<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Study Dashboard</title>
    <!-- Tailwind CSS for modern styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class'
        }
    </script>
    <!-- Google Fonts for a clean look -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Confetti library for celebrations -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        /* Use the Inter font family */
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Style for the modal backdrop */
        #modal-backdrop.hidden,
        #completion-modal-backdrop.hidden {
            display: none;
        }

        /* Position confetti canvas behind everything */
        #confetti-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 9999;
        }
    </style>
</head>

<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200 p-4 sm:p-6 transition-colors">
    <canvas id="confetti-canvas"></canvas>

    <div class="max-w-7xl mx-auto mb-4 flex gap-4">
        <a href="gunnaiza.html" class="text-blue-600 underline">View Gunnaiza's Dashboard</a>
        <a href="index.html" class="text-blue-600 underline">MyAutoSmart</a>
    </div>

    <div id="dashboard-container" class="max-w-7xl mx-auto">
        <header
            class="mb-6 bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 transition-colors">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-bold text-gray-900 dark:text-gray-100">Assignment Sheet</h1>
                    <p id="dashboard-subtitle" class="text-gray-500 dark:text-gray-400 mt-1"></p>
                </div>
                <div class="flex items-center gap-4">
                    <div class="text-sm font-semibold">
                        <span>Rewards:</span>
                        <span id="reward-points" class="font-bold text-yellow-600 bg-yellow-100 px-2 py-1 rounded-md">0
                            ‚≠ê</span>
                    </div>
                    <button id="collection-btn"
                        class="text-sm bg-purple-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-purple-600 transition-colors">üéÅ
                        Collection</button>
                    <button id="dark-mode-toggle"
                        class="text-sm bg-gray-700 dark:bg-gray-300 text-white dark:text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-800 dark:hover:bg-gray-200 transition-colors">üåô</button>
                    <button id="toggle-calendar"
                        class="text-sm bg-indigo-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-600 transition-colors">Show
                        Calendar</button>
                </div>
            </div>
        </header>

        <main id="dashboard-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">
            <!-- Day cards are generated by JavaScript -->
        </main>

        <!-- Future Assignments Section -->
        <div class="mt-8">
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-6 border border-gray-200 dark:border-gray-700">
                <div class="flex justify-between items-center mb-4">
                    <div>
                        <h2 class="text-xl font-bold text-gray-900 dark:text-gray-100">üìÖ Upcoming Schedule</h2>
                        <p class="text-gray-600 dark:text-gray-400 text-sm">Future assignments and live classes</p>
                    </div>
                    <button id="expand-future-btn"
                        class="text-sm bg-blue-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-600 transition-colors">
                        <span id="expand-text">Show More</span> <span id="expand-arrow">‚ñº</span>
                    </button>
                </div>
                <div id="future-assignments-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- Future assignments will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for displaying notes -->
    <div id="modal-backdrop"
        class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-40">
        <div id="modal-content"
            class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-md p-6 border border-gray-200 dark:border-gray-700">
            <div class="flex justify-between items-center mb-4">
                <h3 id="modal-title" class="text-lg font-semibold dark:text-gray-100">Subject Notes</h3>
                <button id="modal-close-btn"
                    class="text-gray-400 dark:text-gray-300 hover:text-gray-600 dark:hover:text-gray-100 text-2xl leading-none">&times;</button>
            </div>
            <p id="modal-body" class="text-gray-600 dark:text-gray-300"></p>
        </div>
    </div>

    <!-- Calendar Modal -->
    <div id="calendar-modal-backdrop"
        class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl h-[80vh] flex flex-col">
            <div class="p-4 border-b flex justify-between items-center">
                <h3 class="text-lg font-semibold">Full Assignment Calendar</h3>
                <button id="calendar-modal-close-btn"
                    class="text-gray-400 hover:text-gray-600 text-2xl leading-none">&times;</button>
            </div>
            <iframe src="gunnaiza.html" class="w-full h-full"></iframe>
        </div>
    </div>

    <!-- Break Time Modal -->
    <div id="break-modal-backdrop"
        class="fixed inset-0 bg-gradient-to-br from-green-400 to-blue-500 dark:from-green-600 dark:to-blue-700 hidden items-center justify-center z-[100]">
        <div class="text-center text-white p-8 max-w-2xl mx-auto">
            <div class="mb-8">
                <div class="text-8xl mb-4">üéâ</div>
                <h1 class="text-4xl font-bold mb-4">Great Work!</h1>
                <p id="break-message" class="text-xl mb-6">You've completed a focused work session. Time for a
                    well-deserved break!</p>
            </div>
            <div class="mb-8">
                <p class="text-lg mb-2">Break Time:</p>
                <p id="break-timer" class="text-6xl font-bold text-yellow-200">5:00</p>
            </div>
            <div class="space-y-4">
                <p class="text-lg">üíß Drink some water</p>
                <p class="text-lg">üëÄ Look away from the screen</p>
                <p class="text-lg">üßò Take deep breaths</p>
                <p class="text-lg">üö∂ Move around a bit</p>
            </div>
            <button id="skip-break-btn"
                class="mt-8 bg-white/20 hover:bg-white/30 text-white px-6 py-3 rounded-lg font-semibold transition-colors">
                Skip Break
            </button>
        </div>
    </div>

    <!-- Collection Modal -->
    <div id="collection-modal-backdrop"
        class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center p-4 z-50">
        <div
            class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl w-full max-w-4xl h-[80vh] flex flex-col border border-gray-200 dark:border-gray-700">
            <div class="p-6 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
                <div>
                    <h3 class="text-2xl font-bold text-gray-900 dark:text-gray-100">üéÅ Your Collection</h3>
                    <p class="text-gray-600 dark:text-gray-400 mt-1">Rewards earned through your study achievements</p>
                </div>
                <button id="collection-modal-close-btn"
                    class="text-gray-400 dark:text-gray-300 hover:text-gray-600 dark:hover:text-gray-100 text-2xl leading-none">&times;</button>
            </div>
            <div class="flex-1 overflow-y-auto p-6">
                <div class="mb-6">
                    <div class="flex items-center justify-between mb-4">
                        <h4 class="text-lg font-semibold text-gray-900 dark:text-gray-100">Statistics</h4>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                        <div class="bg-yellow-100 dark:bg-yellow-900/30 p-4 rounded-lg text-center">
                            <div class="text-2xl font-bold text-yellow-600 dark:text-yellow-400" id="total-points">0
                            </div>
                            <div class="text-sm text-yellow-700 dark:text-yellow-300">Total Points</div>
                        </div>
                        <div class="bg-purple-100 dark:bg-purple-900/30 p-4 rounded-lg text-center">
                            <div class="text-2xl font-bold text-purple-600 dark:text-purple-400" id="total-collected">0
                            </div>
                            <div class="text-sm text-purple-700 dark:text-purple-300">Items Collected</div>
                        </div>
                        <div class="bg-blue-100 dark:bg-blue-900/30 p-4 rounded-lg text-center">
                            <div class="text-2xl font-bold text-blue-600 dark:text-blue-400" id="current-streak">0</div>
                            <div class="text-sm text-blue-700 dark:text-blue-300">Day Streak</div>
                        </div>
                        <div class="bg-green-100 dark:bg-green-900/30 p-4 rounded-lg text-center">
                            <div class="text-2xl font-bold text-green-600 dark:text-green-400" id="completion-rate">0%
                            </div>
                            <div class="text-sm text-green-700 dark:text-green-300">Completion Rate</div>
                        </div>
                    </div>
                </div>

                <div id="collection-content">
                    <!-- Rarity Index -->
                    <div class="mb-8">
                        <h4 class="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-4">üìö Dynamic Rarity System
                        </h4>
                        <div
                            class="bg-gradient-to-r from-blue-50 to-purple-50 dark:from-blue-900/20 dark:to-purple-900/20 p-4 rounded-lg mb-4">
                            <h5 class="font-semibold text-sm text-gray-800 dark:text-gray-200 mb-2">üéØ Reward Chances by
                                Assignment Length</h5>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-3 text-xs">
                                <div class="bg-white/50 dark:bg-gray-800/50 p-2 rounded">
                                    <div class="font-semibold text-gray-700 dark:text-gray-300">Short (5-9 min)</div>
                                    <div class="text-gray-600 dark:text-gray-400">25% reward chance</div>
                                </div>
                                <div class="bg-white/50 dark:bg-gray-800/50 p-2 rounded">
                                    <div class="font-semibold text-gray-700 dark:text-gray-300">Medium (25-49 min)</div>
                                    <div class="text-gray-600 dark:text-gray-400">45% reward chance</div>
                                </div>
                                <div class="bg-white/50 dark:bg-gray-800/50 p-2 rounded">
                                    <div class="font-semibold text-gray-700 dark:text-gray-300">Long (50+ min)</div>
                                    <div class="text-gray-600 dark:text-gray-400">60% reward chance</div>
                                </div>
                            </div>
                            <div class="mt-2 text-xs text-gray-600 dark:text-gray-400">
                                üçÖ <strong>Pomodoro Bonus:</strong> +15% chance for any timer completion!
                            </div>
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                            <div class="bg-gray-50 dark:bg-gray-700 border-l-4 border-gray-400 p-3 rounded">
                                <div class="flex items-center gap-2 mb-1">
                                    <div class="w-3 h-3 bg-gray-400 rounded-full"></div>
                                    <span class="font-semibold text-sm text-gray-700 dark:text-gray-300">COMMON</span>
                                </div>
                                <div class="text-xs text-gray-500 dark:text-gray-400">30-50% chance*</div>
                                <div class="text-xs text-gray-600 dark:text-gray-300 mt-1">Basic fish & food</div>
                            </div>
                            <div class="bg-green-50 dark:bg-green-900/20 border-l-4 border-green-400 p-3 rounded">
                                <div class="flex items-center gap-2 mb-1">
                                    <div class="w-3 h-3 bg-green-400 rounded-full"></div>
                                    <span
                                        class="font-semibold text-sm text-green-700 dark:text-green-300">UNCOMMON</span>
                                </div>
                                <div class="text-xs text-green-600 dark:text-green-400">30% chance</div>
                                <div class="text-xs text-green-700 dark:text-green-300 mt-1">Afghan cuisine</div>
                            </div>
                            <div class="bg-blue-50 dark:bg-blue-900/20 border-l-4 border-blue-400 p-3 rounded">
                                <div class="flex items-center gap-2 mb-1">
                                    <div class="w-3 h-3 bg-blue-400 rounded-full"></div>
                                    <span class="font-semibold text-sm text-blue-700 dark:text-blue-300">RARE</span>
                                </div>
                                <div class="text-xs text-blue-600 dark:text-blue-400">15-25% chance*</div>
                                <div class="text-xs text-blue-700 dark:text-blue-300 mt-1">Special creatures & treasures
                                </div>
                            </div>
                            <div class="bg-yellow-50 dark:bg-yellow-900/20 border-l-4 border-yellow-400 p-3 rounded">
                                <div class="flex items-center gap-2 mb-1">
                                    <div class="w-3 h-3 bg-yellow-400 rounded-full"></div>
                                    <span
                                        class="font-semibold text-sm text-yellow-700 dark:text-yellow-300">LEGENDARY</span>
                                </div>
                                <div class="text-xs text-yellow-600 dark:text-yellow-400">5-15% chance*</div>
                                <div class="text-xs text-yellow-700 dark:text-yellow-300 mt-1">Afghan landmarks & gems
                                </div>
                            </div>
                        </div>
                        <div class="text-xs text-gray-500 dark:text-gray-400 mt-2">
                            *Higher chances for longer assignments
                        </div>
                    </div>

                    <h4 class="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-4">Collected Items</h4>
                    <div id="collected-items" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                        <!-- Collected items will be populated here -->
                    </div>

                    <!-- Item Catalog by Rarity -->
                    <div class="mt-8">
                        <h4 class="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-4">üìñ Complete Item Catalog
                        </h4>
                        <div class="space-y-4">
                            <!-- Common Items -->
                            <div class="bg-gray-50 dark:bg-gray-800 rounded-lg p-4">
                                <h5 class="font-semibold text-gray-700 dark:text-gray-300 mb-2 flex items-center gap-2">
                                    <div class="w-3 h-3 bg-gray-400 rounded-full"></div>
                                    COMMON (50% chance)
                                </h5>
                                <div class="grid grid-cols-3 md:grid-cols-6 gap-2 text-center">
                                    <div class="text-2xl">üêü</div>
                                    <div class="text-2xl">üê†</div>
                                    <div class="text-2xl">üçï</div>
                                    <div class="text-2xl">üçñ</div>
                                    <div class="text-2xl">ü´ì</div>
                                </div>
                                <p class="text-xs text-gray-600 dark:text-gray-400 mt-2">Rainbow Trout, Tropical Fish,
                                    Pizza, Kebab, Naan</p>
                            </div>

                            <!-- Uncommon Items -->
                            <div class="bg-green-50 dark:bg-green-900/20 rounded-lg p-4">
                                <h5
                                    class="font-semibold text-green-700 dark:text-green-300 mb-2 flex items-center gap-2">
                                    <div class="w-3 h-3 bg-green-400 rounded-full"></div>
                                    UNCOMMON (30% chance)
                                </h5>
                                <div class="grid grid-cols-3 md:grid-cols-6 gap-2 text-center">
                                    <div class="text-2xl">üê°</div>
                                    <div class="text-2xl">üçõ</div>
                                    <div class="text-2xl">ü•ò</div>
                                </div>
                                <p class="text-xs text-green-600 dark:text-green-400 mt-2">Pufferfish, Kabuli Pulao,
                                    Qorma</p>
                            </div>

                            <!-- Rare Items -->
                            <div class="bg-blue-50 dark:bg-blue-900/20 rounded-lg p-4">
                                <h5 class="font-semibold text-blue-700 dark:text-blue-300 mb-2 flex items-center gap-2">
                                    <div class="w-3 h-3 bg-blue-400 rounded-full"></div>
                                    RARE (15% chance)
                                </h5>
                                <div class="grid grid-cols-3 md:grid-cols-6 gap-2 text-center">
                                    <div class="text-2xl">ü¶à</div>
                                    <div class="text-2xl">üêô</div>
                                    <div class="text-2xl">üçØ</div>
                                    <div class="text-2xl">üßø</div>
                                </div>
                                <p class="text-xs text-blue-600 dark:text-blue-400 mt-2">Shark, Octopus, Afghan Honey,
                                    Nazar (Evil Eye)</p>
                            </div>

                            <!-- Legendary Items -->
                            <div
                                class="bg-yellow-50 dark:bg-yellow-900/20 rounded-lg p-4 border-2 border-yellow-300 dark:border-yellow-600">
                                <h5
                                    class="font-semibold text-yellow-700 dark:text-yellow-300 mb-2 flex items-center gap-2">
                                    <div class="w-3 h-3 bg-yellow-400 rounded-full"></div>
                                    LEGENDARY (5% chance) ‚≠ê
                                </h5>
                                <div class="grid grid-cols-3 md:grid-cols-6 gap-2 text-center">
                                    <div class="text-2xl">üèîÔ∏è</div>
                                    <div class="text-2xl">üíé</div>
                                </div>
                                <p class="text-xs text-yellow-600 dark:text-yellow-400 mt-2">Hindu Kush Mountains, Lapis
                                    Lazuli Gemstone</p>
                                <p class="text-xs text-yellow-700 dark:text-yellow-300 mt-1 font-semibold">üéâ Extra
                                    confetti when collected!</p>
                            </div>
                        </div>
                    </div>

                    <div class="mt-8">
                        <h4 class="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-4">Available Items</h4>
                        <p class="text-gray-600 dark:text-gray-400 mb-4">Complete more assignments to discover these
                            items!</p>
                        <div id="available-items"
                            class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 opacity-50">
                            <!-- Available items will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <script>
        // =============================
        // Pomodoro Timer Engine
        // =============================
        const PomodoroEngine = (function () {
            const STORAGE_KEY = 'pomodoroStateV1';

            class PomodoroTimer {
                constructor(options) {
                    const defaults = { workSeconds: 25 * 60, shortBreakSeconds: 5 * 60, longBreakSeconds: 15 * 60, cyclesPerSet: 1 };
                    this.config = Object.assign({}, defaults, options || {});
                    this.state = {
                        active: false,
                        taskId: null,
                        taskLabel: '',
                        phase: 'idle', // 'work' | 'break' | 'complete' | 'idle'
                        cycle: 0,
                        totalCycles: this.config.cyclesPerSet,
                        remainingSeconds: this.config.workSeconds,
                        phaseSeconds: this.config.workSeconds,
                        startedAt: null,
                        paused: false
                    };
                    this.intervalId = null;
                    this.listeners = new Set();
                    this._load();
                }

                on(listener) {
                    this.listeners.add(listener);
                    // send current state immediately
                    listener(this.getState());
                    return () => this.listeners.delete(listener);
                }

                _emit() {
                    const snapshot = this.getState();
                    for (const l of this.listeners) l(snapshot);
                    this._save();
                }

                getState() {
                    return JSON.parse(JSON.stringify(this.state));
                }

                start(taskId, taskLabel, options) {
                    if (options) this.config = Object.assign({}, this.config, options);
                    this.state.active = true;
                    this.state.taskId = taskId;
                    this.state.taskLabel = taskLabel || '';
                    this.state.phase = 'work';
                    this.state.cycle = 1;
                    this.state.totalCycles = this.config.cyclesPerSet;
                    this.state.phaseSeconds = this.config.workSeconds;
                    this.state.remainingSeconds = this.config.workSeconds;
                    this.state.paused = false;
                    this._startTicking();
                    this._emit();
                }

                pause() {
                    if (!this.state.active) return;
                    this.state.paused = true;
                    this._clearTicker();
                    this._emit();
                }

                resume() {
                    if (!this.state.active) return;
                    this.state.paused = false;
                    this._startTicking();
                    this._emit();
                }

                reset() {
                    this._clearTicker();
                    this.state = {
                        active: false,
                        taskId: null,
                        taskLabel: '',
                        phase: 'idle',
                        cycle: 0,
                        totalCycles: this.config.cyclesPerSet,
                        remainingSeconds: this.config.workSeconds,
                        phaseSeconds: this.config.workSeconds,
                        startedAt: null,
                        paused: false
                    };
                    this._emit();
                }

                _startTicking() {
                    this._clearTicker();
                    this.state.startedAt = Date.now();
                    this.intervalId = setInterval(() => this._tick(), 1000);
                }

                _clearTicker() {
                    if (this.intervalId) clearInterval(this.intervalId);
                    this.intervalId = null;
                }

                _tick() {
                    if (!this.state.active || this.state.paused) return;
                    this.state.remainingSeconds -= 1;
                    if (this.state.remainingSeconds <= 0) {
                        // advance phase
                        if (this.state.phase === 'work') {
                            if (this.state.cycle >= this.state.totalCycles) {
                                this.state.phase = 'complete';
                                this.state.active = false;
                                this._clearTicker();
                            } else {
                                this.state.phase = 'break';
                                this.state.phaseSeconds = this.config.shortBreakSeconds;
                                this.state.remainingSeconds = this.config.shortBreakSeconds;
                            }
                        } else if (this.state.phase === 'break') {
                            this.state.cycle += 1;
                            this.state.phase = 'work';
                            this.state.phaseSeconds = this.config.workSeconds;
                            this.state.remainingSeconds = this.config.workSeconds;
                        }
                    }
                    this._emit();
                }

                _save() {
                    try { localStorage.setItem(STORAGE_KEY, JSON.stringify({ state: this.state, config: this.config })); } catch { }
                }

                _load() {
                    try {
                        const raw = localStorage.getItem(STORAGE_KEY);
                        if (!raw) return;
                        const { state, config } = JSON.parse(raw);
                        if (config) this.config = Object.assign({}, this.config, config);
                        if (state) this.state = Object.assign({}, this.state, state);
                    } catch { }
                }
            }

            function formatTime(totalSeconds) {
                const s = Math.max(0, Math.floor(totalSeconds));
                const m = Math.floor(s / 60).toString().padStart(2, '0');
                const ss = (s % 60).toString().padStart(2, '0');
                return `${m}:${ss}`;
            }

            return { PomodoroTimer, formatTime };
        })();

        // =============================
        // State Management
        // =============================
        let studyData = [];
        let rewardPoints = 0;
        let pomodoro;
        let breakInterval = null;
        let collectedRewards = [];
        let streakCount = 0;
        let lastStudyDate = null;
        let assignmentProgress = {}; // Store time spent on each assignment
        let showAllFuture = false; // Track expanded state for future assignments

        // =============================
        // Rewards System
        // =============================
        const REWARD_TYPES = {
            POMODORO_COMPLETE: { points: 3, message: "Focused Work Session!" },
            ASSIGNMENT_COMPLETE: { points: 5, message: "Assignment Completed!" },
            DAILY_GOAL: { points: 10, message: "Daily Goal Achieved!" },
            STREAK_3: { points: 15, message: "3-Day Study Streak!" },
            STREAK_7: { points: 25, message: "Week Study Streak!" }
        };

        const FUN_REWARDS = [
            { emoji: "üêü", name: "Rainbow Trout", rarity: "common", message: "You caught a beautiful rainbow trout!" },
            { emoji: "üê†", name: "Tropical Fish", rarity: "common", message: "A colorful tropical fish swims by!" },
            { emoji: "üê°", name: "Pufferfish", rarity: "uncommon", message: "A rare pufferfish appears!" },
            { emoji: "ü¶à", name: "Shark", rarity: "rare", message: "Whoa! A mighty shark emerges!" },
            { emoji: "üêô", name: "Octopus", rarity: "rare", message: "An intelligent octopus greets you!" },
            { emoji: "üçï", name: "Pizza", rarity: "common", message: "Delicious pizza slice earned!" },
            { emoji: "üçõ", name: "Kabuli Pulao", rarity: "uncommon", message: "Traditional Afghan rice dish unlocked!" },
            { emoji: "ü•ò", name: "Qorma", rarity: "uncommon", message: "Savory Afghan stew discovered!" },
            { emoji: "üçñ", name: "Kebab", rarity: "common", message: "Juicy Afghan kebab earned!" },
            { emoji: "ü´ì", name: "Naan", rarity: "common", message: "Fresh Afghan bread acquired!" },
            { emoji: "üçØ", name: "Afghan Honey", rarity: "rare", message: "Sweet golden honey from Afghanistan!" },
            { emoji: "üßø", name: "Nazar", rarity: "rare", message: "Protective evil eye charm found!" },
            { emoji: "üèîÔ∏è", name: "Hindu Kush", rarity: "legendary", message: "You've conquered the Hindu Kush mountains!" },
            { emoji: "üíé", name: "Lapis Lazuli", rarity: "legendary", message: "Precious Afghan gemstone discovered!" }
        ];

        // =============================
        // Encouraging Messages
        // =============================
        const ENCOURAGING_MESSAGES = [
            "Amazing focus! üåü You're making great progress on your studies.",
            "Excellent work! üí™ Your dedication is really paying off.",
            "Fantastic job! üöÄ You're building great study habits.",
            "Well done! üìö Every focused session brings you closer to your goals.",
            "Outstanding effort! ‚≠ê You're developing excellent concentration skills.",
            "Brilliant work! üéØ Your consistent effort is inspiring.",
            "Great job! üèÜ You're proving that focused work really pays off.",
            "Wonderful progress! üåà Your commitment to learning is admirable.",
            "Excellent focus! üíé You're turning your study time into real achievement.",
            "Impressive dedication! üî• Your hard work is building towards success."
        ];

        // =============================
        // Configuration
        // =============================
        const MINUTES_PER_PAGE_SHORT = 5; // For tasks < 10 pages
        const MINUTES_PER_PAGE_LONG = 50; // Flat rate for tasks >= 10 pages
        const SPANISH_MINUTES_PER_PAGE = 7; // UPDATED
        const SPANISH_TEST_MINUTES = 15;
        const DAYS_ORDER = ["Wed", "Thu", "Fri"];
        const SUBJECT_COLORS = [
            'bg-blue-500', 'bg-indigo-500', 'bg-purple-500',
            'bg-pink-500', 'bg-red-500', 'bg-orange-500', 'bg-yellow-500', 'bg-green-500'
        ];

        // =============================
        // Future Assignments Data
        // =============================
        const FUTURE_ASSIGNMENTS = [
            // Week 1 - Monday
            { "Day": "Mon", "Date": "2025-01-06", "Subject": "Algebra Live Class", "Type": "live", "Minutes": 45, "Notes": "Weekly live session" },
            { "Day": "Mon", "Subject": "English Reading", "Type": "assignment", "Minutes": 30, "Notes": "Chapter 4-5" },
            { "Day": "Mon", "Subject": "History Research", "Type": "assignment", "Minutes": 60, "Notes": "Medieval period" },

            // Tuesday
            { "Day": "Tue", "Date": "2025-01-07", "Subject": "Biology Live Class", "Type": "live", "Minutes": 45, "Notes": "Cell structure" },
            { "Day": "Tue", "Subject": "Spanish Practice", "Type": "assignment", "Minutes": 25, "Notes": "Vocabulary review" },
            { "Day": "Tue", "Subject": "PrinHLSC Review", "Type": "assignment", "Minutes": 20, "Notes": "Lesson 5-6" },

            // Wednesday  
            { "Day": "Wed", "Date": "2025-01-08", "Subject": "English Live Class", "Type": "live", "Minutes": 45, "Notes": "Literature discussion" },
            { "Day": "Wed", "Subject": "Algebra Problems", "Type": "assignment", "Minutes": 40, "Notes": "Unit 3 practice" },
            { "Day": "Wed", "Subject": "Health Quiz", "Type": "assignment", "Minutes": 15, "Notes": "Nutrition chapter" },

            // Thursday
            { "Day": "Thu", "Date": "2025-01-09", "Subject": "History Live Class", "Type": "live", "Minutes": 45, "Notes": "Renaissance era" },
            { "Day": "Thu", "Subject": "Biology Lab", "Type": "assignment", "Minutes": 50, "Notes": "Microscope work" },
            { "Day": "Thu", "Subject": "Spanish Writing", "Type": "assignment", "Minutes": 35, "Notes": "Essay practice" },

            // Friday
            { "Day": "Fri", "Date": "2025-01-10", "Subject": "Science Live Class", "Type": "live", "Minutes": 45, "Notes": "Physics intro" },
            { "Day": "Fri", "Subject": "English Essay", "Type": "assignment", "Minutes": 45, "Notes": "Character analysis" },
            { "Day": "Fri", "Subject": "Math Review", "Type": "assignment", "Minutes": 30, "Notes": "Week summary" },

            // Week 2 - Monday
            { "Day": "Mon", "Date": "2025-01-13", "Subject": "Algebra Live Class", "Type": "live", "Minutes": 45, "Notes": "Advanced equations" },
            { "Day": "Mon", "Subject": "History Project", "Type": "assignment", "Minutes": 90, "Notes": "Research paper" },
            { "Day": "Mon", "Subject": "Health Reading", "Type": "assignment", "Minutes": 20, "Notes": "Exercise science" },

            // Tuesday
            { "Day": "Tue", "Date": "2025-01-14", "Subject": "Biology Live Class", "Type": "live", "Minutes": 45, "Notes": "Genetics basics" },
            { "Day": "Tue", "Subject": "Spanish Test Prep", "Type": "assignment", "Minutes": 40, "Notes": "Unit 2 review" },
            { "Day": "Tue", "Subject": "English Reading", "Type": "assignment", "Minutes": 35, "Notes": "Novel chapters" }
        ];

        // =============================
        // Raw Data (Current Week)
        // =============================
        const ROWS = [
            // Wednesday
            { "Day": "Wed", "Subject": "Algebra (U1 L6 + U2 L1)", "Pages": 13 + 2, "Notes": "U1 L6=13, U2 L1=2" },
            { "Day": "Wed", "Subject": "English (L3)", "Pages": 17, "Notes": "" },
            { "Day": "Wed", "Subject": "Health (L3)", "Pages": 1, "Notes": "" },
            { "Day": "Wed", "Subject": "PrinHLSC (L1+L2)", "Pages": 1 + 1, "Notes": "L1=1, L2=1" },
            { "Day": "Wed", "Subject": "Spanish (U1 L2 + test)", "Pages": 13, "Notes": "2-day plan; test at end" },
            { "Day": "Wed", "Subject": "History (U2 L2)", "Pages": 17, "Notes": "" },
            { "Day": "Wed", "Subject": "Biology", "Pages": 26, "Notes": "New addition" },

            // Thursday
            { "Day": "Thu", "Subject": "Algebra (L2+L3)", "Pages": 11 + 10, "Notes": "L2=11, L3=10" },
            { "Day": "Thu", "Subject": "Biology", "Pages": 10, "Notes": "" },
            { "Day": "Thu", "Subject": "English", "Pages": 13, "Notes": "" },
            { "Day": "Thu", "Subject": "Health", "Pages": 1, "Notes": "" },
            { "Day": "Thu", "Subject": "Spanish (U1 L2 + test)", "Pages": 12, "Notes": "Finish lesson + test" },
            { "Day": "Thu", "Subject": "History (L3)", "Pages": 17, "Notes": "" },

            // Friday
            { "Day": "Fri", "Subject": "Algebra (L4+L5)", "Pages": 12 + 13, "Notes": "L4=12, L5=13" },
            { "Day": "Fri", "Subject": "Biology", "Pages": 8, "Notes": "" },
            { "Day": "Fri", "Subject": "English", "Pages": 3, "Notes": "+ discussion" },
            { "Day": "Fri", "Subject": "Health (L5)", "Pages": 1, "Notes": "" },
            { "Day": "Fri", "Subject": "PrinHLSC (L3+L4)", "Pages": 1 + 1, "Notes": "L3=1, L4=1" },
            { "Day": "Fri", "Subject": "Spanish (U1 L3 + test)", "Pages": 10, "Notes": "2-day plan" }, // UPDATED
            { "Day": "Fri", "Subject": "History", "Pages": 14, "Notes": "" },
        ];

        // =============================
        // Data Processing Logic
        // =============================
        function processData(rawData) {
            let processed = [];
            let idCounter = 0;

            // 1. Pre-process to expand combined tasks based on notes
            const expandedRows = [];
            rawData.forEach(row => {
                if (row.Notes && row.Notes.includes('=')) {
                    const subjectBase = row.Subject.split('(')[0].trim();
                    const lessonParts = row.Notes.split(', ');
                    lessonParts.forEach(part => {
                        const [lesson, pagesStr] = part.split('=');
                        expandedRows.push({
                            ...row,
                            Subject: `${subjectBase} (${lesson.trim()})`,
                            Pages: parseInt(pagesStr, 10),
                            Notes: `Original: ${row.Subject}`
                        });
                    });
                } else {
                    expandedRows.push(row);
                }
            });

            // 2. Process expanded data with specific logic
            const processedSubjects = new Set();

            // Handle Spanish U1 L2 specifically
            const spanishU1L2Entries = expandedRows.filter(r => r.Subject.includes("Spanish (U1 L2"));
            if (spanishU1L2Entries.length > 0) {
                processed.push({
                    ...spanishU1L2Entries[0],
                    id: idCounter++, Subject: "Spanish U1 L2 - Reading", Day: "Wed",
                    Pages: 6, Minutes: 6 * MINUTES_PER_PAGE_SHORT, completed: false,
                    Notes: "First half of reading."
                });
                processed.push({
                    ...spanishU1L2Entries[0],
                    id: idCounter++, Subject: "Spanish U1 L2 - Reading + Test", Day: "Thu",
                    Pages: 6, Minutes: (6 * MINUTES_PER_PAGE_SHORT) + SPANISH_TEST_MINUTES, completed: false,
                    Notes: "Second half of reading plus the test."
                });
                processedSubjects.add("WedSpanish (U1 L2 + test)");
                processedSubjects.add("ThuSpanish (U1 L2 + test)");
            }

            // Handle Spanish U1 L3 specifically for Friday
            const spanishU1L3Entry = expandedRows.find(r => r.Subject.includes("Spanish (U1 L3"));
            if (spanishU1L3Entry) {
                processed.push({
                    ...spanishU1L3Entry,
                    id: idCounter++,
                    Subject: "Spanish U1 L3 - Part 1",
                    Day: "Fri",
                    Pages: 5,
                    Minutes: 5 * SPANISH_MINUTES_PER_PAGE,
                    completed: false,
                    Notes: "First half of reading (5 pages). Test will be on Monday."
                });
                processedSubjects.add("FriSpanish (U1 L3 + test)");
            }

            // 3. Process all remaining items with the new time logic
            expandedRows.forEach(row => {
                if (!processedSubjects.has(row.Day + row.Subject)) {
                    const isSpanish = row.Subject.includes("Spanish");
                    let minutes;
                    if (isSpanish) {
                        // This will only catch single-day Spanish lessons now
                        minutes = row.Pages * SPANISH_MINUTES_PER_PAGE;
                    } else {
                        minutes = row.Pages >= 10 ? MINUTES_PER_PAGE_LONG : row.Pages * MINUTES_PER_PAGE_SHORT;
                    }

                    processed.push({
                        ...row,
                        id: idCounter++,
                        Minutes: minutes,
                        completed: false
                    });
                }
            });

            return processed;
        }


        // =============================
        // Main Render Function
        // =============================
        function renderDashboard() {
            const dashboardGrid = document.getElementById('dashboard-grid');
            dashboardGrid.innerHTML = '';

            document.getElementById('dashboard-subtitle').textContent = `Long tasks (>=10 pages) are 50 min. Short tasks are 5 min/page. Spanish is 7 min/page.`;

            const subjectColorMap = new Map();
            let colorIndex = 0;
            studyData.forEach(row => {
                const baseSubject = row.Subject.split('(')[0].split('-')[0].trim();
                if (!subjectColorMap.has(baseSubject)) {
                    subjectColorMap.set(baseSubject, SUBJECT_COLORS[colorIndex % SUBJECT_COLORS.length]);
                    colorIndex++;
                }
            });

            DAYS_ORDER.forEach(day => {
                const dayData = studyData.filter(row => row.Day === day);
                const totalMinutes = dayData.reduce((sum, row) => sum + row.Minutes, 0);

                // Calculate remaining minutes accounting for active Pomodoro
                let remainingMinutes = 0;
                const pState = pomodoro ? pomodoro.getState() : null;

                dayData.forEach(row => {
                    if (row.completed) return; // Skip completed tasks

                    if (pState && pState.active && pState.taskId === row.id && pState.phase === 'work') {
                        const timeSpent = (pState.phaseSeconds - pState.remainingSeconds) / 60;
                        remainingMinutes += Math.max(0, row.Minutes - timeSpent);
                    } else {
                        remainingMinutes += row.Minutes;
                    }
                });

                remainingMinutes = Math.round(remainingMinutes);

                const dayCard = document.createElement('div');
                dayCard.className = 'bg-white dark:bg-gray-800 rounded-xl shadow-sm p-4 flex flex-col border border-gray-200 dark:border-gray-700 transition-colors';

                const subjectItemsHTML = dayData.sort((a, b) => b.Minutes - a.Minutes).map(subject => {
                    const percentage = totalMinutes > 0 ? (subject.Minutes / totalMinutes) * 100 : 0;
                    const baseSubject = subject.Subject.split('(')[0].split('-')[0].trim();
                    const colorClass = subjectColorMap.get(baseSubject) || 'bg-gray-400';
                    const notes = subject.Notes || 'No notes for this entry.';
                    const isCompleted = subject.completed;

                    const pState = pomodoro ? pomodoro.getState() : null;
                    const isActiveTask = pState && pState.active && pState.taskId === subject.id;
                    const pomodoroProgress = isActiveTask && pState.phaseSeconds > 0 ? Math.round(((pState.phaseSeconds - pState.remainingSeconds) / pState.phaseSeconds) * 100) : 0;
                    const timerLabel = isActiveTask ? `${pState.phase.charAt(0).toUpperCase() + pState.phase.slice(1)}` : 'Ready';
                    // Show appropriate timer duration based on task length
                    let defaultTime = subject.Minutes <= 5 ? subject.Minutes * 60 : 25 * 60;
                    const timeDisplay = isActiveTask ? PomodoroEngine.formatTime(pState.remainingSeconds) : PomodoroEngine.formatTime(defaultTime);

                    // Calculate assignment progress overlay based on actual assignment time, not Pomodoro time
                    let assignmentProgressPercent = 0;
                    let totalTimeSpentOnAssignment = assignmentProgress[subject.id] || 0; // Previously saved time

                    if (isActiveTask && pState.phase === 'work') {
                        const currentSessionTime = (pState.phaseSeconds - pState.remainingSeconds) / 60; // minutes spent in current session
                        totalTimeSpentOnAssignment += currentSessionTime;
                    }

                    assignmentProgressPercent = Math.min(100, Math.round((totalTimeSpentOnAssignment / subject.Minutes) * 100));

                    // Use the same total time spent calculation for display minutes
                    const displayMinutes = Math.max(0, Math.round(subject.Minutes - totalTimeSpentOnAssignment));

                    return `
                        <div class="subject-card relative p-3 rounded-lg border border-gray-200 dark:border-gray-600 transition-all duration-300 ${isCompleted ? 'opacity-50 bg-gray-50 dark:bg-gray-700' : 'hover:bg-gray-50 dark:hover:bg-gray-700'} overflow-hidden">
                            ${assignmentProgressPercent > 0 ? `
                                <div class="absolute inset-0 bg-gradient-to-r from-green-400/20 to-blue-500/20 dark:from-green-400/30 dark:to-blue-500/30 transition-all duration-1000" style="width: ${assignmentProgressPercent}%; z-index: 1;"></div>
                            ` : ''}
                            <div class="relative z-10">
                                <div class="flex justify-between items-start">
                                    <h3 class="font-semibold pr-2 text-sm ${isCompleted ? 'line-through' : ''}">${subject.Subject}</h3>
                                    <p class="text-xs text-gray-600 dark:text-gray-400 font-medium whitespace-nowrap ${isCompleted ? 'line-through' : ''} ${isActiveTask ? 'text-indigo-600 dark:text-indigo-400 font-bold' : ''}">${displayMinutes} min</p>
                                </div>
                                <div class="flex justify-between items-end mt-2">
                                    <div>
                                        <p class="text-xs text-gray-500 dark:text-gray-400 ${isCompleted ? 'line-through' : ''}">${subject.Pages} Pages</p>
                                        <div class="w-full bg-gray-200 dark:bg-gray-600 rounded-full h-1.5 mt-1" style="width: 120px;">
                                            <div class="${colorClass} h-1.5 rounded-full transition-all duration-300" style="width: ${percentage}%"></div>
                                        </div>
                                    </div>
                                    ${!isCompleted ? `<button class="complete-btn text-xs bg-green-500 text-white font-semibold py-1 px-3 rounded-full hover:bg-green-600 transition-colors" data-task-id="${subject.id}">Complete</button>` : `
                                        <div class="flex gap-2 items-center">
                                            <span class="text-xs font-bold text-green-600">Done!</span>
                                            <button class="undo-btn text-xs bg-gray-500 text-white font-semibold py-1 px-2 rounded hover:bg-gray-600 transition-colors" data-task-id="${subject.id}">‚Ü∂ Undo</button>
                                        </div>
                                    `}
                                </div>
                            </div>
                            ${!isCompleted ? `
                            <div class="mt-3 relative z-10">
                                <div class="flex items-center justify-between text-xs text-gray-600 dark:text-gray-400">
                                    <span class="font-medium">${timerLabel}</span>
                                    <span class="font-bold tabular-nums ${isActiveTask ? 'text-indigo-600 dark:text-indigo-400' : ''}">${timeDisplay}</span>
                                </div>
                                <div class="w-full bg-gray-200 dark:bg-gray-600 rounded-full h-2 mt-1">
                                    <div class="bg-indigo-500 dark:bg-indigo-400 h-2 rounded-full transition-all duration-500" style="width: ${pomodoroProgress}%"></div>
                                </div>
                                <div class="mt-2 flex gap-2 flex-wrap">
                                    ${!isActiveTask || (pState && pState.paused) ? `<button class="pomo-btn text-xs bg-indigo-500 hover:bg-indigo-600 text-white px-2 py-1 rounded transition-colors" data-action="${isActiveTask && pState && pState.paused ? 'resume' : 'start'}" data-task-id="${subject.id}">${isActiveTask && pState && pState.paused ? 'Resume' : 'Start'}</button>` : ''}
                                    ${isActiveTask && pState && !pState.paused ? `<button class="pomo-btn text-xs bg-yellow-500 hover:bg-yellow-600 text-white px-2 py-1 rounded transition-colors" data-action="pause" data-task-id="${subject.id}">Pause</button>` : ''}
                                    ${isActiveTask ? `<button class="pomo-btn text-xs bg-gray-500 hover:bg-gray-600 text-white px-2 py-1 rounded transition-colors" data-action="reset" data-task-id="${subject.id}">Reset</button>` : ''}
                                </div>
                            </div>
                            ` : ''}
                        </div>
                    `;
                }).join('');

                dayCard.innerHTML = `
                    <div class="flex justify-between items-center mb-4 pb-3 border-b border-gray-200">
                        <h2 class="text-lg font-bold">${day}</h2>
                        <div>
                           <span class="text-sm font-semibold text-gray-500 ${remainingMinutes === 0 ? '' : 'line-through'}">${totalMinutes} min</span>
                           <span class="text-base font-semibold text-indigo-600 ml-2">${remainingMinutes} min left</span>
                        </div>
                    </div>
                    <div class="space-y-3">
                        ${subjectItemsHTML}
                    </div>
                `;

                dashboardGrid.appendChild(dayCard);
            });

            setupActionListeners();
            document.getElementById('reward-points').textContent = `${rewardPoints} ‚≠ê`;
        }

        // =============================
        // Future Assignments Functions
        // =============================
        function renderFutureAssignments() {
            const futureGrid = document.getElementById('future-assignments-grid');

            // Group assignments by day
            const groupedByDay = {};
            FUTURE_ASSIGNMENTS.forEach(assignment => {
                const key = `${assignment.Day}-${assignment.Date}`;
                if (!groupedByDay[key]) {
                    groupedByDay[key] = {
                        day: assignment.Day,
                        date: assignment.Date,
                        assignments: []
                    };
                }
                groupedByDay[key].assignments.push(assignment);
            });

            const dayGroups = Object.values(groupedByDay);
            const visibleDays = showAllFuture ? dayGroups : dayGroups.slice(0, 3);

            futureGrid.innerHTML = visibleDays.map(dayGroup => {
                const totalMinutes = dayGroup.assignments.reduce((sum, a) => sum + a.Minutes, 0);
                const liveClasses = dayGroup.assignments.filter(a => a.Type === 'live').length;
                const assignments = dayGroup.assignments.filter(a => a.Type === 'assignment').length;

                const assignmentItems = dayGroup.assignments.map(assignment => {
                    const isLive = assignment.Type === 'live';
                    const baseSubject = assignment.Subject.split(' ')[0]; // Get first word for color
                    const colorClass = SUBJECT_COLORS[Math.abs(baseSubject.charCodeAt(0)) % SUBJECT_COLORS.length];

                    return `
                        <div class="flex items-center justify-between p-2 ${isLive ? 'bg-red-50 dark:bg-red-900/20 border-l-2 border-red-400' : 'bg-gray-50 dark:bg-gray-700'} rounded text-sm">
                            <div class="flex items-center gap-2">
                                <div class="w-2 h-2 ${colorClass} rounded-full"></div>
                                <span class="font-medium ${isLive ? 'text-red-700 dark:text-red-300' : 'text-gray-700 dark:text-gray-300'}">${assignment.Subject}</span>
                                ${isLive ? '<span class="text-xs bg-red-100 dark:bg-red-800 text-red-600 dark:text-red-300 px-1 rounded">LIVE</span>' : ''}
                            </div>
                            <span class="text-xs text-gray-600 dark:text-gray-400">${assignment.Minutes}m</span>
                        </div>
                    `;
                }).join('');

                return `
                    <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4 border border-gray-200 dark:border-gray-600">
                        <div class="flex justify-between items-center mb-3">
                            <div>
                                <h3 class="font-bold text-gray-900 dark:text-gray-100">${dayGroup.day}</h3>
                                <p class="text-xs text-gray-500 dark:text-gray-400">${new Date(dayGroup.date).toLocaleDateString()}</p>
                            </div>
                            <div class="text-right text-xs text-gray-600 dark:text-gray-400">
                                <div>${totalMinutes} min total</div>
                                <div>${liveClasses} live ‚Ä¢ ${assignments} tasks</div>
                            </div>
                        </div>
                        <div class="space-y-1">
                            ${assignmentItems}
                        </div>
                    </div>
                `;
            }).join('');

            // Update button text
            const expandBtn = document.getElementById('expand-future-btn');
            const expandText = document.getElementById('expand-text');
            const expandArrow = document.getElementById('expand-arrow');

            if (showAllFuture) {
                expandText.textContent = 'Show Less';
                expandArrow.textContent = '‚ñ≤';
            } else {
                expandText.textContent = 'Show More';
                expandArrow.textContent = '‚ñº';
            }
        }

        // =============================
        // Interactivity Setup
        // =============================
        function setupActionListeners() {
            // Notes Modal
            const notesModalBackdrop = document.getElementById('modal-backdrop');
            const notesModalTitle = document.getElementById('modal-title');
            const notesModalBody = document.getElementById('modal-body');
            const notesModalCloseBtn = document.getElementById('modal-close-btn');

            document.querySelectorAll('.subject-card h3').forEach(title => {
                title.addEventListener('click', (e) => {
                    notesModalTitle.textContent = title.textContent;
                    notesModalBody.textContent = "Notes would be displayed here."; // Placeholder
                    notesModalBackdrop.classList.remove('hidden');
                });
            });

            const closeNotesModal = () => notesModalBackdrop.classList.add('hidden');
            notesModalCloseBtn.addEventListener('click', closeNotesModal);
            notesModalBackdrop.addEventListener('click', (event) => {
                if (event.target === notesModalBackdrop) closeNotesModal();
            });

            // Manual complete button
            document.querySelectorAll('.complete-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const taskId = parseInt(e.target.dataset.taskId, 10);
                    const task = studyData.find(t => t.id === taskId);
                    if (task && !task.completed) {
                        task.completed = true;
                        task.completedDate = new Date().toISOString();

                        // Give reward for manual completion (fewer points than Pomodoro)
                        giveReward('ASSIGNMENT_COMPLETE', 2, "Quick Complete!", task.Minutes);

                        // Update streak and check daily goals
                        updateStreak();
                        checkDailyGoal();

                        triggerCelebration();
                        renderDashboard();
                    }
                });
            });

            // Undo button for completed assignments
            document.querySelectorAll('.undo-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const taskId = parseInt(e.target.dataset.taskId, 10);
                    const task = studyData.find(t => t.id === taskId);
                    if (task && task.completed) {
                        task.completed = false;
                        task.completedDate = null;

                        console.log('Undoing completion for:', task.Subject);
                        renderDashboard();
                    }
                });
            });

            // Pomodoro controls - use event delegation
            document.addEventListener('click', (e) => {
                if (e.target.classList.contains('pomo-btn')) {
                    const action = e.target.dataset.action;
                    const taskId = parseInt(e.target.dataset.taskId, 10);
                    const task = studyData.find(t => t.id === taskId);

                    console.log('Pomodoro button clicked:', action, taskId, task?.Subject);

                    if (!task || task.completed || !pomodoro) {
                        console.warn('Cannot perform action:', { task: !!task, completed: task?.completed, pomodoro: !!pomodoro });
                        return;
                    }

                    try {
                        if (action === 'start') {
                            console.log('Starting pomodoro for:', task.Subject);

                            // Save progress from current timer if switching
                            const currentState = pomodoro.getState();
                            if (currentState.active && currentState.taskId !== taskId) {
                                const timeSpent = (currentState.phaseSeconds - currentState.remainingSeconds) / 60;
                                if (!assignmentProgress[currentState.taskId]) {
                                    assignmentProgress[currentState.taskId] = 0;
                                }
                                assignmentProgress[currentState.taskId] += timeSpent;
                                console.log(`Saved ${timeSpent.toFixed(1)} minutes of progress for task ${currentState.taskId}`);

                                // Save to localStorage
                                try {
                                    localStorage.setItem('assignmentProgress', JSON.stringify(assignmentProgress));
                                } catch { }
                            }

                            // Use task duration for short tasks (5 minutes), otherwise use 25 minutes
                            const timerDuration = task.Minutes <= 5 ? task.Minutes * 60 : 25 * 60;
                            pomodoro.start(taskId, task.Subject, { workSeconds: timerDuration });
                        } else if (action === 'pause') {
                            console.log('Pausing pomodoro');
                            pomodoro.pause();
                        } else if (action === 'resume') {
                            console.log('Resuming pomodoro');
                            pomodoro.resume();
                        } else if (action === 'reset') {
                            console.log('Resetting pomodoro');
                            pomodoro.reset();
                        }
                    } catch (error) {
                        console.error('Pomodoro action failed:', error);
                    }
                }
            });
        }

        // =============================
        // Effects
        // =============================
        function triggerCelebration() {
            const myCanvas = document.getElementById('confetti-canvas');
            const myConfetti = confetti.create(myCanvas, {
                resize: true,
                useWorker: true
            });
            myConfetti({
                particleCount: 100,
                spread: 70,
                origin: { y: 0.6 }
            });
        }

        function updatePomodoroUI(state) {
            renderDashboard();
        }

        // =============================
        // Reward Functions
        // =============================
        function giveReward(type, customPoints = null, customMessage = null, assignmentMinutes = null) {
            const reward = REWARD_TYPES[type];
            const points = customPoints || reward.points;
            const message = customMessage || reward.message;

            rewardPoints += points;

            // Save to localStorage
            try {
                localStorage.setItem('rewardPointsV1', String(rewardPoints));
                localStorage.setItem('streakCount', String(streakCount));
                localStorage.setItem('lastStudyDate', lastStudyDate);
            } catch { }

            // Calculate fun reward chance based on assignment length and completion method
            let funRewardChance = 0.2; // Base 20% chance

            if (assignmentMinutes) {
                // Longer assignments = better reward chances
                if (assignmentMinutes >= 50) funRewardChance = 0.6;        // 60% for 50+ min assignments
                else if (assignmentMinutes >= 25) funRewardChance = 0.45;  // 45% for 25-49 min assignments
                else if (assignmentMinutes >= 10) funRewardChance = 0.35;  // 35% for 10-24 min assignments
                else if (assignmentMinutes >= 5) funRewardChance = 0.25;   // 25% for 5-9 min assignments
                // else stays at 20% for very short assignments
            }

            // Bonus chance for Pomodoro completions
            if (type === 'POMODORO_COMPLETE') {
                funRewardChance += 0.15; // +15% bonus for using Pomodoro
            }

            // Cap at 80% max chance
            funRewardChance = Math.min(0.8, funRewardChance);

            console.log(`Fun reward chance: ${Math.round(funRewardChance * 100)}% for ${assignmentMinutes || 'unknown'} min assignment`);

            // Roll for fun reward
            if (Math.random() < funRewardChance) {
                giveFunReward(assignmentMinutes);
            }

            showRewardNotification(message, points);
            updateRewardDisplay();
        }

        function giveFunReward(assignmentMinutes = null) {
            // Determine rarity based on probability and assignment length
            const rarityRoll = Math.random();
            let targetRarity;

            // Better items for longer assignments
            if (assignmentMinutes && assignmentMinutes >= 50) {
                // 50+ minute assignments get better odds
                if (rarityRoll < 0.3) targetRarity = "common";          // 30%
                else if (rarityRoll < 0.6) targetRarity = "uncommon";   // 30%
                else if (rarityRoll < 0.85) targetRarity = "rare";      // 25%
                else targetRarity = "legendary";                        // 15%
            } else if (assignmentMinutes && assignmentMinutes >= 25) {
                // 25-49 minute assignments get slightly better odds
                if (rarityRoll < 0.4) targetRarity = "common";          // 40%
                else if (rarityRoll < 0.7) targetRarity = "uncommon";   // 30%
                else if (rarityRoll < 0.9) targetRarity = "rare";       // 20%
                else targetRarity = "legendary";                        // 10%
            } else {
                // Standard odds for shorter assignments
                if (rarityRoll < 0.5) targetRarity = "common";          // 50%
                else if (rarityRoll < 0.8) targetRarity = "uncommon";   // 30%
                else if (rarityRoll < 0.95) targetRarity = "rare";      // 15%
                else targetRarity = "legendary";                        // 5%
            }

            const availableRewards = FUN_REWARDS.filter(r => r.rarity === targetRarity);
            const randomReward = availableRewards[Math.floor(Math.random() * availableRewards.length)];

            // Add to collection if not already owned
            if (!collectedRewards.find(r => r.name === randomReward.name)) {
                collectedRewards.push({
                    ...randomReward,
                    dateCollected: new Date().toISOString()
                });

                // Save collection
                try {
                    localStorage.setItem('collectedRewards', JSON.stringify(collectedRewards));
                } catch { }

                showFunRewardNotification(randomReward);
            }
        }

        function showRewardNotification(message, points) {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-yellow-500 text-white px-4 py-2 rounded-lg shadow-lg z-50 transform translate-x-full transition-transform duration-300';
            notification.innerHTML = `
                <div class="flex items-center gap-2">
                    <span class="text-lg">‚≠ê</span>
                    <div>
                        <div class="font-semibold">${message}</div>
                        <div class="text-sm">+${points} points</div>
                    </div>
                </div>
            `;

            document.body.appendChild(notification);

            // Animate in
            setTimeout(() => {
                notification.style.transform = 'translateX(0)';
            }, 100);

            // Animate out and remove
            setTimeout(() => {
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        function showFunRewardNotification(reward) {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `fixed top-20 right-4 bg-gradient-to-r ${getRarityColors(reward.rarity)} text-white px-4 py-3 rounded-lg shadow-lg z-50 transform translate-x-full transition-transform duration-300`;
            notification.innerHTML = `
                <div class="flex items-center gap-3">
                    <span class="text-2xl">${reward.emoji}</span>
                    <div>
                        <div class="font-semibold">${reward.name}</div>
                        <div class="text-sm opacity-90">${reward.message}</div>
                        <div class="text-xs font-bold uppercase">${reward.rarity}</div>
                    </div>
                </div>
            `;

            document.body.appendChild(notification);

            // Animate in
            setTimeout(() => {
                notification.style.transform = 'translateX(0)';
            }, 100);

            // Animate out and remove
            setTimeout(() => {
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => notification.remove(), 300);
            }, 4000);

            // Extra confetti for rare rewards
            if (reward.rarity === 'rare' || reward.rarity === 'legendary') {
                setTimeout(() => triggerCelebration(), 500);
            }
        }

        function getRarityColors(rarity) {
            switch (rarity) {
                case 'common': return 'from-gray-500 to-gray-600';
                case 'uncommon': return 'from-green-500 to-green-600';
                case 'rare': return 'from-blue-500 to-purple-600';
                case 'legendary': return 'from-yellow-400 to-orange-500';
                default: return 'from-gray-500 to-gray-600';
            }
        }

        function updateRewardDisplay() {
            document.getElementById('reward-points').textContent = `${rewardPoints} ‚≠ê`;
        }

        function checkDailyGoal() {
            const today = new Date().toDateString();
            const completedToday = studyData.filter(task =>
                task.completed &&
                task.completedDate &&
                new Date(task.completedDate).toDateString() === today
            ).length;

            if (completedToday >= 3) { // Goal: complete 3 tasks per day
                giveReward('DAILY_GOAL');
            }
        }

        function updateStreak() {
            const today = new Date().toDateString();

            if (lastStudyDate === today) return; // Already updated today

            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            const yesterdayStr = yesterday.toDateString();

            if (lastStudyDate === yesterdayStr) {
                streakCount++;
            } else if (lastStudyDate !== today) {
                streakCount = 1; // Reset streak
            }

            lastStudyDate = today;

            // Check for streak rewards
            if (streakCount === 3) {
                giveReward('STREAK_3');
            } else if (streakCount === 7) {
                giveReward('STREAK_7');
            }
        }

        // =============================
        // Collection Modal Functions
        // =============================
        function showCollectionModal() {
            const modal = document.getElementById('collection-modal-backdrop');

            // Update statistics
            document.getElementById('total-points').textContent = rewardPoints;
            document.getElementById('total-collected').textContent = collectedRewards.length;
            document.getElementById('current-streak').textContent = streakCount;

            // Calculate completion rate
            const totalTasks = studyData.length;
            const completedTasks = studyData.filter(task => task.completed).length;
            const completionRate = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
            document.getElementById('completion-rate').textContent = `${completionRate}%`;

            // Populate collected items
            const collectedContainer = document.getElementById('collected-items');
            if (collectedRewards.length === 0) {
                collectedContainer.innerHTML = `
                    <div class="col-span-full text-center py-8">
                        <div class="text-4xl mb-2">üéÅ</div>
                        <p class="text-gray-500 dark:text-gray-400">No items collected yet!</p>
                        <p class="text-sm text-gray-400 dark:text-gray-500">Complete assignments to start collecting.</p>
                    </div>
                `;
            } else {
                collectedContainer.innerHTML = collectedRewards.map(item => `
                    <div class="bg-white dark:bg-gray-700 border-2 ${getRarityBorderClass(item.rarity)} rounded-lg p-4 text-center hover:scale-105 transition-transform">
                        <div class="text-3xl mb-2">${item.emoji}</div>
                        <div class="font-semibold text-sm text-gray-900 dark:text-gray-100">${item.name}</div>
                        <div class="text-xs text-gray-500 dark:text-gray-400 mt-1 uppercase font-bold ${getRarityTextClass(item.rarity)}">${item.rarity}</div>
                        <div class="text-xs text-gray-400 dark:text-gray-500 mt-2">${new Date(item.dateCollected).toLocaleDateString()}</div>
                    </div>
                `).join('');
            }

            // Populate available items (not yet collected)
            const availableContainer = document.getElementById('available-items');
            const uncollectedItems = FUN_REWARDS.filter(item =>
                !collectedRewards.find(collected => collected.name === item.name)
            );

            availableContainer.innerHTML = uncollectedItems.map(item => `
                <div class="bg-gray-100 dark:bg-gray-600 border border-gray-300 dark:border-gray-500 rounded-lg p-4 text-center">
                    <div class="text-3xl mb-2 grayscale">${item.emoji}</div>
                    <div class="font-semibold text-sm text-gray-600 dark:text-gray-300">???</div>
                    <div class="text-xs text-gray-400 dark:text-gray-500 mt-1 uppercase font-bold">${item.rarity}</div>
                </div>
            `).join('');

            // Show modal
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function hideCollectionModal() {
            const modal = document.getElementById('collection-modal-backdrop');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        function getRarityBorderClass(rarity) {
            switch (rarity) {
                case 'common': return 'border-gray-400';
                case 'uncommon': return 'border-green-400';
                case 'rare': return 'border-blue-400';
                case 'legendary': return 'border-yellow-400';
                default: return 'border-gray-400';
            }
        }

        function getRarityTextClass(rarity) {
            switch (rarity) {
                case 'common': return 'text-gray-500';
                case 'uncommon': return 'text-green-500';
                case 'rare': return 'text-blue-500';
                case 'legendary': return 'text-yellow-500';
                default: return 'text-gray-500';
            }
        }

        // =============================
        // Break Modal Functions
        // =============================
        function showBreakModal() {
            const modal = document.getElementById('break-modal-backdrop');
            const messageElement = document.getElementById('break-message');
            const timerElement = document.getElementById('break-timer');

            // Show random encouraging message
            const randomMessage = ENCOURAGING_MESSAGES[Math.floor(Math.random() * ENCOURAGING_MESSAGES.length)];
            messageElement.textContent = randomMessage;

            // Set up break timer (5 minutes)
            let breakTimeLeft = 5 * 60; // 5 minutes in seconds
            timerElement.textContent = PomodoroEngine.formatTime(breakTimeLeft);

            // Show modal
            modal.classList.remove('hidden');
            modal.classList.add('flex');

            // Start break countdown
            breakInterval = setInterval(() => {
                breakTimeLeft--;
                timerElement.textContent = PomodoroEngine.formatTime(breakTimeLeft);

                if (breakTimeLeft <= 0) {
                    hideBreakModal();
                }
            }, 1000);

            // Trigger celebration
            triggerCelebration();
        }

        function hideBreakModal() {
            const modal = document.getElementById('break-modal-backdrop');
            modal.classList.add('hidden');
            modal.classList.remove('flex');

            if (breakInterval) {
                clearInterval(breakInterval);
                breakInterval = null;
            }
        }

        // =============================
        // Initial Load
        // =============================
        document.addEventListener('DOMContentLoaded', () => {
            // Load saved data
            try {
                rewardPoints = parseInt(localStorage.getItem('rewardPointsV1') || '0', 10) || 0;
                streakCount = parseInt(localStorage.getItem('streakCount') || '0', 10) || 0;
                lastStudyDate = localStorage.getItem('lastStudyDate') || null;
                collectedRewards = JSON.parse(localStorage.getItem('collectedRewards') || '[]');
                assignmentProgress = JSON.parse(localStorage.getItem('assignmentProgress') || '{}');
            } catch {
                rewardPoints = 0;
                streakCount = 0;
                lastStudyDate = null;
                collectedRewards = [];
                assignmentProgress = {};
            }

            // Process data first
            studyData = processData(ROWS);
            console.log('Study data processed:', studyData.length, 'tasks');

            // Render dashboard immediately without Pomodoro
            renderDashboard();

            // Render future assignments
            renderFutureAssignments();

            // Initialize Pomodoro timer
            try {
                pomodoro = new PomodoroEngine.PomodoroTimer({
                    workSeconds: 25 * 60,
                    shortBreakSeconds: 5 * 60,
                    longBreakSeconds: 15 * 60,
                    cyclesPerSet: 1  // Complete task after 1 cycle
                });
                pomodoro.on(state => {
                    console.log('Pomodoro state update:', state);
                    const activeTask = studyData.find(t => t.id === state.taskId);

                    if (state.phase === 'break' && state.remainingSeconds === state.phaseSeconds) {
                        // Just started break - show break modal
                        showBreakModal();
                    } else if (state.phase === 'complete' && activeTask && !activeTask.completed) {
                        activeTask.completed = true;
                        activeTask.completedDate = new Date().toISOString();

                        // Give rewards for completing Pomodoro (pass assignment minutes for better rewards)
                        giveReward('POMODORO_COMPLETE', null, null, activeTask.Minutes);

                        // Give additional reward for completing assignment
                        giveReward('ASSIGNMENT_COMPLETE', null, null, activeTask.Minutes);

                        // Update streak and check daily goals
                        updateStreak();
                        checkDailyGoal();

                        triggerCelebration();
                        pomodoro.reset();
                    }
                    updatePomodoroUI(state);
                });
                console.log('Pomodoro timer initialized successfully');
            } catch (e) {
                console.warn('Pomodoro initialization failed:', e);
                // Continue without Pomodoro
            }

            // Dark Mode Toggle
            const darkModeToggle = document.getElementById('dark-mode-toggle');
            const isDarkMode = localStorage.getItem('darkMode') === 'true';
            if (isDarkMode) {
                document.documentElement.classList.add('dark');
                darkModeToggle.textContent = '‚òÄÔ∏è';
            }

            darkModeToggle.addEventListener('click', () => {
                document.documentElement.classList.toggle('dark');
                const isDark = document.documentElement.classList.contains('dark');
                localStorage.setItem('darkMode', isDark);
                darkModeToggle.textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
            });

            // Calendar Modal Controls
            const calModal = document.getElementById('calendar-modal-backdrop');
            document.getElementById('toggle-calendar').addEventListener('click', () => calModal.classList.remove('hidden'));
            document.getElementById('calendar-modal-close-btn').addEventListener('click', () => calModal.classList.add('hidden'));
            calModal.addEventListener('click', (e) => {
                if (e.target === calModal) calModal.classList.add('hidden');
            });

            // Break Modal Controls
            document.getElementById('skip-break-btn').addEventListener('click', () => {
                hideBreakModal();
                if (pomodoro) {
                    pomodoro.reset(); // End the break and reset
                }
            });

            // Collection Modal Controls
            document.getElementById('collection-btn').addEventListener('click', () => {
                showCollectionModal();
            });
            document.getElementById('collection-modal-close-btn').addEventListener('click', () => {
                hideCollectionModal();
            });
            document.getElementById('collection-modal-backdrop').addEventListener('click', (e) => {
                if (e.target === document.getElementById('collection-modal-backdrop')) {
                    hideCollectionModal();
                }
            });

            // Future Assignments Expand/Collapse
            document.getElementById('expand-future-btn').addEventListener('click', () => {
                showAllFuture = !showAllFuture;
                renderFutureAssignments();
            });
        });
    </script>
</body>

</html>