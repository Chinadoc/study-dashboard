<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Study Dashboard</title>
    <!-- Tailwind CSS for modern styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts for a clean look -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Confetti library for celebrations -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <!-- Pomodoro engine -->
    <script src="pomodoro.js"></script>
    <style>
        /* Use the Inter font family */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Style for the modal backdrop */
        #modal-backdrop.hidden, #completion-modal-backdrop.hidden {
            display: none;
        }
        /* Position confetti canvas behind everything */
        #confetti-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 9999;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 p-4 sm:p-6">
    <canvas id="confetti-canvas"></canvas>

    <div class="max-w-7xl mx-auto mb-4">
        <a href="gunnaiza.html" class="text-blue-600 underline">View Gunnaiza's Dashboard</a>
    </div>

    <div id="dashboard-container" class="max-w-7xl mx-auto">
        <header class="mb-6 bg-white p-4 rounded-xl shadow-sm border border-gray-200">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-bold text-gray-900">Assignment Sheet</h1>
                    <p id="dashboard-subtitle" class="text-gray-500 mt-1"></p>
                </div>
                <div class="flex items-center gap-4">
                    <div class="text-sm font-semibold">
                        <span>Rewards:</span> 
                        <span id="reward-points" class="font-bold text-yellow-600 bg-yellow-100 px-2 py-1 rounded-md">0 ‚≠ê</span>
                    </div>
                    <button id="toggle-calendar" class="text-sm bg-indigo-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-600 transition-colors">Show Calendar</button>
                </div>
            </div>
        </header>

        <main id="dashboard-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">
            <!-- Day cards are generated by JavaScript -->
        </main>
    </div>

    <!-- Modal for displaying notes -->
    <div id="modal-backdrop" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-40">
        <div id="modal-content" class="bg-white rounded-lg shadow-xl w-full max-w-md p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 id="modal-title" class="text-lg font-semibold">Subject Notes</h3>
                <button id="modal-close-btn" class="text-gray-400 hover:text-gray-600 text-2xl leading-none">&times;</button>
            </div>
            <p id="modal-body" class="text-gray-600"></p>
        </div>
    </div>

    <!-- Calendar Modal -->
    <div id="calendar-modal-backdrop" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl h-[80vh] flex flex-col">
            <div class="p-4 border-b flex justify-between items-center">
                <h3 class="text-lg font-semibold">Full Assignment Calendar</h3>
                <button id="calendar-modal-close-btn" class="text-gray-400 hover:text-gray-600 text-2xl leading-none">&times;</button>
            </div>
            <iframe src="gunnaiza.html" class="w-full h-full"></iframe>
        </div>
    </div>


    <script>
        // =============================
        // State Management
        // =============================
        let studyData = [];
        let rewardPoints = 0;
        let pomodoro; // PomodoroEngine.PomodoroTimer

        // =============================
        // Configuration
        // =============================
        const MINUTES_PER_PAGE_SHORT = 5; // For tasks < 10 pages
        const MINUTES_PER_PAGE_LONG = 50; // Flat rate for tasks >= 10 pages
        const SPANISH_MINUTES_PER_PAGE = 7; // UPDATED
        const SPANISH_TEST_MINUTES = 15;
        const DAYS_ORDER = ["Wed", "Thu", "Fri"];
        const SUBJECT_COLORS = [
            'bg-blue-500', 'bg-indigo-500', 'bg-purple-500',
            'bg-pink-500', 'bg-red-500', 'bg-orange-500', 'bg-yellow-500', 'bg-green-500'
        ];

        // =============================
        // Raw Data
        // =============================
        const ROWS = [
            // Wednesday
            { "Day": "Wed", "Subject": "Algebra (U1 L6 + U2 L1)", "Pages": 13 + 2, "Notes": "U1 L6=13, U2 L1=2" },
            { "Day": "Wed", "Subject": "English (L3)", "Pages": 17, "Notes": "" },
            { "Day": "Wed", "Subject": "Health (L3)", "Pages": 1, "Notes": "" },
            { "Day": "Wed", "Subject": "PrinHLSC (L1+L2)", "Pages": 1 + 1, "Notes": "L1=1, L2=1" },
            { "Day": "Wed", "Subject": "Spanish (U1 L2 + test)", "Pages": 13, "Notes": "2-day plan; test at end" },
            { "Day": "Wed", "Subject": "History (U2 L2)", "Pages": 17, "Notes": "" },
            { "Day": "Wed", "Subject": "Biology", "Pages": 26, "Notes": "New addition" },

            // Thursday
            { "Day": "Thu", "Subject": "Algebra (L2+L3)", "Pages": 11 + 10, "Notes": "L2=11, L3=10" },
            { "Day": "Thu", "Subject": "Biology", "Pages": 10, "Notes": "" },
            { "Day": "Thu", "Subject": "English", "Pages": 13, "Notes": "" },
            { "Day": "Thu", "Subject": "Health", "Pages": 1, "Notes": "" },
            { "Day": "Thu", "Subject": "Spanish (U1 L2 + test)", "Pages": 12, "Notes": "Finish lesson + test" },
            { "Day": "Thu", "Subject": "History (L3)", "Pages": 17, "Notes": "" },

            // Friday
            { "Day": "Fri", "Subject": "Algebra (L4+L5)", "Pages": 12 + 13, "Notes": "L4=12, L5=13" },
            { "Day": "Fri", "Subject": "Biology", "Pages": 8, "Notes": "" },
            { "Day": "Fri", "Subject": "English", "Pages": 3, "Notes": "+ discussion" },
            { "Day": "Fri", "Subject": "Health (L5)", "Pages": 1, "Notes": "" },
            { "Day": "Fri", "Subject": "PrinHLSC (L3+L4)", "Pages": 1 + 1, "Notes": "L3=1, L4=1" },
            { "Day": "Fri", "Subject": "Spanish (U1 L3 + test)", "Pages": 10, "Notes": "2-day plan" }, // UPDATED
            { "Day": "Fri", "Subject": "History", "Pages": 14, "Notes": "" },
        ];

        // =============================
        // Data Processing Logic
        // =============================
        function processData(rawData) {
            let processed = [];
            let idCounter = 0;

            // 1. Pre-process to expand combined tasks based on notes
            const expandedRows = [];
            rawData.forEach(row => {
                if (row.Notes && row.Notes.includes('=')) {
                    const subjectBase = row.Subject.split('(')[0].trim();
                    const lessonParts = row.Notes.split(', ');
                    lessonParts.forEach(part => {
                        const [lesson, pagesStr] = part.split('=');
                        expandedRows.push({
                            ...row,
                            Subject: `${subjectBase} (${lesson.trim()})`,
                            Pages: parseInt(pagesStr, 10),
                            Notes: `Original: ${row.Subject}`
                        });
                    });
                } else {
                    expandedRows.push(row);
                }
            });

            // 2. Process expanded data with specific logic
            const processedSubjects = new Set();

            // Handle Spanish U1 L2 specifically
            const spanishU1L2Entries = expandedRows.filter(r => r.Subject.includes("Spanish (U1 L2"));
            if (spanishU1L2Entries.length > 0) {
                processed.push({
                    ...spanishU1L2Entries[0],
                    id: idCounter++, Subject: "Spanish U1 L2 - Reading", Day: "Wed",
                    Pages: 6, Minutes: 6 * MINUTES_PER_PAGE_SHORT, completed: false,
                    Notes: "First half of reading."
                });
                processed.push({
                    ...spanishU1L2Entries[0],
                    id: idCounter++, Subject: "Spanish U1 L2 - Reading + Test", Day: "Thu",
                    Pages: 6, Minutes: (6 * MINUTES_PER_PAGE_SHORT) + SPANISH_TEST_MINUTES, completed: false,
                    Notes: "Second half of reading plus the test."
                });
                processedSubjects.add("WedSpanish (U1 L2 + test)");
                processedSubjects.add("ThuSpanish (U1 L2 + test)");
            }

            // Handle Spanish U1 L3 specifically for Friday
            const spanishU1L3Entry = expandedRows.find(r => r.Subject.includes("Spanish (U1 L3"));
            if (spanishU1L3Entry) {
                processed.push({
                    ...spanishU1L3Entry,
                    id: idCounter++,
                    Subject: "Spanish U1 L3 - Part 1",
                    Day: "Fri",
                    Pages: 5,
                    Minutes: 5 * SPANISH_MINUTES_PER_PAGE,
                    completed: false,
                    Notes: "First half of reading (5 pages). Test will be on Monday."
                });
                processedSubjects.add("FriSpanish (U1 L3 + test)");
            }

            // 3. Process all remaining items with the new time logic
            expandedRows.forEach(row => {
                if (!processedSubjects.has(row.Day + row.Subject)) {
                    const isSpanish = row.Subject.includes("Spanish");
                    let minutes;
                    if (isSpanish) {
                        // This will only catch single-day Spanish lessons now
                        minutes = row.Pages * SPANISH_MINUTES_PER_PAGE;
                    } else {
                        minutes = row.Pages >= 10 ? MINUTES_PER_PAGE_LONG : row.Pages * MINUTES_PER_PAGE_SHORT;
                    }

                    processed.push({
                        ...row,
                        id: idCounter++,
                        Minutes: minutes,
                        completed: false
                    });
                }
            });

            return processed;
        }


        // =============================
        // Main Render Function
        // =============================
        function renderDashboard() {
            const dashboardGrid = document.getElementById('dashboard-grid');
            dashboardGrid.innerHTML = '';

            document.getElementById('dashboard-subtitle').textContent = `Long tasks (>=10 pages) are 50 min. Short tasks are 5 min/page. Spanish is 7 min/page.`;

            const subjectColorMap = new Map();
            let colorIndex = 0;
            studyData.forEach(row => {
                const baseSubject = row.Subject.split('(')[0].split('-')[0].trim();
                if (!subjectColorMap.has(baseSubject)) {
                    subjectColorMap.set(baseSubject, SUBJECT_COLORS[colorIndex % SUBJECT_COLORS.length]);
                    colorIndex++;
                }
            });

            DAYS_ORDER.forEach(day => {
                const dayData = studyData.filter(row => row.Day === day);
                const totalMinutes = dayData.reduce((sum, row) => sum + row.Minutes, 0);
                const remainingMinutes = dayData.reduce((sum, row) => sum + (row.completed ? 0 : row.Minutes), 0);

                const dayCard = document.createElement('div');
                dayCard.className = 'bg-white rounded-xl shadow-sm p-4 flex flex-col';

                const subjectItemsHTML = dayData.sort((a,b) => b.Minutes - a.Minutes).map(subject => {
                    const percentage = totalMinutes > 0 ? (subject.Minutes / totalMinutes) * 100 : 0;
                    const baseSubject = subject.Subject.split('(')[0].split('-')[0].trim();
                    const colorClass = subjectColorMap.get(baseSubject) || 'bg-gray-400';
                    const notes = subject.Notes || 'No notes for this entry.';
                    const isCompleted = subject.completed;

                    const pState = pomodoro ? pomodoro.getState() : null;
                    const isActiveTask = pState && pState.active && pState.taskId === subject.id;
                    const pomodoroProgress = isActiveTask && pState.phase !== 'complete'
                        ? Math.round(((pState.phaseSeconds - pState.remainingSeconds) / pState.phaseSeconds) * 100)
                        : 0;
                    const timerLabel = isActiveTask ? `${pState.phase === 'work' ? 'Focus' : (pState.phase === 'break' ? 'Break' : 'Done')}` : 'Ready';
                    const timeDisplay = isActiveTask ? PomodoroEngine.formatTime(pState.remainingSeconds) : PomodoroEngine.formatTime(25*60);

                    return `
                        <div class="subject-card p-3 rounded-lg border border-gray-200 transition-all duration-300 ${isCompleted ? 'opacity-50 bg-gray-50' : 'hover:bg-gray-50'}">
                            <div class="flex justify-between items-start">
                                <h3 class="font-semibold pr-2 text-sm ${isCompleted ? 'line-through' : ''}">${subject.Subject}</h3>
                                <p class="text-xs text-gray-600 font-medium whitespace-nowrap ${isCompleted ? 'line-through' : ''}">${subject.Minutes} min</p>
                            </div>
                            <div class="flex justify-between items-end mt-2">
                                <div>
                                    <p class="text-xs text-gray-500 ${isCompleted ? 'line-through' : ''}">${subject.Pages} Pages</p>
                                    <div class="w-full bg-gray-200 rounded-full h-1.5 mt-1" style="width: 120px;">
                                        <div class="${colorClass} h-1.5 rounded-full" style="width: ${percentage}%"></div>
                                    </div>
                                </div>
                                ${!isCompleted ? `<button class="complete-btn text-xs bg-green-500 text-white font-semibold py-1 px-3 rounded-full hover:bg-green-600 transition-colors" data-task-id="${subject.id}">Complete</button>` : `<span class="text-xs font-bold text-green-600">Done!</span>`}
                            </div>
                            ${!isCompleted ? `
                            <div class="mt-3">
                                <div class="flex items-center justify-between text-xs text-gray-600">
                                    <span class="font-medium">${timerLabel}</span>
                                    <span class="font-bold tabular-nums" id="pomo-time-${subject.id}">${timeDisplay}</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-2 mt-1">
                                    <div class="bg-indigo-500 h-2 rounded-full" id="pomo-progress-${subject.id}" style="width: ${pomodoroProgress}%"></div>
                                </div>
                                <div class="mt-2 flex gap-2 flex-wrap">
                                    ${!isActiveTask ? `<button class="pomo-btn text-xs bg-indigo-500 text-white px-2 py-1 rounded" data-action="start" data-task-id="${subject.id}" data-label="${subject.Subject.replace(/"/g, '&quot;')}">Start</button>` : ''}
                                    ${isActiveTask && pState.paused ? `<button class="pomo-btn text-xs bg-green-500 text-white px-2 py-1 rounded" data-action="resume" data-task-id="${subject.id}">Resume</button>` : ''}
                                    ${isActiveTask && !pState.paused ? `<button class="pomo-btn text-xs bg-yellow-500 text-white px-2 py-1 rounded" data-action="pause" data-task-id="${subject.id}">Pause</button>` : ''}
                                    ${isActiveTask ? `<button class="pomo-btn text-xs bg-gray-500 text-white px-2 py-1 rounded" data-action="reset" data-task-id="${subject.id}">Reset</button>` : ''}
                                </div>
                            </div>
                            ` : ''}
                        </div>
                    `;
                }).join('');

                dayCard.innerHTML = `
                    <div class="flex justify-between items-center mb-4 pb-3 border-b border-gray-200">
                        <h2 class="text-lg font-bold">${day}</h2>
                        <div>
                           <span class="text-sm font-semibold text-gray-500 line-through">${totalMinutes} min</span>
                           <span class="text-base font-semibold text-indigo-600 ml-2">${remainingMinutes} min left</span>
                        </div>
                    </div>
                    <div class="space-y-3">
                        ${subjectItemsHTML}
                    </div>
                `;

                dashboardGrid.appendChild(dayCard);
            });

            setupActionListeners();
            document.getElementById('reward-points').textContent = String(rewardPoints);
        }

        // =============================
        // Interactivity Setup
        // =============================
        function setupActionListeners() {
            // Notes Modal
            const notesModalBackdrop = document.getElementById('modal-backdrop');
            const notesModalTitle = document.getElementById('modal-title');
            const notesModalBody = document.getElementById('modal-body');
            const notesModalCloseBtn = document.getElementById('modal-close-btn');
            
            document.querySelectorAll('.subject-card h3').forEach(title => {
                title.addEventListener('click', (e) => {
                    notesModalTitle.textContent = title.textContent;
                    notesModalBody.textContent = "Notes would be displayed here."; // Placeholder
                    notesModalBackdrop.classList.remove('hidden');
                });
            });
            
            const closeNotesModal = () => notesModalBackdrop.classList.add('hidden');
            notesModalCloseBtn.addEventListener('click', closeNotesModal);
            notesModalBackdrop.addEventListener('click', (event) => {
                if (event.target === notesModalBackdrop) closeNotesModal();
            });

            // Manual complete button
            document.querySelectorAll('.complete-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const taskId = parseInt(e.target.dataset.taskId, 10);
                    const task = studyData.find(t => t.id === taskId);
                    if (task && !task.completed) {
                        task.completed = true;
                        rewardPoints += 1; // 1 point for manual completion
                        try { localStorage.setItem('rewardPointsV1', String(rewardPoints)); } catch {}
                        triggerCelebration();
                        renderDashboard();
                    }
                });
            });

            // Pomodoro controls
            document.querySelectorAll('.pomo-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const action = e.target.dataset.action;
                    const taskId = parseInt(e.target.dataset.taskId, 10);
                    const task = studyData.find(t => t.id === taskId);
                    if (!task || task.completed) return;
                    if (action === 'start') {
                        pomodoro.start(taskId, task.Subject);
                    } else if (action === 'pause') {
                        pomodoro.pause();
                    } else if (action === 'resume') {
                        pomodoro.resume();
                    } else if (action === 'reset') {
                        pomodoro.reset();
                    }
                });
            });
        }

        // =============================
        // Effects
        // =============================
        function triggerCelebration() {
            const myCanvas = document.getElementById('confetti-canvas');
            const myConfetti = confetti.create(myCanvas, {
                resize: true,
                useWorker: true
            });
            myConfetti({
                particleCount: 100,
                spread: 70,
                origin: { y: 0.6 }
            });
        }

        // =============================
        // Initial Load
        // =============================
        document.addEventListener('DOMContentLoaded', () => {
            try { rewardPoints = parseInt(localStorage.getItem('rewardPointsV1') || '0', 10) || 0; } catch { rewardPoints = 0; }
            
            studyData = processData(ROWS);

            pomodoro = new PomodoroEngine.PomodoroTimer({ workSeconds: 25 * 60, shortBreakSeconds: 5 * 60 });
            pomodoro.on(state => {
                const activeTask = studyData.find(t => t.id === state.taskId);
                if (state.phase === 'complete' && activeTask && !activeTask.completed) {
                    activeTask.completed = true;
                    rewardPoints += 3; // 3 points for finishing a pomodoro session
                    try { localStorage.setItem('rewardPointsV1', String(rewardPoints)); } catch {}
                    triggerCelebration();
                    pomodoro.reset(); // Also reset the timer
                }
                renderDashboard();
            });

            // Calendar Modal Controls
            const calModal = document.getElementById('calendar-modal-backdrop');
            document.getElementById('toggle-calendar').addEventListener('click', () => calModal.classList.remove('hidden'));
            document.getElementById('calendar-modal-close-btn').addEventListener('click', () => calModal.classList.add('hidden'));
            calModal.addEventListener('click', (e) => {
                if (e.target === calModal) calModal.classList.add('hidden');
            });

            renderDashboard();
        });
    </script>
</body>
</html>
