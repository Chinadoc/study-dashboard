<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0f172a">
    <title>Euro Keys - Locksmith Database</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a1628;
            --bg-secondary: #111d32;
            --bg-tertiary: #1a2942;
            --brand-primary: #fbbf24;
            --brand-secondary: #f59e0b;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --success: #22c55e;
            --border: rgba(251, 191, 36, 0.15);
            --radius: 12px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: linear-gradient(180deg, var(--bg-primary) 0%, #0d1829 100%);
            color: var(--text-primary);
            min-height: 100vh;
        }

        /* Top Bar */
        .top-bar {
            background: var(--brand-primary);
            color: var(--bg-primary);
            text-align: center;
            padding: 8px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        /* Header */
        .header {
            padding: 16px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.4rem;
            font-weight: 800;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .logo span {
            color: var(--brand-primary);
        }

        /* Container */
        .container {
            max-width: 700px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Hero */
        .hero {
            text-align: center;
            padding: 40px 20px;
        }

        .hero-title {
            font-size: 2rem;
            font-weight: 800;
            margin-bottom: 12px;
            line-height: 1.2;
        }

        .hero-title span {
            color: var(--brand-primary);
        }

        .hero-subtitle {
            color: var(--text-secondary);
            font-size: 1rem;
            margin-bottom: 30px;
        }

        /* VIN Input */
        .vin-section {
            display: flex;
            gap: 8px;
            max-width: 500px;
            margin: 0 auto 40px;
        }

        .vin-input {
            flex: 1;
            padding: 16px 20px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            color: var(--text-primary);
            font-size: 1rem;
            font-family: inherit;
        }

        .vin-input::placeholder {
            color: var(--text-muted);
        }

        .vin-input:focus {
            outline: none;
            border-color: var(--brand-primary);
        }

        .vin-btn {
            padding: 16px 24px;
            background: var(--brand-primary);
            border: none;
            border-radius: var(--radius);
            color: var(--bg-primary);
            font-weight: 700;
            font-size: 1rem;
            cursor: pointer;
            white-space: nowrap;
        }

        /* Section Title */
        .section-title {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section-title::after {
            content: '';
            flex: 1;
            height: 1px;
            background: var(--border);
        }

        /* Browse Section */
        .browse-section {
            margin-bottom: 40px;
        }

        .browse-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 12px;
        }

        .browse-select {
            padding: 14px 16px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            color: var(--text-primary);
            font-size: 0.95rem;
            font-family: inherit;
            cursor: pointer;
            appearance: none;
        }

        .browse-select:focus {
            outline: none;
            border-color: var(--brand-primary);
        }

        .search-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, var(--brand-primary), var(--brand-secondary));
            border: none;
            border-radius: var(--radius);
            color: var(--bg-primary);
            font-weight: 700;
            font-size: 1rem;
            cursor: pointer;
        }

        /* Make List */
        .make-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 8px;
        }

        .make-card {
            padding: 16px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
        }

        .make-card:hover {
            border-color: var(--brand-primary);
            background: var(--bg-tertiary);
        }

        .make-name {
            font-weight: 600;
            font-size: 0.95rem;
        }

        .make-count {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 4px;
        }

        /* Model List */
        .model-list {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .model-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 16px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            cursor: pointer;
        }

        .model-item:hover {
            border-color: var(--brand-primary);
        }

        .model-name {
            font-weight: 600;
        }

        .model-years {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        /* Vehicle View */
        .vehicle-view {
            display: none;
        }

        .vehicle-view.active {
            display: block;
        }

        .vehicle-header {
            text-align: center;
            padding: 30px 0;
            border-bottom: 1px solid var(--border);
            margin-bottom: 24px;
        }

        .vehicle-title {
            font-size: 1.6rem;
            font-weight: 800;
            margin-bottom: 8px;
        }

        .vehicle-badges {
            display: flex;
            justify-content: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .badge {
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .badge-primary {
            background: var(--brand-primary);
            color: var(--bg-primary);
        }

        .badge-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        /* Data Grid */
        .data-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .data-card {
            padding: 16px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius);
        }

        .data-card.full-width {
            grid-column: span 2;
        }

        .data-label {
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
        }

        .data-value {
            font-size: 1rem;
            font-weight: 600;
        }

        .data-value.highlight {
            color: var(--brand-primary);
        }

        .data-value a {
            color: var(--brand-primary);
            text-decoration: none;
        }

        /* Back Button */
        .back-bar {
            display: none;
            padding: 12px 20px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
        }

        .back-bar.visible {
            display: flex;
        }

        .back-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 0.9rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Footer */
        .footer {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-muted);
            font-size: 0.85rem;
        }

        /* Views */
        .view {
            display: none;
        }

        .view.active {
            display: block;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-muted);
        }

        @media (max-width: 480px) {
            .browse-grid {
                grid-template-columns: 1fr;
            }

            .make-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .data-grid {
                grid-template-columns: 1fr;
            }

            .data-card.full-width {
                grid-column: span 1;
            }
        }
    </style>
</head>

<body>

    <div class="top-bar">üìû Call (804) 506-0709</div>

    <header class="header">
        <div class="logo">üîë EURO <span>KEYS</span></div>
    </header>

    <div class="back-bar" id="backBar">
        <button class="back-btn" onclick="goBack()">‚Üê Back</button>
    </div>

    <!-- VIEW 1: Home -->
    <div class="view active" id="viewHome">
        <div class="hero">
            <h1 class="hero-title">Vehicle Intelligence <span>Decoded</span></h1>
            <p class="hero-subtitle">Instant access to key codes, transponder data, and locksmith specs</p>

            <div class="vin-section">
                <input type="text" class="vin-input" id="vinInput" placeholder="üîç Enter VIN (17 characters)"
                    maxlength="17" oninput="handleVinInput(this.value)">
                <button class="vin-btn" onclick="decodeVIN()">Decode</button>
            </div>
        </div>

        <div class="container">
            <div class="browse-section">
                <div class="section-title">Or Browse by Vehicle</div>
                <div class="browse-grid">
                    <select class="browse-select" id="yearSelect" onchange="loadMakesForYear()">
                        <option value="">Year</option>
                    </select>
                    <select class="browse-select" id="makeSelect" onchange="loadModelsForMake()">
                        <option value="">Make</option>
                    </select>
                    <select class="browse-select" id="modelSelect">
                        <option value="">Model</option>
                    </select>
                </div>
                <button class="search-btn" onclick="searchVehicle()">üîç Search Database</button>
            </div>

            <div class="section-title">Popular Makes</div>
            <div class="make-grid" id="makeGrid">
                <div class="loading">Loading...</div>
            </div>
        </div>
    </div>

    <!-- VIEW 2: Models -->
    <div class="view" id="viewModels">
        <div class="container">
            <div class="section-title" id="modelsTitle">Select Model</div>
            <div class="model-list" id="modelList"></div>
        </div>
    </div>

    <!-- VIEW 3: Vehicle Data -->
    <div class="view" id="viewVehicle">
        <div class="container">
            <div class="vehicle-header">
                <h1 class="vehicle-title" id="vehicleTitle">2019 Chevrolet Colorado</h1>
                <div class="vehicle-badges" id="vehicleBadges">
                    <span class="badge badge-primary" id="badgeChip">ID46</span>
                    <span class="badge badge-secondary" id="badgeFreq">315 MHz</span>
                </div>
            </div>

            <div class="data-grid" id="dataGrid">
                <!-- Populated by JS -->
            </div>
        </div>
    </div>

    <footer class="footer">
        ¬© 2025 Euro Keys<br>
        Professional Automotive Locksmith - Richmond, VA
    </footer>

    <script>
        const API = 'https://euro-keys.jeremy-samuels17.workers.dev';

        // Valid automotive makes only (filter out garbage data)
        const VALID_MAKES = [
            'Acura', 'Alfa Romeo', 'Aston Martin', 'Audi', 'Bentley', 'BMW', 'Buick',
            'Cadillac', 'Chevrolet', 'Chrysler', 'Dodge', 'Ferrari', 'Fiat', 'Ford',
            'Genesis', 'GMC', 'Honda', 'Hyundai', 'Infiniti', 'Jaguar', 'Jeep', 'Kia',
            'Lamborghini', 'Land Rover', 'Lexus', 'Lincoln', 'Maserati', 'Mazda',
            'McLaren', 'Mercedes-Benz', 'Mercedes', 'Mini', 'Mitsubishi', 'Nissan',
            'Porsche', 'Ram', 'Rolls-Royce', 'Subaru', 'Tesla', 'Toyota', 'Volkswagen',
            'Volvo'
        ];

        let currentMake = null;
        let currentView = 'viewHome';

        function showView(viewId) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');
            document.getElementById('backBar').classList.toggle('visible', viewId !== 'viewHome');
            currentView = viewId;
        }

        function goBack() {
            if (currentView === 'viewVehicle') {
                showView('viewModels');
            } else {
                showView('viewHome');
            }
        }

        // Populate years
        function populateYears() {
            const select = document.getElementById('yearSelect');
            const year = new Date().getFullYear() + 1;
            for (let y = year; y >= 2000; y--) {
                select.innerHTML += `<option value="${y}">${y}</option>`;
            }
        }

        // Load makes for dropdown
        async function loadMakesForYear() {
            const year = document.getElementById('yearSelect').value;
            const select = document.getElementById('makeSelect');
            select.innerHTML = '<option value="">Loading...</option>';

            try {
                const res = await fetch(`${API}/api/master?year=${year}&limit=1000`);
                const data = await res.json();
                const makes = [...new Set(data.rows.map(r => r.make))]
                    .filter(m => VALID_MAKES.some(v => v.toLowerCase() === m.toLowerCase()))
                    .sort();

                select.innerHTML = '<option value="">Make</option>';
                makes.forEach(m => {
                    select.innerHTML += `<option value="${m}">${m}</option>`;
                });
            } catch (e) {
                select.innerHTML = '<option value="">Make</option>';
            }
        }

        // Load models for dropdown
        async function loadModelsForMake() {
            const year = document.getElementById('yearSelect').value;
            const make = document.getElementById('makeSelect').value;
            const select = document.getElementById('modelSelect');

            if (!make) return;
            select.innerHTML = '<option value="">Loading...</option>';

            try {
                const res = await fetch(`${API}/api/master?year=${year}&make=${encodeURIComponent(make)}&limit=500`);
                const data = await res.json();
                const models = [...new Set(data.rows.map(r => r.model))].sort();

                select.innerHTML = '<option value="">Model</option>';
                models.forEach(m => {
                    select.innerHTML += `<option value="${m}">${m}</option>`;
                });
            } catch (e) {
                select.innerHTML = '<option value="">Model</option>';
            }
        }

        // Search vehicle from dropdowns
        async function searchVehicle() {
            const year = document.getElementById('yearSelect').value;
            const make = document.getElementById('makeSelect').value;
            const model = document.getElementById('modelSelect').value;

            if (!year || !make || !model) {
                alert('Please select year, make, and model');
                return;
            }

            await loadVehicleData(make, model, year);
        }

        // Load popular makes grid
        async function loadMakes() {
            try {
                const res = await fetch(`${API}/api/master?limit=2000`);
                const data = await res.json();

                const makeCounts = {};
                data.rows.forEach(r => {
                    if (VALID_MAKES.some(v => v.toLowerCase() === r.make.toLowerCase())) {
                        makeCounts[r.make] = (makeCounts[r.make] || 0) + 1;
                    }
                });

                // Sort by count, take top 12
                const topMakes = Object.entries(makeCounts)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 12);

                document.getElementById('makeGrid').innerHTML = topMakes.map(([make, count]) => `
                <div class="make-card" onclick="selectMake('${make.replace(/'/g, "\\'")}')">
                    <div class="make-name">${make}</div>
                    <div class="make-count">${count} models</div>
                </div>
            `).join('');
            } catch (e) {
                document.getElementById('makeGrid').innerHTML = '<div class="loading">Failed to load</div>';
            }
        }

        // Select make from grid
        async function selectMake(make) {
            currentMake = make;
            document.getElementById('modelsTitle').textContent = `${make} Models`;
            document.getElementById('modelList').innerHTML = '<div class="loading">Loading...</div>';
            showView('viewModels');

            try {
                const res = await fetch(`${API}/api/master?make=${encodeURIComponent(make)}&limit=500`);
                const data = await res.json();

                const models = {};
                data.rows.forEach(r => {
                    if (!models[r.model]) {
                        models[r.model] = { years: [], data: r };
                    }
                    if (r.year_start && r.year_end) {
                        models[r.model].years.push(`${r.year_start}-${r.year_end}`);
                    }
                });

                const modelNames = Object.keys(models).sort();

                document.getElementById('modelList').innerHTML = modelNames.map(model => {
                    const yearStr = models[model].years[0] || '';
                    return `
                    <div class="model-item" onclick="loadVehicleData('${currentMake.replace(/'/g, "\\'")}', '${model.replace(/'/g, "\\'")}')">
                        <span class="model-name">${model}</span>
                        <span class="model-years">${yearStr} ‚Üí</span>
                    </div>
                `;
                }).join('');
            } catch (e) {
                document.getElementById('modelList').innerHTML = '<div class="loading">Failed to load</div>';
            }
        }

        // Load vehicle data
        async function loadVehicleData(make, model, year = null) {
            showView('viewVehicle');

            try {
                let url = `${API}/api/browse?make=${encodeURIComponent(make)}&model=${encodeURIComponent(model)}&limit=1`;
                if (year) url += `&year=${year}`;

                const res = await fetch(url);
                const data = await res.json();

                if (data.rows && data.rows.length > 0) {
                    const v = data.rows[0];
                    displayVehicle(v, make, model);
                } else {
                    document.getElementById('vehicleTitle').textContent = `${make} ${model}`;
                    document.getElementById('dataGrid').innerHTML = '<div class="data-card full-width"><div class="data-value">No data found</div></div>';
                }
            } catch (e) {
                console.error(e);
            }
        }

        // Display vehicle data
        function displayVehicle(v, make, model) {
            const yearStr = v.year_start ? `${v.year_start}` : '';
            document.getElementById('vehicleTitle').textContent = `${yearStr} ${make} ${model}`;

            // Badges
            const chip = v.chip || v.chip_technology || '';
            const freq = v.frequency ? `${v.frequency} MHz` : '';
            document.getElementById('badgeChip').textContent = chip || 'Unknown';
            document.getElementById('badgeFreq').textContent = freq || '315 MHz';

            // Data grid
            const fields = [
                { label: 'FCC ID', value: v.fcc_id, link: v.fcc_id ? `https://fccid.io/${v.fcc_id}` : null, highlight: true },
                { label: 'Immobilizer', value: v.immobilizer_system || v.immobilizer },
                { label: 'Transponder', value: v.chip || v.chip_technology },
                { label: 'Frequency', value: v.frequency ? `${v.frequency} MHz` : null },
                { label: 'Key Blank', value: v.keyway },
                { label: 'Buttons', value: v.buttons },
                { label: 'Battery', value: v.battery },
                { label: 'OEM Part #', value: v.oem_part_number },
            ];

            document.getElementById('dataGrid').innerHTML = fields.map(f => {
                const val = f.value || 'N/A';
                const content = f.link
                    ? `<a href="${f.link}" target="_blank">${val}</a>`
                    : val;
                return `
                <div class="data-card">
                    <div class="data-label">${f.label}</div>
                    <div class="data-value${f.highlight ? ' highlight' : ''}">${content}</div>
                </div>
            `;
            }).join('');
        }

        // VIN decode
        function handleVinInput(vin) {
            if (vin.length === 17) {
                decodeVIN();
            }
        }

        async function decodeVIN() {
            const vin = document.getElementById('vinInput').value.trim();
            if (vin.length !== 17) {
                alert('VIN must be 17 characters');
                return;
            }

            try {
                const res = await fetch(`https://vpic.nhtsa.dot.gov/api/vehicles/DecodeVinValues/${vin}?format=json`);
                const data = await res.json();
                const r = data.Results?.[0];

                if (r?.Make && r?.Model) {
                    await loadVehicleData(r.Make, r.Model, r.ModelYear);
                } else {
                    alert('Could not decode VIN');
                }
            } catch (e) {
                alert('VIN decode failed');
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            populateYears();
            loadMakes();
        });
    </script>
</body>

</html>