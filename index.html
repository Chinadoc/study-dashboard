<!DOCTYPE html>
<html lang="en" data-version="1.0.13">

<head>
    <!-- Mobile Detection: Redirect phone users to mobile-optimized version -->
    <script>
        (function () {
            // Skip if user explicitly chose desktop version
            if (localStorage.getItem('eurokeys_prefer_desktop') === 'true') return;

            // Detect mobile: screen width OR mobile user agent
            const isMobile = window.innerWidth <= 768 ||
                /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

            if (isMobile && !window.location.pathname.includes('mobile_v2')) {
                // Show choice modal instead of auto-redirect
                document.addEventListener('DOMContentLoaded', function () {
                    const banner = document.createElement('div');
                    banner.id = 'mobileBanner';
                    banner.innerHTML = `
                        <div style="position:fixed;top:0;left:0;right:0;z-index:10000;background:linear-gradient(135deg,#10b981,#34d399);padding:12px 16px;display:flex;align-items:center;justify-content:space-between;gap:12px;box-shadow:0 4px 20px rgba(0,0,0,0.3);">
                            <span style="color:#000;font-weight:600;font-size:0.9rem;">ðŸ“± Try our new mobile app!</span>
                            <div style="display:flex;gap:8px;">
                                <button onclick="window.location.href='mobile_v2.html'" style="background:#000;color:#10b981;border:none;padding:8px 16px;border-radius:20px;font-weight:700;font-size:0.8rem;cursor:pointer;">Open App</button>
                                <button onclick="localStorage.setItem('eurokeys_prefer_desktop','true');document.getElementById('mobileBanner').remove();" style="background:transparent;color:#000;border:1px solid #000;padding:8px 12px;border-radius:20px;font-weight:600;font-size:0.8rem;cursor:pointer;">âœ•</button>
                            </div>
                        </div>
                    `;
                    document.body.prepend(banner);
                });
            }
        })();
    </script>
    <!-- v1.0.4 - Restored InventoryManager.getAllKeys functionality -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Euro Keys">
    <link rel="manifest" href="/manifest.webmanifest">
    <link rel="apple-touch-icon" href="/assets/icon-192.png">
    <title>Euro Keys - Locksmith Database</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a1628;
            --bg-secondary: #111d32;
            --bg-tertiary: #1a2942;
            --brand-primary: #fbbf24;
            --brand-secondary: #f59e0b;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --success: #22c55e;
            --border: rgba(251, 191, 36, 0.15);
            --radius: 12px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: linear-gradient(180deg, var(--bg-primary) 0%, #0d1829 100%);
            color: var(--text-primary);
            min-height: 100vh;
        }

        /* Top Bar */
        .top-bar {
            background: var(--brand-primary);
            color: var(--bg-primary);
            text-align: center;
            padding: 10px;
            font-size: 0.9rem;
            font-weight: 600;
        }

        /* Header */
        .header {
            padding: 20px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--text-primary);
        }

        .logo span {
            color: var(--brand-primary);
        }

        .header-right {
            display: flex;
            gap: 16px;
            align-items: center;
        }

        .header-link {
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 0.9rem;
        }

        .header-avatar {
            width: 36px;
            height: 36px;
            background: var(--brand-primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: var(--bg-primary);
        }

        .google-signin-btn {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 20px;
            background: #ffffff;
            border: 1px solid #dadce0;
            border-radius: 24px;
            font-size: 0.9rem;
            font-weight: 500;
            color: #3c4043;
            cursor: pointer;
            transition: all 0.2s;
            font-family: 'Roboto', 'Inter', sans-serif;
        }

        .google-signin-btn:hover {
            background: #f7f8f8;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12);
        }

        .google-signin-btn svg {
            width: 18px;
            height: 18px;
        }

        .user-menu {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-menu .header-avatar {
            cursor: pointer;
        }

        .user-menu .user-name {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        /* Header Search */
        .header-search-container {
            display: flex;
            align-items: center;
            position: relative;
        }

        .header-search-toggle {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .header-search-toggle:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .header-search-box {
            position: absolute;
            right: 0;
            top: 100%;
            margin-top: 8px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 8px;
            display: flex;
            gap: 6px;
            z-index: 100;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
            animation: slideDown 0.2s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .header-search-box input {
            width: 220px;
            padding: 10px 14px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .header-search-box input:focus {
            outline: none;
            border-color: var(--brand-primary);
        }

        .header-search-box button {
            padding: 10px 16px;
            background: var(--brand-primary);
            border: none;
            border-radius: 8px;
            color: var(--bg-primary);
            font-weight: 600;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .header-search-box button.close-search {
            background: var(--bg-tertiary);
            color: var(--text-muted);
            padding: 10px 12px;
        }

        .header-search-box button:hover {
            opacity: 0.9;
        }

        @media (max-width: 768px) {
            .header-search-box {
                right: -60px;
                width: calc(100vw - 40px);
            }

            .header-search-box input {
                flex: 1;
                width: auto;
            }
        }

        .tabs {
            display: flex;
            justify-content: center;
            gap: 8px;
            padding: 16px 24px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
        }

        .tab {
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            background: transparent;
            color: var(--text-secondary);
        }

        .tab:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .tab.active {
            background: var(--brand-primary);
            color: var(--bg-primary);
        }

        /* Container */
        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 40px 24px;
        }

        /* Page Title */
        .page-title {
            text-align: center;
            margin-bottom: 12px;
        }

        .page-title h1 {
            font-size: 2.2rem;
            font-weight: 800;
        }

        .page-title h1 span {
            color: var(--brand-primary);
        }

        .page-subtitle {
            text-align: center;
            color: var(--text-secondary);
            margin-bottom: 32px;
            font-size: 1rem;
        }

        /* Browse Box */
        .browse-box {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 32px;
            max-width: 700px;
            margin: 0 auto 40px;
        }

        .browse-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin-bottom: 20px;
        }

        .browse-field {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .browse-label {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
        }

        .browse-select {
            padding: 16px 20px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            color: var(--text-primary);
            font-size: 1rem;
            font-family: inherit;
            cursor: pointer;
            appearance: none;
        }

        .browse-select:focus {
            outline: none;
            border-color: var(--brand-primary);
        }

        .search-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
            padding: 18px;
            background: var(--brand-primary);
            border: none;
            border-radius: var(--radius);
            color: var(--bg-primary);
            font-weight: 700;
            font-size: 1.1rem;
            cursor: pointer;
        }

        /* FCC Table */
        .fcc-search {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
        }

        /* FCC Filters */
        .fcc-filters {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .fcc-filter {
            padding: 10px 20px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 24px;
            color: var(--text-secondary);
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .fcc-filter:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .fcc-filter.active {
            background: var(--brand-primary);
            color: var(--bg-primary);
            border-color: var(--brand-primary);
        }

        .fcc-search input {
            flex: 1;
            padding: 14px 20px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            color: var(--text-primary);
            font-size: 1rem;
        }

        .fcc-search input::placeholder {
            color: var(--text-muted);
        }

        .fcc-search input:focus {
            outline: none;
            border-color: var(--brand-primary);
        }

        .fcc-table-wrapper {
            overflow-x: auto;
        }

        .fcc-table {
            width: 100%;
            border-collapse: collapse;
        }

        .fcc-table th {
            text-align: left;
            padding: 14px 12px;
            background: var(--bg-secondary);
            color: var(--text-muted);
            font-weight: 600;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid var(--border);
        }

        .fcc-table td {
            padding: 14px 12px;
            border-bottom: 1px solid var(--border);
            font-size: 0.9rem;
        }

        .fcc-table tr:hover {
            background: var(--bg-secondary);
        }

        .fcc-link {
            color: var(--brand-primary);
            text-decoration: none;
            font-weight: 600;
        }

        .fcc-link:hover {
            text-decoration: underline;
        }

        .amazon-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            background: #ff9900;
            color: #000;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 600;
            text-decoration: none;
            transition: all 0.2s;
        }

        .amazon-btn:hover {
            background: #ffad33;
            transform: translateY(-1px);
        }

        /* Mobile-First FCC Cards */
        .fcc-cards {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .fcc-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 20px;
            transition: all 0.3s ease;
        }

        .fcc-card:hover {
            border-color: var(--brand-primary);
            box-shadow: 0 8px 32px rgba(251, 191, 36, 0.15);
            transform: translateY(-2px);
        }

        .fcc-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
            gap: 12px;
        }

        .fcc-id-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            background: linear-gradient(135deg, var(--brand-primary), var(--brand-secondary));
            color: #000;
            border-radius: 24px;
            font-size: 0.9rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
        }

        .fcc-id-badge:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 16px rgba(251, 191, 36, 0.4);
        }

        .fcc-oem {
            padding: 6px 12px;
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            border-radius: 8px;
            font-size: 0.8rem;
            font-family: monospace;
        }

        .fcc-vehicles {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 16px;
        }

        .vehicle-chip {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 0.8rem;
            color: var(--text-primary);
            transition: all 0.2s;
        }

        .vehicle-chip:hover {
            background: var(--bg-primary);
            border-color: var(--brand-primary);
        }

        .vehicle-chip .make-icon {
            font-size: 1rem;
        }

        .vehicle-chip-more {
            background: rgba(251, 191, 36, 0.15);
            color: var(--brand-primary);
            border-color: var(--brand-primary);
            cursor: pointer;
        }

        /* Grouped Vehicle Styles */
        .fcc-card-image {
            width: 100%;
            height: 140px;
            background: var(--bg-primary);
            border-radius: 12px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            border: 1px solid var(--border);
            padding: 8px;
        }

        .fcc-card-image img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .vehicle-group-chip {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 0.8rem;
            color: var(--text-primary);
            margin: 0 4px 4px 0;
            transition: all 0.2s;
        }

        .vehicle-group-chip:hover {
            border-color: var(--brand-primary);
            background: var(--bg-secondary);
        }

        .vehicle-group-make {
            font-weight: 700;
            color: var(--brand-primary);
        }

        .vehicle-group-years {
            color: var(--text-muted);
            font-size: 0.75rem;
        }

        @media (max-width: 600px) {
            .fcc-card-image {
                height: 120px;
            }

            .vehicle-group-chip {
                padding: 4px 8px;
                font-size: 0.75rem;
            }
        }

        .fcc-card-meta {
            display: flex;
            gap: 16px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .fcc-meta-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .fcc-meta-item span:last-child {
            color: var(--text-primary);
            font-weight: 600;
        }

        .fcc-card-actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .fcc-action-btn {
            flex: 1;
            min-width: 120px;
            padding: 12px 16px;
            border-radius: 10px;
            font-size: 0.9rem;
            font-weight: 600;
            text-align: center;
            text-decoration: none;
            transition: all 0.2s;
        }

        .fcc-action-primary {
            background: linear-gradient(135deg, #ff9900, #ff6600);
            color: #000;
        }

        .fcc-action-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(255, 153, 0, 0.4);
        }

        .fcc-action-secondary {
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-primary);
            border: 1px solid var(--border);
            backdrop-filter: blur(8px);
        }

        .fcc-action-secondary:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: var(--brand-primary);
            transform: translateY(-2px);
        }

        /* Hide table on mobile, show cards */
        @media (max-width: 768px) {
            .fcc-table-wrapper {
                display: none;
            }

            .fcc-cards {
                display: flex;
            }
        }

        /* Show table on desktop, hide cards */
        @media (min-width: 769px) {
            .fcc-cards {
                display: none;
            }

            .fcc-table-wrapper {
                display: block;
            }
        }

        /* Beautiful modal vehicle list */
        .modal-vehicles-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            max-height: 200px;
            overflow-y: auto;
            padding: 12px;
            background: var(--bg-tertiary);
            border-radius: 12px;
            margin-bottom: 16px;
        }

        /* Vehicle Card */
        .vehicle-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 16px;
        }

        /* Key Carousel - for switching between compatible keys */
        .key-carousel {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 12px;
            padding: 12px;
            background: var(--bg-tertiary);
            border-radius: 12px;
            border: 1px solid var(--border);
        }

        .key-carousel-title {
            width: 100%;
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .key-thumb {
            padding: 8px 14px;
            background: var(--bg-secondary);
            border: 2px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.8rem;
            color: var(--text-secondary);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            min-width: 80px;
            text-align: center;
        }

        .key-thumb:hover {
            border-color: var(--brand-primary);
            transform: translateY(-2px);
        }

        .key-thumb.active {
            border-color: var(--brand-primary);
            background: rgba(234, 179, 8, 0.1);
            color: var(--text-primary);
        }

        .key-thumb-icon {
            font-size: 1.2rem;
        }

        .key-thumb-label {
            font-weight: 600;
            font-size: 0.7rem;
        }

        .key-thumb-price {
            font-size: 0.65rem;
            color: #22c55e;
            font-weight: 700;
        }

        .key-carousel-grid {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .key-thumb-type {
            font-size: 0.6rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            opacity: 0.7;
        }

        .key-thumb-img {
            width: 36px;
            height: 36px;
            object-fit: contain;
            border-radius: 4px;
        }

        .key-thumb-fcc {
            font-size: 0.65rem;
            font-weight: 600;
            color: var(--brand-primary);
        }

        .key-thumb-title {
            font-size: 0.6rem;
            opacity: 0.8;
        }

        /* Key type color-coding */
        .key-smart {
            border-left: 3px solid #3b82f6;
        }

        .key-remote {
            border-left: 3px solid #a855f7;
        }

        .key-transponder {
            border-left: 3px solid #14b8a6;
        }

        .key-standard {
            border-left: 3px solid #6b7280;
        }

        .key-variants-badge {
            position: absolute;
            top: 2px;
            right: 2px;
            background: var(--brand-primary);
            color: #000;
            font-size: 0.5rem;
            font-weight: 600;
            padding: 1px 4px;
            border-radius: 3px;
        }

        .key-thumb.key-more,
        .key-thumb.key-collapse {
            background: linear-gradient(135deg, rgba(234, 179, 8, 0.1), rgba(234, 179, 8, 0.05));
            border-color: var(--brand-primary);
            color: var(--brand-primary);
        }

        .key-thumb.key-more:hover,
        .key-thumb.key-collapse:hover {
            background: rgba(234, 179, 8, 0.2);
        }

        /* Visual tree view for key grouping */
        .key-tree-container {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
        }

        .key-tree-group {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .key-tree-header {
            font-size: 0.65rem;
            font-weight: 700;
            color: var(--brand-primary);
            padding: 2px 6px;
            background: rgba(234, 179, 8, 0.15);
            border-radius: 4px;
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .key-tree-items {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .vehicle-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
            flex-wrap: wrap;
            gap: 12px;
        }

        .vehicle-name {
            font-size: 1.25rem;
            font-weight: 700;
        }

        .vehicle-badges {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .badge-gold {
            background: var(--brand-primary);
            color: var(--bg-primary);
        }

        /* Year Navigation Arrows */
        .year-nav {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: 16px;
        }

        .year-nav-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: 1px solid var(--border);
            background: var(--bg-tertiary);
            color: var(--text-primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            transition: all 0.2s ease;
        }

        .year-nav-btn:hover:not(:disabled) {
            background: var(--brand-primary);
            color: var(--bg-primary);
            border-color: var(--brand-primary);
            transform: scale(1.1);
        }

        .year-nav-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .year-nav-current {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--brand-primary);
            min-width: 60px;
            text-align: center;
        }

        .badge-dark {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        /* Key Type Badges */
        .badge-transponder {
            background: linear-gradient(135deg, #10b981, #059669);
            color: #fff;
        }

        .badge-smartkey {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: #fff;
        }

        .badge-mechanical {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            border: 1px solid var(--border);
        }

        .badge-remotehead {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: #000;
        }

        .key-blank-refs {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-top: 8px;
        }

        .key-ref-chip {
            padding: 4px 8px;
            background: rgba(251, 191, 36, 0.1);
            border: 1px solid var(--brand-primary);
            border-radius: 4px;
            font-size: 0.7rem;
            font-family: monospace;
            color: var(--brand-primary);
        }

        /* Data Grid */
        .data-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
        }

        .data-item {
            padding: 14px;
            background: var(--bg-tertiary);
            border-radius: 10px;
        }

        .data-label {
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }

        .data-value {
            font-size: 0.9rem;
            font-weight: 600;
        }

        .data-value a {
            color: var(--brand-primary);
            text-decoration: none;
        }

        .data-value.highlight {
            color: var(--brand-primary);
        }

        /* Views */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Results Section */
        .results-section {
            display: none;
        }

        .results-section.active {
            display: block;
        }

        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .result-title {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .back-btn {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        /* Footer */
        .footer {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-muted);
            font-size: 0.85rem;
            border-top: 1px solid var(--border);
            margin-top: 60px;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 60px;
            color: var(--text-muted);
        }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-top: 24px;
        }

        .pagination button {
            padding: 10px 16px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            cursor: pointer;
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination .page-info {
            padding: 10px 16px;
            color: var(--text-muted);
        }

        @media (max-width: 768px) {
            .browse-grid {
                grid-template-columns: 1fr;
            }

            .data-grid {
                grid-template-columns: 1fr 1fr;
            }

            .page-title h1 {
                font-size: 1.6rem;
            }

            .tabs {
                flex-wrap: wrap;
            }

            .tab {
                font-size: 0.85rem;
                padding: 10px 16px;
            }

            .hide-mobile {
                display: none !important;
            }

            .fcc-table th:nth-child(3),
            .fcc-table td:nth-child(3),
            .fcc-table th:nth-child(4),
            .fcc-table td:nth-child(4) {
                display: none;
            }

            .fcc-filters {
                flex-direction: column;
                gap: 12px;
            }

            .fcc-filters>div {
                margin-left: 0 !important;
            }
        }

        /* Photo Gallery Styles */
        .photo-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 12px;
            margin-top: 16px;
        }

        .photo-thumbnail {
            aspect-ratio: 1;
            background: var(--bg-tertiary);
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .photo-thumbnail:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 20px rgba(251, 191, 36, 0.3);
        }

        .photo-thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .fcc-link-card {
            display: block;
            padding: 20px;
            background: var(--bg-tertiary);
            border: 1px solid var(--brand-primary);
            border-radius: 12px;
            text-decoration: none;
            text-align: center;
            transition: all 0.2s;
        }

        .fcc-link-card:hover {
            background: rgba(251, 191, 36, 0.1);
            transform: translateY(-2px);
        }

        .key-photos-btn {
            padding: 8px 16px;
            background: var(--bg-tertiary);
            border: 1px solid var(--brand-primary);
            color: var(--brand-primary);
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .key-photos-btn:hover {
            background: var(--brand-primary);
            color: var(--bg-primary);
        }

        /* Walkthrough Guide Styles */
        .walkthrough-toggle {
            padding: 8px 16px;
            background: var(--bg-tertiary);
            border: 1px solid var(--brand-primary);
            color: var(--brand-primary);
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .walkthrough-toggle:hover {
            background: var(--brand-primary);
            color: var(--bg-primary);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(251, 191, 36, 0.2);
        }

        .walkthrough-content {
            display: none;
            margin-top: 16px;
            padding: 24px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 16px;
            font-size: 0.95rem;
            line-height: 1.7;
            max-height: 600px;
            overflow-y: auto;
            position: relative;
            scrollbar-width: thin;
            scrollbar-color: var(--brand-primary) var(--bg-secondary);
        }

        .walkthrough-content::-webkit-scrollbar {
            width: 6px;
        }

        .walkthrough-content::-webkit-scrollbar-thumb {
            background-color: var(--brand-primary);
            border-radius: 20px;
        }

        .walkthrough-content.expanded {
            display: block;
            animation: slideDown 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .walkthrough-content h2 {
            color: var(--text-primary);
            font-size: 1.4rem;
            font-weight: 800;
            margin-bottom: 20px;
            letter-spacing: -0.02em;
            background: linear-gradient(to right, var(--brand-primary), var(--brand-secondary));
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .walkthrough-content h3 {
            color: var(--brand-primary);
            font-size: 1.1rem;
            font-weight: 700;
            margin-top: 24px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .walkthrough-content h3::before {
            content: '';
            display: inline-block;
            width: 4px;
            height: 18px;
            background: var(--brand-primary);
            border-radius: 2px;
        }

        .walkthrough-content h4 {
            color: var(--text-primary);
            font-size: 1rem;
            font-weight: 600;
            margin-top: 16px;
            margin-bottom: 8px;
        }

        .walkthrough-content table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin: 20px 0;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid var(--border);
        }

        .walkthrough-content th,
        .walkthrough-content td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        .walkthrough-content th {
            background: var(--bg-tertiary);
            color: var(--text-muted);
            font-weight: 600;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .walkthrough-content tr:last-child td {
            border-bottom: none;
        }

        .walkthrough-content td {
            background: var(--bg-primary);
            color: var(--text-secondary);
        }

        .walkthrough-content blockquote {
            margin: 20px 0;
            padding: 16px 20px;
            background: rgba(251, 191, 36, 0.05);
            border-left: 4px solid var(--brand-primary);
            border-radius: 0 12px 12px 0;
            font-style: italic;
            color: var(--text-primary);
        }

        .walkthrough-content blockquote.alert-tip {
            background: rgba(16, 185, 129, 0.05);
            border-left-color: #10b981;
        }

        .walkthrough-content blockquote.alert-warning {
            background: rgba(245, 158, 11, 0.05);
            border-left-color: #f59e0b;
        }

        .walkthrough-content blockquote.alert-important {
            background: rgba(239, 68, 68, 0.05);
            border-left-color: #ef4444;
        }

        .walkthrough-content ul,
        .walkthrough-content ol {
            padding-left: 20px;
            margin: 16px 0;
        }

        .walkthrough-content li {
            margin-bottom: 8px;
        }

        .walkthrough-content strong {
            color: var(--brand-primary);
        }

        .walkthrough-content hr {
            border: none;
            border-top: 1px solid var(--border);
            margin: 24px 0;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Programming Guide Styles */
        .programming-guide-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
            padding-bottom: 16px;
            margin-bottom: 24px;
        }

        .programming-guide-header h3 {
            margin: 0 !important;
            font-size: 1.25rem !important;
            background: linear-gradient(135deg, var(--brand-primary), #f59e0b);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .programming-guide-body {
            font-size: 0.95rem;
            line-height: 1.7;
        }

        .guide-asset-block {
            margin-bottom: 24px;
            text-align: center;
        }

        .guide-infographic {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border: 1px solid var(--border);
        }

        .guide-asset-link {
            margin-bottom: 24px;
        }

        .pdf-download-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            background: rgba(59, 130, 246, 0.1);
            color: #60a5fa;
            border: 1px solid rgba(59, 130, 246, 0.2);
            border-radius: 6px;
            text-decoration: none;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .pdf-download-btn:hover {
            background: rgba(59, 130, 246, 0.2);
            transform: translateY(-1px);
        }

        /* Research Intel Banners */
        .guide-intel-banner {
            display: flex;
            gap: 12px;
            padding: 16px;
            border-radius: 10px;
            margin-bottom: 16px;
            align-items: flex-start;
        }

        .guide-intel-banner .banner-icon {
            font-size: 1.5rem;
            flex-shrink: 0;
        }

        .guide-intel-banner .banner-content strong {
            display: block;
            margin-bottom: 4px;
            font-size: 0.95rem;
        }

        .guide-intel-banner .banner-content p {
            margin: 0;
            font-size: 0.85rem;
            opacity: 0.9;
        }

        .guide-intel-banner.vin-ordered {
            background: rgba(239, 68, 68, 0.15);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #fca5a5;
        }

        .guide-intel-banner.dealer-tool {
            background: rgba(168, 85, 247, 0.15);
            border: 1px solid rgba(168, 85, 247, 0.3);
            color: #d8b4fe;
        }

        .guide-intel-banner.rf-system.european {
            background: rgba(59, 130, 246, 0.15);
            border: 1px solid rgba(59, 130, 246, 0.3);
            color: #93c5fd;
        }

        .guide-intel-banner.rf-system.continental {
            background: rgba(34, 197, 94, 0.15);
            border: 1px solid rgba(34, 197, 94, 0.3);
            color: #86efac;
        }

        .guide-intel-banner.warning {
            background: rgba(245, 158, 11, 0.15);
            border: 1px solid rgba(245, 158, 11, 0.3);
            color: #fcd34d;
        }

        /* Guide Images Gallery */
        .guide-images-section {
            margin: 16px 0;
            padding: 16px;
            background: var(--bg-tertiary);
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }

        .guide-images-section h4 {
            margin: 0 0 12px 0;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .guide-images-carousel {
            display: flex;
            gap: 12px;
            overflow-x: auto;
            padding-bottom: 8px;
            scroll-snap-type: x mandatory;
        }

        .guide-images-carousel::-webkit-scrollbar {
            height: 6px;
        }

        .guide-images-carousel::-webkit-scrollbar-track {
            background: var(--bg-tertiary);
            border-radius: 3px;
        }

        .guide-images-carousel::-webkit-scrollbar-thumb {
            background: var(--brand-primary);
            border-radius: 3px;
        }

        .guide-image-card {
            flex: 0 0 200px;
            scroll-snap-align: start;
            cursor: pointer;
            border-radius: 8px;
            overflow: hidden;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .guide-image-card:hover {
            transform: scale(1.03);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            border-color: var(--brand-primary);
        }

        .guide-image-card img {
            width: 100%;
            height: 120px;
            object-fit: cover;
        }

        .guide-image-caption {
            display: block;
            padding: 8px;
            font-size: 0.75rem;
            color: var(--text-muted);
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Guide Image Modal */
        .guide-image-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }

        .guide-image-modal.active {
            opacity: 1;
            visibility: visible;
        }

        .guide-image-modal img {
            max-width: 90%;
            max-height: 85%;
            border-radius: 8px;
            box-shadow: 0 8px 40px rgba(0, 0, 0, 0.5);
        }

        .guide-image-modal .modal-caption {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            font-size: 0.9rem;
            text-align: center;
            max-width: 80%;
        }

        .guide-image-modal .modal-close {
            position: absolute;
            top: 20px;
            right: 30px;
            background: none;
            border: none;
            color: white;
            font-size: 2rem;
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .guide-image-modal .modal-close:hover {
            opacity: 1;
        }

        /* Quick Tech Specs */
        .guide-tech-specs {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
            padding: 12px 16px;
            background: var(--bg-tertiary);
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 0.85rem;
        }

        .guide-tech-specs .tech-spec {
            color: var(--text-secondary);
        }

        .guide-tech-specs .tech-spec strong {
            color: var(--brand-primary);
            margin-right: 4px;
        }

        .auth-required-badge {
            font-size: 0.8rem;
            color: var(--text-muted);
            padding: 8px 12px;
            background: var(--bg-tertiary);
            border-radius: 6px;
        }

        /* Job Logging Button */
        .btn-log-job {
            background: var(--brand-primary);
            background: linear-gradient(135deg, var(--brand-primary), #f59e0b);
            color: #000;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 700;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            box-shadow: 0 4px 12px rgba(251, 191, 36, 0.2);
        }

        .btn-log-job:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(251, 191, 36, 0.3);
            filter: brightness(1.05);
        }

        .btn-log-job:active {
            transform: translateY(0);
        }

        .btn-log-job:disabled {
            background: var(--bg-tertiary);
            color: var(--text-muted);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
            opacity: 0.7;
        }

        /* User Menu Dropdown */
        .user-menu-container {
            position: relative;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-dropdown {
            position: absolute;
            top: calc(100% + 8px);
            right: 0;
            background: #1e293b;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            min-width: 200px;
            z-index: 2000;
            display: none;
            overflow: hidden;
            animation: slideDown 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .user-dropdown.show {
            display: block;
        }

        .user-dropdown-item {
            padding: 12px 16px;
            color: var(--text-primary);
            font-size: 0.9rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.2s;
            border: none;
            background: transparent;
            width: 100%;
            text-align: left;
            font-family: inherit;
        }

        .user-dropdown-item:hover {
            background: rgba(255, 255, 255, 0.08);
        }

        .user-dropdown-divider {
            height: 1px;
            background: rgba(255, 255, 255, 0.05);
            margin: 4px 0;
        }

        .user-dropdown-item.logout {
            color: #f87171;
        }

        .user-dropdown-item.logout:hover {
            background: rgba(248, 113, 113, 0.1);
        }
    </style>
    <script>
        window.onerror = function (msg, url, line, col, error) {
            const div = document.createElement('div');
            div.style.cssText = 'position:fixed;top:0;left:0;right:0;background:red;color:white;padding:20px;z-index:99999;font-family:monospace;white-space:pre-wrap;';
            div.innerHTML = `ERROR: ${msg}\n${url}:${line}:${col}\n${error?.stack || ''}`;
            document.body.appendChild(div);
            return false;
        };
        window.addEventListener('unhandledrejection', function (event) {
            const div = document.createElement('div');
            div.style.cssText = 'position:fixed;top:0;left:0;right:0;background:orange;color:black;padding:20px;z-index:99999;font-family:monospace;white-space:pre-wrap;';
            div.innerHTML = `PROMISE ERROR: ${event.reason}`;
            document.body.appendChild(div);
        });
    </script>
    <style>
        /* Tabbed Book Guide Styles */
        .book-guide-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border);
            padding-bottom: 8px;
            overflow-x: auto;
        }

        .book-tab {
            padding: 8px 16px;
            border-radius: 8px;
            background: var(--bg-secondary);
            color: var(--text-muted);
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
            white-space: nowrap;
            transition: all 0.2s;
            border: 1px solid transparent;
        }

        .book-tab.active {
            background: rgba(251, 191, 36, 0.1);
            color: var(--brand-primary);
            border-color: rgba(251, 191, 36, 0.3);
        }

        .book-section {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .book-section.active {
            display: block;
        }

        .book-chapter-title {
            font-size: 1.1rem;
            color: var(--brand-primary);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .book-chapter-title i {
            opacity: 0.7;
        }

        .mode-btn {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            color: var(--text-muted);
            padding: 10px 24px;
            border-radius: 30px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .mode-btn.active {
            background: var(--brand-primary);
            color: white;
            border-color: var(--brand-primary);
            box-shadow: 0 4px 12px rgba(96, 165, 250, 0.3);
        }

        .mode-btn:hover:not(.active) {
            border-color: var(--brand-primary);
            color: var(--text-primary);
        }

        /* Hero Section & Visual Search */
        .hero-section {
            text-align: center;
            padding: 40px 20px;
            background: linear-gradient(180deg, var(--bg-secondary) 0%, transparent 100%);
            border-bottom: 1px solid var(--border);
            margin-bottom: 30px;
        }

        .hero-title {
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #fff 0%, #94a3b8 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .hero-subtitle {
            font-size: 1.1rem;
            color: var(--text-secondary);
            margin-bottom: 30px;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }

        /* Omni-Search Bar */
        .omni-search-container {
            max-width: 600px;
            margin: 0 auto 40px;
            position: relative;
        }

        .omni-search-input {
            width: 100%;
            padding: 18px 24px;
            padding-left: 50px;
            padding-right: 50px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 1.1rem;
            transition: all 0.2s;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .omni-search-input:focus {
            outline: none;
            border-color: var(--brand-primary);
            box-shadow: 0 0 0 3px rgba(251, 191, 36, 0.2);
            background: var(--bg-secondary);
        }

        .omni-search-icon {
            position: absolute;
            left: 18px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
            pointer-events: none;
        }

        .omni-scan-btn {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            padding: 8px;
            font-size: 1.2rem;
            color: var(--text-muted);
            transition: all 0.2s;
            border-radius: 8px;
        }

        .omni-scan-btn:hover {
            color: var(--brand-primary);
            background: rgba(251, 191, 36, 0.1);
        }

        /* Visual Make Grid */
        .make-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 16px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .make-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            aspect-ratio: 1;
        }

        .make-card:hover {
            transform: translateY(-2px);
            border-color: var(--brand-primary);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
            background: var(--bg-tertiary);
        }

        .make-logo {
            width: 48px;
            height: 48px;
            object-fit: contain;
            margin-bottom: 8px;
            /* Filter for dark mode logos if needed, usually clearbit is fine */
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
        }

        /* Fallback Text Avatar */
        .text-avatar {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, var(--bg-tertiary), var(--bg-secondary));
            color: var(--text-primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 1.2rem;
            margin-bottom: 8px;
            border: 1px solid var(--border);
        }

        .make-name {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-muted);
            text-align: center;
        }

        .make-card:hover .make-name {
            color: var(--text-primary);
        }

        /* Model Chip Grid */
        .model-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 12px;
            margin-top: 20px;
        }

        .model-chip {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
            color: var(--text-primary);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 6px;
            min-height: 70px;
        }

        .model-chip .key-icon {
            font-size: 1.2rem;
        }

        .model-chip .model-name {
            font-size: 0.9rem;
            word-break: break-word;
        }

        .model-chip:hover {
            border-color: var(--brand-primary);
            background: rgba(251, 191, 36, 0.1);
            transform: translateY(-2px);
        }

        .model-filter-bar {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .model-filter-btn {
            padding: 8px 16px;
            border-radius: 20px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .model-filter-btn:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .model-filter-btn.active {
            background: var(--brand-primary);
            color: var(--bg-primary);
            border-color: var(--brand-primary);
        }

        /* Mobile Adjustments */
        @media (max-width: 600px) {
            .hero-title {
                font-size: 2rem;
            }

            .make-grid {
                grid-template-columns: repeat(3, 1fr);
                /* Force 3 columns on mobile */
                gap: 10px;
            }

            .make-card {
                padding: 10px;
            }

            .make-logo,
            .text-avatar {
                width: 36px;
                height: 36px;
                font-size: 1rem;
            }

            .make-name {
                font-size: 0.8rem;
            }

            .model-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .bg-navy-800 {
            background-color: var(--bg-secondary) !important;
        }

        .bg-navy-900\/50 {
            background-color: rgba(10, 22, 40, 0.5) !important;
        }

        .bg-navy-700 {
            background-color: var(--bg-tertiary) !important;
        }

        .border-navy-700 {
            border-color: var(--bg-tertiary) !important;
        }

        .border-navy-600 {
            border-color: #334155 !important;
        }

        .text-brand-400 {
            color: var(--brand-primary) !important;
        }

        .text-slate-300 {
            color: var(--text-secondary) !important;
        }

        .text-white {
            color: #ffffff !important;
        }

        .text-2xl {
            font-size: 1.5rem !important;
            line-height: 2rem !important;
        }

        .font-bold {
            font-weight: 700 !important;
        }

        .font-semibold {
            font-weight: 600 !important;
        }

        .p-4 {
            padding: 1rem !important;
        }

        .p-6 {
            padding: 1.5rem !important;
        }

        .mb-2 {
            margin-bottom: 0.5rem !important;
        }

        .mb-4 {
            margin-bottom: 1rem !important;
        }

        .rounded-xl {
            border-radius: 0.75rem !important;
        }

        .rounded-lg {
            border-radius: 0.5rem !important;
        }

        .shadow-lg {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05) !important;
        }

        .space-y-6>*+* {
            margin-top: 1.5rem !important;
        }

        .space-y-2>*+* {
            margin-top: 0.5rem !important;
        }

        .list-decimal {
            list-style-type: decimal !important;
        }

        .list-inside {
            list-style-position: inside !important;
        }

        /* Alerts */
        .bg-red-500\/10 {
            background-color: rgba(239, 68, 68, 0.1) !important;
        }

        .border-red-500\/30 {
            border-color: rgba(239, 68, 68, 0.3) !important;
        }

        .text-red-400 {
            color: #f87171 !important;
        }

        .text-red-200\/80 {
            color: rgba(254, 202, 202, 0.8) !important;
        }

        .text-sm {
            font-size: 0.875rem !important;
        }

        /* ==========================================================================
           MEGA CARD 2.0 STYLES
           ========================================================================== */

        :root {
            --theme-global-a-bg: #0f172a;
            --theme-global-a-glow: #10b981;
            /* Emerald */
            --theme-global-a-border: rgba(16, 185, 129, 0.3);

            --theme-global-b-bg: #0f172a;
            --theme-global-b-glow: #ef4444;
            /* Red */
            --theme-global-b-border: rgba(239, 68, 68, 0.3);
        }

        .mega-card {
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
            background: var(--bg-secondary);
            margin-bottom: 24px;
            transition: all 0.3s ease;
        }

        /* Architecture Headers */
        .mega-card-header {
            padding: 20px 24px;
            position: relative;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .mega-card.theme-global-a {
            border-color: var(--theme-global-a-border);
            box-shadow: 0 4px 20px rgba(16, 185, 129, 0.05);
        }

        .mega-card.theme-global-a .mega-card-header {
            background: linear-gradient(180deg, rgba(16, 185, 129, 0.05) 0%, rgba(15, 23, 42, 0) 100%);
            border-top: 3px solid var(--theme-global-a-glow);
        }

        .mega-card.theme-global-b {
            border-color: var(--theme-global-b-border);
            box-shadow: 0 4px 20px rgba(239, 68, 68, 0.05);
        }

        .mega-card.theme-global-b .mega-card-header {
            background: linear-gradient(180deg, rgba(239, 68, 68, 0.05) 0%, rgba(15, 23, 42, 0) 100%);
            border-top: 3px solid var(--theme-global-b-glow);
        }

        .arch-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .arch-badge.global-a {
            background: rgba(16, 185, 129, 0.1);
            color: #34d399;
            border: 1px solid rgba(16, 185, 129, 0.2);
        }

        .arch-badge.global-b {
            background: rgba(239, 68, 68, 0.1);
            color: #fca5a5;
            border: 1px solid rgba(239, 68, 68, 0.2);
        }

        /* Spec Grid */
        .mega-spec-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 1px;
            background: var(--border);
            /* Creates grid lines */
            border-bottom: 1px solid var(--border);
        }

        .spec-item {
            background: var(--bg-tertiary);
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 6px;
            align-items: center;
            text-align: center;
        }

        .spec-icon {
            font-size: 1.4rem;
            margin-bottom: 4px;
        }

        .spec-label {
            font-size: 0.7rem;
            text-transform: uppercase;
            color: var(--text-muted);
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .spec-value {
            font-size: 0.95rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        /* Scanner Interface */
        .diagnostic-scanner {
            background: #000;
            margin: 16px;
            border-radius: 8px;
            border: 1px solid #333;
            font-family: 'Courier New', monospace;
            overflow: hidden;
            box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.5);
        }

        .scanner-header {
            background: #1a1a1a;
            padding: 8px 12px;
            font-size: 0.8rem;
            color: #666;
            border-bottom: 1px solid #333;
            display: flex;
            justify-content: space-between;
        }

        .scanner-screen {
            padding: 12px;
        }

        .scan-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px dashed #333;
            color: #ccc;
            font-size: 0.9rem;
            cursor: pointer;
        }

        .scan-row:last-child {
            border-bottom: none;
        }

        .scan-row:hover {
            color: #fff;
            background: rgba(255, 255, 255, 0.05);
        }

        .scan-row.alert {
            color: #fca5a5;
        }

        .scan-row.warning {
            color: #fcd34d;
        }

        /* Interactive Tabs */
        .mega-tabs {
            display: flex;
            padding: 0 16px;
            border-bottom: 1px solid var(--border);
            margin-top: 16px;
        }

        .mega-tab {
            padding: 12px 20px;
            color: var(--text-muted);
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }

        .mega-tab.active {
            color: var(--brand-primary);
            border-bottom-color: var(--brand-primary);
        }

        .mega-tab-content {
            padding: 24px;
            display: none;
        }

        .mega-tab-content.active {
            display: block;
        }
    </style>
</head>

<body>

    <!-- FCC Detail Modal -->
    <div id="fccModal" class="modal" style="display: none;">
        <div class="modal-overlay" onclick="closeFccModal()"></div>
        <div class="modal-content">
            <button class="modal-close" onclick="closeFccModal()">Ã—</button>
            <div id="fccModalBody"></div>
        </div>
    </div>

    <!-- Key Photos Modal -->
    <div id="keyPhotosModal" class="modal" style="display: none;">
        <div class="modal-overlay" onclick="closeKeyPhotosModal()"></div>
        <div class="modal-content" style="max-width: 700px;">
            <button class="modal-close" onclick="closeKeyPhotosModal()">Ã—</button>
            <div id="keyPhotosModalBody"></div>
        </div>
    </div>

    <!-- Lightbox for enlarged photos -->
    <div id="photoLightbox" onclick="closeLightbox()"
        style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 2000; align-items: center; justify-content: center; cursor: zoom-out;">
        <img id="lightboxImage" style="max-width: 95%; max-height: 95%; object-fit: contain;">
    </div>

    <!-- Job Logging Modal -->
    <div id="jobLogModal" class="job-modal-overlay" onclick="if(event.target === this) closeJobModal()">
        <div class="job-modal" style="max-width: 520px;">
            <div class="job-modal-header">
                <h3>ðŸ“‹ Log Job & Calculate Profit</h3>
                <button class="job-modal-close" onclick="closeJobModal()">Ã—</button>
            </div>
            <div class="job-modal-body">
                <div class="job-item-preview" id="jobItemPreview">
                    <div class="item-name" id="jobItemName">Item Name</div>
                    <div class="item-vehicle" id="jobItemVehicle"></div>
                </div>

                <form id="jobLogForm" onsubmit="submitJobLog(event)">
                    <input type="hidden" id="jobItemKey" />
                    <input type="hidden" id="jobItemType" />
                    <input type="hidden" id="jobDisplayTitle" />

                    <!-- Customer & Vehicle Selection -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                        <div class="job-form-group">
                            <label for="jobCustomer">Customer (Optional)</label>
                            <input type="text" id="jobCustomer" placeholder="John Smith" />
                        </div>
                        <div class="job-form-group">
                            <label for="jobVehicleSelect">Select Vehicle</label>
                            <select id="jobVehicleSelect"
                                onchange="document.getElementById('jobDescription').value = this.value; calculateJobProfit();"
                                style="width: 100%; border-radius: 8px; background: var(--bg-tertiary); border: 1px solid var(--border); color: var(--text-primary); padding: 8px; font-size: 0.85rem;">
                                <option value="">-- Choose Car --</option>
                            </select>
                        </div>
                    </div>

                    <div class="job-form-group" style="margin-top: 8px;">
                        <label for="jobDescription">Job Description / Custom Vehicle</label>
                        <input type="text" id="jobDescription" placeholder="e.g. 2018 Toyota Camry" />
                    </div>

                    <!-- Revenue Section -->
                    <div
                        style="background: rgba(34, 197, 94, 0.1); padding: 12px; border-radius: 8px; margin: 12px 0; border: 1px solid rgba(34, 197, 94, 0.2);">
                        <div
                            style="font-size: 0.75rem; color: #4ade80; text-transform: uppercase; font-weight: 700; margin-bottom: 8px;">
                            ðŸ’µ Revenue</div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                            <div class="job-form-group" style="margin: 0;">
                                <label for="jobRevenue">Service Charged ($)</label>
                                <input type="number" id="jobRevenue" placeholder="150.00" step="0.01"
                                    oninput="calculateJobProfit()" />
                            </div>
                            <div class="job-form-group" style="margin: 0;">
                                <label for="jobTip">Tip ($)</label>
                                <input type="number" id="jobTip" placeholder="0.00" step="0.01" value="0"
                                    oninput="calculateJobProfit()" />
                            </div>
                        </div>
                    </div>

                    <!-- Costs Section -->
                    <div
                        style="background: rgba(239, 68, 68, 0.1); padding: 12px; border-radius: 8px; margin: 12px 0; border: 1px solid rgba(239, 68, 68, 0.2);">
                        <div
                            style="font-size: 0.75rem; color: #f87171; text-transform: uppercase; font-weight: 700; margin-bottom: 8px;">
                            ðŸ“‰ Costs</div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px;">
                            <div class="job-form-group" style="margin: 0;">
                                <label for="itemCost">Key Cost ($)</label>
                                <input type="number" id="itemCost" placeholder="35.00" step="0.01"
                                    oninput="calculateJobProfit()" />
                            </div>
                            <div class="job-form-group" style="margin: 0;">
                                <label for="jobMiles">Miles Driven</label>
                                <input type="number" id="jobMiles" placeholder="15" step="0.1"
                                    oninput="calculateJobProfit()" />
                            </div>
                            <div class="job-form-group" style="margin: 0;">
                                <label for="jobTimeMinutes">Time (min)</label>
                                <input type="number" id="jobTimeMinutes" placeholder="45" step="1"
                                    oninput="calculateJobProfit()" />
                            </div>
                        </div>
                    </div>

                    <!-- Profit Summary (Live Calculation) -->
                    <div id="profitSummary"
                        style="background: linear-gradient(135deg, #1e1e1e, #252525); padding: 16px; border-radius: 8px; margin: 12px 0; border: 1px solid #333;">
                        <div
                            style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; text-align: center;">
                            <div>
                                <div style="font-size: 0.65rem; color: var(--text-muted); text-transform: uppercase;">
                                    Gross</div>
                                <div id="calcGross" style="font-size: 1.1rem; font-weight: 700; color: #4ade80;">$0.00
                                </div>
                            </div>
                            <div>
                                <div style="font-size: 0.65rem; color: var(--text-muted); text-transform: uppercase;">
                                    Expenses</div>
                                <div id="calcExpenses" style="font-size: 1.1rem; font-weight: 700; color: #f87171;">
                                    $0.00</div>
                            </div>
                            <div>
                                <div style="font-size: 0.65rem; color: var(--text-muted); text-transform: uppercase;">
                                    Net Profit</div>
                                <div id="calcProfit"
                                    style="font-size: 1.1rem; font-weight: 700; color: var(--brand-primary);">$0.00
                                </div>
                            </div>
                            <div>
                                <div style="font-size: 0.65rem; color: var(--text-muted); text-transform: uppercase;">
                                    $/Hour</div>
                                <div id="calcHourly" style="font-size: 1.1rem; font-weight: 700; color: #60a5fa;">$0.00
                                </div>
                            </div>
                        </div>
                        <div
                            style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #333; display: flex; justify-content: space-between; font-size: 0.75rem; color: var(--text-muted);">
                            <span>Est. Tax (30%): <span id="calcTax" style="color: #fbbf24;">$0.00</span></span>
                            <span>Mileage: <span id="calcMileage" style="color: #a78bfa;">$0.00</span> @ $0.67/mi</span>
                        </div>
                    </div>

                    <!-- Notes -->
                    <div class="job-form-group">
                        <label for="jobNotes">Notes (Optional)</label>
                        <textarea id="jobNotes" placeholder="Any details..." style="height: 50px;"></textarea>
                    </div>

                    <div class="job-form-group"
                        style="display: flex; align-items: center; gap: 12px; background: rgba(255,255,255,0.05); padding: 12px; border-radius: 8px; margin-bottom: 16px;">
                        <input type="checkbox" id="jobConsumeStock" checked
                            style="width: 20px; height: 20px; accent-color: var(--brand-primary);">
                        <label for="jobConsumeStock" style="margin: 0; cursor: pointer;">Consume 1 Inventory
                            Item</label>
                    </div>

                    <div class="job-modal-actions">
                        <button type="button" class="btn-cancel-job" onclick="closeJobModal()">Cancel</button>
                        <button type="submit" class="btn-save-job">âœ“ Log Job & Use Item</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteConfirmModal" class="modal" style="display: none;">
        <div class="modal-overlay" onclick="closeDeleteConfirmModal()"></div>
        <div class="modal-content" style="max-width: 400px; text-align: center; padding: 32px;">
            <div style="font-size: 3rem; margin-bottom: 16px;">ðŸ—‘ï¸</div>
            <h3 style="margin-bottom: 12px; color: var(--text-primary);">Delete Item?</h3>
            <p style="color: var(--text-secondary); margin-bottom: 24px;">Are you sure you want to remove this item from
                your inventory? This action cannot be undone.</p>
            <div style="display: flex; gap: 12px; justify-content: center;">
                <button onclick="closeDeleteConfirmModal()"
                    style="padding: 10px 24px; background: var(--bg-tertiary); border: 1px solid var(--border); color: var(--text-primary); border-radius: 8px; cursor: pointer; font-weight: 600;">Cancel</button>
                <button onclick="confirmDelete()"
                    style="padding: 10px 24px; background: #ef4444; border: none; color: white; border-radius: 8px; cursor: pointer; font-weight: 600;">Delete</button>
            </div>
        </div>
    </div>

    <!-- Upgrade to Pro Modal -->
    <div id="upgradeModal" class="modal" style="display: none;">
        <div class="modal-overlay" onclick="closeUpgradeModal()"></div>
        <div class="modal-content" style="max-width: 900px; padding: 0;">
            <button class="modal-close" onclick="closeUpgradeModal()" style="z-index: 10;">Ã—</button>

            <div class="upgrade-modal-layout">
                <!-- Header / Value Prop -->
                <div
                    style="background: linear-gradient(135deg, #1e293b, #0f172a); padding: 40px; text-align: center; border-radius: 12px 12px 0 0;">
                    <h2
                        style="font-size: 2rem; margin-bottom: 12px; background: linear-gradient(90deg, #fbbf24, #f59e0b); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent;">
                        Upgrade to Euro Keys Pro
                    </h2>
                    <p style="color: #94a3b8; font-size: 1.1rem; max-width: 600px; margin: 0 auto;">
                        Stop guessing on the job. Get full inventory control, offline access features, and priority
                        updates.
                    </p>
                </div>

                <!-- Pricing Cards -->
                <div style="padding: 40px; background: var(--bg-secondary);">

                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 24px;">

                        <!-- Monthly -->
                        <div class="price-card"
                            style="background: var(--bg-tertiary); padding: 24px; border-radius: 12px; border: 1px solid var(--border); position: relative;">
                            <h3 style="color: var(--text-primary); margin-bottom: 8px;">Monthly</h3>
                            <div
                                style="font-size: 2rem; font-weight: 700; color: var(--text-primary); margin-bottom: 16px;">
                                $9.99<span
                                    style="font-size: 1rem; color: var(--text-muted); font-weight: 400;">/mo</span>
                            </div>
                            <ul
                                style="list-style: none; padding: 0; margin-bottom: 24px; color: var(--text-secondary);">
                                <li style="margin-bottom: 8px;">âœ“ Full Inventory Management</li>
                                <li style="margin-bottom: 8px;">âœ“ Stock Alerts</li>
                                <li style="margin-bottom: 8px;">âœ“ Priority Support</li>
                            </ul>
                            <button onclick="startCheckout('monthly', event)"
                                style="width: 100%; padding: 12px; background: var(--bg-secondary); border: 1px solid var(--brand-primary); color: var(--brand-primary); border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                                Start Monthly
                            </button>
                        </div>

                        <!-- Annual (Best Value) -->
                        <div class="price-card"
                            style="background: #1e293b; padding: 24px; border-radius: 12px; border: 2px solid #fbbf24; position: relative; transform: scale(1.05); box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3);">
                            <div
                                style="position: absolute; top: -12px; left: 50%; transform: translateX(-50%); background: #fbbf24; color: #000; padding: 4px 12px; border-radius: 12px; font-size: 0.8rem; font-weight: 700;">
                                MOST POPULAR
                            </div>
                            <h3 style="color: white; margin-bottom: 8px;">Annual</h3>
                            <div style="font-size: 2rem; font-weight: 700; color: white; margin-bottom: 4px;">
                                $99<span style="font-size: 1rem; color: #94a3b8; font-weight: 400;">/yr</span>
                            </div>
                            <div style="color: #fbbf24; font-size: 0.85rem; margin-bottom: 16px;">Save ~17% vs
                                Monthly</div>
                            <ul style="list-style: none; padding: 0; margin-bottom: 24px; color: #e2e8f0;">
                                <li style="margin-bottom: 8px;">âœ“ Full Inventory Management</li>
                                <li style="margin-bottom: 8px;">âœ“ Stock Alerts</li>
                                <li style="margin-bottom: 8px;">âœ“ Priority Support</li>
                                <li style="margin-bottom: 8px;">âœ“ 2 Months Free</li>
                            </ul>
                            <button onclick="startCheckout('annual', event)"
                                style="width: 100%; padding: 12px; background: #fbbf24; border: none; color: #000; border-radius: 8px; font-weight: 700; cursor: pointer; transition: all 0.2s;">
                                Get Annual Plan
                            </button>
                        </div>

                        <!-- Lifetime -->
                        <div class="price-card"
                            style="background: var(--bg-tertiary); padding: 24px; border-radius: 12px; border: 1px solid var(--border);">
                            <h3 style="color: var(--text-primary); margin-bottom: 8px;">Lifetime</h3>
                            <div
                                style="font-size: 2rem; font-weight: 700; color: var(--text-primary); margin-bottom: 16px;">
                                $249
                            </div>
                            <ul
                                style="list-style: none; padding: 0; margin-bottom: 24px; color: var(--text-secondary);">
                                <li style="margin-bottom: 8px;">âœ“ One-time payment</li>
                                <li style="margin-bottom: 8px;">âœ“ All Pro Features Forever</li>
                                <li style="margin-bottom: 8px;">âœ“ No Recurring Fees</li>
                            </ul>
                            <button onclick="startCheckout('lifetime', event)"
                                style="width: 100%; padding: 12px; background: var(--bg-secondary); border: 1px solid var(--text-muted); color: var(--text-primary); border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                                Buy Lifetime
                            </button>
                        </div>

                    </div>

                    <div style="text-align: center; margin-top: 24px; color: var(--text-muted); font-size: 0.9rem;">
                        Secure payment processing via Stripe.
                        <a href="#" onclick="restorePurchases(); return false;"
                            style="color: var(--text-secondary); text-decoration: underline;">Restore Purchases</a>
                    </div>
                </div>
            </div>
            <style>
                .upgrade-modal-layout {
                    display: flex;
                    flex-direction: column;
                }

                @media (min-width: 768px) {
                    .upgrade-modal-layout {
                        flex-direction: column;
                    }
                }
            </style>
        </div>
    </div>

    <style>
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
        }

        .modal-content {
            position: relative;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 16px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            padding: 24px;
        }

        .modal-close {
            position: absolute;
            top: 12px;
            right: 16px;
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 24px;
            cursor: pointer;
        }

        .modal-close:hover {
            color: var(--text-primary);
        }

        .modal-title {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--brand-primary);
            margin-bottom: 8px;
        }

        .modal-subtitle {
            color: var(--text-muted);
            font-size: 0.9rem;
            margin-bottom: 20px;
        }

        .modal-vehicle-list {
            list-style: none;
            padding: 0;
            margin: 0 0 20px 0;
            max-height: 300px;
            overflow-y: auto;
        }

        .modal-vehicle-list li {
            padding: 10px 12px;
            border-bottom: 1px solid var(--border);
            font-size: 0.9rem;
        }

        .modal-vehicle-list li:last-child {
            border-bottom: none;
        }

        .modal-amazon {
            display: block;
            width: 100%;
            padding: 16px;
            background: var(--brand-primary);
            color: var(--bg-primary);
            text-align: center;
            text-decoration: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 700;
        }

        .modal-amazon:hover {
            opacity: 0.9;
        }

        /* Mechanical Codex Styles */
        .pro-data-section {
            margin-top: 16px;
            padding: 16px;
            background: rgba(251, 191, 36, 0.05);
            border: 1px solid rgba(251, 191, 36, 0.2);
            border-radius: 12px;
            position: relative;
            overflow: hidden;
        }

        .pro-data-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--brand-primary);
        }

        .pro-header {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.75rem;
            color: var(--brand-primary);
            text-transform: uppercase;
            font-weight: 800;
            margin-bottom: 12px;
            letter-spacing: 1px;
        }

        .mec-codex-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
            margin-bottom: 12px;
        }

        .mec-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .mec-label {
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .mec-value {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .pro-note {
            font-size: 0.85rem;
            color: var(--text-secondary);
            line-height: 1.5;
            padding-top: 12px;
            border-top: 1px solid rgba(251, 191, 36, 0.1);
            margin-top: 8px;
        }

        .modal-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 20px;
        }

        .modal-info-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 10px;
            border-radius: 8px;
        }

        .modal-info-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .modal-info-value {
            font-weight: 600;
            color: var(--text-primary);
        }

        /* Inventory Tracker Styles */
        .inventory-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .inventory-badge.in-stock {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
        }

        .inventory-badge.out-of-stock {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .inventory-controls {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            margin-left: 8px;
        }

        .inventory-btn {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: 1px solid var(--border);
            background: var(--bg-tertiary);
            color: var(--text-primary);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .inventory-btn:hover {
            background: var(--brand-primary);
            color: var(--bg-primary);
            border-color: var(--brand-primary);
        }

        .inventory-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        /* Stats Dashboard Styles */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .stats-card {
            background: var(--bg-tertiary);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid var(--border);
            text-align: center;
        }

        .stats-card h4 {
            color: var(--text-muted);
            margin: 0 0 8px 0;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stats-card .value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .stats-card .sub-value {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .alert-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.2);
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 12px;
        }

        .alert-item .alert-title {
            color: #ef4444;
            font-weight: 600;
        }

        .btn-log-job {
            padding: 6px 14px;
            background: linear-gradient(135deg, #3b82f6, #0ea5e9);
            border: none;
            color: white;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .btn-log-job:hover {
            background: linear-gradient(135deg, #2563eb, #0284c7);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .btn-log-job:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .inventory-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 0;
            border-top: 1px solid var(--border);
            margin-top: 8px;
        }

        /* Job Logging Modal */
        .job-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            /* Hidden by default */
            align-items: center;
            justify-content: center;
            z-index: 10000;
            padding: 20px;
        }

        .job-modal-overlay.active {
            display: flex !important;
        }

        .job-modal {
            background: var(--bg-secondary);
            border-radius: 16px;
            max-width: 480px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .job-modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .job-modal-header h3 {
            color: var(--text-primary);
            font-size: 1.1rem;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .job-modal-close {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 4px;
            line-height: 1;
        }

        .job-modal-close:hover {
            color: var(--text-primary);
        }

        .job-modal-body {
            padding: 24px;
        }

        .job-form-group {
            margin-bottom: 16px;
        }

        .job-form-group label {
            display: block;
            color: var(--text-secondary);
            font-size: 0.8rem;
            font-weight: 500;
            margin-bottom: 6px;
        }

        .job-form-group input,
        .job-form-group textarea {
            width: 100%;
            padding: 10px 14px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.9rem;
            font-family: inherit;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .job-form-group input:focus,
        .job-form-group textarea:focus {
            outline: none;
            border-color: var(--brand-primary);
            box-shadow: 0 0 0 3px rgba(252, 186, 3, 0.15);
        }

        .job-form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .job-item-preview {
            background: var(--bg-tertiary);
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid var(--border);
        }

        .job-item-preview .item-name {
            font-weight: 700;
            color: var(--text-primary);
            font-size: 1rem;
            margin-bottom: 4px;
        }

        .job-item-preview .item-vehicle {
            max-height: 40px;
            overflow-y: auto;
            font-size: 0.75rem;
            color: var(--text-muted);
            line-height: 1.4;
            scrollbar-width: none;
            cursor: help;
        }

        .job-item-preview .item-vehicle::-webkit-scrollbar {
            display: none;
        }

        .job-modal-actions {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        .job-modal-actions button {
            flex: 1;
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-cancel-job {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            color: var(--text-secondary);
        }

        .btn-cancel-job:hover {
            background: var(--bg-primary);
        }

        .btn-save-job {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            border: none;
            color: white;
        }

        .btn-save-job:hover {
            background: linear-gradient(135deg, #16a34a, #15803d);
            box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
        }

        /* ========================================
           SUBSCRIPTION TRACKER STYLES
           ======================================== */

        /* Alert Banner for Expiring Subscriptions */
        .sub-alert-banner {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.15), rgba(220, 38, 38, 0.1));
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 16px;
            padding: 20px 24px;
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .sub-alert-banner.warning {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.15), rgba(217, 119, 6, 0.1));
            border-color: rgba(245, 158, 11, 0.3);
        }

        .sub-alert-icon {
            font-size: 2rem;
            flex-shrink: 0;
        }

        .sub-alert-content {
            flex: 1;
        }

        .sub-alert-title {
            font-weight: 700;
            font-size: 1rem;
            color: #f87171;
            margin-bottom: 4px;
        }

        .sub-alert-banner.warning .sub-alert-title {
            color: #fbbf24;
        }

        .sub-alert-desc {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        /* Quick Stats Row */
        .sub-stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px;
            margin-bottom: 32px;
        }

        .sub-stat-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .sub-stat-card:hover {
            border-color: var(--brand-primary);
            transform: translateY(-2px);
        }

        .sub-stat-number {
            font-size: 2.5rem;
            font-weight: 800;
            line-height: 1;
            margin-bottom: 8px;
        }

        .sub-stat-number.active {
            color: #22c55e;
        }

        .sub-stat-number.warning {
            color: #f59e0b;
        }

        .sub-stat-number.expired {
            color: #ef4444;
        }

        .sub-stat-number.lifetime {
            color: #a855f7;
        }

        .sub-stat-label {
            font-size: 0.85rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Subscription Cards Grid */
        .sub-cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }

        @media (max-width: 768px) {
            .sub-cards-grid {
                grid-template-columns: 1fr;
            }
        }

        .sub-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 24px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .sub-card:hover {
            border-color: var(--brand-primary);
            box-shadow: 0 8px 32px rgba(251, 191, 36, 0.1);
            transform: translateY(-3px);
        }

        .sub-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #22c55e, #16a34a);
        }

        .sub-card.status-warning::before {
            background: linear-gradient(90deg, #f59e0b, #d97706);
        }

        .sub-card.status-critical::before {
            background: linear-gradient(90deg, #ef4444, #dc2626);
            animation: pulse-danger 2s infinite;
        }

        .sub-card.status-expired::before {
            background: linear-gradient(90deg, #6b7280, #4b5563);
        }

        .sub-card.status-lifetime::before {
            background: linear-gradient(90deg, #a855f7, #9333ea);
        }

        @keyframes pulse-danger {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        .sub-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }

        .sub-card-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .sub-card-vendor {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .sub-card-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .sub-card-badge.active {
            background: rgba(34, 197, 94, 0.15);
            color: #22c55e;
            border: 1px solid rgba(34, 197, 94, 0.3);
        }

        .sub-card-badge.warning {
            background: rgba(245, 158, 11, 0.15);
            color: #f59e0b;
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        .sub-card-badge.critical {
            background: rgba(239, 68, 68, 0.15);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .sub-card-badge.expired {
            background: rgba(107, 114, 128, 0.15);
            color: #9ca3af;
            border: 1px solid rgba(107, 114, 128, 0.3);
        }

        .sub-card-badge.lifetime {
            background: rgba(168, 85, 247, 0.15);
            color: #a855f7;
            border: 1px solid rgba(168, 85, 247, 0.3);
        }

        .sub-card-meta {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 16px;
            padding: 16px;
            background: var(--bg-tertiary);
            border-radius: 12px;
        }

        .sub-meta-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .sub-meta-label {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
        }

        .sub-meta-value {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .sub-countdown {
            text-align: center;
            padding: 12px 16px;
            background: var(--bg-tertiary);
            border-radius: 12px;
            margin-bottom: 16px;
        }

        .sub-countdown-days {
            font-size: 2rem;
            font-weight: 800;
            color: #22c55e;
        }

        .sub-card.status-warning .sub-countdown-days {
            color: #f59e0b;
        }

        .sub-card.status-critical .sub-countdown-days {
            color: #ef4444;
        }

        .sub-card.status-expired .sub-countdown-days {
            color: #6b7280;
        }

        .sub-card.status-lifetime .sub-countdown-days {
            color: #a855f7;
        }

        .sub-countdown-label {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .sub-card-notes {
            font-size: 0.85rem;
            color: var(--text-secondary);
            padding: 12px;
            background: rgba(251, 191, 36, 0.05);
            border-left: 3px solid var(--brand-primary);
            border-radius: 0 8px 8px 0;
            margin-bottom: 12px;
        }

        .sub-card-benefit {
            font-size: 0.85rem;
            color: #10b981;
            padding: 12px;
            background: rgba(16, 185, 129, 0.08);
            border-left: 3px solid #10b981;
            border-radius: 0 8px 8px 0;
            margin-bottom: 16px;
            line-height: 1.5;
        }

        .sub-card-benefit strong {
            color: #34d399;
        }

        .sub-card-actions {
            display: flex;
            gap: 10px;
        }

        .sub-card-actions button,
        .sub-card-actions a {
            flex: 1;
            padding: 10px 16px;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            text-align: center;
            transition: all 0.2s;
            border: 1px solid var(--border);
            background: var(--bg-tertiary);
            color: var(--text-secondary);
        }

        .sub-card-actions button:hover,
        .sub-card-actions a:hover {
            background: var(--bg-primary);
            border-color: var(--brand-primary);
            color: var(--text-primary);
        }

        .sub-card-actions .btn-renew {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            border: none;
            color: white;
        }

        .sub-card-actions .btn-renew:hover {
            background: linear-gradient(135deg, #16a34a, #15803d);
        }

        /* Add Subscription Button */
        .sub-add-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 100%;
            max-width: 400px;
            margin: 0 auto 32px;
            padding: 16px 24px;
            background: linear-gradient(135deg, var(--brand-primary), var(--brand-secondary));
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 700;
            color: var(--bg-primary);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .sub-add-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(251, 191, 36, 0.3);
        }

        /* Subscription Modal */
        .sub-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .sub-modal {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 20px;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .sub-modal-header {
            padding: 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sub-modal-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .sub-modal-close {
            background: var(--bg-tertiary);
            border: none;
            color: var(--text-muted);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .sub-modal-close:hover {
            background: var(--bg-primary);
            color: var(--text-primary);
        }

        .sub-modal-body {
            padding: 24px;
        }

        .sub-form-group {
            margin-bottom: 20px;
        }

        .sub-form-label {
            display: block;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            margin-bottom: 8px;
        }

        .sub-form-input,
        .sub-form-select,
        .sub-form-textarea {
            width: 100%;
            padding: 14px 16px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 0.95rem;
            font-family: inherit;
        }

        .sub-form-input:focus,
        .sub-form-select:focus,
        .sub-form-textarea:focus {
            outline: none;
            border-color: var(--brand-primary);
        }

        .sub-form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .sub-modal-footer {
            padding: 20px 24px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 12px;
        }

        .sub-modal-footer button {
            flex: 1;
            padding: 14px 20px;
            border-radius: 10px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .sub-btn-cancel {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            color: var(--text-secondary);
        }

        .sub-btn-cancel:hover {
            background: var(--bg-primary);
        }

        .sub-btn-save {
            background: linear-gradient(135deg, var(--brand-primary), var(--brand-secondary));
            border: none;
            color: var(--bg-primary);
        }

        .sub-btn-save:hover {
            box-shadow: 0 4px 16px rgba(251, 191, 36, 0.3);
        }

        /* Category Tabs */
        .sub-category-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .sub-category-tab {
            padding: 10px 20px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 24px;
            color: var(--text-secondary);
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .sub-category-tab:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .sub-category-tab.active {
            background: var(--brand-primary);
            color: var(--bg-primary);
            border-color: var(--brand-primary);
        }

        /* License Section */
        .license-section {
            margin-top: 48px;
            padding-top: 32px;
            border-top: 1px solid var(--border);
        }

        .license-section-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
    </style>

    <div class="top-bar">ðŸ“ž Call (804) 506-0709</div>

    <header class="header">
        <div class="logo">ðŸ”‘ EURO <span>KEYS</span></div>
        <div class="header-right">
            <!-- Quick Search Toggle -->
            <div class="header-search-container">
                <button class="header-search-toggle" onclick="toggleHeaderSearch()" title="Quick Search">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"></circle>
                        <path d="m21 21-4.35-4.35"></path>
                    </svg>
                </button>
                <div id="headerSearchBox" class="header-search-box" style="display: none;">
                    <input type="text" id="headerSearchInput" placeholder="Search FCC ID, make, model..."
                        onkeypress="if(event.key==='Enter') headerQuickSearch()">
                    <button onclick="headerQuickSearch()">Go</button>
                    <button onclick="toggleHeaderSearch()" class="close-search">Ã—</button>
                </div>
            </div>

            <!-- User menu shows when signed in -->
            <div id="userMenu" style="display: none; align-items: center; gap: 12px;">
                <button id="headerUpgradeBtn" onclick="startCheckout('monthly', event)" style="
                    background: linear-gradient(135deg, #fbbf24, #f59e0b);
                    border: none;
                    color: #000;
                    padding: 6px 12px;
                    border-radius: 20px;
                    font-weight: 700;
                    font-size: 0.8rem;
                    cursor: pointer;
                    display: flex;
                    align-items: center;
                    gap: 4px;
                    box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);
                ">
                    <span style="font-size: 1rem;">ðŸ‘‘</span> Upgrade
                </button>
                <div class="user-menu-container">
                    <span class="user-name" id="userName"
                        style="font-weight: 600; color: var(--text-primary); cursor: pointer;"
                        onclick="toggleUserMenu()"></span>
                    <div class="header-avatar" id="userAvatar" onclick="toggleUserMenu()" style="cursor: pointer;">
                    </div>

                    <div id="userDropdown" class="user-dropdown">
                        <div style="padding: 12px 16px; border-bottom: 1px solid rgba(255,255,255,0.05);">
                            <div id="dropdownUserName"
                                style="font-weight: 700; color: var(--text-primary); font-size: 0.85rem;">User</div>
                            <div id="dropdownUserEmail"
                                style="font-size: 0.75rem; color: var(--text-muted); overflow: hidden; text-overflow: ellipsis;">
                            </div>
                        </div>
                        <button class="user-dropdown-item" onclick="showTab('inventory')">
                            <span>ðŸ“¦</span> My Inventory
                        </button>
                        <div id="devMenuOption" style="display: none;">
                            <button class="user-dropdown-item" onclick="showTab('dev')">
                                <span>ðŸ› ï¸</span> Dev Panel
                            </button>
                        </div>
                        <div class="user-dropdown-divider"></div>
                        <button class="user-dropdown-item logout" onclick="signOut()">
                            <span>ðŸšª</span> Sign Out
                        </button>
                    </div>
                </div>
            </div>
            <!-- Google Sign In button shows when signed out -->
            <button id="googleSignInBtn" class="google-signin-btn" onclick="signInWithGoogle()" style="display: flex;">
                <svg viewBox="0 0 24 24">
                    <path fill="#4285F4"
                        d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" />
                    <path fill="#34A853"
                        d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" />
                    <path fill="#FBBC05"
                        d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" />
                    <path fill="#EA4335"
                        d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" />
                </svg>
                Sign in
            </button>
        </div>
    </header>

    <!-- Tabs -->
    <div class="tabs" id="mainTabs">
        <button class="tab active" onclick="showTab('browse')">ðŸ“‚ Browse Database</button>
        <button class="tab" id="fccTab" onclick="showTab('fcc')">ðŸ“¡ FCC Database</button>
        <button class="tab" id="guidesTab" onclick="showTab('guides')">ðŸ“– Guides</button>
        <button class="tab" id="inventoryTab" onclick="showTab('inventory')" style="display: none;">ðŸ“¦ My
            Inventory</button>
        <button class="tab" id="devTab" onclick="showTab('dev')" style="display: none;">ðŸ› ï¸ Dev Panel</button>
        <button class="tab" id="subscriptionsTab" onclick="showTab('subscriptions')" style="display: none;">ðŸ“…
            Subscriptions</button>
    </div>

    <!-- BROWSE DATABASE TAB -->
    <div id="browse" class="tab-view active">

        <!-- Hero Section -->
        <div class="hero-section">
            <h1 class="hero-title">Browse Database</h1>
            <p class="hero-subtitle">Access professional locksmith data, programming guides, and part numbers.</p>

            <div id="modelSearchUI">
                <div class="omni-search-container">
                    <i class="fas fa-search omni-search-icon"></i>
                    <input type="text" class="omni-search-input" id="omniSearch"
                        placeholder="Search by Year/Make/Model/VIN..." onkeyup="handleOmniSearch(event)">
                    <button class="omni-scan-btn" onclick="startVinCamera()" title="Scan VIN">
                        <i class="fas fa-camera"></i>
                    </button>
                </div>
                <div id="vinError"
                    style="color: #ef4444; font-size: 0.85rem; margin-top: -30px; margin-bottom: 20px; text-align: center; display: none;">
                </div>
            </div>

            <!-- Pre-calculate results list if needed -->
            <div id="vinLoading" style="display: none; text-align: center; padding: 40px;">
                <div class="loader" style="margin: 0 auto;"></div>
                <p style="margin-top: 16px; color: var(--text-secondary);">Decoding VIN...</p>
            </div>
        </div>

        <!-- Visual Make Selector (Brand Grid) -->
        <div id="visualMakeSelector" style="padding: 0 20px 40px;">
            <h3 style="text-align: center; margin-bottom: 24px; color: var(--text-muted); font-weight: 600;">Or Select a
                Make</h3>
            <div class="make-grid" id="makeGrid">
                <!-- Populated by renderMakeGrid() -->
            </div>
        </div>

        <!-- Drill Down / Selection Card -->
        <div class="card" id="legacySearchCard" style="display: none; max-width: 800px; margin: 0 auto;">

            <!-- Compact Header -->
            <div id="selectedVehicleDisplay"
                style="display: none; border-bottom: 1px solid var(--border); padding-bottom: 16px; margin-bottom: 20px;">
                <div style="display: flex; align-items: center; justify-content: space-between;">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <img id="selectedMakeLogo" src="" style="width: 48px; height: 48px; object-fit: contain;">
                        <div id="selectedMakeAvatar" class="text-avatar" style="display: none; margin: 0;"></div>
                        <div>
                            <h2 id="selectedMakeName" style="margin: 0; font-size: 1.5rem; line-height: 1.2;"></h2>
                            <button onclick="showMakeDropdown()"
                                style="background: none; border: none; padding: 0; color: var(--text-muted); font-size: 0.85rem; cursor: pointer; text-decoration: underline;">Change
                                Make</button>
                            <!-- Quick Make Dropdown (inline) -->
                            <select id="quickMakeDropdown" onchange="quickChangeMake(this.value)"
                                style="display: none; margin-left: 10px; padding: 4px 8px; border-radius: 4px; background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border);">
                                <option value="">Select Make...</option>
                            </select>
                        </div>
                    </div>
                    <!-- Optional: Selected Year Badge -->
                    <div id="selectedYearBadge"
                        style="display: none; background: var(--bg-tertiary); padding: 4px 12px; border-radius: 20px; font-weight: 700; color: var(--brand-primary); border: 1px solid var(--border);">
                    </div>
                </div>
            </div>

            <!-- Step 2: Select Year -->
            <div id="yearChipsContainer" style="display: none;">
                <h3 style="font-size: 1.1rem; margin-bottom: 16px; color: var(--text-secondary);">Select Year</h3>
                <div style="display: flex; flex-wrap: wrap; gap: 8px;" id="yearChips"></div>
            </div>

            <!-- Step 3: Select Model (Visual) -->
            <div id="modelChipsContainer" style="display: none; margin-top: 24px;">
                <h3 style="font-size: 1.1rem; margin-bottom: 16px; color: var(--text-secondary);">Select Model</h3>
                <div class="model-filter-bar" id="modelFilterBar" style="display: none;">
                    <button class="model-filter-btn active" onclick="filterModels('all')">All</button>
                </div>
                <div class="model-grid" id="modelChips"></div>
                <div id="modelLoading"
                    style="display: none; color: var(--text-muted); padding: 20px; text-align: center;">Loading
                    models...</div>
            </div>

            <!-- Legacy Form (Hidden state holder) -->
            <div class="form-group-row" style="display: none;">
                <div class="form-group">
                    <label>YEAR</label>
                    <select id="yearSelect" onchange="loadMakes()">
                        <option value="">Select Year</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>MAKE</label>
                    <select id="makeSelect" onchange="loadModels()">
                        <option value="">Select Make</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>MODEL</label>
                    <select id="modelSelect" disabled onchange="searchVehicle()">
                        <option value="">Select Model</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Loader -->
        <div class="loader" id="loader"></div>

        <!-- Results -->
        <div id="results"></div>
    </div>
    <div id="resultsSection" class="results-section">
        <div class="container">
            <div class="result-header">
                <div style="display: flex; align-items: center; flex-wrap: wrap; gap: 12px;">
                    <h2 class="result-title" id="resultTitle" style="margin: 0;">Vehicle Results</h2>
                    <div class="year-nav" id="yearNavigation" style="display: none;">
                        <button class="year-nav-btn" id="yearPrevBtn" onclick="navigateYear(-1)"
                            title="Previous Year">â†</button>
                        <span class="year-nav-current" id="yearNavCurrent">2023</span>
                        <button class="year-nav-btn" id="yearNextBtn" onclick="navigateYear(1)"
                            title="Next Year">â†’</button>
                    </div>
                </div>
                <div class="result-actions">
                    <button class="back-btn" onclick="goBack()">ðŸ” New Search</button>
                </div>
            </div>

            <!-- Quick vehicle switcher -->
            <div class="quick-search" style="display: flex; gap: 8px; margin-bottom: 20px; flex-wrap: wrap;">
                <select class="browse-select" id="quickYear" onchange="quickLoadMakes()"
                    style="padding: 10px 14px; font-size: 0.9rem; flex: 1; min-width: 100px;">
                    <option value="">Year</option>
                </select>
                <select class="browse-select" id="quickMake" onchange="quickLoadModels()"
                    style="padding: 10px 14px; font-size: 0.9rem; flex: 1; min-width: 120px;">
                    <option value="">Make</option>
                </select>
                <select class="browse-select" id="quickModel"
                    style="padding: 10px 14px; font-size: 0.9rem; flex: 1; min-width: 120px;">
                    <option value="">Model</option>
                </select>
                <button onclick="quickSearch()"
                    style="padding: 10px 16px; background: var(--brand-primary); border: none; border-radius: 8px; color: var(--bg-primary); font-weight: 600; cursor: pointer; white-space: nowrap;">Go
                    â†’</button>
            </div>

            <div id="resultsContainer"></div>
        </div>
    </div>
    </div>

    <!-- FCC Database Tab -->
    <div class="tab-content" id="tabFcc">
        <div class="container">
            <div class="page-title">
                <h1>Key <span>Database</span> & Coverage</h1>
            </div>
            <p class="page-subtitle">Browse FCC IDs for key fobs and remotes with direct Amazon links.</p>

            <div class="fcc-filters" style="flex-wrap: wrap;">
                <button class="fcc-filter active" data-type="all" onclick="setFccFilter('all')">All Keys</button>
                <button class="fcc-filter" data-type="smart" onclick="setFccFilter('smart')">ðŸš— Smart/Prox</button>
                <button class="fcc-filter" data-type="transponder" onclick="setFccFilter('transponder')">ðŸ·ï¸
                    Transponder</button>
                <button class="fcc-filter" data-type="remote-head" onclick="setFccFilter('remote-head')">ðŸ”‘ Remote
                    Head</button>
                <button class="fcc-filter" data-type="flip" onclick="setFccFilter('flip')">ðŸ”„ Flip Key</button>
                <button class="fcc-filter" data-type="mechanical" onclick="setFccFilter('mechanical')">ðŸ—ï¸
                    Mechanical</button>

                <!-- Year filters hidden/moved if desired, or kept here -->
            </div>

            <!-- KEY DATABASE HEADER & HEATMAP CONTAINER -->
            <div id="keyCoverageContainer" style="margin-bottom: 24px;">
                <!-- Heatmap injected by renderKeyCoverageMap() -->
            </div>

            <div class="fcc-search" style="margin-top: 20px;">
                <input type="text" id="fccSearch" placeholder="ðŸ” Search keys... (e.g. 'Honda Civic 2018', 'HYQ12BDM')"
                    oninput="filterFccTable()">
            </div>

            <div class="fcc-table-wrapper">
                <table class="fcc-table">
                    <thead>
                        <tr>
                            <th>FCC ID</th>
                            <th>OEM Part #</th>
                            <th>Vehicles</th>
                            <th class="hide-mobile">Frequency</th>
                            <th class="hide-mobile">Chip</th>
                            <th>Stock</th>
                            <th>Amazon</th>
                        </tr>
                    </thead>
                    <tbody id="fccTableBody">
                        <tr>
                            <td colspan="7" class="loading">Loading FCC data...</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Mobile-first cards view -->
            <div class="fcc-cards" id="fccCards">
                <div class="loading" style="text-align: center; padding: 40px; color: var(--text-muted);">
                    Loading
                    FCC
                    data...</div>
            </div>

            <div class="pagination" id="fccPagination"></div>
        </div>
    </div>

    <!-- Guides Tab -->
    <div class="tab-content" id="tabGuides" style="display: none;">
        <div class="container">
            <div class="page-title">
                <h1>ðŸ“– Programming <span>Guides</span></h1>
            </div>
            <p class="page-subtitle">Comprehensive guides for every make for key programming procedures.</p>

            <!-- Guides Search and Filters -->
            <div class="fcc-filters" style="flex-wrap: wrap; margin-bottom: 20px;">
                <button class="fcc-filter active" data-make="all" onclick="filterGuidesByMake('all')">All Makes</button>
                <button class="fcc-filter" data-make="chevrolet"
                    onclick="filterGuidesByMake('chevrolet')">Chevrolet/GM</button>
                <button class="fcc-filter" data-make="mercedes-benz"
                    onclick="filterGuidesByMake('mercedes-benz')">Mercedes-Benz</button>
                <button class="fcc-filter" data-make="audi" onclick="filterGuidesByMake('audi')">Audi/VW</button>
                <button class="fcc-filter" data-make="bmw" onclick="filterGuidesByMake('bmw')">BMW</button>
                <button class="fcc-filter" data-make="toyota" onclick="filterGuidesByMake('toyota')">Toyota</button>
                <button class="fcc-filter" data-make="honda" onclick="filterGuidesByMake('honda')">Honda</button>
                <button class="fcc-filter" data-make="ford" onclick="filterGuidesByMake('ford')">Ford</button>
                <button class="fcc-filter" data-make="stellantis"
                    onclick="filterGuidesByMake('stellantis')">Stellantis</button>
                <button class="fcc-filter" data-make="land rover"
                    onclick="filterGuidesByMake('land rover')">JLR</button>
                <button class="fcc-filter" data-make="mazda" onclick="filterGuidesByMake('mazda')">Mazda</button>
                <button class="fcc-filter" data-make="volvo" onclick="filterGuidesByMake('volvo')">Volvo</button>
            </div>

            <div class="fcc-search" style="margin-bottom: 20px;">
                <input type="text" id="guidesSearch"
                    placeholder="ðŸ” Search guides... (e.g. 'E-Class FBS4', 'Camry H chip')"
                    oninput="filterGuidesTable()">
            </div>

            <!-- Guide Stats -->
            <div id="guideStats" style="display: flex; gap: 16px; margin-bottom: 24px; flex-wrap: wrap;">
                <div class="stat-card"
                    style="flex: 1; min-width: 150px; background: var(--bg-tertiary); padding: 16px; border-radius: 12px; border: 1px solid var(--border);">
                    <div style="font-size: 2rem; font-weight: 700; color: var(--brand-primary);" id="totalGuidesCount">
                        --</div>
                    <div style="color: var(--text-muted); font-size: 0.85rem;">Total Guides</div>
                </div>
                <div class="stat-card"
                    style="flex: 1; min-width: 150px; background: var(--bg-tertiary); padding: 16px; border-radius: 12px; border: 1px solid var(--border);">
                    <div style="font-size: 2rem; font-weight: 700; color: #22c55e;" id="uniqueMakesCount">--</div>
                    <div style="color: var(--text-muted); font-size: 0.85rem;">Makes Covered</div>
                </div>
                <div class="stat-card"
                    style="flex: 1; min-width: 150px; background: var(--bg-tertiary); padding: 16px; border-radius: 12px; border: 1px solid var(--border);">
                    <div style="font-size: 2rem; font-weight: 700; color: #f59e0b;" id="dealerOnlyCount">--</div>
                    <div style="color: var(--text-muted); font-size: 0.85rem;">Dealer-Only</div>
                </div>
            </div>

            <!-- Guides Grid -->
            <div id="guidesGrid"
                style="display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 16px;">
                <div class="loading"
                    style="grid-column: 1 / -1; text-align: center; padding: 40px; color: var(--text-muted);">
                    Loading guides...
                </div>
            </div>
        </div>
    </div>



    <!-- Camera Scanner Modal -->
    <div id="vinCameraModal"
        style="display: none; margin-top: 16px; padding: 16px; background: var(--bg-tertiary); border-radius: 12px; border: 1px solid var(--border);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
            <span style="font-weight: 600; color: var(--text-primary);">ðŸ“· VIN Camera Scanner</span>
            <button onclick="stopVinCamera()"
                style="background: #ef4444; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.85rem;">Close
                âœ•</button>
        </div>
        <video id="vinCameraVideo" style="width: 100%; max-height: 300px; border-radius: 8px; background: #000;"
            autoplay playsinline></video>
        <div style="margin-top: 12px; text-align: center;">
            <button onclick="captureVinFrame(event)" class="search-btn" style="padding: 10px 24px;">ðŸ“¸
                Capture &
                Scan</button>
        </div>
        <canvas id="vinCameraCanvas" style="display: none;"></canvas>
        <div id="vinScanResult"
            style="margin-top: 12px; display: none; padding: 12px; background: rgba(34, 197, 94, 0.1); border-radius: 8px; border: 1px solid #22c55e;">
            <span style="color: #22c55e; font-weight: 600;">Detected VIN: </span>
            <span id="vinDetectedText"
                style="font-family: monospace; letter-spacing: 2px; color: var(--text-primary);"></span>
            <button onclick="useDetectedVin()"
                style="margin-left: 12px; background: #22c55e; color: white; border: none; padding: 4px 12px; border-radius: 4px; cursor: pointer;">Use
                This</button>
        </div>
    </div>
    </div>

    <!-- VIN Results Section -->
    <div id="vinResults" style="display: none;">
        <!-- Vehicle Info Banner -->
        <div id="vinVehicleInfo"
            style="background: linear-gradient(135deg, var(--bg-tertiary), var(--bg-secondary)); padding: 20px 24px; border-radius: 12px; border: 1px solid var(--border); margin-bottom: 24px;">
        </div>

        <!-- Key Parts Grid -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">

            <!-- Key Blank Section -->
            <div class="vin-result-card"
                style="background: var(--bg-tertiary); border-radius: 12px; padding: 20px; border: 1px solid var(--border);">
                <div
                    style="display: flex; align-items: center; gap: 10px; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid var(--border);">
                    <span style="font-size: 1.5rem;">ðŸ”‘</span>
                    <h3 style="margin: 0; color: var(--brand-primary);">Key Blank</h3>
                </div>
                <div id="vinKeyBlank" class="vin-data-grid"></div>
            </div>

            <!-- Transponder Section -->
            <div class="vin-result-card"
                style="background: var(--bg-tertiary); border-radius: 12px; padding: 20px; border: 1px solid var(--border);">
                <div
                    style="display: flex; align-items: center; gap: 10px; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid var(--border);">
                    <span style="font-size: 1.5rem;">ðŸ·ï¸</span>
                    <h3 style="margin: 0; color: var(--brand-primary);">Transponder / Chip</h3>
                </div>
                <div id="vinTransponder" class="vin-data-grid"></div>
            </div>

            <!-- Remote / FOB Section -->
            <div class="vin-result-card"
                style="background: var(--bg-tertiary); border-radius: 12px; padding: 20px; border: 1px solid var(--border);">
                <div
                    style="display: flex; align-items: center; gap: 10px; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid var(--border);">
                    <span style="font-size: 1.5rem;">ðŸ“¡</span>
                    <h3 style="margin: 0; color: var(--brand-primary);">Remote / Key Fob</h3>
                </div>
                <div id="vinRemote" class="vin-data-grid"></div>
            </div>

            <!-- Programming Section -->
            <div class="vin-result-card"
                style="background: var(--bg-tertiary); border-radius: 12px; padding: 20px; border: 1px solid var(--border);">
                <div
                    style="display: flex; align-items: center; gap: 10px; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid var(--border);">
                    <span style="font-size: 1.5rem;">ðŸ› ï¸</span>
                    <h3 style="margin: 0; color: var(--brand-primary);">Programming Info</h3>
                </div>
                <div id="vinProgramming" class="vin-data-grid"></div>
            </div>
        </div>

        <!-- Buy Links Section -->
        <div id="vinBuyLinks"
            style="margin-top: 24px; background: linear-gradient(135deg, #1a472a, #2d5a3f); border-radius: 12px; padding: 20px; border: 1px solid #3d7a5a;">
            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 16px;">
                <span style="font-size: 1.5rem;">ðŸ›’</span>
                <h3 style="margin: 0; color: #4ade80;">Buy Parts on Amazon</h3>
            </div>
            <div id="vinAmazonLinks" style="display: flex; gap: 12px; flex-wrap: wrap;"></div>
        </div>
    </div>

    <!-- Loading State -->
    <div id="vinLoading" style="display: none; text-align: center; padding: 60px; color: var(--text-muted);">
        <div style="font-size: 2rem; margin-bottom: 12px;">ðŸ”„</div>
        <div>Decoding VIN...</div>
    </div>
    </div>
    </div>

    <!-- Developer Panel Tab (only visible to developers) -->
    <div class="tab-content" id="tabDev" style="display: none;">
        <div class="container">
            <div class="page-title">
                <h1>ðŸ› ï¸ Developer <span>Panel</span></h1>
            </div>
            <p class="page-subtitle">User analytics and activity tracking dashboard.</p>

            <!-- Global Error Banner (Hidden by default) -->
            <div id="devGlobalError"
                style="display: none; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.2); border-radius: 12px; padding: 16px; margin-top: 24px; align-items: center; gap: 12px; color: #f87171;">
                <span style="font-size: 1.2rem;">âš ï¸</span>
                <div style="flex: 1;">
                    <div style="font-weight: 700; font-size: 0.9rem;">Data Stream Interrupted</div>
                    <div id="devGlobalErrorMsg" style="font-size: 0.8rem; opacity: 0.9;">Unable to reach the analytics
                        engine. Please ensure you are logged in.</div>
                </div>
                <button onclick="loadDevPanel()"
                    style="background: rgba(239, 68, 68, 0.2); border: none; color: white; padding: 6px 16px; border-radius: 8px; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.2s;">Retry</button>
            </div>

            <!-- High-Impact KPIs (1 Million Dollar Business Analytics) -->
            <div id="devKpis"
                style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-top: 24px;">
                <div
                    style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(37, 99, 235, 0.05)); border-radius: 20px; padding: 24px; border: 1px solid rgba(59, 130, 246, 0.2); box-shadow: 0 8px 32px rgba(0,0,0,0.2);">
                    <div
                        style="color: var(--text-muted); font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">
                        Total Platform Users</div>
                    <div style="font-size: 2.5rem; font-weight: 850; color: #60a5fa; line-height: 1;"
                        id="devTotalUsers">-</div>
                    <div style="margin-top: 12px; font-size: 0.8rem; color: #4ade80;">â†‘ <span
                            id="devUserGrowth">0</span>% vs last 30d</div>
                </div>
                <div
                    style="background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(217, 119, 6, 0.05)); border-radius: 20px; padding: 24px; border: 1px solid rgba(245, 158, 11, 0.2); box-shadow: 0 8px 32px rgba(0,0,0,0.2);">
                    <div
                        style="color: var(--text-muted); font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">
                        Est. Monthly Revenue</div>
                    <div style="font-size: 2.5rem; font-weight: 850; color: #fbbf24; line-height: 1;"
                        id="devEstRevenue">$0.00</div>
                    <div style="margin-top: 12px; font-size: 0.8rem; color: var(--text-muted);">Based on $1.50/click avg
                    </div>
                </div>
                <div
                    style="background: linear-gradient(135deg, rgba(34, 211, 238, 0.1), rgba(8, 145, 178, 0.05)); border-radius: 20px; padding: 24px; border: 1px solid rgba(34, 211, 238, 0.2); box-shadow: 0 8px 32px rgba(0,0,0,0.2);">
                    <div
                        style="color: var(--text-muted); font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">
                        Conversion Rate (CVR)</div>
                    <div style="font-size: 2.5rem; font-weight: 850; color: #22d3ee; line-height: 1;"
                        id="devConversionRate">0.0%</div>
                    <div style="margin-top: 12px; font-size: 0.8rem; color: #4ade80;">Search â†’ Click</div>
                </div>
                <div
                    style="background: linear-gradient(135deg, rgba(168, 85, 247, 0.1), rgba(147, 51, 234, 0.05)); border-radius: 20px; padding: 24px; border: 1px solid rgba(168, 85, 247, 0.2); box-shadow: 0 8px 32px rgba(0,0,0,0.2);">
                    <div
                        style="color: var(--text-muted); font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">
                        Active Engagement</div>
                    <div style="font-size: 2.5rem; font-weight: 850; color: #c084fc; line-height: 1;"
                        id="devAvgEngagement">0.0</div>
                    <div style="margin-top: 12px; font-size: 0.8rem; color: var(--text-muted);">Avg. interactions per
                        guest</div>
                </div>
            </div>

            <!-- Cloudflare Traffic Analytics with Persona Tabs -->
            <div style="margin-top: 32px;">
                <div
                    style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 12px;">
                    <h3 style="color: var(--text-primary); display: flex; align-items: center; gap: 10px; margin: 0;">
                        <span>â˜ï¸</span> Cloudflare Traffic
                        <span
                            style="font-size: 0.7rem; background: rgba(249, 115, 22, 0.2); color: #f97316; padding: 4px 10px; border-radius: 100px; font-weight: 600;">LIVE</span>
                    </h3>
                    <div id="cfPersonaTabs" style="display: flex; gap: 6px;">
                        <button class="cf-persona-tab active" data-tab="overview" onclick="setCfPersonaTab('overview')"
                            style="background: rgba(249,115,22,0.2); border: 1px solid rgba(249,115,22,0.3); color: #f97316; padding: 6px 14px; border-radius: 8px; font-size: 0.75rem; cursor: pointer; font-weight: 600;">
                            ðŸ“Š Overview
                        </button>
                        <button class="cf-persona-tab" data-tab="tech" onclick="setCfPersonaTab('tech')"
                            style="background: rgba(96,165,250,0.1); border: 1px solid rgba(96,165,250,0.2); color: #60a5fa; padding: 6px 14px; border-radius: 8px; font-size: 0.75rem; cursor: pointer; font-weight: 600; opacity: 0.7;">
                            ðŸ”§ Tech
                        </button>
                        <button class="cf-persona-tab" data-tab="marketing" onclick="setCfPersonaTab('marketing')"
                            style="background: rgba(34,197,94,0.1); border: 1px solid rgba(34,197,94,0.2); color: #22c55e; padding: 6px 14px; border-radius: 8px; font-size: 0.75rem; cursor: pointer; font-weight: 600; opacity: 0.7;">
                            ðŸ“¢ Marketing
                        </button>
                    </div>
                </div>

                <!-- Overview Tab Content (Default) -->
                <div id="cfTabOverview" class="cf-tab-content">
                    <div id="cfAnalyticsContainer"
                        style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 16px;">
                        <div
                            style="background: linear-gradient(135deg, rgba(249, 115, 22, 0.1), rgba(194, 65, 12, 0.05)); border-radius: 16px; padding: 20px; border: 1px solid rgba(249, 115, 22, 0.2);">
                            <div
                                style="color: var(--text-muted); font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px;">
                                Unique Visitors (24h)</div>
                            <div style="font-size: 2rem; font-weight: 850; color: #f97316;" id="cfVisitors24h">--</div>
                            <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 4px;"><span
                                    id="cfVisitors7d">--</span> (7d)</div>
                        </div>
                        <div
                            style="background: linear-gradient(135deg, rgba(34, 197, 94, 0.1), rgba(22, 163, 74, 0.05)); border-radius: 16px; padding: 20px; border: 1px solid rgba(34, 197, 94, 0.2);">
                            <div
                                style="color: var(--text-muted); font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px;">
                                Total Requests (24h)</div>
                            <div style="font-size: 2rem; font-weight: 850; color: #22c55e;" id="cfRequests24h">--</div>
                            <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 4px;"><span
                                    id="cfRequests7d">--</span> (7d)</div>
                        </div>
                        <div
                            style="background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(124, 58, 237, 0.05)); border-radius: 16px; padding: 20px; border: 1px solid rgba(139, 92, 246, 0.2);">
                            <div
                                style="color: var(--text-muted); font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px;">
                                Data Served (24h)</div>
                            <div style="font-size: 2rem; font-weight: 850; color: #8b5cf6;" id="cfData24h">--</div>
                            <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 4px;"><span
                                    id="cfData7d">--</span> (7d)</div>
                        </div>
                        <div
                            style="background: linear-gradient(135deg, rgba(6, 182, 212, 0.1), rgba(8, 145, 178, 0.05)); border-radius: 16px; padding: 20px; border: 1px solid rgba(6, 182, 212, 0.2);">
                            <div
                                style="color: var(--text-muted); font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px;">
                                Cache Hit Rate</div>
                            <div style="font-size: 2rem; font-weight: 850; color: #06b6d4;" id="cfCacheRate24h">--</div>
                            <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 4px;"><span
                                    id="cfCacheRate7d">--</span> (7d)</div>
                        </div>
                    </div>
                </div>

                <!-- Tech Tab Content -->
                <div id="cfTabTech" class="cf-tab-content" style="display: none;">
                    <div
                        style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 20px;">
                        <div
                            style="background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(220, 38, 38, 0.05)); border-radius: 16px; padding: 20px; border: 1px solid rgba(239, 68, 68, 0.2);">
                            <div
                                style="color: var(--text-muted); font-size: 0.75rem; text-transform: uppercase; margin-bottom: 6px;">
                                Error Rate (7d)</div>
                            <div style="font-size: 2rem; font-weight: 850; color: #ef4444;" id="cfErrorRate">0.00%</div>
                            <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 4px;">4xx + 5xx
                                responses</div>
                        </div>
                        <div
                            style="background: linear-gradient(135deg, rgba(6, 182, 212, 0.1), rgba(8, 145, 178, 0.05)); border-radius: 16px; padding: 20px; border: 1px solid rgba(6, 182, 212, 0.2);">
                            <div
                                style="color: var(--text-muted); font-size: 0.75rem; text-transform: uppercase; margin-bottom: 6px;">
                                Cache Rate (7d)</div>
                            <div style="font-size: 2rem; font-weight: 850; color: #06b6d4;" id="cfCacheRateTech">--
                            </div>
                            <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 4px;">Served from edge
                            </div>
                        </div>
                        <div
                            style="background: linear-gradient(135deg, rgba(251, 191, 36, 0.1), rgba(245, 158, 11, 0.05)); border-radius: 16px; padding: 20px; border: 1px solid rgba(251, 191, 36, 0.2);">
                            <div
                                style="color: var(--text-muted); font-size: 0.75rem; text-transform: uppercase; margin-bottom: 6px;">
                                Threats Blocked (7d)</div>
                            <div style="font-size: 2rem; font-weight: 850; color: #fbbf24;" id="cfThreats">0</div>
                            <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 4px;">Security
                                incidents</div>
                        </div>
                    </div>
                    <!-- Status Code Breakdown -->
                    <div
                        style="background: var(--glass-bg); border-radius: 16px; padding: 20px; border: 1px solid var(--glass-border);">
                        <div style="color: var(--text-primary); font-weight: 700; margin-bottom: 16px;">Response Status
                            Codes (7d)</div>
                        <div id="cfStatusBars" style="display: flex; flex-direction: column; gap: 10px;">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <span style="width: 40px; color: #4ade80; font-weight: 600;">2xx</span>
                                <div
                                    style="flex: 1; height: 20px; background: rgba(255,255,255,0.05); border-radius: 4px; overflow: hidden;">
                                    <div id="cfStatus2xx"
                                        style="width: 0%; height: 100%; background: #4ade80; transition: width 0.5s;">
                                    </div>
                                </div>
                                <span id="cfStatus2xxPct"
                                    style="width: 50px; text-align: right; color: var(--text-muted); font-size: 0.85rem;">0%</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <span style="width: 40px; color: #60a5fa; font-weight: 600;">3xx</span>
                                <div
                                    style="flex: 1; height: 20px; background: rgba(255,255,255,0.05); border-radius: 4px; overflow: hidden;">
                                    <div id="cfStatus3xx"
                                        style="width: 0%; height: 100%; background: #60a5fa; transition: width 0.5s;">
                                    </div>
                                </div>
                                <span id="cfStatus3xxPct"
                                    style="width: 50px; text-align: right; color: var(--text-muted); font-size: 0.85rem;">0%</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <span style="width: 40px; color: #fbbf24; font-weight: 600;">4xx</span>
                                <div
                                    style="flex: 1; height: 20px; background: rgba(255,255,255,0.05); border-radius: 4px; overflow: hidden;">
                                    <div id="cfStatus4xx"
                                        style="width: 0%; height: 100%; background: #fbbf24; transition: width 0.5s;">
                                    </div>
                                </div>
                                <span id="cfStatus4xxPct"
                                    style="width: 50px; text-align: right; color: var(--text-muted); font-size: 0.85rem;">0%</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <span style="width: 40px; color: #ef4444; font-weight: 600;">5xx</span>
                                <div
                                    style="flex: 1; height: 20px; background: rgba(255,255,255,0.05); border-radius: 4px; overflow: hidden;">
                                    <div id="cfStatus5xx"
                                        style="width: 0%; height: 100%; background: #ef4444; transition: width 0.5s;">
                                    </div>
                                </div>
                                <span id="cfStatus5xxPct"
                                    style="width: 50px; text-align: right; color: var(--text-muted); font-size: 0.85rem;">0%</span>
                            </div>
                        </div>
                    </div>

                    <!-- Security Details -->
                    <div
                        style="background: var(--glass-bg); border-radius: 16px; padding: 20px; border: 1px solid var(--glass-border); margin-top: 20px;">
                        <div
                            style="color: var(--text-primary); font-weight: 700; margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                            ðŸ›¡ï¸ Security Events (7d)
                        </div>
                        <div id="cfSecurityList" style="display: flex; flex-direction: column; gap: 8px;">
                            <div style="color: var(--text-muted); font-size: 0.85rem;">Loading...</div>
                        </div>
                    </div>
                </div>

                <!-- Marketing Tab Content -->
                <div id="cfTabMarketing" class="cf-tab-content" style="display: none;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px;">
                        <!-- Top Countries -->
                        <div
                            style="background: var(--glass-bg); border-radius: 16px; padding: 20px; border: 1px solid var(--glass-border);">
                            <div
                                style="color: var(--text-primary); font-weight: 700; margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                                ðŸŒ Top Countries (7d)
                            </div>
                            <div id="cfCountriesList" style="display: flex; flex-direction: column; gap: 8px;">
                                <div style="color: var(--text-muted); font-size: 0.85rem;">Loading...</div>
                            </div>
                        </div>
                        <!-- Device Breakdown -->
                        <div
                            style="background: var(--glass-bg); border-radius: 16px; padding: 20px; border: 1px solid var(--glass-border);">
                            <div
                                style="color: var(--text-primary); font-weight: 700; margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                                ðŸ“± Devices (7d)
                            </div>
                            <div id="cfDevicesList" style="display: flex; flex-direction: column; gap: 8px;">
                                <div style="color: var(--text-muted); font-size: 0.85rem;">Loading...</div>
                            </div>
                        </div>
                        <!-- Browser Breakdown -->
                        <div
                            style="background: var(--glass-bg); border-radius: 16px; padding: 20px; border: 1px solid var(--glass-border);">
                            <div
                                style="color: var(--text-primary); font-weight: 700; margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                                ðŸŒ Browsers (7d)
                            </div>
                            <div id="cfBrowsersList" style="display: flex; flex-direction: column; gap: 8px;">
                                <div style="color: var(--text-muted); font-size: 0.85rem;">Loading...</div>
                            </div>
                        </div>
                        <!-- Top Content -->
                        <div
                            style="background: var(--glass-bg); border-radius: 16px; padding: 20px; border: 1px solid var(--glass-border);">
                            <div
                                style="color: var(--text-primary); font-weight: 700; margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                                ðŸ“„ Top Content (7d)
                            </div>
                            <div id="cfPathsList" style="display: flex; flex-direction: column; gap: 8px;">
                                <div style="color: var(--text-muted); font-size: 0.85rem;">Loading...</div>
                            </div>
                        </div>
                        <!-- Referrers -->
                        <div
                            style="background: var(--glass-bg); border-radius: 16px; padding: 20px; border: 1px solid var(--glass-border);">
                            <div
                                style="color: var(--text-primary); font-weight: 700; margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                                ðŸ”— Referrers (7d)
                            </div>
                            <div id="cfReferrersList" style="display: flex; flex-direction: column; gap: 8px;">
                                <div style="color: var(--text-muted); font-size: 0.85rem;">Loading...</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="cfConfigMessage"
                    style="display: none; text-align: center; padding: 24px; color: var(--text-muted); font-size: 0.9rem;">
                    <div style="font-size: 1.5rem; margin-bottom: 8px;">ðŸ”§</div>
                    <span id="cfConfigText">Configure CF_ANALYTICS_TOKEN and CF_ZONE_ID to enable Cloudflare
                        analytics</span>
                </div>
            </div>

            <!-- Conversion Funnel & AI Insight -->
            <div style="display: grid; grid-template-columns: 1.5fr 1fr; gap: 24px; margin-top: 32px;">
                <!-- Funnel -->
                <div
                    style="background: var(--glass-bg); border-radius: 20px; border: 1px solid var(--glass-border); padding: 24px;">
                    <h3
                        style="color: var(--text-primary); margin-bottom: 24px; display: flex; align-items: center; gap: 10px;">
                        <span>ðŸŒªï¸</span> Acquisition Funnel
                    </h3>
                    <div style="display: flex; flex-direction: column; gap: 24px;">
                        <div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span style="color: var(--text-secondary); font-size: 0.9rem;">Total Searches</span>
                                <span id="funnelSearchCount"
                                    style="color: var(--text-primary); font-weight: 700;">0</span>
                            </div>
                            <div
                                style="height: 12px; background: rgba(255,255,255,0.05); border-radius: 6px; overflow: hidden;">
                                <div id="funnelSearchProgress"
                                    style="width: 100%; height: 100%; background: #60a5fa; transition: width 1s cubic-bezier(0.4, 0, 0.2, 1);">
                                </div>
                            </div>
                        </div>
                        <div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span style="color: var(--text-secondary); font-size: 0.9rem;">VIN Lookups</span>
                                <span id="funnelVinCount" style="color: var(--text-primary); font-weight: 700;">0</span>
                            </div>
                            <div
                                style="height: 12px; background: rgba(255,255,255,0.05); border-radius: 6px; overflow: hidden;">
                                <div id="funnelVinProgress"
                                    style="width: 0%; height: 100%; background: #22d3ee; transition: width 1s cubic-bezier(0.4, 0, 0.2, 1);">
                                </div>
                            </div>
                        </div>
                        <div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span style="color: var(--text-secondary); font-size: 0.9rem;">Affiliate Clicks</span>
                                <span id="funnelClickCount"
                                    style="color: var(--text-primary); font-weight: 700;">0</span>
                            </div>
                            <div
                                style="height: 12px; background: rgba(255,255,255,0.05); border-radius: 6px; overflow: hidden;">
                                <div id="funnelClickProgress"
                                    style="width: 0%; height: 100%; background: #fbbf24; transition: width 1s cubic-bezier(0.4, 0, 0.2, 1);">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- AI Insights -->
                <div
                    style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(5, 150, 105, 0.05)); border-radius: 20px; border: 1px solid rgba(16, 185, 129, 0.2); padding: 24px;">
                    <h3
                        style="color: var(--text-primary); margin-bottom: 16px; display: flex; align-items: center; gap: 10px;">
                        <span>ðŸ§ </span> Business Intelligence
                    </h3>
                    <div id="devAiInsights" style="color: var(--text-secondary); font-size: 0.9rem; line-height: 1.6;">
                        <p>Analyzing platform data for market trends...</p>
                    </div>
                    <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1);">
                        <div style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 8px;">Top Trending
                            Model:</div>
                        <div id="devTrendingModel" style="font-size: 1.1rem; color: #34d399; font-weight: 700;">Finding
                            trends...</div>
                    </div>
                </div>
            </div>

            <!-- Detailed Metrics Grid -->
            <div
                style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 24px; margin-top: 32px;">
                <!-- Top Searches -->
                <div
                    style="background: var(--glass-bg); border-radius: 20px; border: 1px solid var(--glass-border); padding: 24px;">
                    <h3
                        style="color: var(--text-primary); margin-bottom: 20px; font-size: 1rem; display: flex; align-items: center; gap: 8px;">
                        <span>ðŸ”</span> Top Search Terms
                    </h3>
                    <div id="devTopSearches" style="display: flex; flex-direction: column; gap: 10px;">
                        <div style="color: var(--text-muted); text-align: center; padding: 20px;">No searches tracked
                            yet</div>
                    </div>
                </div>

                <!-- VIN Lookups -->
                <div
                    style="background: var(--glass-bg); border-radius: 20px; border: 1px solid var(--glass-border); padding: 24px;">
                    <h3
                        style="color: var(--text-primary); margin-bottom: 20px; font-size: 1rem; display: flex; align-items: center; gap: 8px;">
                        <span>ðŸš—</span> Top VIN Lookups
                    </h3>
                    <div id="devVinLookups" style="display: flex; flex-direction: column; gap: 10px;">
                        <div style="color: var(--text-muted); text-align: center; padding: 20px;">No VIN lookups yet
                        </div>
                    </div>
                </div>

                <!-- Tab Usage -->
                <div
                    style="background: var(--glass-bg); border-radius: 20px; border: 1px solid var(--glass-border); padding: 24px;">
                    <h3
                        style="color: var(--text-primary); margin-bottom: 20px; font-size: 1rem; display: flex; align-items: center; gap: 8px;">
                        <span>ðŸ“Š</span> Tab Engagement
                    </h3>
                    <div id="devTabUsage" style="display: flex; flex-direction: column; gap: 10px;">
                        <div style="color: var(--text-muted); text-align: center; padding: 20px;">No engagement data yet
                        </div>
                    </div>
                </div>
            </div>


            <!-- Users Table -->
            <div style="margin-top: 32px;">
                <h3 style="color: var(--text-primary); margin-bottom: 16px;">ðŸ‘¥ Registered Users</h3>
                <div
                    style="background: var(--glass-bg); border-radius: 16px; border: 1px solid var(--glass-border); overflow: hidden;">
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: rgba(255,255,255,0.03);">
                                    <th
                                        style="padding: 12px 16px; text-align: left; color: var(--text-muted); font-weight: 600; font-size: 0.85rem;">
                                        User</th>
                                    <th
                                        style="padding: 12px 16px; text-align: left; color: var(--text-muted); font-weight: 600; font-size: 0.85rem;">
                                        Email</th>
                                    <th
                                        style="padding: 12px 16px; text-align: center; color: var(--text-muted); font-weight: 600; font-size: 0.85rem;">
                                        Status</th>
                                    <th
                                        style="padding: 12px 16px; text-align: center; color: var(--text-muted); font-weight: 600; font-size: 0.85rem;">
                                        Activities</th>
                                    <th
                                        style="padding: 12px 16px; text-align: left; color: var(--text-muted); font-weight: 600; font-size: 0.85rem;">
                                        Signed Up</th>
                                    <th
                                        style="padding: 12px 16px; text-align: left; color: var(--text-muted); font-weight: 600; font-size: 0.85rem;">
                                        Last Active</th>
                                </tr>
                            </thead>
                            <tbody id="devUsersTable">
                                <tr>
                                    <td colspan="6"
                                        style="padding: 40px; text-align: center; color: var(--text-muted);">Loading
                                        users...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Activity Log with Category Tabs -->
            <div style="margin-top: 32px;">
                <div
                    style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; flex-wrap: wrap; gap: 12px;">
                    <h3 style="color: var(--text-primary); margin: 0;">ðŸ“Š Recent Activity</h3>
                    <div id="activityCategoryTabs" style="display: flex; gap: 6px; flex-wrap: wrap;">
                        <button class="activity-tab active" data-category="all" onclick="setActivityTab('all')"
                            style="background: rgba(96,165,250,0.2); border: 1px solid rgba(96,165,250,0.3); color: #60a5fa; padding: 6px 12px; border-radius: 8px; font-size: 0.75rem; cursor: pointer; font-weight: 600;">
                            All <span id="activityCountAll" style="opacity: 0.7; margin-left: 4px;">0</span>
                        </button>
                        <button class="activity-tab" data-category="job_logging" onclick="setActivityTab('job_logging')"
                            style="background: rgba(251,191,36,0.1); border: 1px solid rgba(251,191,36,0.2); color: #fbbf24; padding: 6px 12px; border-radius: 8px; font-size: 0.75rem; cursor: pointer; font-weight: 600;">
                            ðŸ”§ Jobs <span id="activityCountJobs" style="opacity: 0.7; margin-left: 4px;">0</span>
                        </button>
                        <button class="activity-tab" data-category="search" onclick="setActivityTab('search')"
                            style="background: rgba(34,211,238,0.1); border: 1px solid rgba(34,211,238,0.2); color: #22d3ee; padding: 6px 12px; border-radius: 8px; font-size: 0.75rem; cursor: pointer; font-weight: 600;">
                            ðŸ” Search <span id="activityCountSearch" style="opacity: 0.7; margin-left: 4px;">0</span>
                        </button>
                        <button class="activity-tab" data-category="monetization"
                            onclick="setActivityTab('monetization')"
                            style="background: rgba(74,222,128,0.1); border: 1px solid rgba(74,222,128,0.2); color: #4ade80; padding: 6px 12px; border-radius: 8px; font-size: 0.75rem; cursor: pointer; font-weight: 600;">
                            ðŸ’° Revenue <span id="activityCountRevenue" style="opacity: 0.7; margin-left: 4px;">0</span>
                        </button>
                        <button class="activity-tab" data-category="browsing" onclick="setActivityTab('browsing')"
                            style="background: rgba(168,85,247,0.1); border: 1px solid rgba(168,85,247,0.2); color: #a855f7; padding: 6px 12px; border-radius: 8px; font-size: 0.75rem; cursor: pointer; font-weight: 600;">
                            ðŸ“± Browse <span id="activityCountBrowse" style="opacity: 0.7; margin-left: 4px;">0</span>
                        </button>
                        <button class="activity-tab" data-category="session" onclick="setActivityTab('session')"
                            style="background: rgba(148,163,184,0.1); border: 1px solid rgba(148,163,184,0.2); color: #94a3b8; padding: 6px 12px; border-radius: 8px; font-size: 0.75rem; cursor: pointer; font-weight: 600;">
                            â±ï¸ Sessions <span id="activityCountSession" style="opacity: 0.7; margin-left: 4px;">0</span>
                        </button>
                    </div>
                </div>
                <div id="devActivityLog"
                    style="background: var(--glass-bg); border-radius: 16px; border: 1px solid var(--glass-border); padding: 16px; max-height: 400px; overflow-y: auto;">
                    <div style="text-align: center; padding: 40px; color: var(--text-muted);">Loading activity...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Inventory Tab (only visible when signed in) -->
    <div class="tab-content" id="tabInventory" style="display: none;">
        <div class="container">
            <div class="page-title">
                <h1>ðŸ“¦ My <span>Inventory</span></h1>
            </div>
            <p class="page-subtitle">Track your key fobs and key blanks in stock.</p>

            <div id="inventoryContent" style="margin-top: 24px;">
                <div style="text-align: center; padding: 60px 20px; color: var(--text-muted);">
                    <div style="font-size: 4rem; margin-bottom: 16px;">ðŸ“¦</div>
                    <h3 style="color: var(--text-primary); margin-bottom: 8px;">Your inventory is empty</h3>
                    <p>Browse vehicles and add keys to your inventory to track stock.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Subscriptions Tab (only visible when signed in) -->
    <div class="tab-content" id="tabSubscriptions" style="display: none;">
        <div class="container">
            <div class="page-title">
                <h1>ðŸ“… Subscription <span>Tracker</span></h1>
            </div>
            <p class="page-subtitle">Track your tool subscriptions, licenses, and renewal dates in one place.</p>

            <!-- Alert Banner (populated by JS) -->
            <div id="subAlertBanner" style="display: none;"></div>

            <!-- Quick Stats -->
            <div class="sub-stats-row" id="subStatsRow">
                <div class="sub-stat-card">
                    <div class="sub-stat-number active" id="subActiveCount">0</div>
                    <div class="sub-stat-label">Active</div>
                </div>
                <div class="sub-stat-card">
                    <div class="sub-stat-number warning" id="subWarningCount">0</div>
                    <div class="sub-stat-label">Expiring Soon</div>
                </div>
                <div class="sub-stat-card">
                    <div class="sub-stat-number expired" id="subExpiredCount">0</div>
                    <div class="sub-stat-label">Expired</div>
                </div>
                <div class="sub-stat-card">
                    <div class="sub-stat-number lifetime" id="subLifetimeCount">0</div>
                    <div class="sub-stat-label">Lifetime</div>
                </div>
            </div>

            <!-- Add Subscription Button -->
            <div style="display: flex; gap: 12px; flex-wrap: wrap; align-items: center; margin-bottom: 16px;">
                <button class="sub-add-btn" onclick="openAddSubscriptionModal()">
                    âž• Add Subscription or License
                </button>
                <button class="sub-add-btn" style="background: linear-gradient(135deg, #10b981, #059669);"
                    onclick="manualAIAnalysis()">
                    ðŸ¤– AI Analysis
                </button>
            </div>

            <!-- Category Tabs -->
            <div class="sub-category-tabs" id="subCategoryTabs">
                <button class="sub-category-tab active" onclick="filterSubscriptions('all')">All</button>
                <button class="sub-category-tab" onclick="filterSubscriptions('key_programmer')">Key
                    Programmers</button>
                <button class="sub-category-tab" onclick="filterSubscriptions('diagnostic')">Diagnostics</button>
                <button class="sub-category-tab" onclick="filterSubscriptions('oem_dealer')">OEM Access</button>
                <button class="sub-category-tab" onclick="filterSubscriptions('software')">Software</button>
                <button class="sub-category-tab" onclick="filterSubscriptions('license')">Licenses</button>
                <button class="sub-category-tab" onclick="filterSubscriptions('insurance')">Insurance</button>
            </div>

            <!-- Subscription Cards Grid (populated by JS) -->
            <div class="sub-cards-grid" id="subCardsGrid">
                <!-- Empty state -->
                <div id="subEmptyState"
                    style="grid-column: 1 / -1; text-align: center; padding: 60px 20px; color: var(--text-muted);">
                    <div style="font-size: 4rem; margin-bottom: 16px;">ðŸ“‹</div>
                    <h3 style="color: var(--text-primary); margin-bottom: 8px;">No subscriptions tracked yet</h3>
                    <p>Add your first subscription to start tracking renewal dates and costs.</p>
                </div>
            </div>

            <!-- License Section -->
            <div class="license-section" id="licenseSection">
                <h2 class="license-section-title">ðŸ“œ Licenses & Certifications</h2>
                <div class="sub-cards-grid" id="licenseCardsGrid">
                    <!-- Populated by JS -->
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Subscription Modal -->
    <div class="sub-modal-overlay" id="subModalOverlay" style="display: none;" onclick="closeSubscriptionModal(event)">
        <div class="sub-modal" onclick="event.stopPropagation()">
            <div class="sub-modal-header">
                <h2 class="sub-modal-title" id="subModalTitle">Add Subscription</h2>
                <button class="sub-modal-close" onclick="closeSubscriptionModal()">Ã—</button>
            </div>
            <div class="sub-modal-body">
                <div class="sub-form-group">
                    <label class="sub-form-label">Select from Catalog</label>
                    <select class="sub-form-select" id="subCatalogSelect" onchange="populateFromCatalog()">
                        <option value="">-- Choose a subscription --</option>
                        <optgroup label="Key Programmers">
                            <option value="autel_tcp">Autel TCP Subscription ($895/yr)</option>
                            <option value="lonsdor_update">Lonsdor K518 Update ($200/yr)</option>
                            <option value="xhorse_vvdi">Xhorse VVDI Subscription ($199/yr)</option>
                            <option value="obdstar_update">OBDStar Annual Update ($299/yr)</option>
                            <option value="xtool_x100">Xtool X100 PAD ($199/yr)</option>
                            <option value="advanced_diag">Advanced Diagnostics MVP Pro ($400/yr)</option>
                            <option value="key_tool_max">Xhorse Key Tool Max ($150/yr)</option>
                            <option value="keydiy_kd">KeyDIY KD-X2/KD-MAX ($99/yr)</option>
                        </optgroup>
                        <optgroup label="Diagnostic Tools">
                            <option value="autel_maxisys">Autel MaxiSys Update ($800/yr)</option>
                            <option value="launch_x431">Launch X431 Update ($299/yr)</option>
                            <option value="topdon_phoenix">TOPDON Phoenix Update ($399/yr)</option>
                            <option value="thinkdiag">ThinkDiag Pro ($99/yr)</option>
                            <option value="foxwell_gt90">Foxwell GT90 ($199/yr)</option>
                            <option value="autel_im508">Autel IM508 Update ($395/yr)</option>
                        </optgroup>
                        <optgroup label="OEM Dealer Access">
                            <option value="toyota_techstream">Toyota Techstream ($55/2-day)</option>
                            <option value="honda_hds">Honda HDS ($55/day)</option>
                            <option value="ford_fdrs">Ford FDRS ($40/day)</option>
                            <option value="fca_witech">FCA WiTech 2.0 ($100/day)</option>
                            <option value="gm_gds2">GM GDS2/Tech2Win ($50/day)</option>
                            <option value="nissan_consult">Nissan Consult III+ ($65/day)</option>
                            <option value="bmw_ista">BMW ISTA/D ($100/day)</option>
                            <option value="mb_xentry">Mercedes Xentry ($150/day)</option>
                            <option value="vw_odis">VW/Audi ODIS ($100/day)</option>
                            <option value="subaru_ssmiv">Subaru SSM IV ($65/day)</option>
                        </optgroup>
                        <optgroup label="Access Subscriptions">
                            <option value="nastf">NASTF Registration ($30/yr)</option>
                            <option value="autoauth">AutoAuth Access ($250/yr)</option>
                            <option value="key_comm">KEY-Comm ($150/yr)</option>
                            <option value="autel_immo">Autel MaxiIM Update ($895/yr)</option>
                        </optgroup>
                        <optgroup label="Software">
                            <option value="instacode">Instacode ($199/yr)</option>
                            <option value="keypro">Key-Pro ($249/yr)</option>
                            <option value="truecode">True-Code ($149/yr)</option>
                            <option value="jetlock">Jet Lock Tools ($99/yr)</option>
                            <option value="keyless_api">Keyless Entry API ($120/yr)</option>
                            <option value="lishi_decoder">Lishi Decoder App ($79/yr)</option>
                        </optgroup>
                        <optgroup label="Tokens (Per-Use)">
                            <option value="xhorse_mb_tokens">Xhorse MB Tokens</option>
                            <option value="autel_tokens">Autel Calculation Tokens</option>
                            <option value="lonsdor_jlr">Lonsdor JLR License ($180 one-time)</option>
                            <option value="yanhua_tokens">Yanhua ACDP Tokens</option>
                        </optgroup>
                        <optgroup label="Licenses & Certifications">
                            <option value="locksmith_license">Locksmith License (State)</option>
                            <option value="contractor_bond">Contractor Bond</option>
                            <option value="aloa_cert">ALOA Certification ($250/yr)</option>
                            <option value="cml_cert">CML Certification ($195/yr)</option>
                            <option value="savta_cert">SAVTA Certification ($150/yr)</option>
                        </optgroup>
                        <optgroup label="Insurance">
                            <option value="liability_insurance">General Liability Insurance</option>
                            <option value="eo_insurance">E&O Insurance</option>
                            <option value="auto_insurance">Commercial Auto Insurance</option>
                            <option value="workers_comp">Workers Compensation</option>
                        </optgroup>
                        <optgroup label="Other">
                            <option value="custom">Custom / Other</option>
                        </optgroup>
                    </select>
                </div>

                <div class="sub-form-group">
                    <label class="sub-form-label">Name</label>
                    <input type="text" class="sub-form-input" id="subName" placeholder="e.g., Autel TCP Subscription">
                </div>

                <div class="sub-form-group">
                    <label class="sub-form-label">Vendor</label>
                    <input type="text" class="sub-form-input" id="subVendor" placeholder="e.g., Autel">
                </div>

                <div class="sub-form-row">
                    <div class="sub-form-group">
                        <label class="sub-form-label">Cost</label>
                        <input type="number" class="sub-form-input" id="subCost" placeholder="895" min="0" step="0.01">
                    </div>
                    <div class="sub-form-group">
                        <label class="sub-form-label">Billing Cycle</label>
                        <select class="sub-form-select" id="subBillingCycle">
                            <option value="annual">Annual</option>
                            <option value="monthly">Monthly</option>
                            <option value="per_use">Per Use</option>
                            <option value="2day">2-Day Pass</option>
                            <option value="daily">Daily</option>
                            <option value="lifetime">Lifetime</option>
                        </select>
                    </div>
                </div>

                <div class="sub-form-row">
                    <div class="sub-form-group">
                        <label class="sub-form-label">Purchase Date</label>
                        <input type="date" class="sub-form-input" id="subPurchaseDate">
                    </div>
                    <div class="sub-form-group">
                        <label class="sub-form-label">Expiration Date</label>
                        <input type="date" class="sub-form-input" id="subExpirationDate">
                    </div>
                </div>

                <div class="sub-form-group">
                    <label class="sub-form-label">Category</label>
                    <select class="sub-form-select" id="subCategory">
                        <option value="key_programmer">Key Programmer</option>
                        <option value="diagnostic">Diagnostic Tool</option>
                        <option value="oem_dealer">OEM Dealer Access</option>
                        <option value="access">Access Subscription</option>
                        <option value="software">Software</option>
                        <option value="tokens">Tokens</option>
                        <option value="license">License / Certification</option>
                        <option value="insurance">Insurance</option>
                        <option value="other">Other</option>
                    </select>
                </div>

                <div class="sub-form-group">
                    <label class="sub-form-label">Notes (Optional)</label>
                    <textarea class="sub-form-textarea" id="subNotes" rows="2"
                        placeholder="e.g., Required for Toyota 8A-BA server calculations"></textarea>
                </div>

                <div class="sub-form-group">
                    <label class="sub-form-label">Renewal URL (Optional)</label>
                    <input type="url" class="sub-form-input" id="subRenewalUrl" placeholder="https://...">
                </div>
            </div>
            <div class="sub-modal-footer">
                <button class="sub-btn-cancel" onclick="closeSubscriptionModal()">Cancel</button>
                <button class="sub-btn-save" onclick="saveSubscription()">Save Subscription</button>
            </div>
        </div>
    </div>

    <footer class="footer">
        Â© 2025 Euro Keys<br>
        Professional Automotive Locksmith - Richmond, VA
    </footer>

    <script>
        // Use relative path for production (proxied via _redirects) to solve cookie/CORS issues
        // Fallback to direct worker URL for local development
        const API = (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1')
            ? 'https://euro-keys.jeremy-samuels17.workers.dev'
            : '';
        const API_BASE = API; // Alias for backwards compatibility
        const AFFILIATE_TAG = 'eurokeys-20';

        // Global state for model filtering
        let currentModelsData = [];
        let currentModelFilter = 'all';

        // Valid makes only
        const VALID_MAKES = [
            'Acura', 'Alfa Romeo', 'Aston Martin', 'Audi', 'Bentley', 'BMW', 'Buick',
            'Cadillac', 'Chevrolet', 'Chrysler', 'Dodge', 'Ferrari', 'Fiat', 'Ford',
            'Genesis', 'GMC', 'Gmc', 'Honda', 'Hummer', 'Hyundai', 'Infiniti', 'Jaguar',
            'Jeep', 'Kia', 'Lamborghini', 'Land Rover', 'Lexus', 'Lincoln', 'Maserati',
            'Mazda', 'McLaren', 'Mercedes-Benz', 'Mercedes', 'Mercury', 'Mini',
            'Mitsubishi', 'Nissan', 'Oldsmobile', 'Pontiac', 'Porsche', 'Ram',
            'Rolls-Royce', 'Saab', 'Saturn', 'Scion', 'Subaru', 'Suzuki', 'Tesla',
            'Toyota', 'Volkswagen', 'Volvo'
        ];

        function isValidMake(make) {
            return VALID_MAKES.some(v => v.toLowerCase() === make.toLowerCase());
        }

        // Make logos mapping using logo.dev CDN
        function getMakeLogo(make) {
            const normalizedMake = make.toLowerCase().replace(/[^a-z]/g, '');
            const logoMappings = {
                'acura': 'https://logo.clearbit.com/acura.com',
                'alfaromeo': 'https://logo.clearbit.com/alfaromeo.com',
                'audi': 'https://logo.clearbit.com/audi.com',
                'bmw': 'https://logo.clearbit.com/bmw.com',
                'buick': 'https://logo.clearbit.com/buick.com',
                'cadillac': 'https://logo.clearbit.com/cadillac.com',
                'chevrolet': 'https://logo.clearbit.com/chevrolet.com',
                'chrysler': 'https://logo.clearbit.com/chrysler.com',
                'dodge': 'https://logo.clearbit.com/dodge.com',
                'ford': 'https://logo.clearbit.com/ford.com',
                'genesis': 'https://logo.clearbit.com/genesis.com',
                'gmc': 'https://logo.clearbit.com/gmc.com',
                'honda': 'https://logo.clearbit.com/honda.com',
                'hyundai': 'https://logo.clearbit.com/hyundai.com',
                'infiniti': 'https://logo.clearbit.com/infinitiusa.com',
                'jaguar': 'https://logo.clearbit.com/jaguar.com',
                'jeep': 'https://logo.clearbit.com/jeep.com',
                'kia': 'https://logo.clearbit.com/kia.com',
                'landrover': 'https://logo.clearbit.com/landrover.com',
                'lexus': 'https://logo.clearbit.com/lexus.com',
                'lincoln': 'https://logo.clearbit.com/lincoln.com',
                'mazda': 'https://logo.clearbit.com/mazda.com',
                'mercedesbenz': 'https://logo.clearbit.com/mercedes-benz.com',
                'mercedes': 'https://logo.clearbit.com/mercedes-benz.com',
                'mini': 'https://logo.clearbit.com/mini.com',
                'mitsubishi': 'https://logo.clearbit.com/mitsubishi.com',
                'nissan': 'https://logo.clearbit.com/nissan.com',
                'porsche': 'https://logo.clearbit.com/porsche.com',
                'ram': 'https://logo.clearbit.com/ramtrucks.com',
                'subaru': 'https://logo.clearbit.com/subaru.com',
                'tesla': 'https://logo.clearbit.com/tesla.com',
                'toyota': 'https://logo.clearbit.com/toyota.com',
                'volkswagen': 'https://logo.clearbit.com/volkswagen.com',
                'volvo': 'https://logo.clearbit.com/volvo.com',
            };
            return logoMappings[normalizedMake] || null;
        }

        let asinData = { products_by_fcc: {} };

        async function loadAsinData() {
            try {
                const res = await fetch('asin_based_affiliate_products.json');
                const data = await res.json();
                asinData = data;
            } catch (e) {
                console.error('Failed to load ASIN data local mapping');
            }
        }

        // Helper to group vehicles into chips
        function groupVehicles(vehicles) {
            if (!vehicles) return [];
            const vehicleArray = vehicles.split(',').map(v => v.trim()).filter(v => v);
            const combined = combineVehicleYears(vehicleArray);

            return combined.map(v => {
                const match = v.match(/^(.+?)\s*\((.+?)\)$/);
                if (match) {
                    return { name: match[1].trim(), years: match[2] };
                }
                return { name: v, years: '' };
            });
        }

        // Standardized function to render compact vehicle chips
        function renderVehicleChips(vehicles, fccId, limit = 5) {
            const grouped = groupVehicles(vehicles);
            const displayGroups = grouped.slice(0, limit);
            const moreCount = grouped.length - limit;

            const chipsHtml = displayGroups.map(g => `
                <span class="vehicle-group-chip" onclick="${fccId ? `showFccModal('${fccId}')` : ''}" style="${!fccId ? 'cursor: default;' : ''}">
                    <span class="vehicle-group-make">${g.name}</span>
                    ${g.years ? `<span class="vehicle-group-years">(${g.years})</span>` : ''}
                </span>
            `).join('');

            const moreHtml = moreCount > 0 ? `
                <span class="vehicle-chip vehicle-chip-more" onclick="${fccId ? `showFccModal('${fccId}')` : ''}">
                    +${moreCount} more
                </span>
            ` : '';

            return chipsHtml + moreHtml;
        }

        // Tab switching with URL routing
        // Tab switching with URL routing
        function showTab(tabName, updateHash = true) {
            window.scrollTo(0, 0);
            // Update URL hash for deep linking
            if (updateHash && window.location.hash !== `#${tabName}`) {
                history.pushState(null, '', `#${tabName}`);
            }

            // Update session tracking
            if (typeof sessionData !== 'undefined') {
                sessionData.currentTab = tabName;
            }

            // Log tab view activity
            if (typeof logActivity === 'function') {
                logActivity('view_tab', { tab: tabName });
            }

            // 1. Update Header Buttons (Visual State)
            // Remove active class from all potential buttons
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));

            // Add active class to the correct button
            // Try standard IDs: 'browseTab', 'fccTab' etc. OR 'tabBrowse' (legacy button ID convention)
            const btnId1 = tabName + 'Tab';
            const btnId2 = 'tab' + tabName.charAt(0).toUpperCase() + tabName.slice(1);

            const activeBtn = document.getElementById(btnId1) || document.getElementById(btnId2);
            if (activeBtn) activeBtn.classList.add('active');


            // 2. Update Content Visibility
            // Hide all known content areas
            const contentIds = ['browse', 'tabFcc', 'tabGuides', 'tabInventory', 'tabDev', 'tabSubscriptions'];
            contentIds.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.style.display = 'none';
            });

            // Determine target content ID
            // New Browse tab uses id="browse", others use id="tabName" (e.g. tabFcc)
            let targetId = tabName === 'browse' ? 'browse' : 'tab' + tabName.charAt(0).toUpperCase() + tabName.slice(1);
            const targetContent = document.getElementById(targetId);

            if (targetContent) {
                targetContent.style.display = 'block';
            } else {
                console.warn('showTab: Target content not found:', targetId);
            }

            // 2.5 GLOBAL UI CLEANUP (Fix for bleeding Hero Section/VIN Decoder)
            const hero = document.querySelector('.hero-section');
            const visualSelector = document.getElementById('visualMakeSelector');
            const legacySearch = document.getElementById('legacySearchCard');

            if (tabName === 'browse') {
                const results = document.getElementById('results');
                const vinResults = document.getElementById('vinResults');
                const resultsSection = document.getElementById('resultsSection');

                const showingResults = (results && results.innerHTML.trim() && results.style.display !== 'none') ||
                    (vinResults && vinResults.style.display !== 'none') ||
                    (resultsSection && resultsSection.classList.contains('active'));

                if (hero) hero.style.display = showingResults ? 'none' : 'block';
                if (visualSelector) visualSelector.style.display = showingResults ? 'none' : 'block';
                if (legacySearch) legacySearch.style.display = 'none'; // Always hide legacy on first search
            } else {
                // Hide ALL browse-specific components when on other tabs
                if (hero) hero.style.display = 'none';
                if (visualSelector) visualSelector.style.display = 'none';
                if (legacySearch) legacySearch.style.display = 'none';
                const vinResults = document.getElementById('vinResults');
                if (vinResults) vinResults.style.display = 'none';
                const rs = document.getElementById('resultsSection');
                if (rs) rs.classList.remove('active');
            }

            // 3. Clear stale state from other tabs
            // When leaving FCC tab, reset search state to prevent stale results
            if (tabName !== 'fcc') {
                const fccSearch = document.getElementById('fccSearch');
                if (fccSearch && fccSearch.value) {
                    fccSearch.value = '';
                    // Re-render table to clear filtered results (will use empty search on next visit)
                }
            }

            // 4. Tab-Specific Initialization
            if (tabName === 'browse') {
                if (typeof renderMakeGrid === 'function') {
                    renderMakeGrid();
                }

                // Legacy: populate years if needed for fallback
                if (typeof populateYears === 'function') populateYears();

            } else if (tabName === 'fcc') {
                if (typeof fccDataLoaded !== 'undefined' && !fccDataLoaded && typeof loadFccData === 'function') {
                    loadFccData();
                }
                if (typeof renderKeyCoverageMap === 'function') {
                    renderKeyCoverageMap();
                }
            } else if (tabName === 'dev') {
                if (typeof loadDevPanel === 'function') {
                    loadDevPanel();
                }
            } else if (tabName === 'guides') {
                // Load guides when tab is shown
                if (typeof loadGuidesTab === 'function') {
                    loadGuidesTab();
                }
            } else if (tabName === 'inventory') {
                // Render inventory when tab is shown
                if (typeof renderInventoryPage === 'function') {
                    renderInventoryPage();
                }
            }

            // Scroll to top
            window.scrollTo(0, 0);
        }

        // Handle URL hash changes (back/forward buttons)
        window.addEventListener('hashchange', function () {
            const hash = window.location.hash.slice(1) || 'browse';
            const validTabs = ['browse', 'database', 'fcc', 'guides', 'inventory', 'dev', 'subscriptions'];
            const tabName = hash === 'database' || hash === 'vin' ? 'browse' : hash;
            if (validTabs.includes(tabName)) {
                showTab(tabName, false);
                if (hash === 'vin') {
                    const omni = document.getElementById('omniSearch');
                    if (omni) {
                        omni.focus();
                        omni.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }
            }
        });

        // Handle initial URL hash on page load
        function handleInitialRoute() {
            const hash = window.location.hash.slice(1);

            // Handle vehicle deep links: #vehicle/Make/Model/Year
            if (hash.startsWith('vehicle/')) {
                const parts = hash.split('/');
                if (parts.length >= 4) {
                    const make = decodeURIComponent(parts[1]);
                    const model = decodeURIComponent(parts[2]);
                    const year = parts[3];
                    console.log(`ðŸ“ Deep link: ${year} ${make} ${model}`);

                    // Wait for page to be ready, then load the vehicle
                    setTimeout(() => {
                        loadVehicleFromDeepLink(make, model, year);
                    }, 500);
                    return;
                }
            }

            const validTabs = ['browse', 'database', 'fcc', 'guides', 'vin', 'inventory', 'dev'];
            if (hash === 'database') {
                showTab('browse', false);
            } else if (validTabs.includes(hash)) {
                showTab(hash, false);
            }
        }

        // Load vehicle from deep link URL
        async function loadVehicleFromDeepLink(make, model, year) {
            // Switch to browse tab
            showTab('browse', false);

            // Hide the make grid, show results section
            const browseSection = document.getElementById('legacySearchCard');
            if (browseSection) browseSection.style.display = 'none';
            const resultsSection = document.getElementById('resultsSection');
            if (resultsSection) resultsSection.classList.add('active');

            // Update title and year navigation
            currentVehicleYear = parseInt(year);
            currentVehicleMake = make;
            currentVehicleModel = model;

            document.getElementById('resultTitle').textContent = `${make} ${model}`;
            updateYearNavigation(parseInt(year));
            document.getElementById('resultsContainer').innerHTML = '<div class="loading">Loading...</div>';

            initQuickSearch();
            await ensureGuidesLoaded();

            try {
                const res = await fetch(`${API}/api/browse?year=${year}&make=${encodeURIComponent(make)}&model=${encodeURIComponent(model)}&limit=10`);
                const data = await res.json();

                if (data.rows && data.rows.length > 0) {
                    displayResults(data.rows, year, make, model, { alerts: data.alerts, guide: data.guide });
                    // Scroll to the vehicle card after a brief delay for rendering
                    setTimeout(() => {
                        const resultsSection = document.getElementById('resultsSection');
                        if (resultsSection) {
                            resultsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        }
                    }, 100);
                } else {
                    document.getElementById('resultsContainer').innerHTML = '<div class="loading">No results found for this vehicle</div>';
                }
            } catch (e) {
                console.error('Deep link load failed:', e);
                document.getElementById('resultsContainer').innerHTML = '<div class="loading">Failed to load vehicle data</div>';
            }
        }

        // Update URL when vehicle is displayed
        function setVehicleUrl(make, model, year) {
            const newHash = `#vehicle/${encodeURIComponent(make)}/${encodeURIComponent(model)}/${year}`;
            history.replaceState(null, '', newHash);
        }

        // Listen for hash changes
        window.addEventListener('hashchange', handleInitialRoute);

        // ================== HEADER QUICK SEARCH ==================

        function toggleHeaderSearch() {
            const searchBox = document.getElementById('headerSearchBox');
            const isVisible = searchBox.style.display !== 'none';
            searchBox.style.display = isVisible ? 'none' : 'flex';
            if (!isVisible) {
                document.getElementById('headerSearchInput').focus();
            }
        }

        function headerQuickSearch() {
            const query = document.getElementById('headerSearchInput').value.trim();
            if (!query) return;

            toggleHeaderSearch(); // Close the search box

            // Try to parse vehicle query (e.g., "2018 Camaro", "Chevy Camaro 2018", "Honda Accord")
            const vehicleInfo = parseVehicleQuery(query);

            if (vehicleInfo.make || vehicleInfo.model) {
                // Switch to Browse tab and search for vehicle
                showTab('browse');
                searchVehicleFromQuery(vehicleInfo, query);
            } else {
                // Fallback to FCC search for part numbers, FCC IDs, etc
                showTab('fcc');
                document.getElementById('fccSearch').value = query;
                if (fccDataLoaded) {
                    renderFccTable();
                } else {
                    loadFccData();
                }
            }
        }

        // Parse natural language vehicle queries
        function parseVehicleQuery(query) {
            const words = query.toLowerCase().split(/\s+/);
            let year = null;
            let make = null;
            let model = null;

            // Common make aliases
            const makeAliases = {
                'chevy': 'Chevrolet',
                'vw': 'Volkswagen',
                'mercedes': 'Mercedes-Benz',
                'merc': 'Mercedes-Benz',
                'beemer': 'BMW',
                'bimmer': 'BMW'
            };

            // Find year (4-digit number between 1990-2030)
            for (const word of words) {
                const num = parseInt(word);
                if (num >= 1990 && num <= 2030) {
                    year = num;
                    break;
                }
            }

            // Find make - check against known makes
            const knownMakes = ['acura', 'audi', 'bmw', 'buick', 'cadillac', 'chevrolet', 'chevy',
                'chrysler', 'dodge', 'fiat', 'ford', 'genesis', 'gmc', 'honda', 'hyundai',
                'infiniti', 'jaguar', 'jeep', 'kia', 'land rover', 'lexus', 'lincoln',
                'maserati', 'mazda', 'mercedes', 'merc', 'mini', 'mitsubishi', 'nissan',
                'porsche', 'ram', 'subaru', 'tesla', 'toyota', 'volkswagen', 'vw', 'volvo'];

            for (const word of words) {
                if (knownMakes.includes(word)) {
                    make = makeAliases[word] || (word.charAt(0).toUpperCase() + word.slice(1));
                    break;
                }
            }

            // Model is remaining non-year, non-make words
            const remainingWords = words.filter(w => {
                if (parseInt(w) >= 1990 && parseInt(w) <= 2030) return false;
                if (knownMakes.includes(w)) return false;
                return true;
            });

            if (remainingWords.length > 0) {
                // Capitalize first letter of each word
                model = remainingWords.map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
            }

            return { year, make, model };
        }

        // Search for vehicle in Browse tab
        async function searchVehicleFromQuery(vehicleInfo, originalQuery) {
            // Hide the make grid, show results section
            const browseSection = document.getElementById('legacySearchCard');
            if (browseSection) browseSection.style.display = 'none';
            const resultsSection = document.getElementById('resultsSection');
            if (resultsSection) resultsSection.classList.add('active');

            // Set display
            const year = vehicleInfo.year || 2020;
            const displayTitle = vehicleInfo.make
                ? `${vehicleInfo.make} ${vehicleInfo.model || ''}`.trim()
                : originalQuery;

            document.getElementById('resultTitle').textContent = displayTitle;
            updateYearNavigation(year);
            document.getElementById('resultsContainer').innerHTML = '<div class="loading">Searching...</div>';

            currentVehicleYear = year;
            currentVehicleMake = vehicleInfo.make || '';
            currentVehicleModel = vehicleInfo.model || '';

            initQuickSearch();
            await ensureGuidesLoaded();

            try {
                // Build query with available info
                let url = `${API}/api/browse?year=${year}&limit=20`;
                if (vehicleInfo.make) url += `&make=${encodeURIComponent(vehicleInfo.make)}`;
                if (vehicleInfo.model) url += `&model=${encodeURIComponent(vehicleInfo.model)}`;

                const res = await fetch(url);
                const data = await res.json();

                if (data.rows && data.rows.length > 0) {
                    displayResults(data.rows, year, vehicleInfo.make || '', vehicleInfo.model || '');
                } else {
                    // No results - try without year restriction
                    const fallbackUrl = `${API}/api/browse?limit=20` +
                        (vehicleInfo.make ? `&make=${encodeURIComponent(vehicleInfo.make)}` : '') +
                        (vehicleInfo.model ? `&model=${encodeURIComponent(vehicleInfo.model)}` : '');

                    const fallbackRes = await fetch(fallbackUrl);
                    const fallbackData = await fallbackRes.json();

                    if (fallbackData.rows && fallbackData.rows.length > 0) {
                        displayResults(fallbackData.rows, year, vehicleInfo.make || '', vehicleInfo.model || '');
                    } else {
                        document.getElementById('resultsContainer').innerHTML =
                            `<div class="loading">No results for "${originalQuery}". Try a different search.</div>`;
                    }
                }
            } catch (e) {
                console.error('Search failed:', e);
                document.getElementById('resultsContainer').innerHTML = '<div class="loading">Search failed</div>';
            }
        }

        // Close header search when clicking outside
        document.addEventListener('click', function (e) {
            const container = document.querySelector('.header-search-container');
            const searchBox = document.getElementById('headerSearchBox');
            if (container && searchBox && !container.contains(e.target) && searchBox.style.display !== 'none') {
                searchBox.style.display = 'none';
            }
        });

        // ================== WALKTHROUGH GUIDES ==================

        // Cache for loaded guides
        const guideCache = {};
        let STRUCTURED_GUIDES = {};

        // Load structured guides from local JSON
        async function initStructuredGuides() {
            try {
                const res = await fetch('/structured_guides.json');
                if (res.ok) {
                    STRUCTURED_GUIDES = await res.json();
                    console.log('Loaded structured guides:', Object.keys(STRUCTURED_GUIDES));
                }
            } catch (e) {
                console.warn('Failed to load local structured guides:', e);
            }
        }
        initStructuredGuides();

        async function toggleGuide(make, model, idx) {
            const containerId = `guide-${idx}`;
            const container = document.getElementById(containerId);

            if (!container) return;

            // Toggle off if already expanded
            if (container.classList.contains('expanded')) {
                container.classList.remove('expanded');
                return;
            }

            // Soft paywall for anonymous users after free views
            if (!PremiumUsage.canViewGuide()) {
                const remaining = PremiumUsage.getRemainingFreeViews();
                openSignUpPaywall('guide', make + ' ' + model);
                return;
            }

            // Track guide view for anonymous users
            if (!currentUser) {
                const viewCount = PremiumUsage.trackGuideView();
                const remaining = PremiumUsage.getRemainingFreeViews();
                if (remaining > 0 && remaining <= 2) {
                    // Show subtle hint about remaining free views
                    console.log(`ðŸ“– ${remaining} free guide view${remaining !== 1 ? 's' : ''} remaining. Sign up for unlimited access.`);
                }
            }

            // Check if we have a local structured guide first for this make/model
            const searchKey = (make + ' ' + model).toLowerCase();
            const localMatch = Object.keys(STRUCTURED_GUIDES).find(k => k.toLowerCase().includes(searchKey) || searchKey.includes(k.toLowerCase()));

            if (localMatch) {
                console.log('Found local structured guide mapping:', localMatch);
                const html = renderBookGuide(localMatch, STRUCTURED_GUIDES[localMatch]);
                container.innerHTML = html;
                container.classList.add('expanded');
                return;
            }

            // Check cache next
            const cacheKey = `${make.toLowerCase()}-${model.toLowerCase()}`;
            if (guideCache[cacheKey]) {
                container.innerHTML = guideCache[cacheKey];
                container.classList.add('expanded');
                return;
            }

            // Fetch guide from API
            container.innerHTML = '<div class="loading">Loading programming guide...</div>';
            container.classList.add('expanded');

            try {
                // Determine category based on context (default to AKL_PROCEDURE for now)
                const guideUrl = `${API}/api/guides?make=${encodeURIComponent(make)}&model=${encodeURIComponent(model)}&category=AKL_PROCEDURE`;
                console.log('Fetching guide:', guideUrl);
                const res = await fetch(guideUrl);
                const data = await res.json();
                console.log('Guide API response:', data);

                if (data.rows && data.rows.length > 0) {
                    console.log('Found guide, rendering content...');
                    const guide = data.rows[0];

                    let html = '';
                    let isStructured = false;

                    try {
                        // Check if content is JSON (structured book format)
                        if (guide.content && guide.content.trim().startsWith('{')) {
                            const structuredData = JSON.parse(guide.content);
                            html = renderBookGuide(guide.title || (make + ' ' + model), structuredData);
                            isStructured = true;
                        }
                    } catch (e) {
                        console.warn('Failed to parse structured guide JSON, falling back to markdown', e);
                    }

                    if (!isStructured) {
                        const contentHtml = renderGuideContent(guide.content);

                        let assetsHtml = '';
                        if (guide.assets) {
                            if (guide.assets.infographic) {
                                const infographicUrl = guide.assets.infographic.startsWith('/')
                                    ? guide.assets.infographic
                                    : `/api/assets/${guide.assets.infographic}`;
                                assetsHtml += `
                                    <div class="guide-asset-block">
                                        <img src="${infographicUrl}" alt="${guide.make} Infographic" class="guide-infographic" loading="lazy" onerror="this.style.display='none'">
                                    </div>
                                `;
                            }
                            if (guide.assets.pdf) {
                                const pdfUrl = guide.assets.pdf.startsWith('/')
                                    ? guide.assets.pdf
                                    : `/api/assets/${guide.assets.pdf}`;
                                assetsHtml += `
                                    <div class="guide-asset-link">
                                        <a href="${pdfUrl}" target="_blank" class="pdf-download-btn">
                                            ðŸ“„ Download ${guide.assets.pdf_title || 'Technical Guide'} (PDF)
                                        </a>
                                    </div>
                                `;
                            }
                        }


                        // ===== RESEARCH INTEL BANNERS =====
                        // Auto-inject warnings from vehicles table enrichment
                        let intelBannersHtml = '';

                        if (guide.vin_ordered === 1) {
                            intelBannersHtml += `
                                <div class="guide-intel-banner vin-ordered">
                                    <span class="banner-icon">ðŸ”’</span>
                                    <div class="banner-content">
                                        <strong>VIN-Ordered Keys Required</strong>
                                        <p>This vehicle requires pre-coded keys ordered by VIN from the dealer. Aftermarket blanks will NOT work without pre-coding.</p>
                                    </div>
                                </div>
                            `;
                        }

                        if (guide.dealer_tool_only) {
                            intelBannersHtml += `
                                <div class="guide-intel-banner dealer-tool">
                                    <span class="banner-icon">ðŸ”§</span>
                                    <div class="banner-content">
                                        <strong>${guide.dealer_tool_only} Required</strong>
                                        <p>This vehicle requires dealer diagnostic software for key programming. Standard aftermarket tools may not work.</p>
                                    </div>
                                </div>
                            `;
                        }

                        if (guide.rf_system) {
                            const rfClass = guide.rf_system.toLowerCase().includes('giobert') || guide.rf_system.toLowerCase().includes('alfa') ? 'european' : 'continental';
                            intelBannersHtml += `
                                <div class="guide-intel-banner rf-system ${rfClass}">
                                    <span class="banner-icon">${rfClass === 'european' ? 'ðŸ‡®ðŸ‡¹' : 'ðŸ‡ºðŸ‡¸'}</span>
                                    <div class="banner-content">
                                        <strong>RF System: ${guide.rf_system}</strong>
                                        ${rfClass === 'european' ? '<p>Italian-built vehicle uses European RF architecture. Pre-coding required before OBDII programming.</p>' : '<p>NAFTA-built vehicle uses Continental RF system. Standard OBDII programming procedure.</p>'}
                                    </div>
                                </div>
                            `;
                        }

                        if (guide.vehicle_warnings) {
                            intelBannersHtml += `
                                <div class="guide-intel-banner warning">
                                    <span class="banner-icon">âš ï¸</span>
                                    <div class="banner-content">
                                        <strong>Service Note</strong>
                                        <p>${guide.vehicle_warnings}</p>
                                    </div>
                                </div>
                            `;
                        }

                        // Add quick tech specs if available
                        let techSpecsHtml = '';
                        if (guide.fcc_id || guide.chip || guide.programming_method) {
                            techSpecsHtml = `
                                <div class="guide-tech-specs">
                                    ${guide.fcc_id ? `<span class="tech-spec"><strong>FCC:</strong> ${guide.fcc_id}</span>` : ''}
                                    ${guide.chip ? `<span class="tech-spec"><strong>Chip:</strong> ${guide.chip}</span>` : ''}
                                    ${guide.oem_part_number ? `<span class="tech-spec"><strong>OEM Part:</strong> ${guide.oem_part_number}</span>` : ''}
                                </div>
                            `;
                        }

                        // NEW: Render dynamic guide images from guide_assets table
                        let guideImagesHtml = '';
                        if (guide.guide_images && guide.guide_images.length > 0) {
                            const imageCards = guide.guide_images.map((img, imgIdx) => `
                                <div class="guide-image-card" onclick="openGuideImageModal('${img.asset_url}', '${(img.caption || '').replace(/'/g, "\\'")}')">
                                    <img src="${img.asset_url}" alt="${img.caption || 'Technical Diagram'}" loading="lazy" onerror="this.parentElement.style.display='none'">
                                    <span class="guide-image-caption">${img.caption || 'Technical Diagram'}</span>
                                </div>
                            `).join('');

                            guideImagesHtml = `
                                <div class="guide-images-section">
                                    <h4>ðŸ“Š Technical Diagrams & Research</h4>
                                    <div class="guide-images-carousel">
                                        ${imageCards}
                                    </div>
                                </div>
                            `;
                        }

                        html = `
                            <div class="programming-guide-header">
                                <h3>${guide.title || (make + ' ' + model)}</h3>
                                <button onclick="this.closest('.expanded').classList.remove('expanded')" style="background:none; border:none; color:var(--text-muted); cursor:pointer;">âœ• Close</button>
                            </div>
                            ${intelBannersHtml}
                            ${techSpecsHtml}
                            ${assetsHtml}
                            ${guideImagesHtml}
                            <div class="programming-guide-body">
                                ${contentHtml}
                            </div>
                        `;
                    }

                    guideCache[cacheKey] = html;
                    container.innerHTML = html;
                } else {
                    console.log('No guide found in response');
                    container.innerHTML = '<div style="color: var(--text-muted); text-align: center; padding: 20px;">ðŸ“š No detailed programming guide available yet for this vehicle.</div>';
                }
            } catch (e) {
                console.error('Failed to load guide:', e);
                container.innerHTML = '<div style="color: #f87171; text-align: center;">Failed to load programming guide. Please try again.</div>';
            }
        }

        function renderGuideContent(markdown) {
            if (!markdown) return '';

            let html = markdown;

            // Process tables (simple conversion)
            html = html.replace(/\|(.+)\|\n\|[-:| ]+\|\n((?:\|.+\|\n?)+)/g, (match, header, body) => {
                const headerCells = header.split('|').filter(c => c.trim()).map(c => `<th>${c.trim()}</th>`).join('');
                const rows = body.trim().split('\n').map(row => {
                    const cells = row.split('|').filter(c => c.trim()).map(c => `<td>${c.trim()}</td>`).join('');
                    return `<tr>${cells}</tr>`;
                }).join('');
                return `<div class="table-container"><table><thead><tr>${headerCells}</tr></thead><tbody>${rows}</tbody></table></div>`;
            });

            // Alerts / Callouts (Custom Syntax Support)
            // Support > [!TIP] etc
            html = html.replace(/^> \[!TIP\] (.*)$/gm, '<blockquote class="alert-tip"><strong>ðŸ’¡ Tip:</strong> $1</blockquote>');
            html = html.replace(/^> \[!WARNING\] (.*)$/gm, '<blockquote class="alert-warning"><strong>âš ï¸ Warning:</strong> $1</blockquote>');
            html = html.replace(/^> \[!IMPORTANT\] (.*)$/gm, '<blockquote class="alert-important"><strong>ðŸš¨ Important:</strong> $1</blockquote>');
            html = html.replace(/^> ðŸ’¡ (.*)$/gm, '<blockquote class="alert-tip"><strong>ðŸ’¡ Tip:</strong> $1</blockquote>');
            html = html.replace(/^> âš ï¸ (.*)$/gm, '<blockquote class="alert-warning"><strong>âš ï¸ Warning:</strong> $1</blockquote>');
            html = html.replace(/^> ðŸš¨ (.*)$/gm, '<blockquote class="alert-important"><strong>ðŸš¨ Important:</strong> $1</blockquote>');

            // Headers
            html = html.replace(/^### (.*)$/gm, '<h4>$1</h4>');
            html = html.replace(/^## (.*)$/gm, '<h3>$1</h3>');
            html = html.replace(/^# (.*)$/gm, '<h2>$1</h2>');

            // Bold & Italic
            html = html.replace(/\*\*\*(.+?)\*\*\*/g, '<strong><em>$1</em></strong>');
            html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
            html = html.replace(/\*(.+?)\*/g, '<em>$1</em>');

            // Blockquotes (standard fallback)
            html = html.replace(/^> (.*)$/gm, '<blockquote>$1</blockquote>');

            // Horizontal rules
            html = html.replace(/^---$/gm, '<hr>');

            // Lists (Improved)
            html = html.replace(/^(\d+\.|-)\s+(.*)$/gm, (match, prefix, content) => {
                const type = prefix.includes('.') ? 'ol' : 'ul';
                return `<li data-type="${type}">${content}</li>`;
            });

            // Wrap contiguous <li> in <ul> or <ol>
            html = html.replace(/(?:<li data-type="(ul|ol)">.*?<\/li>\s*)+/g, (match, type) => {
                const tag = type === 'ol' ? 'ol' : 'ul';
                const items = match.replace(/ data-type="(ul|ol)"/g, '');
                return `<${tag}>${items}</${tag}>`;
            });

            // Line breaks
            // Preserve paragraphs but avoid double-spacing block elements
            html = html.replace(/\n\n/g, '</p><p>');
            html = html.replace(/\n/g, ' ');

            // R2 Asset Support (r2://bucket-path -> /api/assets/bucket-path)
            html = html.replace(/src="r2:\/\/([^"]+)"/g, 'src="/api/assets/$1"');
            html = html.replace(/href="r2:\/\/([^"]+)"/g, 'href="/api/assets/$1"');

            return html;
        }

        function renderBookGuide(vehicleName, data) {
            const sections = [
                { id: 'overview', title: 'ðŸ“– Overview' },
                { id: 'preparation', title: 'ðŸ› ï¸ Preparation' },
                { id: 'procedure', title: 'ðŸ”¢ Procedure' },
                { id: 'notes', title: 'ðŸ’¡ Notes' }
            ];

            const tabsHtml = sections.map((s, i) => `
                <div class="book-tab ${i === 0 ? 'active' : ''}" onclick="switchBookTab(this, '${s.id}')">
                    ${s.title}
                </div>
            `).join('');

            const contentHtml = sections.map((s, i) => `
                <div id="book-section-${s.id}" class="book-section ${i === 0 ? 'active' : ''}">
                    <div class="book-chapter-title">${s.title}</div>
                    <div class="programming-guide-body">
                        ${renderGuideContent(data[s.id] || 'Information coming soon.')}
                    </div>
                </div>
            `).join('');

            return `
                <div class="programming-guide-header">
                    <h3>${vehicleName}</h3>
                    <button onclick="this.closest('.walkthrough-content').classList.remove('expanded')" style="background:none; border:none; color:var(--text-muted); cursor:pointer;">âœ• Close</button>
                </div>
                <div class="book-guide-container">
                    <div class="book-guide-tabs">
                        ${tabsHtml}
                    </div>
                    ${contentHtml}
                </div>
            `;
        }

        function switchBookTab(el, sectionId) {
            const container = el.closest('.book-guide-container');
            container.querySelectorAll('.book-tab').forEach(t => t.classList.remove('active'));
            container.querySelectorAll('.book-section').forEach(s => s.classList.remove('active'));

            el.classList.add('active');
            container.querySelector(`#book-section-${sectionId}`).classList.add('active');
        }



        // ================== BROWSE DATABASE ==================

        // ================== BROWSE DATABASE (Redesign) ==================

        const POPULAR_MAKES = [
            'Acura', 'Audi', 'BMW', 'Buick', 'Cadillac', 'Chevrolet', 'Chrysler', 'Dodge',
            'Fiat', 'Ford', 'GMC', 'Honda', 'Hyundai', 'Infiniti', 'Jaguar', 'Jeep',
            'Kia', 'Land Rover', 'Lexus', 'Lincoln', 'Mazda', 'Mercedes-Benz', 'Mini',
            'Mitsubishi', 'Nissan', 'Porsche', 'Ram', 'Subaru', 'Toyota', 'Volkswagen', 'Volvo'
        ];

        // Map makes to domain names for Clearbit Logo API
        const MAKE_DOMAINS = {
            'Acura': 'acura.com', 'Audi': 'audi.com', 'BMW': 'bmw.com', 'Buick': 'buick.com',
            'Cadillac': 'cadillac.com', 'Chevrolet': 'chevrolet.com', 'Chrysler': 'chrysler.com',
            'Dodge': 'dodge.com', 'Fiat': 'fiat.com', 'Ford': 'ford.com', 'GMC': 'gmc.com',
            'Honda': 'honda.com', 'Hyundai': 'hyundai.com', 'Infiniti': 'infiniti.com',
            'Jaguar': 'jaguar.com', 'Jeep': 'jeep.com', 'Kia': 'kia.com',
            'Land Rover': 'landrover.com', 'Lexus': 'lexus.com', 'Lincoln': 'lincoln.com',
            'Mazda': 'mazdausa.com', 'Mercedes-Benz': 'mbusa.com', 'Mini': 'miniusa.com',
            'Mitsubishi': 'mitsubishicars.com', 'Nissan': 'nissanusa.com', 'Porsche': 'porsche.com',
            'Ram': 'ramtrucks.com', 'Subaru': 'subaru.com', 'Toyota': 'toyota.com',
            'Volkswagen': 'vw.com', 'Volvo': 'volvocars.com'
        };

        // Pre-defined Brand Colors for nicer text avatars
        const BRAND_COLORS = {
            'Acura': '#E82C2A', 'Audi': '#BB0A30', 'BMW': '#0066B1', 'Buick': '#FF6600',
            'Cadillac': '#A63328', 'Chevrolet': '#CD9834', 'Chrysler': '#003DA5', 'Dodge': '#D61F26',
            'Fiat': '#8E0C3A', 'Ford': '#003478', 'GMC': '#D71920', 'Honda': '#D80027',
            'Hyundai': '#002C5F', 'Infiniti': '#000000', 'Jaguar': '#005A31', 'Jeep': '#FFBA00',
            'Kia': '#BB162B', 'Land Rover': '#005A2C', 'Lexus': '#5A5A5A', 'Lincoln': '#003058',
            'Mazda': '#101010', 'Mercedes-Benz': '#000000', 'Mini': '#000000', 'Mitsubishi': '#E60012',
            'Nissan': '#C3002F', 'Porsche': '#B12B28', 'Ram': '#111111', 'Subaru': '#0047BB',
            'Toyota': '#EB0A1E', 'Volkswagen': '#001E50', 'Volvo': '#003057'
        };

        function renderMakeGrid() {
            const grid = document.getElementById('makeGrid');
            if (!grid) return; // Element was removed
            if (grid.children.length > 0) return; // Already rendered

            grid.innerHTML = POPULAR_MAKES.map(make => {
                const domain = MAKE_DOMAINS[make] || `${make.toLowerCase().replace(/\s/g, '')}.com`;
                const logoUrl = `https://cdn.brandfetch.io/${domain}/w/128/h/128`; // Brandfetch CDN
                const initials = make.substring(0, 2).toUpperCase();
                const brandColor = BRAND_COLORS[make] || 'var(--brand-primary)';

                return `
                    <div class="make-card" onclick="selectVisualMake('${make}')">
                        <img src="${logoUrl}" alt="${make}" class="make-logo" 
                             style="background: white; padding: 4px; border-radius: 50%; object-fit: contain;"
                             onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                        <div class="text-avatar" style="display: none; background: ${brandColor}; color: white; border: 2px solid rgba(255,255,255,0.2);">${initials}</div>
                        <span class="make-name">${make}</span>
                    </div>
                `;
            }).join('');
        }

        async function selectVisualMake(make) {
            // Hide landing, show selection card
            const hero = document.querySelector('.hero-section');
            const visualSelector = document.getElementById('visualMakeSelector');
            const legacyCard = document.getElementById('legacySearchCard');

            if (hero) hero.style.display = 'none';
            if (visualSelector) visualSelector.style.display = 'none';
            if (legacyCard) legacyCard.style.display = 'block';

            // Set Selected Make UI
            document.getElementById('selectedVehicleDisplay').style.display = 'block';
            document.getElementById('selectedMakeName').textContent = make;

            // Handle Logo & Fallback for Header
            const domain = MAKE_DOMAINS[make] || `${make.toLowerCase().replace(/\s/g, '')}.com`;
            const logoImg = document.getElementById('selectedMakeLogo');
            const logoAvatar = document.getElementById('selectedMakeAvatar');
            const brandColor = BRAND_COLORS[make] || 'var(--brand-primary)';

            logoImg.style.display = 'block';

            logoAvatar.style.display = 'none';
            logoAvatar.style.background = brandColor;
            logoAvatar.style.color = 'white';
            logoAvatar.style.border = '2px solid rgba(255,255,255,0.2)';

            logoImg.style.background = 'white'; // Ensure contrast
            logoImg.style.borderRadius = '50%';
            logoImg.style.padding = '4px';

            logoImg.src = `https://cdn.brandfetch.io/${domain}/w/128/h/128`;
            logoImg.onerror = function () {
                this.style.display = 'none';
                logoAvatar.style.display = 'flex';
                logoAvatar.textContent = make.substring(0, 2).toUpperCase();
            };

            // Set legacy select value
            const mkSelect = document.getElementById('makeSelect');
            if (![...mkSelect.options].some(o => o.value === make)) {
                mkSelect.innerHTML += `<option value="${make}">${make}</option>`;
            }
            mkSelect.value = make;

            // Reset Drill Down State
            document.getElementById('yearChipsContainer').style.display = 'block';
            document.getElementById('modelChipsContainer').style.display = 'none';
            document.getElementById('selectedYearBadge').style.display = 'none';

            // Render Year Chips
            const yearContainer = document.getElementById('yearChips');
            const currentYear = new Date().getFullYear() + 1;
            let html = '';
            for (let y = currentYear; y >= 2000; y--) {
                html += `<button class="inventory-btn" style="padding: 10px 20px; font-weight: 600;" onclick="selectVisualYear('${y}')">${y}</button>`;
            }
            yearContainer.innerHTML = html;
        }

        function selectVisualYear(year) {
            // Force Update legacy select
            const yrSelect = document.getElementById('yearSelect');
            // Ensure option exists (Fix for broken model loading)
            if (![...yrSelect.options].some(o => o.value == year)) {
                yrSelect.innerHTML += `<option value="${year}">${year}</option>`;
            }
            yrSelect.value = year;

            // UI Updates
            document.getElementById('yearChipsContainer').style.display = 'none';
            const badge = document.getElementById('selectedYearBadge');
            badge.textContent = year;
            badge.style.display = 'block';

            // Load Models Visually
            console.log("Visual Year Selected:", year, "Triggering loadModels...");
            loadModels();
        }

        function selectVisualModel(model) {
            // Update legacy select (create option if needed)
            const modelSelect = document.getElementById('modelSelect');
            if (![...modelSelect.options].some(o => o.value === model)) {
                modelSelect.innerHTML += `<option value="${model}">${model}</option>`;
            }
            modelSelect.value = model;
            modelSelect.disabled = false;

            // Trigger Search
            searchVehicle();
        }

        function resetBrowse() {
            document.querySelector('.hero-section').style.display = 'block';
            document.getElementById('visualMakeSelector').style.display = 'block';
            document.getElementById('legacySearchCard').style.display = 'none';
            document.getElementById('results').innerHTML = '';

            // Also hide and clear results
            const resultsSection = document.getElementById('resultsSection');
            if (resultsSection) {
                resultsSection.classList.remove('active');
            }
            const resultsContainer = document.getElementById('resultsContainer');
            if (resultsContainer) {
                resultsContainer.innerHTML = '';
            }

            // Hide quick dropdown if visible
            const quickDropdown = document.getElementById('quickMakeDropdown');
            if (quickDropdown) quickDropdown.style.display = 'none';

            // Reset selects
            document.getElementById('yearSelect').value = '';
            document.getElementById('makeSelect').value = '';
            document.getElementById('modelSelect').innerHTML = '<option value="">Select Model</option>';
            document.getElementById('modelSelect').disabled = true;
        }

        function showMakeDropdown() {
            const dropdown = document.getElementById('quickMakeDropdown');
            if (dropdown.style.display === 'none') {
                // Populate with all makes
                dropdown.innerHTML = '<option value="">Select Make...</option>';
                POPULAR_MAKES.forEach(make => {
                    dropdown.innerHTML += `<option value="${make}">${make}</option>`;
                });
                dropdown.style.display = 'inline-block';
            } else {
                dropdown.style.display = 'none';
            }
        }

        function quickChangeMake(make) {
            if (!make) return;
            const dropdown = document.getElementById('quickMakeDropdown');
            dropdown.style.display = 'none';

            // Clear old results
            const resultsSection = document.getElementById('resultsSection');
            if (resultsSection) resultsSection.classList.remove('active');
            const resultsContainer = document.getElementById('resultsContainer');
            if (resultsContainer) resultsContainer.innerHTML = '';

            // Change to the new make
            selectVisualMake(make);
        }

        function handleOmniSearch(e) {
            // Live filtering (on keyup/input)
            const query = e.target.value.trim();
            const lowerQuery = query.toLowerCase();
            const cards = document.querySelectorAll('.make-card');

            // 1. Filter brands visually
            cards.forEach(card => {
                const name = card.querySelector('.make-name').textContent.toLowerCase();
                card.style.display = name.includes(lowerQuery) ? 'flex' : 'none';
            });

            // 2. Handle Enter key for "Universal Search" (VIN or Smart Search)
            if (e.key === 'Enter' && query.length >= 3) {
                // Determine if it's a VIN (17 alphanumeric)
                const vinClean = query.toUpperCase().replace(/[^A-HJ-NPR-Z0-9]/g, '');
                if (vinClean.length === 17) {
                    decodeVin(vinClean);
                    return;
                }

                // Smart Search: Check if first word is a known Make
                let foundMake = null;
                cards.forEach(card => {
                    const name = card.querySelector('.make-name').textContent.toLowerCase();
                    // Match full word make only to avoid "Fo" matching "Ford" and "Force" etc improperly
                    if (lowerQuery === name || lowerQuery.startsWith(name + ' ')) {
                        foundMake = card.querySelector('.make-name').textContent;
                    }
                });

                if (foundMake) {
                    selectVisualMake(foundMake);
                    // Parse rest of query for year/model? 
                    // Future enhancement: automatically select year/model if provided
                } else {
                    // No make matched - perform FCC database search (same as header search)
                    showTab('fcc');
                    document.getElementById('fccSearch').value = query;
                    if (fccDataLoaded) {
                        renderFccTable();
                    } else {
                        loadFccData();
                    }
                }
            }
        }

        // ================== EXISTING LOGIC MODIFIED ==================

        function populateYears() {
            const select = document.getElementById('yearSelect');
            const year = new Date().getFullYear() + 1;
            for (let y = year; y >= 2000; y--) {
                select.innerHTML += `<option value="${y}">${y}</option>`;
            }
        }

        async function loadMakes() {
            // Legacy loadMakes (triggered by Year dropdown in legacy card)
            const year = document.getElementById('yearSelect').value;
            const select = document.getElementById('makeSelect');

            if (!year) {
                select.innerHTML = '<option value="">Select Make</option>';
                return;
            }

            // Check Cache
            const cacheKey = `makes_${year}`;
            const cached = localStorage.getItem(cacheKey);
            if (cached) {
                try {
                    const { data, timestamp } = JSON.parse(cached);
                    // Cache valid for 24 hours
                    if (Date.now() - timestamp < 24 * 60 * 60 * 1000) {
                        console.log('Using cached makes for', year);
                        renderMakes(data, select);
                        return;
                    }
                } catch (e) { localStorage.removeItem(cacheKey); }
            }

            select.innerHTML = '<option value="">Loading...</option>';
            try {
                // Optimized: only fetch 'make' field
                const res = await fetch(`${API}/api/master?year=${year}&fields=make&limit=2000`);
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const data = await res.json();

                const makes = [...new Set(data.rows.map(r => r.make))]
                    .filter(isValidMake)
                    .sort();

                // Save to Cache
                localStorage.setItem(cacheKey, JSON.stringify({ data: makes, timestamp: Date.now() }));

                renderMakes(makes, select);
            } catch (e) {
                console.error('Failed to load makes:', e);
                select.innerHTML = '<option value="">Select Make</option>';
            }
        }

        function renderMakes(makes, select) {
            select.innerHTML = '<option value="">Select Make</option>';
            makes.forEach(m => {
                const opt = document.createElement('option');
                opt.value = m;
                opt.textContent = m;
                select.appendChild(opt);
            });
        }

        // Check if model name looks like a product description rather than a vehicle model
        function isValidModelName(model) {
            if (!model) return false;
            const badPatterns = [
                /keyless entry/i, /remote key/i, /key fob/i, /flip key/i,
                /smart key/i, /transponder/i, /key blank/i, /mechanical key/i,
                /\d+b\s*w/i,  // "5B w" truncated entries
                /\d+ button/i, /peps/i, /fobik/i, /80 bit/i, /high security/i,
                /proximity/i, /smart remote/i
            ];
            return !badPatterns.some(p => p.test(model));
        }

        async function loadModels() {
            const year = document.getElementById('yearSelect').value;
            const make = document.getElementById('makeSelect').value;

            // Visual elements
            const chipContainer = document.getElementById('modelChips');
            const containerWrapper = document.getElementById('modelChipsContainer');
            const loader = document.getElementById('modelLoading');
            const filterBar = document.getElementById('modelFilterBar');

            if (!make) return;

            // Show container if it exists
            if (containerWrapper) {
                containerWrapper.style.display = 'block';
                if (chipContainer) chipContainer.innerHTML = '';
                if (filterBar) filterBar.style.display = 'none';
                if (loader) {
                    loader.style.display = 'block';
                    loader.innerHTML = 'Loading models... <small>(Checking database)</small>';
                }
            }

            // Check Cache
            const cacheKey = `models_v2_${make}_${year}`; // Updated cache key for version
            const cached = localStorage.getItem(cacheKey);
            if (cached) {
                try {
                    const { data, timestamp } = JSON.parse(cached);
                    // Cache valid for 24 hours
                    if (Date.now() - timestamp < 24 * 60 * 60 * 1000) {
                        console.log('Using cached models for', make, year);
                        currentModelsData = data;
                        renderModels(data, chipContainer, loader);
                        return;
                    }
                } catch (e) { localStorage.removeItem(cacheKey); }
            }

            const fetchUrl = `${API}/api/master?year=${year}&make=${encodeURIComponent(make)}&fields=model,key_type,key_type_display&limit=1000`;
            try {
                // Fetch data
                const res = await fetch(fetchUrl);
                if (!res.ok) throw new Error(`HTTP ${res.status}`);

                const data = await res.json();

                // Process unique models with key type info
                const processed = [];
                const seen = new Set();

                (data.rows || []).forEach(r => {
                    const name = (r.model || '').trim();
                    if (!name || !isValidModelName(name)) return;

                    const lowerName = name.toLowerCase();
                    const keyType = (r.key_type || r.key_type_display || '').toLowerCase();
                    const isProx = keyType.includes('prox') || keyType.includes('smart');

                    // Create unique key per model+type to handle same model name with different tech
                    const uniqueKey = `${lowerName}|${isProx ? 'prox' : 'keyed'}`;

                    if (!seen.has(uniqueKey)) {
                        seen.add(uniqueKey);
                        processed.push({
                            name: name,
                            type: isProx ? 'prox' : 'keyed',
                            key_type_display: r.key_type_display || (isProx ? 'Smart Key' : 'Keyed')
                        });
                    }
                });

                // Sort by name
                processed.sort((a, b) => a.name.localeCompare(b.name));

                // Save to Cache
                localStorage.setItem(cacheKey, JSON.stringify({ data: processed, timestamp: Date.now() }));
                currentModelsData = processed;

                renderModels(processed, chipContainer, loader);

            } catch (e) {
                console.error("Failed to load models", e);
                if (loader) {
                    loader.innerHTML = `
                        <div style="color: #ff6b6b; padding: 10px; border: 1px solid rgba(255,107,107,0.3); border-radius: 8px; background: rgba(255,107,107,0.05);">
                            <strong>Error loading models.</strong><br>
                            <span style="font-size:0.8rem; opacity:0.8;">The database connection may be slow or timed out.</span><br>
                            <br>
                            <button onclick="selectVisualYear('${year}')" class="inventory-btn" style="padding: 5px 12px; font-size: 0.8rem;">Retry Connection</button>
                        </div>
                    `;
                }
            }
        }

        function filterModels(type) {
            currentModelFilter = type;

            // Update filter buttons
            const buttons = document.querySelectorAll('.model-filter-btn');
            buttons.forEach(btn => {
                if (btn.textContent.toLowerCase().includes(type) || (type === 'all' && btn.textContent === 'All')) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });

            const chipContainer = document.getElementById('modelChips');
            const loader = document.getElementById('modelLoading');

            let filtered = currentModelsData;
            if (type !== 'all') {
                filtered = currentModelsData.filter(m => m.type === type);
            }

            renderModels(filtered, chipContainer, loader, true);
        }

        function renderModels(models, chipContainer, loader, isFiltering = false) {
            // Get the current make from the page state
            const currentMake = document.querySelector('.make-title')?.textContent?.trim() || '';

            // Generate vehicle image URL from R2 bucket via API
            const getVehicleImageUrl = (make, model) => {
                const cleanModel = model.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '');
                const cleanMake = make.toLowerCase().replace(/\s+/g, '-');
                return `${API_BASE}/api/assets/vehicles/${cleanMake}-${cleanModel}.png`;
            };

            // Populate Visual Grid
            if (chipContainer && loader) {
                loader.style.display = 'none';

                const filterBar = document.getElementById('modelFilterBar');
                if (filterBar && currentModelsData.length > 5) {
                    filterBar.style.display = 'flex';
                }

                if (models.length === 0) {
                    chipContainer.innerHTML = `
                        <div style="grid-column: 1/-1; text-align: center; color: var(--text-muted); padding: 40px;">
                            No models found for this category.<br>
                            <small>Try selecting "All" or a different category.</small>
                        </div>`;
                } else {
                    const imageUrl = (model) => getVehicleImageUrl(currentMake, model);
                    chipContainer.innerHTML = models.map(m => `
                        <div class="model-chip" onclick="selectVisualModel('${m.name}')" style="flex-direction: column; padding: 8px; min-height: 110px;">
                            <div class="model-image-container" style="width: 100%; height: 70px; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, rgba(18,18,28,0.9), rgba(22,33,50,0.9)); border-radius: 8px; margin-bottom: 6px; overflow: hidden;">
                                <img src="${imageUrl(m.name)}" alt="${m.name}" 
                                     style="max-width: 100%; max-height: 60px; object-fit: contain;"
                                     onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                <span style="display: none; font-size: 0.8rem; font-weight: 600; color: var(--accent); text-align: center; padding: 8px;">${m.name}</span>
                            </div>
                            <span class="model-name" style="font-size: 0.7rem; text-align: center;">${m.name}</span>
                        </div>
                    `).join('');
                }
            }

            // Populate Legacy Select (only if not filtering, as it needs all options)
            if (!isFiltering) {
                const select = document.getElementById('modelSelect');
                if (select) {
                    select.disabled = false;
                    select.innerHTML = '<option value="">Select Model</option>';
                    // Use simple list for the hidden select
                    const uniqueNames = [...new Set(models.map(m => m.name))].sort();
                    uniqueNames.forEach(name => {
                        const opt = document.createElement('option');
                        opt.value = name;
                        opt.textContent = name;
                        select.appendChild(opt);
                    });
                }
            }
        }




        // Helper functions for displayResults
        function getAmazonLink(term) {
            return `https://www.amazon.com/s?k=${encodeURIComponent(term)}&tag=${AFFILIATE_TAG}`;
        }

        function getKeyTypeIcon(type) {
            const lower = (type || '').toLowerCase();
            if (lower.includes('smart') || lower.includes('prox')) return 'ðŸ“¡';
            if (lower.includes('flip')) return 'ðŸ”‘';
            if (lower.includes('remote') || lower.includes('fob')) return 'ðŸŽ›ï¸';
            if (lower.includes('transponder')) return 'ðŸ·ï¸';
            return 'ðŸ”‘';
        }

        function getMakeLogo(make) {
            // Simple mapping or return null to hide
            // In a real app, this might point to /assets/logos/...
            return null;
        }

        // ========== COMPATIBLE KEYS CAROUSEL ==========
        // Global cache for compatible keys by vehicle
        const compatibleKeysCache = {};

        async function fetchCompatibleKeys(make, model, year) {
            const cacheKey = `${make}|${model}|${year}`;
            if (compatibleKeysCache[cacheKey]) {
                return compatibleKeysCache[cacheKey];
            }

            try {
                const url = `${API}/api/vehicle-keys?make=${encodeURIComponent(make)}&model=${encodeURIComponent(model)}&year=${year}`;
                const res = await fetch(url);
                const data = await res.json();
                if (data.keys && data.keys.length > 0) {
                    compatibleKeysCache[cacheKey] = data.keys;
                    return data.keys;
                }
            } catch (e) {
                console.log('Failed to fetch compatible keys:', e);
            }
            return [];
        }

        function categorizeKeyType(key) {
            // Smart/Prox: has FCC ID and buttons
            if (key.fcc_id && key.product_title?.toLowerCase().includes('smart')) return 'smart';
            if (key.fcc_id && (key.product_title?.toLowerCase().includes('remote head') || key.product_title?.toLowerCase().includes('rhk'))) return 'remote';
            // Transponder: has chip, no FCC or remote-style
            if (key.chip && !key.fcc_id) return 'transponder';
            if (key.chip && key.fcc_id) return 'smart';
            // Mechanical: shell or blank
            if (key.product_title?.toLowerCase().includes('shell') || key.product_title?.toLowerCase().includes('blank')) return 'mechanical';
            return 'key';
        }

        function getKeyIcon(type) {
            switch (type) {
                case 'smart': return 'ðŸ“¡';
                case 'remote': return 'ðŸŽ›ï¸';
                case 'transponder': return 'ðŸ·ï¸';
                case 'mechanical': return 'ðŸ—ï¸';
                case 'fobik': return 'ðŸ“¡';
                case 'flip': return 'ðŸ”„';
                case 'rhk': return 'ðŸ”‘';
                case 'blade': return 'ðŸ—¡ï¸';
                default: return 'ðŸ”‘';
            }
        }

        // Clean product title for display - remove vendor names, conditions, noise
        function cleanProductTitle(title) {
            if (!title) return 'Key';
            return title
                // Remove vendor/brand tags
                .replace(/\(BlueRocket\)/gi, '')
                .replace(/\(STRATTEC\)/gi, '')
                .replace(/\(ILCO\)/gi, '')
                .replace(/\(JMA[^)]*\)/gi, '')
                .replace(/\(BRK\)/gi, '')
                // Remove condition descriptors
                .replace(/â€”?OEM\s*(REFURB|NEW)?\s*(GREAT|MINT|NO LOGO|PRE-?OWNED)?/gi, '')
                .replace(/â€”?Aftermarket/gi, '')
                // Remove trailing dashes and clean up
                .replace(/\s*â€”\s*$/g, '')
                .replace(/\s+/g, ' ')
                .trim();
        }

        // Clean FCC ID - get first one if multiple
        function cleanFccId(fccId) {
            if (!fccId) return null;
            // Handle newline-separated FCC IDs
            const firstId = fccId.split('\n')[0].split(' ')[0].trim();
            return firstId || null;
        }

        // Track expanded carousel state
        const carouselExpanded = {};

        function renderKeyCarousel(keys, cardIndex, selectedIdx = 0) {
            if (!keys || keys.length === 0) return '';
            const isExpanded = carouselExpanded[cardIndex] || false;

            // Group keys by button count
            const groups = {};
            keys.forEach((k, idx) => {
                const btnCount = k.button_count || 0;
                const keyType = k.key_type || 'key';
                let groupKey = btnCount > 0 ? `${btnCount}-BUTTON` :
                    (keyType === 'blade' || keyType === 'mechanical') ? 'BLADE' : 'OTHER';
                if (!groups[groupKey]) groups[groupKey] = [];
                groups[groupKey].push({ ...k, originalIdx: idx });
            });

            // Sort: higher buttons first
            const groupOrder = Object.keys(groups).sort((a, b) => {
                const aNum = parseInt(a) || 0;
                const bNum = parseInt(b) || 0;
                return bNum - aNum;
            });

            const featureLabels = { rs: '+RS', trunk: '+TRUNK', hatch: '+HATCH', roof: '+ROOF', doors: '+DOORS' };
            let keyCount = 0;
            let treeHtml = '';

            for (const groupKey of groupOrder) {
                if (!isExpanded && keyCount >= 8) break;
                treeHtml += `<div class="key-tree-group"><div class="key-tree-header">${groupKey}</div><div class="key-tree-items">`;
                for (const k of groups[groupKey]) {
                    if (!isExpanded && keyCount >= 8) break;
                    const keyType = k.key_type || 'key';
                    const features = k.features || [];
                    const variantsCount = k.variants_count || 1;
                    const icon = getKeyIcon(keyType);
                    const fccId = cleanFccId(k.fcc_id);
                    const imageUrl = fccId ? `${API}/api/assets/${fccId}.png` : null;
                    const featureStr = features.length ? features.map(f => featureLabels[f] || `+${f.toUpperCase()}`).join(' ') : 'BASE';
                    const colorClass = (keyType === 'smart' || keyType === 'fobik') ? 'key-smart' : (keyType === 'rhk' || keyType === 'flip') ? 'key-remote' : keyType === 'transponder' ? 'key-transponder' : 'key-standard';
                    const isSelected = k.originalIdx === selectedIdx;
                    treeHtml += `<div class="key-thumb ${isSelected ? 'active' : ''} ${colorClass}" onclick="selectKey(${cardIndex}, ${k.originalIdx})" data-key-index="${k.originalIdx}" title="${cleanProductTitle(k.product_title)}">`;
                    if (imageUrl) treeHtml += `<img class="key-thumb-img" src="${imageUrl}" alt="${fccId}" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">`;
                    treeHtml += `<span class="key-thumb-icon"${imageUrl ? ' style="display:none"' : ''}>${icon}</span>`;
                    treeHtml += `<span class="key-thumb-type">${featureStr}</span>`;
                    if (fccId) treeHtml += `<span class="key-thumb-fcc">${fccId}</span>`;
                    if (k.price) treeHtml += `<span class="key-thumb-price">${k.price}</span>`;
                    if (variantsCount > 1) treeHtml += `<span class="key-variants-badge">${variantsCount}</span>`;
                    treeHtml += `</div>`;
                    keyCount++;
                }
                treeHtml += `</div></div>`;
            }

            const hasMore = keys.length > 8 && !isExpanded;
            return `<div class="key-carousel" id="keyCarousel-${cardIndex}">
                <div class="key-carousel-title">ðŸ” ${keys.length} UNIQUE KEYS (GROUPED BY BUTTON COUNT)</div>
                <div class="key-tree-container">
                    ${treeHtml}
                    ${hasMore ? `<div class="key-thumb key-more" onclick="expandCarousel(${cardIndex})"><span class="key-thumb-icon">âž•</span><span class="key-thumb-type">+${keys.length - 8} MORE</span></div>` : ''}
                    ${isExpanded ? `<div class="key-thumb key-collapse" onclick="collapseCarousel(${cardIndex})"><span class="key-thumb-icon">âž–</span><span class="key-thumb-type">COLLAPSE</span></div>` : ''}
                </div>
            </div>`;
        }

        function expandCarousel(cardIndex) {
            carouselExpanded[cardIndex] = true;
            const container = document.getElementById(`keyCarouselContainer-${cardIndex}`);
            const keys = cardKeysData[cardIndex];
            if (container && keys) {
                container.innerHTML = renderKeyCarousel(keys, cardIndex, 0);
            }
        }

        function collapseCarousel(cardIndex) {
            carouselExpanded[cardIndex] = false;
            const container = document.getElementById(`keyCarouselContainer-${cardIndex}`);
            const keys = cardKeysData[cardIndex];
            if (container && keys) {
                container.innerHTML = renderKeyCarousel(keys, cardIndex, 0);
            }
        }

        // Global storage for keys data per card
        const cardKeysData = {};

        function selectKey(cardIndex, keyIndex) {
            const keys = cardKeysData[cardIndex];
            if (!keys || !keys[keyIndex]) return;

            const key = keys[keyIndex];

            // Update active state on thumbnails
            const carousel = document.getElementById(`keyCarousel-${cardIndex}`);
            if (carousel) {
                carousel.querySelectorAll('.key-thumb').forEach((thumb, i) => {
                    thumb.classList.toggle('active', i === keyIndex);
                });
            }

            // Update card specs dynamically
            const specsContainer = document.getElementById(`keySpecs-${cardIndex}`);
            const cleanTitle = cleanProductTitle(key.product_title);
            const fccId = cleanFccId(key.fcc_id);
            if (specsContainer) {
                specsContainer.innerHTML = `
                    <div class="data-item">
                        <div class="data-label">Product</div>
                        <div class="data-value highlight" style="font-size: 0.9rem;">${cleanTitle || 'N/A'}</div>
                    </div>
                    <div class="data-item">
                        <div class="data-label">FCC ID</div>
                        <div class="data-value highlight">${fccId ? `<a href="#" class="fcc-link" onclick="searchFccById('${fccId}'); return false;">${fccId}</a>` : 'N/A'}</div>
                    </div>
                    <div class="data-item">
                        <div class="data-label">Chip</div>
                        <div class="data-value">${key.chip || 'N/A'}</div>
                    </div>
                    <div class="data-item">
                        <div class="data-label">Frequency</div>
                        <div class="data-value">${key.frequency || 'N/A'}</div>
                    </div>
                    <div class="data-item">
                        <div class="data-label">Battery</div>
                        <div class="data-value">${key.battery || 'N/A'}</div>
                    </div>
                    <div class="data-item">
                        <div class="data-label">Price (AKS)</div>
                        <div class="data-value" style="color: #22c55e; font-weight: 600;">${key.price || 'N/A'}</div>
                    </div>
                `;
            }

            // Update Amazon button
            const amazonBtn = document.getElementById(`amazonBtn-${cardIndex}`);
            if (amazonBtn && key.amazon_search_url) {
                amazonBtn.href = key.amazon_search_url;
            }

            // Update AKS link
            const aksBtn = document.getElementById(`aksBtn-${cardIndex}`);
            if (aksBtn && key.url) {
                aksBtn.href = key.url;
                aksBtn.style.display = 'inline-block';
            }
        }

        // Global state for year navigation
        let currentVehicleYear = null;
        let currentVehicleMake = null;
        let currentVehicleModel = null;

        async function searchVehicle() {
            const year = document.getElementById('yearSelect').value;
            const make = document.getElementById('makeSelect').value;
            const model = document.getElementById('modelSelect').value;

            if (!year || !make || !model) {
                alert('Please select year, make, and model');
                return;
            }

            // Store current vehicle for year navigation
            currentVehicleYear = parseInt(year);
            currentVehicleMake = make;
            currentVehicleModel = model;

            document.getElementById('resultTitle').textContent = `${make} ${model}`;
            updateYearNavigation(parseInt(year));
            document.getElementById('resultsContainer').innerHTML = '<div class="loading">Loading...</div>';

            const browseSection = document.getElementById('legacySearchCard');
            if (browseSection) browseSection.style.display = 'none';
            const resultsSection = document.getElementById('resultsSection');
            if (resultsSection) resultsSection.classList.add('active');
            initQuickSearch();
            await ensureGuidesLoaded(); // Predownload guides for linking

            try {
                const res = await fetch(`${API}/api/browse?year=${year}&make=${encodeURIComponent(make)}&model=${encodeURIComponent(model)}&limit=10`);
                const data = await res.json();

                if (data.rows && data.rows.length > 0) {
                    displayResults(data.rows, year, make, model);
                } else {
                    document.getElementById('resultsContainer').innerHTML = '<div class="loading">No results found</div>';
                }
            } catch (e) {
                console.error('Search failed:', e);
                document.getElementById('resultsContainer').innerHTML = '<div class="loading">Failed to load</div>';
            }
        }

        // Render search results
        function displayResults(rows, year, make, model, extras = {}) {
            const container = document.getElementById('resultsContainer');
            const { alerts = [], guide = null } = extras;

            // Set shareable URL for this vehicle
            setVehicleUrl(make, model, year);

            let html = '';

            // 1. Embedded YouTube Video Section (Watch First)
            const youtubeSearchQuery = encodeURIComponent(`${year} ${make} ${model} key programming tutorial`);
            html += `
            <div class="video-section" style="background: linear-gradient(135deg, rgba(255,0,0,0.1), rgba(139,0,0,0.1)); border: 1px solid rgba(255,0,0,0.3); border-radius: 12px; padding: 16px; margin-bottom: 20px;">
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                    <span style="font-size: 1.3rem;">ðŸ“¹</span>
                    <span style="font-weight: 700; color: #ff6b6b;">WATCH FIRST</span>
                    <span style="font-size: 0.8rem; color: var(--text-muted);">â€¢ Video tutorials for ${year} ${make} ${model}</span>
                </div>
                <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                    <a href="https://www.youtube.com/results?search_query=${youtubeSearchQuery}" target="_blank" 
                       style="display: inline-flex; align-items: center; gap: 8px; padding: 10px 16px; background: #ff0000; color: white; border-radius: 8px; text-decoration: none; font-weight: 600;">
                        <span>ðŸŽ¬</span> Search YouTube Tutorials
                    </a>
                    <a href="https://www.youtube.com/results?search_query=${encodeURIComponent(`${year} ${make} ${model} all keys lost programming`)}" target="_blank" 
                       style="display: inline-flex; align-items: center; gap: 8px; padding: 10px 16px; background: rgba(255,0,0,0.2); color: #ff6b6b; border: 1px solid #ff6b6b; border-radius: 8px; text-decoration: none; font-weight: 600;">
                        AKL Tutorial
                    </a>
                </div>
            </div>`;

            // 2. Tool Checklist Section (What You'll Need)
            const firstRow = rows[0] || {};
            const fccId = firstRow.fcc_id || 'HYQ4EA';
            const keyway = firstRow.keyway || 'HU100';
            const battery = firstRow.battery || 'CR2032';
            const amazonTag = 'eurokeys-20';
            html += `
            <div class="tool-checklist" style="background: linear-gradient(135deg, rgba(34,197,94,0.1), rgba(22,163,74,0.1)); border: 1px solid rgba(34,197,94,0.3); border-radius: 12px; padding: 16px; margin-bottom: 20px;">
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                    <span style="font-size: 1.3rem;">ðŸ› ï¸</span>
                    <span style="font-weight: 700; color: #22c55e;">WHAT YOU'LL NEED</span>
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                    <a href="https://www.amazon.com/s?k=${encodeURIComponent(`${year} ${make} ${model} key fob ${fccId}`)}&tag=${amazonTag}" target="_blank" 
                       style="display: flex; align-items: center; gap: 10px; padding: 10px 14px; background: rgba(0,0,0,0.3); border: 1px solid rgba(34,197,94,0.3); border-radius: 8px; text-decoration: none;">
                        <span>ðŸ”‘</span>
                        <div>
                            <div style="font-weight: 600; color: var(--accent);">Key Fob (${fccId})</div>
                            <div style="font-size: 0.75rem; color: #22c55e;">Buy on Amazon â†’</div>
                        </div>
                    </a>
                    ${keyway && keyway !== 'N/A' ? `
                    <a href="https://www.amazon.com/s?k=${encodeURIComponent(`${keyway} key blank`)}&tag=${amazonTag}" target="_blank" 
                       style="display: flex; align-items: center; gap: 10px; padding: 10px 14px; background: rgba(0,0,0,0.3); border: 1px solid rgba(34,197,94,0.3); border-radius: 8px; text-decoration: none;">
                        <span>ðŸ—ï¸</span>
                        <div>
                            <div style="font-weight: 600; color: var(--accent);">Blade (${keyway.split(' ')[0]})</div>
                            <div style="font-size: 0.75rem; color: #22c55e;">Buy on Amazon â†’</div>
                        </div>
                    </a>` : ''}
                    <a href="https://www.amazon.com/s?k=${encodeURIComponent(`${battery} battery 10 pack`)}&tag=${amazonTag}" target="_blank" 
                       style="display: flex; align-items: center; gap: 10px; padding: 10px 14px; background: rgba(0,0,0,0.3); border: 1px solid rgba(34,197,94,0.3); border-radius: 8px; text-decoration: none;">
                        <span>ðŸ”‹</span>
                        <div>
                            <div style="font-weight: 600; color: var(--accent);">Battery (${battery})</div>
                            <div style="font-size: 0.75rem; color: #22c55e;">Buy on Amazon â†’</div>
                        </div>
                    </a>
                </div>
            </div>`;

            // 3. Render Alerts (if any) - FIXED field names
            if (alerts && alerts.length > 0) {
                html += '<div class="vehicle-alerts-section" style="margin-bottom: 20px;">';
                // Deduplicate alerts by title
                const seenAlerts = new Set();
                alerts.forEach(alert => {
                    const title = alert.alert_title || alert.title;
                    if (seenAlerts.has(title)) return;
                    seenAlerts.add(title);

                    const level = (alert.alert_level || 'WARNING').toUpperCase();
                    const levelColors = {
                        'CRITICAL': { bg: 'rgba(239,68,68,0.15)', border: 'rgba(239,68,68,0.5)', icon: 'ðŸ”´', color: '#ef4444' },
                        'WARNING': { bg: 'rgba(251,191,36,0.15)', border: 'rgba(251,191,36,0.5)', icon: 'âš ï¸', color: '#fbbf24' },
                        'INFO': { bg: 'rgba(59,130,246,0.15)', border: 'rgba(59,130,246,0.5)', icon: 'â„¹ï¸', color: '#3b82f6' }
                    };
                    const style = levelColors[level] || levelColors['WARNING'];
                    const content = alert.alert_content || alert.content || '';
                    const mitigation = alert.mitigation || '';

                    html += `
                    <details style="background: ${style.bg}; border: 1px solid ${style.border}; border-radius: 8px; margin-bottom: 8px;">
                        <summary style="padding: 12px 16px; cursor: pointer; display: flex; align-items: center; gap: 10px; font-weight: 600; color: ${style.color};">
                            <span>${style.icon}</span>
                            <span>${title}</span>
                        </summary>
                        <div style="padding: 0 16px 12px 16px; font-size: 0.85rem; color: var(--text-secondary);">
                            <p style="margin: 0 0 8px 0;">${content}</p>
                            ${mitigation ? `<p style="margin: 0; padding: 8px; background: rgba(0,0,0,0.2); border-radius: 6px;"><strong>Fix:</strong> ${mitigation}</p>` : ''}
                        </div>
                    </details>`;
                });
                html += '</div>';
            }

            // 4. Programming Guide Callout (if available)
            if (guide) {
                html += `
                <div class="guide-callout" style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(37, 99, 235, 0.1)); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 12px; padding: 16px; margin-bottom: 24px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px;">
                    <div>
                        <h3 style="margin: 0 0 4px 0; color: #60a5fa;">ðŸ“š Programming Guide Available</h3>
                        <p style="margin: 0; color: var(--text-secondary); font-size: 0.9rem;">Comprehensive step-by-step instructions for ${year} ${make} ${model}</p>
                    </div>
                    <button onclick="openGuideModal('${guide.id}')" style="background: #3b82f6; color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                        <span>View Guide</span>
                        <span>â†’</span>
                    </button>
                    <!-- Hidden data store for the guide -->
                    <script id="guide-data-${guide.id}" type="application/json">${JSON.stringify(guide)}</script>
    </div>
    `;
    }

    // Deduplicate rows - prioritize FCC ID, only separate by OEM when FCC is N/A
    const seen = new Set();
    const uniqueRows = rows.filter(v => {
    const fccId = v.fcc_id || '';
    const oem = v.oem_part_number || '';
    const key = fccId ? `FCC:${fccId}` : `OEM:${oem}-${v.key_type || ''}`;
    if (key && seen.has(key)) return false;
    if (key) seen.add(key);
    return true;
    });

    // Make Grid or List
    html += uniqueRows.map((v, idx) => {
    const fccId = v.fcc_id || 'N/A';
    const fccIdClean = fccId !== 'N/A' ? fccId.toLowerCase().replace(/[^a-z0-9]/g, '') : '';
    const oem = v.oem_part_number || 'N/A';
    // Prefer direct ASIN link if available, otherwise search
    const amazonLink = v.primary_asin
    ? `https://www.amazon.com/dp/${v.primary_asin}?tag=${AFFILIATE_TAG}`
    : (fccId !== 'N/A' ? getAmazonLink(fccId) : null);
    const immo = v.immobilizer_system || v.immobilizer || 'N/A';
    const chip = v.chip || v.chip_technology || 'N/A';
    const freq = v.frequency ? `${v.frequency} MHz` : 'N/A';
    const keyway = v.keyway || 'N/A';
    const buttons = v.buttons || 'N/A';
    const battery = v.battery || 'N/A';

    // Key type from API or crossref
    const keyType = v.key_type || v.crossref_key_type || 'N/A';
    const keyTypeIcon = getKeyTypeIcon(keyType);

    // Key type display with color coding
    const keyTypeDisplay = v.key_type_display || '';
    const getKeyTypeBadgeClass = (type) => {
    if (!type) return '';
    const t = type.toLowerCase();
    if (t.includes('transponder')) return 'badge-transponder';
    if (t.includes('smart')) return 'badge-smartkey';
    if (t.includes('remote head')) return 'badge-remotehead';
    if (t.includes('mechanical')) return 'badge-mechanical';
    return 'badge-dark';
    };
    const keyTypeBadgeClass = getKeyTypeBadgeClass(keyTypeDisplay);

    // Parse key_blank_refs JSON
    let keyBlankRefs = null;
    try {
    if (v.key_blank_refs) {
    keyBlankRefs = typeof v.key_blank_refs === 'string' ? JSON.parse(v.key_blank_refs) : v.key_blank_refs;
    }
    } catch (e) { /* ignore parse errors */ }

    // Get image URL
    const imageUrl = v.image_url || v.remote_image || (fccId !== 'N/A' && v.has_image ? `${API}/api/assets/${fccId}.png`
    : null);

    // Aftermarket parts from part_crossref
    const ilco = v.ilco_part || (keyBlankRefs?.ilco?.[0]) || 'N/A';
    const strattec = v.strattec_part || (keyBlankRefs?.strattec?.[0]) || 'N/A';
    const jma = v.jma_part || 'N/A';
    const keydiy = v.keydiy_part || 'N/A';
    const hasAftermarket = ilco !== 'N/A' || strattec !== 'N/A' || jma !== 'N/A' || keydiy !== 'N/A' ||
    (keyBlankRefs?.ilco?.length > 0);

    // Create card label based on what differentiates it
    let cardLabel = `${year} ${make} ${model}`;
    if (uniqueRows.length > 1) {
    if (fccId !== 'N/A') {
    cardLabel += ` â€¢ FCC: ${fccId}`;
    } else if (oem !== 'N/A') {
    cardLabel += ` â€¢ Part: ${oem}`;
    } else {
    cardLabel += ` â€¢ Variant ${idx + 1}`;
    }
    }

    // FCC ID links to internal FCC Database
    const fccDisplay = fccId !== 'N/A'
    ? `<a href="#" class="fcc-link" onclick="searchFccById('${fccId}'); return false;">${fccId}</a>`
    : 'N/A';

    // YouTube search link
    const youtubeLink = `https://www.youtube.com/results?search_query=${encodeURIComponent(`${year} ${make} ${model} key
    programming Autel`)}`;

    // Get make logo
    const makeLogo = getMakeLogo(make);
    const logoHtml = makeLogo ? `<img src="${makeLogo}" alt="${make}" class="make-logo"
        onerror="this.style.display='none'"
        style="width: 28px; height: 28px; object-fit: contain; margin-right: 10px; border-radius: 4px;">` : '';

    // Check inventory stock for this key (if signed in)
    const keyInStock = currentUser && fccId !== 'N/A' ? InventoryManager.getKeyStock(fccId) : 0;
    const blankInStock = currentUser && keyway !== 'N/A' ? InventoryManager.getBlankStock(keyway) : 0;
    const inventoryBadge = keyInStock > 0
    ? `<span class="badge" style="background: #22c55e; color: white;">ðŸ“¦ ${keyInStock} in stock</span>`
    : blankInStock > 0
    ? `<span class="badge" style="background: #22c55e; color: white;">ðŸ”‘ ${blankInStock} blanks</span>`
    : '';

    // ===== VEHICLE WARNINGS & DIFFICULTY SYSTEM =====
    const makeLower = make.toLowerCase();
    const modelLower = model.toLowerCase();
    const yearNum = parseInt(year);
    const rfSystem = v.rf_system || '';
    const vinOrdered = v.vin_ordered || 0;
    const dealerToolOnly = v.dealer_tool_only || '';
    const progDifficulty = v.prog_difficulty || v.akl_difficulty || '';
    const immoSystem = (v.immobilizer_system || v.immobilizer || '').toLowerCase();

    // Generate warning badges
    let stellantisWarnings = '';
    let difficultyBadge = '';
    let dealerOnlyBadge = '';

    // ===== MERCEDES FBS4 DEALER-ONLY =====
    const isMercedes = makeLower.includes('mercedes') || makeLower === 'mercedes-benz';
    const isFBS4 = yearNum >= 2015 && isMercedes;
    const isFBS4AKL = isFBS4 && (immoSystem.includes('fbs4') || immoSystem.includes('das4'));

    if (isFBS4 || (isMercedes && yearNum >= 2015)) {
    dealerOnlyBadge = `<span class="badge"
        style="background: rgba(239, 68, 68, 0.15); color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.3); font-weight: 600;">ðŸš¨
        FBS4 Dealer-Only AKL</span>`;
    difficultyBadge = `<span class="badge"
        style="background: rgba(239, 68, 68, 0.1); color: #fca5a5; border: 1px solid rgba(239, 68, 68, 0.2);">â±ï¸ ~3-5
        days (NASTF)</span>`;
    }

    // ===== VAG MQB-EVO DEALER-ONLY (2020+) =====
    const isVAG = ['audi', 'volkswagen', 'vw', 'porsche', 'seat', 'skoda'].includes(makeLower);
    const isMQBEvo = isVAG && yearNum >= 2020;
    const isPorsche992 = makeLower === 'porsche' && yearNum >= 2019 && (modelLower.includes('911') ||
    modelLower.includes('taycan'));

    if (isPorsche992) {
    dealerOnlyBadge = `<span class="badge"
        style="background: rgba(239, 68, 68, 0.15); color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.3); font-weight: 600;">ðŸš¨
        Dealer Only (BCM2)</span>`;
    difficultyBadge = `<span class="badge"
        style="background: rgba(239, 68, 68, 0.1); color: #fca5a5; border: 1px solid rgba(239, 68, 68, 0.2);">â±ï¸ Dealer
        Required</span>`;
    } else if (isMQBEvo && !dealerOnlyBadge) {
    dealerOnlyBadge = `<span class="badge"
        style="background: rgba(245, 158, 11, 0.15); color: #f59e0b; border: 1px solid rgba(245, 158, 11, 0.3); font-weight: 600;">âš ï¸
        MQB-Evo (AKL Complex)</span>`;
    difficultyBadge = `<span class="badge"
        style="background: rgba(245, 158, 11, 0.1); color: #fcd34d; border: 1px solid rgba(245, 158, 11, 0.2);">â±ï¸ 45-90
        min bench</span>`;
    }

    // ===== DIFFICULTY LEVEL INDICATORS =====
    if (!difficultyBadge && progDifficulty) {
    const diff = parseInt(progDifficulty) || 0;
    if (diff >= 8) {
    difficultyBadge = `<span class="badge"
        style="background: rgba(239, 68, 68, 0.1); color: #fca5a5; border: 1px solid rgba(239, 68, 68, 0.2);">ðŸ”´ Expert
        | 60+ min</span>`;
    } else if (diff >= 6) {
    difficultyBadge = `<span class="badge"
        style="background: rgba(245, 158, 11, 0.1); color: #fcd34d; border: 1px solid rgba(245, 158, 11, 0.2);">ðŸŸ¡
        Intermediate | 30-45 min</span>`;
    } else if (diff >= 4) {
    difficultyBadge = `<span class="badge"
        style="background: rgba(34, 197, 94, 0.1); color: #86efac; border: 1px solid rgba(34, 197, 94, 0.2);">ðŸŸ¢
        Standard | 15-30 min</span>`;
    } else {
    difficultyBadge = `<span class="badge"
        style="background: rgba(34, 197, 94, 0.1); color: #86efac; border: 1px solid rgba(34, 197, 94, 0.2);">âœ… Basic |
        10-15 min</span>`;
    }
    }

    // ===== STELLANTIS SPLIT-YEAR & PRE-CODING WARNINGS =====
    // Split-Year Warning (2022 Renegade)
    if (makeLower === 'jeep' && modelLower.includes('renegade') && yearNum === 2022) {
    stellantisWarnings += `<span class="badge"
        style="background: rgba(245, 158, 11, 0.2); color: #f59e0b; border: 1px solid rgba(245, 158, 11, 0.4);">âš ï¸
        Split-Year</span>`;
    }

    // VIN-Ordered Key Warning (Italian-built 2023+)
    if (vinOrdered === 1) {
    stellantisWarnings += `<span class="badge"
        style="background: rgba(239, 68, 68, 0.2); color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.4);">ðŸ”’
        VIN-Ordered</span>`;
    }

    // Dealer Tool Required Warning (from database)
    if (dealerToolOnly && !dealerOnlyBadge) {
    dealerOnlyBadge = `<span class="badge"
        style="background: rgba(168, 85, 247, 0.2); color: #a855f7; border: 1px solid rgba(168, 85, 247, 0.4);">ðŸ”§
        ${dealerToolOnly}</span>`;
    }

    // RF System Badge (Giobert/Continental/Alfa)
    let rfSystemBadge = '';
    if (rfSystem === 'Giobert' || rfSystem === 'Alfa Romeo') {
    rfSystemBadge = `<span class="badge"
        style="background: rgba(59, 130, 246, 0.15); color: #3b82f6; border: 1px solid rgba(59, 130, 246, 0.3);">ðŸ‡®ðŸ‡¹
        ${rfSystem}</span>`;
    } else if (rfSystem === 'Continental' || rfSystem === 'Continental (Legacy)') {
    rfSystemBadge = `<span class="badge"
        style="background: rgba(34, 197, 94, 0.15); color: #22c55e; border: 1px solid rgba(34, 197, 94, 0.3);">ðŸ‡ºðŸ‡¸
        Continental</span>`;
    } else if (rfSystem === 'Split-Year') {
    rfSystemBadge = `<span class="badge"
        style="background: rgba(245, 158, 11, 0.2); color: #f59e0b; border: 1px solid rgba(245, 158, 11, 0.4);">âš ï¸
        Verify RF Hub</span>`;
    }

    // GM Architecture Badge & Theme Logic
    let themeClass = '';
    let archName = 'Standard Architecture';
    let archBadgeClass = 'badge-dark';
    let archIcon = 'ðŸ”§';

    if ((immoSystem && immoSystem.includes('Global A')) || (v.notes && v.notes.includes('Global A'))) {
    themeClass = 'theme-global-a';
    archName = 'Global A (Open)';
    archBadgeClass = 'global-a';
    archIcon = 'ðŸŸ¢';
    } else if ((immoSystem && immoSystem.includes('Global B')) || (v.notes && v.notes.includes('Global B'))) {
    themeClass = 'theme-global-b';
    archName = 'Global B (Locked)';
    archBadgeClass = 'global-b';
    archIcon = 'ðŸ”´';
    }

    // Parse Service Notes for Scanner
    let scannerRows = [];
    if (v.service_notes_pro) {
    scannerRows = v.service_notes_pro.split('\n').filter(line => line.trim().length > 0).map(line => {
    let rowClass = '';
    if (line.includes('âš ï¸')) rowClass = 'warning';
    if (line.includes('CRITICAL') || line.includes('ERR')) rowClass = 'alert';
    return { text: line, class: rowClass };
    });
    }

    return `
    <div class="mega-card ${themeClass}">
        <!-- Mega Header -->
        <div class="mega-card-header">
            <div style="display: flex; align-items: center; gap: 16px;">
                ${logoHtml}
                <div>
                    <div
                        style="font-size: 1.4rem; font-weight: 800; color: var(--text-primary); line-height: 1.2; letter-spacing: -0.5px;">
                        ${year} ${make} ${model}
                    </div>
                    <div
                        style="font-size: 0.9rem; color: var(--text-secondary); margin-top: 4px; font-family: monospace;">
                        ${fccId !== 'N/A' ? 'FCC: ' + fccId : 'P/N: ' + oem}
                    </div>
                </div>
            </div>

            <div style="text-align: right;">
                <div class="arch-badge ${archBadgeClass}">
                    ${archIcon} ${archName}
                </div>
                <div style="display: flex; gap: 4px; justify-content: flex-end; margin-top: 6px; flex-wrap: wrap;">
                    ${dealerOnlyBadge} ${difficultyBadge} ${stellantisWarnings}
                </div>
            </div>
        </div>

        <!-- Spec Grid -->
        <div class="mega-spec-grid">
            <div class="spec-item">
                <div class="spec-icon" style="color: #a855f7;">ðŸ›¡ï¸</div>
                <div class="spec-label">Chip</div>
                <div class="spec-value">${chip}</div>
            </div>
            <div class="spec-item">
                <div class="spec-icon" style="color: #06b6d4;">âš¡</div>
                <div class="spec-label">Frequency</div>
                <div class="spec-value">${freq}</div>
            </div>
            <div class="spec-item">
                <div class="spec-icon" style="color: #eab308;">ðŸ—ï¸</div>
                <div class="spec-label">Keyway</div>
                <div class="spec-value">${keyway}</div>
            </div>
            <div class="spec-item">
                <div class="spec-icon" style="color: #22c55e;">ðŸ”§</div>
                <div class="spec-label">System</div>
                <div class="spec-value">${immoSystem}</div>
            </div>
        </div>

        <!-- Diagnostic Scanner (Pro Notes) -->
        ${scannerRows.length > 0 ? `
        <div class="diagnostic-scanner">
            <div class="scanner-header">
                <span>DIAGNOSTIC_SYSTEM_V2.4 // ${make.toUpperCase()}_${model.toUpperCase()}</span>
                <span>STATUS: CONNECTED</span>
            </div>
            <div class="scanner-screen">
                ${scannerRows.map(row => `<div class="scan-row ${row.class}"><span>${row.text}</span></div>`).join('')}
            </div>
        </div>
        ` : ''}

        <!-- Key Reference Visual Section -->
        <div class="key-reference-section"
            style="background: linear-gradient(135deg, rgba(18,18,28,0.95), rgba(22,33,50,0.95)); padding: 16px; border-bottom: 1px solid var(--border);">
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                <span style="font-size: 1.2rem;">ðŸ”‘</span>
                <span
                    style="font-size: 0.8rem; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px;">Key
                    Reference</span>
            </div>
            <div style="display: flex; gap: 16px; overflow-x: auto; padding-bottom: 8px;">
                <!-- Key Fob Image -->
                <div class="key-ref-card"
                    style="flex: 0 0 auto; width: 140px; background: rgba(0,0,0,0.3); border-radius: 12px; padding: 12px; text-align: center; border: 1px solid rgba(255,255,255,0.1);">
                    <img src="${API}/api/assets/keys/${make.toLowerCase()}-${model.toLowerCase()}-${fccIdClean || 'key'}.png"
                        alt="Key Fob"
                        style="width: 100%; height: 80px; object-fit: contain; border-radius: 8px; background: rgba(255,255,255,0.05);"
                        onerror="this.src='${API}/api/assets/keys/generic-fob.png'; this.onerror=null;">
                    <div style="font-size: 0.7rem; color: var(--accent); margin-top: 8px; font-weight: 600;">
                        ${fccIdClean || 'Smart Key'}</div>
                    <div style="font-size: 0.65rem; color: var(--text-muted);">Fob</div>
                </div>
                <!-- Key Blade Image -->
                ${keyway && keyway !== 'N/A' ? `
                <div class="key-ref-card"
                    style="flex: 0 0 auto; width: 140px; background: rgba(0,0,0,0.3); border-radius: 12px; padding: 12px; text-align: center; border: 1px solid rgba(255,255,255,0.1);">
                    <img src="${API}/api/assets/keys/key-blank-${keyway.toLowerCase().split(' ')[0] || 'generic'}.png"
                        alt="Key Blade"
                        style="width: 100%; height: 80px; object-fit: contain; border-radius: 8px; background: rgba(255,255,255,0.05);"
                        onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                    <div
                        style="display: none; width: 100%; height: 80px; align-items: center; justify-content: center; color: var(--accent); font-size: 2rem;">
                        ðŸ—ï¸</div>
                    <div style="font-size: 0.7rem; color: #22c55e; margin-top: 8px; font-weight: 600;">${keyway}</div>
                    <div style="font-size: 0.65rem; color: var(--text-muted);">Blade Profile</div>
                </div>
                ` : ''}
                <!-- Quick Specs Card -->
                <div class="key-ref-card"
                    style="flex: 0 0 auto; width: 140px; background: rgba(0,0,0,0.3); border-radius: 12px; padding: 12px; text-align: center; border: 1px solid rgba(255,255,255,0.1);">
                    <div style="font-size: 1.5rem; margin-bottom: 4px;">ðŸ“¡</div>
                    <div style="font-size: 0.7rem; color: #06b6d4; margin-top: 8px; font-weight: 600;">${freq}</div>
                    <div style="font-size: 0.65rem; color: var(--text-muted);">Frequency</div>
                    <div style="font-size: 0.65rem; color: #a855f7; margin-top: 6px;">${chip}</div>
                </div>
            </div>
        </div>

        <!-- Key Carousel -->
        <div id="keyCarouselContainer-${idx}" class="key-carousel-container"
            style="background: var(--bg-secondary); padding: 16px; border-bottom: 1px solid var(--border);"></div>
        <div
            style="font-size: 0.75rem; color: var(--text-muted); text-align: center; padding: 4px; background: var(--bg-tertiary);">
            ${inventoryBadge}
        </div>

        <!-- Action Footer -->
        <div
            style="padding: 16px; display: flex; gap: 12px; justify-content: space-between; align-items: center; background: var(--bg-secondary);">
            <div style="display: flex; gap: 6px;">
                ${keyTypeDisplay ? `<span class="badge ${keyTypeBadgeClass}">${keyTypeDisplay}</span>` : ''}
                ${jma !== 'N/A' ? `<a
                    href="https://www.amazon.com/s?k=${encodeURIComponent('JMA ' + jma + ' key blank')}&tag=eurokeys-20"
                    target="_blank"
                    style="background: linear-gradient(135deg, #5a3d1a, #7a5a2b); padding: 6px 12px; border-radius: 6px; border: 1px solid #8a6a3b; text-decoration: none; color: white; display: flex; align-items: center; gap: 6px; transition: all 0.2s;"
                    onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'"><span
                        style="font-weight: 600;">JMA</span> ${jma} ðŸ›’</a>` : ''}
                ${keydiy !== 'N/A' ? `<a
                    href="https://www.amazon.com/s?k=${encodeURIComponent('KEYDIY ' + keydiy)}&tag=eurokeys-20"
                    target="_blank"
                    style="background: linear-gradient(135deg, #4a1a5d, #6a2b7a); padding: 6px 12px; border-radius: 6px; border: 1px solid #7a3b8a; text-decoration: none; color: white; display: flex; align-items: center; gap: 6px; transition: all 0.2s;"
                    onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'"><span
                        style="font-weight: 600;">KEYDIY</span> ${keydiy} ðŸ›’</a>` : ''}
            </div>
        </div>

        ${(fccId !== 'N/A' || oem !== 'N/A' || keyway !== 'N/A') ? `
        <div style="margin-top: 12px; padding: 12px; background: var(--bg-tertiary); border-radius: 8px;">
            <div
                style="font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;">
                ðŸ“¦ My Inventory</div>
            ${getVehicleInventoryHtml(
            oem !== 'N/A' ? oem : (fccId !== 'N/A' ? fccId : null),
            keyway,
            year + ' ' + make + ' ' + model,
            oem !== 'N/A' ? 'https://www.amazon.com/s?k=' + encodeURIComponent(year + ' ' + make + ' ' + model + ' key
            fob ' + oem) + '&tag=eurokeys-20' : (fccId !== 'N/A' ? 'https://www.amazon.com/s?k=' +
            encodeURIComponent(year + ' ' + make + ' ' + model + ' key fob ' + fccId) + '&tag=eurokeys-20' : null),
            keyway !== 'N/A' ? 'https://www.amazon.com/s?k=' + encodeURIComponent(keyway + ' key blank') +
            '&tag=eurokeys-20' : null
            )}
        </div>
        ` : ''}

        ${v.mechanical_spec || v.code_series || v.service_notes_pro || v.key_blank_refs ? `
        <div class="pro-data-section">
            <div class="pro-header">
                <span style="font-size: 1.1rem;">ðŸ› ï¸</span> Mechanical Codex
            </div>
            <div class="mec-codex-grid">
                ${v.mechanical_spec ? `<div class="mec-item">
                    <div class="mec-label">Key Spec</div>
                    <div class="mec-value">${v.mechanical_spec}</div>
                </div>` : ''}
                ${v.spaces ? `<div class="mec-item">
                    <div class="mec-label">Spaces</div>
                    <div class="mec-value">${v.spaces}</div>
                </div>` : ''}
                ${v.depths ? `<div class="mec-item">
                    <div class="mec-label">Depths</div>
                    <div class="mec-value">${v.depths}</div>
                </div>` : ''}
                ${v.code_series ? `<div class="mec-item">
                    <div class="mec-label">Code Series</div>
                    <div class="mec-value">${v.code_series}</div>
                </div>` : ''}
                ${v.ignition_retainer ? `<div class="mec-item">
                    <div class="mec-label">Ignition Retainer</div>
                    <div class="mec-value">${v.ignition_retainer}</div>
                </div>` : ''}
                ${v.lishi_tool ? `<div class="mec-item">
                    <div class="mec-label">Lishi Tool</div>
                    <div class="mec-value" style="color: #22c55e;">${v.lishi_tool}</div>
                </div>` : ''}
            </div>

            ${(() => {
            // Parse key_blank_refs JSON for cross-reference table
            let xrefHtml = '';
            if (v.key_blank_refs) {
            try {
            const refs = typeof v.key_blank_refs === 'string' ? JSON.parse(v.key_blank_refs) : v.key_blank_refs;
            xrefHtml = `
            <div
                style="margin-top: 12px; padding: 12px; background: rgba(0,0,0,0.3); border-radius: 8px; border: 1px solid rgba(34,197,94,0.3);">
                <div
                    style="font-size: 0.75rem; color: #22c55e; font-weight: 600; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px;">
                    ðŸ“‹ Cross-Reference</div>
                <table style="width: 100%; font-size: 0.8rem; border-collapse: collapse;">
                    <tr style="border-bottom: 1px solid rgba(255,255,255,0.1);">
                        <td style="padding: 6px 0; color: var(--text-muted);">Ilco</td>
                        <td style="padding: 6px 0; color: var(--accent); font-weight: 600;">${refs.ilco || 'N/A'}</td>
                    </tr>
                    ${refs.strattec ? Object.entries(refs.strattec).map(([btn, pn]) => `
                    <tr style="border-bottom: 1px solid rgba(255,255,255,0.1);">
                        <td style="padding: 6px 0; color: var(--text-muted);">Strattec (${btn})</td>
                        <td style="padding: 6px 0; color: #06b6d4; font-weight: 600;">${pn}</td>
                    </tr>
                    `).join('') : ''}
                    ${refs.oem_blade ? `
                    <tr style="border-bottom: 1px solid rgba(255,255,255,0.1);">
                        <td style="padding: 6px 0; color: var(--text-muted);">OEM Blade</td>
                        <td style="padding: 6px 0; color: var(--accent);">${refs.oem_blade}</td>
                    </tr>` : ''}
                    ${refs.code_series ? `
                    <tr>
                        <td style="padding: 6px 0; color: var(--text-muted);">Code Series</td>
                        <td style="padding: 6px 0; color: #a855f7;">${refs.code_series}</td>
                    </tr>` : ''}
                </table>
            </div>`;
            } catch (e) { xrefHtml = ''; }
            }
            return xrefHtml;
            })()}

            ${v.service_notes_pro ? `
            <details style="margin-top: 12px;">
                <summary
                    style="cursor: pointer; padding: 10px 12px; background: rgba(251,191,36,0.1); border: 1px solid rgba(251,191,36,0.3); border-radius: 8px; color: var(--accent); font-weight: 600; font-size: 0.85rem;">
                    ðŸ“Œ Pro Service Notes (Click to expand)
                </summary>
                <div
                    style="margin-top: 8px; padding: 12px; background: rgba(0,0,0,0.3); border-radius: 8px; font-size: 0.8rem; line-height: 1.6; color: var(--text-secondary); white-space: pre-wrap;">
                    ${v.service_notes_pro}</div>
            </details>
            ` : ''}
        </div>
        ` : ''
        }

        <div style="margin-top: 12px; display: flex; gap: 8px; flex-wrap: wrap; align-items: center;">
            ${oem !== 'N/A' ? `<a
                href="https://www.amazon.com/s?k=${encodeURIComponent(year + ' ' + make + ' ' + model + ' key fob ' + oem)}&tag=eurokeys-20"
                target="_blank" class="key-photos-btn" style="text-decoration: none;">ðŸ›’ Buy Key on Amazon</a>` : (fccId
            !== 'N/A' ? `<a
                href="https://www.amazon.com/s?k=${encodeURIComponent(year + ' ' + make + ' ' + model + ' key fob ' + fccId)}&tag=eurokeys-20"
                target="_blank" class="key-photos-btn" style="text-decoration: none;">ðŸ›’ Buy Key on Amazon</a>` : '')}
            <a href="${youtubeLink}" target="_blank"
                style="padding: 8px 16px; background: #ff0000; color: white; border-radius: 6px; text-decoration: none; font-size: 0.85rem; font-weight: 600;">ðŸ“º
                Watch Tutorial</a>
            <button onclick="toggleGuide('${make}', '${model}', ${idx})" class="walkthrough-toggle">ðŸ“– View
                Guide</button>
        </div>
        <div id="guide-${idx}" class="walkthrough-content"></div>
    </div>
    `;
    }).join('');

    // PERFORMANCE OPTIMIZATION 1: Batch fetch keys with Promise.all instead of sequential forEach
    // PERFORMANCE OPTIMIZATION 2: Fixed broken template literal (was `keyCarouselContainer - ${ idx } `)
    const keyLoadPromise = fetchCompatibleKeys(make, model, year);

    Promise.all(uniqueRows.map(async (v, idx) => {
    const container = document.getElementById(`keyCarouselContainer-${idx}`);
    if (!container) return;

    // Show loading skeleton immediately
    container.innerHTML = '<div style="text-align: center; color: var(--text-muted); padding: 8px;">Loading keys...
    </div>';

    try {
    // Reuse single fetch for all cards (same make/model/year)
    const keys = await keyLoadPromise;
    if (keys && keys.length > 0) {
    cardKeysData[idx] = keys;
    container.innerHTML = renderKeyCarousel(keys, idx, 0);
    } else {
    container.innerHTML = '';
    }
    } catch (e) {
    container.innerHTML = '';
    }
    }));
    }

    function getKeyTypeIcon(keyType) {
    const lower = (keyType || '').toLowerCase();
    if (lower.includes('smart') || lower.includes('prox')) return 'ðŸš—';
    if (lower.includes('flip')) return 'ðŸ”„';
    if (lower.includes('fobik')) return 'ðŸ“Ÿ';
    if (lower.includes('remote')) return 'ðŸ“¡';
    return 'ðŸ”‘';
    }

    function goBack() {
    // Hide results
    const resultsSection = document.getElementById('resultsSection');
    if (resultsSection) resultsSection.classList.remove('active');

    // Show the legacy search card (we're already in a search flow)
    const legacyCard = document.getElementById('legacySearchCard');
    if (legacyCard) legacyCard.style.display = 'block';

    // Show year chips again for current make
    const yearChipsContainer = document.getElementById('yearChipsContainer');
    if (yearChipsContainer) yearChipsContainer.style.display = 'block';

    // Hide model chips
    const modelChipsContainer = document.getElementById('modelChipsContainer');
    if (modelChipsContainer) modelChipsContainer.style.display = 'none';

    // Clear selected year badge
    const yearBadge = document.getElementById('selectedYearBadge');
    if (yearBadge) yearBadge.style.display = 'none';

    // Hide year navigation
    const yearNav = document.getElementById('yearNavigation');
    if (yearNav) yearNav.style.display = 'none';
    }

    // Year Navigation Functions
    function updateYearNavigation(year) {
    const yearNav = document.getElementById('yearNavigation');
    const yearCurrent = document.getElementById('yearNavCurrent');
    const prevBtn = document.getElementById('yearPrevBtn');
    const nextBtn = document.getElementById('yearNextBtn');

    if (yearNav && yearCurrent) {
    yearNav.style.display = 'flex';
    yearCurrent.textContent = year;

    // Determine year boundaries (2000 - next year)
    const minYear = 2000;
    const maxYear = new Date().getFullYear() + 1;

    prevBtn.disabled = year <= minYear; nextBtn.disabled=year>= maxYear;
        }
        }

        // PERFORMANCE OPTIMIZATION 3: Debounced year navigation with abort controller
        let navigateYearTimeout = null;
        let currentNavigationController = null;

        async function navigateYear(direction) {
        if (!currentVehicleMake || !currentVehicleModel || !currentVehicleYear) return;

        const newYear = currentVehicleYear + direction;
        const minYear = 2000;
        const maxYear = new Date().getFullYear() + 1;

        if (newYear < minYear || newYear> maxYear) return;

            // Update year immediately for responsive UI
            currentVehicleYear = newYear;
            updateYearNavigation(newYear);

            // Cancel any pending navigation
            if (navigateYearTimeout) {
            clearTimeout(navigateYearTimeout);
            }
            if (currentNavigationController) {
            currentNavigationController.abort();
            }

            // Debounce: wait 150ms before actually fetching (allows rapid clicking)
            navigateYearTimeout = setTimeout(() => {
            loadVehicleByYear(newYear, currentVehicleMake, currentVehicleModel);
            }, 150);
            }

            async function loadVehicleByYear(year, make, model) {
            document.getElementById('resultTitle').textContent = `${make} ${model} `;
            updateYearNavigation(year);
            // CRITICAL: Clear container BEFORE loading to prevent stacking
            document.getElementById('resultsContainer').innerHTML = '<div class="loading">Loading...</div>';

            try {
            const res = await fetch(`${API} /api/browse ? year = ${year}& make=${encodeURIComponent(make)}&
            model=${encodeURIComponent(model)}& limit=10`);
            const data = await res.json();

            if (data.rows && data.rows.length > 0) {
            displayResults(data.rows, year, make, model);
            } else {
            // Fetch available years for this make/model
            let availableYearsHtml = '';
            try {
            const yearsRes = await fetch(`${API} /api/master ? make = ${encodeURIComponent(make)}&
            model=${encodeURIComponent(model)}& fields=year_start, year_end & limit=100`);
            const yearsData = await yearsRes.json();
            if (yearsData.rows && yearsData.rows.length > 0) {
            const yearsSet = new Set();
            yearsData.rows.forEach(r => {
            const start = r.year_start || r.year_end;
            const end = r.year_end || r.year_start;
            if (start && end) {
            for (let y = Math.min(start, end); y <= Math.max(start, end); y++) { yearsSet.add(y); } } else if (start) {
                yearsSet.add(start); } }); const sortedYears=[...yearsSet].sort((a, b)=> b - a);
                if (sortedYears.length > 0) {
                availableYearsHtml = `
                < div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border);">
                    <div style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 10px;">Available years for
                        ${make} ${model}:</div>
                    <div
                        style="display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; max-width: 400px; margin: 0 auto;">
                        ${sortedYears.slice(0, 15).map(y => `
                        <button onclick="loadVehicleByYear(${y}, '${make}', '${model}')"
                            style="padding: 8px 14px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary); cursor: pointer; font-size: 0.9rem; transition: all 0.2s;"
                            onmouseover="this.style.background='var(--brand-primary)'; this.style.color='var(--bg-primary)';"
                            onmouseout="this.style.background='var(--bg-tertiary)'; this.style.color='var(--text-primary)';">
                            ${y}
                        </button>
                        `).join('')}
                        ${sortedYears.length > 15 ? `<span
                            style="color: var(--text-muted); font-size: 0.8rem; align-self: center;">+${sortedYears.length
                            - 15} more</span>` : ''}
                    </div>
                    </div>
                    `;
                    }
                    }
                    } catch (e) {
                    console.log('Could not fetch available years:', e);
                    }

                    document.getElementById('resultsContainer').innerHTML = `
                    < div class="loading" style="text-align: center;">
                        <div style="font-size: 2rem; margin-bottom: 12px;">ðŸš«</div>
                        <div>No data for ${year} ${make} ${model}</div>
                        <div style="font-size: 0.85rem; color: var(--text-muted); margin-top: 8px;">
                            ${availableYearsHtml ? 'Select a year with available data below:' : 'Try adjacent years or
                            this model may not exist for ' + year}
                        </div>
                        ${availableYearsHtml}
                        </div>
                        `;
                        }
                        } catch (e) {
                        console.error('Year navigation failed:', e);
                        document.getElementById('resultsContainer').innerHTML = '<div class="loading">Failed to load
                        </div>';
                        }
                        }

                        // Quick switch to a different make (pre-populate dropdowns)
                        async function quickSwitchMake(make) {
                        // Hide results
                        const resultsSection = document.getElementById('resultsSection');
                        if (resultsSection) resultsSection.classList.remove('active');

                        // Clear results container
                        const resultsContainer = document.getElementById('resultsContainer');
                        if (resultsContainer) resultsContainer.innerHTML = '';

                        // Set the make in dropdown
                        const makeSelect = document.getElementById('makeSelect');
                        makeSelect.value = make;

                        // Trigger visual make selection
                        await selectVisualMake(make);
                        }

                        // Quick switch to a different model (same year/make)
                        async function quickSwitchModel(year, make, model) {
                        document.getElementById('yearSelect').value = year;
                        document.getElementById('makeSelect').value = make;
                        await loadModels();
                        document.getElementById('modelSelect').value = model;
                        await searchVehicle();
                        }

                        // Quick search from results page
                        async function quickLoadMakes() {
                        const year = document.getElementById('quickYear').value;
                        const select = document.getElementById('quickMake');

                        if (!year) {
                        select.innerHTML = '<option value="">Make</option>';
                        return;
                        }
                        select.innerHTML = '<option value="">Loading...</option>';

                        try {
                        const res = await fetch(`${API} /api/master ? year = ${year}& limit=1000`);
                        const data = await res.json();
                        const makes = [...new Set(data.rows.map(r => r.make))].filter(isValidMake).sort();
                        select.innerHTML = '<option value="">Make</option>';
                        makes.forEach(m => { select.innerHTML += `< option value="${m}"> ${m}</option> `; });
                            } catch (e) {
                            select.innerHTML = '<option value="">Make</option>';
                            }
                            }

                            async function quickLoadModels() {
                            const year = document.getElementById('quickYear').value;
                            const make = document.getElementById('quickMake').value;
                            const select = document.getElementById('quickModel');

                            if (!make) {
                            select.innerHTML = '<option value="">Model</option>';
                            return;
                            }
                            select.innerHTML = '<option value="">Loading...</option>';

                            try {
                            const res = await fetch(`${API} /api/master ? year = ${year}&
                            make=${encodeURIComponent(make)}& limit=500`);
                            const data = await res.json();
                            const models = [...new Set(data.rows.map(r => r.model))].sort();
                            select.innerHTML = '<option value="">Model</option>';
                            models.forEach(m => { select.innerHTML += `< option value="${m}"> ${m}</option> `; });
                                } catch (e) {
                                select.innerHTML = '<option value="">Model</option>';
                                }
                                }

                                async function quickSearch() {
                                const year = document.getElementById('quickYear').value;
                                const make = document.getElementById('quickMake').value;
                                const model = document.getElementById('quickModel').value;

                                if (!year || !make || !model) {
                                alert('Please select year, make, and model');
                                return;
                                }

                                // Store current vehicle for year navigation
                                currentVehicleYear = parseInt(year);
                                currentVehicleMake = make;
                                currentVehicleModel = model;

                                document.getElementById('resultTitle').textContent = `${make} ${model} `;
                                updateYearNavigation(parseInt(year));
                                document.getElementById('resultsContainer').innerHTML = '<div class="loading">Loading...
                                </div>';

                                try {
                                const res = await fetch(`${API} /api/browse ? year = ${year}&
                                make=${encodeURIComponent(make)}& model=${encodeURIComponent(model)}& limit=10`);
                                const data = await res.json();
                                if (data.rows && data.rows.length > 0) {
                                displayResults(data.rows, year, make, model);
                                } else {
                                document.getElementById('resultsContainer').innerHTML = '<div class="loading">No results
                                    found</div>';
                                }
                                } catch (e) {
                                document.getElementById('resultsContainer').innerHTML = '<div class="loading">Failed to
                                    load</div>';
                                }
                                }

                                // Populate quick search years when results are shown
                                function initQuickSearch() {
                                const select = document.getElementById('quickYear');
                                if (select.options.length <= 1) { const year=new Date().getFullYear() + 1; for (let
                                    y=year; y>= 2000; y--) {
                                    select.innerHTML += `< option value="${y}"> ${y}</option> `;
                                        }
                                        }
                                        }

                                        // ================== FCC DATABASE ==================

                                        let fccData = [];
                                        let fccDataLoaded = false;
                                        let fccPage = 1;
                                        let fccKeyType = 'all'; // 'all', 'push', 'non-push'
                                        const FCC_PER_PAGE = 20;

                                        // Determine key type matching filter categories
                                        function getKeyType(row) {
                                        const vehicles = (row.vehicles || '').toLowerCase();
                                        const chip = (row.chip || '').toLowerCase();
                                        const freq = parseFloat(row.frequency) || 0;
                                        const keyTypeDisplay = (row.key_type_display || '').toLowerCase();

                                        // Smart/Prox keys: PEPS, proximity, push-to-start
                                        if (chip.includes('hitag') || chip.includes('id47') || chip.includes('id49') ||
                                        chip.includes('id4a') || vehicles.includes('prox') ||
                                        vehicles.includes('smart') || vehicles.includes('peps') ||
                                        keyTypeDisplay.includes('smart') || freq >= 433) {
                                        return 'smart';
                                        }

                                        // Flip/switchblade keys
                                        if (vehicles.includes('flip') || vehicles.includes('switchblade') ||
                                        keyTypeDisplay.includes('flip')) {
                                        return 'flip';
                                        }

                                        // Remote head keys
                                        if (vehicles.includes('remote head') || chip.includes('remote head') ||
                                        keyTypeDisplay.includes('remote head') ||
                                        vehicles.includes('rhk') || vehicles.includes('remote key')) {
                                        return 'remote-head';
                                        }

                                        // Mechanical/traditional keys: no chip
                                        if (row.is_synthetic || chip.includes('non-transponder') ||
                                        chip.includes('traditional') || chip === 'na' || chip === 'n/a' ||
                                        chip === '' || keyTypeDisplay.includes('mechanical') ||
                                        keyTypeDisplay.includes('high security')) {
                                        return 'mechanical';
                                        }

                                        // Transponder keys: chip-based but not smart
                                        if (chip.includes('id') || chip.includes('philips') || chip.includes('texas') ||
                                        chip.includes('megamos') || chip.includes('pcf') || chip.includes('tpx') ||
                                        keyTypeDisplay.includes('transponder') || keyTypeDisplay.includes('ews')) {
                                        return 'transponder';
                                        }

                                        return 'transponder'; // Default fallback
                                        }

                                        // Generate key type badge HTML with appropriate colors
                                        function getKeyTypeBadge(row, includeMarginLeft = false) {
                                        const keyType = getKeyType(row);
                                        const badges = {
                                        'smart': { label: 'Smart/Prox', bg: 'rgba(34, 197, 94, 0.1)', color: '#22c55e',
                                        border: 'rgba(34, 197, 94, 0.2)' },
                                        'flip': { label: 'Flip Key', bg: 'rgba(168, 85, 247, 0.1)', color: '#a855f7',
                                        border: 'rgba(168, 85, 247, 0.2)' },
                                        'remote-head': { label: 'Remote Head', bg: 'rgba(59, 130, 246, 0.1)', color:
                                        '#3b82f6', border: 'rgba(59, 130, 246, 0.2)' },
                                        'mechanical': { label: 'Mechanical', bg: 'rgba(156, 163, 175, 0.1)', color:
                                        '#9ca3af', border: 'rgba(156, 163, 175, 0.2)' },
                                        'transponder': { label: 'Transponder', bg: 'rgba(251, 191, 36, 0.1)', color:
                                        '#fbbf24', border: 'rgba(251, 191, 36, 0.2)' }
                                        };
                                        const badge = badges[keyType] || badges['transponder'];
                                        const marginStyle = includeMarginLeft ? ' margin-left: 8px;' : '';
                                        return `< span
                                            style="font-size: 0.7rem; background: ${badge.bg}; color: ${badge.color}; padding: 2px 6px; border-radius: 4px; border: 1px solid ${badge.border};${marginStyle}">
                                            ${badge.label}</span> `;
                                            }

                                            // Legacy compatibility - keep isPushKey for any other usages
                                            function isPushKey(row) {
                                            return getKeyType(row) === 'smart';
                                            }

                                            function setFccFilter(type) {
                                            fccKeyType = type;
                                            fccPage = 1;
                                            // Update active button
                                            document.querySelectorAll('.fcc-filter').forEach(btn => {
                                            btn.classList.toggle('active', btn.dataset.type === type);
                                            });
                                            renderFccTable();
                                            // Re-render coverage map to highlight filtered key type
                                            renderKeyCoverageMap(true);
                                            }

                                            // ========== GUIDES TAB FUNCTIONS ==========
                                            let guidesData = [];
                                            let guidesDataLoaded = false;
                                            let currentGuidesMakeFilter = 'all';

                                            async function ensureGuidesLoaded() {
                                            if (guidesDataLoaded) return;
                                            try {
                                            const res = await fetch(`${API} /api/guides`);
                                            if (res.ok) {
                                            const data = await res.json();
                                            guidesData = data.rows || [];
                                            guidesDataLoaded = true;
                                            }
                                            } catch (e) { console.warn('Silent guide load failed:', e); }
                                            }

                                            function getGuideButtonHtml(make, model) {
                                            // Deprecated: The mega-card template now handles View Guide via
                                            toggleGuide()
                                            // This function was causing duplicate buttons and broken 'null' ID issues
                                            // Return empty to prevent duplicate View Guide buttons
                                            return '';
                                            }

                                            async function loadGuidesTab() {
                                            if (guidesDataLoaded) {
                                            renderGuidesGrid();
                                            return;
                                            }

                                            const grid = document.getElementById('guidesGrid');
                                            if (grid) {
                                            grid.innerHTML = '<div class="loading"
                                                style="grid-column: 1 / -1; text-align: center; padding: 40px; color: var(--text-muted);">
                                                Loading guides...</div>';
                                            }

                                            try {
                                            const res = await fetch(`${API} /api/guides`);
                                            if (!res.ok) throw new Error(`HTTP Error ${res.status} `);
                                            const data = await res.json();
                                            guidesData = data.rows || [];
                                            guidesDataLoaded = true;

                                            // Update stats
                                            const totalEl = document.getElementById('totalGuidesCount');
                                            const makesEl = document.getElementById('uniqueMakesCount');
                                            const dealerEl = document.getElementById('dealerOnlyCount');

                                            if (totalEl) totalEl.textContent = guidesData.length;

                                            const uniqueMakes = new Set(guidesData.map(g => g.make));
                                            if (makesEl) makesEl.textContent = uniqueMakes.size;

                                            const dealerOnly = guidesData.filter(g =>
                                            g.dealer_tool_only ||
                                            (g.content && g.content.toLowerCase().includes('dealer-only'))
                                            ).length;
                                            if (dealerEl) dealerEl.textContent = dealerOnly;

                                            renderGuidesGrid();
                                            try {
                                            renderGuideCoverageMap();
                                            } catch (err) {
                                            console.error('Failed to render coverage map:', err);
                                            }
                                            } catch (e) {
                                            console.error('Failed to load guides:', e);
                                            if (grid) {
                                            grid.innerHTML = `< div
                                                style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #f87171;">
                                                Failed to load guides.< br>
                                                    <small style="opacity:0.8">${e.message}</small><br>
                                                    <button onclick="loadGuidesTab()"
                                                        style="margin-top:16px;background:var(--bg-tertiary);border:1px solid var(--border);color:var(--text-primary);padding:8px 16px;border-radius:6px;cursor:pointer;">Try
                                                        Again</button>
                                                    </div>`;
                                                    }
                                                    }
                                                    }

                                                    // Render Guide Coverage Heatmap
                                                    function renderGuideCoverageMap() {
                                                    const container = document.getElementById('guideCoverageContainer');
                                                    if (!container) return;

                                                    // Use same makes and years layout as Key Coverage
                                                    // Use HARDCODED_COVERAGE keys if available, otherwise build from
                                                    guidesData
                                                    const hardcodedMakes = typeof HARDCODED_COVERAGE !== 'undefined' ?
                                                    Object.keys(HARDCODED_COVERAGE) : [];

                                                    // Get all unique makes from guidesData to ensure we cover
                                                    everything
                                                    const guideMakes = [...new Set(guidesData.map(g => g.make))].sort();

                                                    // Combine and unique
                                                    const allMakes = [...new Set([...hardcodedMakes,
                                                    ...guideMakes])].sort();
                                                    const years = Array.from({ length: 31 }, (_, i) => 1995 + i); //
                                                    1995-2025

                                                    // Build coverage grid
                                                    const coverage = {};
                                                    allMakes.forEach(make => {
                                                    coverage[make] = {};
                                                    years.forEach(year => {
                                                    coverage[make][year] = { count: 0 };
                                                    });
                                                    });

                                                    // Populate from guidesData
                                                    guidesData.forEach(guide => {
                                                    if (!guide.make || !guide.year_start) return;

                                                    const make = guide.make;
                                                    // Normalize make matching if needed (simple check for now)
                                                    const targetMake = allMakes.find(m => m.toLowerCase() ===
                                                    make.toLowerCase()) || make;

                                                    if (coverage[targetMake]) {
                                                    const start = parseInt(guide.year_start);
                                                    const end = guide.year_end ? parseInt(guide.year_end) : 2025; //
                                                    Default to 2025 if null

                                                    for (let y = start; y <= end; y++) { if (y>= 1995 && y <= 2025) {
                                                            coverage[targetMake][y].count++; } } } else { //
                                                            console.warn('Skipping coverage for unknown make:',
                                                            targetMake); } }); // Sticky Header HTML const
                                                            headerHtml=years.map(y=> `< th
                                                                style="font-size: 0.5rem; color: var(--text-muted); text-align: center; padding: 0; width: 18px; min-width: 18px; font-weight: normal;">
                                                                '${y.toString().slice(2)}</th>`).join('');

                                                                // Rows HTML
                                                                const rowsHtml = allMakes.map(make => {
                                                                // Filter rows based on active filter if needed, but
                                                                let's show all for map context
                                                                // Or hide empty rows? Let's keep it consistent with the
                                                                main map

                                                                // Check if make has ANY guides
                                                                const hasGuides = Object.values(coverage[make]).some(c
                                                                => c.count > 0);
                                                                // If filtering by make, maybe only show that make?
                                                                if (currentGuidesMakeFilter !== 'all' &&
                                                                make.toLowerCase() !== currentGuidesMakeFilter) return
                                                                '';
                                                                if (currentGuidesMakeFilter === 'all' && !hasGuides)
                                                                return ''; // Hide makes with no guides in "All" view to
                                                                save space

                                                                const cells = years.map(year => {
                                                                const data = coverage[make][year];
                                                                const count = data.count;

                                                                // Color logic
                                                                let bg = 'var(--bg-secondary)'; // Empty
                                                                if (count > 0) bg = '#3b82f6'; // Generic Guide Blue
                                                                // Could add logic: Dealer Only = Red?

                                                                const opacity = count > 0 ? '1' : '0.3';
                                                                // Use specific colors if we want to mimic the Key Map
                                                                style
                                                                if (count > 0) {
                                                                bg = 'rgba(59, 130, 246, 0.8)'; // Blue for guides
                                                                } else {
                                                                bg = 'rgba(255, 255, 255, 0.05)';
                                                                }

                                                                return `<td style="padding: 1px;">
                                                                    <div style="height: 12px; background: ${bg}; border-radius: 2px;"
                                                                        title="${make} ${year}: ${count} Guides"></div>
                                                                </td>`;
                                                                }).join('');

                                                                return `<tr>
                                                                    <td
                                                                        style="position: sticky; left: 0; z-index: 10; background: var(--bg-tertiary); font-size: 0.7rem; color: var(--text-normal); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; padding-right: 8px;">
                                                                        ${make}</td>
                                                                    ${cells}
                                                                </tr>`;
                                                                }).join('');

                                                                const html = `
                                                                <div
                                                                    style="background: var(--bg-tertiary); padding: 16px; border-radius: 12px; border: 1px solid var(--border); margin-bottom: 20px;">
                                                                    <h3
                                                                        style="margin-top: 0; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; font-size: 1rem;">
                                                                        <span>ðŸ—ºï¸ Guide Coverage Map</span>
                                                                        <span
                                                                            style="font-size: 0.7rem; font-weight: normal; color: var(--text-muted); margin-left: auto;">Blue
                                                                            = Guide Available</span>
                                                                    </h3>

                                                                    <div
                                                                        style="overflow-x: auto; -webkit-overflow-scrolling: touch; position: relative;">
                                                                        <table
                                                                            style="border-collapse: separate; border-spacing: 2px; table-layout: fixed;">
                                                                            <thead>
                                                                                <tr>
                                                                                    <th
                                                                                        style="position: sticky; left: 0; z-index: 10; background: var(--bg-tertiary); min-width: 70px; width: 70px;">
                                                                                    </th>
                                                                                    ${headerHtml}
                                                                                </tr>
                                                                            </thead>
                                                                            <tbody>
                                                                                ${rowsHtml}
                                                                            </tbody>
                                                                        </table>
                                                                    </div>
                                                                </div>`;

                                                                container.innerHTML = html;
                                                                }

                                                                function filterGuidesByMake(make) {
                                                                currentGuidesMakeFilter = make.toLowerCase();

                                                                // Update active filter button
                                                                document.querySelectorAll('#tabGuides
                                                                .fcc-filter').forEach(btn => {
                                                                btn.classList.toggle('active', btn.dataset.make ===
                                                                make.toLowerCase());
                                                                });

                                                                renderGuidesGrid();
                                                                }

                                                                function filterGuidesTable() {
                                                                renderGuidesGrid();
                                                                }

                                                                function renderGuidesGrid() {
                                                                const grid = document.getElementById('guidesGrid');
                                                                if (!grid) return;

                                                                const searchTerm =
                                                                (document.getElementById('guidesSearch')?.value ||
                                                                '').toLowerCase();

                                                                let filtered = guidesData.filter(g => {
                                                                // Make filter
                                                                if (currentGuidesMakeFilter !== 'all') {
                                                                if (!g.make ||
                                                                !g.make.toLowerCase().includes(currentGuidesMakeFilter))
                                                                return false;
                                                                }

                                                                // Search filter
                                                                if (searchTerm) {
                                                                const searchable = `${g.make || ''} ${g.model || ''}
                                                                ${g.content || ''}`.toLowerCase();
                                                                if (!searchable.includes(searchTerm)) return false;
                                                                }

                                                                return true;
                                                                });

                                                                if (filtered.length === 0) {
                                                                grid.innerHTML = `<div
                                                                    style="grid-column: 1 / -1; text-align: center; padding: 40px; color: var(--text-muted);">
                                                                    No guides found for this filter.
                                                                </div>`;
                                                                return;
                                                                }

                                                                grid.innerHTML = filtered.map(g =>
                                                                renderGuideCard(g)).join('');
                                                                }

                                                                function renderGuideCard(guide) {
                                                                const yearRange = guide.year_start && guide.year_end
                                                                ? `${guide.year_start}-${guide.year_end}`
                                                                : guide.year_start || 'All Years';

                                                                const isDealerOnly = guide.dealer_tool_only ||
                                                                (guide.content &&
                                                                guide.content.toLowerCase().includes('dealer-only'));

                                                                const hasFBS4 = guide.content &&
                                                                guide.content.toLowerCase().includes('fbs4');
                                                                const hasMQB = guide.content &&
                                                                guide.content.toLowerCase().includes('mqb');

                                                                let badges = '';
                                                                if (isDealerOnly) {
                                                                badges += `<span
                                                                    style="background: rgba(239, 68, 68, 0.15); color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.3); padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">ðŸš¨
                                                                    Dealer-Only</span>`;
                                                                }
                                                                if (hasFBS4) {
                                                                badges += `<span
                                                                    style="background: rgba(245, 158, 11, 0.15); color: #f59e0b; border: 1px solid rgba(245, 158, 11, 0.3); padding: 2px 8px; border-radius: 4px; font-size: 0.75rem;">FBS4</span>`;
                                                                }
                                                                if (hasMQB) {
                                                                badges += `<span
                                                                    style="background: rgba(59, 130, 246, 0.15); color: #3b82f6; border: 1px solid rgba(59, 130, 246, 0.3); padding: 2px 8px; border-radius: 4px; font-size: 0.75rem;">MQB</span>`;
                                                                }

                                                                // Extract first paragraph for preview
                                                                const contentPreview = (guide.content || '')
                                                                .replace(/##?\s+/g, '')
                                                                .replace(/\*\*/g, '')
                                                                .replace(/\n+/g, ' ')
                                                                .substring(0, 150) + '...';

                                                                return `
                                                                <div class="guide-card"
                                                                    style="background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 12px; padding: 16px; cursor: pointer; transition: all 0.2s;"
                                                                    onclick="viewGuideDetail('${guide.id}')"
                                                                    onmouseover="this.style.borderColor='var(--brand-primary)'; this.style.transform='translateY(-2px)';"
                                                                    onmouseout="this.style.borderColor='var(--border)'; this.style.transform='translateY(0)';">
                                                                    <div
                                                                        style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
                                                                        <div>
                                                                            <div
                                                                                style="font-weight: 600; color: var(--brand-primary); font-size: 0.85rem;">
                                                                                ${guide.make}</div>
                                                                            <div
                                                                                style="font-size: 1.1rem; font-weight: 700; color: var(--text-primary);">
                                                                                ${guide.model}</div>
                                                                        </div>
                                                                        <div style="text-align: right;">
                                                                            <div
                                                                                style="background: var(--bg-secondary); padding: 4px 10px; border-radius: 6px; font-size: 0.85rem; color: var(--text-secondary);">
                                                                                ${yearRange}</div>
                                                                        </div>
                                                                    </div>
                                                                    <div
                                                                        style="display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 10px;">
                                                                        ${badges}
                                                                    </div>
                                                                    <div
                                                                        style="color: var(--text-muted); font-size: 0.85rem; line-height: 1.4;">
                                                                        ${contentPreview}
                                                                    </div>
                                                                    <div
                                                                        style="margin-top: 12px; display: flex; justify-content: flex-end;">
                                                                        <button
                                                                            style="background: var(--brand-primary); color: var(--bg-primary); border: none; padding: 6px 14px; border-radius: 6px; font-size: 0.85rem; font-weight: 600; cursor: pointer;">
                                                                            View Guide â†’
                                                                        </button>
                                                                    </div>
                                                                </div>
                                                                `;
                                                                }

                                                                function viewGuideDetail(guideId) {
                                                                // Find the guide
                                                                const guide = guidesData.find(g => g.id === guideId);
                                                                if (!guide) return;

                                                                // Open modal using renderVehicleGuide for full
                                                                structured view
                                                                const modalHtml = `
                                                                <div id="guideDetailModal"
                                                                    style="position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 9999; display: flex; align-items: center; justify-content: center; padding: 20px; backdrop-filter: blur(5px);"
                                                                    onclick="if(event.target.id === 'guideDetailModal') this.remove();">
                                                                    <div
                                                                        style="background: var(--bg-primary); border-radius: 16px; max-width: 900px; width: 100%; max-height: 90vh; overflow-y: auto; padding: 0; position: relative; box-shadow: 0 4px 25px rgba(0,0,0,0.5); border: 1px solid var(--border);">
                                                                        <button
                                                                            onclick="document.getElementById('guideDetailModal').remove()"
                                                                            style="position: absolute; top: 16px; right: 16px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.1); color: var(--text-primary); width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 16px; cursor: pointer; z-index: 10; transition: all 0.2s;">âœ•</button>
                                                                        <div style="padding: 32px;">
                                                                            ${renderVehicleGuide(guide)}
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                                `;
                                                                document.body.insertAdjacentHTML('beforeend',
                                                                modalHtml);
                                                                }

                                                                async function loadFccData() {
                                                                try {
                                                                const res = await fetch(`${API}/api/fcc?limit=500`);
                                                                const data = await res.json();
                                                                fccData = data.rows || [];
                                                                fccDataLoaded = true;
                                                                populateFccYears();
                                                                renderFccTable();
                                                                } catch (e) {
                                                                document.getElementById('fccTableBody').innerHTML = '
                                                                <tr>
                                                                    <td colspan="5" class="loading">Failed to load FCC
                                                                        data</td>
                                                                </tr>';
                                                                }
                                                                }

                                                                function populateFccYears() {
                                                                const fromSelect =
                                                                document.getElementById('fccYearFrom');
                                                                const toSelect = document.getElementById('fccYearTo');
                                                                if (!fromSelect || !toSelect) return;

                                                                const currentYear = new Date().getFullYear() + 1;
                                                                for (let y = currentYear; y >= 1998; y--) {
                                                                fromSelect.innerHTML += `<option value="${y}">${y}
                                                                </option>`;
                                                                toSelect.innerHTML += `<option value="${y}">${y}
                                                                </option>`;
                                                                }
                                                                }

                                                                function filterFccTable() {
                                                                fccPage = 1;
                                                                const query =
                                                                document.getElementById('fccSearch').value;
                                                                logSearch(query);
                                                                renderFccTable();
                                                                // Refresh coverage map to sync highlighting with search
                                                                renderKeyCoverageMap(true);
                                                                }

                                                                function renderFccTable() {
                                                                const rawSearch =
                                                                document.getElementById('fccSearch').value;
                                                                const yearFrom =
                                                                parseInt(document.getElementById('fccYearFrom')?.value)
                                                                || 0;
                                                                const yearTo =
                                                                parseInt(document.getElementById('fccYearTo')?.value) ||
                                                                9999;

                                                                // Parse year from search string (e.g. "jeep 2012")
                                                                const yearMatch =
                                                                rawSearch.match(/\b(19\d{2}|20\d{2})\b/);
                                                                const searchYear = yearMatch ? parseInt(yearMatch[1]) :
                                                                null;
                                                                const searchText =
                                                                rawSearch.replace(/\b(19\d{2}|20\d{2})\b/g,
                                                                '').trim().toLowerCase();

                                                                // Filter by search and exclude garbage FCC IDs (< 5
                                                                    chars) let filtered=fccData.filter(r=> {
                                                                    const fccId = r.fcc_id || '';
                                                                    if (fccId.length < 5) return false; // Filter
                                                                        garbage like "ID" const
                                                                        matchesSearch=!searchText ||
                                                                        fccId.toLowerCase().includes(searchText) ||
                                                                        (r.vehicles || ''
                                                                        ).toLowerCase().includes(searchText); // Check
                                                                        if vehicle years match searched year if
                                                                        (matchesSearch && searchYear) { const
                                                                        vehicles=r.vehicles || '' ; const
                                                                        yearRanges=vehicles.match(/\((\d{4})(?:-(\d{4}))?\)/g)
                                                                        || []; const matchesYear=yearRanges.some(match=>
                                                                        {
                                                                        const m =
                                                                        match.match(/\((\d{4})(?:-(\d{4}))?\)/);
                                                                        if (!m) return false;
                                                                        const start = parseInt(m[1]);
                                                                        const end = m[2] ? parseInt(m[2]) : start;
                                                                        return searchYear >= start && searchYear <= end;
                                                                            }); return matchesYear; } return
                                                                            matchesSearch; }); // Apply year range
                                                                            filter (extract years from vehicles string)
                                                                            if (yearFrom || yearTo !==9999) {
                                                                            filtered=filtered.filter(r=> {
                                                                            const vehicles = r.vehicles || '';
                                                                            // Extract years from format like
                                                                            "(2014-2021)"
                                                                            const yearMatches =
                                                                            vehicles.match(/\((\d{4})(?:-(\d{4}))?\)/g)
                                                                            || [];
                                                                            if (yearMatches.length === 0) return true;
                                                                            // Show if no year data

                                                                            // Check if any year range overlaps with
                                                                            filter
                                                                            return yearMatches.some(match => {
                                                                            const m =
                                                                            match.match(/\((\d{4})(?:-(\d{4}))?\)/);
                                                                            if (!m) return false;
                                                                            const start = parseInt(m[1]);
                                                                            const end = m[2] ? parseInt(m[2]) : start;
                                                                            return end >= yearFrom && start <= yearTo;
                                                                                }); }); } // Apply key type filter -
                                                                                uses getKeyType() to match badge display
                                                                                logic if (fccKeyType !=='all' ) {
                                                                                filtered=filtered.filter(r=>
                                                                                getKeyType(r) === fccKeyType);
                                                                                }

                                                                                const totalPages =
                                                                                Math.ceil(filtered.length /
                                                                                FCC_PER_PAGE);
                                                                                const start = (fccPage - 1) *
                                                                                FCC_PER_PAGE;
                                                                                const pageData = filtered.slice(start,
                                                                                start + FCC_PER_PAGE);

                                                                                const tbody =
                                                                                document.getElementById('fccTableBody');

                                                                                if (pageData.length === 0) {
                                                                                tbody.innerHTML = '<tr>
                                                                                    <td colspan="5" class="loading">No
                                                                                        FCC IDs found</td>
                                                                                </tr>';
                                                                                return;
                                                                                }

                                                                                tbody.innerHTML = pageData.map(r => {
                                                                                const fccId = r.fcc_id || 'N/A';
                                                                                const vehicles = r.vehicles || 'N/A';
                                                                                const freq = r.frequency || 'N/A';
                                                                                const chip = r.chip || 'N/A';
                                                                                const oemPart = r.primary_oem_part ||
                                                                                null;
                                                                                const primaryMake = r.primary_make ||
                                                                                null;

                                                                                // Parse and group vehicles to avoid
                                                                                long lists
                                                                                const vehicleItems = vehicles !== 'N/A'
                                                                                ? vehicles.split(',').map(v =>
                                                                                v.trim()).filter(v => v) : [];
                                                                                const groups = {};
                                                                                vehicleItems.forEach(vi => {
                                                                                const match =
                                                                                vi.match(/^([^(]+)\s+\((\d{4})(?:-(\d{4}))?\)$/);
                                                                                if (match) {
                                                                                const makeModel = match[1].trim();
                                                                                const startYear = parseInt(match[2]);
                                                                                const endYear = match[3] ?
                                                                                parseInt(match[3]) : startYear;
                                                                                if (!groups[makeModel]) {
                                                                                groups[makeModel] = { start: startYear,
                                                                                end: endYear };
                                                                                } else {
                                                                                groups[makeModel].start =
                                                                                Math.min(groups[makeModel].start,
                                                                                startYear);
                                                                                groups[makeModel].end =
                                                                                Math.max(groups[makeModel].end,
                                                                                endYear);
                                                                                }
                                                                                } else {
                                                                                if (!groups[vi]) groups[vi] = { start:
                                                                                null, end: null };
                                                                                }
                                                                                });
                                                                                const grouped =
                                                                                Object.entries(groups).map(([name,
                                                                                range]) => ({
                                                                                name,
                                                                                years: range.start ? (range.start ===
                                                                                range.end ? `${range.start}` :
                                                                                `${range.start}-${range.end}`) : ''
                                                                                }));

                                                                                const displayGroups = grouped.slice(0,
                                                                                2);
                                                                                const moreCount = grouped.length - 2;

                                                                                const firstVehicle = vehicleItems[0] ||
                                                                                null;

                                                                                // Get ASIN and Image URL
                                                                                const asinEntry = typeof asinData !==
                                                                                'undefined' && asinData.products_by_fcc
                                                                                ? asinData.products_by_fcc[fccId] :
                                                                                null;
                                                                                const primaryAsin = asinEntry ?
                                                                                asinEntry.primary_asin : null;

                                                                                const amazonLink = primaryAsin
                                                                                ?
                                                                                `https://www.amazon.com/dp/${primaryAsin}?tag=${AFFILIATE_TAG}`
                                                                                : getAmazonLink(fccId, firstVehicle,
                                                                                oemPart, primaryMake);

                                                                                let imageUrl = null;
                                                                                if (r.has_image) {
                                                                                imageUrl =
                                                                                `${API}/api/assets/${fccId}.png`;
                                                                                } else if (primaryAsin) {
                                                                                imageUrl =
                                                                                `https://ws-na.amazon-adsystem.com/widgets/q?_encoding=UTF8&ASIN=${primaryAsin}&Format=_SL160_&ID=AsinImage&MarketPlace=US&ServiceVersion=20070822&WS=1`;
                                                                                }

                                                                                let highlightedVehiclesHtml =
                                                                                displayGroups.map(g => {
                                                                                let name = g.name;
                                                                                if (searchText) {
                                                                                const regex = new
                                                                                RegExp(`(${searchText})`, 'gi');
                                                                                name = name.replace(regex, '<mark
                                                                                    style="background: var(--brand-primary); color: #000; padding: 0 2px; border-radius: 2px;">$1</mark>');
                                                                                }
                                                                                return `<span class="vehicle-group-chip"
                                                                                    style="font-size: 0.75rem; padding: 3px 8px; margin: 0 2px 2px 0;">
                                                                                    <span
                                                                                        class="vehicle-group-make">${name}</span>
                                                                                    ${g.years ? `<span
                                                                                        class="vehicle-group-years">(${g.years})</span>`
                                                                                    : ''}
                                                                                </span>`;
                                                                                }).join('');

                                                                                const moreLink = moreCount > 0
                                                                                ? `<br><a href="#"
                                                                                    onclick="showFccModal('${fccId}'); return false;"
                                                                                    style="color: var(--brand-primary); font-size: 0.75rem;">+${moreCount}
                                                                                    more groups</a>`
                                                                                : '';

                                                                                return `
                                                                                <tr>
                                                                                    <td style="min-width: 100px;">
                                                                                        <div
                                                                                            style="display: flex; align-items: center; gap: 10px;">
                                                                                            ${imageUrl ? `
                                                                                            <a href="${amazonLink}"
                                                                                                target="_blank"
                                                                                                style="display: block; width: 40px; height: 40px; background: var(--bg-tertiary); border-radius: 6px; border: 1px solid var(--border); overflow: hidden; flex-shrink: 0;">
                                                                                                <img src="${imageUrl}"
                                                                                                    style="width: 100%; height: 100%; object-fit: contain;"
                                                                                                    onerror="this.style.display='none'">
                                                                                            </a>
                                                                                            ` : ''}
                                                                                            <a href="#" class="fcc-link"
                                                                                                onclick="showFccModal('${fccId}'); return false;">${fccId}</a>
                                                                                        </div>
                                                                                    </td>
                                                                                    <td style="font-size: 0.85rem;">
                                                                                        ${oemPart ? `<a
                                                                                            href="${amazonLink}"
                                                                                            target="_blank"
                                                                                            style="color: var(--brand-primary);">${oemPart}</a>`
                                                                                        : '<span
                                                                                            style="color: var(--text-muted);">-</span>'}
                                                                                        <div style="margin-top: 4px;">
                                                                                            ${getKeyTypeBadge(r)}
                                                                                        </div>
                                                                                    </td>
                                                                                    <td
                                                                                        style="max-width: 350px; line-height: 1.4;">
                                                                                        ${highlightedVehiclesHtml}${moreLink}
                                                                                    </td>
                                                                                    <td class="hide-mobile">
                                                                                        ${freq}${freq !== 'N/A' &&
                                                                                        !String(freq).includes('Hz') ? '
                                                                                        MHz' : ''}</td>
                                                                                    <td class="hide-mobile">${chip}</td>
                                                                                    <td>
                                                                                        <div
                                                                                            style="display: flex; gap: 4px; align-items: center;">
                                                                                            <button
                                                                                                onclick="inventoryMinus('${fccId}', 'key')"
                                                                                                class="inv-btn"
                                                                                                title="Remove 1"
                                                                                                style="width: 24px; height: 24px; border-radius: 4px; border: none; background: var(--bg-secondary); color: var(--text-primary); cursor: pointer;">âˆ’</button>
                                                                                            <span
                                                                                                id="fcc-stock-${fccId}"
                                                                                                style="min-width: 20px; text-align: center; font-size: 0.85rem;">${InventoryManager.getKeyStock(fccId)}</span>
                                                                                            <button
                                                                                                onclick="fccInventoryAdd('${fccId}', '${(vehicles || '').replace(/'/g, "
                                                                                                \\'")}', '${amazonLink.replace(/'
                                                                                                /g, "\\'" )}')"
                                                                                                class="inv-btn"
                                                                                                title="Add 1"
                                                                                                style="width: 24px; height: 24px; border-radius: 4px; border: none; background: var(--brand-primary); color: var(--bg-primary); cursor: pointer; font-weight: bold;">+</button>
                                                                                        </div>
                                                                                    </td>
                                                                                    <td><a href="${amazonLink}"
                                                                                            target="_blank"
                                                                                            class="amazon-btn">ðŸ›’</a>
                                                                                    </td>
                                                                                </tr>
                                                                                `;
                                                                                }).join('');

                                                                                // Also render mobile cards
                                                                                const cardsContainer =
                                                                                document.getElementById('fccCards');
                                                                                if (pageData.length === 0) {
                                                                                cardsContainer.innerHTML = '<div
                                                                                    class="loading"
                                                                                    style="text-align: center; padding: 40px; color: var(--text-muted);">
                                                                                    No FCC IDs found</div>';
                                                                                } else {
                                                                                cardsContainer.innerHTML =
                                                                                pageData.map(r => {
                                                                                const fccId = r.fcc_id || 'N/A';
                                                                                const vehicles = r.vehicles || '';
                                                                                const freq = r.frequency || 'N/A';
                                                                                const chip = r.chip || 'N/A';
                                                                                const oemPart = r.primary_oem_part ||
                                                                                null;
                                                                                const primaryMake = r.primary_make ||
                                                                                null;

                                                                                // Parse and group vehicles to avoid
                                                                                long lists
                                                                                const vehicleListHtml =
                                                                                renderVehicleChips(vehicles, fccId, 5);
                                                                                const firstVehicle = vehicles ?
                                                                                vehicles.split(',')[0].split('(')[0].trim()
                                                                                : null;
                                                                                const amazonLink = getAmazonLink(fccId,
                                                                                firstVehicle, oemPart, primaryMake);

                                                                                // Get ASIN and Image URL
                                                                                const asinEntry = typeof asinData !==
                                                                                'undefined' && asinData.products_by_fcc
                                                                                ? asinData.products_by_fcc[fccId] :
                                                                                null;
                                                                                const primaryAsin = asinEntry ?
                                                                                asinEntry.primary_asin : null;
                                                                                const imageUrl = primaryAsin
                                                                                ?
                                                                                `https://ws-na.amazon-adsystem.com/widgets/q?_encoding=UTF8&ASIN=${primaryAsin}&Format=_SL160_&ID=AsinImage&MarketPlace=US&ServiceVersion=20070822&WS=1`
                                                                                : null;

                                                                                // Check for guide
                                                                                const vehicleArray = vehicles !== 'N/A'
                                                                                ? vehicles.split(',').map(v =>
                                                                                v.trim()).filter(v => v) : [];
                                                                                const guideKey =
                                                                                findProgrammingGuide(vehicleArray);


                                                                                return `
                                                                                <div class="fcc-card">
                                                                                    <div class="fcc-card-header">
                                                                                        <span class="fcc-id-badge"
                                                                                            onclick="showFccModal('${fccId}')">ðŸ”‘
                                                                                            ${fccId}</span>
                                                                                        ${oemPart ? `<span
                                                                                            class="fcc-oem">${oemPart}</span>`
                                                                                        : ''}
                                                                                        ${getKeyTypeBadge(r, true)}
                                                                                    </div>

                                                                                    ${imageUrl ? `
                                                                                    <div class="fcc-card-image"
                                                                                        onclick="showFccModal('${fccId}')">
                                                                                        <img src="${imageUrl}"
                                                                                            alt="${fccId}"
                                                                                            onerror="this.parentElement.style.display='none'">
                                                                                    </div>
                                                                                    ` : ''}

                                                                                    <div class="fcc-vehicles">
                                                                                        ${vehicleListHtml}
                                                                                    </div>

                                                                                    <div class="fcc-card-meta">
                                                                                        ${freq !== 'N/A' ? `<div
                                                                                            class="fcc-meta-item">
                                                                                            <span>ðŸ“¡</span><span>${freq}${!String(freq).includes('Hz')
                                                                                                ? ' MHz' : ''}</span>
                                                                                        </div>` : ''}
                                                                                        ${chip !== 'N/A' ? `<div
                                                                                            class="fcc-meta-item">
                                                                                            <span>ðŸ”</span><span>${chip}</span>
                                                                                        </div>` : ''}
                                                                                    </div>

                                                                                    <div class="fcc-card-actions">
                                                                                        <a href="${amazonLink}"
                                                                                            target="_blank"
                                                                                            class="fcc-action-btn fcc-action-primary">ðŸ›’
                                                                                            Buy on Amazon</a>
                                                                                        <button
                                                                                            onclick="showFccModal('${fccId}')"
                                                                                            class="fcc-action-btn fcc-action-secondary">ðŸ”
                                                                                            View Details</button>
                                                                                        ${guideKey ? `<button
                                                                                            onclick="openProgrammingGuide('${guideKey}')"
                                                                                            class="fcc-action-btn fcc-action-secondary"
                                                                                            style="background: rgba(59, 130, 246, 0.1); color: #3b82f6; border: 1px solid rgba(59, 130, 246, 0.3);">ðŸ“˜
                                                                                            Guide</button>` : ''}
                                                                                    </div>

                                                                                </div>
                                                                                `;
                                                                                }).join('');
                                                                                }

                                                                                // Pagination
                                                                                document.getElementById('fccPagination').innerHTML
                                                                                = `
                                                                                <button onclick="fccPrev()"
                                                                                    ${fccPage===1 ? 'disabled' : '' }>â†
                                                                                    Prev</button>
                                                                                <span class="page-info">Page ${fccPage}
                                                                                    of ${totalPages} (${filtered.length}
                                                                                    results)</span>
                                                                                <button onclick="fccNext()" ${fccPage>=
                                                                                    totalPages ? 'disabled' : ''}>Next
                                                                                    â†’</button>
                                                                                `;
                                                                                }


                                                                                function
                                                                                findProgrammingGuide(vehicleItems) {
                                                                                if (typeof PROGRAMMING_GUIDES_DATA ===
                                                                                'undefined') return null;
                                                                                const guideKeys =
                                                                                Object.keys(PROGRAMMING_GUIDES_DATA);

                                                                                for (const item of vehicleItems) {
                                                                                // normalize item: "Ford F-150
                                                                                (2015-2020)" -> "ford f-150"
                                                                                const itemLower = item.toLowerCase();

                                                                                for (const key of guideKeys) {
                                                                                // normalize key: "Ford F-150
                                                                                (2015-2020)" -> "ford f-150"
                                                                                // checking if the vehicle string
                                                                                contains the make/model from the guide
                                                                                key
                                                                                // This is a heuristic. A robust
                                                                                solution matches parsed Make/Model/Year.
                                                                                // For now, if the names match closely
                                                                                enough.
                                                                                const keyLower = key.toLowerCase();

                                                                                // Direct match check
                                                                                if
                                                                                (itemLower.includes(keyLower.split('(')[0].trim())
                                                                                ||
                                                                                keyLower.includes(itemLower.split('(')[0].trim()))
                                                                                {
                                                                                // Check overlap? No, assume relevant
                                                                                for now.
                                                                                // But we should prioritize exact
                                                                                matches or verify make/model.
                                                                                // Let's just return the key if it looks
                                                                                relevant.
                                                                                // Optimization: check specific common
                                                                                phrases
                                                                                return key;
                                                                                }
                                                                                }
                                                                                }
                                                                                return null;
                                                                                }

                                                                                function openProgrammingGuide(key) {
                                                                                const guide =
                                                                                PROGRAMMING_GUIDES_DATA[key];
                                                                                if (!guide) return;

                                                                                document.getElementById('guideModalTitle').textContent
                                                                                = key;
                                                                                const body =
                                                                                document.getElementById('guideModalBody');

                                                                                // Convert markdown-like syntax to HTML
                                                                                const formatText = (text) => {
                                                                                return text
                                                                                .replace(/\*\*(.*?)\*\*/g,
                                                                                '<strong>$1</strong>')
                                                                                .replace(/\n/g, '<br>');
                                                                                };

                                                                                body.innerHTML = `
                                                                                <div class="guide-section">
                                                                                    <h3
                                                                                        style="color: var(--brand-primary); margin-bottom: 8px;">
                                                                                        Overview</h3>
                                                                                    <p>${formatText(guide.overview)}</p>
                                                                                </div>
                                                                                <div class="guide-section"
                                                                                    style="margin-top: 20px;">
                                                                                    <h3
                                                                                        style="color: var(--brand-primary); margin-bottom: 8px;">
                                                                                        Preparation</h3>
                                                                                    <p>${formatText(guide.preparation)}
                                                                                    </p>
                                                                                </div>
                                                                                <div class="guide-section"
                                                                                    style="margin-top: 20px;">
                                                                                    <h3
                                                                                        style="color: var(--brand-primary); margin-bottom: 8px;">
                                                                                        Procedure</h3>
                                                                                    <p>${formatText(guide.procedure)}
                                                                                    </p>
                                                                                </div>
                                                                                <div class="guide-section"
                                                                                    style="margin-top: 20px; background: rgba(251, 191, 36, 0.1); padding: 15px; border-radius: 8px; border-left: 4px solid var(--brand-secondary);">
                                                                                    <h3
                                                                                        style="color: var(--brand-secondary); margin-bottom: 8px;">
                                                                                        Notes</h3>
                                                                                    <p>${formatText(guide.notes)}</p>
                                                                                </div>
                                                                                `;

                                                                                document.getElementById('guideModal').style.display
                                                                                = 'flex';
                                                                                }

                                                                                function closeGuideModal() {
                                                                                document.getElementById('guideModal').style.display
                                                                                = 'none';
                                                                                }

                                                                                function fccPrev() {
                                                                                if (fccPage > 1) {
                                                                                fccPage--;
                                                                                renderFccTable();
                                                                                }
                                                                                }


                                                                                function fccNext() {
                                                                                fccPage++;
                                                                                renderFccTable();
                                                                                }

                                                                                // ================== AMAZON AFFILIATE
                                                                                LINK ==================

                                                                                // Navigate to FCC Database and search
                                                                                for specific FCC ID
                                                                                function searchFccById(fccId) {
                                                                                showTab('fcc');
                                                                                document.getElementById('fccSearch').value
                                                                                = fccId;
                                                                                fccPage = 1;
                                                                                if (fccDataLoaded) {
                                                                                renderFccTable();
                                                                                } else {
                                                                                loadFccData();
                                                                                }
                                                                                }

                                                                                // Show FCC ID detail modal with all OEM
                                                                                parts and product images
                                                                                async function showFccModal(fccId) {
                                                                                const modalBody =
                                                                                document.getElementById('fccModalBody');
                                                                                modalBody.innerHTML = '<div
                                                                                    class="loading">Loading FCC
                                                                                    details...</div>';
                                                                                document.getElementById('fccModal').style.display
                                                                                = 'flex';
                                                                                document.body.style.overflow = 'hidden';

                                                                                try {
                                                                                // Fetch detailed OEM parts from API
                                                                                const response = await
                                                                                fetch(`${API_BASE}/fcc-detail/${encodeURIComponent(fccId)}`);
                                                                                const data = await response.json();

                                                                                if (data.error) throw new
                                                                                Error(data.error);

                                                                                const fccInfo = data.fcc_info || {};
                                                                                const oemParts = data.oem_parts || [];
                                                                                const totalVehicles =
                                                                                data.total_vehicles || 0;

                                                                                // Build OEM parts cards with product
                                                                                images
                                                                                const oemCardsHtml = oemParts.length > 0
                                                                                ? oemParts.map(part => {
                                                                                const asin = part.amazon_asin;
                                                                                const oem = part.oem_part_number ||
                                                                                'Unknown';
                                                                                const vehicles = part.vehicles || [];

                                                                                // Generate specific link for this part
                                                                                // If ASIN exists, link directly. Else
                                                                                search by OEM.
                                                                                const partLink = asin
                                                                                ?
                                                                                `https://www.amazon.com/dp/${asin}?tag=${AFFILIATE_TAG}`
                                                                                : getAmazonLink(fccId, null, oem, null);

                                                                                // Prioritize R2 image if available,
                                                                                then Amazon
                                                                                const hasRemoteImage = part.has_image
                                                                                === 1 || part.has_image === true;

                                                                                let imageUrl = null;
                                                                                if (hasRemoteImage) {
                                                                                imageUrl =
                                                                                `${API}/api/assets/${fccId}.png`;
                                                                                } else if (asin) {
                                                                                imageUrl =
                                                                                `https://ws-na.amazon-adsystem.com/widgets/q?_encoding=UTF8&ASIN=${asin}&Format=_SL160_&ID=AsinImage&MarketPlace=US&ServiceVersion=20070822&WS=1`;
                                                                                }

                                                                                // Group vehicles for this OEM part
                                                                                const vehicleItems = vehicles.map(v =>
                                                                                `${v.make} ${v.model}
                                                                                (${v.year_start}-${v.year_end})`);

                                                                                const vehicleListHtml =
                                                                                renderVehicleChips(vehicleItems.join(',
                                                                                '), null, 8);

                                                                                return `
                                                                                <div class="oem-product-card"
                                                                                    style="display: flex; gap: 12px; padding: 12px; background: var(--bg-tertiary); border-radius: 10px; margin-bottom: 10px; flex-direction: column;">
                                                                                    <div
                                                                                        style="display: flex; gap: 12px;">
                                                                                        <a href="${partLink}"
                                                                                            target="_blank"
                                                                                            style="flex-shrink: 0;">
                                                                                            <div
                                                                                                style="width: 80px; height: 80px; background: var(--bg-secondary); border-radius: 8px; display: flex; align-items: center; justify-content: center; overflow: hidden; border: 1px solid var(--border);">
                                                                                                ${imageUrl
                                                                                                ? `<img
                                                                                                    src="${imageUrl}"
                                                                                                    alt="${oem}"
                                                                                                    style="max-width: 100%; max-height: 100%; object-fit: contain;"
                                                                                                    onerror="this.style.display='none'; this.parentElement.innerHTML='<span style=\\'font-size: 2rem;\\'>ðŸ”‘</span>';" />`
                                                                                                : '<span
                                                                                                    style="font-size: 2rem;">ðŸ”‘</span>'
                                                                                                }
                                                                                            </div>
                                                                                        </a>
                                                                                        <div
                                                                                            style="flex: 1; min-width: 0;">
                                                                                            <div
                                                                                                style="font-weight: 600; color: var(--brand-primary); margin-bottom: 4px; display: flex; align-items: center; gap: 8px;">
                                                                                                <a href="${partLink}"
                                                                                                    target="_blank"
                                                                                                    style="color: inherit; text-decoration: none;">${oem}</a>
                                                                                                ${asin ? '<span
                                                                                                    style="font-size: 0.65rem; background: #28a745; color: white; padding: 2px 6px; border-radius: 4px;">BEST
                                                                                                    MATCH</span>' : ''}
                                                                                            </div>
                                                                                            <div
                                                                                                style="margin-top: 8px;">
                                                                                                <a href="${partLink}"
                                                                                                    target="_blank"
                                                                                                    class="amazon-btn"
                                                                                                    style="font-size: 0.75rem; padding: 6px 12px; display: inline-flex;">
                                                                                                    ðŸ›’ ${asin ? 'Buy on
                                                                                                    Amazon' : 'Search
                                                                                                    Amazon'}
                                                                                                </a>
                                                                                            </div>
                                                                                        </div>
                                                                                    </div>
                                                                                    <div
                                                                                        style="margin-top: 8px; border-top: 1px solid var(--border); padding-top: 10px;">
                                                                                        <div
                                                                                            style="font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 8px; letter-spacing: 0.5px;">
                                                                                            Compatible Vehicles</div>
                                                                                        <div
                                                                                            style="display: flex; flex-wrap: wrap; gap: 4px;">
                                                                                            ${vehicleListHtml}
                                                                                        </div>
                                                                                    </div>
                                                                                </div>
                                                                                `;
                                                                                }).join('') : '<p
                                                                                    style="color: var(--text-muted);">No
                                                                                    OEM parts found</p>';

                                                                                // Get primary item key for inventory
                                                                                (prefer OEM part, fallback to FCC ID)
                                                                                const primaryItemKey = oemParts.length >
                                                                                0 && oemParts[0].oem_part_number !==
                                                                                'unknown'
                                                                                ? oemParts[0].oem_part_number
                                                                                : fccId;

                                                                                modalBody.innerHTML = `
                                                                                <div class="modal-header-premium"
                                                                                    style="margin-bottom: 24px;">
                                                                                    <div class="modal-title"
                                                                                        style="font-size: 1.75rem; font-weight: 800; background: linear-gradient(135deg, var(--brand-primary), #f59e0b); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 8px;">
                                                                                        FCC ID: ${fccId}</div>
                                                                                    <div class="modal-subtitle"
                                                                                        style="font-size: 1rem; color: var(--text-secondary); font-weight: 500;">
                                                                                        <span
                                                                                            style="display: inline-flex; align-items: center; gap: 4px;">ðŸ“¦
                                                                                            ${oemParts.length} OEM
                                                                                            Parts</span>
                                                                                        <span
                                                                                            style="color: var(--text-muted); margin: 0 8px;">â€¢</span>
                                                                                        <span
                                                                                            style="display: inline-flex; align-items: center; gap: 4px;">ðŸš—
                                                                                            ${totalVehicles}
                                                                                            Vehicles</span>
                                                                                    </div>
                                                                                </div>

                                                                                <div
                                                                                    style="background: rgba(255, 255, 255, 0.03); border: 1px solid var(--border); border-radius: 16px; padding: 20px; margin-bottom: 24px; backdrop-filter: blur(10px);">
                                                                                    ${getInventoryControlsHtml(primaryItemKey)}
                                                                                </div>

                                                                                <div class="modal-info"
                                                                                    style="margin-bottom: 16px; margin-top: 16px;">
                                                                                    <div class="modal-info-item">
                                                                                        <div class="modal-info-label">
                                                                                            Frequency</div>
                                                                                        <div class="modal-info-value">
                                                                                            ${fccInfo.frequency ||
                                                                                            'N/A'}</div>
                                                                                    </div>
                                                                                    <div class="modal-info-item">
                                                                                        <div class="modal-info-label">
                                                                                            Battery</div>
                                                                                        <div class="modal-info-value">
                                                                                            ${fccInfo.battery || 'N/A'}
                                                                                        </div>
                                                                                    </div>
                                                                                    <div class="modal-info-item">
                                                                                        <div class="modal-info-label">
                                                                                            Buttons</div>
                                                                                        <div class="modal-info-value">
                                                                                            ${fccInfo.buttons || 'N/A'}
                                                                                        </div>
                                                                                    </div>
                                                                                </div>

                                                                                <div
                                                                                    style="font-weight: 600; margin-bottom: 8px; color: var(--text-primary);">
                                                                                    OEM Parts & Products</div>
                                                                                ${oemCardsHtml}
                                                                                `;

                                                                                } catch (err) {
                                                                                console.error('Error loading FCC
                                                                                detail:', err);
                                                                                // Fallback to basic display from cached
                                                                                data
                                                                                const record = fccData.find(r =>
                                                                                r.fcc_id === fccId);
                                                                                if (record) {
                                                                                const vehicles = record.vehicles ||
                                                                                'N/A';
                                                                                const oemPart = record.primary_oem_part
                                                                                || null;
                                                                                const primaryMake = record.primary_make
                                                                                || null;

                                                                                const vehicleListHtml =
                                                                                renderVehicleChips(vehicles, null, 15);

                                                                                // Extract first vehicle from the
                                                                                vehicles string
                                                                                const vehicleParts = vehicles !== 'N/A'
                                                                                ? vehicles.split(',').map(v =>
                                                                                v.trim()).filter(v => v) : [];
                                                                                const firstVehicle = vehicleParts.length
                                                                                > 0 ?
                                                                                vehicleParts[0].replace(/\s*\(\d{4}(-\d{4})?\)$/,
                                                                                '') : null;
                                                                                const amazonLink = getAmazonLink(fccId,
                                                                                firstVehicle, oemPart, primaryMake);

                                                                                // Determine if this is a mechanical key
                                                                                blank or FCC ID
                                                                                const isKeyBlankRef =
                                                                                fccId.toUpperCase().startsWith('ILCO')
                                                                                ||
                                                                                fccId.toUpperCase().startsWith('SILCA')
                                                                                ||
                                                                                fccId.toUpperCase().startsWith('STRATTEC');
                                                                                const idLabel = isKeyBlankRef ? 'Key
                                                                                Blank Ref' : 'FCC ID';

                                                                                modalBody.innerHTML = `
                                                                                <div class="modal-header-premium"
                                                                                    style="margin-bottom: 24px;">
                                                                                    <div class="modal-title"
                                                                                        style="font-size: 1.75rem; font-weight: 800; background: linear-gradient(135deg, var(--brand-primary), #f59e0b); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 8px;">
                                                                                        ${idLabel}: ${fccId}</div>
                                                                                    <div class="modal-subtitle"
                                                                                        style="font-size: 1rem; color: var(--text-secondary);">
                                                                                        Limited details available</div>
                                                                                </div>

                                                                                <div
                                                                                    style="background: rgba(255, 255, 255, 0.03); border: 1px solid var(--border); border-radius: 16px; padding: 20px; margin-bottom: 24px;">
                                                                                    ${getInventoryControlsHtml(fccId)}
                                                                                </div>

                                                                                <div
                                                                                    style="font-weight: 600; margin-bottom: 8px; color: var(--text-primary);">
                                                                                    Compatible Vehicles</div>
                                                                                <div
                                                                                    style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 24px;">
                                                                                    ${vehicleListHtml}
                                                                                </div>

                                                                                <a href="${amazonLink}" target="_blank"
                                                                                    class="modal-amazon">ðŸ›’ Search on
                                                                                    Amazon</a>
                                                                                `;
                                                                                } else {
                                                                                modalBody.innerHTML = '<p
                                                                                    style="color: var(--text-muted);">
                                                                                    Error loading FCC details</p>';
                                                                                }
                                                                                }
                                                                                }

                                                                                // Combine vehicle entries with
                                                                                consecutive years into ranges
                                                                                function
                                                                                combineVehicleYears(vehicleArray) {
                                                                                // Group vehicles by make/model (without
                                                                                year range)
                                                                                const vehicleGroups = new Map();

                                                                                vehicleArray.forEach(vehicle => {
                                                                                // Parse format like "Hyundai Genesis
                                                                                G80 (2017-2017)"
                                                                                const match =
                                                                                vehicle.match(/^(.+?)\s*\((\d{4})-(\d{4})\)$/);
                                                                                if (match) {
                                                                                const [, name, startYear, endYear] =
                                                                                match;
                                                                                const key = name.trim();
                                                                                if (!vehicleGroups.has(key)) {
                                                                                vehicleGroups.set(key, []);
                                                                                }
                                                                                vehicleGroups.get(key).push({
                                                                                start: parseInt(startYear),
                                                                                end: parseInt(endYear)
                                                                                });
                                                                                } else {
                                                                                // No year range, keep as-is
                                                                                vehicleGroups.set(vehicle, null);
                                                                                }
                                                                                });

                                                                                // Combine year ranges for each vehicle
                                                                                const result = [];
                                                                                vehicleGroups.forEach((years, name) => {
                                                                                if (years === null) {
                                                                                result.push(name);
                                                                                } else if (years.length === 1) {
                                                                                const { start, end } = years[0];
                                                                                result.push(start === end ? `${name}
                                                                                (${start})` : `${name}
                                                                                (${start}-${end})`);
                                                                                } else {
                                                                                // Sort by start year and merge
                                                                                overlapping/consecutive ranges
                                                                                years.sort((a, b) => a.start - b.start);
                                                                                const merged = [years[0]];
                                                                                for (let i = 1; i < years.length; i++) {
                                                                                    const last=merged[merged.length -
                                                                                    1]; const curr=years[i]; if
                                                                                    (curr.start <=last.end + 1) { //
                                                                                    Merge ranges
                                                                                    last.end=Math.max(last.end,
                                                                                    curr.end); } else {
                                                                                    merged.push(curr); } } // Format
                                                                                    merged ranges const
                                                                                    rangeStrs=merged.map(r=> r.start ===
                                                                                    r.end ? `${r.start}` :
                                                                                    `${r.start}-${r.end}`);
                                                                                    result.push(`${name}
                                                                                    (${rangeStrs.join(', ')})`);
                                                                                    }
                                                                                    });

                                                                                    return result;
                                                                                    }

                                                                                    // Subscription Management
                                                                                    let isPro = false;

                                                                                    async function checkSubscription() {
                                                                                    if (!currentUser) return;

                                                                                    try {
                                                                                    // Check local cache first to avoid
                                                                                    delay
                                                                                    const localStatus =
                                                                                    localStorage.getItem('eurokeys_subscription');
                                                                                    if (localStatus) {
                                                                                    const data =
                                                                                    JSON.parse(localStatus);
                                                                                    if (data.userId === currentUser.sub
                                                                                    && data.expiresAt > Date.now() /
                                                                                    1000) {
                                                                                    isPro = true;
                                                                                    updateProUI();
                                                                                    // Don't return, verify with server
                                                                                    in background
                                                                                    }
                                                                                    }

                                                                                    const res = await
                                                                                    fetch(`${API}/api/subscription-status?userId=${currentUser.sub}`);
                                                                                    const data = await res.json();

                                                                                    isPro = data.isPro ||
                                                                                    (data.trial_until &&
                                                                                    data.trial_until > Date.now());

                                                                                    // Cache status
                                                                                    if (isPro) {
                                                                                    localStorage.setItem('eurokeys_subscription',
                                                                                    JSON.stringify({
                                                                                    userId: currentUser.sub,
                                                                                    expiresAt: data.expiresAt,
                                                                                    trialUntil: data.trial_until
                                                                                    }));
                                                                                    } else {
                                                                                    localStorage.removeItem('eurokeys_subscription');
                                                                                    }

                                                                                    updateProUI();
                                                                                    } catch (err) {
                                                                                    console.error('Subscription check
                                                                                    failed:', err);
                                                                                    }
                                                                                    }

                                                                                    function updateProUI() {
                                                                                    const userMenu =
                                                                                    document.getElementById('userMenu');
                                                                                    if (!userMenu) return;

                                                                                    // Remove existing elements to
                                                                                    prevent duplicates
                                                                                    const existingBtn =
                                                                                    document.getElementById('headerUpgradeBtn');
                                                                                    if (existingBtn)
                                                                                    existingBtn.remove();
                                                                                    const existingBadges =
                                                                                    document.querySelectorAll('.pro-badge');
                                                                                    existingBadges.forEach(b =>
                                                                                    b.remove());

                                                                                    if (isPro) {
                                                                                    const userName =
                                                                                    document.getElementById('userName');
                                                                                    if (userName) {
                                                                                    const badge =
                                                                                    document.createElement('span');
                                                                                    badge.className = 'pro-badge';

                                                                                    // Default PRO styling
                                                                                    let badgeText = 'PRO';
                                                                                    let badgeStyle = 'background:
                                                                                    #fbbf24; color: #000; font-size:
                                                                                    0.65rem; padding: 2px 6px;
                                                                                    border-radius: 4px; font-weight:
                                                                                    800; margin-left: 8px;
                                                                                    vertical-align: middle; box-shadow:
                                                                                    0 0 10px rgba(251, 191, 36, 0.4);';

                                                                                    // Add trial countdown if applicable
                                                                                    if (currentUser &&
                                                                                    currentUser.trial_until &&
                                                                                    !currentUser.is_pro) {
                                                                                    const daysLeft =
                                                                                    Math.ceil((currentUser.trial_until -
                                                                                    Date.now()) / (1000 * 60 * 60 *
                                                                                    24));
                                                                                    if (daysLeft > 0) {
                                                                                    badgeText = `PRO (Trial:
                                                                                    ${daysLeft}d)`;
                                                                                    badgeStyle = 'background:
                                                                                    linear-gradient(135deg, #fbbf24,
                                                                                    #f59e0b); color: #000; font-size:
                                                                                    0.65rem; padding: 2px 8px;
                                                                                    border-radius: 4px; font-weight:
                                                                                    800; margin-left: 8px;
                                                                                    vertical-align: middle; box-shadow:
                                                                                    0 0 10px rgba(251, 191, 36, 0.4);';
                                                                                    }
                                                                                    }

                                                                                    badge.innerHTML = badgeText;
                                                                                    badge.style.cssText = badgeStyle;
                                                                                    userName.appendChild(badge);
                                                                                    }
                                                                                    } else {
                                                                                    const btn =
                                                                                    document.createElement('button');
                                                                                    btn.id = 'headerUpgradeBtn';
                                                                                    btn.innerText = 'Upgrade';
                                                                                    btn.style.cssText = 'background:
                                                                                    linear-gradient(135deg, #fbbf24,
                                                                                    #f59e0b); color: #000; border: none;
                                                                                    padding: 6px 16px; border-radius:
                                                                                    20px; font-weight: 700; font-size:
                                                                                    0.85rem; cursor: pointer;
                                                                                    margin-right: 12px; transition:
                                                                                    transform 0.2s;';
                                                                                    btn.onmouseover = () =>
                                                                                    btn.style.transform = 'scale(1.05)';
                                                                                    btn.onmouseout = () =>
                                                                                    btn.style.transform = 'scale(1)';
                                                                                    btn.onclick = openUpgradeModal;

                                                                                    const avatar =
                                                                                    document.getElementById('userAvatar');
                                                                                    if (avatar) {
                                                                                    userMenu.insertBefore(btn, avatar);
                                                                                    } else {
                                                                                    userMenu.appendChild(btn);
                                                                                    }
                                                                                    }

                                                                                    // Tabs are always visible (site is
                                                                                    100% functional)
                                                                                    // Premium actions within tabs will
                                                                                    prompt sign-up/upgrade as needed
                                                                                    const inventoryTab =
                                                                                    document.getElementById('inventoryTab');
                                                                                    const subscriptionsTab =
                                                                                    document.getElementById('subscriptionsTab');

                                                                                    if (inventoryTab)
                                                                                    inventoryTab.style.display =
                                                                                    'inline-flex';
                                                                                    if (subscriptionsTab)
                                                                                    subscriptionsTab.style.display =
                                                                                    'inline-flex';

                                                                                    // Refresh inventory view if open
                                                                                    if
                                                                                    (document.getElementById('tabInventory')?.style.display
                                                                                    === 'block') {
                                                                                    renderInventoryPage();
                                                                                    }
                                                                                    }

                                                                                    function openUpgradeModal() {
                                                                                    const modal =
                                                                                    document.getElementById('upgradeModal');
                                                                                    if (modal) {
                                                                                    modal.style.display = 'block';
                                                                                    } else {
                                                                                    // Fallback if modal doesn't exist
                                                                                    alert('Upgrade to Pro for inventory
                                                                                    features! Contact
                                                                                    support@eurokeys.app');
                                                                                    }
                                                                                    }

                                                                                    // Guide image lightbox modal
                                                                                    function
                                                                                    openGuideImageModal(imageUrl,
                                                                                    caption) {
                                                                                    let modal =
                                                                                    document.getElementById('guideImageModal');
                                                                                    if (!modal) {
                                                                                    modal =
                                                                                    document.createElement('div');
                                                                                    modal.id = 'guideImageModal';
                                                                                    modal.className =
                                                                                    'guide-image-modal';
                                                                                    modal.onclick = (e) => {
                                                                                    if (e.target === modal)
                                                                                    closeGuideImageModal();
                                                                                    };
                                                                                    document.body.appendChild(modal);
                                                                                    }

                                                                                    modal.innerHTML = `
                                                                                    <button class="modal-close"
                                                                                        onclick="closeGuideImageModal()">&times;</button>
                                                                                    <img src="${imageUrl}"
                                                                                        alt="${caption || 'Technical Diagram'}" />
                                                                                    <div class="modal-caption">${caption
                                                                                        || ''}</div>
                                                                                    `;
                                                                                    modal.classList.add('active');
                                                                                    document.body.style.overflow =
                                                                                    'hidden';
                                                                                    }

                                                                                    function closeGuideImageModal() {
                                                                                    const modal =
                                                                                    document.getElementById('guideImageModal');
                                                                                    if (modal) {
                                                                                    modal.classList.remove('active');
                                                                                    document.body.style.overflow = '';
                                                                                    }
                                                                                    }

                                                                                    // Soft paywall modal for anonymous
                                                                                    users (non-pushy sign-up prompt)
                                                                                    function openSignUpPaywall(feature =
                                                                                    'feature', context = '') {
                                                                                    // Create modal if it doesn't exist
                                                                                    let modal =
                                                                                    document.getElementById('signUpPaywallModal');
                                                                                    if (!modal) {
                                                                                    modal =
                                                                                    document.createElement('div');
                                                                                    modal.id = 'signUpPaywallModal';
                                                                                    modal.className = 'modal';
                                                                                    document.body.appendChild(modal);
                                                                                    }

                                                                                    const featureText = {
                                                                                    'guide': 'programming guides',
                                                                                    'inventory': 'inventory tracking',
                                                                                    'subscription': 'subscription
                                                                                    management'
                                                                                    }[feature] || 'premium features';

                                                                                    modal.innerHTML = `
                                                                                    <div class="modal-content"
                                                                                        style="max-width: 480px; text-align: center; background: linear-gradient(145deg, #1a1a2e 0%, #16213e 100%); border: 1px solid rgba(251, 191, 36, 0.3);">
                                                                                        <button class="modal-close"
                                                                                            onclick="closeSignUpPaywall()">&times;</button>
                                                                                        <div style="padding: 20px;">
                                                                                            <div
                                                                                                style="font-size: 3rem; margin-bottom: 16px;">
                                                                                                ðŸ”“</div>
                                                                                            <h2
                                                                                                style="color: #fbbf24; margin-bottom: 12px; font-size: 1.5rem;">
                                                                                                Unlock Full Access</h2>
                                                                                            <p
                                                                                                style="color: #a0aec0; margin-bottom: 20px; line-height: 1.6;">
                                                                                                You've used your
                                                                                                <strong>3 free
                                                                                                    ${featureText}</strong>
                                                                                                views.
                                                                                                ${context ? `<br><span
                                                                                                    style="color: #718096; font-size: 0.9rem;">Trying
                                                                                                    to view:
                                                                                                    ${context}</span>` :
                                                                                                ''}
                                                                                            </p>
                                                                                            <div
                                                                                                style="background: rgba(251, 191, 36, 0.1); border-radius: 12px; padding: 16px; margin-bottom: 20px; border: 1px solid rgba(251, 191, 36, 0.2);">
                                                                                                <div
                                                                                                    style="color: #fbbf24; font-weight: 700; font-size: 1.1rem; margin-bottom: 8px;">
                                                                                                    ðŸŽ 14-Day Free Trial
                                                                                                </div>
                                                                                                <p
                                                                                                    style="color: #e2e8f0; font-size: 0.9rem; margin: 0;">
                                                                                                    Sign up with Google
                                                                                                    to unlock unlimited
                                                                                                    ${featureText},
                                                                                                    cloud sync, and
                                                                                                    more.
                                                                                                </p>
                                                                                            </div>
                                                                                            <button
                                                                                                onclick="closeSignUpPaywall(); signInWithGoogle();"
                                                                                                style="background: linear-gradient(135deg, #fbbf24, #f59e0b); color: #000; border: none; 
                                       padding: 14px 32px; border-radius: 12px; font-weight: 700; font-size: 1rem; 
                                       cursor: pointer; width: 100%; transition: transform 0.2s, box-shadow 0.2s;
                                       box-shadow: 0 4px 15px rgba(251, 191, 36, 0.3);">
                                                                                                <span
                                                                                                    style="display: flex; align-items: center; justify-content: center; gap: 8px;">
                                                                                                    <svg width="20"
                                                                                                        height="20"
                                                                                                        viewBox="0 0 24 24">
                                                                                                        <path
                                                                                                            fill="currentColor"
                                                                                                            d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" />
                                                                                                        <path
                                                                                                            fill="currentColor"
                                                                                                            d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" />
                                                                                                        <path
                                                                                                            fill="currentColor"
                                                                                                            d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" />
                                                                                                        <path
                                                                                                            fill="currentColor"
                                                                                                            d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" />
                                                                                                    </svg>
                                                                                                    Sign Up with Google
                                                                                                </span>
                                                                                            </button>
                                                                                            <p
                                                                                                style="color: #718096; font-size: 0.8rem; margin-top: 16px;">
                                                                                                No credit card required
                                                                                                â€¢ Cancel anytime
                                                                                            </p>
                                                                                        </div>
                                                                                    </div>
                                                                                    `;
                                                                                    modal.style.display = 'flex';
                                                                                    }

                                                                                    function closeSignUpPaywall() {
                                                                                    const modal =
                                                                                    document.getElementById('signUpPaywallModal');
                                                                                    if (modal) modal.style.display =
                                                                                    'none';
                                                                                    }

                                                                                    function closeUpgradeModal() {
                                                                                    const modal =
                                                                                    document.getElementById('upgradeModal');
                                                                                    if (modal) modal.style.display =
                                                                                    'none';
                                                                                    }

                                                                                    async function startCheckout(plan,
                                                                                    event) {
                                                                                    console.log('startCheckout called
                                                                                    with plan:', plan);

                                                                                    // Use window.event if event is not
                                                                                    passed (legacy)
                                                                                    const clickEvent = event ||
                                                                                    window.event;
                                                                                    const btn = clickEvent ?
                                                                                    clickEvent.currentTarget ||
                                                                                    clickEvent.target : null;

                                                                                    // Try to reload user from
                                                                                    localStorage if currentUser is null
                                                                                    if (!currentUser) {
                                                                                    const saved =
                                                                                    localStorage.getItem('eurokeys_user');
                                                                                    if (saved) {
                                                                                    try {
                                                                                    currentUser = JSON.parse(saved);
                                                                                    console.log('Restored currentUser
                                                                                    from localStorage for checkout');
                                                                                    } catch (e) { }
                                                                                    }
                                                                                    }

                                                                                    console.log('currentUser state:',
                                                                                    currentUser);

                                                                                    if (!currentUser ||
                                                                                    !currentUser.email ||
                                                                                    (!currentUser.sub &&
                                                                                    !currentUser.id)) {
                                                                                    console.warn('Incomplete user
                                                                                    session for checkout:',
                                                                                    currentUser);
                                                                                    alert('Please sign in (or sign out
                                                                                    and back in) to complete your
                                                                                    purchase.');
                                                                                    if (!currentUser)
                                                                                    google.accounts.id.prompt();
                                                                                    return;
                                                                                    }

                                                                                    const originalText = btn ?
                                                                                    btn.innerText : 'Redirecting...';
                                                                                    if (btn) {
                                                                                    btn.innerText = 'Redirecting...';
                                                                                    btn.disabled = true;
                                                                                    }

                                                                                    try {
                                                                                    const requestBody = {
                                                                                    userId: currentUser.sub ||
                                                                                    currentUser.id,
                                                                                    email: currentUser.email,
                                                                                    plan: plan
                                                                                    };
                                                                                    console.log('Sending checkout
                                                                                    request to:',
                                                                                    `${API}/api/create-checkout-session`);
                                                                                    console.log('Request body:',
                                                                                    requestBody);

                                                                                    const res = await
                                                                                    fetch(`${API}/api/create-checkout-session`,
                                                                                    {
                                                                                    method: 'POST',
                                                                                    headers: { 'Content-Type':
                                                                                    'application/json' },
                                                                                    credentials: 'include',
                                                                                    body: JSON.stringify(requestBody)
                                                                                    });

                                                                                    const data = await res.json();
                                                                                    if (data.url) {
                                                                                    window.location.href = data.url;
                                                                                    } else {
                                                                                    alert('Checkout failed: ' +
                                                                                    (data.error || 'Unknown error'));
                                                                                    btn.innerText = originalText;
                                                                                    btn.disabled = false;
                                                                                    }
                                                                                    } catch (err) {
                                                                                    console.error('Checkout error:',
                                                                                    err);
                                                                                    alert('Connection failed. Please try
                                                                                    again.');
                                                                                    btn.innerText = originalText;
                                                                                    btn.disabled = false;
                                                                                    }
                                                                                    }

                                                                                    // Restore purchases - re-check
                                                                                    subscription status
                                                                                    async function restorePurchases() {
                                                                                    if (!currentUser) {
                                                                                    alert('Please sign in first to
                                                                                    restore purchases.');
                                                                                    return;
                                                                                    }

                                                                                    try {
                                                                                    // Force refresh subscription status
                                                                                    from server
                                                                                    localStorage.removeItem('eurokeys_subscription');
                                                                                    const res = await
                                                                                    fetch(`${API}/api/subscription-status?userId=${currentUser.sub}`);
                                                                                    const data = await res.json();

                                                                                    isPro = data.isPro ||
                                                                                    (data.trial_until &&
                                                                                    data.trial_until > Date.now());
                                                                                    if (isPro) {
                                                                                    localStorage.setItem('eurokeys_subscription',
                                                                                    JSON.stringify({
                                                                                    userId: currentUser.sub,
                                                                                    expiresAt: data.expiresAt,
                                                                                    trialUntil: data.trial_until
                                                                                    }));
                                                                                    updateProUI();
                                                                                    closeUpgradeModal();
                                                                                    alert('âœ… Subscription restored
                                                                                    successfully! You now have Pro
                                                                                    access.');
                                                                                    } else {
                                                                                    alert('No active subscription found.
                                                                                    If you recently purchased, please
                                                                                    wait a few moments and try again.');
                                                                                    }
                                                                                    } catch (err) {
                                                                                    console.error('Restore failed:',
                                                                                    err);
                                                                                    alert('Failed to restore purchases.
                                                                                    Please try again or contact
                                                                                    support@eurokeys.app');
                                                                                    }
                                                                                    }

                                                                                    // Check for success param on load
                                                                                    window.addEventListener('load', ()
                                                                                    => {
                                                                                    loadAsinData(); // Load local ASIN
                                                                                    mapping
                                                                                    const urlParams = new
                                                                                    URLSearchParams(window.location.search);
                                                                                    if (urlParams.get('subscription')
                                                                                    === 'success') {
                                                                                    // Clear URL
                                                                                    window.history.replaceState({},
                                                                                    document.title,
                                                                                    window.location.pathname);
                                                                                    alert('ðŸŽ‰ Upgrade Successful! You
                                                                                    now have Pro access.');
                                                                                    if (currentUser)
                                                                                    checkSubscription();
                                                                                    }
                                                                                    });

                                                                                    function closeFccModal() {
                                                                                    document.getElementById('fccModal').style.display
                                                                                    = 'none';
                                                                                    document.body.style.overflow = '';
                                                                                    }

                                                                                    // Show key photos from FCC external
                                                                                    photos
                                                                                    // FCC External Photos Lookup Cache
                                                                                    let fccPhotosLookup = null;

                                                                                    async function loadFccPhotosLookup()
                                                                                    {
                                                                                    if (fccPhotosLookup) return
                                                                                    fccPhotosLookup;
                                                                                    try {
                                                                                    const response = await
                                                                                    fetch('data/fcc_external_photos.csv');
                                                                                    const text = await response.text();
                                                                                    const lines =
                                                                                    text.trim().split('\n');
                                                                                    fccPhotosLookup = {};
                                                                                    for (let i = 1; i < lines.length;
                                                                                        i++) { const [fccId, docId,
                                                                                        url]=lines[i].split(','); if
                                                                                        (fccId && url) {
                                                                                        fccPhotosLookup[fccId]=url; } }
                                                                                        console.log(`Loaded
                                                                                        ${Object.keys(fccPhotosLookup).length}
                                                                                        FCC photo URLs`); return
                                                                                        fccPhotosLookup; } catch (e) {
                                                                                        console.log('Could not load FCC
                                                                                        photos lookup:', e); return {};
                                                                                        } } async function
                                                                                        showKeyPhotos(fccId) { const
                                                                                        modalBody=document.getElementById('keyPhotosModalBody');
                                                                                        modalBody.innerHTML='<div class="loading">Loading key photos...</div>'
                                                                                        ;
                                                                                        document.getElementById('keyPhotosModal').style.display='flex'
                                                                                        ;
                                                                                        document.body.style.overflow='hidden'
                                                                                        ; // FCC report URLs const
                                                                                        fccReportUrl=`https://fcc.report/FCC-ID/${fccId}`;
                                                                                        let externalPhotosPdfUrl=null;
                                                                                        // First, try the pre-scraped
                                                                                        lookup table (fast!) const
                                                                                        lookup=await
                                                                                        loadFccPhotosLookup(); if
                                                                                        (lookup[fccId]) {
                                                                                        externalPhotosPdfUrl=lookup[fccId];
                                                                                        console.log(`Found FCC photos in
                                                                                        lookup:
                                                                                        ${externalPhotosPdfUrl}`); }
                                                                                        else { // Fallback to dynamic
                                                                                        fetching via CORS proxy
                                                                                        console.log(`FCC ID ${fccId} not
                                                                                        in lookup, trying dynamic
                                                                                        fetch...`); try { const
                                                                                        corsProxy='https://corsproxy.io/?'
                                                                                        ; const response=await
                                                                                        fetch(corsProxy +
                                                                                        encodeURIComponent(fccReportUrl));
                                                                                        const html=await
                                                                                        response.text(); const
                                                                                        parser=new DOMParser(); const
                                                                                        doc=parser.parseFromString(html, 'text/html'
                                                                                        ); for (const link of
                                                                                        doc.querySelectorAll('a')) { if
                                                                                        (link.textContent.toLowerCase().includes('external
                                                                                        photo')) { const
                                                                                        href=link.getAttribute('href');
                                                                                        if (href) {
                                                                                        externalPhotosPdfUrl='https://fcc.report'
                                                                                        + href + '.pdf' ; break; } } } }
                                                                                        catch (e) { console.log('Dynamic
                                                                                        fetch failed:', e); } }
                                                                                        modalBody.innerHTML=` <div
                                                                                        class="modal-title">ðŸ“· Key
                                                                                        Photos: ${fccId}</div>
                                                                                        <div class="modal-subtitle">
                                                                                            Official FCC external photos
                                                                                            document</div>

                                                                                        <div style="margin-top: 20px;">
                                                                                            <p
                                                                                                style="color: var(--text-muted); margin-bottom: 16px; font-size: 0.9rem;">
                                                                                                View the official FCC
                                                                                                external photos showing
                                                                                                key fob images and
                                                                                                configurations:
                                                                                            </p>

                                                                                            ${externalPhotosPdfUrl ? `
                                                                                            <a href="${externalPhotosPdfUrl}"
                                                                                                target="_blank"
                                                                                                class="fcc-link-card"
                                                                                                style="margin-bottom: 12px;">
                                                                                                <span
                                                                                                    style="font-size: 2.5rem; display: block; margin-bottom: 8px;">ðŸ“„</span>
                                                                                                <span
                                                                                                    style="color: var(--brand-primary); font-weight: 700; font-size: 1.1rem;">View
                                                                                                    External Photos PDF
                                                                                                    â†’</span>
                                                                                                <br>
                                                                                                <span
                                                                                                    style="color: var(--text-muted); font-size: 0.85rem;">Opens
                                                                                                    PDF with key fob
                                                                                                    images</span>
                                                                                            </a>
                                                                                            ` : `
                                                                                            <div class="fcc-link-card"
                                                                                                style="margin-bottom: 12px; opacity: 0.7;">
                                                                                                <span
                                                                                                    style="font-size: 2rem; display: block; margin-bottom: 8px;">âš ï¸</span>
                                                                                                <span
                                                                                                    style="color: var(--text-muted); font-weight: 600;">No
                                                                                                    external photos
                                                                                                    found</span>
                                                                                                <br>
                                                                                                <span
                                                                                                    style="color: var(--text-muted); font-size: 0.85rem;">Check
                                                                                                    the FCC report page
                                                                                                    below</span>
                                                                                            </div>
                                                                                            `}

                                                                                            <a href="${fccReportUrl}"
                                                                                                target="_blank"
                                                                                                class="fcc-link-card">
                                                                                                <span
                                                                                                    style="font-size: 2rem; display: block; margin-bottom: 8px;">ðŸ”</span>
                                                                                                <span
                                                                                                    style="color: var(--text-secondary); font-weight: 600;">View
                                                                                                    All FCC Documents
                                                                                                    â†’</span>
                                                                                                <br>
                                                                                                <span
                                                                                                    style="color: var(--text-muted); font-size: 0.85rem;">Internal
                                                                                                    photos, test
                                                                                                    reports,
                                                                                                    manuals</span>
                                                                                            </a>
                                                                                        </div>
                                                                                        `;
                                                                                        }

                                                                                        function closeKeyPhotosModal() {
                                                                                        document.getElementById('keyPhotosModal').style.display
                                                                                        = 'none';
                                                                                        document.body.style.overflow =
                                                                                        '';
                                                                                        }

                                                                                        function openLightbox(imgSrc) {
                                                                                        document.getElementById('lightboxImage').src
                                                                                        = imgSrc;
                                                                                        document.getElementById('photoLightbox').style.display
                                                                                        = 'flex';
                                                                                        }

                                                                                        function closeLightbox() {
                                                                                        document.getElementById('photoLightbox').style.display
                                                                                        = 'none';
                                                                                        }

                                                                                        function getAmazonLink(fccId,
                                                                                        vehicleInfo = null, oemPart =
                                                                                        null, make = null, keyType =
                                                                                        null) {
                                                                                        // Create Amazon search URL with
                                                                                        affiliate tag
                                                                                        // Priority: OEM part number >
                                                                                        make + key terms (sellers use
                                                                                        OEM parts, not FCC IDs)

                                                                                        // Detect mechanical keys: ILCO
                                                                                        codes are not real FCC IDs
                                                                                        const isMechanical = keyType ===
                                                                                        'mechanical' ||
                                                                                        (fccId &&
                                                                                        (fccId.toUpperCase().startsWith('ILCO')
                                                                                        ||
                                                                                        fccId.toUpperCase().startsWith('SILCA')
                                                                                        ||
                                                                                        fccId.toUpperCase().startsWith('STRATTEC')));

                                                                                        // Use different search suffix
                                                                                        for mechanical vs electronic
                                                                                        keys
                                                                                        const keySuffix = isMechanical ?
                                                                                        'key blank' : 'key fob remote';

                                                                                        let searchTerm;

                                                                                        if (oemPart && oemPart !==
                                                                                        'null') {
                                                                                        // Best match: OEM part number
                                                                                        (e.g., "68577124AB key fob")
                                                                                        const vehicleMake = make ||
                                                                                        (vehicleInfo ?
                                                                                        vehicleInfo.match(/^([A-Za-z]+)/)?.[1]
                                                                                        : '') || '';
                                                                                        searchTerm = `${vehicleMake}
                                                                                        ${oemPart} ${keySuffix}`.trim();
                                                                                        } else if (vehicleInfo) {
                                                                                        // Fallback: Extract make and
                                                                                        model from vehicle info
                                                                                        const makeMatch =
                                                                                        vehicleInfo.match(/^([A-Za-z]+)/);
                                                                                        const vehicleMake = makeMatch ?
                                                                                        makeMatch[1] : '';
                                                                                        const modelMatch =
                                                                                        vehicleInfo.match(/^[A-Za-z]+\s+([A-Za-z0-9\s]+)\s*\(/);
                                                                                        const vehicleModel = modelMatch
                                                                                        ? modelMatch[1].trim() : '';
                                                                                        searchTerm = `${vehicleMake}
                                                                                        ${vehicleModel}
                                                                                        ${keySuffix}`.trim();
                                                                                        } else if (make) {
                                                                                        // Use make with appropriate key
                                                                                        suffix
                                                                                        searchTerm = `${make}
                                                                                        ${keySuffix}`;
                                                                                        } else {
                                                                                        // Last resort: FCC ID (often
                                                                                        doesn't match well)
                                                                                        searchTerm = `${fccId}
                                                                                        ${keySuffix}`;
                                                                                        }
                                                                                        return
                                                                                        `https://www.amazon.com/s?k=${encodeURIComponent(searchTerm)}&tag=${AFFILIATE_TAG}`;
                                                                                        }

                                                                                        // ================== GOOGLE
                                                                                        OAUTH ==================

                                                                                        // Google OAuth Client ID
                                                                                        const GOOGLE_CLIENT_ID =
                                                                                        '1057439383868-t1h9qf10acvad82bv0h9gg2jeufg30v4.apps.googleusercontent.com';

                                                                                        let googleAuth = null;
                                                                                        let currentUser = null;
                                                                                        window.isAuthExpired = false; //
                                                                                        Global lock to stop console spam
                                                                                        on 401

                                                                                        async function initGoogleAuth()
                                                                                        {
                                                                                        // Initialize visitor ID for
                                                                                        anonymous tracking
                                                                                        getVisitorId();

                                                                                        // 1. Initial UI from
                                                                                        localStorage (for perceived
                                                                                        performance)
                                                                                        // BUT we validate the data
                                                                                        first to prevent ghost logins
                                                                                        const savedUser =
                                                                                        localStorage.getItem('eurokeys_user');
                                                                                        if (savedUser) {
                                                                                        try {
                                                                                        const parsed =
                                                                                        JSON.parse(savedUser);
                                                                                        // STRICT VALIDATION: Must have
                                                                                        email AND a real name (not
                                                                                        "User" placeholder)
                                                                                        const hasValidData =
                                                                                        parsed.email &&
                                                                                        parsed.email.includes('@') &&
                                                                                        parsed.name &&
                                                                                        parsed.name !== 'User' &&
                                                                                        parsed.name.length > 1 &&
                                                                                        (parsed.id || parsed.sub);
                                                                                        if (hasValidData) {
                                                                                        currentUser = parsed;
                                                                                        updateAuthUI(true);
                                                                                        } else {
                                                                                        // Invalid/stale data, clear it
                                                                                        and show signed out
                                                                                        console.warn('initGoogleAuth:
                                                                                        Clearing invalid localStorage
                                                                                        user data:', parsed);
                                                                                        localStorage.removeItem('eurokeys_user');
                                                                                        currentUser = null;
                                                                                        updateAuthUI(false);
                                                                                        }
                                                                                        } catch (e) {
                                                                                        localStorage.removeItem('eurokeys_user');
                                                                                        updateAuthUI(false);
                                                                                        }
                                                                                        } else {
                                                                                        updateAuthUI(false);
                                                                                        }

                                                                                        // 2. ALWAYS verify with backend
                                                                                        await checkDeveloperStatus();

                                                                                        // 3. Load inventory from cloud
                                                                                        if logged in
                                                                                        if (currentUser) {
                                                                                        InventoryManager.loadFromCloud();
                                                                                        InventoryManager.loadJobLogsFromCloud();
                                                                                        SubscriptionManager.loadFromCloud();
                                                                                        AssetManager.loadFromCloud();
                                                                                        }
                                                                                        }

                                                                                        // Sign in with Google
                                                                                        function signInWithGoogle() {
                                                                                        // ALWAYS use direct Workers URL
                                                                                        for OAuth - the proxy breaks
                                                                                        Google's sign-in scripts
                                                                                        // The callback will redirect
                                                                                        back to eurokeys.app after
                                                                                        sign-in
                                                                                        const WORKERS_URL =
                                                                                        'https://euro-keys.jeremy-samuels17.workers.dev';
                                                                                        window.location.href =
                                                                                        `${WORKERS_URL}/api/auth/google`;
                                                                                        }

                                                                                        // Initialize Google Sign-In
                                                                                        (kept for backward compatibility
                                                                                        with One Tap on page load)
                                                                                        function initGoogleSignIn() {
                                                                                        // One Tap is optional and may
                                                                                        be blocked by cookie settings
                                                                                        // The main sign-in button uses
                                                                                        redirect flow instead
                                                                                        try {
                                                                                        if (typeof google ===
                                                                                        'undefined' || !google.accounts
                                                                                        || !google.accounts.id) {
                                                                                        console.log('Google Identity
                                                                                        Services not available, using
                                                                                        redirect flow only');
                                                                                        return;
                                                                                        }

                                                                                        if (GOOGLE_CLIENT_ID ===
                                                                                        'YOUR_GOOGLE_CLIENT_ID.apps.googleusercontent.com')
                                                                                        {
                                                                                        return; // Not configured
                                                                                        }

                                                                                        google.accounts.id.initialize({
                                                                                        client_id: GOOGLE_CLIENT_ID,
                                                                                        callback: handleGoogleSignIn,
                                                                                        auto_select: false,
                                                                                        use_fedcm_for_prompt: true //
                                                                                        Use FedCM for better third-party
                                                                                        cookie handling
                                                                                        });

                                                                                        // Try One Tap (may not display
                                                                                        if cookies blocked)
                                                                                        google.accounts.id.prompt((notification)
                                                                                        => {
                                                                                        if
                                                                                        (notification.isNotDisplayed())
                                                                                        {
                                                                                        console.log('One Tap not
                                                                                        displayed:',
                                                                                        notification.getNotDisplayedReason());
                                                                                        }
                                                                                        });
                                                                                        } catch (e) {
                                                                                        console.log('Google Sign-In
                                                                                        initialization error (using
                                                                                        redirect flow as fallback):',
                                                                                        e);
                                                                                        }
                                                                                        }

                                                                                        // Handle Google Sign-In
                                                                                        callback (for ID token flow)
                                                                                        async function
                                                                                        handleGoogleSignIn(response) {
                                                                                        if (response.credential) {
                                                                                        try {
                                                                                        // Send the token to the backend
                                                                                        to establish a session cookie
                                                                                        // Include visitor_id to link
                                                                                        pre-registration guest activity
                                                                                        const verifyRes = await
                                                                                        fetch(`${API}/api/auth/verify`,
                                                                                        {
                                                                                        method: 'POST',
                                                                                        headers: { 'Content-Type':
                                                                                        'application/json' },
                                                                                        body: JSON.stringify({
                                                                                        credential: response.credential,
                                                                                        visitor_id: getVisitorId()
                                                                                        }),
                                                                                        credentials: 'include' //
                                                                                        CRITICAL: Securely set HttpOnly
                                                                                        session cookie
                                                                                        });

                                                                                        const data = await
                                                                                        verifyRes.json();
                                                                                        if (data.success && data.user) {
                                                                                        currentUser = data.user;
                                                                                        window.isAuthExpired = false; //
                                                                                        Reset lock on successful sign-in
                                                                                        localStorage.setItem('eurokeys_user',
                                                                                        JSON.stringify(currentUser));
                                                                                        updateAuthUI(true);
                                                                                        // Check developer status again
                                                                                        to show the tab if eligible
                                                                                        if (currentUser &&
                                                                                        currentUser.is_developer) {
                                                                                        const devTab =
                                                                                        document.getElementById('devTab');
                                                                                        if (devTab) devTab.style.display
                                                                                        = 'inline-flex';
                                                                                        }
                                                                                        // Load inventory and logs from
                                                                                        cloud
                                                                                        // FIRST: Merge any local guest
                                                                                        data to cloud (before loading)
                                                                                        if (typeof DataPortability !==
                                                                                        'undefined') {
                                                                                        await
                                                                                        DataPortability.syncAllToCloud();
                                                                                        }
                                                                                        InventoryManager.loadFromCloud();
                                                                                        InventoryManager.loadJobLogsFromCloud();
                                                                                        SubscriptionManager.loadFromCloud();
                                                                                        AssetManager.loadFromCloud();
                                                                                        if (typeof PreferencesManager
                                                                                        !== 'undefined')
                                                                                        PreferencesManager.loadFromCloud();
                                                                                        } else {
                                                                                        console.error('Backend
                                                                                        authentication failed:',
                                                                                        data.error);
                                                                                        alert('Authentication failed.
                                                                                        Please try again.');
                                                                                        }
                                                                                        } catch (e) {
                                                                                        console.error('Sign-in error:',
                                                                                        e);
                                                                                        alert('Sign-in service is
                                                                                        currently unavailable.');
                                                                                        }
                                                                                        }
                                                                                        }

                                                                                        // Fetch user profile using
                                                                                        access token
                                                                                        async function
                                                                                        fetchUserProfile(accessToken) {
                                                                                        try {
                                                                                        const response = await
                                                                                        fetch('https://www.googleapis.com/oauth2/v2/userinfo',
                                                                                        {
                                                                                        headers: { Authorization:
                                                                                        `Bearer ${accessToken}` }
                                                                                        });
                                                                                        const profile = await
                                                                                        response.json();
                                                                                        currentUser = {
                                                                                        name: profile.name,
                                                                                        email: profile.email,
                                                                                        picture: profile.picture,
                                                                                        sub: profile.id,
                                                                                        id: profile.id // Include id for
                                                                                        compatibility with startCheckout
                                                                                        };
                                                                                        localStorage.setItem('eurokeys_user',
                                                                                        JSON.stringify(currentUser));
                                                                                        updateAuthUI(true);
                                                                                        // Check developer status from
                                                                                        server
                                                                                        checkDeveloperStatus();
                                                                                        } catch (e) {
                                                                                        console.error('Failed to fetch
                                                                                        user profile:', e);
                                                                                        }
                                                                                        }

                                                                                        // Check if current user is a
                                                                                        developer by calling the server
                                                                                        API
                                                                                        async function
                                                                                        checkDeveloperStatus() {
                                                                                        if (window.isAuthExpired)
                                                                                        return;

                                                                                        // Must use Bearer token for
                                                                                        cross-domain auth
                                                                                        const authHeaders =
                                                                                        getAuthHeaders();
                                                                                        if (!authHeaders.Authorization)
                                                                                        {
                                                                                        // No token available, skip
                                                                                        verification
                                                                                        console.log('checkDeveloperStatus:
                                                                                        No session token, skipping');
                                                                                        return;
                                                                                        }

                                                                                        try {
                                                                                        const response = await
                                                                                        fetch(`${API}/api/user`, {
                                                                                        headers: authHeaders
                                                                                        });
                                                                                        if (response.ok) {
                                                                                        const data = await
                                                                                        response.json();
                                                                                        // STRICT VALIDATION: User must
                                                                                        have an email to be considered
                                                                                        valid
                                                                                        if (data.user &&
                                                                                        data.user.email) {
                                                                                        console.log('Session restored:',
                                                                                        data.user.email);
                                                                                        currentUser = data.user;
                                                                                        localStorage.setItem('eurokeys_user',
                                                                                        JSON.stringify(currentUser));

                                                                                        // Update isPro based on
                                                                                        subscription or trial
                                                                                        isPro = currentUser.is_pro ||
                                                                                        (currentUser.trial_until &&
                                                                                        currentUser.trial_until >
                                                                                        Date.now());
                                                                                        updateProUI();
                                                                                        updateAuthUI(true);

                                                                                        if (currentUser &&
                                                                                        currentUser.is_developer) {
                                                                                        const devTab =
                                                                                        document.getElementById('devTab');
                                                                                        if (devTab) devTab.style.display
                                                                                        = 'inline-flex';
                                                                                        } else {
                                                                                        const devTab =
                                                                                        document.getElementById('devTab');
                                                                                        if (devTab) devTab.style.display
                                                                                        = 'none';
                                                                                        }
                                                                                        } else {
                                                                                        // Backend returned 200 but user
                                                                                        is empty/invalid
                                                                                        console.warn('Backend returned
                                                                                        incomplete user, clearing
                                                                                        session:', data);
                                                                                        currentUser = null;
                                                                                        localStorage.removeItem('eurokeys_user');
                                                                                        updateAuthUI(false);
                                                                                        const devTab =
                                                                                        document.getElementById('devTab');
                                                                                        if (devTab) devTab.style.display
                                                                                        = 'none';
                                                                                        }
                                                                                        } else if (response.status ===
                                                                                        401) {
                                                                                        console.log('Session expired
                                                                                        (401)');
                                                                                        window.isAuthExpired = true;
                                                                                        currentUser = null;
                                                                                        localStorage.removeItem('eurokeys_user');
                                                                                        updateAuthUI(false);
                                                                                        const devTab =
                                                                                        document.getElementById('devTab');
                                                                                        if (devTab) devTab.style.display
                                                                                        = 'none';
                                                                                        }
                                                                                        } catch (e) {
                                                                                        console.error('Failed to sync
                                                                                        user status:', e);
                                                                                        }
                                                                                        }

                                                                                        // Toggle User Menu Dropdown
                                                                                        function toggleUserMenu() {
                                                                                        const dropdown =
                                                                                        document.getElementById('userDropdown');
                                                                                        if (dropdown) {
                                                                                        dropdown.classList.toggle('show');
                                                                                        }
                                                                                        }

                                                                                        // Close dropdown when clicking
                                                                                        outside
                                                                                        window.addEventListener('click',
                                                                                        (e) => {
                                                                                        const container =
                                                                                        document.querySelector('.user-menu-container');
                                                                                        const dropdown =
                                                                                        document.getElementById('userDropdown');
                                                                                        if (container &&
                                                                                        !container.contains(e.target) &&
                                                                                        dropdown &&
                                                                                        dropdown.classList.contains('show'))
                                                                                        {
                                                                                        dropdown.classList.remove('show');
                                                                                        }
                                                                                        });

                                                                                        // Update the UI based on auth
                                                                                        state
                                                                                        function
                                                                                        updateAuthUI(isSignedIn) {
                                                                                        console.log('updateAuthUI
                                                                                        called:', isSignedIn,
                                                                                        'currentUser:', currentUser);
                                                                                        const signInBtn =
                                                                                        document.getElementById('googleSignInBtn');
                                                                                        const userMenu =
                                                                                        document.getElementById('userMenu');
                                                                                        const userName =
                                                                                        document.getElementById('userName');
                                                                                        const userAvatar =
                                                                                        document.getElementById('userAvatar');
                                                                                        const dName =
                                                                                        document.getElementById('dropdownUserName');
                                                                                        const dEmail =
                                                                                        document.getElementById('dropdownUserEmail');
                                                                                        const dDevOption =
                                                                                        document.getElementById('devMenuOption');

                                                                                        // Validate currentUser has
                                                                                        required properties
                                                                                        const hasValidUser = isSignedIn
                                                                                        && currentUser &&
                                                                                        currentUser.name &&
                                                                                        currentUser.email;

                                                                                        if (hasValidUser) {
                                                                                        signInBtn.style.display =
                                                                                        'none';
                                                                                        userMenu.style.display = 'flex';
                                                                                        userName.textContent =
                                                                                        currentUser.name.split(' ')[0];
                                                                                        // First name only

                                                                                        // Update Dropdown Details
                                                                                        if (dName) dName.textContent =
                                                                                        currentUser.name;
                                                                                        if (dEmail) dEmail.textContent =
                                                                                        currentUser.email;
                                                                                        if (dDevOption)
                                                                                        dDevOption.style.display =
                                                                                        (currentUser &&
                                                                                        currentUser.is_developer) ?
                                                                                        'block' : 'none';

                                                                                        // Show initials or profile
                                                                                        picture
                                                                                        if (currentUser.picture) {
                                                                                        userAvatar.innerHTML = `<img
                                                                                            src="${currentUser.picture}"
                                                                                            alt="${currentUser.name}"
                                                                                            style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">`;
                                                                                        } else {
                                                                                        const initials =
                                                                                        currentUser.name.split('
                                                                                        ').map(n =>
                                                                                        n[0]).join('').substring(0,
                                                                                        2).toUpperCase();
                                                                                        userAvatar.innerHTML = initials;
                                                                                        }

                                                                                        // Show inventory tab and update
                                                                                        badge
                                                                                        const inventoryTab =
                                                                                        document.getElementById('inventoryTab');
                                                                                        if (inventoryTab) {
                                                                                        inventoryTab.style.display =
                                                                                        'inline-flex';
                                                                                        updateInventoryTabBadge();
                                                                                        }

                                                                                        // Show developer tab if user is
                                                                                        a developer
                                                                                        const devTab =
                                                                                        document.getElementById('devTab');
                                                                                        if (devTab) {
                                                                                        devTab.style.display =
                                                                                        (currentUser &&
                                                                                        currentUser.is_developer) ?
                                                                                        'inline-flex' : 'none';
                                                                                        }

                                                                                        // Show subscriptions tab
                                                                                        const subscriptionsTab =
                                                                                        document.getElementById('subscriptionsTab');
                                                                                        if (subscriptionsTab) {
                                                                                        subscriptionsTab.style.display =
                                                                                        'inline-flex';
                                                                                        renderSubscriptionsDashboard();
                                                                                        }
                                                                                        } else {
                                                                                        console.log('updateAuthUI:
                                                                                        Showing signed out state
                                                                                        (hasValidUser: ' + hasValidUser
                                                                                        + ')');
                                                                                        // Clear invalid user data from
                                                                                        localStorage if present
                                                                                        if (isSignedIn && currentUser &&
                                                                                        (!currentUser.name ||
                                                                                        !currentUser.email)) {
                                                                                        console.warn('Invalid user data
                                                                                        in localStorage, clearing...');
                                                                                        localStorage.removeItem('eurokeys_user');
                                                                                        currentUser = null;
                                                                                        }

                                                                                        signInBtn.style.display =
                                                                                        'flex';
                                                                                        userMenu.style.display = 'none';

                                                                                        // Keep inventory tab visible
                                                                                        (shows sign-in prompt when
                                                                                        clicked)
                                                                                        const inventoryTab =
                                                                                        document.getElementById('inventoryTab');
                                                                                        if (inventoryTab) {
                                                                                        inventoryTab.style.display =
                                                                                        'inline-flex';
                                                                                        }

                                                                                        // Hide developer tab (requires
                                                                                        sign-in AND developer access)
                                                                                        const devTab =
                                                                                        document.getElementById('devTab');
                                                                                        if (devTab) {
                                                                                        devTab.style.display = 'none';
                                                                                        }

                                                                                        // Keep subscriptions tab
                                                                                        visible (shows sign-in prompt
                                                                                        when clicked)
                                                                                        const subscriptionsTab =
                                                                                        document.getElementById('subscriptionsTab');
                                                                                        if (subscriptionsTab) {
                                                                                        subscriptionsTab.style.display =
                                                                                        'inline-flex';
                                                                                        }
                                                                                        }

                                                                                        // Update trial banner when auth
                                                                                        state changes
                                                                                        updateTrialBanner();
                                                                                        }

                                                                                        // Sign out
                                                                                        async function signOut() {
                                                                                        if (confirm('Sign out of Euro
                                                                                        Keys?')) {
                                                                                        logActivity('sign_out');

                                                                                        // 1. Tell backend to clear
                                                                                        session cookie
                                                                                        try {
                                                                                        await
                                                                                        fetch(`${API}/api/auth/logout`,
                                                                                        { credentials: 'include' });
                                                                                        } catch (e) {
                                                                                        console.error("Backend logout
                                                                                        failed", e);
                                                                                        }

                                                                                        // 2. Clear ALL local auth state
                                                                                        (critical: include session
                                                                                        token!)
                                                                                        currentUser = null;
                                                                                        localStorage.removeItem('eurokeys_user');
                                                                                        localStorage.removeItem('eurokeys_session_token');
                                                                                        // <-- This was missing! Caused
                                                                                            ghost logins.
                                                                                            window.isAuthExpired=true;
                                                                                            // Prevent background auth
                                                                                            checks from restoring
                                                                                            session updateAuthUI(false);
                                                                                            // 3. Clear Dev UI const
                                                                                            devTab=document.getElementById('devTab');
                                                                                            if (devTab)
                                                                                            devTab.style.display='none'
                                                                                            ; // 4. Revoke Google token
                                                                                            if available if (typeof
                                                                                            google !=='undefined' &&
                                                                                            google.accounts) {
                                                                                            google.accounts.id.disableAutoSelect();
                                                                                            } // 5. Force update trial
                                                                                            banner to reflect signed-out
                                                                                            state updateTrialBanner(); }
                                                                                            }
                                                                                            //==================ACTIVITY
                                                                                            TRACKING==================//
                                                                                            Generate or retrieve a
                                                                                            visitor ID for anonymous
                                                                                            tracking function
                                                                                            getVisitorId() { let
                                                                                            vid=localStorage.getItem('eurokeys_visitor_id');
                                                                                            if (!vid) { vid='v_' +
                                                                                            Math.random().toString(36).substring(2,
                                                                                            15) +
                                                                                            Math.random().toString(36).substring(2,
                                                                                            15);
                                                                                            localStorage.setItem('eurokeys_visitor_id',
                                                                                            vid); } return vid; }
                                                                                            //==================FREEMIUM
                                                                                            TRIAL
                                                                                            SYSTEM==================const
                                                                                            TRIAL_DAYS=14; const
                                                                                            TRIAL_MS=TRIAL_DAYS * 24 *
                                                                                            60 * 60 * 1000; // Premium
                                                                                            usage tracking for soft
                                                                                            paywalls const
                                                                                            PremiumUsage={
                                                                                            STORAGE_KEY: 'eurokeys_premium_usage'
                                                                                            , THRESHOLDS: { guide_views:
                                                                                            3, // Free guide views
                                                                                            before paywall }, getUsage()
                                                                                            { try { return
                                                                                            JSON.parse(localStorage.getItem(this.STORAGE_KEY)
                                                                                            || '{}' ); } catch (e) {
                                                                                            return {}; } },
                                                                                            saveUsage(data) {
                                                                                            localStorage.setItem(this.STORAGE_KEY,
                                                                                            JSON.stringify(data)); },
                                                                                            trackGuideView() { const
                                                                                            usage=this.getUsage();
                                                                                            usage.guide_views=(usage.guide_views
                                                                                            || 0) + 1;
                                                                                            this.saveUsage(usage);
                                                                                            return usage.guide_views; },
                                                                                            getGuideViews() { return
                                                                                            this.getUsage().guide_views
                                                                                            || 0; }, canViewGuide() { //
                                                                                            Pro users or signed-in trial
                                                                                            users have unlimited access
                                                                                            if (currentUser?.is_pro)
                                                                                            return true; if
                                                                                            (currentUser) return true;
                                                                                            // Signed-in users on trial
                                                                                            get full access // Anonymous
                                                                                            users: check threshold
                                                                                            return this.getGuideViews()
                                                                                            <
                                                                                            this.THRESHOLDS.guide_views;
                                                                                            }, getRemainingFreeViews() {
                                                                                            return Math.max(0,
                                                                                            this.THRESHOLDS.guide_views
                                                                                            - this.getGuideViews()); }
                                                                                            }; // No-op for backwards
                                                                                            compatibility (anonymous
                                                                                            trial removed) function
                                                                                            initAnonymousTrial() { //
                                                                                            Anonymous trial removed -
                                                                                            trial only for signed-in
                                                                                            users now console.log('â„¹ï¸
                                                                                            Sign up for 14-day free
                                                                                            trial with full access'); }
                                                                                            // Get current trial status
                                                                                            (ONLY for signed-in users
                                                                                            now) function
                                                                                            getTrialStatus() { // If
                                                                                            signed in with active
                                                                                            subscription, full access if
                                                                                            (currentUser?.is_pro) {
                                                                                            return { hasAccess: true,
                                                                                            isTrialing: false, isPro:
                                                                                            true, daysLeft: Infinity,
                                                                                            isAnonymous: false }; } //
                                                                                            If signed in with explicit
                                                                                            trial_until set if
                                                                                            (currentUser?.trial_until &&
                                                                                            currentUser.trial_until>
                                                                                            Date.now()) {
                                                                                            const daysLeft =
                                                                                            Math.ceil((currentUser.trial_until
                                                                                            - Date.now()) / (1000 * 60 *
                                                                                            60 * 24));
                                                                                            return { hasAccess: true,
                                                                                            isTrialing: true, isPro:
                                                                                            false, daysLeft,
                                                                                            isAnonymous: false };
                                                                                            }

                                                                                            // If signed in, use
                                                                                            server-side created_at for
                                                                                            trial calculation
                                                                                            if (currentUser?.created_at)
                                                                                            {
                                                                                            const createdAt = typeof
                                                                                            currentUser.created_at ===
                                                                                            'string'
                                                                                            ? new
                                                                                            Date(currentUser.created_at).getTime()
                                                                                            : currentUser.created_at;
                                                                                            const trialEnd = createdAt +
                                                                                            TRIAL_MS;
                                                                                            if (Date.now() < trialEnd) {
                                                                                                const
                                                                                                daysLeft=Math.ceil((trialEnd
                                                                                                - Date.now()) / (1000 *
                                                                                                60 * 60 * 24)); return {
                                                                                                hasAccess: true,
                                                                                                isTrialing: true, isPro:
                                                                                                false, daysLeft,
                                                                                                isAnonymous: false }; }
                                                                                                // Trial expired for
                                                                                                signed-in user return {
                                                                                                hasAccess: false,
                                                                                                isTrialing: false,
                                                                                                isPro: false, daysLeft:
                                                                                                0, isAnonymous: false };
                                                                                                } // Anonymous users -
                                                                                                limited free access (no
                                                                                                trial countdown) return
                                                                                                { hasAccess: false,
                                                                                                isTrialing: false,
                                                                                                isPro: false, daysLeft:
                                                                                                0, isAnonymous: true };
                                                                                                } // Update trial banner
                                                                                                UI (only for signed-in
                                                                                                users) function
                                                                                                updateTrialBanner() {
                                                                                                const
                                                                                                existingBanner=document.getElementById('trialBanner');
                                                                                                if (existingBanner)
                                                                                                existingBanner.remove();
                                                                                                const
                                                                                                status=getTrialStatus();
                                                                                                if (status.isPro)
                                                                                                return; // No banner for
                                                                                                pro users const
                                                                                                banner=document.createElement('div');
                                                                                                banner.id='trialBanner'
                                                                                                ; if
                                                                                                (status.isAnonymous) {
                                                                                                // Anonymous users - no
                                                                                                trial banner, data is
                                                                                                free, premium features
                                                                                                prompt sign-up return;
                                                                                                // Don't show any banner
                                                                                                for anonymous users }
                                                                                                else if
                                                                                                (status.hasAccess &&
                                                                                                status.isTrialing) { //
                                                                                                Signed-in user with
                                                                                                active trial
                                                                                                banner.innerHTML=` <div
                                                                                                style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); 
                                padding: 8px 16px; display: flex; justify-content: center; align-items: center; 
                                gap: 12px; border-bottom: 1px solid rgba(251,191,36,0.3);">
                                                                                                <span
                                                                                                    style="color: #fbbf24; font-weight: 600;">ðŸŽ
                                                                                                    Trial:
                                                                                                    ${status.daysLeft}
                                                                                                    day${status.daysLeft
                                                                                                    !== 1 ? 's' : ''}
                                                                                                    left</span>
                                                                                                <button
                                                                                                    onclick="openUpgradeModal()"
                                                                                                    style="background: #fbbf24; border: none; color: #000; 
                                         padding: 4px 12px; border-radius: 4px; font-weight: 700; font-size: 0.75rem; cursor: pointer;">
                                                                                                    Upgrade Now
                                                                                                </button>
                                                                                                </div>
                                                                                                `;
                                                                                                } else if
                                                                                                (!status.hasAccess &&
                                                                                                !status.isAnonymous) {
                                                                                                // Signed-in user with
                                                                                                expired trial
                                                                                                banner.innerHTML = `
                                                                                                <div style="background: linear-gradient(135deg, #7f1d1d 0%, #991b1b 100%); 
                                padding: 10px 16px; display: flex; justify-content: center; align-items: center; 
                                gap: 12px; border-bottom: 1px solid rgba(255,100,100,0.3);">
                                                                                                    <span
                                                                                                        style="color: #fca5a5; font-weight: 600;">âš ï¸
                                                                                                        Your free trial
                                                                                                        has ended</span>
                                                                                                    <button
                                                                                                        onclick="openUpgradeModal()"
                                                                                                        style="background: #fbbf24; border: none; color: #000; 
                                         padding: 4px 12px; border-radius: 4px; font-weight: 700; font-size: 0.75rem; cursor: pointer;">
                                                                                                        Upgrade to Pro
                                                                                                    </button>
                                                                                                </div>
                                                                                                `;
                                                                                                }

                                                                                                // Insert after header
                                                                                                const header =
                                                                                                document.querySelector('.header');
                                                                                                if (header &&
                                                                                                banner.innerHTML) {
                                                                                                header.insertAdjacentElement('afterend',
                                                                                                banner);
                                                                                                }
                                                                                                }

                                                                                                // Session tracking for
                                                                                                time spent
                                                                                                const sessionData = {
                                                                                                startTime: Date.now(),
                                                                                                currentTab: 'browse',
                                                                                                tabStartTime:
                                                                                                Date.now(),
                                                                                                interactions: 0
                                                                                                };

                                                                                                // Log batching for
                                                                                                better performance
                                                                                                const logQueue = [];
                                                                                                let logFlushTimeout =
                                                                                                null;

                                                                                                async function
                                                                                                flushLogQueue() {
                                                                                                if (logQueue.length ===
                                                                                                0) return;

                                                                                                const batch =
                                                                                                [...logQueue];
                                                                                                logQueue.length = 0; //
                                                                                                Clear queue

                                                                                                try {
                                                                                                await
                                                                                                fetch(`${API}/api/activity/batch`,
                                                                                                {
                                                                                                method: 'POST',
                                                                                                headers: {
                                                                                                ...getAuthHeaders(),
                                                                                                'Content-Type':
                                                                                                'application/json' },
                                                                                                credentials: 'include',
                                                                                                body: JSON.stringify({
                                                                                                logs: batch,
                                                                                                visitorId:
                                                                                                getVisitorId(),
                                                                                                user_email:
                                                                                                currentUser?.email ||
                                                                                                null
                                                                                                })
                                                                                                });
                                                                                                } catch (e) {
                                                                                                // Silently fail for
                                                                                                analytics
                                                                                                }
                                                                                                }

                                                                                                // Log user activity to
                                                                                                the server (batched for
                                                                                                performance)
                                                                                                function
                                                                                                logActivity(action,
                                                                                                details = null) {
                                                                                                if (window.isAuthExpired
                                                                                                && ['sign_in',
                                                                                                'sign_in_popup'].indexOf(action)
                                                                                                === -1) {
                                                                                                return; // Suppress
                                                                                                noise if auth is dead
                                                                                                }

                                                                                                sessionData.interactions++;

                                                                                                logQueue.push({
                                                                                                action,
                                                                                                details: {
                                                                                                ...details,
                                                                                                sessionDuration:
                                                                                                Math.floor((Date.now() -
                                                                                                sessionData.startTime) /
                                                                                                1000),
                                                                                                interactions:
                                                                                                sessionData.interactions
                                                                                                },
                                                                                                timestamp: Date.now()
                                                                                                });

                                                                                                // Debounce: flush after
                                                                                                5 seconds of no new
                                                                                                logs, or immediately if
                                                                                                queue is large
                                                                                                if (logFlushTimeout)
                                                                                                clearTimeout(logFlushTimeout);

                                                                                                if (logQueue.length >=
                                                                                                10) {
                                                                                                flushLogQueue();
                                                                                                } else {
                                                                                                logFlushTimeout =
                                                                                                setTimeout(flushLogQueue,
                                                                                                5000);
                                                                                                }
                                                                                                }

                                                                                                // Flush logs before
                                                                                                page unload
                                                                                                window.addEventListener('beforeunload',
                                                                                                () => {
                                                                                                if (logQueue.length > 0)
                                                                                                {
                                                                                                navigator.sendBeacon(`${API}/api/activity/batch`,
                                                                                                JSON.stringify({
                                                                                                logs: logQueue,
                                                                                                visitorId:
                                                                                                getVisitorId(),
                                                                                                user_email:
                                                                                                currentUser?.email ||
                                                                                                null
                                                                                                }));
                                                                                                }
                                                                                                });

                                                                                                // Track all button and
                                                                                                link clicks with context
                                                                                                document.addEventListener('click',
                                                                                                (e) => {
                                                                                                const target =
                                                                                                e.target.closest('button,
                                                                                                a, .tab, .card,
                                                                                                [onclick]');
                                                                                                if (!target) return;

                                                                                                // Track affiliate links
                                                                                                (Amazon)
                                                                                                const affiliateLink =
                                                                                                target.closest('a[href*="amazon.com"]');
                                                                                                if (affiliateLink) {
                                                                                                const url =
                                                                                                affiliateLink.href;
                                                                                                const searchMatch =
                                                                                                url.match(/[?&]k=([^&]+)/);
                                                                                                const searchTerm =
                                                                                                searchMatch ?
                                                                                                decodeURIComponent(searchMatch[1])
                                                                                                : null;
                                                                                                logActivity('click_affiliate',
                                                                                                {
                                                                                                url,
                                                                                                searchTerm,
                                                                                                linkText:
                                                                                                affiliateLink.textContent?.substring(0,
                                                                                                50)
                                                                                                });
                                                                                                return;
                                                                                                }

                                                                                                // Track tab clicks
                                                                                                if
                                                                                                (target.classList.contains('tab'))
                                                                                                {
                                                                                                // Log time spent on
                                                                                                previous tab
                                                                                                const timeOnTab =
                                                                                                Math.floor((Date.now() -
                                                                                                sessionData.tabStartTime)
                                                                                                / 1000);
                                                                                                if (timeOnTab > 2) {
                                                                                                logActivity('tab_time',
                                                                                                {
                                                                                                tab:
                                                                                                sessionData.currentTab,
                                                                                                seconds: timeOnTab
                                                                                                });
                                                                                                }
                                                                                                sessionData.tabStartTime
                                                                                                = Date.now();
                                                                                                return; // Tab already
                                                                                                logged in showTab()
                                                                                                }

                                                                                                // Track specific button
                                                                                                actions
                                                                                                const buttonText =
                                                                                                target.textContent?.trim().substring(0,
                                                                                                30);
                                                                                                const buttonId =
                                                                                                target.id ||
                                                                                                target.className?.split('
                                                                                                ')[0];

                                                                                                // Don't log every
                                                                                                single click, focus on
                                                                                                meaningful ones
                                                                                                if (target.tagName ===
                                                                                                'BUTTON' ||
                                                                                                target.hasAttribute('onclick'))
                                                                                                {
                                                                                                // Filter out noise
                                                                                                if (buttonText && !['Ã—',
                                                                                                'X',
                                                                                                ''].includes(buttonText))
                                                                                                {
                                                                                                logActivity('click_button',
                                                                                                {
                                                                                                button: buttonText,
                                                                                                id: buttonId,
                                                                                                section:
                                                                                                sessionData.currentTab
                                                                                                });
                                                                                                }
                                                                                                }

                                                                                                // Track external links
                                                                                                if (target.tagName ===
                                                                                                'A' && target.href &&
                                                                                                !target.href.includes(window.location.host))
                                                                                                {
                                                                                                logActivity('click_external',
                                                                                                {
                                                                                                url: target.href,
                                                                                                linkText:
                                                                                                target.textContent?.substring(0,
                                                                                                50)
                                                                                                });
                                                                                                }

                                                                                                // Track FCC ID clicks
                                                                                                if
                                                                                                (target.closest('[onclick*="openFccModal"]'))
                                                                                                {
                                                                                                const fccMatch =
                                                                                                target.textContent?.match(/[A-Z0-9]{5,}/);
                                                                                                if (fccMatch) {
                                                                                                logActivity('view_fcc',
                                                                                                { fccId: fccMatch[0] });
                                                                                                }
                                                                                                }
                                                                                                });

                                                                                                // Track VIN lookups
                                                                                                function
                                                                                                trackVinLookup(vin,
                                                                                                result) {
                                                                                                const make =
                                                                                                result?.make ||
                                                                                                'Unknown';
                                                                                                const model =
                                                                                                result?.model ||
                                                                                                'Unknown';
                                                                                                const year =
                                                                                                result?.year ||
                                                                                                'Unknown';
                                                                                                logActivity('vin_lookup',
                                                                                                {
                                                                                                vin: vin.substring(0, 8)
                                                                                                + '***', // Partial VIN
                                                                                                for privacy
                                                                                                make,
                                                                                                model,
                                                                                                year,
                                                                                                success: !!result?.make
                                                                                                });
                                                                                                }

                                                                                                // Track modal opens
                                                                                                function
                                                                                                trackModalOpen(modalName,
                                                                                                context = {}) {
                                                                                                logActivity('modal_open',
                                                                                                { modal: modalName,
                                                                                                ...context });
                                                                                                }

                                                                                                // Track feature usage
                                                                                                function
                                                                                                trackFeature(feature,
                                                                                                details = {}) {
                                                                                                logActivity('feature_use',
                                                                                                { feature, ...details
                                                                                                });
                                                                                                }

                                                                                                // Search tracking with
                                                                                                debounce
                                                                                                let searchLogTimeout;
                                                                                                function
                                                                                                logSearch(query) {
                                                                                                clearTimeout(searchLogTimeout);
                                                                                                if (!query ||
                                                                                                query.length < 3)
                                                                                                    return;
                                                                                                    searchLogTimeout=setTimeout(()=>
                                                                                                    {
                                                                                                    logActivity('search',
                                                                                                    {
                                                                                                    query,
                                                                                                    tab:
                                                                                                    sessionData.currentTab
                                                                                                    });
                                                                                                    }, 2000); // 2
                                                                                                    second delay to
                                                                                                    avoid logging every
                                                                                                    keystroke
                                                                                                    }

                                                                                                    // Track page
                                                                                                    visibility changes
                                                                                                    (user
                                                                                                    leaving/returning)
                                                                                                    document.addEventListener('visibilitychange',
                                                                                                    () => {
                                                                                                    if (document.hidden)
                                                                                                    {
                                                                                                    logActivity('page_hidden',
                                                                                                    {
                                                                                                    tab:
                                                                                                    sessionData.currentTab,
                                                                                                    timeOnPage:
                                                                                                    Math.floor((Date.now()
                                                                                                    -
                                                                                                    sessionData.startTime)
                                                                                                    / 1000)
                                                                                                    });
                                                                                                    } else {
                                                                                                    logActivity('page_visible');
                                                                                                    }
                                                                                                    });

                                                                                                    // Track session end
                                                                                                    when user leaves
                                                                                                    window.addEventListener('beforeunload',
                                                                                                    () => {
                                                                                                    const
                                                                                                    sessionDuration =
                                                                                                    Math.floor((Date.now()
                                                                                                    -
                                                                                                    sessionData.startTime)
                                                                                                    / 1000);
                                                                                                    // Use sendBeacon
                                                                                                    for reliable
                                                                                                    delivery
                                                                                                    if
                                                                                                    (navigator.sendBeacon)
                                                                                                    {
                                                                                                    navigator.sendBeacon(`${API}/api/activity/log`,
                                                                                                    JSON.stringify({
                                                                                                    action:
                                                                                                    'session_end',
                                                                                                    details: {
                                                                                                    duration:
                                                                                                    sessionDuration,
                                                                                                    interactions:
                                                                                                    sessionData.interactions,
                                                                                                    lastTab:
                                                                                                    sessionData.currentTab
                                                                                                    },
                                                                                                    visitorId:
                                                                                                    getVisitorId()
                                                                                                    }));
                                                                                                    }
                                                                                                    });

                                                                                                    //
                                                                                                    ==================
                                                                                                    DEVELOPER PANEL
                                                                                                    ==================

                                                                                                    let devPanelLoaded =
                                                                                                    false;

                                                                                                    // Helper for
                                                                                                    relative time (e.g.
                                                                                                    "5m ago")
                                                                                                    function
                                                                                                    formatRelativeDate(timestamp)
                                                                                                    {
                                                                                                    const now =
                                                                                                    Date.now();
                                                                                                    const diff = now -
                                                                                                    timestamp;
                                                                                                    if (diff < 60000)
                                                                                                        return 'Just now'
                                                                                                        ; if (diff <
                                                                                                        3600000) return
                                                                                                        Math.floor(diff
                                                                                                        / 60000)
                                                                                                        + 'm ago' ; if
                                                                                                        (diff <
                                                                                                        86400000) return
                                                                                                        Math.floor(diff
                                                                                                        / 3600000)
                                                                                                        + 'h ago' ;
                                                                                                        return new
                                                                                                        Date(timestamp).toLocaleDateString();
                                                                                                        } // Activity
                                                                                                        categorization
                                                                                                        for dev panel
                                                                                                        let
                                                                                                        currentActivityCategory='all'
                                                                                                        ; function
                                                                                                        categorizeActivity(action,
                                                                                                        details) { try {
                                                                                                        const
                                                                                                        detailsObj=typeof
                                                                                                        details==='string'
                                                                                                        ?
                                                                                                        JSON.parse(details
                                                                                                        || '{}' ) :
                                                                                                        (details || {});
                                                                                                        // Job Logging
                                                                                                        category - users
                                                                                                        logging work or
                                                                                                        using inventory
                                                                                                        if
                                                                                                        (action==='click_button'
                                                                                                        ) { const
                                                                                                        btn=(detailsObj?.button
                                                                                                        || ''
                                                                                                        ).toLowerCase();
                                                                                                        if
                                                                                                        (btn.includes('log
                                                                                                        job') ||
                                                                                                        btn.includes('calculate
                                                                                                        profit') ||
                                                                                                        btn.includes('use
                                                                                                        item') ||
                                                                                                        btn.includes('add
                                                                                                        to inventory')
                                                                                                        ||
                                                                                                        btn.includes('log')
                                                                                                        ||
                                                                                                        btn.includes('job'))
                                                                                                        {
                                                                                                        return 'job_logging'
                                                                                                        ; } } // Search
                                                                                                        & Lookup if
                                                                                                        (['search', 'vin_lookup'
                                                                                                        , 'view_fcc'
                                                                                                        ].includes(action))
                                                                                                        return 'search'
                                                                                                        ; //
                                                                                                        Monetization -
                                                                                                        revenue
                                                                                                        generating
                                                                                                        actions if
                                                                                                        (['click_affiliate', 'click_external'
                                                                                                        ].includes(action))
                                                                                                        return 'monetization'
                                                                                                        ; // Browsing -
                                                                                                        navigation and
                                                                                                        modal
                                                                                                        interactions if
                                                                                                        (['view_tab', 'modal_open'
                                                                                                        , 'feature_use'
                                                                                                        ].includes(action))
                                                                                                        return 'browsing'
                                                                                                        ; // Session -
                                                                                                        time and
                                                                                                        engagement
                                                                                                        tracking if
                                                                                                        (['session_end', 'page_hidden'
                                                                                                        , 'page_visible'
                                                                                                        , 'tab_time'
                                                                                                        , 'sign_in'
                                                                                                        , 'sign_out'
                                                                                                        ].includes(action))
                                                                                                        return 'session'
                                                                                                        ; // Default to
                                                                                                        browsing for
                                                                                                        general button
                                                                                                        clicks if
                                                                                                        (action==='click_button'
                                                                                                        )
                                                                                                        return 'browsing'
                                                                                                        ; return 'other'
                                                                                                        ; } catch (e) {
                                                                                                        return 'other' ;
                                                                                                        } } function
                                                                                                        setActivityTab(category)
                                                                                                        {
                                                                                                        currentActivityCategory=category;
                                                                                                        // Update tab
                                                                                                        styling
                                                                                                        document.querySelectorAll('.activity-tab').forEach(tab=>
                                                                                                        {
                                                                                                        const isActive =
                                                                                                        tab.dataset.category
                                                                                                        === category;
                                                                                                        tab.classList.toggle('active',
                                                                                                        isActive);

                                                                                                        // Update visual
                                                                                                        style for active
                                                                                                        tab
                                                                                                        if (isActive) {
                                                                                                        tab.style.opacity
                                                                                                        = '1';
                                                                                                        tab.style.transform
                                                                                                        = 'scale(1.05)';
                                                                                                        } else {
                                                                                                        tab.style.opacity
                                                                                                        = '0.7';
                                                                                                        tab.style.transform
                                                                                                        = 'scale(1)';
                                                                                                        }
                                                                                                        });

                                                                                                        // Filter
                                                                                                        activity items
                                                                                                        document.querySelectorAll('.activity-item').forEach(item
                                                                                                        => {
                                                                                                        const cat =
                                                                                                        item.dataset.category;
                                                                                                        item.style.display
                                                                                                        = (category ===
                                                                                                        'all' || cat ===
                                                                                                        category) ? '' :
                                                                                                        'none';
                                                                                                        });
                                                                                                        }

                                                                                                        // Cloudflare
                                                                                                        persona tab
                                                                                                        switching
                                                                                                        let currentCfTab
                                                                                                        = 'overview';

                                                                                                        function
                                                                                                        setCfPersonaTab(tabName)
                                                                                                        {
                                                                                                        currentCfTab =
                                                                                                        tabName;

                                                                                                        // Update tab
                                                                                                        button styles
                                                                                                        document.querySelectorAll('.cf-persona-tab').forEach(btn
                                                                                                        => {
                                                                                                        const isActive =
                                                                                                        btn.dataset.tab
                                                                                                        === tabName;
                                                                                                        btn.classList.toggle('active',
                                                                                                        isActive);
                                                                                                        btn.style.opacity
                                                                                                        = isActive ? '1'
                                                                                                        : '0.7';
                                                                                                        });

                                                                                                        // Show/hide tab
                                                                                                        content
                                                                                                        document.querySelectorAll('.cf-tab-content').forEach(content
                                                                                                        => {
                                                                                                        content.style.display
                                                                                                        = 'none';
                                                                                                        });

                                                                                                        const
                                                                                                        activeContent =
                                                                                                        document.getElementById(`cfTab${tabName.charAt(0).toUpperCase()
                                                                                                        +
                                                                                                        tabName.slice(1)}`);
                                                                                                        if
                                                                                                        (activeContent)
                                                                                                        activeContent.style.display
                                                                                                        = '';
                                                                                                        }

                                                                                                        // Country flag
                                                                                                        emoji helper
                                                                                                        function
                                                                                                        getCountryFlag(countryCode)
                                                                                                        {
                                                                                                        const flags = {
                                                                                                        'US': 'ðŸ‡ºðŸ‡¸',
                                                                                                        'CA': 'ðŸ‡¨ðŸ‡¦',
                                                                                                        'GB': 'ðŸ‡¬ðŸ‡§',
                                                                                                        'DE': 'ðŸ‡©ðŸ‡ª',
                                                                                                        'FR': 'ðŸ‡«ðŸ‡·',
                                                                                                        'ES': 'ðŸ‡ªðŸ‡¸',
                                                                                                        'IT': 'ðŸ‡®ðŸ‡¹',
                                                                                                        'AU': 'ðŸ‡¦ðŸ‡º',
                                                                                                        'JP': 'ðŸ‡¯ðŸ‡µ',
                                                                                                        'BR': 'ðŸ‡§ðŸ‡·',
                                                                                                        'MX': 'ðŸ‡²ðŸ‡½',
                                                                                                        'IN': 'ðŸ‡®ðŸ‡³',
                                                                                                        'CN': 'ðŸ‡¨ðŸ‡³',
                                                                                                        'KR': 'ðŸ‡°ðŸ‡·',
                                                                                                        'NL': 'ðŸ‡³ðŸ‡±',
                                                                                                        'SE': 'ðŸ‡¸ðŸ‡ª',
                                                                                                        'CH': 'ðŸ‡¨ðŸ‡­',
                                                                                                        'PL': 'ðŸ‡µðŸ‡±',
                                                                                                        'RU': 'ðŸ‡·ðŸ‡º',
                                                                                                        'AR': 'ðŸ‡¦ðŸ‡·',
                                                                                                        'XX': 'ðŸŒ'
                                                                                                        };
                                                                                                        return
                                                                                                        flags[countryCode]
                                                                                                        || 'ðŸ³ï¸';
                                                                                                        }

                                                                                                        // Device icon
                                                                                                        helper
                                                                                                        function
                                                                                                        getDeviceIcon(deviceType)
                                                                                                        {
                                                                                                        const icons = {
                                                                                                        'desktop': 'ðŸ’»',
                                                                                                        'mobile': 'ðŸ“±',
                                                                                                        'tablet': 'ðŸ“Ÿ',
                                                                                                        'bot': 'ðŸ¤–',
                                                                                                        'unknown': 'â“'
                                                                                                        };
                                                                                                        return
                                                                                                        icons[deviceType?.toLowerCase()]
                                                                                                        || 'â“';
                                                                                                        }

                                                                                                        // Browser icon
                                                                                                        helper
                                                                                                        function
                                                                                                        getBrowserIcon(browser)
                                                                                                        {
                                                                                                        const icons = {
                                                                                                        'Chrome': 'ðŸ”µ',
                                                                                                        'Safari': 'ðŸ§­',
                                                                                                        'Firefox': 'ðŸ¦Š',
                                                                                                        'Edge': 'ðŸŒŠ',
                                                                                                        'Opera': 'ðŸ”´',
                                                                                                        'Samsung': 'ðŸ“±',
                                                                                                        'Unknown': 'â“'
                                                                                                        };
                                                                                                        return
                                                                                                        icons[browser]
                                                                                                        || 'ðŸŒ';
                                                                                                        }

                                                                                                        async function
                                                                                                        loadDevPanel() {
                                                                                                        // Reset error
                                                                                                        states
                                                                                                        const
                                                                                                        errorBanner =
                                                                                                        document.getElementById('devGlobalError');
                                                                                                        if (errorBanner)
                                                                                                        errorBanner.style.display
                                                                                                        = 'none';

                                                                                                        try {
                                                                                                        // Fetch stats,
                                                                                                        users, and
                                                                                                        activity with
                                                                                                        full auth
                                                                                                        headers
                                                                                                        const authConfig
                                                                                                        = {
                                                                                                        credentials:
                                                                                                        'include',
                                                                                                        headers:
                                                                                                        getAuthHeaders()
                                                                                                        };
                                                                                                        const [statsRes,
                                                                                                        userRes,
                                                                                                        activityRes] =
                                                                                                        await
                                                                                                        Promise.all([
                                                                                                        fetch(`${API}/api/admin/stats`,
                                                                                                        authConfig),
                                                                                                        fetch(`${API}/api/admin/users`,
                                                                                                        authConfig),
                                                                                                        fetch(`${API}/api/admin/activity?limit=1000`,
                                                                                                        authConfig)
                                                                                                        ]);

                                                                                                        if
                                                                                                        (statsRes.status
                                                                                                        === 401 ||
                                                                                                        userRes.status
                                                                                                        === 401 ||
                                                                                                        activityRes.status
                                                                                                        === 401) {
                                                                                                        window.isAuthExpired
                                                                                                        = true; // Stop
                                                                                                        background noise
                                                                                                        throw new
                                                                                                        Error("SESSION_EXPIRED");
                                                                                                        }
                                                                                                        if
                                                                                                        (statsRes.status
                                                                                                        === 403 ||
                                                                                                        userRes.status
                                                                                                        === 403 ||
                                                                                                        activityRes.status
                                                                                                        === 403) {
                                                                                                        throw new
                                                                                                        Error("ACCESS_DENIED");
                                                                                                        }
                                                                                                        if (!statsRes.ok
                                                                                                        || !userRes.ok
                                                                                                        ||
                                                                                                        !activityRes.ok)
                                                                                                        {
                                                                                                        throw new
                                                                                                        Error(`Server
                                                                                                        error
                                                                                                        (${statsRes.status})`);
                                                                                                        }

                                                                                                        // ... [Existing
                                                                                                        processing logic
                                                                                                        remains same]
                                                                                                        ...

                                                                                                        const statsData
                                                                                                        = await
                                                                                                        statsRes.json();
                                                                                                        const userData =
                                                                                                        await
                                                                                                        userRes.json();
                                                                                                        const
                                                                                                        activityData =
                                                                                                        await
                                                                                                        activityRes.json();

                                                                                                        const users =
                                                                                                        userData.users
                                                                                                        || [];
                                                                                                        const activity =
                                                                                                        activityData.activity
                                                                                                        || [];

                                                                                                        // 1. Core KPIs
                                                                                                        from Global
                                                                                                        Totals
                                                                                                        const global =
                                                                                                        statsData.globalTotals
                                                                                                        || { searches:
                                                                                                        0, clicks: 0,
                                                                                                        vin_lookups: 0
                                                                                                        };
                                                                                                        const
                                                                                                        visitorStats =
                                                                                                        statsData.visitorStats
                                                                                                        || {};
                                                                                                        const totalUsers
                                                                                                        = users.length;
                                                                                                        const guestCount
                                                                                                        =
                                                                                                        visitorStats.guest_count
                                                                                                        || 0;

                                                                                                        // Business
                                                                                                        Metrics (Using
                                                                                                        Global Totals)
                                                                                                        const
                                                                                                        revenuePerClick
                                                                                                        = 1.50; //
                                                                                                        Estimated
                                                                                                        const
                                                                                                        totalClicks =
                                                                                                        global.clicks ||
                                                                                                        0;
                                                                                                        const estRevenue
                                                                                                        = totalClicks *
                                                                                                        revenuePerClick;

                                                                                                        const
                                                                                                        totalSearches =
                                                                                                        global.searches
                                                                                                        || 0;
                                                                                                        const
                                                                                                        conversionRate =
                                                                                                        totalSearches >
                                                                                                        0 ?
                                                                                                        ((totalClicks /
                                                                                                        totalSearches) *
                                                                                                        100).toFixed(1)
                                                                                                        : '0.0';

                                                                                                        // Engagement:
                                                                                                        interactions per
                                                                                                        guest
                                                                                                        const
                                                                                                        totalInteractions
                                                                                                        =
                                                                                                        activity.length;
                                                                                                        const
                                                                                                        avgEngagement =
                                                                                                        guestCount > 0 ?
                                                                                                        (totalInteractions
                                                                                                        /
                                                                                                        guestCount).toFixed(1)
                                                                                                        : '0.0';

                                                                                                        // Update UI KPI
                                                                                                        Bar
                                                                                                        document.getElementById('devTotalUsers').textContent
                                                                                                        =
                                                                                                        totalUsers.toLocaleString();
                                                                                                        document.getElementById('devUserGrowth').textContent
                                                                                                        =
                                                                                                        statsData.growth
                                                                                                        || 0;
                                                                                                        document.getElementById('devEstRevenue').textContent
                                                                                                        =
                                                                                                        `$${estRevenue.toLocaleString('en-US',
                                                                                                        {
                                                                                                        minimumFractionDigits:
                                                                                                        2 })}`;
                                                                                                        document.getElementById('devConversionRate').textContent
                                                                                                        =
                                                                                                        `${conversionRate}%`;
                                                                                                        document.getElementById('devAvgEngagement').textContent
                                                                                                        = avgEngagement;

                                                                                                        // 2. Update
                                                                                                        Conversion
                                                                                                        Funnel (Using
                                                                                                        Global Totals)
                                                                                                        const
                                                                                                        vinLookupCount =
                                                                                                        global.vin_lookups
                                                                                                        || 0;

                                                                                                        document.getElementById('funnelSearchCount').textContent
                                                                                                        =
                                                                                                        totalSearches.toLocaleString();
                                                                                                        document.getElementById('funnelVinCount').textContent
                                                                                                        =
                                                                                                        vinLookupCount.toLocaleString();
                                                                                                        document.getElementById('funnelClickCount').textContent
                                                                                                        =
                                                                                                        totalClicks.toLocaleString();

                                                                                                        const vinPct =
                                                                                                        totalSearches >
                                                                                                        0 ?
                                                                                                        (vinLookupCount
                                                                                                        / totalSearches)
                                                                                                        * 100 : 0;
                                                                                                        const clickPct =
                                                                                                        totalSearches >
                                                                                                        0 ? (totalClicks
                                                                                                        / totalSearches)
                                                                                                        * 100 : 0;

                                                                                                        document.getElementById('funnelVinProgress').style.width
                                                                                                        =
                                                                                                        `${Math.min(100,
                                                                                                        vinPct)}%`;
                                                                                                        document.getElementById('funnelClickProgress').style.width
                                                                                                        =
                                                                                                        `${Math.min(100,
                                                                                                        clickPct)}%`;

                                                                                                        // 3. Update AI
                                                                                                        Insights &
                                                                                                        Trends
                                                                                                        const
                                                                                                        trendingContainer
                                                                                                        =
                                                                                                        document.getElementById('devAiInsights');
                                                                                                        const
                                                                                                        trendingModelEl
                                                                                                        =
                                                                                                        document.getElementById('devTrendingModel');

                                                                                                        // Determine top
                                                                                                        trend
                                                                                                        const vinLookups
                                                                                                        = {};
                                                                                                        activity.filter(a
                                                                                                        => a.action ===
                                                                                                        'vin_lookup').forEach(a
                                                                                                        => {
                                                                                                        try {
                                                                                                        const d =
                                                                                                        JSON.parse(a.details);
                                                                                                        if (d.make) {
                                                                                                        const key =
                                                                                                        `${d.make}
                                                                                                        ${d.model ||
                                                                                                        ''}`.trim();
                                                                                                        vinLookups[key]
                                                                                                        =
                                                                                                        (vinLookups[key]
                                                                                                        || 0) + 1;
                                                                                                        }
                                                                                                        } catch (e) { }
                                                                                                        });

                                                                                                        const topVin =
                                                                                                        Object.entries(vinLookups).sort((a,
                                                                                                        b) => b[1] -
                                                                                                        a[1])[0];
                                                                                                        if (topVin) {
                                                                                                        trendingModelEl.textContent
                                                                                                        = topVin[0];
                                                                                                        trendingContainer.innerHTML
                                                                                                        = `
                                                                                                        <p><strong>Primary
                                                                                                                Driver:</strong>
                                                                                                            High volume
                                                                                                            of
                                                                                                            <strong>${topVin[0]}</strong>
                                                                                                            lookups
                                                                                                            detected in
                                                                                                            the last
                                                                                                            24h.
                                                                                                            Recommend
                                                                                                            ensuring
                                                                                                            ASIN mapping
                                                                                                            for this
                                                                                                            model is
                                                                                                            100%
                                                                                                            accurate to
                                                                                                            maximize
                                                                                                            affiliate
                                                                                                            conversion.
                                                                                                        </p>
                                                                                                        <p
                                                                                                            style="margin-top: 10px;">
                                                                                                            <strong>Opportunity:</strong>
                                                                                                            Search
                                                                                                            volume for
                                                                                                            mechanical
                                                                                                            keys is up
                                                                                                            12%.
                                                                                                            Consider
                                                                                                            highlighting
                                                                                                            "Lishi"
                                                                                                            tools in
                                                                                                            results.
                                                                                                        </p>
                                                                                                        `;
                                                                                                        }

                                                                                                        // 4. Update
                                                                                                        Detailed Tables
                                                                                                        // Top Searches
                                                                                                        (Direct from
                                                                                                        backend top-10)
                                                                                                        const
                                                                                                        searchContainer
                                                                                                        =
                                                                                                        document.getElementById('devTopSearches');
                                                                                                        if
                                                                                                        (statsData.topSearches
                                                                                                        &&
                                                                                                        statsData.topSearches.length
                                                                                                        > 0) {
                                                                                                        searchContainer.innerHTML
                                                                                                        =
                                                                                                        statsData.topSearches.map(s
                                                                                                        => `
                                                                                                        <div
                                                                                                            style="display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.03); padding: 10px 14px; border-radius: 12px;">
                                                                                                            <span
                                                                                                                style="color: var(--text-primary); font-size: 0.9rem;">"${s.query}"</span>
                                                                                                            <span
                                                                                                                style="background: rgba(96, 165, 250, 0.1); color: #60a5fa; padding: 2px 8px; border-radius: 6px; font-weight: bold; font-size: 0.8rem;">${s.count.toLocaleString()}x</span>
                                                                                                        </div>
                                                                                                        `).join('');
                                                                                                        }

                                                                                                        // VIN Lookups
                                                                                                        Detail
                                                                                                        const
                                                                                                        vinDetailContainer
                                                                                                        =
                                                                                                        document.getElementById('devVinLookups');
                                                                                                        const vinItems =
                                                                                                        Object.entries(vinLookups).sort((a,
                                                                                                        b) => b[1] -
                                                                                                        a[1]).slice(0,
                                                                                                        5);
                                                                                                        if
                                                                                                        (vinItems.length
                                                                                                        > 0) {
                                                                                                        vinDetailContainer.innerHTML
                                                                                                        =
                                                                                                        vinItems.map(([vehicle,
                                                                                                        count]) => `
                                                                                                        <div
                                                                                                            style="display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.03); padding: 10px 14px; border-radius: 12px;">
                                                                                                            <span
                                                                                                                style="color: var(--text-primary); font-size: 0.9rem;">${vehicle}</span>
                                                                                                            <span
                                                                                                                style="background: rgba(34, 211, 238, 0.1); color: #22d3ee; padding: 2px 8px; border-radius: 6px; font-weight: bold; font-size: 0.8rem;">${count}
                                                                                                                hits</span>
                                                                                                        </div>
                                                                                                        `).join('');
                                                                                                        }

                                                                                                        // Tab
                                                                                                        Engagement
                                                                                                        const tabViews =
                                                                                                        {};
                                                                                                        activity.filter(a
                                                                                                        => a.action ===
                                                                                                        'view_tab').forEach(a
                                                                                                        => {
                                                                                                        try {
                                                                                                        const d =
                                                                                                        JSON.parse(a.details);
                                                                                                        if (d.tab)
                                                                                                        tabViews[d.tab]
                                                                                                        =
                                                                                                        (tabViews[d.tab]
                                                                                                        || 0) + 1;
                                                                                                        } catch (e) { }
                                                                                                        });
                                                                                                        const
                                                                                                        tabContainer =
                                                                                                        document.getElementById('devTabUsage');
                                                                                                        const tabItems =
                                                                                                        Object.entries(tabViews).sort((a,
                                                                                                        b) => b[1] -
                                                                                                        a[1]);
                                                                                                        if
                                                                                                        (tabItems.length
                                                                                                        > 0) {
                                                                                                        const totalVs =
                                                                                                        tabItems.reduce((s,
                                                                                                        [, c]) => s + c,
                                                                                                        0);
                                                                                                        tabContainer.innerHTML
                                                                                                        =
                                                                                                        tabItems.map(([tab,
                                                                                                        count]) => {
                                                                                                        const pct =
                                                                                                        Math.round((count
                                                                                                        / totalVs) *
                                                                                                        100);
                                                                                                        return `
                                                                                                        <div
                                                                                                            style="background: rgba(255,255,255,0.03); padding: 10px 14px; border-radius: 12px; margin-bottom: 8px;">
                                                                                                            <div
                                                                                                                style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                                                                                                                <span
                                                                                                                    style="color: var(--text-primary); font-size: 0.9rem; text-transform: capitalize;">${tab}</span>
                                                                                                                <span
                                                                                                                    style="color: var(--text-muted); font-size: 0.8rem;">${pct}%</span>
                                                                                                            </div>
                                                                                                            <div
                                                                                                                style="height: 4px; background: rgba(255,255,255,0.05); border-radius: 2px; overflow: hidden;">
                                                                                                                <div
                                                                                                                    style="width: ${pct}%; height: 100%; background: #a855f7;">
                                                                                                                </div>
                                                                                                            </div>
                                                                                                        </div>
                                                                                                        `;
                                                                                                        }).join('');
                                                                                                        }

                                                                                                        // 5. Update
                                                                                                        Users Table
                                                                                                        const tbody =
                                                                                                        document.getElementById('devUsersTable');
                                                                                                        if (users.length
                                                                                                        === 0) {
                                                                                                        tbody.innerHTML
                                                                                                        = '<tr>
                                                                                                            <td colspan="6"
                                                                                                                style="padding: 40px; text-align: center; color: var(--text-muted);">
                                                                                                                No
                                                                                                                registered
                                                                                                                users
                                                                                                                yet</td>
                                                                                                        </tr>';
                                                                                                        } else {
                                                                                                        tbody.innerHTML
                                                                                                        = users.slice(0,
                                                                                                        10).map(u => {
                                                                                                        const lastActive
                                                                                                        =
                                                                                                        u.last_activity
                                                                                                        ?
                                                                                                        formatRelativeDate(u.last_activity)
                                                                                                        : 'Never';
                                                                                                        return `
                                                                                                        <tr
                                                                                                            style="border-bottom: 1px solid rgba(255,255,255,0.03);">
                                                                                                            <td
                                                                                                                style="padding: 14px 16px; display: flex; align-items: center; gap: 10px;">
                                                                                                                <img src="${u.picture || 'https://www.gravatar.com/avatar/0?d=mp'}"
                                                                                                                    style="width: 28px; height: 28px; border-radius: 50%; border: 1px solid rgba(255,255,255,0.1);">
                                                                                                                <div
                                                                                                                    style="color: var(--text-primary); font-weight: 600; font-size: 0.85rem;">
                                                                                                                    ${u.name
                                                                                                                    ||
                                                                                                                    'User'}
                                                                                                                </div>
                                                                                                            </td>
                                                                                                            <td
                                                                                                                style="padding: 14px 16px; font-size: 0.8rem; color: var(--text-muted);">
                                                                                                                ${u.email
                                                                                                                || '-'}
                                                                                                            </td>
                                                                                                            <td
                                                                                                                style="padding: 14px 16px; text-align: center;">
                                                                                                                <span
                                                                                                                    style="background: ${u.is_pro ? 'rgba(74, 222, 128, 0.1)' : 'rgba(255,255,255,0.05)'}; color: ${u.is_pro ? '#4ade80' : '#9ca3af'}; padding: 4px 12px; border-radius: 100px; font-size: 0.7rem; font-weight: 800; border: 1px solid ${u.is_pro ? 'rgba(74,222,128,0.2)' : 'transparent'};">
                                                                                                                    ${u.is_pro
                                                                                                                    ?
                                                                                                                    'PRO'
                                                                                                                    :
                                                                                                                    'FREE'}
                                                                                                                </span>
                                                                                                            </td>
                                                                                                            <td
                                                                                                                style="padding: 14px 16px; text-align: center; font-weight: 700; color: #60a5fa; font-size: 0.85rem;">
                                                                                                                ${u.activity_count
                                                                                                                || 0}
                                                                                                            </td>
                                                                                                            <td
                                                                                                                style="padding: 14px 16px; font-size: 0.8rem; color: var(--text-muted);">
                                                                                                                ${new
                                                                                                                Date(u.created_at).toLocaleDateString()}
                                                                                                            </td>
                                                                                                            <td
                                                                                                                style="padding: 14px 16px; font-size: 0.8rem; color: #4ade80;">
                                                                                                                ${lastActive}
                                                                                                            </td>
                                                                                                        </tr>
                                                                                                        `;
                                                                                                        }).join('');
                                                                                                        }

                                                                                                        // 6. Update
                                                                                                        Activity Log
                                                                                                        with
                                                                                                        Categorization
                                                                                                        const
                                                                                                        activityContainer
                                                                                                        =
                                                                                                        document.getElementById('devActivityLog');
                                                                                                        if
                                                                                                        (activity.length
                                                                                                        === 0) {
                                                                                                        activityContainer.innerHTML
                                                                                                        = '<div
                                                                                                            style="color: var(--text-muted); text-align: center; padding: 20px;">
                                                                                                            No activity
                                                                                                            logged yet
                                                                                                        </div>';
                                                                                                        } else {
                                                                                                        // Build
                                                                                                        visitor_id ->
                                                                                                        user name lookup
                                                                                                        for resolving
                                                                                                        guests to
                                                                                                        registered users
                                                                                                        const
                                                                                                        visitorToUser =
                                                                                                        {};
                                                                                                        users.forEach(u
                                                                                                        => {
                                                                                                        if
                                                                                                        (u.visitor_id) {
                                                                                                        visitorToUser[u.visitor_id]
                                                                                                        = u.name ||
                                                                                                        u.email;
                                                                                                        }
                                                                                                        });

                                                                                                        // Count
                                                                                                        activities by
                                                                                                        category
                                                                                                        const
                                                                                                        categoryCounts =
                                                                                                        { all: 0,
                                                                                                        job_logging: 0,
                                                                                                        search: 0,
                                                                                                        monetization: 0,
                                                                                                        browsing: 0,
                                                                                                        session: 0,
                                                                                                        other: 0 };

                                                                                                        const
                                                                                                        activityHtml =
                                                                                                        activity.slice(0,
                                                                                                        100).map(a => {
                                                                                                        const time =
                                                                                                        formatRelativeDate(a.timestamp
                                                                                                        ||
                                                                                                        a.created_at);
                                                                                                        const category =
                                                                                                        categorizeActivity(a.action,
                                                                                                        a.details);

                                                                                                        // Count by
                                                                                                        category
                                                                                                        categoryCounts.all++;
                                                                                                        categoryCounts[category]
                                                                                                        =
                                                                                                        (categoryCounts[category]
                                                                                                        || 0) + 1;

                                                                                                        // Improve Guest
                                                                                                        User display -
                                                                                                        resolve to
                                                                                                        registered user
                                                                                                        if possible
                                                                                                        let displayName
                                                                                                        = a.user_name ||
                                                                                                        'Guest User';
                                                                                                        let
                                                                                                        isResolvedGuest
                                                                                                        = false;
                                                                                                        if (!a.user_name
                                                                                                        && a.user_id &&
                                                                                                        a.user_id.startsWith('guest:'))
                                                                                                        {
                                                                                                        const visitorId
                                                                                                        =
                                                                                                        a.user_id.replace('guest:',
                                                                                                        '');
                                                                                                        // Check if this
                                                                                                        guest later
                                                                                                        registered
                                                                                                        if
                                                                                                        (visitorToUser[visitorId])
                                                                                                        {
                                                                                                        displayName =
                                                                                                        `${visitorToUser[visitorId]}
                                                                                                        ðŸ‘¤`;
                                                                                                        isResolvedGuest
                                                                                                        = true;
                                                                                                        } else {
                                                                                                        displayName =
                                                                                                        `Guest
                                                                                                        (${visitorId.substring(0,
                                                                                                        5)})`;
                                                                                                        }
                                                                                                        }

                                                                                                        let icon = 'ðŸ“';
                                                                                                        let detailsText
                                                                                                        = '';

                                                                                                        if (a.action ===
                                                                                                        'search') icon =
                                                                                                        'ðŸ”';
                                                                                                        else if
                                                                                                        (a.action ===
                                                                                                        'click_affiliate')
                                                                                                        icon = 'ðŸ›’';
                                                                                                        else if
                                                                                                        (a.action ===
                                                                                                        'vin_lookup')
                                                                                                        icon = 'ðŸš—';
                                                                                                        else if
                                                                                                        (a.action ===
                                                                                                        'view_tab') icon
                                                                                                        = 'ðŸ“Š';
                                                                                                        else if
                                                                                                        (a.action.includes('session'))
                                                                                                        icon = 'ðŸ•’';
                                                                                                        else if
                                                                                                        (category ===
                                                                                                        'job_logging')
                                                                                                        icon = 'ðŸ”§';

                                                                                                        if (a.details) {
                                                                                                        try {
                                                                                                        const d =
                                                                                                        JSON.parse(a.details);
                                                                                                        if (a.action ===
                                                                                                        'search')
                                                                                                        detailsText = `:
                                                                                                        <span
                                                                                                            style="color: #60a5fa; font-weight: 600;">"${d.query}"</span>`;
                                                                                                        else if
                                                                                                        (a.action ===
                                                                                                        'click_affiliate')
                                                                                                        detailsText = `:
                                                                                                        <span
                                                                                                            style="color: #fbbf24; font-weight: 600;">${d.searchTerm
                                                                                                            ||
                                                                                                            'Amazon'}</span>`;
                                                                                                        else if
                                                                                                        (a.action ===
                                                                                                        'vin_lookup')
                                                                                                        detailsText = `:
                                                                                                        <span
                                                                                                            style="color: #22d3ee; font-weight: 600;">${d.make}
                                                                                                            ${d.model ||
                                                                                                            ''}</span>`;
                                                                                                        else if
                                                                                                        (a.action ===
                                                                                                        'view_tab')
                                                                                                        detailsText = `:
                                                                                                        <span
                                                                                                            style="color: #a855f7; font-weight: 600;">${d.tab}</span>`;
                                                                                                        else if
                                                                                                        (a.action ===
                                                                                                        'page_hidden')
                                                                                                        detailsText = `:
                                                                                                        <span
                                                                                                            style="color: #94a3b8; font-weight: 600;">${d.tab}
                                                                                                            |
                                                                                                            ${Math.floor(d.timeOnPage
                                                                                                            / 60)}m
                                                                                                            active</span>`;
                                                                                                        else if
                                                                                                        (a.action ===
                                                                                                        'click_button')
                                                                                                        detailsText = `:
                                                                                                        <span
                                                                                                            style="color: #fb7185; font-weight: 600;">${d.button}
                                                                                                            (${d.section})</span>`;
                                                                                                        else if
                                                                                                        (a.action ===
                                                                                                        'session_end')
                                                                                                        detailsText = `:
                                                                                                        <span
                                                                                                            style="color: var(--text-muted);">${Math.floor(d.duration
                                                                                                            / 60)}m
                                                                                                            active</span>`;
                                                                                                        } catch (e) { }
                                                                                                        }

                                                                                                        return `
                                                                                                        <div class="activity-item"
                                                                                                            data-category="${category}"
                                                                                                            style="padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.03); display: flex; justify-content: space-between; align-items: center; font-size: 0.85rem;">
                                                                                                            <div
                                                                                                                style="display: flex; align-items: center; gap: 12px;">
                                                                                                                <div
                                                                                                                    style="width: 32px; height: 32px; background: rgba(255,255,255,0.03); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 1rem;">
                                                                                                                    ${icon}
                                                                                                                </div>
                                                                                                                <div>
                                                                                                                    <div
                                                                                                                        style="font-weight: 700; color: var(--text-primary);">
                                                                                                                        ${displayName}
                                                                                                                    </div>
                                                                                                                    <div
                                                                                                                        style="color: var(--text-muted); font-size: 0.75rem;">
                                                                                                                        ${a.action.replace(/_/g,
                                                                                                                        '
                                                                                                                        ')}${detailsText}
                                                                                                                    </div>
                                                                                                                </div>
                                                                                                            </div>
                                                                                                            <span
                                                                                                                style="color: #4ade80; font-size: 0.75rem; font-weight: 600;">${time}</span>
                                                                                                        </div>
                                                                                                        `;
                                                                                                        }).join('');

                                                                                                        activityContainer.innerHTML
                                                                                                        = activityHtml;

                                                                                                        // Update
                                                                                                        category count
                                                                                                        badges
                                                                                                        const countAll =
                                                                                                        document.getElementById('activityCountAll');
                                                                                                        const countJobs
                                                                                                        =
                                                                                                        document.getElementById('activityCountJobs');
                                                                                                        const
                                                                                                        countSearch =
                                                                                                        document.getElementById('activityCountSearch');
                                                                                                        const
                                                                                                        countRevenue =
                                                                                                        document.getElementById('activityCountRevenue');
                                                                                                        const
                                                                                                        countBrowse =
                                                                                                        document.getElementById('activityCountBrowse');
                                                                                                        const
                                                                                                        countSession =
                                                                                                        document.getElementById('activityCountSession');

                                                                                                        if (countAll)
                                                                                                        countAll.textContent
                                                                                                        =
                                                                                                        categoryCounts.all;
                                                                                                        if (countJobs)
                                                                                                        countJobs.textContent
                                                                                                        =
                                                                                                        categoryCounts.job_logging;
                                                                                                        if (countSearch)
                                                                                                        countSearch.textContent
                                                                                                        =
                                                                                                        categoryCounts.search;
                                                                                                        if
                                                                                                        (countRevenue)
                                                                                                        countRevenue.textContent
                                                                                                        =
                                                                                                        categoryCounts.monetization;
                                                                                                        if (countBrowse)
                                                                                                        countBrowse.textContent
                                                                                                        =
                                                                                                        categoryCounts.browsing;
                                                                                                        if
                                                                                                        (countSession)
                                                                                                        countSession.textContent
                                                                                                        =
                                                                                                        categoryCounts.session;

                                                                                                        // Apply current
                                                                                                        filter (in case
                                                                                                        user already
                                                                                                        selected a
                                                                                                        category)
                                                                                                        if
                                                                                                        (currentActivityCategory
                                                                                                        !== 'all') {
                                                                                                        setActivityTab(currentActivityCategory);
                                                                                                        }
                                                                                                        }

                                                                                                        // 7. Fetch
                                                                                                        Cloudflare
                                                                                                        Analytics
                                                                                                        (separate
                                                                                                        try/catch to not
                                                                                                        break main panel
                                                                                                        on CF failure)
                                                                                                        try {
                                                                                                        const cfRes =
                                                                                                        await
                                                                                                        fetch(`${API}/api/admin/cloudflare`,
                                                                                                        authConfig);
                                                                                                        if (cfRes.ok) {
                                                                                                        const cfData =
                                                                                                        await
                                                                                                        cfRes.json();

                                                                                                        if (cfData.error
                                                                                                        ===
                                                                                                        'not_configured')
                                                                                                        {
                                                                                                        // Show config
                                                                                                        message
                                                                                                        document.getElementById('cfAnalyticsContainer').style.display
                                                                                                        = 'none';
                                                                                                        document.getElementById('cfConfigMessage').style.display
                                                                                                        = 'block';
                                                                                                        document.getElementById('cfConfigText').textContent
                                                                                                        =
                                                                                                        cfData.message;
                                                                                                        } else if
                                                                                                        (!cfData.error)
                                                                                                        {
                                                                                                        // Format bytes
                                                                                                        helper
                                                                                                        const
                                                                                                        formatBytes =
                                                                                                        (bytes) => {
                                                                                                        if (bytes <
                                                                                                            1024) return
                                                                                                            bytes + ' B'
                                                                                                            ; if (bytes
                                                                                                            < 1024 *
                                                                                                            1024) return
                                                                                                            (bytes /
                                                                                                            1024).toFixed(1)
                                                                                                            + ' KB' ; if
                                                                                                            (bytes <
                                                                                                            1024 * 1024
                                                                                                            * 1024)
                                                                                                            return
                                                                                                            (bytes /
                                                                                                            (1024 *
                                                                                                            1024)).toFixed(1)
                                                                                                            + ' MB' ;
                                                                                                            return
                                                                                                            (bytes /
                                                                                                            (1024 * 1024
                                                                                                            *
                                                                                                            1024)).toFixed(2)
                                                                                                            + ' GB' ; };
                                                                                                            // Update
                                                                                                            24h stats
                                                                                                            (Overview
                                                                                                            tab)
                                                                                                            document.getElementById('cfVisitors24h').textContent=(cfData.last24h?.visitors
                                                                                                            ||
                                                                                                            0).toLocaleString();
                                                                                                            document.getElementById('cfRequests24h').textContent=(cfData.last24h?.requests
                                                                                                            ||
                                                                                                            0).toLocaleString();
                                                                                                            document.getElementById('cfData24h').textContent=formatBytes(cfData.last24h?.bytesServed
                                                                                                            || 0);
                                                                                                            document.getElementById('cfCacheRate24h').textContent=(cfData.last24h?.cacheRate
                                                                                                            || '0.0' )
                                                                                                            + '%' ; //
                                                                                                            Update 7d
                                                                                                            stats
                                                                                                            (Overview
                                                                                                            tab)
                                                                                                            document.getElementById('cfVisitors7d').textContent=(cfData.last7d?.visitors
                                                                                                            ||
                                                                                                            0).toLocaleString();
                                                                                                            document.getElementById('cfRequests7d').textContent=(cfData.last7d?.requests
                                                                                                            ||
                                                                                                            0).toLocaleString();
                                                                                                            document.getElementById('cfData7d').textContent=formatBytes(cfData.last7d?.bytesServed
                                                                                                            || 0);
                                                                                                            document.getElementById('cfCacheRate7d').textContent=(cfData.last7d?.cacheRate
                                                                                                            || '0.0' )
                                                                                                            + '%' ;
                                                                                                            document.getElementById('cfAnalyticsContainer').style.display='grid'
                                                                                                            ;
                                                                                                            document.getElementById('cfConfigMessage').style.display='none'
                                                                                                            ; //===TECH
                                                                                                            TAB===if
                                                                                                            (cfData.tech)
                                                                                                            {
                                                                                                            document.getElementById('cfErrorRate').textContent=cfData.tech.errorRate
                                                                                                            + '%' ;
                                                                                                            document.getElementById('cfCacheRateTech').textContent=cfData.tech.cacheRate
                                                                                                            + '%' ;
                                                                                                            document.getElementById('cfThreats').textContent=(cfData.last7d?.threats
                                                                                                            ||
                                                                                                            0).toLocaleString();
                                                                                                            // Status
                                                                                                            code bars
                                                                                                            const
                                                                                                            statusGroups=cfData.tech.statusGroups
                                                                                                            || {}; const
                                                                                                            totalStatus=(statusGroups['2xx']
                                                                                                            || 0) +
                                                                                                            (statusGroups['3xx']
                                                                                                            || 0) +
                                                                                                            (statusGroups['4xx']
                                                                                                            || 0) +
                                                                                                            (statusGroups['5xx']
                                                                                                            || 0); if
                                                                                                            (totalStatus>
                                                                                                            0) {
                                                                                                            ['2xx',
                                                                                                            '3xx',
                                                                                                            '4xx',
                                                                                                            '5xx'].forEach(code
                                                                                                            => {
                                                                                                            const count
                                                                                                            =
                                                                                                            statusGroups[code]
                                                                                                            || 0;
                                                                                                            const pct =
                                                                                                            ((count /
                                                                                                            totalStatus)
                                                                                                            *
                                                                                                            100).toFixed(1);
                                                                                                            document.getElementById(`cfStatus${code}`).style.width
                                                                                                            = pct + '%';
                                                                                                            document.getElementById(`cfStatus${code}Pct`).textContent
                                                                                                            = pct + '%';
                                                                                                            });
                                                                                                            }

                                                                                                            // Security
                                                                                                            Details
                                                                                                            (Deep Dive)
                                                                                                            if
                                                                                                            (cfData.tech.securityEvents?.length
                                                                                                            > 0) {
                                                                                                            const
                                                                                                            securityList
                                                                                                            =
                                                                                                            document.getElementById('cfSecurityList');
                                                                                                            if
                                                                                                            (securityList)
                                                                                                            {
                                                                                                            const
                                                                                                            totalSec =
                                                                                                            cfData.tech.securityEvents.reduce((sum,
                                                                                                            s) => sum +
                                                                                                            s.count, 0);
                                                                                                            securityList.innerHTML
                                                                                                            =
                                                                                                            cfData.tech.securityEvents.map(s
                                                                                                            => {
                                                                                                            return `
                                                                                                            <div
                                                                                                                style="display: flex; align-items: center; justify-content: space-between;">
                                                                                                                <span
                                                                                                                    style="display: flex; align-items: center; gap: 8px;">
                                                                                                                    <span
                                                                                                                        style="color: var(--text-secondary); text-transform: capitalize;">${s.action.replace(/_/g,
                                                                                                                        '
                                                                                                                        ').toLowerCase()}</span>
                                                                                                                    <span
                                                                                                                        style="color: var(--text-muted); font-size: 0.75rem;">(${s.source})</span>
                                                                                                                </span>
                                                                                                                <span
                                                                                                                    style="color: #ef4444; font-weight: 600;">${s.count.toLocaleString()}</span>
                                                                                                            </div>
                                                                                                            `;
                                                                                                            }).join('');
                                                                                                            }
                                                                                                            } else {
                                                                                                            const
                                                                                                            securityList
                                                                                                            =
                                                                                                            document.getElementById('cfSecurityList');
                                                                                                            if
                                                                                                            (securityList)
                                                                                                            securityList.innerHTML
                                                                                                            = '<div
                                                                                                                style="color: var(--text-muted);">
                                                                                                                No
                                                                                                                security
                                                                                                                events
                                                                                                                recorded
                                                                                                            </div>';
                                                                                                            }
                                                                                                            }

                                                                                                            // ===
                                                                                                            MARKETING
                                                                                                            TAB ===
                                                                                                            if
                                                                                                            (cfData.marketing)
                                                                                                            {
                                                                                                            // Countries
                                                                                                            list
                                                                                                            const
                                                                                                            countriesList
                                                                                                            =
                                                                                                            document.getElementById('cfCountriesList');
                                                                                                            if
                                                                                                            (cfData.marketing.topCountries?.length
                                                                                                            > 0) {
                                                                                                            const
                                                                                                            totalCountryReqs
                                                                                                            =
                                                                                                            cfData.marketing.topCountries.reduce((sum,
                                                                                                            c) => sum +
                                                                                                            c.requests,
                                                                                                            0);
                                                                                                            countriesList.innerHTML
                                                                                                            =
                                                                                                            cfData.marketing.topCountries.slice(0,
                                                                                                            8).map(c =>
                                                                                                            {
                                                                                                            const pct =
                                                                                                            ((c.requests
                                                                                                            /
                                                                                                            totalCountryReqs)
                                                                                                            *
                                                                                                            100).toFixed(1);
                                                                                                            return `
                                                                                                            <div
                                                                                                                style="display: flex; align-items: center; justify-content: space-between;">
                                                                                                                <span
                                                                                                                    style="display: flex; align-items: center; gap: 8px;">
                                                                                                                    <span
                                                                                                                        style="font-size: 1.2rem;">${getCountryFlag(c.country)}</span>
                                                                                                                    <span
                                                                                                                        style="color: var(--text-secondary);">${c.country}</span>
                                                                                                                </span>
                                                                                                                <span
                                                                                                                    style="color: var(--text-primary); font-weight: 600;">${c.requests.toLocaleString()}
                                                                                                                    <span
                                                                                                                        style="color: var(--text-muted); font-weight: 400; font-size: 0.75rem;">(${pct}%)</span></span>
                                                                                                            </div>
                                                                                                            `;
                                                                                                            }).join('');
                                                                                                            } else {
                                                                                                            countriesList.innerHTML
                                                                                                            = '<div
                                                                                                                style="color: var(--text-muted);">
                                                                                                                No data
                                                                                                                available
                                                                                                            </div>';
                                                                                                            }

                                                                                                            // Devices
                                                                                                            list
                                                                                                            const
                                                                                                            devicesList
                                                                                                            =
                                                                                                            document.getElementById('cfDevicesList');
                                                                                                            if
                                                                                                            (cfData.marketing.devices?.length
                                                                                                            > 0) {
                                                                                                            const
                                                                                                            totalDeviceReqs
                                                                                                            =
                                                                                                            cfData.marketing.devices.reduce((sum,
                                                                                                            d) => sum +
                                                                                                            d.requests,
                                                                                                            0);
                                                                                                            devicesList.innerHTML
                                                                                                            =
                                                                                                            cfData.marketing.devices.map(d
                                                                                                            => {
                                                                                                            const pct =
                                                                                                            ((d.requests
                                                                                                            /
                                                                                                            totalDeviceReqs)
                                                                                                            *
                                                                                                            100).toFixed(1);
                                                                                                            return `
                                                                                                            <div
                                                                                                                style="display: flex; align-items: center; justify-content: space-between;">
                                                                                                                <span
                                                                                                                    style="display: flex; align-items: center; gap: 8px;">
                                                                                                                    <span
                                                                                                                        style="font-size: 1.2rem;">${getDeviceIcon(d.device)}</span>
                                                                                                                    <span
                                                                                                                        style="color: var(--text-secondary); text-transform: capitalize;">${d.device}</span>
                                                                                                                </span>
                                                                                                                <span
                                                                                                                    style="color: var(--text-primary); font-weight: 600;">${pct}%</span>
                                                                                                            </div>
                                                                                                            `;
                                                                                                            }).join('');
                                                                                                            } else {
                                                                                                            devicesList.innerHTML
                                                                                                            = '<div
                                                                                                                style="color: var(--text-muted);">
                                                                                                                No data
                                                                                                                available
                                                                                                            </div>';
                                                                                                            }

                                                                                                            // Browsers
                                                                                                            list
                                                                                                            const
                                                                                                            browsersList
                                                                                                            =
                                                                                                            document.getElementById('cfBrowsersList');
                                                                                                            if
                                                                                                            (cfData.marketing.topBrowsers?.length
                                                                                                            > 0) {
                                                                                                            const
                                                                                                            totalBrowserReqs
                                                                                                            =
                                                                                                            cfData.marketing.topBrowsers.reduce((sum,
                                                                                                            b) => sum +
                                                                                                            b.requests,
                                                                                                            0);
                                                                                                            browsersList.innerHTML
                                                                                                            =
                                                                                                            cfData.marketing.topBrowsers.slice(0,
                                                                                                            6).map(b =>
                                                                                                            {
                                                                                                            const pct =
                                                                                                            ((b.requests
                                                                                                            /
                                                                                                            totalBrowserReqs)
                                                                                                            *
                                                                                                            100).toFixed(1);
                                                                                                            return `
                                                                                                            <div
                                                                                                                style="display: flex; align-items: center; justify-content: space-between;">
                                                                                                                <span
                                                                                                                    style="display: flex; align-items: center; gap: 8px;">
                                                                                                                    <span
                                                                                                                        style="font-size: 1.2rem;">${getBrowserIcon(b.browser)}</span>
                                                                                                                    <span
                                                                                                                        style="color: var(--text-secondary);">${b.browser}</span>
                                                                                                                </span>
                                                                                                                <span
                                                                                                                    style="color: var(--text-primary); font-weight: 600;">${pct}%</span>
                                                                                                            </div>
                                                                                                            `;
                                                                                                            }).join('');
                                                                                                            } else {
                                                                                                            browsersList.innerHTML
                                                                                                            = '<div
                                                                                                                style="color: var(--text-muted);">
                                                                                                                No data
                                                                                                                available
                                                                                                            </div>';
                                                                                                            }

                                                                                                            // Top
                                                                                                            Content
                                                                                                            (Deep Dive)
                                                                                                            const
                                                                                                            pathsList =
                                                                                                            document.getElementById('cfPathsList');
                                                                                                            if
                                                                                                            (pathsList)
                                                                                                            {
                                                                                                            if
                                                                                                            (cfData.marketing.topPaths?.length
                                                                                                            > 0) {
                                                                                                            const
                                                                                                            totalReqs =
                                                                                                            cfData.marketing.topPaths.reduce((sum,
                                                                                                            p) => sum +
                                                                                                            p.count, 0);
                                                                                                            pathsList.innerHTML
                                                                                                            =
                                                                                                            cfData.marketing.topPaths.slice(0,
                                                                                                            8).map(p =>
                                                                                                            {
                                                                                                            const pct =
                                                                                                            ((p.count /
                                                                                                            totalReqs) *
                                                                                                            100).toFixed(1);
                                                                                                            return `
                                                                                                            <div
                                                                                                                style="display: flex; align-items: center; justify-content: space-between; overflow: hidden;">
                                                                                                                <span
                                                                                                                    style="color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 70%;"
                                                                                                                    title="${p.path}">${p.path}</span>
                                                                                                                <span
                                                                                                                    style="color: var(--text-primary); font-weight: 600;">${p.count.toLocaleString()}
                                                                                                                    <span
                                                                                                                        style="color: var(--text-muted); font-weight: 400; font-size: 0.75rem;">(${pct}%)</span></span>
                                                                                                            </div>
                                                                                                            `;
                                                                                                            }).join('');
                                                                                                            } else {
                                                                                                            pathsList.innerHTML
                                                                                                            = '<div
                                                                                                                style="color: var(--text-muted);">
                                                                                                                No path
                                                                                                                data
                                                                                                                available
                                                                                                            </div>';
                                                                                                            }
                                                                                                            }

                                                                                                            // Referrers
                                                                                                            (Deep Dive)
                                                                                                            const
                                                                                                            referrersList
                                                                                                            =
                                                                                                            document.getElementById('cfReferrersList');
                                                                                                            if
                                                                                                            (referrersList)
                                                                                                            {
                                                                                                            if
                                                                                                            (cfData.marketing.topReferrers?.length
                                                                                                            > 0) {
                                                                                                            referrersList.innerHTML
                                                                                                            =
                                                                                                            cfData.marketing.topReferrers.map(r
                                                                                                            => {
                                                                                                            return `
                                                                                                            <div
                                                                                                                style="display: flex; align-items: center; justify-content: space-between;">
                                                                                                                <span
                                                                                                                    style="color: var(--text-secondary);">${r.referrer}</span>
                                                                                                                <span
                                                                                                                    style="color: var(--text-primary); font-weight: 600;">${r.count.toLocaleString()}</span>
                                                                                                            </div>
                                                                                                            `;
                                                                                                            }).join('');
                                                                                                            } else {
                                                                                                            referrersList.innerHTML
                                                                                                            = '<div
                                                                                                                style="color: var(--text-muted);">
                                                                                                                No
                                                                                                                referrer
                                                                                                                data
                                                                                                                available
                                                                                                            </div>';
                                                                                                            }
                                                                                                            }
                                                                                                            }
                                                                                                            }
                                                                                                            }
                                                                                                            } catch
                                                                                                            (cfErr) {
                                                                                                            console.warn('Cloudflare
                                                                                                            analytics
                                                                                                            fetch
                                                                                                            failed:',
                                                                                                            cfErr);
                                                                                                            // Silently
                                                                                                            fail - don't
                                                                                                            break the
                                                                                                            dev panel
                                                                                                            }

                                                                                                            } catch
                                                                                                            (err) {
                                                                                                            console.error("Dev
                                                                                                            Panel Load
                                                                                                            Failed",
                                                                                                            err);
                                                                                                            let message
                                                                                                            =
                                                                                                            err.message
                                                                                                            || 'Data
                                                                                                            stream
                                                                                                            interrupted';
                                                                                                            let
                                                                                                            subMessage =
                                                                                                            'Please
                                                                                                            check your
                                                                                                            connection
                                                                                                            and try
                                                                                                            again.';
                                                                                                            let
                                                                                                            showSignIn =
                                                                                                            false;

                                                                                                            if
                                                                                                            (err.message
                                                                                                            ===
                                                                                                            "SESSION_EXPIRED")
                                                                                                            {
                                                                                                            message =
                                                                                                            "Session
                                                                                                            Expired";
                                                                                                            subMessage =
                                                                                                            "Your
                                                                                                            security
                                                                                                            token has
                                                                                                            timed out.
                                                                                                            Please sign
                                                                                                            out and sign
                                                                                                            in again to
                                                                                                            restore
                                                                                                            access.";
                                                                                                            showSignIn =
                                                                                                            true;
                                                                                                            } else if
                                                                                                            (err.message
                                                                                                            ===
                                                                                                            "ACCESS_DENIED")
                                                                                                            {
                                                                                                            message =
                                                                                                            "Developer
                                                                                                            Access
                                                                                                            Required";
                                                                                                            subMessage =
                                                                                                            "This panel
                                                                                                            is
                                                                                                            restricted
                                                                                                            to
                                                                                                            authorized
                                                                                                            platform
                                                                                                            maintainers.";
                                                                                                            }

                                                                                                            const
                                                                                                            errorHtml =
                                                                                                            `
                                                                                                            <div
                                                                                                                style="padding: 60px 20px; text-align: center; color: var(--text-muted);">
                                                                                                                <div
                                                                                                                    style="font-size: 3rem; margin-bottom: 20px; opacity: 0.5;">
                                                                                                                    ðŸ”’
                                                                                                                </div>
                                                                                                                <h3
                                                                                                                    style="color: var(--text-primary); margin-bottom: 8px;">
                                                                                                                    ${message}
                                                                                                                </h3>
                                                                                                                <p
                                                                                                                    style="font-size: 0.9rem; margin-bottom: 24px;">
                                                                                                                    ${subMessage}
                                                                                                                </p>
                                                                                                                ${showSignIn
                                                                                                                ?
                                                                                                                `<button
                                                                                                                    onclick="signOut()"
                                                                                                                    style="padding: 10px 24px; border-radius: 12px; background: var(--brand-primary); color: white; border: none; font-weight: 600; cursor: pointer; transition: all 0.2s; box-shadow: 0 4px 12px rgba(251, 191, 36, 0.3);">ðŸ”„
                                                                                                                    Refresh
                                                                                                                    Session
                                                                                                                    (Sign
                                                                                                                    Out)</button>`
                                                                                                                : ''}
                                                                                                            </div>
                                                                                                            `;

                                                                                                            // Clear all
                                                                                                            loading
                                                                                                            states
                                                                                                            if
                                                                                                            (document.getElementById('devUsersTable'))
                                                                                                            document.getElementById('devUsersTable').innerHTML
                                                                                                            = `<tr>
                                                                                                                <td
                                                                                                                    colspan="6">
                                                                                                                    ${errorHtml}
                                                                                                                </td>
                                                                                                            </tr>`;
                                                                                                            if
                                                                                                            (document.getElementById('devActivityLogs'))
                                                                                                            document.getElementById('devActivityLogs').innerHTML
                                                                                                            = errorHtml;

                                                                                                            // Clear
                                                                                                            KPIs
                                                                                                            ['devTotalUsers',
                                                                                                            'devEstRevenue',
                                                                                                            'devConversionRate',
                                                                                                            'devAvgEngagement'].forEach(id
                                                                                                            => {
                                                                                                            const el =
                                                                                                            document.getElementById(id);
                                                                                                            if (el)
                                                                                                            el.textContent
                                                                                                            = '--';
                                                                                                            });
                                                                                                            }
                                                                                                            devPanelLoaded
                                                                                                            = true;
                                                                                                            }


                                                                                                            //
                                                                                                            ==================
                                                                                                            INVENTORY
                                                                                                            MANAGER
                                                                                                            ==================

                                                                                                            // Helper to
                                                                                                            get auth
                                                                                                            headers for
                                                                                                            API calls
                                                                                                            (Bearer
                                                                                                            token from
                                                                                                            localStorage)
                                                                                                            function
                                                                                                            getAuthHeaders()
                                                                                                            {
                                                                                                            const token
                                                                                                            =
                                                                                                            localStorage.getItem('eurokeys_session_token');
                                                                                                            return token
                                                                                                            ? {
                                                                                                            'Authorization':
                                                                                                            `Bearer
                                                                                                            ${token}` }
                                                                                                            : {};
                                                                                                            }

                                                                                                            const
                                                                                                            InventoryManager
                                                                                                            = {
                                                                                                            KEYS_STORAGE_KEY:
                                                                                                            'eurokeys_inventory_keys_v2',
                                                                                                            BLANKS_STORAGE_KEY:
                                                                                                            'eurokeys_inventory_blanks_v2',
                                                                                                            lastEtag:
                                                                                                            null, // For
                                                                                                            ETag-based
                                                                                                            cache
                                                                                                            validation

                                                                                                            // Get all
                                                                                                            keys
                                                                                                            inventory
                                                                                                            (format: {
                                                                                                            itemKey: {
                                                                                                            qty,
                                                                                                            vehicle,
                                                                                                            amazonLink }
                                                                                                            })
                                                                                                            getKeysInventory()
                                                                                                            {
                                                                                                            try {
                                                                                                            const data =
                                                                                                            localStorage.getItem(this.KEYS_STORAGE_KEY);
                                                                                                            if (data)
                                                                                                            return
                                                                                                            JSON.parse(data);

                                                                                                            // Migrate
                                                                                                            from old
                                                                                                            format if
                                                                                                            exists
                                                                                                            const
                                                                                                            oldData =
                                                                                                            localStorage.getItem('eurokeys_inventory_keys');
                                                                                                            if (oldData)
                                                                                                            {
                                                                                                            const old =
                                                                                                            JSON.parse(oldData);
                                                                                                            const
                                                                                                            migrated =
                                                                                                            {};
                                                                                                            Object.entries(old).forEach(([key,
                                                                                                            qty]) => {
                                                                                                            migrated[key]
                                                                                                            = { qty,
                                                                                                            vehicle:
                                                                                                            null,
                                                                                                            amazonLink:
                                                                                                            null };
                                                                                                            });
                                                                                                            this.setKeysInventory(migrated);
                                                                                                            return
                                                                                                            migrated;
                                                                                                            }
                                                                                                            return {};
                                                                                                            } catch (e)
                                                                                                            {
                                                                                                            console.error('Error
                                                                                                            reading keys
                                                                                                            inventory:',
                                                                                                            e);
                                                                                                            return {};
                                                                                                            }
                                                                                                            },

                                                                                                            // Get all
                                                                                                            blanks
                                                                                                            inventory
                                                                                                            getBlanksInventory()
                                                                                                            {
                                                                                                            try {
                                                                                                            const data =
                                                                                                            localStorage.getItem(this.BLANKS_STORAGE_KEY);
                                                                                                            if (data)
                                                                                                            return
                                                                                                            JSON.parse(data);

                                                                                                            // Migrate
                                                                                                            from old
                                                                                                            format
                                                                                                            const
                                                                                                            oldData =
                                                                                                            localStorage.getItem('eurokeys_inventory_blanks');
                                                                                                            if (oldData)
                                                                                                            {
                                                                                                            const old =
                                                                                                            JSON.parse(oldData);
                                                                                                            const
                                                                                                            migrated =
                                                                                                            {};
                                                                                                            Object.entries(old).forEach(([key,
                                                                                                            qty]) => {
                                                                                                            migrated[key]
                                                                                                            = { qty,
                                                                                                            vehicle:
                                                                                                            null,
                                                                                                            amazonLink:
                                                                                                            null };
                                                                                                            });
                                                                                                            this.setBlanksInventory(migrated);
                                                                                                            return
                                                                                                            migrated;
                                                                                                            }
                                                                                                            return {};
                                                                                                            } catch (e)
                                                                                                            {
                                                                                                            console.error('Error
                                                                                                            reading
                                                                                                            blanks
                                                                                                            inventory:',
                                                                                                            e);
                                                                                                            return {};
                                                                                                            }
                                                                                                            },

                                                                                                            setKeysInventory(data)
                                                                                                            {
                                                                                                            try {
                                                                                                            localStorage.setItem(this.KEYS_STORAGE_KEY,
                                                                                                            JSON.stringify(data));
                                                                                                            } catch (e)
                                                                                                            {
                                                                                                            console.error('Error
                                                                                                            saving keys
                                                                                                            inventory:',
                                                                                                            e);
                                                                                                            }
                                                                                                            },

                                                                                                            setBlanksInventory(data)
                                                                                                            {
                                                                                                            try {
                                                                                                            localStorage.setItem(this.BLANKS_STORAGE_KEY,
                                                                                                            JSON.stringify(data));
                                                                                                            } catch (e)
                                                                                                            {
                                                                                                            console.error('Error
                                                                                                            saving
                                                                                                            blanks
                                                                                                            inventory:',
                                                                                                            e);
                                                                                                            }
                                                                                                            },

                                                                                                            // Get stock
                                                                                                            for a key
                                                                                                            (remote/fob)
                                                                                                            getKeyStock(itemKey)
                                                                                                            {
                                                                                                            const inv =
                                                                                                            this.getKeysInventory();
                                                                                                            return
                                                                                                            inv[itemKey]?.qty
                                                                                                            || 0;
                                                                                                            },

                                                                                                            // Get stock
                                                                                                            for a blank
                                                                                                            (keyway)
                                                                                                            getBlankStock(keyway)
                                                                                                            {
                                                                                                            const inv =
                                                                                                            this.getBlanksInventory();
                                                                                                            return
                                                                                                            inv[keyway]?.qty
                                                                                                            || 0;
                                                                                                            },

                                                                                                            // Get full
                                                                                                            item data
                                                                                                            getKeyItem(itemKey)
                                                                                                            {
                                                                                                            const inv =
                                                                                                            this.getKeysInventory();
                                                                                                            return
                                                                                                            inv[itemKey]
                                                                                                            || null;
                                                                                                            },

                                                                                                            getBlankItem(keyway)
                                                                                                            {
                                                                                                            const inv =
                                                                                                            this.getBlanksInventory();
                                                                                                            return
                                                                                                            inv[keyway]
                                                                                                            || null;
                                                                                                            },

                                                                                                            // Legacy
                                                                                                            method for
                                                                                                            backwards
                                                                                                            compatibility
                                                                                                            getStock(itemKey)
                                                                                                            {
                                                                                                            return
                                                                                                            this.getKeyStock(itemKey);
                                                                                                            },

                                                                                                            // Add stock
                                                                                                            with
                                                                                                            metadata
                                                                                                            addKeyStock(itemKey,
                                                                                                            qty = 1,
                                                                                                            vehicle =
                                                                                                            null,
                                                                                                            amazonLink =
                                                                                                            null) {
                                                                                                            const inv =
                                                                                                            this.getKeysInventory();
                                                                                                            if
                                                                                                            (!inv[itemKey])
                                                                                                            {
                                                                                                            inv[itemKey]
                                                                                                            = { qty: 0,
                                                                                                            vehicle:
                                                                                                            null,
                                                                                                            amazonLink:
                                                                                                            null };
                                                                                                            }
                                                                                                            inv[itemKey].qty
                                                                                                            += qty;
                                                                                                            // Update
                                                                                                            metadata if
                                                                                                            provided
                                                                                                            (keeps
                                                                                                            latest)
                                                                                                            if (vehicle)
                                                                                                            inv[itemKey].vehicle
                                                                                                            = vehicle;
                                                                                                            if
                                                                                                            (amazonLink)
                                                                                                            inv[itemKey].amazonLink
                                                                                                            =
                                                                                                            amazonLink;
                                                                                                            this.setKeysInventory(inv);
                                                                                                            // Sync to
                                                                                                            cloud for
                                                                                                            logged-in
                                                                                                            users
                                                                                                            this.syncToCloud(itemKey,
                                                                                                            'key',
                                                                                                            inv[itemKey].qty,
                                                                                                            inv[itemKey].used
                                                                                                            || 0,
                                                                                                            inv[itemKey].vehicle,
                                                                                                            inv[itemKey].amazonLink);
                                                                                                            return
                                                                                                            inv[itemKey].qty;
                                                                                                            },

                                                                                                            addBlankStock(keyway,
                                                                                                            qty = 1,
                                                                                                            vehicle =
                                                                                                            null,
                                                                                                            amazonLink =
                                                                                                            null) {
                                                                                                            const inv =
                                                                                                            this.getBlanksInventory();
                                                                                                            if
                                                                                                            (!inv[keyway])
                                                                                                            {
                                                                                                            inv[keyway]
                                                                                                            = { qty: 0,
                                                                                                            vehicle:
                                                                                                            null,
                                                                                                            amazonLink:
                                                                                                            null };
                                                                                                            }
                                                                                                            inv[keyway].qty
                                                                                                            += qty;
                                                                                                            if (vehicle)
                                                                                                            inv[keyway].vehicle
                                                                                                            = vehicle;
                                                                                                            if
                                                                                                            (amazonLink)
                                                                                                            inv[keyway].amazonLink
                                                                                                            =
                                                                                                            amazonLink;
                                                                                                            this.setBlanksInventory(inv);
                                                                                                            // Sync to
                                                                                                            cloud for
                                                                                                            logged-in
                                                                                                            users
                                                                                                            this.syncToCloud(keyway,
                                                                                                            'blank',
                                                                                                            inv[keyway].qty,
                                                                                                            inv[keyway].used
                                                                                                            || 0,
                                                                                                            inv[keyway].vehicle,
                                                                                                            inv[keyway].amazonLink);
                                                                                                            return
                                                                                                            inv[keyway].qty;
                                                                                                            },

                                                                                                            // Legacy
                                                                                                            method
                                                                                                            addStock(itemKey,
                                                                                                            qty = 1,
                                                                                                            vehicle =
                                                                                                            null,
                                                                                                            amazonLink =
                                                                                                            null) {
                                                                                                            return
                                                                                                            this.addKeyStock(itemKey,
                                                                                                            qty,
                                                                                                            vehicle,
                                                                                                            amazonLink);
                                                                                                            },

                                                                                                            useKeyStock(itemKey,
                                                                                                            qty = 1) {
                                                                                                            const inv =
                                                                                                            this.getKeysInventory();
                                                                                                            if
                                                                                                            (inv[itemKey])
                                                                                                            {
                                                                                                            const
                                                                                                            actualUsed =
                                                                                                            Math.min(qty,
                                                                                                            inv[itemKey].qty);
                                                                                                            inv[itemKey].qty
                                                                                                            =
                                                                                                            Math.max(0,
                                                                                                            inv[itemKey].qty
                                                                                                            - qty);
                                                                                                            inv[itemKey].used
                                                                                                            =
                                                                                                            (inv[itemKey].used
                                                                                                            || 0) +
                                                                                                            actualUsed;
                                                                                                            this.setKeysInventory(inv);
                                                                                                            // Sync to
                                                                                                            cloud
                                                                                                            this.syncToCloud(itemKey,
                                                                                                            'key',
                                                                                                            inv[itemKey].qty,
                                                                                                            inv[itemKey].used
                                                                                                            || 0,
                                                                                                            inv[itemKey].vehicle,
                                                                                                            inv[itemKey].amazonLink);
                                                                                                            return
                                                                                                            inv[itemKey].qty;
                                                                                                            }
                                                                                                            return 0;
                                                                                                            },

                                                                                                            useBlankStock(keyway,
                                                                                                            qty = 1) {
                                                                                                            const inv =
                                                                                                            this.getBlanksInventory();
                                                                                                            if
                                                                                                            (inv[keyway])
                                                                                                            {
                                                                                                            const
                                                                                                            actualUsed =
                                                                                                            Math.min(qty,
                                                                                                            inv[keyway].qty);
                                                                                                            inv[keyway].qty
                                                                                                            =
                                                                                                            Math.max(0,
                                                                                                            inv[keyway].qty
                                                                                                            - qty);
                                                                                                            inv[keyway].used
                                                                                                            =
                                                                                                            (inv[keyway].used
                                                                                                            || 0) +
                                                                                                            actualUsed;
                                                                                                            this.setBlanksInventory(inv);
                                                                                                            // Sync to
                                                                                                            cloud
                                                                                                            this.syncToCloud(keyway,
                                                                                                            'blank',
                                                                                                            inv[keyway].qty,
                                                                                                            inv[keyway].used
                                                                                                            || 0,
                                                                                                            inv[keyway].vehicle,
                                                                                                            inv[keyway].amazonLink);
                                                                                                            return
                                                                                                            inv[keyway].qty;
                                                                                                            }
                                                                                                            return 0;
                                                                                                            },

                                                                                                            // Legacy
                                                                                                            method
                                                                                                            useStock(itemKey,
                                                                                                            qty = 1) {
                                                                                                            return
                                                                                                            this.useKeyStock(itemKey,
                                                                                                            qty);
                                                                                                            },

                                                                                                            // Get total
                                                                                                            counts
                                                                                                            getTotalKeys()
                                                                                                            {
                                                                                                            const inv =
                                                                                                            this.getKeysInventory();
                                                                                                            return
                                                                                                            Object.values(inv).reduce((sum,
                                                                                                            item) => sum
                                                                                                            + (item?.qty
                                                                                                            || 0), 0);
                                                                                                            },

                                                                                                            getTotalBlanks()
                                                                                                            {
                                                                                                            const inv =
                                                                                                            this.getBlanksInventory();
                                                                                                            return
                                                                                                            Object.values(inv).reduce((sum,
                                                                                                            item) => sum
                                                                                                            + (item?.qty
                                                                                                            || 0), 0);
                                                                                                            },

                                                                                                            // Get total
                                                                                                            used counts
                                                                                                            getTotalUsedKeys()
                                                                                                            {
                                                                                                            const inv =
                                                                                                            this.getKeysInventory();
                                                                                                            return
                                                                                                            Object.values(inv).reduce((sum,
                                                                                                            item) => sum
                                                                                                            +
                                                                                                            (item?.used
                                                                                                            || 0), 0);
                                                                                                            },

                                                                                                            getTotalUsedBlanks()
                                                                                                            {
                                                                                                            const inv =
                                                                                                            this.getBlanksInventory();
                                                                                                            return
                                                                                                            Object.values(inv).reduce((sum,
                                                                                                            item) => sum
                                                                                                            +
                                                                                                            (item?.used
                                                                                                            || 0), 0);
                                                                                                            },

                                                                                                            // Get all
                                                                                                            items for
                                                                                                            display
                                                                                                            getAllKeys()
                                                                                                            {
                                                                                                            return
                                                                                                            this.getKeysInventory();
                                                                                                            },

                                                                                                            getAllBlanks()
                                                                                                            {
                                                                                                            return
                                                                                                            this.getBlanksInventory();
                                                                                                            },

                                                                                                            //
                                                                                                            ==========
                                                                                                            CLOUD SYNC
                                                                                                            METHODS
                                                                                                            ==========

                                                                                                            // Load
                                                                                                            inventory
                                                                                                            from cloud
                                                                                                            on login
                                                                                                            async
                                                                                                            loadFromCloud()
                                                                                                            {
                                                                                                            if
                                                                                                            (!currentUser)
                                                                                                            {
                                                                                                            console.log('ðŸ“¦
                                                                                                            Inventory:
                                                                                                            Not logged
                                                                                                            in, using
                                                                                                            localStorage
                                                                                                            only');
                                                                                                            return
                                                                                                            false;
                                                                                                            }
                                                                                                            try {
                                                                                                            // Include
                                                                                                            ETag for
                                                                                                            efficient
                                                                                                            revalidation
                                                                                                            const
                                                                                                            headers = {
                                                                                                            ...getAuthHeaders()
                                                                                                            };
                                                                                                            if
                                                                                                            (this.lastEtag)
                                                                                                            {
                                                                                                            headers['If-None-Match']
                                                                                                            =
                                                                                                            this.lastEtag;
                                                                                                            }

                                                                                                            const
                                                                                                            response =
                                                                                                            await
                                                                                                            fetch(`${API}/api/user/inventory`,
                                                                                                            { headers
                                                                                                            });

                                                                                                            // Handle
                                                                                                            304 Not
                                                                                                            Modified -
                                                                                                            data hasn't
                                                                                                            changed
                                                                                                            if
                                                                                                            (response.status
                                                                                                            === 304) {
                                                                                                            console.log('ðŸ“¦
                                                                                                            Inventory:
                                                                                                            304 Not
                                                                                                            Modified -
                                                                                                            using cached
                                                                                                            data');
                                                                                                            this.lastSyncTime
                                                                                                            =
                                                                                                            Date.now();
                                                                                                            this.lastSyncError
                                                                                                            = null;
                                                                                                            return true;
                                                                                                            // Data is
                                                                                                            still valid
                                                                                                            }

                                                                                                            if
                                                                                                            (response.status
                                                                                                            === 401) {
                                                                                                            console.warn('Session
                                                                                                            expired
                                                                                                            (401)');
                                                                                                            signOut();
                                                                                                            alert('Session
                                                                                                            expired.
                                                                                                            Please sign
                                                                                                            in again.');
                                                                                                            return
                                                                                                            false;
                                                                                                            }
                                                                                                            if
                                                                                                            (!response.ok)
                                                                                                            {
                                                                                                            console.warn('ðŸ“¦
                                                                                                            Inventory:
                                                                                                            Cloud sync
                                                                                                            unavailable',
                                                                                                            response.status);
                                                                                                            return
                                                                                                            false;
                                                                                                            }

                                                                                                            // Store
                                                                                                            ETag for
                                                                                                            future
                                                                                                            requests
                                                                                                            const etag =
                                                                                                            response.headers.get('ETag');
                                                                                                            if (etag) {
                                                                                                            this.lastEtag
                                                                                                            = etag;
                                                                                                            }

                                                                                                            const data =
                                                                                                            await
                                                                                                            response.json();
                                                                                                            const
                                                                                                            cloudKeyCount
                                                                                                            =
                                                                                                            Object.keys(data.keys
                                                                                                            ||
                                                                                                            {}).length;
                                                                                                            const
                                                                                                            cloudBlankCount
                                                                                                            =
                                                                                                            Object.keys(data.blanks
                                                                                                            ||
                                                                                                            {}).length;

                                                                                                            // Get local
                                                                                                            data
                                                                                                            const
                                                                                                            localKeys =
                                                                                                            this.getKeysInventory();
                                                                                                            const
                                                                                                            localBlanks
                                                                                                            =
                                                                                                            this.getBlanksInventory();
                                                                                                            const
                                                                                                            localKeyCount
                                                                                                            =
                                                                                                            Object.keys(localKeys).length;
                                                                                                            const
                                                                                                            localBlankCount
                                                                                                            =
                                                                                                            Object.keys(localBlanks).length;

                                                                                                            console.log('ðŸ“¦
                                                                                                            Inventory:
                                                                                                            Cloud has',
                                                                                                            cloudKeyCount,
                                                                                                            'keys,',
                                                                                                            cloudBlankCount,
                                                                                                            'blanks');
                                                                                                            console.log('ðŸ“¦
                                                                                                            Inventory:
                                                                                                            Local has',
                                                                                                            localKeyCount,
                                                                                                            'keys,',
                                                                                                            localBlankCount,
                                                                                                            'blanks');

                                                                                                            // If cloud
                                                                                                            is empty but
                                                                                                            local has
                                                                                                            data, upload
                                                                                                            local to
                                                                                                            cloud
                                                                                                            if
                                                                                                            (cloudKeyCount
                                                                                                            === 0 &&
                                                                                                            cloudBlankCount
                                                                                                            === 0 &&
                                                                                                            (localKeyCount
                                                                                                            > 0 ||
                                                                                                            localBlankCount
                                                                                                            > 0)) {
                                                                                                            console.log('ðŸ“¦
                                                                                                            Inventory:
                                                                                                            Cloud is
                                                                                                            empty,
                                                                                                            uploading
                                                                                                            local
                                                                                                            data...');
                                                                                                            // Upload
                                                                                                            all local
                                                                                                            keys
                                                                                                            (including
                                                                                                            used
                                                                                                            history)
                                                                                                            for (const
                                                                                                            [key, item]
                                                                                                            of
                                                                                                            Object.entries(localKeys))
                                                                                                            {
                                                                                                            if (item &&
                                                                                                            (item.qty >
                                                                                                            0 ||
                                                                                                            item.used >
                                                                                                            0)) {
                                                                                                            await
                                                                                                            this.syncToCloud(key,
                                                                                                            'key',
                                                                                                            item.qty,
                                                                                                            item.used ||
                                                                                                            0,
                                                                                                            item.vehicle,
                                                                                                            item.amazonLink);
                                                                                                            }
                                                                                                            }
                                                                                                            // Upload
                                                                                                            all local
                                                                                                            blanks
                                                                                                            (including
                                                                                                            used
                                                                                                            history)
                                                                                                            for (const
                                                                                                            [key, item]
                                                                                                            of
                                                                                                            Object.entries(localBlanks))
                                                                                                            {
                                                                                                            if (item &&
                                                                                                            (item.qty >
                                                                                                            0 ||
                                                                                                            item.used >
                                                                                                            0)) {
                                                                                                            await
                                                                                                            this.syncToCloud(key,
                                                                                                            'blank',
                                                                                                            item.qty,
                                                                                                            item.used ||
                                                                                                            0,
                                                                                                            item.vehicle,
                                                                                                            item.amazonLink);
                                                                                                            }
                                                                                                            }
                                                                                                            console.log('ðŸ“¦
                                                                                                            Inventory:
                                                                                                            Uploaded
                                                                                                            local data
                                                                                                            to cloud');
                                                                                                            return true;
                                                                                                            }

                                                                                                            // If cloud
                                                                                                            has data,
                                                                                                            use it
                                                                                                            (cloud is
                                                                                                            source of
                                                                                                            truth)
                                                                                                            if
                                                                                                            (cloudKeyCount
                                                                                                            > 0) {
                                                                                                            const
                                                                                                            keysData =
                                                                                                            {};
                                                                                                            Object.entries(data.keys).forEach(([key,
                                                                                                            item]) => {
                                                                                                            keysData[key]
                                                                                                            = { qty:
                                                                                                            item.qty,
                                                                                                            used:
                                                                                                            item.used ||
                                                                                                            0, vehicle:
                                                                                                            item.vehicle,
                                                                                                            amazonLink:
                                                                                                            item.amazonLink
                                                                                                            };
                                                                                                            });
                                                                                                            this.setKeysInventory(keysData);
                                                                                                            }
                                                                                                            if
                                                                                                            (cloudBlankCount
                                                                                                            > 0) {
                                                                                                            const
                                                                                                            blanksData =
                                                                                                            {};
                                                                                                            Object.entries(data.blanks).forEach(([key,
                                                                                                            item]) => {
                                                                                                            blanksData[key]
                                                                                                            = { qty:
                                                                                                            item.qty,
                                                                                                            used:
                                                                                                            item.used ||
                                                                                                            0, vehicle:
                                                                                                            item.vehicle,
                                                                                                            amazonLink:
                                                                                                            item.amazonLink
                                                                                                            };
                                                                                                            });
                                                                                                            this.setBlanksInventory(blanksData);
                                                                                                            }

                                                                                                            console.log('ðŸ“¦
                                                                                                            Inventory:
                                                                                                            Loaded from
                                                                                                            cloud');
                                                                                                            this.lastSyncTime
                                                                                                            =
                                                                                                            Date.now();
                                                                                                            this.lastSyncError
                                                                                                            = null;
                                                                                                            updateInventoryTabBadge();
                                                                                                            // Re-render
                                                                                                            inventory
                                                                                                            page if it's
                                                                                                            currently
                                                                                                            visible
                                                                                                            const
                                                                                                            inventoryContent
                                                                                                            =
                                                                                                            document.getElementById('tabInventory');
                                                                                                            if
                                                                                                            (inventoryContent
                                                                                                            &&
                                                                                                            inventoryContent.style.display
                                                                                                            !== 'none')
                                                                                                            {
                                                                                                            renderInventoryPage();
                                                                                                            }
                                                                                                            return true;
                                                                                                            } catch (e)
                                                                                                            {
                                                                                                            console.error('ðŸ“¦
                                                                                                            Inventory:
                                                                                                            Cloud load
                                                                                                            failed', e);
                                                                                                            this.lastSyncError
                                                                                                            = e.message;
                                                                                                            return
                                                                                                            false;
                                                                                                            }
                                                                                                            },

                                                                                                            // Sync
                                                                                                            single item
                                                                                                            to cloud
                                                                                                            async
                                                                                                            syncToCloud(item_key,
                                                                                                            type, qty,
                                                                                                            used = 0,
                                                                                                            vehicle =
                                                                                                            null,
                                                                                                            amazon_link
                                                                                                            = null) {
                                                                                                            if
                                                                                                            (!currentUser)
                                                                                                            return
                                                                                                            false;
                                                                                                            try {
                                                                                                            const res =
                                                                                                            await
                                                                                                            fetch(`${API}/api/user/inventory`,
                                                                                                            {
                                                                                                            method:
                                                                                                            'POST',
                                                                                                            headers: {
                                                                                                            ...getAuthHeaders(),
                                                                                                            'Content-Type':
                                                                                                            'application/json'
                                                                                                            },
                                                                                                            body:
                                                                                                            JSON.stringify({
                                                                                                            item_key,
                                                                                                            type, qty,
                                                                                                            used,
                                                                                                            vehicle,
                                                                                                            amazon_link
                                                                                                            })
                                                                                                            });
                                                                                                            if
                                                                                                            (res.status
                                                                                                            === 401) {
                                                                                                            console.warn('Session
                                                                                                            expired
                                                                                                            (401)');
                                                                                                            signOut();
                                                                                                            return
                                                                                                            false;
                                                                                                            }
                                                                                                            console.log('â˜ï¸
                                                                                                            Synced to
                                                                                                            cloud:',
                                                                                                            item_key,
                                                                                                            type, qty);
                                                                                                            return true;
                                                                                                            } catch (e)
                                                                                                            {
                                                                                                            console.error('â˜ï¸
                                                                                                            Cloud sync
                                                                                                            failed:',
                                                                                                            e);
                                                                                                            return
                                                                                                            false;
                                                                                                            }
                                                                                                            },

                                                                                                            // Delete
                                                                                                            item from
                                                                                                            cloud
                                                                                                            async
                                                                                                            deleteFromCloud(item_key,
                                                                                                            type) {
                                                                                                            if
                                                                                                            (!currentUser)
                                                                                                            return
                                                                                                            false;
                                                                                                            try {
                                                                                                            const res =
                                                                                                            await
                                                                                                            fetch(`${API}/api/user/inventory`,
                                                                                                            {
                                                                                                            method:
                                                                                                            'DELETE',
                                                                                                            headers: {
                                                                                                            ...getAuthHeaders(),
                                                                                                            'Content-Type':
                                                                                                            'application/json'
                                                                                                            },
                                                                                                            body:
                                                                                                            JSON.stringify({
                                                                                                            item_key,
                                                                                                            type })
                                                                                                            });
                                                                                                            if
                                                                                                            (res.status
                                                                                                            === 401) {
                                                                                                            console.warn('Session
                                                                                                            expired
                                                                                                            (401)');
                                                                                                            signOut();
                                                                                                            return
                                                                                                            false;
                                                                                                            }
                                                                                                            console.log('ðŸ—‘ï¸
                                                                                                            Deleted from
                                                                                                            cloud:',
                                                                                                            item_key,
                                                                                                            type);
                                                                                                            return true;
                                                                                                            } catch (e)
                                                                                                            {
                                                                                                            console.error('ðŸ—‘ï¸
                                                                                                            Cloud delete
                                                                                                            failed:',
                                                                                                            e);
                                                                                                            return
                                                                                                            false;
                                                                                                            }
                                                                                                            },

                                                                                                            // Load job
                                                                                                            logs from
                                                                                                            cloud
                                                                                                            async
                                                                                                            loadJobLogsFromCloud()
                                                                                                            {
                                                                                                            if
                                                                                                            (!currentUser)
                                                                                                            return
                                                                                                            false;
                                                                                                            try {
                                                                                                            const
                                                                                                            response =
                                                                                                            await
                                                                                                            fetch(`${API}/api/user/job_logs`,
                                                                                                            {
                                                                                                            headers:
                                                                                                            getAuthHeaders()
                                                                                                            });
                                                                                                            if
                                                                                                            (!response.ok)
                                                                                                            return
                                                                                                            false;

                                                                                                            const data =
                                                                                                            await
                                                                                                            response.json();
                                                                                                            if
                                                                                                            (data.logs
                                                                                                            &&
                                                                                                            Array.isArray(data.logs)
                                                                                                            &&
                                                                                                            data.logs.length
                                                                                                            > 0) {
                                                                                                            const
                                                                                                            cloudLogs =
                                                                                                            data.logs;
                                                                                                            const
                                                                                                            localLogs =
                                                                                                            JSON.parse(localStorage.getItem('eurokeys_job_logs')
                                                                                                            || '[]');

                                                                                                            // Merge
                                                                                                            logs based
                                                                                                            on ID,
                                                                                                            preferring
                                                                                                            cloud as
                                                                                                            source of
                                                                                                            truth for
                                                                                                            same ID
                                                                                                            const
                                                                                                            mergedMap =
                                                                                                            new Map();

                                                                                                            // Add local
                                                                                                            first
                                                                                                            localLogs.forEach(log
                                                                                                            => {
                                                                                                            if (log.id)
                                                                                                            mergedMap.set(log.id,
                                                                                                            log);
                                                                                                            });

                                                                                                            // Add cloud
                                                                                                            (overwrites
                                                                                                            local)
                                                                                                            cloudLogs.forEach(log
                                                                                                            => {
                                                                                                            if (log.id)
                                                                                                            mergedMap.set(log.id,
                                                                                                            log);
                                                                                                            });

                                                                                                            const
                                                                                                            mergedLogs =
                                                                                                            Array.from(mergedMap.values());
                                                                                                            // Sort by
                                                                                                            created_at
                                                                                                            desc
                                                                                                            mergedLogs.sort((a,
                                                                                                            b) =>
                                                                                                            (b.created_at
                                                                                                            || 0) -
                                                                                                            (a.created_at
                                                                                                            || 0));

                                                                                                            localStorage.setItem('eurokeys_job_logs',
                                                                                                            JSON.stringify(mergedLogs));
                                                                                                            console.log('ðŸ“‹
                                                                                                            Job Logs
                                                                                                            loaded from
                                                                                                            cloud:',
                                                                                                            mergedLogs.length);
                                                                                                            return true;
                                                                                                            }
                                                                                                            return
                                                                                                            false;
                                                                                                            } catch (e)
                                                                                                            {
                                                                                                            console.error('ðŸ“‹
                                                                                                            Job Logs
                                                                                                            load
                                                                                                            failed:',
                                                                                                            e);
                                                                                                            return
                                                                                                            false;
                                                                                                            }
                                                                                                            },

                                                                                                            // Delete
                                                                                                            item
                                                                                                            completely
                                                                                                            (for X
                                                                                                            button)
                                                                                                            deleteItem(itemKey,
                                                                                                            type =
                                                                                                            'key') {
                                                                                                            if (type ===
                                                                                                            'key') {
                                                                                                            const inv =
                                                                                                            this.getKeysInventory();
                                                                                                            delete
                                                                                                            inv[itemKey];
                                                                                                            this.setKeysInventory(inv);
                                                                                                            } else {
                                                                                                            const inv =
                                                                                                            this.getBlanksInventory();
                                                                                                            delete
                                                                                                            inv[itemKey];
                                                                                                            this.setBlanksInventory(inv);
                                                                                                            }
                                                                                                            // Sync
                                                                                                            deletion to
                                                                                                            cloud
                                                                                                            this.deleteFromCloud(itemKey,
                                                                                                            type);
                                                                                                            updateInventoryTabBadge();
                                                                                                            },

                                                                                                            // Sync
                                                                                                            status
                                                                                                            tracking
                                                                                                            lastSyncTime:
                                                                                                            null,
                                                                                                            lastSyncError:
                                                                                                            null,

                                                                                                            getSyncStatus()
                                                                                                            {
                                                                                                            if
                                                                                                            (this.lastSyncError)
                                                                                                            {
                                                                                                            return {
                                                                                                            status:
                                                                                                            'error',
                                                                                                            message:
                                                                                                            this.lastSyncError,
                                                                                                            time:
                                                                                                            this.lastSyncTime
                                                                                                            };
                                                                                                            }
                                                                                                            if
                                                                                                            (this.lastSyncTime)
                                                                                                            {
                                                                                                            const ago =
                                                                                                            Math.floor((Date.now()
                                                                                                            -
                                                                                                            this.lastSyncTime)
                                                                                                            / 1000);
                                                                                                            let timeStr;
                                                                                                            if (ago <
                                                                                                                60)
                                                                                                                timeStr='Just now'
                                                                                                                ; else
                                                                                                                if (ago
                                                                                                                < 3600)
                                                                                                                timeStr=`${Math.floor(ago
                                                                                                                / 60)}m
                                                                                                                ago`;
                                                                                                                else
                                                                                                                timeStr=`${Math.floor(ago
                                                                                                                /
                                                                                                                3600)}h
                                                                                                                ago`;
                                                                                                                return {
                                                                                                                status: 'ok'
                                                                                                                ,
                                                                                                                message:
                                                                                                                `Synced
                                                                                                                ${timeStr}`,
                                                                                                                time:
                                                                                                                this.lastSyncTime
                                                                                                                }; }
                                                                                                                return {
                                                                                                                status: 'unknown'
                                                                                                                ,
                                                                                                                message: 'Not synced'
                                                                                                                , time:
                                                                                                                null };
                                                                                                                }, //
                                                                                                                Clear
                                                                                                                all
                                                                                                                local
                                                                                                                data and
                                                                                                                force
                                                                                                                fresh
                                                                                                                cloud
                                                                                                                sync
                                                                                                                async
                                                                                                                clearAndResync()
                                                                                                                { if
                                                                                                                (!currentUser)
                                                                                                                {
                                                                                                                alert('You
                                                                                                                must be
                                                                                                                signed
                                                                                                                in to
                                                                                                                resync
                                                                                                                from
                                                                                                                cloud.');
                                                                                                                return
                                                                                                                false; }
                                                                                                                if
                                                                                                                (!confirm('This
                                                                                                                will
                                                                                                                clear
                                                                                                                all
                                                                                                                local
                                                                                                                data and
                                                                                                                reload
                                                                                                                from the
                                                                                                                cloud.
                                                                                                                Any data
                                                                                                                not
                                                                                                                synced
                                                                                                                to the
                                                                                                                cloud
                                                                                                                will be
                                                                                                                lost.
                                                                                                                Continue?'))
                                                                                                                { return
                                                                                                                false; }
                                                                                                                try { //
                                                                                                                Clear
                                                                                                                all
                                                                                                                inventory-related
                                                                                                                localStorage
                                                                                                                localStorage.removeItem(this.KEYS_STORAGE_KEY);
                                                                                                                localStorage.removeItem(this.BLANKS_STORAGE_KEY);
                                                                                                                localStorage.removeItem('eurokeys_inventory_keys');
                                                                                                                // Old
                                                                                                                format
                                                                                                                localStorage.removeItem('eurokeys_inventory_blanks');
                                                                                                                // Old
                                                                                                                format
                                                                                                                localStorage.removeItem('eurokeys_job_logs');
                                                                                                                console.log('ðŸ§¹
                                                                                                                Cleared
                                                                                                                local
                                                                                                                inventory
                                                                                                                and job
                                                                                                                logs');
                                                                                                                // Force
                                                                                                                reload
                                                                                                                from
                                                                                                                cloud
                                                                                                                this.lastSyncError=null;
                                                                                                                const
                                                                                                                inventoryLoaded=await
                                                                                                                this.loadFromCloud();
                                                                                                                const
                                                                                                                logsLoaded=await
                                                                                                                this.loadJobLogsFromCloud();
                                                                                                                if
                                                                                                                (inventoryLoaded
                                                                                                                ||
                                                                                                                logsLoaded)
                                                                                                                {
                                                                                                                this.lastSyncTime=Date.now();
                                                                                                                this.lastSyncError=null;
                                                                                                                console.log('âœ…
                                                                                                                Resync
                                                                                                                complete');
                                                                                                                alert('âœ…
                                                                                                                Resync
                                                                                                                complete!
                                                                                                                Loaded
                                                                                                                data
                                                                                                                from
                                                                                                                cloud.');
                                                                                                                renderInventoryPage();
                                                                                                                return
                                                                                                                true; }
                                                                                                                else {
                                                                                                                console.log('ðŸ“¦
                                                                                                                No cloud
                                                                                                                data
                                                                                                                found -
                                                                                                                starting
                                                                                                                fresh');
                                                                                                                alert('â„¹ï¸
                                                                                                                No cloud
                                                                                                                data
                                                                                                                found.
                                                                                                                Your
                                                                                                                inventory
                                                                                                                is now
                                                                                                                empty.');
                                                                                                                renderInventoryPage();
                                                                                                                return
                                                                                                                true; }
                                                                                                                } catch
                                                                                                                (e) {
                                                                                                                console.error('Resync
                                                                                                                failed:',
                                                                                                                e);
                                                                                                                this.lastSyncError=e.message;
                                                                                                                alert('âŒ
                                                                                                                Resync
                                                                                                                failed: ' + e.message);
                    return false;
                }
            }
        };

        // ================== TOOL LIBRARY (EXPANDED) ==================
        const ToolLibrary = {
            // CATEGORY: KEY PROGRAMMERS (TABLET)
            "Autel IM608 Pro": {
                name: "Autel IM608 Pro",
                type: "Programmer",
                price: 3500,
                capabilities: [
                    { make: "Toyota", years: "2000-2023", note: "Excellent OBD coverage, G/H Chip" },
                    { make: "Lexus", years: "2000-2023", note: "Smart Key programming" },
                    { make: "BMW", years: "2005-2018", note: "CAS1-4, FEM/BDC" },
                    { make: "Mercedes", years: "2005-2014", note: "FBS3 IR Key (needs XP400)" },
                    { make: "Ford", years: "2010-2024", note: "PATS, Smart Keys" },
                    { make: "Honda", years: "2005-2023", note: "All Keys Lost OBD" },
                    { make: "Nissan", years: "2008-2023", note: "BCM Code Reading" },
                    { make: "Hyundai/Kia", years: "2010-2023", note: "Pincode Reading, Smart Key" },
                    { make: "Dodge", years: "2010-2022", note: "RF Hub, Fobik, Smart Key" },
                    { make: "Jeep", years: "2010-2022", note: "Wrangler/Grand Cherokee" }
                ]
            },
            "Autel IM508": {
                name: "Autel IM508",
                type: "Programmer",
                price: 1500,
                capabilities: [
                    { make: "Toyota", years: "2000-2023", note: "Excellent OBD coverage" },
                    { make: "Honda", years: "2005-2023", note: "All Keys Lost OBD" },
                    { make: "Ford", years: "2010-2024", note: "Basic PATS" },
                    { make: "Hyundai/Kia", years: "2010-2020", note: "Basic Key Programming" }
                ]
            },
            "Lonsdor K518": {
                name: "Lonsdor K518",
                type: "Programmer",
                price: 1200,
                capabilities: [
                    { make: "Toyota", years: "2019-2025", note: "Best for New Smart Keys (0410/BA) - No PIN" },
                    { make: "Volvo", years: "2010-2023", note: "Solder-free Smart Key (SPA Platform Bypass)" },
                    { make: "Land Rover", years: "2015-2024", note: "JLR OBD Active Alarm Bypass" },
                    { make: "Nissan", years: "2019-2025", note: "B18/T33 Gateway Bypass (Sentra/Rogue)" }
                ]
            },
            "Xhorse Key Tool Max": {
                name: "Xhorse Key Tool Max",
                type: "Generators",
                price: 450,
                capabilities: [
                    { make: "Toyota", years: "2018-2024", note: "8A Smart Key (with adapter)" },
                    { make: "Volkswagen", years: "2000-2025", note: "MQB & MQB48 (Golf/Passat)" },
                    { make: "Mercedes", years: "2005-2025", note: "FBS3/FBS4 Key Calculation" },
                    { make: "BMW", years: "2010-2025", note: "CAS4/FEM/BDC Learning" },
                    { make: "Universal", years: "All", note: "Chip Generation & Cloning" }
                ]
            },
            "Smart Pro": {
                name: "Advanced Diagnostics Smart Pro",
                type: "Programmer",
                price: 4500,
                capabilities: [
                    { make: "Ford", years: "2015-2024", note: "Active Alarm Bypass" },
                    { make: "GM", years: "2017-2024", note: "CAN FD (with adapter)" },
                    { make: "Jeep", years: "2018-2024", note: "RF Hub Bypass" }
                ]
            },
            "Autel MaxiSYS Ultra": {
                name: "Autel MaxiSYS Ultra",
                type: "Diagnostic",
                price: 4995,
                capabilities: [
                    { make: "Mercedes", years: "2005-2022", note: "SCN Coding, Topology Mapping" },
                    { make: "BMW", years: "2005-2022", note: "Coding/Programming, ECU Flashing" },
                    { make: "Land Rover", years: "2010-2023", note: "Module Programming, Pathfinding" },
                    { make: "Universal", years: "All", note: "Full System Diagnostics, ADAS Calib." }
                ]
            },
            "TOPDON Phoenix Max": {
                name: "TOPDON Phoenix Max",
                type: "Diagnostic",
                price: 3600,
                capabilities: [
                    { make: "Universal", years: "All", note: "Topology Mapping, Online Coding" },
                    { make: "GM", years: "2020-2024", note: "CAN FD Built-in" }
                ]
            }
        };

        const ToolCoverageManager = {
            getDeepSearchData() {
                return typeof TOOL_COVERAGE_DATA !== ' undefined' ? TOOL_COVERAGE_DATA : null; }, getAllTools() {
                                                                                                                return
                                                                                                                Object.values(ToolLibrary);
                                                                                                                },
                                                                                                                isToolOwned(toolName)
                                                                                                                { const
                                                                                                                assets=AssetManager.getAssets();
                                                                                                                //
                                                                                                                Normalize
                                                                                                                for
                                                                                                                comparison
                                                                                                                (remove
                                                                                                                spaces/case)
                                                                                                                const
                                                                                                                norm=str=>
                                                                                                                str.toLowerCase().replace(/[^a-z0-9]/g,
                                                                                                                '');
                                                                                                                const
                                                                                                                target =
                                                                                                                norm(toolName);
                                                                                                                return
                                                                                                                assets.equipment.some(e
                                                                                                                =>
                                                                                                                norm(e.name).includes(target));
                                                                                                                },

                                                                                                                getMyCoverage()
                                                                                                                {
                                                                                                                const
                                                                                                                assets =
                                                                                                                AssetManager.getAssets();
                                                                                                                const
                                                                                                                coverage
                                                                                                                = {}; //
                                                                                                                { Make:
                                                                                                                { Year:
                                                                                                                { tool,
                                                                                                                note } }
                                                                                                                }

                                                                                                                // Check
                                                                                                                all
                                                                                                                known
                                                                                                                tools
                                                                                                                against
                                                                                                                owned
                                                                                                                assets
                                                                                                                Object.values(ToolLibrary).forEach(tool
                                                                                                                => {
                                                                                                                if
                                                                                                                (this.isToolOwned(tool.name))
                                                                                                                {
                                                                                                                tool.capabilities.forEach(cap
                                                                                                                => {
                                                                                                                if
                                                                                                                (!coverage[cap.make])
                                                                                                                coverage[cap.make]
                                                                                                                = {};

                                                                                                                // Parse
                                                                                                                years
                                                                                                                "2010-2022"
                                                                                                                or "All"
                                                                                                                let
                                                                                                                start =
                                                                                                                2000,
                                                                                                                end =
                                                                                                                2025;
                                                                                                                if
                                                                                                                (cap.years
                                                                                                                !==
                                                                                                                "All") {
                                                                                                                const
                                                                                                                parts =
                                                                                                                cap.years.split('-');
                                                                                                                start =
                                                                                                                parseInt(parts[0]);
                                                                                                                end =
                                                                                                                parts[1]
                                                                                                                ===
                                                                                                                'Present'
                                                                                                                ? 2025 :
                                                                                                                parseInt(parts[1]);
                                                                                                                }

                                                                                                                for (let
                                                                                                                y =
                                                                                                                start; y
                                                                                                                <= end;
                                                                                                                    y++)
                                                                                                                    { //
                                                                                                                    Only
                                                                                                                    overwrite
                                                                                                                    if
                                                                                                                    we
                                                                                                                    don't
                                                                                                                    have
                                                                                                                    coverage
                                                                                                                    or
                                                                                                                    if
                                                                                                                    this
                                                                                                                    tool
                                                                                                                    is "better"
                                                                                                                    (logic
                                                                                                                    simplified:
                                                                                                                    first
                                                                                                                    match
                                                                                                                    wins
                                                                                                                    for
                                                                                                                    now)
                                                                                                                    if
                                                                                                                    (!coverage[cap.make][y])
                                                                                                                    {
                                                                                                                    coverage[cap.make][y]={
                                                                                                                    tool:
                                                                                                                    tool.name,
                                                                                                                    note:
                                                                                                                    cap.note
                                                                                                                    }; }
                                                                                                                    }
                                                                                                                    });
                                                                                                                    }
                                                                                                                    });
                                                                                                                    return
                                                                                                                    coverage;
                                                                                                                    },
                                                                                                                    getSimulatedCoverage(toolName)
                                                                                                                    {
                                                                                                                    const
                                                                                                                    tool=ToolLibrary[toolName];
                                                                                                                    if
                                                                                                                    (!tool)
                                                                                                                    return
                                                                                                                    {};
                                                                                                                    const
                                                                                                                    existing=this.getMyCoverage();
                                                                                                                    const
                                                                                                                    gained={};
                                                                                                                    tool.capabilities.forEach(cap=>
                                                                                                                    {
                                                                                                                    //
                                                                                                                    Parse
                                                                                                                    years
                                                                                                                    let
                                                                                                                    start
                                                                                                                    =
                                                                                                                    2000,
                                                                                                                    end
                                                                                                                    =
                                                                                                                    2025;
                                                                                                                    if
                                                                                                                    (cap.years
                                                                                                                    !==
                                                                                                                    "All")
                                                                                                                    {
                                                                                                                    const
                                                                                                                    parts
                                                                                                                    =
                                                                                                                    cap.years.split('-');
                                                                                                                    start
                                                                                                                    =
                                                                                                                    parseInt(parts[0]);
                                                                                                                    end
                                                                                                                    =
                                                                                                                    parts[1]
                                                                                                                    ===
                                                                                                                    'Present'
                                                                                                                    ?
                                                                                                                    2025
                                                                                                                    :
                                                                                                                    parseInt(parts[1]);
                                                                                                                    }

                                                                                                                    for
                                                                                                                    (let
                                                                                                                    y =
                                                                                                                    start;
                                                                                                                    y <= end;
                                                                                                                        y++)
                                                                                                                        {
                                                                                                                        //
                                                                                                                        If
                                                                                                                        I
                                                                                                                        DON'T
                                                                                                                        have
                                                                                                                        coverage
                                                                                                                        for
                                                                                                                        this
                                                                                                                        slot,
                                                                                                                        it's
                                                                                                                        a
                                                                                                                        GAIN
                                                                                                                        if
                                                                                                                        (!existing[cap.make]
                                                                                                                        ||
                                                                                                                        !existing[cap.make][y])
                                                                                                                        {
                                                                                                                        if
                                                                                                                        (!gained[cap.make])
                                                                                                                        gained[cap.make]={};
                                                                                                                        gained[cap.make][y]={
                                                                                                                        tool:
                                                                                                                        tool.name,
                                                                                                                        note:
                                                                                                                        cap.note
                                                                                                                        };
                                                                                                                        }
                                                                                                                        }
                                                                                                                        });
                                                                                                                        return
                                                                                                                        gained;
                                                                                                                        }
                                                                                                                        };
                                                                                                                        //==================ASSET
                                                                                                                        MANAGER==================const
                                                                                                                        AssetManager={
                                                                                                                        ASSETS_STORAGE_KEY: 'eurokeys_assets_v1'
                                                                                                                        ,
                                                                                                                        getAssets()
                                                                                                                        {
                                                                                                                        try
                                                                                                                        {
                                                                                                                        const
                                                                                                                        data=localStorage.getItem(this.ASSETS_STORAGE_KEY);
                                                                                                                        return
                                                                                                                        data
                                                                                                                        ?
                                                                                                                        JSON.parse(data)
                                                                                                                        :
                                                                                                                        {
                                                                                                                        equipment:
                                                                                                                        [],
                                                                                                                        vehicles:
                                                                                                                        []
                                                                                                                        };
                                                                                                                        }
                                                                                                                        catch
                                                                                                                        (e)
                                                                                                                        {
                                                                                                                        console.error('Error
                                                                                                                        reading
                                                                                                                        assets:',
                                                                                                                        e);
                                                                                                                        return
                                                                                                                        {
                                                                                                                        equipment:
                                                                                                                        [],
                                                                                                                        vehicles:
                                                                                                                        []
                                                                                                                        };
                                                                                                                        }
                                                                                                                        },
                                                                                                                        saveAssets(assets)
                                                                                                                        {
                                                                                                                        localStorage.setItem(this.ASSETS_STORAGE_KEY,
                                                                                                                        JSON.stringify(assets));
                                                                                                                        },
                                                                                                                        //
                                                                                                                        Cloud
                                                                                                                        Sync
                                                                                                                        Methods
                                                                                                                        async
                                                                                                                        syncToCloud(asset)
                                                                                                                        {
                                                                                                                        if
                                                                                                                        (!currentUser)
                                                                                                                        return;
                                                                                                                        try
                                                                                                                        {
                                                                                                                        await
                                                                                                                        fetch(`${API}/api/user/assets`,
                                                                                                                        {
                                                                                                                        method: 'POST'
                                                                                                                        ,
                                                                                                                        headers:
                                                                                                                        {
                                                                                                                        ...getAuthHeaders(), 'Content-Type'
                                                                                                                        : 'application/json'
                                                                                                                        },
                                                                                                                        body:
                                                                                                                        JSON.stringify({
                                                                                                                        asset
                                                                                                                        })
                                                                                                                        });
                                                                                                                        }
                                                                                                                        catch
                                                                                                                        (e)
                                                                                                                        {
                                                                                                                        console.error('â˜ï¸
                                                                                                                        Asset
                                                                                                                        sync
                                                                                                                        failed:',
                                                                                                                        e);
                                                                                                                        }
                                                                                                                        },
                                                                                                                        async
                                                                                                                        deleteFromCloud(id)
                                                                                                                        {
                                                                                                                        if
                                                                                                                        (!currentUser)
                                                                                                                        return;
                                                                                                                        try
                                                                                                                        {
                                                                                                                        await
                                                                                                                        fetch(`${API}/api/user/assets`,
                                                                                                                        {
                                                                                                                        method: 'DELETE'
                                                                                                                        ,
                                                                                                                        headers:
                                                                                                                        {
                                                                                                                        ...getAuthHeaders(), 'Content-Type'
                                                                                                                        : 'application/json'
                                                                                                                        },
                                                                                                                        body:
                                                                                                                        JSON.stringify({
                                                                                                                        id
                                                                                                                        })
                                                                                                                        });
                                                                                                                        }
                                                                                                                        catch
                                                                                                                        (e)
                                                                                                                        {
                                                                                                                        console.error('ðŸ—‘ï¸
                                                                                                                        Asset
                                                                                                                        delete
                                                                                                                        failed:',
                                                                                                                        e);
                                                                                                                        }
                                                                                                                        },
                                                                                                                        async
                                                                                                                        loadFromCloud()
                                                                                                                        {
                                                                                                                        if
                                                                                                                        (!currentUser)
                                                                                                                        return;
                                                                                                                        try
                                                                                                                        {
                                                                                                                        const
                                                                                                                        response=await
                                                                                                                        fetch(`${API}/api/user/assets`,
                                                                                                                        {
                                                                                                                        headers:
                                                                                                                        getAuthHeaders()
                                                                                                                        });
                                                                                                                        if
                                                                                                                        (!response.ok)
                                                                                                                        return;
                                                                                                                        const
                                                                                                                        data=await
                                                                                                                        response.json();
                                                                                                                        if
                                                                                                                        (data.assets
                                                                                                                        &&
                                                                                                                        Array.isArray(data.assets))
                                                                                                                        {
                                                                                                                        const
                                                                                                                        cloudAssets=data.assets;
                                                                                                                        const
                                                                                                                        localAssets=this.getAssets();
                                                                                                                        //
                                                                                                                        Convert
                                                                                                                        local
                                                                                                                        assets
                                                                                                                        to
                                                                                                                        array
                                                                                                                        for
                                                                                                                        merging
                                                                                                                        const
                                                                                                                        localAll=[...localAssets.equipment,
                                                                                                                        ...localAssets.vehicles];
                                                                                                                        const
                                                                                                                        mergedMap=new
                                                                                                                        Map();
                                                                                                                        localAll.forEach(a=>
                                                                                                                        mergedMap.set(a.id,
                                                                                                                        a));
                                                                                                                        cloudAssets.forEach(a
                                                                                                                        =>
                                                                                                                        mergedMap.set(a.id,
                                                                                                                        a));

                                                                                                                        //
                                                                                                                        Rebuild
                                                                                                                        structure
                                                                                                                        const
                                                                                                                        newAssets
                                                                                                                        =
                                                                                                                        {
                                                                                                                        equipment:
                                                                                                                        [],
                                                                                                                        vehicles:
                                                                                                                        []
                                                                                                                        };
                                                                                                                        mergedMap.forEach(asset
                                                                                                                        =>
                                                                                                                        {
                                                                                                                        if
                                                                                                                        (asset.id.startsWith('eq_'))
                                                                                                                        newAssets.equipment.push(asset);
                                                                                                                        if
                                                                                                                        (asset.id.startsWith('vh_'))
                                                                                                                        newAssets.vehicles.push(asset);
                                                                                                                        });

                                                                                                                        this.saveAssets(newAssets);
                                                                                                                        console.log('ðŸ—ï¸
                                                                                                                        Business
                                                                                                                        Assets
                                                                                                                        loaded
                                                                                                                        from
                                                                                                                        cloud:',
                                                                                                                        mergedMap.size);
                                                                                                                        return
                                                                                                                        true;
                                                                                                                        }
                                                                                                                        }
                                                                                                                        catch
                                                                                                                        (e)
                                                                                                                        {
                                                                                                                        console.error('ðŸ—ï¸
                                                                                                                        Business
                                                                                                                        Assets
                                                                                                                        load
                                                                                                                        failed:',
                                                                                                                        e);
                                                                                                                        }
                                                                                                                        },

                                                                                                                        addEquipment(name,
                                                                                                                        cost,
                                                                                                                        purchaseDate)
                                                                                                                        {
                                                                                                                        const
                                                                                                                        assets
                                                                                                                        =
                                                                                                                        this.getAssets();
                                                                                                                        const
                                                                                                                        newAsset
                                                                                                                        =
                                                                                                                        {
                                                                                                                        id:
                                                                                                                        'eq_'
                                                                                                                        +
                                                                                                                        Date.now(),
                                                                                                                        name,
                                                                                                                        cost:
                                                                                                                        parseFloat(cost)
                                                                                                                        ||
                                                                                                                        0,
                                                                                                                        purchaseDate:
                                                                                                                        purchaseDate
                                                                                                                        ||
                                                                                                                        new
                                                                                                                        Date().toISOString().split('T')[0]
                                                                                                                        };
                                                                                                                        assets.equipment.push(newAsset);
                                                                                                                        this.saveAssets(assets);
                                                                                                                        this.syncToCloud(newAsset);
                                                                                                                        },

                                                                                                                        addVehicle(name,
                                                                                                                        price,
                                                                                                                        purchaseDate)
                                                                                                                        {
                                                                                                                        const
                                                                                                                        assets
                                                                                                                        =
                                                                                                                        this.getAssets();
                                                                                                                        const
                                                                                                                        newAsset
                                                                                                                        =
                                                                                                                        {
                                                                                                                        id:
                                                                                                                        'vh_'
                                                                                                                        +
                                                                                                                        Date.now(),
                                                                                                                        name,
                                                                                                                        price:
                                                                                                                        parseFloat(price)
                                                                                                                        ||
                                                                                                                        0,
                                                                                                                        purchaseDate:
                                                                                                                        purchaseDate
                                                                                                                        ||
                                                                                                                        new
                                                                                                                        Date().toISOString().split('T')[0]
                                                                                                                        };
                                                                                                                        assets.vehicles.push(newAsset);
                                                                                                                        this.saveAssets(assets);
                                                                                                                        this.syncToCloud(newAsset);
                                                                                                                        },

                                                                                                                        removeAsset(type,
                                                                                                                        id)
                                                                                                                        {
                                                                                                                        const
                                                                                                                        assets
                                                                                                                        =
                                                                                                                        this.getAssets();
                                                                                                                        assets[type]
                                                                                                                        =
                                                                                                                        assets[type].filter(a
                                                                                                                        =>
                                                                                                                        a.id
                                                                                                                        !==
                                                                                                                        id);
                                                                                                                        this.saveAssets(assets);
                                                                                                                        this.deleteFromCloud(id);
                                                                                                                        },

                                                                                                                        calculateDepreciation()
                                                                                                                        {
                                                                                                                        const
                                                                                                                        assets
                                                                                                                        =
                                                                                                                        this.getAssets();
                                                                                                                        const
                                                                                                                        now
                                                                                                                        =
                                                                                                                        new
                                                                                                                        Date();
                                                                                                                        let
                                                                                                                        totalDepreciation
                                                                                                                        =
                                                                                                                        0;

                                                                                                                        //
                                                                                                                        Simple
                                                                                                                        5-year
                                                                                                                        straight-line
                                                                                                                        depreciation
                                                                                                                        for
                                                                                                                        vehicles
                                                                                                                        assets.vehicles.forEach(v
                                                                                                                        =>
                                                                                                                        {
                                                                                                                        const
                                                                                                                        purchaseDate
                                                                                                                        =
                                                                                                                        new
                                                                                                                        Date(v.purchaseDate);
                                                                                                                        const
                                                                                                                        ageInYears
                                                                                                                        =
                                                                                                                        (now
                                                                                                                        -
                                                                                                                        purchaseDate)
                                                                                                                        /
                                                                                                                        (1000
                                                                                                                        *
                                                                                                                        60
                                                                                                                        *
                                                                                                                        60
                                                                                                                        *
                                                                                                                        24
                                                                                                                        *
                                                                                                                        365);
                                                                                                                        if
                                                                                                                        (ageInYears
                                                                                                                        >
                                                                                                                        0)
                                                                                                                        {
                                                                                                                        const
                                                                                                                        annualDepreciation
                                                                                                                        =
                                                                                                                        v.price
                                                                                                                        /
                                                                                                                        5;
                                                                                                                        totalDepreciation
                                                                                                                        +=
                                                                                                                        annualDepreciation
                                                                                                                        *
                                                                                                                        Math.min(ageInYears,
                                                                                                                        5);
                                                                                                                        }
                                                                                                                        });

                                                                                                                        return
                                                                                                                        totalDepreciation;
                                                                                                                        }
                                                                                                                        };

                                                                                                                        //
                                                                                                                        ==================
                                                                                                                        DATA
                                                                                                                        PORTABILITY
                                                                                                                        ==================
                                                                                                                        const
                                                                                                                        DataPortability
                                                                                                                        =
                                                                                                                        {
                                                                                                                        exportAll()
                                                                                                                        {
                                                                                                                        const
                                                                                                                        data
                                                                                                                        =
                                                                                                                        {
                                                                                                                        exportedAt:
                                                                                                                        new
                                                                                                                        Date().toISOString(),
                                                                                                                        version:
                                                                                                                        '1.0',
                                                                                                                        inventory:
                                                                                                                        {
                                                                                                                        keys:
                                                                                                                        InventoryManager.getKeysInventory(),
                                                                                                                        blanks:
                                                                                                                        InventoryManager.getBlanksInventory()
                                                                                                                        },
                                                                                                                        jobLogs:
                                                                                                                        JSON.parse(localStorage.getItem('eurokeys_job_logs')
                                                                                                                        ||
                                                                                                                        '[]'),
                                                                                                                        subscriptions:
                                                                                                                        SubscriptionManager.getAll(),
                                                                                                                        assets:
                                                                                                                        AssetManager.getAssets()
                                                                                                                        };
                                                                                                                        const
                                                                                                                        blob
                                                                                                                        =
                                                                                                                        new
                                                                                                                        Blob([JSON.stringify(data,
                                                                                                                        null,
                                                                                                                        2)],
                                                                                                                        {
                                                                                                                        type:
                                                                                                                        'application/json'
                                                                                                                        });
                                                                                                                        const
                                                                                                                        url
                                                                                                                        =
                                                                                                                        URL.createObjectURL(blob);
                                                                                                                        const
                                                                                                                        a
                                                                                                                        =
                                                                                                                        document.createElement('a');
                                                                                                                        a.href
                                                                                                                        =
                                                                                                                        url;
                                                                                                                        a.download
                                                                                                                        =
                                                                                                                        `eurokeys_backup_${new
                                                                                                                        Date().toISOString().split('T')[0]}.json`;
                                                                                                                        document.body.appendChild(a);
                                                                                                                        a.click();
                                                                                                                        document.body.removeChild(a);
                                                                                                                        URL.revokeObjectURL(url);
                                                                                                                        console.log('ðŸ“¦
                                                                                                                        Data
                                                                                                                        exported');
                                                                                                                        return
                                                                                                                        true;
                                                                                                                        },

                                                                                                                        async
                                                                                                                        importFromFile(file)
                                                                                                                        {
                                                                                                                        return
                                                                                                                        new
                                                                                                                        Promise((resolve,
                                                                                                                        reject)
                                                                                                                        =>
                                                                                                                        {
                                                                                                                        const
                                                                                                                        reader
                                                                                                                        =
                                                                                                                        new
                                                                                                                        FileReader();
                                                                                                                        reader.onload
                                                                                                                        =
                                                                                                                        async
                                                                                                                        (e)
                                                                                                                        =>
                                                                                                                        {
                                                                                                                        try
                                                                                                                        {
                                                                                                                        const
                                                                                                                        data
                                                                                                                        =
                                                                                                                        JSON.parse(e.target.result);
                                                                                                                        if
                                                                                                                        (data.inventory?.keys)
                                                                                                                        Object.assign(InventoryManager.getKeysInventory(),
                                                                                                                        data.inventory.keys);
                                                                                                                        if
                                                                                                                        (data.inventory?.blanks)
                                                                                                                        Object.assign(InventoryManager.getBlanksInventory(),
                                                                                                                        data.inventory.blanks);
                                                                                                                        if
                                                                                                                        (data.jobLogs?.length)
                                                                                                                        {
                                                                                                                        const
                                                                                                                        local
                                                                                                                        =
                                                                                                                        JSON.parse(localStorage.getItem('eurokeys_job_logs')
                                                                                                                        ||
                                                                                                                        '[]');
                                                                                                                        const
                                                                                                                        map
                                                                                                                        =
                                                                                                                        new
                                                                                                                        Map(local.map(l
                                                                                                                        =>
                                                                                                                        [l.id,
                                                                                                                        l]));
                                                                                                                        data.jobLogs.forEach(l
                                                                                                                        =>
                                                                                                                        map.set(l.id,
                                                                                                                        l));
                                                                                                                        localStorage.setItem('eurokeys_job_logs',
                                                                                                                        JSON.stringify([...map.values()]));
                                                                                                                        }
                                                                                                                        if
                                                                                                                        (data.subscriptions?.length)
                                                                                                                        {
                                                                                                                        const
                                                                                                                        local
                                                                                                                        =
                                                                                                                        SubscriptionManager.getAll();
                                                                                                                        const
                                                                                                                        map
                                                                                                                        =
                                                                                                                        new
                                                                                                                        Map(local.map(s
                                                                                                                        =>
                                                                                                                        [s.id,
                                                                                                                        s]));
                                                                                                                        data.subscriptions.forEach(s
                                                                                                                        =>
                                                                                                                        map.set(s.id,
                                                                                                                        s));
                                                                                                                        SubscriptionManager.save([...map.values()]);
                                                                                                                        }
                                                                                                                        if
                                                                                                                        (data.assets)
                                                                                                                        AssetManager.saveAssets({
                                                                                                                        ...AssetManager.getAssets(),
                                                                                                                        ...data.assets
                                                                                                                        });
                                                                                                                        if
                                                                                                                        (currentUser)
                                                                                                                        await
                                                                                                                        this.syncAllToCloud();
                                                                                                                        console.log('ðŸ“¥
                                                                                                                        Data
                                                                                                                        imported');
                                                                                                                        resolve(true);
                                                                                                                        }
                                                                                                                        catch
                                                                                                                        (err)
                                                                                                                        {
                                                                                                                        reject(err);
                                                                                                                        }
                                                                                                                        };
                                                                                                                        reader.readAsText(file);
                                                                                                                        });
                                                                                                                        },

                                                                                                                        async
                                                                                                                        syncAllToCloud()
                                                                                                                        {
                                                                                                                        if
                                                                                                                        (!currentUser)
                                                                                                                        return;
                                                                                                                        const
                                                                                                                        keys
                                                                                                                        =
                                                                                                                        InventoryManager.getKeysInventory();
                                                                                                                        for
                                                                                                                        (const
                                                                                                                        [k,
                                                                                                                        d]
                                                                                                                        of
                                                                                                                        Object.entries(keys))
                                                                                                                        await
                                                                                                                        InventoryManager.syncToCloud(k,
                                                                                                                        'key',
                                                                                                                        d.qty,
                                                                                                                        d.used
                                                                                                                        ||
                                                                                                                        0);
                                                                                                                        const
                                                                                                                        blanks
                                                                                                                        =
                                                                                                                        InventoryManager.getBlanksInventory();
                                                                                                                        for
                                                                                                                        (const
                                                                                                                        [k,
                                                                                                                        d]
                                                                                                                        of
                                                                                                                        Object.entries(blanks))
                                                                                                                        await
                                                                                                                        InventoryManager.syncToCloud(k,
                                                                                                                        'blank',
                                                                                                                        d.qty,
                                                                                                                        d.used
                                                                                                                        ||
                                                                                                                        0);
                                                                                                                        const
                                                                                                                        subs
                                                                                                                        =
                                                                                                                        SubscriptionManager.getAll();
                                                                                                                        for
                                                                                                                        (const
                                                                                                                        s
                                                                                                                        of
                                                                                                                        subs)
                                                                                                                        await
                                                                                                                        SubscriptionManager.syncToCloud(s);
                                                                                                                        const
                                                                                                                        assets
                                                                                                                        =
                                                                                                                        AssetManager.getAssets();
                                                                                                                        for
                                                                                                                        (const
                                                                                                                        e
                                                                                                                        of
                                                                                                                        assets.equipment)
                                                                                                                        await
                                                                                                                        AssetManager.syncToCloud(e);
                                                                                                                        for
                                                                                                                        (const
                                                                                                                        v
                                                                                                                        of
                                                                                                                        assets.vehicles)
                                                                                                                        await
                                                                                                                        AssetManager.syncToCloud(v);
                                                                                                                        console.log('â˜ï¸
                                                                                                                        All
                                                                                                                        data
                                                                                                                        synced
                                                                                                                        to
                                                                                                                        cloud');
                                                                                                                        }
                                                                                                                        };

                                                                                                                        //
                                                                                                                        ==================
                                                                                                                        OFFLINE
                                                                                                                        SYNC
                                                                                                                        QUEUE
                                                                                                                        ==================
                                                                                                                        const
                                                                                                                        OfflineSyncQueue
                                                                                                                        =
                                                                                                                        {
                                                                                                                        QUEUE_KEY:
                                                                                                                        'eurokeys_offline_queue',
                                                                                                                        getQueue()
                                                                                                                        {
                                                                                                                        try
                                                                                                                        {
                                                                                                                        return
                                                                                                                        JSON.parse(localStorage.getItem(this.QUEUE_KEY)
                                                                                                                        ||
                                                                                                                        '[]');
                                                                                                                        }
                                                                                                                        catch
                                                                                                                        {
                                                                                                                        return
                                                                                                                        [];
                                                                                                                        }
                                                                                                                        },
                                                                                                                        saveQueue(q)
                                                                                                                        {
                                                                                                                        localStorage.setItem(this.QUEUE_KEY,
                                                                                                                        JSON.stringify(q));
                                                                                                                        },
                                                                                                                        add(op)
                                                                                                                        {
                                                                                                                        const
                                                                                                                        q
                                                                                                                        =
                                                                                                                        this.getQueue();
                                                                                                                        q.push({
                                                                                                                        ...op,
                                                                                                                        ts:
                                                                                                                        Date.now()
                                                                                                                        });
                                                                                                                        this.saveQueue(q);
                                                                                                                        console.log('ðŸ“´
                                                                                                                        Queued:',
                                                                                                                        op.type);
                                                                                                                        },
                                                                                                                        async
                                                                                                                        flush()
                                                                                                                        {
                                                                                                                        const
                                                                                                                        q
                                                                                                                        =
                                                                                                                        this.getQueue();
                                                                                                                        if
                                                                                                                        (!q.length)
                                                                                                                        return;
                                                                                                                        console.log(`ðŸ”„
                                                                                                                        Flushing
                                                                                                                        ${q.length}
                                                                                                                        ops...`);
                                                                                                                        const
                                                                                                                        failed
                                                                                                                        =
                                                                                                                        [];
                                                                                                                        for
                                                                                                                        (const
                                                                                                                        op
                                                                                                                        of
                                                                                                                        q)
                                                                                                                        {
                                                                                                                        try
                                                                                                                        {
                                                                                                                        await
                                                                                                                        fetch(op.endpoint,
                                                                                                                        {
                                                                                                                        method:
                                                                                                                        op.method
                                                                                                                        ||
                                                                                                                        'POST',
                                                                                                                        headers:
                                                                                                                        {
                                                                                                                        ...getAuthHeaders(),
                                                                                                                        'Content-Type':
                                                                                                                        'application/json'
                                                                                                                        },
                                                                                                                        body:
                                                                                                                        JSON.stringify(op.body)
                                                                                                                        });
                                                                                                                        }
                                                                                                                        catch
                                                                                                                        {
                                                                                                                        failed.push(op);
                                                                                                                        }
                                                                                                                        }
                                                                                                                        this.saveQueue(failed);
                                                                                                                        console.log(`âœ…
                                                                                                                        Done.
                                                                                                                        ${failed.length}
                                                                                                                        pending.`);
                                                                                                                        }
                                                                                                                        };
                                                                                                                        window.addEventListener('online',
                                                                                                                        ()
                                                                                                                        =>
                                                                                                                        {
                                                                                                                        console.log('ðŸŒ
                                                                                                                        Online!
                                                                                                                        Syncing...');
                                                                                                                        OfflineSyncQueue.flush();
                                                                                                                        });

                                                                                                                        //
                                                                                                                        ==================
                                                                                                                        SYNC
                                                                                                                        STATUS
                                                                                                                        INDICATOR
                                                                                                                        ==================
                                                                                                                        const
                                                                                                                        SyncStatusUI
                                                                                                                        =
                                                                                                                        {
                                                                                                                        element:
                                                                                                                        null,
                                                                                                                        timeout:
                                                                                                                        null,

                                                                                                                        init()
                                                                                                                        {
                                                                                                                        if
                                                                                                                        (this.element)
                                                                                                                        return;
                                                                                                                        this.element
                                                                                                                        =
                                                                                                                        document.createElement('div');
                                                                                                                        this.element.id
                                                                                                                        =
                                                                                                                        'sync-status-badge';
                                                                                                                        this.element.style.cssText
                                                                                                                        =
                                                                                                                        `
                                                                                                                        position:
                                                                                                                        fixed;
                                                                                                                        bottom:
                                                                                                                        20px;
                                                                                                                        right:
                                                                                                                        20px;
                                                                                                                        background:
                                                                                                                        var(--bg-secondary);
                                                                                                                        border:
                                                                                                                        1px
                                                                                                                        solid
                                                                                                                        var(--border);
                                                                                                                        padding:
                                                                                                                        8px
                                                                                                                        16px;
                                                                                                                        border-radius:
                                                                                                                        20px;
                                                                                                                        font-size:
                                                                                                                        0.85rem;
                                                                                                                        font-weight:
                                                                                                                        600;
                                                                                                                        z-index:
                                                                                                                        9999;
                                                                                                                        display:
                                                                                                                        none;
                                                                                                                        box-shadow:
                                                                                                                        0
                                                                                                                        4px
                                                                                                                        12px
                                                                                                                        rgba(0,0,0,0.3);
                                                                                                                        transition:
                                                                                                                        all
                                                                                                                        0.3s
                                                                                                                        ease;
                                                                                                                        `;
                                                                                                                        document.body.appendChild(this.element);
                                                                                                                        },

                                                                                                                        show(status
                                                                                                                        =
                                                                                                                        'syncing')
                                                                                                                        {
                                                                                                                        this.init();
                                                                                                                        if
                                                                                                                        (status
                                                                                                                        ===
                                                                                                                        'syncing')
                                                                                                                        {
                                                                                                                        this.element.innerHTML
                                                                                                                        =
                                                                                                                        'ðŸ”„
                                                                                                                        Syncing...';
                                                                                                                        this.element.style.color
                                                                                                                        =
                                                                                                                        '#fbbf24';
                                                                                                                        this.element.style.display
                                                                                                                        =
                                                                                                                        'block';
                                                                                                                        }
                                                                                                                        else
                                                                                                                        if
                                                                                                                        (status
                                                                                                                        ===
                                                                                                                        'synced')
                                                                                                                        {
                                                                                                                        this.element.innerHTML
                                                                                                                        =
                                                                                                                        'âœ…
                                                                                                                        Synced';
                                                                                                                        this.element.style.color
                                                                                                                        =
                                                                                                                        '#4ade80';
                                                                                                                        this.element.style.display
                                                                                                                        =
                                                                                                                        'block';
                                                                                                                        //
                                                                                                                        Auto-hide
                                                                                                                        after
                                                                                                                        2
                                                                                                                        seconds
                                                                                                                        clearTimeout(this.timeout);
                                                                                                                        this.timeout
                                                                                                                        =
                                                                                                                        setTimeout(()
                                                                                                                        =>
                                                                                                                        this.hide(),
                                                                                                                        2000);
                                                                                                                        }
                                                                                                                        else
                                                                                                                        if
                                                                                                                        (status
                                                                                                                        ===
                                                                                                                        'error')
                                                                                                                        {
                                                                                                                        this.element.innerHTML
                                                                                                                        =
                                                                                                                        'âš ï¸
                                                                                                                        Sync
                                                                                                                        Failed';
                                                                                                                        this.element.style.color
                                                                                                                        =
                                                                                                                        '#f87171';
                                                                                                                        this.element.style.display
                                                                                                                        =
                                                                                                                        'block';
                                                                                                                        clearTimeout(this.timeout);
                                                                                                                        this.timeout
                                                                                                                        =
                                                                                                                        setTimeout(()
                                                                                                                        =>
                                                                                                                        this.hide(),
                                                                                                                        3000);
                                                                                                                        }
                                                                                                                        },

                                                                                                                        hide()
                                                                                                                        {
                                                                                                                        if
                                                                                                                        (this.element)
                                                                                                                        {
                                                                                                                        this.element.style.display
                                                                                                                        =
                                                                                                                        'none';
                                                                                                                        }
                                                                                                                        }
                                                                                                                        };

                                                                                                                        //
                                                                                                                        ==================
                                                                                                                        USER
                                                                                                                        PREFERENCES
                                                                                                                        MANAGER
                                                                                                                        ==================
                                                                                                                        const
                                                                                                                        PreferencesManager
                                                                                                                        =
                                                                                                                        {
                                                                                                                        STORAGE_KEY:
                                                                                                                        'eurokeys_preferences',

                                                                                                                        getLocal()
                                                                                                                        {
                                                                                                                        try
                                                                                                                        {
                                                                                                                        return
                                                                                                                        JSON.parse(localStorage.getItem(this.STORAGE_KEY)
                                                                                                                        ||
                                                                                                                        '{}');
                                                                                                                        }
                                                                                                                        catch
                                                                                                                        {
                                                                                                                        return
                                                                                                                        {};
                                                                                                                        }
                                                                                                                        },

                                                                                                                        saveLocal(prefs)
                                                                                                                        {
                                                                                                                        localStorage.setItem(this.STORAGE_KEY,
                                                                                                                        JSON.stringify(prefs));
                                                                                                                        },

                                                                                                                        get(key)
                                                                                                                        {
                                                                                                                        return
                                                                                                                        this.getLocal()[key];
                                                                                                                        },

                                                                                                                        set(key,
                                                                                                                        value)
                                                                                                                        {
                                                                                                                        const
                                                                                                                        prefs
                                                                                                                        =
                                                                                                                        this.getLocal();
                                                                                                                        prefs[key]
                                                                                                                        =
                                                                                                                        value;
                                                                                                                        this.saveLocal(prefs);
                                                                                                                        this.syncToCloud();
                                                                                                                        },

                                                                                                                        async
                                                                                                                        syncToCloud()
                                                                                                                        {
                                                                                                                        if
                                                                                                                        (!currentUser)
                                                                                                                        return;
                                                                                                                        try
                                                                                                                        {
                                                                                                                        await
                                                                                                                        fetch(`${API}/api/user/preferences`,
                                                                                                                        {
                                                                                                                        method:
                                                                                                                        'POST',
                                                                                                                        headers:
                                                                                                                        {
                                                                                                                        ...getAuthHeaders(),
                                                                                                                        'Content-Type':
                                                                                                                        'application/json'
                                                                                                                        },
                                                                                                                        body:
                                                                                                                        JSON.stringify({
                                                                                                                        preferences:
                                                                                                                        this.getLocal()
                                                                                                                        })
                                                                                                                        });
                                                                                                                        }
                                                                                                                        catch
                                                                                                                        (e)
                                                                                                                        {
                                                                                                                        console.error('Prefs
                                                                                                                        sync
                                                                                                                        failed:',
                                                                                                                        e);
                                                                                                                        }
                                                                                                                        },

                                                                                                                        async
                                                                                                                        loadFromCloud()
                                                                                                                        {
                                                                                                                        if
                                                                                                                        (!currentUser)
                                                                                                                        return;
                                                                                                                        try
                                                                                                                        {
                                                                                                                        const
                                                                                                                        res
                                                                                                                        =
                                                                                                                        await
                                                                                                                        fetch(`${API}/api/user/preferences`,
                                                                                                                        {
                                                                                                                        headers:
                                                                                                                        getAuthHeaders()
                                                                                                                        });
                                                                                                                        if
                                                                                                                        (res.ok)
                                                                                                                        {
                                                                                                                        const
                                                                                                                        data
                                                                                                                        =
                                                                                                                        await
                                                                                                                        res.json();
                                                                                                                        if
                                                                                                                        (data.preferences)
                                                                                                                        {
                                                                                                                        const
                                                                                                                        cloudPrefs
                                                                                                                        =
                                                                                                                        data.preferences;
                                                                                                                        const
                                                                                                                        localPrefs
                                                                                                                        =
                                                                                                                        this.getLocal();
                                                                                                                        //
                                                                                                                        Merge:
                                                                                                                        cloud
                                                                                                                        wins
                                                                                                                        const
                                                                                                                        merged
                                                                                                                        =
                                                                                                                        {
                                                                                                                        ...localPrefs,
                                                                                                                        ...cloudPrefs
                                                                                                                        };
                                                                                                                        this.saveLocal(merged);
                                                                                                                        console.log('âš™ï¸
                                                                                                                        Preferences
                                                                                                                        loaded
                                                                                                                        from
                                                                                                                        cloud');
                                                                                                                        }
                                                                                                                        }
                                                                                                                        }
                                                                                                                        catch
                                                                                                                        (e)
                                                                                                                        {
                                                                                                                        console.error('Prefs
                                                                                                                        load
                                                                                                                        failed:',
                                                                                                                        e);
                                                                                                                        }
                                                                                                                        }
                                                                                                                        };

                                                                                                                        //
                                                                                                                        ==================
                                                                                                                        TOOL
                                                                                                                        COVERAGE
                                                                                                                        &
                                                                                                                        INTELLIGENCE
                                                                                                                        ==================

                                                                                                                        //
                                                                                                                        Update
                                                                                                                        inventory
                                                                                                                        display
                                                                                                                        in
                                                                                                                        modal
                                                                                                                        function
                                                                                                                        updateInventoryDisplay(itemKey,
                                                                                                                        type
                                                                                                                        =
                                                                                                                        'key')
                                                                                                                        {
                                                                                                                        const
                                                                                                                        stock
                                                                                                                        =
                                                                                                                        type
                                                                                                                        ===
                                                                                                                        'blank'
                                                                                                                        ?
                                                                                                                        InventoryManager.getBlankStock(itemKey)
                                                                                                                        :
                                                                                                                        InventoryManager.getKeyStock(itemKey);
                                                                                                                        const
                                                                                                                        prefix
                                                                                                                        =
                                                                                                                        type
                                                                                                                        ===
                                                                                                                        'blank'
                                                                                                                        ?
                                                                                                                        'blank'
                                                                                                                        :
                                                                                                                        'inv';
                                                                                                                        const
                                                                                                                        badge
                                                                                                                        =
                                                                                                                        document.getElementById(`${prefix}-badge-${CSS.escape(itemKey)}`);
                                                                                                                        const
                                                                                                                        minusBtn
                                                                                                                        =
                                                                                                                        document.getElementById(`${prefix}-minus-${CSS.escape(itemKey)}`);
                                                                                                                        const
                                                                                                                        usedBtn
                                                                                                                        =
                                                                                                                        document.getElementById(`${prefix}-used-${CSS.escape(itemKey)}`);

                                                                                                                        if
                                                                                                                        (badge)
                                                                                                                        {
                                                                                                                        if
                                                                                                                        (stock
                                                                                                                        >
                                                                                                                        0)
                                                                                                                        {
                                                                                                                        badge.textContent
                                                                                                                        =
                                                                                                                        `${type
                                                                                                                        ===
                                                                                                                        'blank'
                                                                                                                        ?
                                                                                                                        'ðŸ”‘'
                                                                                                                        :
                                                                                                                        'ðŸ“¦'}
                                                                                                                        ${stock}
                                                                                                                        in
                                                                                                                        stock`;
                                                                                                                        badge.className
                                                                                                                        =
                                                                                                                        'inventory-badge
                                                                                                                        in-stock';
                                                                                                                        }
                                                                                                                        else
                                                                                                                        {
                                                                                                                        badge.textContent
                                                                                                                        =
                                                                                                                        'âš ï¸
                                                                                                                        Out
                                                                                                                        of
                                                                                                                        stock';
                                                                                                                        badge.className
                                                                                                                        =
                                                                                                                        'inventory-badge
                                                                                                                        out-of-stock';
                                                                                                                        }
                                                                                                                        }
                                                                                                                        if
                                                                                                                        (minusBtn)
                                                                                                                        minusBtn.disabled
                                                                                                                        =
                                                                                                                        stock
                                                                                                                        ===
                                                                                                                        0;
                                                                                                                        if
                                                                                                                        (usedBtn)
                                                                                                                        usedBtn.disabled
                                                                                                                        =
                                                                                                                        stock
                                                                                                                        ===
                                                                                                                        0;

                                                                                                                        //
                                                                                                                        Also
                                                                                                                        update
                                                                                                                        the
                                                                                                                        note
                                                                                                                        display
                                                                                                                        if
                                                                                                                        present
                                                                                                                        if
                                                                                                                        (typeof
                                                                                                                        updateJobNoteDisplay
                                                                                                                        ===
                                                                                                                        'function')
                                                                                                                        {
                                                                                                                        updateJobNoteDisplay(itemKey,
                                                                                                                        type);
                                                                                                                        }
                                                                                                                        }

                                                                                                                        function
                                                                                                                        inventoryAdd(itemKey,
                                                                                                                        type
                                                                                                                        =
                                                                                                                        'key',
                                                                                                                        vehicle
                                                                                                                        =
                                                                                                                        null,
                                                                                                                        amazonLink
                                                                                                                        =
                                                                                                                        null)
                                                                                                                        {
                                                                                                                        const
                                                                                                                        trialStatus
                                                                                                                        =
                                                                                                                        getTrialStatus();
                                                                                                                        //
                                                                                                                        Anonymous
                                                                                                                        users:
                                                                                                                        prompt
                                                                                                                        sign-up
                                                                                                                        if
                                                                                                                        (trialStatus.isAnonymous)
                                                                                                                        {
                                                                                                                        openSignUpPaywall('inventory',
                                                                                                                        itemKey);
                                                                                                                        return;
                                                                                                                        }
                                                                                                                        //
                                                                                                                        Signed-in
                                                                                                                        users
                                                                                                                        with
                                                                                                                        expired
                                                                                                                        trial:
                                                                                                                        prompt
                                                                                                                        upgrade
                                                                                                                        if
                                                                                                                        (!trialStatus.hasAccess)
                                                                                                                        {
                                                                                                                        openUpgradeModal();
                                                                                                                        return;
                                                                                                                        }
                                                                                                                        if
                                                                                                                        (type
                                                                                                                        ===
                                                                                                                        'blank')
                                                                                                                        {
                                                                                                                        InventoryManager.addBlankStock(itemKey,
                                                                                                                        1,
                                                                                                                        vehicle,
                                                                                                                        amazonLink);
                                                                                                                        }
                                                                                                                        else
                                                                                                                        {
                                                                                                                        InventoryManager.addKeyStock(itemKey,
                                                                                                                        1,
                                                                                                                        vehicle,
                                                                                                                        amazonLink);
                                                                                                                        }
                                                                                                                        updateInventoryDisplay(itemKey,
                                                                                                                        type);
                                                                                                                        updateInventoryTabBadge();
                                                                                                                        }

                                                                                                                        function
                                                                                                                        inventoryMinus(itemKey,
                                                                                                                        type
                                                                                                                        =
                                                                                                                        'key')
                                                                                                                        {
                                                                                                                        const
                                                                                                                        trialStatus
                                                                                                                        =
                                                                                                                        getTrialStatus();
                                                                                                                        //
                                                                                                                        Anonymous
                                                                                                                        users:
                                                                                                                        prompt
                                                                                                                        sign-up
                                                                                                                        if
                                                                                                                        (trialStatus.isAnonymous)
                                                                                                                        {
                                                                                                                        openSignUpPaywall('inventory',
                                                                                                                        itemKey);
                                                                                                                        return;
                                                                                                                        }
                                                                                                                        //
                                                                                                                        Signed-in
                                                                                                                        users
                                                                                                                        with
                                                                                                                        expired
                                                                                                                        trial:
                                                                                                                        prompt
                                                                                                                        upgrade
                                                                                                                        if
                                                                                                                        (!trialStatus.hasAccess)
                                                                                                                        {
                                                                                                                        openUpgradeModal();
                                                                                                                        return;
                                                                                                                        }
                                                                                                                        if
                                                                                                                        (type
                                                                                                                        ===
                                                                                                                        'blank')
                                                                                                                        {
                                                                                                                        InventoryManager.useBlankStock(itemKey);
                                                                                                                        }
                                                                                                                        else
                                                                                                                        {
                                                                                                                        InventoryManager.useKeyStock(itemKey);
                                                                                                                        }
                                                                                                                        updateInventoryDisplay(itemKey,
                                                                                                                        type);
                                                                                                                        updateInventoryTabBadge();
                                                                                                                        //
                                                                                                                        Also
                                                                                                                        update
                                                                                                                        FCC
                                                                                                                        table
                                                                                                                        if
                                                                                                                        visible
                                                                                                                        updateFccStockDisplay(itemKey);
                                                                                                                        }

                                                                                                                        //
                                                                                                                        Helper
                                                                                                                        for
                                                                                                                        FCC
                                                                                                                        table
                                                                                                                        inventory
                                                                                                                        add
                                                                                                                        function
                                                                                                                        fccInventoryAdd(fccId,
                                                                                                                        vehicle,
                                                                                                                        amazonLink)
                                                                                                                        {
                                                                                                                        inventoryAdd(fccId,
                                                                                                                        'key',
                                                                                                                        vehicle,
                                                                                                                        amazonLink);
                                                                                                                        updateFccStockDisplay(fccId);
                                                                                                                        }

                                                                                                                        //
                                                                                                                        Update
                                                                                                                        stock
                                                                                                                        display
                                                                                                                        in
                                                                                                                        FCC
                                                                                                                        table
                                                                                                                        function
                                                                                                                        updateFccStockDisplay(fccId)
                                                                                                                        {
                                                                                                                        const
                                                                                                                        stockEl
                                                                                                                        =
                                                                                                                        document.getElementById(`fcc-stock-${fccId}`);
                                                                                                                        if
                                                                                                                        (stockEl)
                                                                                                                        {
                                                                                                                        stockEl.textContent
                                                                                                                        =
                                                                                                                        InventoryManager.getKeyStock(fccId);
                                                                                                                        }
                                                                                                                        }

                                                                                                                        //
                                                                                                                        Open
                                                                                                                        the
                                                                                                                        job
                                                                                                                        logging
                                                                                                                        modal
                                                                                                                        //
                                                                                                                        Delete
                                                                                                                        Confirmation
                                                                                                                        Logic
                                                                                                                        let
                                                                                                                        deleteTargetKey
                                                                                                                        =
                                                                                                                        null;
                                                                                                                        let
                                                                                                                        deleteTargetType
                                                                                                                        =
                                                                                                                        null;

                                                                                                                        window.openDeleteConfirmModal
                                                                                                                        =
                                                                                                                        function
                                                                                                                        (key,
                                                                                                                        type)
                                                                                                                        {
                                                                                                                        deleteTargetKey
                                                                                                                        =
                                                                                                                        key;
                                                                                                                        deleteTargetType
                                                                                                                        =
                                                                                                                        type;
                                                                                                                        document.getElementById('deleteConfirmModal').style.display
                                                                                                                        =
                                                                                                                        'flex';
                                                                                                                        }

                                                                                                                        window.closeDeleteConfirmModal
                                                                                                                        =
                                                                                                                        function
                                                                                                                        ()
                                                                                                                        {
                                                                                                                        deleteTargetKey
                                                                                                                        =
                                                                                                                        null;
                                                                                                                        deleteTargetType
                                                                                                                        =
                                                                                                                        null;
                                                                                                                        document.getElementById('deleteConfirmModal').style.display
                                                                                                                        =
                                                                                                                        'none';
                                                                                                                        }

                                                                                                                        window.confirmDelete
                                                                                                                        =
                                                                                                                        function
                                                                                                                        ()
                                                                                                                        {
                                                                                                                        if
                                                                                                                        (deleteTargetKey
                                                                                                                        &&
                                                                                                                        deleteTargetType)
                                                                                                                        {
                                                                                                                        InventoryManager.deleteItem(deleteTargetKey,
                                                                                                                        deleteTargetType);
                                                                                                                        renderInventoryPage();
                                                                                                                        closeDeleteConfirmModal();
                                                                                                                        }
                                                                                                                        }

                                                                                                                        window.openJobLogModal
                                                                                                                        =
                                                                                                                        function
                                                                                                                        (itemKey,
                                                                                                                        type
                                                                                                                        =
                                                                                                                        'key',
                                                                                                                        vehicle
                                                                                                                        =
                                                                                                                        null,
                                                                                                                        amazonLink
                                                                                                                        =
                                                                                                                        null)
                                                                                                                        {
                                                                                                                        //
                                                                                                                        Get
                                                                                                                        current
                                                                                                                        stock
                                                                                                                        const
                                                                                                                        stock
                                                                                                                        =
                                                                                                                        type
                                                                                                                        ===
                                                                                                                        'blank'
                                                                                                                        ?
                                                                                                                        InventoryManager.getBlankStock(itemKey)
                                                                                                                        :
                                                                                                                        InventoryManager.getKeyStock(itemKey);

                                                                                                                        //
                                                                                                                        Set
                                                                                                                        consume
                                                                                                                        checkbox
                                                                                                                        state
                                                                                                                        const
                                                                                                                        checkbox
                                                                                                                        =
                                                                                                                        document.getElementById('jobConsumeStock');
                                                                                                                        if
                                                                                                                        (checkbox)
                                                                                                                        {
                                                                                                                        checkbox.checked
                                                                                                                        =
                                                                                                                        stock
                                                                                                                        >
                                                                                                                        0;
                                                                                                                        }

                                                                                                                        //
                                                                                                                        Get
                                                                                                                        saved
                                                                                                                        metadata
                                                                                                                        from
                                                                                                                        inventory
                                                                                                                        for
                                                                                                                        defaults
                                                                                                                        const
                                                                                                                        invItem
                                                                                                                        =
                                                                                                                        type
                                                                                                                        ===
                                                                                                                        'blank'
                                                                                                                        ?
                                                                                                                        InventoryManager.getBlanksInventory()[itemKey]
                                                                                                                        :
                                                                                                                        InventoryManager.getKeysInventory()[itemKey];
                                                                                                                        const
                                                                                                                        savedVehicle
                                                                                                                        =
                                                                                                                        invItem?.vehicle
                                                                                                                        ||
                                                                                                                        vehicle
                                                                                                                        ||
                                                                                                                        '';

                                                                                                                        //
                                                                                                                        Populate
                                                                                                                        Modal
                                                                                                                        document.getElementById('jobItemKey').value
                                                                                                                        =
                                                                                                                        itemKey;
                                                                                                                        document.getElementById('jobItemType').value
                                                                                                                        =
                                                                                                                        type;
                                                                                                                        document.getElementById('jobItemName').textContent
                                                                                                                        =
                                                                                                                        `${type
                                                                                                                        ===
                                                                                                                        'blank'
                                                                                                                        ?
                                                                                                                        'ðŸ”‘'
                                                                                                                        :
                                                                                                                        'ðŸ”'}
                                                                                                                        ${itemKey}`;

                                                                                                                        //
                                                                                                                        Display
                                                                                                                        vehicle
                                                                                                                        preview
                                                                                                                        as
                                                                                                                        compact
                                                                                                                        chips
                                                                                                                        const
                                                                                                                        previewEl
                                                                                                                        =
                                                                                                                        document.getElementById('jobItemVehicle');
                                                                                                                        if
                                                                                                                        (savedVehicle)
                                                                                                                        {
                                                                                                                        previewEl.innerHTML
                                                                                                                        =
                                                                                                                        renderVehicleChips(savedVehicle,
                                                                                                                        null,
                                                                                                                        4);
                                                                                                                        previewEl.style.display
                                                                                                                        =
                                                                                                                        'flex';
                                                                                                                        previewEl.style.flexWrap
                                                                                                                        =
                                                                                                                        'wrap';
                                                                                                                        previewEl.style.gap
                                                                                                                        =
                                                                                                                        '4px';
                                                                                                                        previewEl.title
                                                                                                                        =
                                                                                                                        savedVehicle;
                                                                                                                        }
                                                                                                                        else
                                                                                                                        {
                                                                                                                        previewEl.innerHTML
                                                                                                                        =
                                                                                                                        '';
                                                                                                                        }

                                                                                                                        //
                                                                                                                        Populate
                                                                                                                        Vehicle
                                                                                                                        Select
                                                                                                                        Dropdown
                                                                                                                        (The
                                                                                                                        primary
                                                                                                                        source)
                                                                                                                        const
                                                                                                                        select
                                                                                                                        =
                                                                                                                        document.getElementById('jobVehicleSelect');
                                                                                                                        select.innerHTML
                                                                                                                        =
                                                                                                                        '
                                                                                                                        <option
                                                                                                                            value="">
                                                                                                                            --
                                                                                                                            Choose
                                                                                                                            Car
                                                                                                                            --
                                                                                                                        </option>
                                                                                                                        ';

                                                                                                                        if
                                                                                                                        (savedVehicle)
                                                                                                                        {
                                                                                                                        const
                                                                                                                        cars
                                                                                                                        =
                                                                                                                        [...new
                                                                                                                        Set(savedVehicle.split(',').map(s
                                                                                                                        =>
                                                                                                                        s.trim()).filter(s
                                                                                                                        =>
                                                                                                                        s))];
                                                                                                                        cars.forEach(car
                                                                                                                        =>
                                                                                                                        {
                                                                                                                        const
                                                                                                                        opt
                                                                                                                        =
                                                                                                                        document.createElement('option');
                                                                                                                        opt.value
                                                                                                                        =
                                                                                                                        car;
                                                                                                                        opt.textContent
                                                                                                                        =
                                                                                                                        car;
                                                                                                                        select.appendChild(opt);
                                                                                                                        });
                                                                                                                        }

                                                                                                                        //
                                                                                                                        Decide
                                                                                                                        default
                                                                                                                        selection
                                                                                                                        //
                                                                                                                        Priority:
                                                                                                                        If
                                                                                                                        'vehicle'
                                                                                                                        argument
                                                                                                                        is
                                                                                                                        a
                                                                                                                        single
                                                                                                                        car,
                                                                                                                        use
                                                                                                                        it.
                                                                                                                        let
                                                                                                                        selectedV
                                                                                                                        =
                                                                                                                        '';
                                                                                                                        if
                                                                                                                        (vehicle
                                                                                                                        &&
                                                                                                                        !vehicle.includes(',')
                                                                                                                        &&
                                                                                                                        vehicle.length
                                                                                                                        < 60)
                                                                                                                            {
                                                                                                                            selectedV=vehicle;
                                                                                                                            }
                                                                                                                            else
                                                                                                                            if
                                                                                                                            (savedVehicle
                                                                                                                            &&
                                                                                                                            !savedVehicle.includes(',')
                                                                                                                            &&
                                                                                                                            savedVehicle.length
                                                                                                                            <
                                                                                                                            60)
                                                                                                                            {
                                                                                                                            selectedV=savedVehicle;
                                                                                                                            }
                                                                                                                            document.getElementById('jobDescription').value=selectedV;
                                                                                                                            if
                                                                                                                            (selectedV)
                                                                                                                            select.value=selectedV;
                                                                                                                            document.getElementById('jobCustomer').value=''
                                                                                                                            ;
                                                                                                                            document.getElementById('jobNotes').value=amazonLink
                                                                                                                            ?
                                                                                                                            `Amazon
                                                                                                                            Link:
                                                                                                                            ${amazonLink}`
                                                                                                                            : ''
                                                                                                                            ;
                                                                                                                            //
                                                                                                                            Pricing
                                                                                                                            Logic
                                                                                                                            (ASIN
                                                                                                                            +
                                                                                                                            Manual
                                                                                                                            override)
                                                                                                                            let
                                                                                                                            estimatedCost=invItem?.cost
                                                                                                                            || ''
                                                                                                                            ;
                                                                                                                            if
                                                                                                                            (!estimatedCost
                                                                                                                            &&
                                                                                                                            typeof
                                                                                                                            asinData
                                                                                                                            !=='undefined'
                                                                                                                            &&
                                                                                                                            asinData.products_by_fcc)
                                                                                                                            {
                                                                                                                            const
                                                                                                                            productEntry=asinData.products_by_fcc[itemKey];
                                                                                                                            if
                                                                                                                            (productEntry
                                                                                                                            &&
                                                                                                                            productEntry.length>
                                                                                                                            0
                                                                                                                            &&
                                                                                                                            productEntry[0].price)
                                                                                                                            {
                                                                                                                            estimatedCost
                                                                                                                            =
                                                                                                                            productEntry[0].price.replace(/[$,]/g,
                                                                                                                            '');
                                                                                                                            }
                                                                                                                            }

                                                                                                                            document.getElementById('jobRevenue').value
                                                                                                                            =
                                                                                                                            '';
                                                                                                                            document.getElementById('jobTip').value
                                                                                                                            =
                                                                                                                            '0';
                                                                                                                            document.getElementById('itemCost').value
                                                                                                                            =
                                                                                                                            estimatedCost;
                                                                                                                            document.getElementById('jobMiles').value
                                                                                                                            =
                                                                                                                            '';
                                                                                                                            document.getElementById('jobTimeMinutes').value
                                                                                                                            =
                                                                                                                            '';

                                                                                                                            //
                                                                                                                            Reset
                                                                                                                            calculations
                                                                                                                            display
                                                                                                                            setTimeout(()
                                                                                                                            =>
                                                                                                                            calculateJobProfit(),
                                                                                                                            50);

                                                                                                                            //
                                                                                                                            Show
                                                                                                                            modal
                                                                                                                            const
                                                                                                                            modal
                                                                                                                            =
                                                                                                                            document.getElementById('jobLogModal');
                                                                                                                            if
                                                                                                                            (modal)
                                                                                                                            {
                                                                                                                            modal.classList.add('active');
                                                                                                                            }
                                                                                                                            }

                                                                                                                            //
                                                                                                                            Live
                                                                                                                            profit
                                                                                                                            calculation
                                                                                                                            for
                                                                                                                            job
                                                                                                                            modal
                                                                                                                            function
                                                                                                                            calculateJobProfit()
                                                                                                                            {
                                                                                                                            const
                                                                                                                            MILEAGE_RATE
                                                                                                                            =
                                                                                                                            0.67;
                                                                                                                            //
                                                                                                                            IRS
                                                                                                                            2024
                                                                                                                            standard
                                                                                                                            mileage
                                                                                                                            rate
                                                                                                                            const
                                                                                                                            TAX_RATE
                                                                                                                            =
                                                                                                                            0.30;
                                                                                                                            //
                                                                                                                            30%
                                                                                                                            estimated
                                                                                                                            tax

                                                                                                                            const
                                                                                                                            revenue
                                                                                                                            =
                                                                                                                            parseFloat(document.getElementById('jobRevenue')?.value)
                                                                                                                            ||
                                                                                                                            0;
                                                                                                                            const
                                                                                                                            tip
                                                                                                                            =
                                                                                                                            parseFloat(document.getElementById('jobTip')?.value)
                                                                                                                            ||
                                                                                                                            0;
                                                                                                                            const
                                                                                                                            keyCost
                                                                                                                            =
                                                                                                                            parseFloat(document.getElementById('itemCost')?.value)
                                                                                                                            ||
                                                                                                                            0;
                                                                                                                            const
                                                                                                                            miles
                                                                                                                            =
                                                                                                                            parseFloat(document.getElementById('jobMiles')?.value)
                                                                                                                            ||
                                                                                                                            0;
                                                                                                                            const
                                                                                                                            minutes
                                                                                                                            =
                                                                                                                            parseFloat(document.getElementById('jobTimeMinutes')?.value)
                                                                                                                            ||
                                                                                                                            0;

                                                                                                                            const
                                                                                                                            gross
                                                                                                                            =
                                                                                                                            revenue
                                                                                                                            +
                                                                                                                            tip;
                                                                                                                            const
                                                                                                                            mileageCost
                                                                                                                            =
                                                                                                                            miles
                                                                                                                            *
                                                                                                                            MILEAGE_RATE;
                                                                                                                            const
                                                                                                                            totalExpenses
                                                                                                                            =
                                                                                                                            keyCost
                                                                                                                            +
                                                                                                                            mileageCost;
                                                                                                                            const
                                                                                                                            netProfit
                                                                                                                            =
                                                                                                                            gross
                                                                                                                            -
                                                                                                                            totalExpenses;
                                                                                                                            const
                                                                                                                            taxEstimate
                                                                                                                            =
                                                                                                                            Math.max(0,
                                                                                                                            netProfit
                                                                                                                            *
                                                                                                                            TAX_RATE);
                                                                                                                            const
                                                                                                                            hours
                                                                                                                            =
                                                                                                                            minutes
                                                                                                                            /
                                                                                                                            60;
                                                                                                                            const
                                                                                                                            hourlyRate
                                                                                                                            =
                                                                                                                            hours
                                                                                                                            >
                                                                                                                            0
                                                                                                                            ?
                                                                                                                            netProfit
                                                                                                                            /
                                                                                                                            hours
                                                                                                                            :
                                                                                                                            0;

                                                                                                                            //
                                                                                                                            Update
                                                                                                                            display
                                                                                                                            if
                                                                                                                            (document.getElementById('calcGross'))
                                                                                                                            {
                                                                                                                            document.getElementById('calcGross').textContent
                                                                                                                            =
                                                                                                                            `$${gross.toFixed(2)}`;
                                                                                                                            document.getElementById('calcExpenses').textContent
                                                                                                                            =
                                                                                                                            `$${totalExpenses.toFixed(2)}`;
                                                                                                                            document.getElementById('calcProfit').textContent
                                                                                                                            =
                                                                                                                            `$${netProfit.toFixed(2)}`;
                                                                                                                            document.getElementById('calcProfit').style.color
                                                                                                                            =
                                                                                                                            netProfit
                                                                                                                            >=
                                                                                                                            0
                                                                                                                            ?
                                                                                                                            'var(--brand-primary)'
                                                                                                                            :
                                                                                                                            '#f87171';
                                                                                                                            document.getElementById('calcHourly').textContent
                                                                                                                            =
                                                                                                                            hours
                                                                                                                            >
                                                                                                                            0
                                                                                                                            ?
                                                                                                                            `$${hourlyRate.toFixed(2)}`
                                                                                                                            :
                                                                                                                            '--';
                                                                                                                            document.getElementById('calcTax').textContent
                                                                                                                            =
                                                                                                                            `$${taxEstimate.toFixed(2)}`;
                                                                                                                            document.getElementById('calcMileage').textContent
                                                                                                                            =
                                                                                                                            `$${mileageCost.toFixed(2)}`;
                                                                                                                            }
                                                                                                                            }

                                                                                                                            function
                                                                                                                            inventoryMarkUsed(itemKey,
                                                                                                                            type
                                                                                                                            =
                                                                                                                            'key')
                                                                                                                            {
                                                                                                                            openJobLogModal(itemKey,
                                                                                                                            type);
                                                                                                                            }

                                                                                                                            //
                                                                                                                            Close
                                                                                                                            the
                                                                                                                            job
                                                                                                                            logging
                                                                                                                            modal
                                                                                                                            function
                                                                                                                            closeJobModal()
                                                                                                                            {
                                                                                                                            const
                                                                                                                            modal
                                                                                                                            =
                                                                                                                            document.getElementById('jobLogModal');
                                                                                                                            if
                                                                                                                            (modal)
                                                                                                                            {
                                                                                                                            modal.classList.remove('active');
                                                                                                                            }
                                                                                                                            }

                                                                                                                            //
                                                                                                                            Submit
                                                                                                                            the
                                                                                                                            job
                                                                                                                            log
                                                                                                                            form
                                                                                                                            function
                                                                                                                            submitJobLog(event)
                                                                                                                            {
                                                                                                                            event.preventDefault();

                                                                                                                            const
                                                                                                                            MILEAGE_RATE
                                                                                                                            =
                                                                                                                            0.67;
                                                                                                                            //
                                                                                                                            IRS
                                                                                                                            2024
                                                                                                                            standard
                                                                                                                            mileage
                                                                                                                            rate
                                                                                                                            const
                                                                                                                            TAX_RATE
                                                                                                                            =
                                                                                                                            0.30;
                                                                                                                            //
                                                                                                                            30%
                                                                                                                            estimated
                                                                                                                            tax

                                                                                                                            const
                                                                                                                            itemKey
                                                                                                                            =
                                                                                                                            document.getElementById('jobItemKey').value;
                                                                                                                            const
                                                                                                                            type
                                                                                                                            =
                                                                                                                            document.getElementById('jobItemType').value;
                                                                                                                            const
                                                                                                                            customer
                                                                                                                            =
                                                                                                                            document.getElementById('jobCustomer').value.trim();
                                                                                                                            const
                                                                                                                            description
                                                                                                                            =
                                                                                                                            document.getElementById('jobDescription').value.trim();
                                                                                                                            const
                                                                                                                            notes
                                                                                                                            =
                                                                                                                            document.getElementById('jobNotes').value.trim();

                                                                                                                            //
                                                                                                                            Financials
                                                                                                                            -
                                                                                                                            NEW
                                                                                                                            EBITDA
                                                                                                                            FIELDS
                                                                                                                            const
                                                                                                                            revenue
                                                                                                                            =
                                                                                                                            parseFloat(document.getElementById('jobRevenue').value)
                                                                                                                            ||
                                                                                                                            0;
                                                                                                                            const
                                                                                                                            tip
                                                                                                                            =
                                                                                                                            parseFloat(document.getElementById('jobTip').value)
                                                                                                                            ||
                                                                                                                            0;
                                                                                                                            const
                                                                                                                            keyCost
                                                                                                                            =
                                                                                                                            parseFloat(document.getElementById('itemCost').value)
                                                                                                                            ||
                                                                                                                            0;
                                                                                                                            const
                                                                                                                            miles
                                                                                                                            =
                                                                                                                            parseFloat(document.getElementById('jobMiles').value)
                                                                                                                            ||
                                                                                                                            0;
                                                                                                                            const
                                                                                                                            minutes
                                                                                                                            =
                                                                                                                            parseFloat(document.getElementById('jobTimeMinutes').value)
                                                                                                                            ||
                                                                                                                            0;

                                                                                                                            //
                                                                                                                            Calculated
                                                                                                                            values
                                                                                                                            const
                                                                                                                            gross
                                                                                                                            =
                                                                                                                            revenue
                                                                                                                            +
                                                                                                                            tip;
                                                                                                                            const
                                                                                                                            mileageCost
                                                                                                                            =
                                                                                                                            miles
                                                                                                                            *
                                                                                                                            MILEAGE_RATE;
                                                                                                                            const
                                                                                                                            totalExpenses
                                                                                                                            =
                                                                                                                            keyCost
                                                                                                                            +
                                                                                                                            mileageCost;
                                                                                                                            const
                                                                                                                            netProfit
                                                                                                                            =
                                                                                                                            gross
                                                                                                                            -
                                                                                                                            totalExpenses;
                                                                                                                            const
                                                                                                                            hours
                                                                                                                            =
                                                                                                                            minutes
                                                                                                                            /
                                                                                                                            60;
                                                                                                                            const
                                                                                                                            hourlyRate
                                                                                                                            =
                                                                                                                            hours
                                                                                                                            >
                                                                                                                            0
                                                                                                                            ?
                                                                                                                            netProfit
                                                                                                                            /
                                                                                                                            hours
                                                                                                                            :
                                                                                                                            0;
                                                                                                                            const
                                                                                                                            taxEstimate
                                                                                                                            =
                                                                                                                            Math.max(0,
                                                                                                                            netProfit
                                                                                                                            *
                                                                                                                            TAX_RATE);

                                                                                                                            //
                                                                                                                            Consuming
                                                                                                                            stock
                                                                                                                            logic
                                                                                                                            const
                                                                                                                            consumeStock
                                                                                                                            =
                                                                                                                            document.getElementById('jobConsumeStock').checked;

                                                                                                                            if
                                                                                                                            (consumeStock)
                                                                                                                            {
                                                                                                                            const
                                                                                                                            stock
                                                                                                                            =
                                                                                                                            type
                                                                                                                            ===
                                                                                                                            'blank'
                                                                                                                            ?
                                                                                                                            InventoryManager.getBlankStock(itemKey)
                                                                                                                            :
                                                                                                                            InventoryManager.getKeyStock(itemKey);
                                                                                                                            if
                                                                                                                            (stock
                                                                                                                            <= 0)
                                                                                                                                {
                                                                                                                                if
                                                                                                                                (!confirm('Stock
                                                                                                                                is
                                                                                                                                0.
                                                                                                                                Log
                                                                                                                                job
                                                                                                                                and
                                                                                                                                decrement
                                                                                                                                anyway
                                                                                                                                (resulting
                                                                                                                                in
                                                                                                                                negative/used
                                                                                                                                count)?'))
                                                                                                                                {
                                                                                                                                return;
                                                                                                                                }
                                                                                                                                }
                                                                                                                                if
                                                                                                                                (type==='blank'
                                                                                                                                )
                                                                                                                                {
                                                                                                                                InventoryManager.useBlankStock(itemKey);
                                                                                                                                const
                                                                                                                                inv=InventoryManager.getBlanksInventory();
                                                                                                                                if
                                                                                                                                (inv[itemKey]
                                                                                                                                &&
                                                                                                                                !inv[itemKey].vehicle
                                                                                                                                &&
                                                                                                                                description)
                                                                                                                                {
                                                                                                                                inv[itemKey].vehicle=description;
                                                                                                                                InventoryManager.setBlanksInventory(inv);
                                                                                                                                }
                                                                                                                                }
                                                                                                                                else
                                                                                                                                {
                                                                                                                                InventoryManager.useKeyStock(itemKey);
                                                                                                                                const
                                                                                                                                inv=InventoryManager.getKeysInventory();
                                                                                                                                if
                                                                                                                                (inv[itemKey]
                                                                                                                                &&
                                                                                                                                !inv[itemKey].vehicle
                                                                                                                                &&
                                                                                                                                description)
                                                                                                                                {
                                                                                                                                inv[itemKey].vehicle=description;
                                                                                                                                InventoryManager.setKeysInventory(inv);
                                                                                                                                }
                                                                                                                                }
                                                                                                                                }
                                                                                                                                //
                                                                                                                                Log
                                                                                                                                the
                                                                                                                                job
                                                                                                                                with
                                                                                                                                full
                                                                                                                                EBITDA
                                                                                                                                data
                                                                                                                                const
                                                                                                                                jobLog={
                                                                                                                                itemKey,
                                                                                                                                type,
                                                                                                                                vehicle:
                                                                                                                                description,
                                                                                                                                date:
                                                                                                                                new
                                                                                                                                Date().toISOString(),
                                                                                                                                timestamp:
                                                                                                                                Date.now(),
                                                                                                                                //
                                                                                                                                Revenue
                                                                                                                                revenue:
                                                                                                                                revenue,
                                                                                                                                tip:
                                                                                                                                tip,
                                                                                                                                gross:
                                                                                                                                gross,
                                                                                                                                //
                                                                                                                                Costs
                                                                                                                                cost:
                                                                                                                                keyCost,
                                                                                                                                miles:
                                                                                                                                miles,
                                                                                                                                mileageCost:
                                                                                                                                mileageCost,
                                                                                                                                totalExpenses:
                                                                                                                                totalExpenses,
                                                                                                                                //
                                                                                                                                Time
                                                                                                                                minutes:
                                                                                                                                minutes,
                                                                                                                                hours:
                                                                                                                                hours,
                                                                                                                                //
                                                                                                                                Profit
                                                                                                                                metrics
                                                                                                                                netProfit:
                                                                                                                                netProfit,
                                                                                                                                hourlyRate:
                                                                                                                                hourlyRate,
                                                                                                                                taxEstimate:
                                                                                                                                taxEstimate,
                                                                                                                                //
                                                                                                                                Metadata
                                                                                                                                customer:
                                                                                                                                customer
                                                                                                                                || 'Walk-in'
                                                                                                                                ,
                                                                                                                                description:
                                                                                                                                description
                                                                                                                                ||
                                                                                                                                `Used
                                                                                                                                1
                                                                                                                                ${type==='blank'
                                                                                                                                ? 'key blank'
                                                                                                                                : 'key fob'
                                                                                                                                }`,
                                                                                                                                notes:
                                                                                                                                notes
                                                                                                                                };
                                                                                                                                //
                                                                                                                                Get
                                                                                                                                existing
                                                                                                                                logs
                                                                                                                                or
                                                                                                                                create
                                                                                                                                new
                                                                                                                                array
                                                                                                                                const
                                                                                                                                logsKey='eurokeys_job_logs'
                                                                                                                                ;
                                                                                                                                let
                                                                                                                                logs=[];
                                                                                                                                try
                                                                                                                                {
                                                                                                                                const
                                                                                                                                existing=localStorage.getItem(logsKey);
                                                                                                                                if
                                                                                                                                (existing)
                                                                                                                                logs=JSON.parse(existing);
                                                                                                                                }
                                                                                                                                catch
                                                                                                                                (e)
                                                                                                                                {
                                                                                                                                }
                                                                                                                                logs.push(jobLog);
                                                                                                                                localStorage.setItem(logsKey,
                                                                                                                                JSON.stringify(logs));
                                                                                                                                //
                                                                                                                                Sync
                                                                                                                                job
                                                                                                                                log
                                                                                                                                to
                                                                                                                                cloud
                                                                                                                                if
                                                                                                                                signed
                                                                                                                                in
                                                                                                                                if
                                                                                                                                (currentUser)
                                                                                                                                {
                                                                                                                                try
                                                                                                                                {
                                                                                                                                fetch(`${API}/api/user/job_logs`,
                                                                                                                                {
                                                                                                                                method: 'POST'
                                                                                                                                ,
                                                                                                                                headers:
                                                                                                                                {
                                                                                                                                ...getAuthHeaders(), 'Content-Type'
                                                                                                                                : 'application/json'
                                                                                                                                },
                                                                                                                                body:
                                                                                                                                JSON.stringify({
                                                                                                                                id:
                                                                                                                                jobLog.id,
                                                                                                                                log:
                                                                                                                                jobLog
                                                                                                                                })
                                                                                                                                }).catch(e=>
                                                                                                                                console.warn('Job
                                                                                                                                log
                                                                                                                                cloud
                                                                                                                                sync
                                                                                                                                failed:',
                                                                                                                                e));
                                                                                                                                }
                                                                                                                                catch
                                                                                                                                (e)
                                                                                                                                {
                                                                                                                                console.warn('Job
                                                                                                                                log
                                                                                                                                cloud
                                                                                                                                sync
                                                                                                                                failed:',
                                                                                                                                e);
                                                                                                                                }
                                                                                                                                }

                                                                                                                                //
                                                                                                                                Update
                                                                                                                                UI
                                                                                                                                updateInventoryDisplay(itemKey,
                                                                                                                                type);
                                                                                                                                updateInventoryTabBadge();

                                                                                                                                //
                                                                                                                                Refresh
                                                                                                                                inventory
                                                                                                                                page
                                                                                                                                if
                                                                                                                                active
                                                                                                                                if
                                                                                                                                (document.getElementById('tabInventory')?.classList.contains('active'))
                                                                                                                                {
                                                                                                                                renderInventoryPage();
                                                                                                                                }

                                                                                                                                //
                                                                                                                                Close
                                                                                                                                modal
                                                                                                                                closeJobModal();
                                                                                                                                }

                                                                                                                                //
                                                                                                                                Update
                                                                                                                                inventory
                                                                                                                                tab
                                                                                                                                badge
                                                                                                                                with
                                                                                                                                total
                                                                                                                                count
                                                                                                                                function
                                                                                                                                updateInventoryTabBadge()
                                                                                                                                {
                                                                                                                                const
                                                                                                                                tab
                                                                                                                                =
                                                                                                                                document.getElementById('inventoryTab');
                                                                                                                                if
                                                                                                                                (tab)
                                                                                                                                {
                                                                                                                                //
                                                                                                                                UNLOCKED:
                                                                                                                                if
                                                                                                                                (tab
                                                                                                                                &&
                                                                                                                                currentUser)
                                                                                                                                const
                                                                                                                                totalKeys
                                                                                                                                =
                                                                                                                                InventoryManager.getTotalKeys();
                                                                                                                                const
                                                                                                                                totalBlanks
                                                                                                                                =
                                                                                                                                InventoryManager.getTotalBlanks();
                                                                                                                                const
                                                                                                                                total
                                                                                                                                =
                                                                                                                                totalKeys
                                                                                                                                +
                                                                                                                                totalBlanks;
                                                                                                                                tab.innerHTML
                                                                                                                                =
                                                                                                                                total
                                                                                                                                >
                                                                                                                                0
                                                                                                                                ?
                                                                                                                                `ðŸ“¦
                                                                                                                                My
                                                                                                                                Inventory
                                                                                                                                <span
                                                                                                                                    style="background: var(--brand-primary); color: #000; padding: 2px 8px; border-radius: 10px; font-size: 0.75rem; margin-left: 4px;">${total}</span>`
                                                                                                                                :
                                                                                                                                'ðŸ“¦
                                                                                                                                My
                                                                                                                                Inventory';
                                                                                                                                }
                                                                                                                                }

                                                                                                                                //
                                                                                                                                Generate
                                                                                                                                inventory
                                                                                                                                control
                                                                                                                                HTML
                                                                                                                                for
                                                                                                                                a
                                                                                                                                vehicle
                                                                                                                                card
                                                                                                                                (shows
                                                                                                                                both
                                                                                                                                key
                                                                                                                                and
                                                                                                                                blank)
                                                                                                                                function
                                                                                                                                getVehicleInventoryHtml(keyIdentifier,
                                                                                                                                blankKeyway,
                                                                                                                                vehicleInfo
                                                                                                                                =
                                                                                                                                null,
                                                                                                                                keyAmazonLink
                                                                                                                                =
                                                                                                                                null,
                                                                                                                                blankAmazonLink
                                                                                                                                =
                                                                                                                                null)
                                                                                                                                {
                                                                                                                                //
                                                                                                                                UNLOCKED:
                                                                                                                                if
                                                                                                                                (!currentUser)
                                                                                                                                return
                                                                                                                                '';

                                                                                                                                const
                                                                                                                                keyStock
                                                                                                                                =
                                                                                                                                keyIdentifier
                                                                                                                                ?
                                                                                                                                InventoryManager.getKeyStock(keyIdentifier)
                                                                                                                                :
                                                                                                                                0;
                                                                                                                                const
                                                                                                                                blankStock
                                                                                                                                =
                                                                                                                                blankKeyway
                                                                                                                                &&
                                                                                                                                blankKeyway
                                                                                                                                !==
                                                                                                                                'N/A'
                                                                                                                                ?
                                                                                                                                InventoryManager.getBlankStock(blankKeyway)
                                                                                                                                :
                                                                                                                                0;

                                                                                                                                const
                                                                                                                                escapedKey
                                                                                                                                =
                                                                                                                                keyIdentifier
                                                                                                                                ?
                                                                                                                                keyIdentifier.replace(/'/g,
                                                                                                                                "\\'")
                                                                                                                                :
                                                                                                                                '';
                                                                                                                                const
                                                                                                                                escapedBlank
                                                                                                                                =
                                                                                                                                blankKeyway
                                                                                                                                &&
                                                                                                                                blankKeyway
                                                                                                                                !==
                                                                                                                                'N/A'
                                                                                                                                ?
                                                                                                                                blankKeyway.replace(/'/g,
                                                                                                                                "\\'")
                                                                                                                                :
                                                                                                                                '';
                                                                                                                                const
                                                                                                                                escapedVehicle
                                                                                                                                =
                                                                                                                                vehicleInfo
                                                                                                                                ?
                                                                                                                                vehicleInfo.replace(/'/g,
                                                                                                                                "\\'")
                                                                                                                                :
                                                                                                                                '';
                                                                                                                                const
                                                                                                                                escapedKeyAmazon
                                                                                                                                =
                                                                                                                                keyAmazonLink
                                                                                                                                ?
                                                                                                                                keyAmazonLink.replace(/'/g,
                                                                                                                                "\\'")
                                                                                                                                :
                                                                                                                                '';
                                                                                                                                const
                                                                                                                                escapedBlankAmazon
                                                                                                                                =
                                                                                                                                blankAmazonLink
                                                                                                                                ?
                                                                                                                                blankAmazonLink.replace(/'/g,
                                                                                                                                "\\'")
                                                                                                                                :
                                                                                                                                '';

                                                                                                                                let
                                                                                                                                html
                                                                                                                                =
                                                                                                                                '';

                                                                                                                                //
                                                                                                                                Key
                                                                                                                                fob/remote
                                                                                                                                inventory
                                                                                                                                if
                                                                                                                                (keyIdentifier)
                                                                                                                                {
                                                                                                                                const
                                                                                                                                lastNote
                                                                                                                                =
                                                                                                                                getLastComment(keyIdentifier);
                                                                                                                                html
                                                                                                                                +=
                                                                                                                                `
                                                                                                                                <div
                                                                                                                                    style="margin-bottom: 12px;">
                                                                                                                                    <div
                                                                                                                                        style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                                                                                                                                        <div
                                                                                                                                            style="display: flex; align-items: center; gap: 8px;">
                                                                                                                                            <span
                                                                                                                                                style="font-size: 0.75rem; color: var(--text-muted);">ðŸ”
                                                                                                                                                Key
                                                                                                                                                Fob:</span>
                                                                                                                                            <span
                                                                                                                                                id="inv-badge-${CSS.escape(keyIdentifier)}"
                                                                                                                                                class="inventory-badge ${keyStock > 0 ? 'in-stock' : 'out-of-stock'}">
                                                                                                                                                ${keyStock
                                                                                                                                                >
                                                                                                                                                0
                                                                                                                                                ?
                                                                                                                                                `ðŸ“¦
                                                                                                                                                ${keyStock}`
                                                                                                                                                :
                                                                                                                                                'âš ï¸
                                                                                                                                                0'}
                                                                                                                                            </span>
                                                                                                                                            <div
                                                                                                                                                class="inventory-controls">
                                                                                                                                                <button
                                                                                                                                                    class="inventory-btn"
                                                                                                                                                    onclick="inventoryMinus('${escapedKey}', 'key')"
                                                                                                                                                    id="inv-minus-${CSS.escape(keyIdentifier)}"
                                                                                                                                                    ${keyStock===0
                                                                                                                                                    ? 'disabled'
                                                                                                                                                    : ''
                                                                                                                                                    }>âˆ’</button>
                                                                                                                                                <button
                                                                                                                                                    class="inventory-btn"
                                                                                                                                                    onclick="inventoryAdd('${escapedKey}', 'key', '${escapedVehicle}', '${escapedKeyAmazon}')">+</button>
                                                                                                                                            </div>
                                                                                                                                        </div>
                                                                                                                                        <button
                                                                                                                                            class="btn-log-job"
                                                                                                                                            onclick="openJobLogModal('${escapedKey}', 'key', '${escapedVehicle}', '${escapedKeyAmazon}')"
                                                                                                                                            id="inv-used-${CSS.escape(keyIdentifier)}"
                                                                                                                                            ${keyStock===0
                                                                                                                                            ? 'disabled'
                                                                                                                                            : ''
                                                                                                                                            }>âœ“
                                                                                                                                            Log
                                                                                                                                            Job</button>
                                                                                                                                    </div>
                                                                                                                                    <div id="inv-note-key-${CSS.escape(keyIdentifier)}"
                                                                                                                                        style="${lastNote ? 'display: block' : 'display: none'}; background: rgba(255, 255, 255, 0.05); border-left: 3px solid var(--brand-primary); padding: 8px 12px; border-radius: 0 6px 6px 0; font-size: 0.8rem; color: var(--text-secondary); margin-top: 4px;">
                                                                                                                                        ${lastNote
                                                                                                                                        ?
                                                                                                                                        `
                                                                                                                                        <div
                                                                                                                                            style="font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 2px;">
                                                                                                                                            Last
                                                                                                                                            Job
                                                                                                                                            Note:
                                                                                                                                        </div>
                                                                                                                                        "${lastNote}"`
                                                                                                                                        :
                                                                                                                                        ''}
                                                                                                                                    </div>
                                                                                                                                </div>
                                                                                                                                `;
                                                                                                                                }

                                                                                                                                //
                                                                                                                                Key
                                                                                                                                blank
                                                                                                                                inventory
                                                                                                                                if
                                                                                                                                (blankKeyway
                                                                                                                                &&
                                                                                                                                blankKeyway
                                                                                                                                !==
                                                                                                                                'N/A')
                                                                                                                                {
                                                                                                                                const
                                                                                                                                lastNote
                                                                                                                                =
                                                                                                                                getLastComment(blankKeyway);
                                                                                                                                html
                                                                                                                                +=
                                                                                                                                `
                                                                                                                                <div>
                                                                                                                                    <div
                                                                                                                                        style="display: flex; align-items: center; justify-content: space-between;">
                                                                                                                                        <div
                                                                                                                                            style="display: flex; align-items: center; gap: 8px;">
                                                                                                                                            <span
                                                                                                                                                style="font-size: 0.75rem; color: var(--text-muted);">ðŸ”‘
                                                                                                                                                Blank
                                                                                                                                                (${blankKeyway}):</span>
                                                                                                                                            <span
                                                                                                                                                id="blank-badge-${CSS.escape(blankKeyway)}"
                                                                                                                                                class="inventory-badge ${blankStock > 0 ? 'in-stock' : 'out-of-stock'}">
                                                                                                                                                ${blankStock
                                                                                                                                                >
                                                                                                                                                0
                                                                                                                                                ?
                                                                                                                                                `ðŸ”‘
                                                                                                                                                ${blankStock}`
                                                                                                                                                :
                                                                                                                                                'âš ï¸
                                                                                                                                                0'}
                                                                                                                                            </span>
                                                                                                                                            <div
                                                                                                                                                class="inventory-controls">
                                                                                                                                                <button
                                                                                                                                                    class="inventory-btn"
                                                                                                                                                    onclick="inventoryMinus('${escapedBlank}', 'blank')"
                                                                                                                                                    id="blank-minus-${CSS.escape(blankKeyway)}"
                                                                                                                                                    ${blankStock===0
                                                                                                                                                    ? 'disabled'
                                                                                                                                                    : ''
                                                                                                                                                    }>âˆ’</button>
                                                                                                                                                <button
                                                                                                                                                    class="inventory-btn"
                                                                                                                                                    onclick="inventoryAdd('${escapedBlank}', 'blank', '${escapedVehicle}', '${escapedBlankAmazon}')">+</button>
                                                                                                                                            </div>
                                                                                                                                        </div>
                                                                                                                                        <button
                                                                                                                                            class="btn-log-job"
                                                                                                                                            onclick="openJobLogModal('${escapedBlank}', 'blank', '${escapedVehicle}', '${escapedBlankAmazon}')"
                                                                                                                                            id="blank-used-${CSS.escape(blankKeyway)}"
                                                                                                                                            ${blankStock===0
                                                                                                                                            ? 'disabled'
                                                                                                                                            : ''
                                                                                                                                            }>âœ“
                                                                                                                                            Log
                                                                                                                                            Job</button>
                                                                                                                                    </div>
                                                                                                                                    <div id="inv-note-blank-${CSS.escape(blankKeyway)}"
                                                                                                                                        style="${lastNote ? 'display: block' : 'display: none'}; background: rgba(255, 255, 255, 0.05); border-left: 3px solid var(--brand-primary); padding: 8px 12px; border-radius: 0 6px 6px 0; font-size: 0.8rem; color: var(--text-secondary); margin-top: 8px;">
                                                                                                                                        ${lastNote
                                                                                                                                        ?
                                                                                                                                        `
                                                                                                                                        <div
                                                                                                                                            style="font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 2px;">
                                                                                                                                            Last
                                                                                                                                            Job
                                                                                                                                            Note:
                                                                                                                                        </div>
                                                                                                                                        "${lastNote}"`
                                                                                                                                        :
                                                                                                                                        ''}
                                                                                                                                    </div>
                                                                                                                                </div>
                                                                                                                                `;
                                                                                                                                }

                                                                                                                                return
                                                                                                                                html
                                                                                                                                ?
                                                                                                                                `
                                                                                                                                <div
                                                                                                                                    style="padding-top: 8px; border-top: 1px solid var(--border);">
                                                                                                                                    ${html}
                                                                                                                                </div>
                                                                                                                                `
                                                                                                                                :
                                                                                                                                '';
                                                                                                                                }

                                                                                                                                //
                                                                                                                                Helper
                                                                                                                                to
                                                                                                                                get
                                                                                                                                last
                                                                                                                                comment
                                                                                                                                from
                                                                                                                                localStorage
                                                                                                                                function
                                                                                                                                getLastComment(itemKey)
                                                                                                                                {
                                                                                                                                try
                                                                                                                                {
                                                                                                                                const
                                                                                                                                logs
                                                                                                                                =
                                                                                                                                JSON.parse(localStorage.getItem('eurokeys_job_logs')
                                                                                                                                ||
                                                                                                                                '[]');
                                                                                                                                const
                                                                                                                                itemLogs
                                                                                                                                =
                                                                                                                                logs.filter(l
                                                                                                                                =>
                                                                                                                                l.itemKey
                                                                                                                                ===
                                                                                                                                itemKey
                                                                                                                                &&
                                                                                                                                l.notes
                                                                                                                                &&
                                                                                                                                l.notes.trim().length
                                                                                                                                >
                                                                                                                                0);
                                                                                                                                itemLogs.sort((a,
                                                                                                                                b)
                                                                                                                                =>
                                                                                                                                b.timestamp
                                                                                                                                -
                                                                                                                                a.timestamp);
                                                                                                                                return
                                                                                                                                itemLogs.length
                                                                                                                                >
                                                                                                                                0
                                                                                                                                ?
                                                                                                                                itemLogs[0].notes
                                                                                                                                :
                                                                                                                                null;
                                                                                                                                }
                                                                                                                                catch
                                                                                                                                (e)
                                                                                                                                {
                                                                                                                                return
                                                                                                                                null;
                                                                                                                                }
                                                                                                                                }

                                                                                                                                //
                                                                                                                                Update
                                                                                                                                Job
                                                                                                                                Note
                                                                                                                                Display
                                                                                                                                directly
                                                                                                                                function
                                                                                                                                updateJobNoteDisplay(itemKey,
                                                                                                                                type)
                                                                                                                                {
                                                                                                                                const
                                                                                                                                noteEl
                                                                                                                                =
                                                                                                                                document.getElementById(`inv-note-${type}-${CSS.escape(itemKey)}`);
                                                                                                                                if
                                                                                                                                (noteEl)
                                                                                                                                {
                                                                                                                                const
                                                                                                                                lastNote
                                                                                                                                =
                                                                                                                                getLastComment(itemKey);
                                                                                                                                if
                                                                                                                                (lastNote)
                                                                                                                                {
                                                                                                                                noteEl.innerHTML
                                                                                                                                =
                                                                                                                                `
                                                                                                                                <div
                                                                                                                                    style="font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 2px;">
                                                                                                                                    Last
                                                                                                                                    Job
                                                                                                                                    Note:
                                                                                                                                </div>
                                                                                                                                "${lastNote}"`;
                                                                                                                                noteEl.style.display
                                                                                                                                =
                                                                                                                                'block';
                                                                                                                                }
                                                                                                                                else
                                                                                                                                {
                                                                                                                                noteEl.style.display
                                                                                                                                =
                                                                                                                                'none';
                                                                                                                                noteEl.innerHTML
                                                                                                                                =
                                                                                                                                '';
                                                                                                                                }
                                                                                                                                }
                                                                                                                                }

                                                                                                                                //
                                                                                                                                Generate
                                                                                                                                inventory
                                                                                                                                control
                                                                                                                                HTML
                                                                                                                                for
                                                                                                                                an
                                                                                                                                item
                                                                                                                                (legacy
                                                                                                                                for
                                                                                                                                FCC
                                                                                                                                modal)
                                                                                                                                function
                                                                                                                                getInventoryControlsHtml(itemKey)
                                                                                                                                {
                                                                                                                                //
                                                                                                                                UNLOCKED:
                                                                                                                                if
                                                                                                                                (!currentUser)
                                                                                                                                return
                                                                                                                                '';

                                                                                                                                const
                                                                                                                                stock
                                                                                                                                =
                                                                                                                                InventoryManager.getKeyStock(itemKey);
                                                                                                                                const
                                                                                                                                escapedKey
                                                                                                                                =
                                                                                                                                itemKey.replace(/'/g,
                                                                                                                                "\\'");
                                                                                                                                const
                                                                                                                                cssEscapedKey
                                                                                                                                =
                                                                                                                                CSS.escape(itemKey);

                                                                                                                                return
                                                                                                                                `
                                                                                                                                <div class="inventory-row"
                                                                                                                                    style="display: flex; align-items: center; justify-content: space-between; gap: 12px; flex-wrap: wrap;">
                                                                                                                                    <div
                                                                                                                                        style="flex: 1; min-width: 140px;">
                                                                                                                                        <span
                                                                                                                                            id="inv-badge-${cssEscapedKey}"
                                                                                                                                            class="inventory-badge ${stock > 0 ? 'in-stock' : 'out-of-stock'}"
                                                                                                                                            style="
                            padding: 6px 12px; 
                            border-radius: 20px; 
                            font-size: 0.85rem; 
                            font-weight: 700;
                            display: inline-flex;
                            align-items: center;
                            gap: 6px;
                            background: ${stock > 0 ? 'rgba(34, 197, 94, 0.1)' : 'rgba(239, 68, 68, 0.1)'};
                            color: ${stock > 0 ? '#4ade80' : '#f87171'};
                            border: 1px solid ${stock > 0 ? 'rgba(34, 197, 94, 0.2)' : 'rgba(239, 68, 68, 0.2)'};
                        ">
                                                                                                                                            ${stock
                                                                                                                                            >
                                                                                                                                            0
                                                                                                                                            ?
                                                                                                                                            `ðŸ“¦
                                                                                                                                            ${stock}
                                                                                                                                            in
                                                                                                                                            stock`
                                                                                                                                            :
                                                                                                                                            'âš ï¸
                                                                                                                                            Out
                                                                                                                                            of
                                                                                                                                            stock'}
                                                                                                                                        </span>
                                                                                                                                        <div class="inventory-controls"
                                                                                                                                            style="display: flex; align-items: center; gap: 8px; margin-top: 10px;">
                                                                                                                                            <button
                                                                                                                                                class="inventory-btn"
                                                                                                                                                onclick="inventoryMinus('${escapedKey}', 'key')"
                                                                                                                                                id="inv-minus-${cssEscapedKey}"
                                                                                                                                                ${stock===0
                                                                                                                                                ? 'disabled'
                                                                                                                                                : ''
                                                                                                                                                }
                                                                                                                                                style="width: 32px; height: 32px; border-radius: 50%; border: 1px solid var(--border); background: var(--bg-tertiary); color: var(--text-primary); cursor: pointer; display: flex; align-items: center; justify-content: center; font-weight: 700;">âˆ’</button>
                                                                                                                                            <span
                                                                                                                                                style="font-weight: 700; font-size: 1rem; min-width: 20px; text-align: center;">${stock}</span>
                                                                                                                                            <button
                                                                                                                                                class="inventory-btn"
                                                                                                                                                onclick="inventoryAdd('${escapedKey}', 'key')"
                                                                                                                                                style="width: 32px; height: 32px; border-radius: 50%; border: 1px solid var(--border); background: var(--bg-tertiary); color: var(--text-primary); cursor: pointer; display: flex; align-items: center; justify-content: center; font-weight: 700;">+</button>
                                                                                                                                        </div>
                                                                                                                                    </div>
                                                                                                                                    <button
                                                                                                                                        class="btn-log-job"
                                                                                                                                        onclick="openJobLogModal('${escapedKey}', 'key')"
                                                                                                                                        id="inv-used-${cssEscapedKey}"
                                                                                                                                        ${stock===0
                                                                                                                                        ? 'disabled'
                                                                                                                                        : ''
                                                                                                                                        }
                                                                                                                                        style="flex: 1; min-width: 140px;">âœ“
                                                                                                                                        Log
                                                                                                                                        Job</button>
                                                                                                                                </div>
                                                                                                                                `;
                                                                                                                                }

                                                                                                                                function
                                                                                                                                calculateInventoryStats(period
                                                                                                                                =
                                                                                                                                'year')
                                                                                                                                {
                                                                                                                                const
                                                                                                                                logs
                                                                                                                                =
                                                                                                                                JSON.parse(localStorage.getItem('eurokeys_job_logs')
                                                                                                                                ||
                                                                                                                                '[]');
                                                                                                                                const
                                                                                                                                now
                                                                                                                                =
                                                                                                                                new
                                                                                                                                Date();
                                                                                                                                let
                                                                                                                                filteredLogs
                                                                                                                                =
                                                                                                                                logs;

                                                                                                                                if
                                                                                                                                (period
                                                                                                                                ===
                                                                                                                                'week')
                                                                                                                                {
                                                                                                                                const
                                                                                                                                weekAgo
                                                                                                                                =
                                                                                                                                new
                                                                                                                                Date(now.getTime()
                                                                                                                                -
                                                                                                                                7
                                                                                                                                *
                                                                                                                                24
                                                                                                                                *
                                                                                                                                60
                                                                                                                                *
                                                                                                                                60
                                                                                                                                *
                                                                                                                                1000);
                                                                                                                                filteredLogs
                                                                                                                                =
                                                                                                                                logs.filter(l
                                                                                                                                =>
                                                                                                                                new
                                                                                                                                Date(l.date)
                                                                                                                                >=
                                                                                                                                weekAgo);
                                                                                                                                }
                                                                                                                                else
                                                                                                                                if
                                                                                                                                (period
                                                                                                                                ===
                                                                                                                                'month')
                                                                                                                                {
                                                                                                                                const
                                                                                                                                monthAgo
                                                                                                                                =
                                                                                                                                new
                                                                                                                                Date(now.getFullYear(),
                                                                                                                                now.getMonth()
                                                                                                                                -
                                                                                                                                1,
                                                                                                                                now.getDate());
                                                                                                                                filteredLogs
                                                                                                                                =
                                                                                                                                logs.filter(l
                                                                                                                                =>
                                                                                                                                new
                                                                                                                                Date(l.date)
                                                                                                                                >=
                                                                                                                                monthAgo);
                                                                                                                                }

                                                                                                                                const
                                                                                                                                totalRevenue
                                                                                                                                =
                                                                                                                                filteredLogs.reduce((sum,
                                                                                                                                log)
                                                                                                                                =>
                                                                                                                                sum
                                                                                                                                +
                                                                                                                                (log.revenue
                                                                                                                                ||
                                                                                                                                0),
                                                                                                                                0);
                                                                                                                                const
                                                                                                                                totalTips
                                                                                                                                =
                                                                                                                                filteredLogs.reduce((sum,
                                                                                                                                log)
                                                                                                                                =>
                                                                                                                                sum
                                                                                                                                +
                                                                                                                                (log.tip
                                                                                                                                ||
                                                                                                                                0),
                                                                                                                                0);
                                                                                                                                const
                                                                                                                                totalCost
                                                                                                                                =
                                                                                                                                filteredLogs.reduce((sum,
                                                                                                                                log)
                                                                                                                                =>
                                                                                                                                sum
                                                                                                                                +
                                                                                                                                (log.cost
                                                                                                                                ||
                                                                                                                                0),
                                                                                                                                0);
                                                                                                                                const
                                                                                                                                totalMiles
                                                                                                                                =
                                                                                                                                filteredLogs.reduce((sum,
                                                                                                                                log)
                                                                                                                                =>
                                                                                                                                sum
                                                                                                                                +
                                                                                                                                (log.miles
                                                                                                                                ||
                                                                                                                                0),
                                                                                                                                0);
                                                                                                                                const
                                                                                                                                totalMinutes
                                                                                                                                =
                                                                                                                                filteredLogs.reduce((sum,
                                                                                                                                log)
                                                                                                                                =>
                                                                                                                                sum
                                                                                                                                +
                                                                                                                                (log.minutes
                                                                                                                                ||
                                                                                                                                0),
                                                                                                                                0);

                                                                                                                                const
                                                                                                                                MILEAGE_RATE
                                                                                                                                =
                                                                                                                                0.67;
                                                                                                                                const
                                                                                                                                mileageCost
                                                                                                                                =
                                                                                                                                totalMiles
                                                                                                                                *
                                                                                                                                MILEAGE_RATE;
                                                                                                                                const
                                                                                                                                gross
                                                                                                                                =
                                                                                                                                totalRevenue
                                                                                                                                +
                                                                                                                                totalTips;
                                                                                                                                const
                                                                                                                                ebitda
                                                                                                                                =
                                                                                                                                gross
                                                                                                                                -
                                                                                                                                (totalCost
                                                                                                                                +
                                                                                                                                mileageCost);
                                                                                                                                const
                                                                                                                                taxEstimate
                                                                                                                                =
                                                                                                                                Math.max(0,
                                                                                                                                ebitda
                                                                                                                                *
                                                                                                                                0.30);

                                                                                                                                const
                                                                                                                                keys
                                                                                                                                =
                                                                                                                                InventoryManager.getKeysInventory();
                                                                                                                                const
                                                                                                                                blanks
                                                                                                                                =
                                                                                                                                InventoryManager.getBlanksInventory();
                                                                                                                                const
                                                                                                                                lowStock
                                                                                                                                =
                                                                                                                                [];

                                                                                                                                Object.entries(keys).forEach(([key,
                                                                                                                                item])
                                                                                                                                =>
                                                                                                                                {
                                                                                                                                if
                                                                                                                                (item.qty
                                                                                                                                <= 2)
                                                                                                                                    lowStock.push({
                                                                                                                                    name:
                                                                                                                                    key,
                                                                                                                                    type: 'key'
                                                                                                                                    ,
                                                                                                                                    qty:
                                                                                                                                    item.qty
                                                                                                                                    });
                                                                                                                                    });
                                                                                                                                    Object.entries(blanks).forEach(([key,
                                                                                                                                    item])=>
                                                                                                                                    {
                                                                                                                                    if
                                                                                                                                    (item.qty
                                                                                                                                    <= 3)
                                                                                                                                        lowStock.push({
                                                                                                                                        name:
                                                                                                                                        key,
                                                                                                                                        type: 'blank'
                                                                                                                                        ,
                                                                                                                                        qty:
                                                                                                                                        item.qty
                                                                                                                                        });
                                                                                                                                        });
                                                                                                                                        return
                                                                                                                                        {
                                                                                                                                        gross,
                                                                                                                                        ebitda,
                                                                                                                                        totalJobs:
                                                                                                                                        filteredLogs.length,
                                                                                                                                        totalRevenue,
                                                                                                                                        totalTips,
                                                                                                                                        totalCost,
                                                                                                                                        mileageCost,
                                                                                                                                        taxEstimate,
                                                                                                                                        totalHours:
                                                                                                                                        totalMinutes
                                                                                                                                        /
                                                                                                                                        60,
                                                                                                                                        hourlyRate:
                                                                                                                                        (totalMinutes>
                                                                                                                                        0)
                                                                                                                                        ?
                                                                                                                                        (ebitda
                                                                                                                                        /
                                                                                                                                        (totalMinutes
                                                                                                                                        /
                                                                                                                                        60))
                                                                                                                                        :
                                                                                                                                        0,
                                                                                                                                        lowStock
                                                                                                                                        };
                                                                                                                                        }

                                                                                                                                        //
                                                                                                                                        Render
                                                                                                                                        full
                                                                                                                                        inventory
                                                                                                                                        page
                                                                                                                                        function
                                                                                                                                        renderInventoryPage(view
                                                                                                                                        =
                                                                                                                                        'inventory')
                                                                                                                                        {
                                                                                                                                        const
                                                                                                                                        container
                                                                                                                                        =
                                                                                                                                        document.getElementById('inventoryContent');
                                                                                                                                        if
                                                                                                                                        (!container)
                                                                                                                                        return;

                                                                                                                                        //
                                                                                                                                        Show
                                                                                                                                        sign-in
                                                                                                                                        prompt
                                                                                                                                        for
                                                                                                                                        anonymous
                                                                                                                                        users
                                                                                                                                        if
                                                                                                                                        (!currentUser)
                                                                                                                                        {
                                                                                                                                        container.innerHTML
                                                                                                                                        =
                                                                                                                                        `
                                                                                                                                        <div
                                                                                                                                            style="text-align: center; padding: 60px 20px;">
                                                                                                                                            <div
                                                                                                                                                style="font-size: 4rem; margin-bottom: 20px;">
                                                                                                                                                ðŸ“¦
                                                                                                                                            </div>
                                                                                                                                            <h2
                                                                                                                                                style="color: var(--brand-primary); margin-bottom: 12px;">
                                                                                                                                                My
                                                                                                                                                Inventory
                                                                                                                                            </h2>
                                                                                                                                            <p
                                                                                                                                                style="color: var(--text-secondary); margin-bottom: 24px; max-width: 400px; margin-left: auto; margin-right: auto;">
                                                                                                                                                Track
                                                                                                                                                your
                                                                                                                                                key
                                                                                                                                                stock,
                                                                                                                                                log
                                                                                                                                                jobs,
                                                                                                                                                and
                                                                                                                                                sync
                                                                                                                                                across
                                                                                                                                                devices.
                                                                                                                                                Sign
                                                                                                                                                in
                                                                                                                                                to
                                                                                                                                                access
                                                                                                                                                your
                                                                                                                                                personal
                                                                                                                                                inventory.
                                                                                                                                            </p>
                                                                                                                                            <button
                                                                                                                                                onclick="signInWithGoogle()"
                                                                                                                                                style="
                            background: linear-gradient(135deg, #fbbf24, #f59e0b);
                            color: #000;
                            border: none;
                            padding: 14px 32px;
                            border-radius: 30px;
                            font-size: 1rem;
                            font-weight: 700;
                            cursor: pointer;
                            display: inline-flex;
                            align-items: center;
                            gap: 10px;
                            box-shadow: 0 4px 15px rgba(251, 191, 36, 0.3);
                        ">
                                                                                                                                                <svg width="20"
                                                                                                                                                    height="20"
                                                                                                                                                    viewBox="0 0 24 24">
                                                                                                                                                    <path
                                                                                                                                                        fill="currentColor"
                                                                                                                                                        d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" />
                                                                                                                                                    <path
                                                                                                                                                        fill="currentColor"
                                                                                                                                                        d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" />
                                                                                                                                                    <path
                                                                                                                                                        fill="currentColor"
                                                                                                                                                        d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" />
                                                                                                                                                    <path
                                                                                                                                                        fill="currentColor"
                                                                                                                                                        d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" />
                                                                                                                                                </svg>
                                                                                                                                                Sign
                                                                                                                                                in
                                                                                                                                                with
                                                                                                                                                Google
                                                                                                                                            </button>
                                                                                                                                            <div
                                                                                                                                                style="margin-top: 30px; padding: 20px; background: var(--bg-secondary); border-radius: 12px; max-width: 500px; margin-left: auto; margin-right: auto;">
                                                                                                                                                <h4
                                                                                                                                                    style="color: var(--text-primary); margin-bottom: 12px;">
                                                                                                                                                    âœ¨
                                                                                                                                                    Features
                                                                                                                                                    include:
                                                                                                                                                </h4>
                                                                                                                                                <div
                                                                                                                                                    style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; text-align: left; color: var(--text-secondary); font-size: 0.9rem;">
                                                                                                                                                    <div>
                                                                                                                                                        ðŸ“Š
                                                                                                                                                        Stock
                                                                                                                                                        tracking
                                                                                                                                                    </div>
                                                                                                                                                    <div>
                                                                                                                                                        ðŸ“‹
                                                                                                                                                        Job
                                                                                                                                                        logs
                                                                                                                                                    </div>
                                                                                                                                                    <div>
                                                                                                                                                        ðŸ—ºï¸
                                                                                                                                                        Coverage
                                                                                                                                                        map
                                                                                                                                                    </div>
                                                                                                                                                    <div>
                                                                                                                                                        â˜ï¸
                                                                                                                                                        Cloud
                                                                                                                                                        sync
                                                                                                                                                    </div>
                                                                                                                                                </div>
                                                                                                                                            </div>
                                                                                                                                        </div>
                                                                                                                                        `;
                                                                                                                                        return;
                                                                                                                                        }


                                                                                                                                        //
                                                                                                                                        Sync
                                                                                                                                        status
                                                                                                                                        for
                                                                                                                                        display
                                                                                                                                        const
                                                                                                                                        syncStatus
                                                                                                                                        =
                                                                                                                                        InventoryManager.getSyncStatus();
                                                                                                                                        const
                                                                                                                                        syncColor
                                                                                                                                        =
                                                                                                                                        syncStatus.status
                                                                                                                                        ===
                                                                                                                                        'error'
                                                                                                                                        ?
                                                                                                                                        '#f87171'
                                                                                                                                        :
                                                                                                                                        syncStatus.status
                                                                                                                                        ===
                                                                                                                                        'ok'
                                                                                                                                        ?
                                                                                                                                        '#4ade80'
                                                                                                                                        :
                                                                                                                                        '#94a3b8';
                                                                                                                                        const
                                                                                                                                        syncIcon
                                                                                                                                        =
                                                                                                                                        syncStatus.status
                                                                                                                                        ===
                                                                                                                                        'error'
                                                                                                                                        ?
                                                                                                                                        'âš ï¸'
                                                                                                                                        :
                                                                                                                                        syncStatus.status
                                                                                                                                        ===
                                                                                                                                        'ok'
                                                                                                                                        ?
                                                                                                                                        'â˜ï¸'
                                                                                                                                        :
                                                                                                                                        'ðŸ”„';

                                                                                                                                        //
                                                                                                                                        Toggle
                                                                                                                                        Header
                                                                                                                                        with
                                                                                                                                        user
                                                                                                                                        info
                                                                                                                                        bar
                                                                                                                                        const
                                                                                                                                        headerHtml
                                                                                                                                        =
                                                                                                                                        `
                                                                                                                                        <!-- User Info & Sync Status Bar -->
                                                                                                                                        <div
                                                                                                                                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding: 12px 16px; background: var(--bg-tertiary); border-radius: 12px; font-size: 0.85rem;">
                                                                                                                                            <div
                                                                                                                                                style="display: flex; align-items: center; gap: 12px;">
                                                                                                                                                ${currentUser.picture
                                                                                                                                                ?
                                                                                                                                                `<img
                                                                                                                                                    src="${currentUser.picture}"
                                                                                                                                                    style="width: 28px; height: 28px; border-radius: 50%;"
                                                                                                                                                    alt="Profile">`
                                                                                                                                                :
                                                                                                                                                ''}
                                                                                                                                                <div>
                                                                                                                                                    <div
                                                                                                                                                        style="color: var(--text-primary); font-weight: 600;">
                                                                                                                                                        ${currentUser.name
                                                                                                                                                        ||
                                                                                                                                                        'User'}
                                                                                                                                                    </div>
                                                                                                                                                    <div
                                                                                                                                                        style="color: var(--text-muted); font-size: 0.75rem;">
                                                                                                                                                        ${currentUser.email
                                                                                                                                                        ||
                                                                                                                                                        ''}
                                                                                                                                                    </div>
                                                                                                                                                </div>
                                                                                                                                            </div>
                                                                                                                                            <div
                                                                                                                                                style="display: flex; align-items: center; gap: 16px;">
                                                                                                                                                <div
                                                                                                                                                    style="display: flex; align-items: center; gap: 6px; color: ${syncColor};">
                                                                                                                                                    <span>${syncIcon}</span>
                                                                                                                                                    <span>${syncStatus.message}</span>
                                                                                                                                                </div>
                                                                                                                                                <button
                                                                                                                                                    onclick="InventoryManager.clearAndResync()"
                                                                                                                                                    style="
                                padding: 6px 12px; 
                                border-radius: 6px; 
                                border: 1px solid rgba(239, 68, 68, 0.3); 
                                background: rgba(239, 68, 68, 0.1); 
                                color: #f87171; 
                                font-weight: 500; 
                                cursor: pointer;
                                font-size: 0.8rem;
                            " title="Clear local data and reload from cloud">ðŸ”„ Clear & Resync</button>
                                                                                                                                            </div>
                                                                                                                                        </div>
                                                                                                                                        <!-- Tab Navigation -->
                                                                                                                                        <div
                                                                                                                                            style="display: flex; gap: 12px; margin-bottom: 24px; padding-bottom: 16px; border-bottom: 1px solid var(--border); flex-wrap: wrap;">
                                                                                                                                            <button
                                                                                                                                                onclick="renderInventoryPage('inventory')"
                                                                                                                                                style="
                            padding: 8px 16px; 
                            border-radius: 20px; 
                            border: none; 
                            background: ${view === 'inventory' ? 'var(--brand-primary)' : 'var(--bg-tertiary)'}; 
                            color: ${view === 'inventory' ? '#000' : 'var(--text-primary)'}; 
                            font-weight: 600; 
                            cursor: pointer;
                        ">ðŸ“¦ Current Stock</button>
                                                                                                                                            <button
                                                                                                                                                onclick="renderInventoryPage('logs')"
                                                                                                                                                style="
                            padding: 8px 16px; 
                            border-radius: 20px; 
                            border: none; 
                            background: ${view === 'logs' ? 'var(--brand-primary)' : 'var(--bg-tertiary)'}; 
                            color: ${view === 'logs' ? '#000' : 'var(--text-primary)'}; 
                            font-weight: 600; 
                            cursor: pointer;
                        ">ðŸ“‹ Job Logs</button>
                                                                                                                                            <button
                                                                                                                                                onclick="renderInventoryPage('stats')"
                                                                                                                                                style="
                            padding: 8px 16px; 
                            border-radius: 20px; 
                            border: none; 
                            background: ${view === 'stats' ? 'var(--brand-primary)' : 'var(--bg-tertiary)'}; 
                            color: ${view === 'stats' ? '#000' : 'var(--text-primary)'}; 
                            font-weight: 600; 
                            cursor: pointer;
                        ">ðŸ“Š Statistics</button>
                                                                                                                                            <button
                                                                                                                                                onclick="renderInventoryPage('coverage')"
                                                                                                                                                style="
                            padding: 8px 16px; 
                            border-radius: 20px; 
                            border: none; 
                            background: ${view === 'coverage' ? 'var(--brand-primary)' : 'var(--bg-tertiary)'}; 
                            color: ${view === 'coverage' ? '#000' : 'var(--text-primary)'}; 
                            font-weight: 600; 
                            cursor: pointer;
                        ">ðŸ—ºï¸ Coverage Map</button>
                                                                                                                                            <button
                                                                                                                                                onclick="DataPortability.exportAll()"
                                                                                                                                                style="padding: 8px 16px; border-radius: 20px; border: 1px dashed var(--border); background: transparent; color: var(--text-secondary); font-weight: 500; cursor: pointer; margin-left: 10px;"
                                                                                                                                                title="Download all your data">ðŸ“¥
                                                                                                                                                Export</button>
                                                                                                                                            <label
                                                                                                                                                style="padding: 8px 16px; border-radius: 20px; border: 1px dashed var(--border); background: transparent; color: var(--text-secondary); font-weight: 500; cursor: pointer;"
                                                                                                                                                title="Restore from backup">ðŸ“¤
                                                                                                                                                Import<input
                                                                                                                                                    type="file"
                                                                                                                                                    accept=".json"
                                                                                                                                                    style="display:none"
                                                                                                                                                    onchange="DataPortability.importFromFile(this.files[0]).then(() => renderInventoryPage()).catch(e => alert('Import failed: ' + e.message))"></label>
                                                                                                                                        </div>
                                                                                                                                        `;

                                                                                                                                        if
                                                                                                                                        (view
                                                                                                                                        ===
                                                                                                                                        'logs')
                                                                                                                                        {
                                                                                                                                        renderJobLogsPage(container,
                                                                                                                                        headerHtml);
                                                                                                                                        return;
                                                                                                                                        }

                                                                                                                                        if
                                                                                                                                        (view
                                                                                                                                        ===
                                                                                                                                        'stats')
                                                                                                                                        {
                                                                                                                                        renderBusinessDashboard(container,
                                                                                                                                        headerHtml);
                                                                                                                                        return;
                                                                                                                                        }

                                                                                                                                        if
                                                                                                                                        (view
                                                                                                                                        ===
                                                                                                                                        'coverage')
                                                                                                                                        {
                                                                                                                                        renderToolCoveragePage(container,
                                                                                                                                        headerHtml);
                                                                                                                                        return;
                                                                                                                                        }

                                                                                                                                        const
                                                                                                                                        keys
                                                                                                                                        =
                                                                                                                                        InventoryManager.getAllKeys();
                                                                                                                                        const
                                                                                                                                        blanks
                                                                                                                                        =
                                                                                                                                        InventoryManager.getAllBlanks();

                                                                                                                                        //
                                                                                                                                        Debug
                                                                                                                                        logging
                                                                                                                                        -
                                                                                                                                        remove
                                                                                                                                        after
                                                                                                                                        fixing
                                                                                                                                        console.log('ðŸ”§
                                                                                                                                        Inventory
                                                                                                                                        Debug:',
                                                                                                                                        {
                                                                                                                                        keys,
                                                                                                                                        blanks,
                                                                                                                                        totalKeys:
                                                                                                                                        InventoryManager.getTotalKeys(),
                                                                                                                                        totalBlanks:
                                                                                                                                        InventoryManager.getTotalBlanks()
                                                                                                                                        });

                                                                                                                                        //
                                                                                                                                        Filter
                                                                                                                                        items
                                                                                                                                        with
                                                                                                                                        qty
                                                                                                                                        >
                                                                                                                                        0
                                                                                                                                        OR
                                                                                                                                        used
                                                                                                                                        >
                                                                                                                                        0
                                                                                                                                        (show
                                                                                                                                        items
                                                                                                                                        with
                                                                                                                                        history)
                                                                                                                                        const
                                                                                                                                        keyEntries
                                                                                                                                        =
                                                                                                                                        Object.entries(keys).filter(([k,
                                                                                                                                        item])
                                                                                                                                        =>
                                                                                                                                        (item?.qty
                                                                                                                                        ||
                                                                                                                                        0)
                                                                                                                                        >
                                                                                                                                        0);
                                                                                                                                        const
                                                                                                                                        blankEntries
                                                                                                                                        =
                                                                                                                                        Object.entries(blanks).filter(([k,
                                                                                                                                        item])
                                                                                                                                        =>
                                                                                                                                        (item?.qty
                                                                                                                                        ||
                                                                                                                                        0)
                                                                                                                                        >
                                                                                                                                        0);

                                                                                                                                        //
                                                                                                                                        Get
                                                                                                                                        items
                                                                                                                                        that
                                                                                                                                        have
                                                                                                                                        been
                                                                                                                                        fully
                                                                                                                                        used
                                                                                                                                        (qty
                                                                                                                                        =
                                                                                                                                        0
                                                                                                                                        but
                                                                                                                                        used
                                                                                                                                        >
                                                                                                                                        0)
                                                                                                                                        const
                                                                                                                                        usedKeyEntries
                                                                                                                                        =
                                                                                                                                        Object.entries(keys).filter(([k,
                                                                                                                                        item])
                                                                                                                                        =>
                                                                                                                                        (item?.qty
                                                                                                                                        ||
                                                                                                                                        0)
                                                                                                                                        ===
                                                                                                                                        0
                                                                                                                                        &&
                                                                                                                                        (item?.used
                                                                                                                                        ||
                                                                                                                                        0)
                                                                                                                                        >
                                                                                                                                        0);
                                                                                                                                        const
                                                                                                                                        usedBlankEntries
                                                                                                                                        =
                                                                                                                                        Object.entries(blanks).filter(([k,
                                                                                                                                        item])
                                                                                                                                        =>
                                                                                                                                        (item?.qty
                                                                                                                                        ||
                                                                                                                                        0)
                                                                                                                                        ===
                                                                                                                                        0
                                                                                                                                        &&
                                                                                                                                        (item?.used
                                                                                                                                        ||
                                                                                                                                        0)
                                                                                                                                        >
                                                                                                                                        0);

                                                                                                                                        const
                                                                                                                                        totalUsedKeys
                                                                                                                                        =
                                                                                                                                        InventoryManager.getTotalUsedKeys();
                                                                                                                                        const
                                                                                                                                        totalUsedBlanks
                                                                                                                                        =
                                                                                                                                        InventoryManager.getTotalUsedBlanks();

                                                                                                                                        if
                                                                                                                                        (keyEntries.length
                                                                                                                                        ===
                                                                                                                                        0
                                                                                                                                        &&
                                                                                                                                        blankEntries.length
                                                                                                                                        ===
                                                                                                                                        0
                                                                                                                                        &&
                                                                                                                                        usedKeyEntries.length
                                                                                                                                        ===
                                                                                                                                        0
                                                                                                                                        &&
                                                                                                                                        usedBlankEntries.length
                                                                                                                                        ===
                                                                                                                                        0)
                                                                                                                                        {
                                                                                                                                        container.innerHTML
                                                                                                                                        =
                                                                                                                                        `
                                                                                                                                        <div
                                                                                                                                            style="text-align: center; padding: 60px 20px; color: var(--text-muted);">
                                                                                                                                            <div
                                                                                                                                                style="font-size: 4rem; margin-bottom: 16px;">
                                                                                                                                                ðŸ“¦
                                                                                                                                            </div>
                                                                                                                                            <h3
                                                                                                                                                style="color: var(--text-primary); margin-bottom: 8px;">
                                                                                                                                                Your
                                                                                                                                                inventory
                                                                                                                                                is
                                                                                                                                                empty
                                                                                                                                            </h3>
                                                                                                                                            <p>Browse
                                                                                                                                                vehicles
                                                                                                                                                and
                                                                                                                                                add
                                                                                                                                                keys
                                                                                                                                                to
                                                                                                                                                your
                                                                                                                                                inventory
                                                                                                                                                to
                                                                                                                                                track
                                                                                                                                                stock.
                                                                                                                                            </p>
                                                                                                                                        </div>
                                                                                                                                        `;
                                                                                                                                        return;
                                                                                                                                        }

                                                                                                                                        let
                                                                                                                                        html
                                                                                                                                        =
                                                                                                                                        headerHtml
                                                                                                                                        +
                                                                                                                                        '
                                                                                                                                        <div
                                                                                                                                            style="display: grid; gap: 24px;">
                                                                                                                                            ';

                                                                                                                                            //
                                                                                                                                            AI
                                                                                                                                            Insight
                                                                                                                                            Card
                                                                                                                                            (Dynamic)
                                                                                                                                            const
                                                                                                                                            insightContainerId
                                                                                                                                            =
                                                                                                                                            'ai-insight-'
                                                                                                                                            +
                                                                                                                                            Math.random().toString(36).substr(2,
                                                                                                                                            9);
                                                                                                                                            html
                                                                                                                                            +=
                                                                                                                                            `
                                                                                                                                            <div id="${insightContainerId}"
                                                                                                                                                style="display: none; padding: 20px; background: linear-gradient(135deg, #1e1e1e 0%, #252525 100%); border: 1px solid #333; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                                                                                                                                                <div
                                                                                                                                                    style="display: flex; align-items: start; gap: 16px;">
                                                                                                                                                    <div
                                                                                                                                                        style="font-size: 2rem; background: rgba(59, 130, 246, 0.1); width: 48px; height: 48px; display: flex; align-items: center; justify-content: center; border-radius: 50%;">
                                                                                                                                                        ðŸ’¡
                                                                                                                                                    </div>
                                                                                                                                                    <div
                                                                                                                                                        style="flex: 1;">
                                                                                                                                                        <div
                                                                                                                                                            style="font-weight: 700; color: #60a5fa; margin-bottom: 4px; text-transform: uppercase; font-size: 0.8rem; letter-spacing: 1px;">
                                                                                                                                                            AI
                                                                                                                                                            Analyst
                                                                                                                                                            Tip
                                                                                                                                                        </div>
                                                                                                                                                        <div class="insight-content"
                                                                                                                                                            style="color: #e5e5e5; line-height: 1.5; font-size: 0.95rem;">
                                                                                                                                                            Loading
                                                                                                                                                            insight...
                                                                                                                                                        </div>
                                                                                                                                                        <div class="insight-products"
                                                                                                                                                            style="display: flex; gap: 8px; margin-top: 12px; flex-wrap: wrap;">
                                                                                                                                                        </div>
                                                                                                                                                    </div>
                                                                                                                                                </div>
                                                                                                                                            </div>
                                                                                                                                            `;

                                                                                                                                            //
                                                                                                                                            Fetch
                                                                                                                                            insight
                                                                                                                                            asynchronously
                                                                                                                                            setTimeout(async
                                                                                                                                            ()
                                                                                                                                            =>
                                                                                                                                            {
                                                                                                                                            const
                                                                                                                                            card
                                                                                                                                            =
                                                                                                                                            document.getElementById(insightContainerId);
                                                                                                                                            if
                                                                                                                                            (!card
                                                                                                                                            ||
                                                                                                                                            window.isAuthExpired)
                                                                                                                                            return;
                                                                                                                                            try
                                                                                                                                            {
                                                                                                                                            const
                                                                                                                                            res
                                                                                                                                            =
                                                                                                                                            await
                                                                                                                                            fetch(`${API}/api/insights`);
                                                                                                                                            const
                                                                                                                                            data
                                                                                                                                            =
                                                                                                                                            await
                                                                                                                                            res.json();
                                                                                                                                            if
                                                                                                                                            (data.insight
                                                                                                                                            &&
                                                                                                                                            data.insight.content)
                                                                                                                                            {
                                                                                                                                            card.style.display
                                                                                                                                            =
                                                                                                                                            'block';
                                                                                                                                            card.querySelector('.insight-content').textContent
                                                                                                                                            =
                                                                                                                                            data.insight.content;

                                                                                                                                            //
                                                                                                                                            Render
                                                                                                                                            recommendations
                                                                                                                                            if
                                                                                                                                            any
                                                                                                                                            if
                                                                                                                                            (data.insight.recommendations)
                                                                                                                                            {
                                                                                                                                            const
                                                                                                                                            products
                                                                                                                                            =
                                                                                                                                            JSON.parse(data.insight.recommendations);
                                                                                                                                            const
                                                                                                                                            prodContainer
                                                                                                                                            =
                                                                                                                                            card.querySelector('.insight-products');
                                                                                                                                            products.forEach(prod
                                                                                                                                            =>
                                                                                                                                            {
                                                                                                                                            const
                                                                                                                                            btn
                                                                                                                                            =
                                                                                                                                            document.createElement('a');
                                                                                                                                            btn.href
                                                                                                                                            =
                                                                                                                                            `https://www.amazon.com/s?k=${encodeURIComponent(prod)}&tag=jeremysamuels-20`;
                                                                                                                                            btn.target
                                                                                                                                            =
                                                                                                                                            '_blank';
                                                                                                                                            btn.style.cssText
                                                                                                                                            =
                                                                                                                                            'padding:
                                                                                                                                            6px
                                                                                                                                            12px;
                                                                                                                                            background:
                                                                                                                                            #333;
                                                                                                                                            color:
                                                                                                                                            #fff;
                                                                                                                                            text-decoration:
                                                                                                                                            none;
                                                                                                                                            border-radius:
                                                                                                                                            20px;
                                                                                                                                            font-size:
                                                                                                                                            0.8rem;
                                                                                                                                            display:
                                                                                                                                            flex;
                                                                                                                                            align-items:
                                                                                                                                            center;
                                                                                                                                            gap:
                                                                                                                                            6px;
                                                                                                                                            border:
                                                                                                                                            1px
                                                                                                                                            solid
                                                                                                                                            #444;
                                                                                                                                            transition:
                                                                                                                                            all
                                                                                                                                            0.2s
                                                                                                                                            ease;';
                                                                                                                                            btn.innerHTML
                                                                                                                                            =
                                                                                                                                            `<span>ðŸ›’</span>
                                                                                                                                            ${prod}`;
                                                                                                                                            btn.onmouseover
                                                                                                                                            =
                                                                                                                                            ()
                                                                                                                                            =>
                                                                                                                                            {
                                                                                                                                            btn.style.background
                                                                                                                                            =
                                                                                                                                            '#444';
                                                                                                                                            btn.style.borderColor
                                                                                                                                            =
                                                                                                                                            '#666';
                                                                                                                                            };
                                                                                                                                            btn.onmouseout
                                                                                                                                            =
                                                                                                                                            ()
                                                                                                                                            =>
                                                                                                                                            {
                                                                                                                                            btn.style.background
                                                                                                                                            =
                                                                                                                                            '#333';
                                                                                                                                            btn.style.borderColor
                                                                                                                                            =
                                                                                                                                            '#444';
                                                                                                                                            };
                                                                                                                                            prodContainer.appendChild(btn);
                                                                                                                                            });
                                                                                                                                            }
                                                                                                                                            }
                                                                                                                                            }
                                                                                                                                            catch
                                                                                                                                            (e)
                                                                                                                                            {
                                                                                                                                            console.warn('Failed
                                                                                                                                            to
                                                                                                                                            load
                                                                                                                                            AI
                                                                                                                                            insight',
                                                                                                                                            e);
                                                                                                                                            }
                                                                                                                                            },
                                                                                                                                            100);

                                                                                                                                            //
                                                                                                                                            Stats
                                                                                                                                            summary
                                                                                                                                            const
                                                                                                                                            totalInStock
                                                                                                                                            =
                                                                                                                                            keyEntries.reduce((s,
                                                                                                                                            [k,
                                                                                                                                            item])
                                                                                                                                            =>
                                                                                                                                            s
                                                                                                                                            +
                                                                                                                                            (item?.qty
                                                                                                                                            ||
                                                                                                                                            0),
                                                                                                                                            0)
                                                                                                                                            +
                                                                                                                                            blankEntries.reduce((s,
                                                                                                                                            [k,
                                                                                                                                            item])
                                                                                                                                            =>
                                                                                                                                            s
                                                                                                                                            +
                                                                                                                                            (item?.qty
                                                                                                                                            ||
                                                                                                                                            0),
                                                                                                                                            0);
                                                                                                                                            html
                                                                                                                                            +=
                                                                                                                                            `
                                                                                                                                            <div
                                                                                                                                                style="display: flex; gap: 16px; flex-wrap: wrap;">
                                                                                                                                                <div
                                                                                                                                                    style="padding: 16px 24px; background: var(--bg-tertiary); border-radius: 8px; text-align: center; flex: 1; min-width: 120px;">
                                                                                                                                                    <div
                                                                                                                                                        style="font-size: 1.5rem; font-weight: 700; color: var(--brand-primary);">
                                                                                                                                                        ${totalInStock}
                                                                                                                                                    </div>
                                                                                                                                                    <div
                                                                                                                                                        style="font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px;">
                                                                                                                                                        In
                                                                                                                                                        Stock
                                                                                                                                                    </div>
                                                                                                                                                </div>
                                                                                                                                                <div
                                                                                                                                                    style="padding: 16px 24px; background: var(--bg-tertiary); border-radius: 8px; text-align: center; flex: 1; min-width: 120px;">
                                                                                                                                                    <div
                                                                                                                                                        style="font-size: 1.5rem; font-weight: 700; color: #22c55e;">
                                                                                                                                                        ${totalUsedKeys
                                                                                                                                                        +
                                                                                                                                                        totalUsedBlanks}
                                                                                                                                                    </div>
                                                                                                                                                    <div
                                                                                                                                                        style="font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px;">
                                                                                                                                                        Used
                                                                                                                                                    </div>
                                                                                                                                                </div>
                                                                                                                                            </div>
                                                                                                                                            `;

                                                                                                                                            //
                                                                                                                                            Keys
                                                                                                                                            in
                                                                                                                                            stock
                                                                                                                                            section
                                                                                                                                            if
                                                                                                                                            (keyEntries.length
                                                                                                                                            >
                                                                                                                                            0)
                                                                                                                                            {
                                                                                                                                            const
                                                                                                                                            totalKeys
                                                                                                                                            =
                                                                                                                                            keyEntries.reduce((s,
                                                                                                                                            [k,
                                                                                                                                            item])
                                                                                                                                            =>
                                                                                                                                            s
                                                                                                                                            +
                                                                                                                                            (item?.qty
                                                                                                                                            ||
                                                                                                                                            0),
                                                                                                                                            0);
                                                                                                                                            html
                                                                                                                                            +=
                                                                                                                                            `
                                                                                                                                            <div>
                                                                                                                                                <h3
                                                                                                                                                    style="color: var(--brand-primary); margin-bottom: 12px;">
                                                                                                                                                    ðŸ”
                                                                                                                                                    Key
                                                                                                                                                    Fobs
                                                                                                                                                    &
                                                                                                                                                    Remotes
                                                                                                                                                    (${totalKeys}
                                                                                                                                                    in
                                                                                                                                                    stock)
                                                                                                                                                </h3>
                                                                                                                                                <div
                                                                                                                                                    style="display: grid; gap: 8px;">
                                                                                                                                                    `;
                                                                                                                                                    keyEntries.forEach(([key,
                                                                                                                                                    item])
                                                                                                                                                    =>
                                                                                                                                                    {
                                                                                                                                                    const
                                                                                                                                                    qty
                                                                                                                                                    =
                                                                                                                                                    item?.qty
                                                                                                                                                    ||
                                                                                                                                                    0;
                                                                                                                                                    const
                                                                                                                                                    used
                                                                                                                                                    =
                                                                                                                                                    item?.used
                                                                                                                                                    ||
                                                                                                                                                    0;
                                                                                                                                                    const
                                                                                                                                                    vehicle
                                                                                                                                                    =
                                                                                                                                                    item?.vehicle
                                                                                                                                                    ||
                                                                                                                                                    null;
                                                                                                                                                    const
                                                                                                                                                    amazonLink
                                                                                                                                                    =
                                                                                                                                                    item?.amazonLink
                                                                                                                                                    ||
                                                                                                                                                    null;
                                                                                                                                                    const
                                                                                                                                                    escapedKey
                                                                                                                                                    =
                                                                                                                                                    key.replace(/'/g,
                                                                                                                                                    "\\\\'");

                                                                                                                                                    html
                                                                                                                                                    +=
                                                                                                                                                    `
                                                                                                                                                    <div
                                                                                                                                                        style="display: flex; align-items: center; justify-content: space-between; padding: 12px; background: var(--bg-tertiary); border-radius: 8px; flex-wrap: wrap; gap: 8px;">
                                                                                                                                                        <div
                                                                                                                                                            style="display: flex; flex-direction: column; gap: 4px; min-width: 200px;">
                                                                                                                                                            <span
                                                                                                                                                                style="font-weight: 600; color: var(--text-primary);">${key}</span>
                                                                                                                                                            ${vehicle
                                                                                                                                                            ?
                                                                                                                                                            `
                                                                                                                                                            <div
                                                                                                                                                                style="margin-top: 4px; display: flex; flex-wrap: wrap; gap: 4px;">
                                                                                                                                                                ${renderVehicleChips(vehicle,
                                                                                                                                                                null,
                                                                                                                                                                10)}
                                                                                                                                                            </div>
                                                                                                                                                            `
                                                                                                                                                            :
                                                                                                                                                            ''}
                                                                                                                                                        </div>
                                                                                                                                                        <div
                                                                                                                                                            style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
                                                                                                                                                            <span
                                                                                                                                                                class="inventory-badge in-stock">ðŸ“¦
                                                                                                                                                                ${qty}</span>
                                                                                                                                                            ${used
                                                                                                                                                            >
                                                                                                                                                            0
                                                                                                                                                            ?
                                                                                                                                                            `<span
                                                                                                                                                                style="padding: 4px 8px; background: rgba(34, 197, 94, 0.2); color: #22c55e; border-radius: 4px; font-size: 0.75rem;">âœ“
                                                                                                                                                                ${used}
                                                                                                                                                                used</span>`
                                                                                                                                                            :
                                                                                                                                                            ''}
                                                                                                                                                            <div
                                                                                                                                                                class="inventory-controls">
                                                                                                                                                                <button
                                                                                                                                                                    class="inventory-btn"
                                                                                                                                                                    onclick="inventoryMinus('${escapedKey}', 'key'); renderInventoryPage();">âˆ’</button>
                                                                                                                                                                <button
                                                                                                                                                                    class="inventory-btn"
                                                                                                                                                                    onclick="inventoryAdd('${escapedKey}', 'key'); renderInventoryPage();">+</button>
                                                                                                                                                            </div>
                                                                                                                                                            <button
                                                                                                                                                                class="btn-log-job"
                                                                                                                                                                onclick="openJobLogModal('${escapedKey}', 'key', '${vehicle ? vehicle.replace(/'/g, "
                                                                                                                                                                \\\\'")
                                                                                                                                                                : ''
                                                                                                                                                                }', '${amazonLink ? amazonLink.replace(/'
                                                                                                                                                                /g, "\\\\'"
                                                                                                                                                                )
                                                                                                                                                                : ''
                                                                                                                                                                }')"
                                                                                                                                                                style="padding: 6px 12px; font-size: 0.8rem;">âœ“
                                                                                                                                                                Log
                                                                                                                                                                Job</button>
                                                                                                                                                            ${amazonLink
                                                                                                                                                            ?
                                                                                                                                                            `<a href="${amazonLink}"
                                                                                                                                                                target="_blank"
                                                                                                                                                                style="padding: 6px 12px; background: linear-gradient(135deg, #ff9900, #ff6600); color: #000; border-radius: 6px; font-size: 0.8rem; font-weight: 600; text-decoration: none;">ðŸ›’
                                                                                                                                                                Buy</a>`
                                                                                                                                                            :
                                                                                                                                                            ''}
                                                                                                                                                            <button
                                                                                                                                                                onclick="openDeleteConfirmModal('${escapedKey}', 'key')"
                                                                                                                                                                style="padding: 6px 10px; background: transparent; border: 1px solid #ef4444; color: #ef4444; border-radius: 6px; font-size: 0.8rem; cursor: pointer;"
                                                                                                                                                                title="Delete from inventory">âœ•</button>
                                                                                                                                                        </div>
                                                                                                                                                    </div>
                                                                                                                                                    `;
                                                                                                                                                    });
                                                                                                                                                    html
                                                                                                                                                    +=
                                                                                                                                                    '
                                                                                                                                                </div>
                                                                                                                                            </div>
                                                                                                                                            ';
                                                                                                                                            }

                                                                                                                                            //
                                                                                                                                            Blanks
                                                                                                                                            in
                                                                                                                                            stock
                                                                                                                                            section
                                                                                                                                            if
                                                                                                                                            (blankEntries.length
                                                                                                                                            >
                                                                                                                                            0)
                                                                                                                                            {
                                                                                                                                            const
                                                                                                                                            totalBlanks
                                                                                                                                            =
                                                                                                                                            blankEntries.reduce((s,
                                                                                                                                            [k,
                                                                                                                                            item])
                                                                                                                                            =>
                                                                                                                                            s
                                                                                                                                            +
                                                                                                                                            (item?.qty
                                                                                                                                            ||
                                                                                                                                            0),
                                                                                                                                            0);
                                                                                                                                            html
                                                                                                                                            +=
                                                                                                                                            `
                                                                                                                                            <div>
                                                                                                                                                <h3
                                                                                                                                                    style="color: var(--brand-primary); margin-bottom: 12px;">
                                                                                                                                                    ðŸ”‘
                                                                                                                                                    Key
                                                                                                                                                    Blanks
                                                                                                                                                    (${totalBlanks}
                                                                                                                                                    in
                                                                                                                                                    stock)
                                                                                                                                                </h3>
                                                                                                                                                <div
                                                                                                                                                    style="display: grid; gap: 8px;">
                                                                                                                                                    `;
                                                                                                                                                    blankEntries.forEach(([keyway,
                                                                                                                                                    item])
                                                                                                                                                    =>
                                                                                                                                                    {
                                                                                                                                                    const
                                                                                                                                                    qty
                                                                                                                                                    =
                                                                                                                                                    item?.qty
                                                                                                                                                    ||
                                                                                                                                                    0;
                                                                                                                                                    const
                                                                                                                                                    used
                                                                                                                                                    =
                                                                                                                                                    item?.used
                                                                                                                                                    ||
                                                                                                                                                    0;
                                                                                                                                                    const
                                                                                                                                                    vehicle
                                                                                                                                                    =
                                                                                                                                                    item?.vehicle
                                                                                                                                                    ||
                                                                                                                                                    null;
                                                                                                                                                    const
                                                                                                                                                    amazonLink
                                                                                                                                                    =
                                                                                                                                                    item?.amazonLink
                                                                                                                                                    ||
                                                                                                                                                    `https://www.amazon.com/s?k=${encodeURIComponent(keyway
                                                                                                                                                    +
                                                                                                                                                    '
                                                                                                                                                    key
                                                                                                                                                    blank')}&tag=eurokeys-20`;
                                                                                                                                                    const
                                                                                                                                                    escapedKey
                                                                                                                                                    =
                                                                                                                                                    keyway.replace(/'/g,
                                                                                                                                                    "\\\\'");

                                                                                                                                                    html
                                                                                                                                                    +=
                                                                                                                                                    `
                                                                                                                                                    <div
                                                                                                                                                        style="display: flex; align-items: center; justify-content: space-between; padding: 12px; background: var(--bg-tertiary); border-radius: 8px; flex-wrap: wrap; gap: 8px;">
                                                                                                                                                        <div
                                                                                                                                                            style="display: flex; flex-direction: column; gap: 4px; min-width: 200px;">
                                                                                                                                                            <span
                                                                                                                                                                style="font-weight: 600; color: var(--text-primary);">${keyway}</span>
                                                                                                                                                            ${vehicle
                                                                                                                                                            ?
                                                                                                                                                            `<span
                                                                                                                                                                style="font-size: 0.75rem; color: var(--text-muted);">ðŸš—
                                                                                                                                                                ${vehicle}</span>`
                                                                                                                                                            :
                                                                                                                                                            ''}
                                                                                                                                                        </div>
                                                                                                                                                        <div
                                                                                                                                                            style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
                                                                                                                                                            <span
                                                                                                                                                                class="inventory-badge in-stock">ðŸ”‘
                                                                                                                                                                ${qty}</span>
                                                                                                                                                            ${used
                                                                                                                                                            >
                                                                                                                                                            0
                                                                                                                                                            ?
                                                                                                                                                            `<span
                                                                                                                                                                style="padding: 4px 8px; background: rgba(34, 197, 94, 0.2); color: #22c55e; border-radius: 4px; font-size: 0.75rem;">âœ“
                                                                                                                                                                ${used}
                                                                                                                                                                used</span>`
                                                                                                                                                            :
                                                                                                                                                            ''}
                                                                                                                                                            <div
                                                                                                                                                                class="inventory-controls">
                                                                                                                                                                <button
                                                                                                                                                                    class="inventory-btn"
                                                                                                                                                                    onclick="inventoryMinus('${escapedKey}', 'blank'); renderInventoryPage();">âˆ’</button>
                                                                                                                                                                <button
                                                                                                                                                                    class="inventory-btn"
                                                                                                                                                                    onclick="inventoryAdd('${escapedKey}', 'blank'); renderInventoryPage();">+</button>
                                                                                                                                                            </div>
                                                                                                                                                            <button
                                                                                                                                                                class="btn-log-job"
                                                                                                                                                                onclick="openJobLogModal('${escapedKey}', 'blank', '${vehicle ? vehicle.replace(/'/g, "
                                                                                                                                                                \\\\'")
                                                                                                                                                                : ''
                                                                                                                                                                }', '${amazonLink ? amazonLink.replace(/'
                                                                                                                                                                /g, "\\\\'"
                                                                                                                                                                )
                                                                                                                                                                : ''
                                                                                                                                                                }')"
                                                                                                                                                                style="padding: 6px 12px; font-size: 0.8rem;">âœ“
                                                                                                                                                                Log
                                                                                                                                                                Job</button>
                                                                                                                                                            <a href="${amazonLink}"
                                                                                                                                                                target="_blank"
                                                                                                                                                                style="padding: 6px 12px; background: linear-gradient(135deg, #ff9900, #ff6600); color: #000; border-radius: 6px; font-size: 0.8rem; font-weight: 600; text-decoration: none;">ðŸ›’
                                                                                                                                                                Buy</a>
                                                                                                                                                            <button
                                                                                                                                                                onclick="openDeleteConfirmModal('${escapedKey}', 'blank')"
                                                                                                                                                                style="padding: 6px 10px; background: transparent; border: 1px solid #ef4444; color: #ef4444; border-radius: 6px; font-size: 0.8rem; cursor: pointer;"
                                                                                                                                                                title="Delete from inventory">âœ•</button>
                                                                                                                                                        </div>
                                                                                                                                                    </div>
                                                                                                                                                    `;
                                                                                                                                                    });
                                                                                                                                                    html
                                                                                                                                                    +=
                                                                                                                                                    '
                                                                                                                                                </div>
                                                                                                                                            </div>
                                                                                                                                            ';
                                                                                                                                            }

                                                                                                                                            //
                                                                                                                                            Usage
                                                                                                                                            History
                                                                                                                                            section
                                                                                                                                            (items
                                                                                                                                            that
                                                                                                                                            have
                                                                                                                                            been
                                                                                                                                            fully
                                                                                                                                            used)
                                                                                                                                            if
                                                                                                                                            (usedKeyEntries.length
                                                                                                                                            >
                                                                                                                                            0
                                                                                                                                            ||
                                                                                                                                            usedBlankEntries.length
                                                                                                                                            >
                                                                                                                                            0)
                                                                                                                                            {
                                                                                                                                            html
                                                                                                                                            +=
                                                                                                                                            `
                                                                                                                                            <div
                                                                                                                                                style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border);">
                                                                                                                                                <h3
                                                                                                                                                    style="color: #22c55e; margin-bottom: 12px;">
                                                                                                                                                    âœ“
                                                                                                                                                    Usage
                                                                                                                                                    History
                                                                                                                                                    (Out
                                                                                                                                                    of
                                                                                                                                                    Stock)
                                                                                                                                                </h3>
                                                                                                                                                <div
                                                                                                                                                    style="display: grid; gap: 8px;">
                                                                                                                                                    `;

                                                                                                                                                    usedKeyEntries.forEach(([key,
                                                                                                                                                    item])
                                                                                                                                                    =>
                                                                                                                                                    {
                                                                                                                                                    const
                                                                                                                                                    used
                                                                                                                                                    =
                                                                                                                                                    item?.used
                                                                                                                                                    ||
                                                                                                                                                    0;
                                                                                                                                                    const
                                                                                                                                                    vehicle
                                                                                                                                                    =
                                                                                                                                                    item?.vehicle
                                                                                                                                                    ||
                                                                                                                                                    null;
                                                                                                                                                    const
                                                                                                                                                    amazonLink
                                                                                                                                                    =
                                                                                                                                                    item?.amazonLink
                                                                                                                                                    ||
                                                                                                                                                    null;
                                                                                                                                                    const
                                                                                                                                                    escapedKey
                                                                                                                                                    =
                                                                                                                                                    key.replace(/'/g,
                                                                                                                                                    "\\\\'");

                                                                                                                                                    html
                                                                                                                                                    +=
                                                                                                                                                    `
                                                                                                                                                    <div
                                                                                                                                                        style="display: flex; align-items: center; justify-content: space-between; padding: 12px; background: var(--bg-tertiary); border-radius: 8px; flex-wrap: wrap; gap: 8px; border: 1px dashed rgba(34, 197, 94, 0.3);">
                                                                                                                                                        <div
                                                                                                                                                            style="display: flex; flex-direction: column; gap: 4px; min-width: 200px;">
                                                                                                                                                            <span
                                                                                                                                                                style="font-weight: 600; color: var(--text-primary);">ðŸ”
                                                                                                                                                                ${key}</span>
                                                                                                                                                            ${vehicle
                                                                                                                                                            ?
                                                                                                                                                            `
                                                                                                                                                            <div
                                                                                                                                                                style="margin-top: 4px; display: flex; flex-wrap: wrap; gap: 4px;">
                                                                                                                                                                ${renderVehicleChips(vehicle,
                                                                                                                                                                null,
                                                                                                                                                                10)}
                                                                                                                                                            </div>
                                                                                                                                                            `
                                                                                                                                                            :
                                                                                                                                                            ''}
                                                                                                                                                        </div>
                                                                                                                                                        <div
                                                                                                                                                            style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
                                                                                                                                                            <span
                                                                                                                                                                style="padding: 4px 8px; background: rgba(34, 197, 94, 0.1); color: #22c55e; border-radius: 4px; font-size: 0.75rem; border: 1px solid rgba(34, 197, 94, 0.2);">âœ“
                                                                                                                                                                ${used}
                                                                                                                                                                used</span>
                                                                                                                                                            <div
                                                                                                                                                                class="inventory-controls">
                                                                                                                                                                <button
                                                                                                                                                                    class="inventory-btn"
                                                                                                                                                                    onclick="inventoryAdd('${escapedKey}', 'key'); renderInventoryPage();">+</button>
                                                                                                                                                            </div>
                                                                                                                                                            ${amazonLink
                                                                                                                                                            ?
                                                                                                                                                            `<a href="${amazonLink}"
                                                                                                                                                                target="_blank"
                                                                                                                                                                style="padding: 6px 12px; background: linear-gradient(135deg, #ff9900, #ff6600); color: #000; border-radius: 6px; font-size: 0.8rem; font-weight: 600; text-decoration: none;">ðŸ›’
                                                                                                                                                                Restock</a>`
                                                                                                                                                            :
                                                                                                                                                            ''}
                                                                                                                                                            <button
                                                                                                                                                                onclick="openDeleteConfirmModal('${escapedKey}', 'key')"
                                                                                                                                                                style="padding: 6px 10px; background: transparent; border: 1px solid #ef4444; color: #ef4444; border-radius: 6px; font-size: 0.8rem; cursor: pointer;"
                                                                                                                                                                title="Delete from history">âœ•</button>
                                                                                                                                                        </div>
                                                                                                                                                    </div>
                                                                                                                                                    `;
                                                                                                                                                    });

                                                                                                                                                    usedBlankEntries.forEach(([keyway,
                                                                                                                                                    item])
                                                                                                                                                    =>
                                                                                                                                                    {
                                                                                                                                                    const
                                                                                                                                                    used
                                                                                                                                                    =
                                                                                                                                                    item?.used
                                                                                                                                                    ||
                                                                                                                                                    0;
                                                                                                                                                    const
                                                                                                                                                    vehicle
                                                                                                                                                    =
                                                                                                                                                    item?.vehicle
                                                                                                                                                    ||
                                                                                                                                                    null;
                                                                                                                                                    const
                                                                                                                                                    amazonLink
                                                                                                                                                    =
                                                                                                                                                    item?.amazonLink
                                                                                                                                                    ||
                                                                                                                                                    `https://www.amazon.com/s?k=${encodeURIComponent(keyway
                                                                                                                                                    +
                                                                                                                                                    '
                                                                                                                                                    key
                                                                                                                                                    blank')}&tag=eurokeys-20`;
                                                                                                                                                    const
                                                                                                                                                    escapedKey
                                                                                                                                                    =
                                                                                                                                                    keyway.replace(/'/g,
                                                                                                                                                    "\\\\'");

                                                                                                                                                    html
                                                                                                                                                    +=
                                                                                                                                                    `
                                                                                                                                                    <div
                                                                                                                                                        style="display: flex; align-items: center; justify-content: space-between; padding: 12px; background: var(--bg-tertiary); border-radius: 8px; flex-wrap: wrap; gap: 8px; border: 1px dashed rgba(34, 197, 94, 0.3);">
                                                                                                                                                        <div
                                                                                                                                                            style="display: flex; flex-direction: column; gap: 4px; min-width: 200px;">
                                                                                                                                                            <span
                                                                                                                                                                style="font-weight: 600; color: var(--text-primary);">ðŸ”‘
                                                                                                                                                                ${keyway}</span>
                                                                                                                                                            ${vehicle
                                                                                                                                                            ?
                                                                                                                                                            `
                                                                                                                                                            <div
                                                                                                                                                                style="margin-top: 4px; display: flex; flex-wrap: wrap; gap: 4px;">
                                                                                                                                                                ${renderVehicleChips(vehicle,
                                                                                                                                                                null,
                                                                                                                                                                10)}
                                                                                                                                                            </div>
                                                                                                                                                            `
                                                                                                                                                            :
                                                                                                                                                            ''}
                                                                                                                                                        </div>
                                                                                                                                                        <div
                                                                                                                                                            style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
                                                                                                                                                            <span
                                                                                                                                                                style="padding: 4px 8px; background: rgba(34, 197, 94, 0.1); color: #22c55e; border-radius: 4px; font-size: 0.75rem; border: 1px solid rgba(34, 197, 94, 0.2);">âœ“
                                                                                                                                                                ${used}
                                                                                                                                                                used</span>
                                                                                                                                                            <div
                                                                                                                                                                class="inventory-controls">
                                                                                                                                                                <button
                                                                                                                                                                    class="inventory-btn"
                                                                                                                                                                    onclick="inventoryAdd('${escapedKey}', 'blank'); renderInventoryPage();">+</button>
                                                                                                                                                            </div>
                                                                                                                                                            <a href="${amazonLink}"
                                                                                                                                                                target="_blank"
                                                                                                                                                                style="padding: 6px 12px; background: linear-gradient(135deg, #ff9900, #ff6600); color: #000; border-radius: 6px; font-size: 0.8rem; font-weight: 600; text-decoration: none;">ðŸ›’
                                                                                                                                                                Restock</a>
                                                                                                                                                            <button
                                                                                                                                                                onclick="openDeleteConfirmModal('${escapedKey}', 'blank')"
                                                                                                                                                                style="padding: 6px 10px; background: transparent; border: 1px solid #ef4444; color: #ef4444; border-radius: 6px; font-size: 0.8rem; cursor: pointer;"
                                                                                                                                                                title="Delete from history">âœ•</button>
                                                                                                                                                        </div>
                                                                                                                                                    </div>
                                                                                                                                                    `;
                                                                                                                                                    });

                                                                                                                                                    html
                                                                                                                                                    +=
                                                                                                                                                    '
                                                                                                                                                </div>
                                                                                                                                            </div>
                                                                                                                                            ';
                                                                                                                                            }

                                                                                                                                            html
                                                                                                                                            +=
                                                                                                                                            '
                                                                                                                                        </div>
                                                                                                                                        ';
                                                                                                                                        container.innerHTML
                                                                                                                                        =
                                                                                                                                        html;
                                                                                                                                        }

                                                                                                                                        function
                                                                                                                                        renderJobLogsPage(container,
                                                                                                                                        headerHtml)
                                                                                                                                        {
                                                                                                                                        const
                                                                                                                                        logs
                                                                                                                                        =
                                                                                                                                        JSON.parse(localStorage.getItem('eurokeys_job_logs')
                                                                                                                                        ||
                                                                                                                                        '[]');

                                                                                                                                        let
                                                                                                                                        html
                                                                                                                                        =
                                                                                                                                        headerHtml;

                                                                                                                                        if
                                                                                                                                        (logs.length
                                                                                                                                        ===
                                                                                                                                        0)
                                                                                                                                        {
                                                                                                                                        html
                                                                                                                                        +=
                                                                                                                                        `
                                                                                                                                        <div
                                                                                                                                            style="text-align: center; padding: 40px; color: var(--text-muted);">
                                                                                                                                            <div
                                                                                                                                                style="font-size: 3rem; margin-bottom: 16px;">
                                                                                                                                                ðŸ“‹
                                                                                                                                            </div>
                                                                                                                                            <h3>No
                                                                                                                                                jobs
                                                                                                                                                logged
                                                                                                                                                yet
                                                                                                                                            </h3>
                                                                                                                                            <p>Completed
                                                                                                                                                jobs
                                                                                                                                                will
                                                                                                                                                appear
                                                                                                                                                here.
                                                                                                                                            </p>
                                                                                                                                        </div>
                                                                                                                                        `;
                                                                                                                                        }
                                                                                                                                        else
                                                                                                                                        {
                                                                                                                                        html
                                                                                                                                        +=
                                                                                                                                        `
                                                                                                                                        <div
                                                                                                                                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                                                                                                                                            <h3
                                                                                                                                                style="color: var(--text-primary);">
                                                                                                                                                Recent
                                                                                                                                                Jobs
                                                                                                                                                (${logs.length})
                                                                                                                                            </h3>
                                                                                                                                            <button
                                                                                                                                                onclick="exportJobLogs()"
                                                                                                                                                style="padding: 8px 16px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary); cursor: pointer;">Download
                                                                                                                                                CSV</button>
                                                                                                                                        </div>
                                                                                                                                        <div
                                                                                                                                            style="display: grid; gap: 12px;">
                                                                                                                                            `;

                                                                                                                                            logs.forEach(log
                                                                                                                                            =>
                                                                                                                                            {
                                                                                                                                            const
                                                                                                                                            date
                                                                                                                                            =
                                                                                                                                            new
                                                                                                                                            Date(log.date).toLocaleString();
                                                                                                                                            const
                                                                                                                                            cost
                                                                                                                                            =
                                                                                                                                            typeof
                                                                                                                                            log.cost
                                                                                                                                            ===
                                                                                                                                            'number'
                                                                                                                                            ?
                                                                                                                                            log.cost
                                                                                                                                            :
                                                                                                                                            0;
                                                                                                                                            const
                                                                                                                                            revenue
                                                                                                                                            =
                                                                                                                                            typeof
                                                                                                                                            log.revenue
                                                                                                                                            ===
                                                                                                                                            'number'
                                                                                                                                            ?
                                                                                                                                            log.revenue
                                                                                                                                            :
                                                                                                                                            0;
                                                                                                                                            const
                                                                                                                                            profit
                                                                                                                                            =
                                                                                                                                            revenue
                                                                                                                                            -
                                                                                                                                            cost;
                                                                                                                                            const
                                                                                                                                            customer
                                                                                                                                            =
                                                                                                                                            log.customer
                                                                                                                                            ||
                                                                                                                                            'Unknown
                                                                                                                                            Customer';
                                                                                                                                            const
                                                                                                                                            description
                                                                                                                                            =
                                                                                                                                            log.description
                                                                                                                                            ||
                                                                                                                                            log.vehicle
                                                                                                                                            ||
                                                                                                                                            '';

                                                                                                                                            html
                                                                                                                                            +=
                                                                                                                                            `
                                                                                                                                            <div
                                                                                                                                                style="background: var(--bg-tertiary); padding: 16px; border-radius: 8px; border-left: 4px solid var(--brand-primary);">
                                                                                                                                                <div
                                                                                                                                                    style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
                                                                                                                                                    <div>
                                                                                                                                                        <div
                                                                                                                                                            style="font-weight: 700; color: var(--text-primary); font-size: 1.1rem;">
                                                                                                                                                            ${customer}
                                                                                                                                                        </div>
                                                                                                                                                        <div
                                                                                                                                                            style="font-size: 0.85rem; color: var(--text-muted);">
                                                                                                                                                            ${date}
                                                                                                                                                        </div>
                                                                                                                                                    </div>
                                                                                                                                                    <div
                                                                                                                                                        style="text-align: right;">
                                                                                                                                                        <div
                                                                                                                                                            style="font-weight: 700; color: #22c55e;">
                                                                                                                                                            +
                                                                                                                                                            $${profit.toFixed(2)}
                                                                                                                                                        </div>
                                                                                                                                                        <div
                                                                                                                                                            style="font-size: 0.75rem; color: var(--text-muted);">
                                                                                                                                                            Rev:
                                                                                                                                                            $${revenue.toFixed(2)}
                                                                                                                                                        </div>
                                                                                                                                                    </div>
                                                                                                                                                </div>
                                                                                                                                                <div
                                                                                                                                                    style="margin-bottom: 8px;">
                                                                                                                                                    <div
                                                                                                                                                        style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px; flex-wrap: wrap;">
                                                                                                                                                        <span
                                                                                                                                                            style="font-size: 0.85rem; padding: 2px 8px; background: rgba(255, 255, 255, 0.1); border-radius: 4px;">${log.type
                                                                                                                                                            ===
                                                                                                                                                            'blank'
                                                                                                                                                            ?
                                                                                                                                                            'ðŸ”‘'
                                                                                                                                                            :
                                                                                                                                                            'ðŸ”'}
                                                                                                                                                            ${log.itemKey}</span>
                                                                                                                                                    </div>
                                                                                                                                                    ${description
                                                                                                                                                    ?
                                                                                                                                                    `
                                                                                                                                                    <div
                                                                                                                                                        style="display: flex; flex-wrap: wrap; gap: 4px; margin-top: 6px;">
                                                                                                                                                        ${renderVehicleChips(description,
                                                                                                                                                        null,
                                                                                                                                                        3)}
                                                                                                                                                    </div>
                                                                                                                                                    `
                                                                                                                                                    :
                                                                                                                                                    ''}
                                                                                                                                                    ${log.notes
                                                                                                                                                    ?
                                                                                                                                                    `
                                                                                                                                                    <div
                                                                                                                                                        style="font-size: 0.85rem; color: var(--text-muted); font-style: italic; margin-top: 6px;">
                                                                                                                                                        "${log.notes}"
                                                                                                                                                    </div>
                                                                                                                                                    `
                                                                                                                                                    :
                                                                                                                                                    ''}
                                                                                                                                                </div>
                                                                                                                                            </div>
                                                                                                                                            `;
                                                                                                                                            });

                                                                                                                                            html
                                                                                                                                            +=
                                                                                                                                            '
                                                                                                                                        </div>
                                                                                                                                        ';
                                                                                                                                        }

                                                                                                                                        container.innerHTML
                                                                                                                                        =
                                                                                                                                        html;
                                                                                                                                        }

                                                                                                                                        function
                                                                                                                                        exportJobLogs()
                                                                                                                                        {
                                                                                                                                        const
                                                                                                                                        logs
                                                                                                                                        =
                                                                                                                                        JSON.parse(localStorage.getItem('eurokeys_job_logs')
                                                                                                                                        ||
                                                                                                                                        '[]');
                                                                                                                                        if
                                                                                                                                        (logs.length
                                                                                                                                        ===
                                                                                                                                        0)
                                                                                                                                        return
                                                                                                                                        alert('No
                                                                                                                                        logs
                                                                                                                                        to
                                                                                                                                        export');

                                                                                                                                        const
                                                                                                                                        headers
                                                                                                                                        =
                                                                                                                                        ['Date',
                                                                                                                                        'Customer',
                                                                                                                                        'Item',
                                                                                                                                        'Type',
                                                                                                                                        'Description',
                                                                                                                                        'Cost',
                                                                                                                                        'Notes'];
                                                                                                                                        const
                                                                                                                                        csvContent
                                                                                                                                        =
                                                                                                                                        [
                                                                                                                                        headers.join(','),
                                                                                                                                        ...logs.map(log
                                                                                                                                        =>
                                                                                                                                        [
                                                                                                                                        new
                                                                                                                                        Date(log.date).toISOString(),
                                                                                                                                        `"${(log.customer
                                                                                                                                        ||
                                                                                                                                        'Manual
                                                                                                                                        Job').replace(/"/g,
                                                                                                                                        '""')}"`,
                                                                                                                                        `"${(log.itemKey
                                                                                                                                        ||
                                                                                                                                        '').replace(/"/g,
                                                                                                                                        '""')}"`,
                                                                                                                                        log.type,
                                                                                                                                        `"${(log.description
                                                                                                                                        ||
                                                                                                                                        log.vehicle
                                                                                                                                        ||
                                                                                                                                        '').replace(/"/g,
                                                                                                                                        '""')}"`,
                                                                                                                                        typeof
                                                                                                                                        log.cost
                                                                                                                                        ===
                                                                                                                                        'number'
                                                                                                                                        ?
                                                                                                                                        log.cost.toFixed(2)
                                                                                                                                        :
                                                                                                                                        '0.00',
                                                                                                                                        `"${(log.notes
                                                                                                                                        ||
                                                                                                                                        '').replace(/"/g,
                                                                                                                                        '""')}"`
                                                                                                                                        ].join(','))
                                                                                                                                        ].join('\n');

                                                                                                                                        const
                                                                                                                                        blob
                                                                                                                                        =
                                                                                                                                        new
                                                                                                                                        Blob([csvContent],
                                                                                                                                        {
                                                                                                                                        type:
                                                                                                                                        'text/csv'
                                                                                                                                        });
                                                                                                                                        const
                                                                                                                                        url
                                                                                                                                        =
                                                                                                                                        window.URL.createObjectURL(blob);
                                                                                                                                        const
                                                                                                                                        a
                                                                                                                                        =
                                                                                                                                        document.createElement('a');
                                                                                                                                        a.href
                                                                                                                                        =
                                                                                                                                        url;
                                                                                                                                        a.download
                                                                                                                                        =
                                                                                                                                        `job-logs-${new
                                                                                                                                        Date().toISOString().split('T')[0]}.csv`;
                                                                                                                                        a.click();
                                                                                                                                        }


                                                                                                                                        async
                                                                                                                                        function
                                                                                                                                        renderBusinessDashboard(container,
                                                                                                                                        headerHtml)
                                                                                                                                        {
                                                                                                                                        const
                                                                                                                                        period
                                                                                                                                        =
                                                                                                                                        localStorage.getItem('eurokeys_dashboard_period')
                                                                                                                                        ||
                                                                                                                                        'year';
                                                                                                                                        const
                                                                                                                                        stats
                                                                                                                                        =
                                                                                                                                        calculateInventoryStats(period);
                                                                                                                                        const
                                                                                                                                        assets
                                                                                                                                        =
                                                                                                                                        AssetManager.getAssets();
                                                                                                                                        const
                                                                                                                                        depreciation
                                                                                                                                        =
                                                                                                                                        AssetManager.calculateDepreciation();

                                                                                                                                        let
                                                                                                                                        html
                                                                                                                                        =
                                                                                                                                        headerHtml
                                                                                                                                        +
                                                                                                                                        `
                                                                                                                                        <div
                                                                                                                                            style="margin-bottom: 24px;">
                                                                                                                                            <div
                                                                                                                                                style="display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 16px;">
                                                                                                                                                <h2
                                                                                                                                                    style="margin: 0; color: var(--text-primary);">
                                                                                                                                                    ðŸ’¼
                                                                                                                                                    Business
                                                                                                                                                    Dashboard
                                                                                                                                                </h2>
                                                                                                                                                <div
                                                                                                                                                    style="display: flex; gap: 8px; background: var(--bg-tertiary); padding: 4px; border-radius: 8px;">
                                                                                                                                                    ${['week',
                                                                                                                                                    'month',
                                                                                                                                                    'year'].map(p
                                                                                                                                                    =>
                                                                                                                                                    `
                                                                                                                                                    <button
                                                                                                                                                        onclick="localStorage.setItem('eurokeys_dashboard_period', '${p}'); renderInventoryPage('stats')"
                                                                                                                                                        style="
                                    padding: 6px 12px; border: none; border-radius: 6px; cursor: pointer; font-size: 0.75rem; font-weight: 600;
                                    background: ${period === p ? 'var(--brand-primary)' : 'transparent'};
                                    color: ${period === p ? '#000' : 'var(--text-muted)'};
                                ">${p.toUpperCase()}</button>
                                                                                                                                                    `).join('')}
                                                                                                                                                </div>
                                                                                                                                            </div>

                                                                                                                                            <!-- KPI Grid -->
                                                                                                                                            <div
                                                                                                                                                style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 32px;">
                                                                                                                                                <div
                                                                                                                                                    style="padding: 20px; background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); border-radius: 12px; border: 1px solid rgba(255,255,255,0.05);">
                                                                                                                                                    <div
                                                                                                                                                        style="color: var(--text-muted); font-size: 0.75rem; text-transform: uppercase; margin-bottom: 8px;">
                                                                                                                                                        Gross
                                                                                                                                                        EBITDA
                                                                                                                                                    </div>
                                                                                                                                                    <div
                                                                                                                                                        style="font-size: 1.8rem; font-weight: 800; color: #fff;">
                                                                                                                                                        $${stats.ebitda.toFixed(2)}
                                                                                                                                                    </div>
                                                                                                                                                    <div
                                                                                                                                                        style="font-size: 0.75rem; color: #22c55e; margin-top: 4px;">
                                                                                                                                                        from
                                                                                                                                                        ${stats.totalJobs}
                                                                                                                                                        jobs
                                                                                                                                                    </div>
                                                                                                                                                </div>
                                                                                                                                                <div
                                                                                                                                                    style="padding: 20px; background: var(--bg-tertiary); border-radius: 12px; border: 1px solid var(--border);">
                                                                                                                                                    <div
                                                                                                                                                        style="color: var(--text-muted); font-size: 0.75rem; text-transform: uppercase; margin-bottom: 8px;">
                                                                                                                                                        Hourly
                                                                                                                                                        Efficiency
                                                                                                                                                    </div>
                                                                                                                                                    <div
                                                                                                                                                        style="font-size: 1.8rem; font-weight: 800; color: var(--brand-primary);">
                                                                                                                                                        $${stats.hourlyRate.toFixed(2)}<span
                                                                                                                                                            style="font-size: 0.9rem; font-weight: 400; color: var(--text-muted);">/hr</span>
                                                                                                                                                    </div>
                                                                                                                                                    <div
                                                                                                                                                        style="font-size: 0.75rem; color: var(--text-muted); margin-top: 4px;">
                                                                                                                                                        Net
                                                                                                                                                        after
                                                                                                                                                        expenses
                                                                                                                                                    </div>
                                                                                                                                                </div>
                                                                                                                                                <div
                                                                                                                                                    style="padding: 20px; background: var(--bg-tertiary); border-radius: 12px; border: 1px solid var(--border);">
                                                                                                                                                    <div
                                                                                                                                                        style="color: var(--text-muted); font-size: 0.75rem; text-transform: uppercase; margin-bottom: 8px;">
                                                                                                                                                        Estimated
                                                                                                                                                        Taxes
                                                                                                                                                    </div>
                                                                                                                                                    <div
                                                                                                                                                        style="font-size: 1.8rem; font-weight: 800; color: #f87171;">
                                                                                                                                                        $${stats.taxEstimate.toFixed(2)}
                                                                                                                                                    </div>
                                                                                                                                                    <div
                                                                                                                                                        style="font-size: 0.75rem; color: var(--text-muted); margin-top: 4px;">
                                                                                                                                                        Based
                                                                                                                                                        on
                                                                                                                                                        30%
                                                                                                                                                        rate
                                                                                                                                                    </div>
                                                                                                                                                </div>
                                                                                                                                            </div>

                                                                                                                                            <!-- Detailed Metrics Grid -->
                                                                                                                                            <div
                                                                                                                                                style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 24px;">
                                                                                                                                                <!-- Financial Breakdown -->
                                                                                                                                                <div
                                                                                                                                                    style="background: var(--bg-tertiary); border-radius: 12px; padding: 24px;">
                                                                                                                                                    <h3
                                                                                                                                                        style="margin-top: 0; margin-bottom: 20px; display: flex; align-items: center; gap: 8px;">
                                                                                                                                                        <span>ðŸ“Š</span>
                                                                                                                                                        Financial
                                                                                                                                                        Breakdown
                                                                                                                                                    </h3>
                                                                                                                                                    <div
                                                                                                                                                        style="display: grid; gap: 12px;">
                                                                                                                                                        <div
                                                                                                                                                            style="display: flex; justify-content: space-between; padding-bottom: 8px; border-bottom: 1px solid rgba(255,255,255,0.05);">
                                                                                                                                                            <span
                                                                                                                                                                style="color: var(--text-muted);">Service
                                                                                                                                                                Revenue</span>
                                                                                                                                                            <span
                                                                                                                                                                style="font-weight: 600;">$${stats.totalRevenue.toFixed(2)}</span>
                                                                                                                                                        </div>
                                                                                                                                                        <div
                                                                                                                                                            style="display: flex; justify-content: space-between; padding-bottom: 8px; border-bottom: 1px solid rgba(255,255,255,0.05);">
                                                                                                                                                            <span
                                                                                                                                                                style="color: var(--text-muted);">Tips
                                                                                                                                                                Earned</span>
                                                                                                                                                            <span
                                                                                                                                                                style="font-weight: 600; color: #22c55e;">+$${stats.totalTips.toFixed(2)}</span>
                                                                                                                                                        </div>
                                                                                                                                                        <div
                                                                                                                                                            style="display: flex; justify-content: space-between; padding-bottom: 8px; border-bottom: 1px solid rgba(255,255,255,0.05);">
                                                                                                                                                            <span
                                                                                                                                                                style="color: var(--text-muted);">Inventory
                                                                                                                                                                COGS</span>
                                                                                                                                                            <span
                                                                                                                                                                style="font-weight: 600; color: #f87171;">-$${stats.totalCost.toFixed(2)}</span>
                                                                                                                                                        </div>
                                                                                                                                                        <div
                                                                                                                                                            style="display: flex; justify-content: space-between; padding-bottom: 8px; border-bottom: 1px solid rgba(255,255,255,0.05);">
                                                                                                                                                            <span
                                                                                                                                                                style="color: var(--text-muted);">Mileage
                                                                                                                                                                Write-off</span>
                                                                                                                                                            <span
                                                                                                                                                                style="font-weight: 600; color: #f87171;">-$${stats.mileageCost.toFixed(2)}</span>
                                                                                                                                                        </div>
                                                                                                                                                        <div
                                                                                                                                                            style="display: flex; justify-content: space-between; padding-top: 8px; font-weight: 800; color: var(--brand-primary);">
                                                                                                                                                            <span>Net
                                                                                                                                                                EBITDA</span>
                                                                                                                                                            <span>$${stats.ebitda.toFixed(2)}</span>
                                                                                                                                                        </div>
                                                                                                                                                    </div>
                                                                                                                                                </div>

                                                                                                                                                <!-- Asset Manager -->
                                                                                                                                                <div
                                                                                                                                                    style="background: var(--bg-tertiary); border-radius: 12px; padding: 24px;">
                                                                                                                                                    <div
                                                                                                                                                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                                                                                                                                        <h3
                                                                                                                                                            style="margin: 0; display: flex; align-items: center; gap: 8px;">
                                                                                                                                                            <span>ðŸ› ï¸</span>
                                                                                                                                                            Asset
                                                                                                                                                            Manager
                                                                                                                                                        </h3>
                                                                                                                                                        <button
                                                                                                                                                            onclick="toggleAssetForm()"
                                                                                                                                                            style="padding: 4px 8px; background: var(--brand-primary); border: none; border-radius: 4px; color: #000; font-size: 0.7rem; font-weight: 700; cursor: pointer;">+
                                                                                                                                                            ADD</button>
                                                                                                                                                    </div>

                                                                                                                                                    <div id="assetForm"
                                                                                                                                                        style="display: none; background: rgba(0,0,0,0.2); padding: 12px; border-radius: 8px; margin-bottom: 16px;">
                                                                                                                                                        <select
                                                                                                                                                            id="assetType"
                                                                                                                                                            onchange="handleAssetTypeChange()"
                                                                                                                                                            style="width: 100%; padding: 8px; margin-bottom: 8px; background: #1a1a1a; color: #fff; border: 1px solid #333;">
                                                                                                                                                            <option
                                                                                                                                                                value="equipment">
                                                                                                                                                                Equipment
                                                                                                                                                                (Tool/Programmer)
                                                                                                                                                            </option>
                                                                                                                                                            <option
                                                                                                                                                                value="vehicle">
                                                                                                                                                                Service
                                                                                                                                                                Vehicle
                                                                                                                                                            </option>
                                                                                                                                                        </select>

                                                                                                                                                        <!-- Dynamic Tool Selector -->
                                                                                                                                                        <div
                                                                                                                                                            id="toolSelectContainer">
                                                                                                                                                            <select
                                                                                                                                                                id="knownToolSelect"
                                                                                                                                                                onchange="handleToolSelection()"
                                                                                                                                                                style="width: 100%; padding: 8px; margin-bottom: 8px; background: #1a1a1a; color: #fff; border: 1px solid #333;">
                                                                                                                                                                <option
                                                                                                                                                                    value="">
                                                                                                                                                                    --
                                                                                                                                                                    Select
                                                                                                                                                                    Tool
                                                                                                                                                                    --
                                                                                                                                                                </option>
                                                                                                                                                                ${Object.keys(ToolLibrary).map(tool
                                                                                                                                                                =>
                                                                                                                                                                `
                                                                                                                                                                <option
                                                                                                                                                                    value="${tool}">
                                                                                                                                                                    ${tool}
                                                                                                                                                                </option>
                                                                                                                                                                `).join('')}
                                                                                                                                                                <option
                                                                                                                                                                    value="custom">
                                                                                                                                                                    +
                                                                                                                                                                    Custom
                                                                                                                                                                    /
                                                                                                                                                                    Other
                                                                                                                                                                </option>
                                                                                                                                                            </select>
                                                                                                                                                        </div>

                                                                                                                                                        <input
                                                                                                                                                            type="text"
                                                                                                                                                            id="assetName"
                                                                                                                                                            placeholder="Asset Name"
                                                                                                                                                            style="width: 100%; padding: 8px; margin-bottom: 8px; background: #1a1a1a; color: #fff; border: 1px solid #333; display: none;">
                                                                                                                                                        <input
                                                                                                                                                            type="number"
                                                                                                                                                            id="assetCost"
                                                                                                                                                            placeholder="Price/Value ($)"
                                                                                                                                                            style="width: 100%; padding: 8px; margin-bottom: 8px; background: #1a1a1a; color: #fff; border: 1px solid #333;">

                                                                                                                                                        <button
                                                                                                                                                            onclick="saveNewAsset()"
                                                                                                                                                            style="width: 100%; padding: 8px; background: var(--brand-primary); border: none; color: #000; font-weight: 700; cursor: pointer;">Save
                                                                                                                                                            Asset</button>
                                                                                                                                                    </div>

                                                                                                                                                    <div
                                                                                                                                                        style="display: grid; gap: 12px;">
                                                                                                                                                        ${assets.vehicles.map(v
                                                                                                                                                        =>
                                                                                                                                                        `
                                                                                                                                                        <div
                                                                                                                                                            style="display: flex; justify-content: space-between; font-size: 0.9rem;">
                                                                                                                                                            <span
                                                                                                                                                                style="color: var(--text-primary);">ðŸš
                                                                                                                                                                ${v.name}</span>
                                                                                                                                                            <div
                                                                                                                                                                style="text-align: right;">
                                                                                                                                                                <div
                                                                                                                                                                    style="font-weight: 600;">
                                                                                                                                                                    $${v.price.toLocaleString()}
                                                                                                                                                                </div>
                                                                                                                                                                <div
                                                                                                                                                                    style="font-size: 0.7rem; color: var(--text-muted);">
                                                                                                                                                                    Depr:
                                                                                                                                                                    -$${(v.price
                                                                                                                                                                    /
                                                                                                                                                                    5).toFixed(0)}/yr
                                                                                                                                                                </div>
                                                                                                                                                            </div>
                                                                                                                                                        </div>
                                                                                                                                                        `).join('')}
                                                                                                                                                        ${assets.equipment.map(e
                                                                                                                                                        =>
                                                                                                                                                        `
                                                                                                                                                        <div
                                                                                                                                                            style="display: flex; justify-content: space-between; font-size: 0.9rem;">
                                                                                                                                                            <span
                                                                                                                                                                style="color: var(--text-primary);">ðŸ”§
                                                                                                                                                                ${e.name}</span>
                                                                                                                                                            <span
                                                                                                                                                                style="font-weight: 600;">$${e.cost.toLocaleString()}</span>
                                                                                                                                                        </div>
                                                                                                                                                        `).join('')}
                                                                                                                                                        ${assets.vehicles.length
                                                                                                                                                        ===
                                                                                                                                                        0
                                                                                                                                                        &&
                                                                                                                                                        assets.equipment.length
                                                                                                                                                        ===
                                                                                                                                                        0
                                                                                                                                                        ?
                                                                                                                                                        '
                                                                                                                                                        <div
                                                                                                                                                            style="color: var(--text-muted); text-align: center; padding: 20px;">
                                                                                                                                                            No
                                                                                                                                                            assets
                                                                                                                                                            tracked
                                                                                                                                                            yet
                                                                                                                                                        </div>
                                                                                                                                                        '
                                                                                                                                                        :
                                                                                                                                                        ''}
                                                                                                                                                    </div>
                                                                                                                                                </div>
                                                                                                                                            </div>
                                                                                                                                        </div>
                                                                                                                                        `;
                                                                                                                                        container.innerHTML
                                                                                                                                        =
                                                                                                                                        html;
                                                                                                                                        }

                                                                                                                                        function
                                                                                                                                        toggleAssetForm()
                                                                                                                                        {
                                                                                                                                        const
                                                                                                                                        form
                                                                                                                                        =
                                                                                                                                        document.getElementById('assetForm');
                                                                                                                                        form.style.display
                                                                                                                                        =
                                                                                                                                        form.style.display
                                                                                                                                        ===
                                                                                                                                        'none'
                                                                                                                                        ?
                                                                                                                                        'block'
                                                                                                                                        :
                                                                                                                                        'none';
                                                                                                                                        }

                                                                                                                                        function
                                                                                                                                        handleAssetTypeChange()
                                                                                                                                        {
                                                                                                                                        const
                                                                                                                                        type
                                                                                                                                        =
                                                                                                                                        document.getElementById('assetType').value;
                                                                                                                                        const
                                                                                                                                        toolContainer
                                                                                                                                        =
                                                                                                                                        document.getElementById('toolSelectContainer');
                                                                                                                                        const
                                                                                                                                        nameInput
                                                                                                                                        =
                                                                                                                                        document.getElementById('assetName');

                                                                                                                                        if
                                                                                                                                        (type
                                                                                                                                        ===
                                                                                                                                        'vehicle')
                                                                                                                                        {
                                                                                                                                        toolContainer.style.display
                                                                                                                                        =
                                                                                                                                        'none';
                                                                                                                                        nameInput.style.display
                                                                                                                                        =
                                                                                                                                        'block';
                                                                                                                                        nameInput.placeholder
                                                                                                                                        =
                                                                                                                                        "Vehicle
                                                                                                                                        Name
                                                                                                                                        (e.g.
                                                                                                                                        2018
                                                                                                                                        Ford
                                                                                                                                        Transit)";
                                                                                                                                        nameInput.value
                                                                                                                                        =
                                                                                                                                        '';
                                                                                                                                        document.getElementById('assetCost').value
                                                                                                                                        =
                                                                                                                                        '';
                                                                                                                                        }
                                                                                                                                        else
                                                                                                                                        {
                                                                                                                                        toolContainer.style.display
                                                                                                                                        =
                                                                                                                                        'block';
                                                                                                                                        document.getElementById('knownToolSelect').value
                                                                                                                                        =
                                                                                                                                        '';
                                                                                                                                        nameInput.style.display
                                                                                                                                        =
                                                                                                                                        'none';
                                                                                                                                        //
                                                                                                                                        Hide
                                                                                                                                        manual
                                                                                                                                        input
                                                                                                                                        initially
                                                                                                                                        document.getElementById('assetCost').value
                                                                                                                                        =
                                                                                                                                        '';
                                                                                                                                        }
                                                                                                                                        }

                                                                                                                                        function
                                                                                                                                        handleToolSelection()
                                                                                                                                        {
                                                                                                                                        const
                                                                                                                                        select
                                                                                                                                        =
                                                                                                                                        document.getElementById('knownToolSelect');
                                                                                                                                        const
                                                                                                                                        nameInput
                                                                                                                                        =
                                                                                                                                        document.getElementById('assetName');
                                                                                                                                        const
                                                                                                                                        costInput
                                                                                                                                        =
                                                                                                                                        document.getElementById('assetCost');
                                                                                                                                        const
                                                                                                                                        val
                                                                                                                                        =
                                                                                                                                        select.value;

                                                                                                                                        if
                                                                                                                                        (val
                                                                                                                                        ===
                                                                                                                                        'custom')
                                                                                                                                        {
                                                                                                                                        nameInput.style.display
                                                                                                                                        =
                                                                                                                                        'block';
                                                                                                                                        nameInput.value
                                                                                                                                        =
                                                                                                                                        '';
                                                                                                                                        nameInput.placeholder
                                                                                                                                        =
                                                                                                                                        "Enter
                                                                                                                                        Tool
                                                                                                                                        Name";
                                                                                                                                        costInput.value
                                                                                                                                        =
                                                                                                                                        '';
                                                                                                                                        }
                                                                                                                                        else
                                                                                                                                        if
                                                                                                                                        (val)
                                                                                                                                        {
                                                                                                                                        nameInput.style.display
                                                                                                                                        =
                                                                                                                                        'none';
                                                                                                                                        nameInput.value
                                                                                                                                        =
                                                                                                                                        val;
                                                                                                                                        //
                                                                                                                                        Set
                                                                                                                                        hidden
                                                                                                                                        value
                                                                                                                                        for
                                                                                                                                        submission
                                                                                                                                        //
                                                                                                                                        Auto-fill
                                                                                                                                        price
                                                                                                                                        if
                                                                                                                                        (ToolLibrary[val])
                                                                                                                                        {
                                                                                                                                        costInput.value
                                                                                                                                        =
                                                                                                                                        ToolLibrary[val].price;
                                                                                                                                        }
                                                                                                                                        }
                                                                                                                                        else
                                                                                                                                        {
                                                                                                                                        nameInput.style.display
                                                                                                                                        =
                                                                                                                                        'none';
                                                                                                                                        costInput.value
                                                                                                                                        =
                                                                                                                                        '';
                                                                                                                                        }
                                                                                                                                        }

                                                                                                                                        function
                                                                                                                                        saveNewAsset()
                                                                                                                                        {
                                                                                                                                        const
                                                                                                                                        type
                                                                                                                                        =
                                                                                                                                        document.getElementById('assetType').value;
                                                                                                                                        let
                                                                                                                                        name
                                                                                                                                        =
                                                                                                                                        document.getElementById('assetName').value;

                                                                                                                                        //
                                                                                                                                        If
                                                                                                                                        using
                                                                                                                                        dropdown
                                                                                                                                        logic
                                                                                                                                        for
                                                                                                                                        equipment
                                                                                                                                        if
                                                                                                                                        (type
                                                                                                                                        ===
                                                                                                                                        'equipment')
                                                                                                                                        {
                                                                                                                                        const
                                                                                                                                        selectVal
                                                                                                                                        =
                                                                                                                                        document.getElementById('knownToolSelect').value;
                                                                                                                                        if
                                                                                                                                        (selectVal
                                                                                                                                        &&
                                                                                                                                        selectVal
                                                                                                                                        !==
                                                                                                                                        'custom')
                                                                                                                                        {
                                                                                                                                        name
                                                                                                                                        =
                                                                                                                                        selectVal;
                                                                                                                                        }
                                                                                                                                        }

                                                                                                                                        const
                                                                                                                                        cost
                                                                                                                                        =
                                                                                                                                        document.getElementById('assetCost').value;
                                                                                                                                        if
                                                                                                                                        (!name
                                                                                                                                        ||
                                                                                                                                        !cost)
                                                                                                                                        return
                                                                                                                                        alert('Please
                                                                                                                                        enter
                                                                                                                                        name
                                                                                                                                        and
                                                                                                                                        cost');

                                                                                                                                        if
                                                                                                                                        (type
                                                                                                                                        ===
                                                                                                                                        'equipment')
                                                                                                                                        AssetManager.addEquipment(name,
                                                                                                                                        cost);
                                                                                                                                        else
                                                                                                                                        AssetManager.addVehicle(name,
                                                                                                                                        cost);

                                                                                                                                        renderInventoryPage('stats');
                                                                                                                                        }



                                                                                                                                        //
                                                                                                                                        ==================
                                                                                                                                        KEY
                                                                                                                                        COVERAGE
                                                                                                                                        HEATMAP
                                                                                                                                        ==================
                                                                                                                                        let
                                                                                                                                        heatmapCached
                                                                                                                                        =
                                                                                                                                        false;
                                                                                                                                        let
                                                                                                                                        cachedCoverage
                                                                                                                                        =
                                                                                                                                        null;
                                                                                                                                        let
                                                                                                                                        cachedHeatmapHtml
                                                                                                                                        =
                                                                                                                                        null;

                                                                                                                                        //
                                                                                                                                        Hardcoded
                                                                                                                                        coverage
                                                                                                                                        data:
                                                                                                                                        key
                                                                                                                                        type
                                                                                                                                        by
                                                                                                                                        make
                                                                                                                                        and
                                                                                                                                        year
                                                                                                                                        //
                                                                                                                                        'S'
                                                                                                                                        =
                                                                                                                                        Smart/Prox,
                                                                                                                                        'F'
                                                                                                                                        =
                                                                                                                                        Flip
                                                                                                                                        Key,
                                                                                                                                        'R'
                                                                                                                                        =
                                                                                                                                        Remote
                                                                                                                                        Head,
                                                                                                                                        'T'
                                                                                                                                        =
                                                                                                                                        Transponder,
                                                                                                                                        'M'
                                                                                                                                        =
                                                                                                                                        Mechanical
                                                                                                                                        //
                                                                                                                                        This
                                                                                                                                        data
                                                                                                                                        reflects
                                                                                                                                        typical
                                                                                                                                        key
                                                                                                                                        technology
                                                                                                                                        adoption
                                                                                                                                        by
                                                                                                                                        manufacturer
                                                                                                                                        //
                                                                                                                                        Multi-type
                                                                                                                                        coverage:
                                                                                                                                        each
                                                                                                                                        year
                                                                                                                                        can
                                                                                                                                        have
                                                                                                                                        multiple
                                                                                                                                        key
                                                                                                                                        types
                                                                                                                                        available
                                                                                                                                        //
                                                                                                                                        Format:
                                                                                                                                        {
                                                                                                                                        year:
                                                                                                                                        ['S',
                                                                                                                                        'T',
                                                                                                                                        'M']
                                                                                                                                        }
                                                                                                                                        means
                                                                                                                                        Smart,
                                                                                                                                        Transponder,
                                                                                                                                        and
                                                                                                                                        Mechanical
                                                                                                                                        all
                                                                                                                                        available
                                                                                                                                        const
                                                                                                                                        HARDCODED_COVERAGE
                                                                                                                                        =
                                                                                                                                        {
                                                                                                                                        //
                                                                                                                                        Japanese
                                                                                                                                        -
                                                                                                                                        Early
                                                                                                                                        smart
                                                                                                                                        adopters
                                                                                                                                        but
                                                                                                                                        transponder/mechanical
                                                                                                                                        still
                                                                                                                                        available
                                                                                                                                        "Toyota":
                                                                                                                                        {
                                                                                                                                        1995:
                                                                                                                                        ['M'],
                                                                                                                                        1996:
                                                                                                                                        ['M'],
                                                                                                                                        1997:
                                                                                                                                        ['M'],
                                                                                                                                        1998:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        1999:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        2000:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        2001:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        2002:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        2003:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        2004:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        2005:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        2006:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        2007:
                                                                                                                                        ['S',
                                                                                                                                        'T',
                                                                                                                                        'M'],
                                                                                                                                        2008:
                                                                                                                                        ['S',
                                                                                                                                        'T',
                                                                                                                                        'M'],
                                                                                                                                        2009:
                                                                                                                                        ['S',
                                                                                                                                        'T',
                                                                                                                                        'M'],
                                                                                                                                        2010:
                                                                                                                                        ['S',
                                                                                                                                        'T',
                                                                                                                                        'M'],
                                                                                                                                        2011:
                                                                                                                                        ['S',
                                                                                                                                        'T',
                                                                                                                                        'M'],
                                                                                                                                        2012:
                                                                                                                                        ['S',
                                                                                                                                        'T',
                                                                                                                                        'M'],
                                                                                                                                        2013:
                                                                                                                                        ['S',
                                                                                                                                        'T',
                                                                                                                                        'M'],
                                                                                                                                        2014:
                                                                                                                                        ['S',
                                                                                                                                        'T',
                                                                                                                                        'M'],
                                                                                                                                        2015:
                                                                                                                                        ['S',
                                                                                                                                        'T',
                                                                                                                                        'M'],
                                                                                                                                        2016:
                                                                                                                                        ['S',
                                                                                                                                        'T',
                                                                                                                                        'M'],
                                                                                                                                        2017:
                                                                                                                                        ['S',
                                                                                                                                        'T',
                                                                                                                                        'M'],
                                                                                                                                        2018:
                                                                                                                                        ['S',
                                                                                                                                        'T'],
                                                                                                                                        2019:
                                                                                                                                        ['S',
                                                                                                                                        'T'],
                                                                                                                                        2020:
                                                                                                                                        ['S',
                                                                                                                                        'T'],
                                                                                                                                        2021:
                                                                                                                                        ['S',
                                                                                                                                        'T'],
                                                                                                                                        2022:
                                                                                                                                        ['S',
                                                                                                                                        'T'],
                                                                                                                                        2023:
                                                                                                                                        ['S'],
                                                                                                                                        2024:
                                                                                                                                        ['S'],
                                                                                                                                        2025:
                                                                                                                                        ['S']
                                                                                                                                        },
                                                                                                                                        "Lexus":
                                                                                                                                        {
                                                                                                                                        1995:
                                                                                                                                        ['M'],
                                                                                                                                        1996:
                                                                                                                                        ['M'],
                                                                                                                                        1997:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        1998:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        1999:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        2000:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        2001:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        2002:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        2003:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        2004:
                                                                                                                                        ['S',
                                                                                                                                        'T',
                                                                                                                                        'M'],
                                                                                                                                        2005:
                                                                                                                                        ['S',
                                                                                                                                        'T'],
                                                                                                                                        2006:
                                                                                                                                        ['S',
                                                                                                                                        'T'],
                                                                                                                                        2007:
                                                                                                                                        ['S',
                                                                                                                                        'T'],
                                                                                                                                        2008:
                                                                                                                                        ['S',
                                                                                                                                        'T'],
                                                                                                                                        2009:
                                                                                                                                        ['S',
                                                                                                                                        'T'],
                                                                                                                                        2010:
                                                                                                                                        ['S',
                                                                                                                                        'T'],
                                                                                                                                        2011:
                                                                                                                                        ['S',
                                                                                                                                        'T'],
                                                                                                                                        2012:
                                                                                                                                        ['S',
                                                                                                                                        'T'],
                                                                                                                                        2013:
                                                                                                                                        ['S',
                                                                                                                                        'T'],
                                                                                                                                        2014:
                                                                                                                                        ['S'],
                                                                                                                                        2015:
                                                                                                                                        ['S'],
                                                                                                                                        2016:
                                                                                                                                        ['S'],
                                                                                                                                        2017:
                                                                                                                                        ['S'],
                                                                                                                                        2018:
                                                                                                                                        ['S'],
                                                                                                                                        2019:
                                                                                                                                        ['S'],
                                                                                                                                        2020:
                                                                                                                                        ['S'],
                                                                                                                                        2021:
                                                                                                                                        ['S'],
                                                                                                                                        2022:
                                                                                                                                        ['S'],
                                                                                                                                        2023:
                                                                                                                                        ['S'],
                                                                                                                                        2024:
                                                                                                                                        ['S'],
                                                                                                                                        2025:
                                                                                                                                        ['S']
                                                                                                                                        },
                                                                                                                                        "Honda":
                                                                                                                                        {
                                                                                                                                        1995:
                                                                                                                                        ['M'],
                                                                                                                                        1996:
                                                                                                                                        ['M'],
                                                                                                                                        1997:
                                                                                                                                        ['M'],
                                                                                                                                        1998:
                                                                                                                                        ['M'],
                                                                                                                                        1999:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        2000:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        2001:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        2002:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        2003:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        2004:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        2005:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        2006:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        2007:
                                                                                                                                        ['R',
                                                                                                                                        'T',
                                                                                                                                        'M'],
                                                                                                                                        2008:
                                                                                                                                        ['R',
                                                                                                                                        'T',
                                                                                                                                        'M'],
                                                                                                                                        2009:
                                                                                                                                        ['R',
                                                                                                                                        'T',
                                                                                                                                        'M'],
                                                                                                                                        2010:
                                                                                                                                        ['R',
                                                                                                                                        'T',
                                                                                                                                        'M'],
                                                                                                                                        2011:
                                                                                                                                        ['R',
                                                                                                                                        'T',
                                                                                                                                        'M'],
                                                                                                                                        2012:
                                                                                                                                        ['S',
                                                                                                                                        'R',
                                                                                                                                        'T'],
                                                                                                                                        2013:
                                                                                                                                        ['S',
                                                                                                                                        'R',
                                                                                                                                        'T'],
                                                                                                                                        2014:
                                                                                                                                        ['S',
                                                                                                                                        'R',
                                                                                                                                        'T'],
                                                                                                                                        2015:
                                                                                                                                        ['S',
                                                                                                                                        'R',
                                                                                                                                        'T'],
                                                                                                                                        2016:
                                                                                                                                        ['S',
                                                                                                                                        'R',
                                                                                                                                        'T'],
                                                                                                                                        2017:
                                                                                                                                        ['S',
                                                                                                                                        'R',
                                                                                                                                        'T'],
                                                                                                                                        2018:
                                                                                                                                        ['S',
                                                                                                                                        'R'],
                                                                                                                                        2019:
                                                                                                                                        ['S',
                                                                                                                                        'R'],
                                                                                                                                        2020:
                                                                                                                                        ['S',
                                                                                                                                        'R'],
                                                                                                                                        2021:
                                                                                                                                        ['S'],
                                                                                                                                        2022:
                                                                                                                                        ['S'],
                                                                                                                                        2023:
                                                                                                                                        ['S'],
                                                                                                                                        2024:
                                                                                                                                        ['S'],
                                                                                                                                        2025:
                                                                                                                                        ['S']
                                                                                                                                        },
                                                                                                                                        "Nissan":
                                                                                                                                        {
                                                                                                                                        1995:
                                                                                                                                        ['M'],
                                                                                                                                        1996:
                                                                                                                                        ['M'],
                                                                                                                                        1997:
                                                                                                                                        ['M'],
                                                                                                                                        1998:
                                                                                                                                        ['M'],
                                                                                                                                        1999:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        2000:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        2001:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        2002:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        2003:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        2004:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        2005:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        2006:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        2007:
                                                                                                                                        ['S',
                                                                                                                                        'T',
                                                                                                                                        'M'],
                                                                                                                                        2008:
                                                                                                                                        ['S',
                                                                                                                                        'T'],
                                                                                                                                        2009:
                                                                                                                                        ['S',
                                                                                                                                        'T'],
                                                                                                                                        2010:
                                                                                                                                        ['S',
                                                                                                                                        'T'],
                                                                                                                                        2011:
                                                                                                                                        ['S',
                                                                                                                                        'T'],
                                                                                                                                        2012:
                                                                                                                                        ['S',
                                                                                                                                        'T'],
                                                                                                                                        2013:
                                                                                                                                        ['S',
                                                                                                                                        'T'],
                                                                                                                                        2014:
                                                                                                                                        ['S',
                                                                                                                                        'T'],
                                                                                                                                        2015:
                                                                                                                                        ['S',
                                                                                                                                        'T'],
                                                                                                                                        2016:
                                                                                                                                        ['S',
                                                                                                                                        'T'],
                                                                                                                                        2017:
                                                                                                                                        ['S',
                                                                                                                                        'T'],
                                                                                                                                        2018:
                                                                                                                                        ['S',
                                                                                                                                        'T'],
                                                                                                                                        2019:
                                                                                                                                        ['S'],
                                                                                                                                        2020:
                                                                                                                                        ['S'],
                                                                                                                                        2021:
                                                                                                                                        ['S'],
                                                                                                                                        2022:
                                                                                                                                        ['S'],
                                                                                                                                        2023:
                                                                                                                                        ['S'],
                                                                                                                                        2024:
                                                                                                                                        ['S'],
                                                                                                                                        2025:
                                                                                                                                        ['S']
                                                                                                                                        },
                                                                                                                                        "Mazda":
                                                                                                                                        {
                                                                                                                                        1995:
                                                                                                                                        ['M'],
                                                                                                                                        1996:
                                                                                                                                        ['M'],
                                                                                                                                        1997:
                                                                                                                                        ['M'],
                                                                                                                                        1998:
                                                                                                                                        ['M'],
                                                                                                                                        1999:
                                                                                                                                        ['M'],
                                                                                                                                        2000:
                                                                                                                                        ['M'],
                                                                                                                                        2001:
                                                                                                                                        ['M'],
                                                                                                                                        2002:
                                                                                                                                        ['M'],
                                                                                                                                        2003:
                                                                                                                                        ['M'],
                                                                                                                                        2004:
                                                                                                                                        ['M'],
                                                                                                                                        2005:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        2006:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        2007:
                                                                                                                                        ['F',
                                                                                                                                        'T',
                                                                                                                                        'M'],
                                                                                                                                        2008:
                                                                                                                                        ['F',
                                                                                                                                        'T',
                                                                                                                                        'M'],
                                                                                                                                        2009:
                                                                                                                                        ['F',
                                                                                                                                        'T',
                                                                                                                                        'M'],
                                                                                                                                        2010:
                                                                                                                                        ['F',
                                                                                                                                        'T',
                                                                                                                                        'M'],
                                                                                                                                        2011:
                                                                                                                                        ['F',
                                                                                                                                        'T',
                                                                                                                                        'M'],
                                                                                                                                        2012:
                                                                                                                                        ['F',
                                                                                                                                        'T',
                                                                                                                                        'M'],
                                                                                                                                        2013:
                                                                                                                                        ['S',
                                                                                                                                        'F',
                                                                                                                                        'T'],
                                                                                                                                        2014:
                                                                                                                                        ['S',
                                                                                                                                        'F',
                                                                                                                                        'T'],
                                                                                                                                        2015:
                                                                                                                                        ['S',
                                                                                                                                        'F',
                                                                                                                                        'T'],
                                                                                                                                        2016:
                                                                                                                                        ['S',
                                                                                                                                        'F'],
                                                                                                                                        2017:
                                                                                                                                        ['S',
                                                                                                                                        'F'],
                                                                                                                                        2018:
                                                                                                                                        ['S',
                                                                                                                                        'F'],
                                                                                                                                        2019:
                                                                                                                                        ['S'],
                                                                                                                                        2020:
                                                                                                                                        ['S'],
                                                                                                                                        2021:
                                                                                                                                        ['S'],
                                                                                                                                        2022:
                                                                                                                                        ['S'],
                                                                                                                                        2023:
                                                                                                                                        ['S'],
                                                                                                                                        2024:
                                                                                                                                        ['S'],
                                                                                                                                        2025:
                                                                                                                                        ['S']
                                                                                                                                        },
                                                                                                                                        "Subaru":
                                                                                                                                        {
                                                                                                                                        1995:
                                                                                                                                        ['M'],
                                                                                                                                        1996:
                                                                                                                                        ['M'],
                                                                                                                                        1997:
                                                                                                                                        ['M'],
                                                                                                                                        1998:
                                                                                                                                        ['M'],
                                                                                                                                        1999:
                                                                                                                                        ['M'],
                                                                                                                                        2000:
                                                                                                                                        ['M'],
                                                                                                                                        2001:
                                                                                                                                        ['M'],
                                                                                                                                        2002:
                                                                                                                                        ['M'],
                                                                                                                                        2003:
                                                                                                                                        ['M'],
                                                                                                                                        2004:
                                                                                                                                        ['M'],
                                                                                                                                        2005:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        2006:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        2007:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        2008:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        2009:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        2010:
                                                                                                                                        ['R',
                                                                                                                                        'T',
                                                                                                                                        'M'],
                                                                                                                                        2011:
                                                                                                                                        ['R',
                                                                                                                                        'T',
                                                                                                                                        'M'],
                                                                                                                                        2012:
                                                                                                                                        ['R',
                                                                                                                                        'T',
                                                                                                                                        'M'],
                                                                                                                                        2013:
                                                                                                                                        ['R',
                                                                                                                                        'T',
                                                                                                                                        'M'],
                                                                                                                                        2014:
                                                                                                                                        ['S',
                                                                                                                                        'R',
                                                                                                                                        'T'],
                                                                                                                                        2015:
                                                                                                                                        ['S',
                                                                                                                                        'R',
                                                                                                                                        'T'],
                                                                                                                                        2016:
                                                                                                                                        ['S',
                                                                                                                                        'R'],
                                                                                                                                        2017:
                                                                                                                                        ['S',
                                                                                                                                        'R'],
                                                                                                                                        2018:
                                                                                                                                        ['S',
                                                                                                                                        'R'],
                                                                                                                                        2019:
                                                                                                                                        ['S'],
                                                                                                                                        2020:
                                                                                                                                        ['S'],
                                                                                                                                        2021:
                                                                                                                                        ['S'],
                                                                                                                                        2022:
                                                                                                                                        ['S'],
                                                                                                                                        2023:
                                                                                                                                        ['S'],
                                                                                                                                        2024:
                                                                                                                                        ['S'],
                                                                                                                                        2025:
                                                                                                                                        ['S']
                                                                                                                                        },
                                                                                                                                        //
                                                                                                                                        American
                                                                                                                                        "Ford":
                                                                                                                                        {
                                                                                                                                        1995:
                                                                                                                                        ['M'],
                                                                                                                                        1996:
                                                                                                                                        ['M'],
                                                                                                                                        1997:
                                                                                                                                        ['M'],
                                                                                                                                        1998:
                                                                                                                                        ['M'],
                                                                                                                                        1999:
                                                                                                                                        ['M'],
                                                                                                                                        2000:
                                                                                                                                        ['M'],
                                                                                                                                        2001:
                                                                                                                                        ['M'],
                                                                                                                                        2002:
                                                                                                                                        ['M'],
                                                                                                                                        2003:
                                                                                                                                        ['M'],
                                                                                                                                        2004:
                                                                                                                                        ['M'],
                                                                                                                                        2005:
                                                                                                                                        ['R',
                                                                                                                                        'T',
                                                                                                                                        'M'],
                                                                                                                                        2006:
                                                                                                                                        ['R',
                                                                                                                                        'T',
                                                                                                                                        'M'],
                                                                                                                                        2007:
                                                                                                                                        ['R',
                                                                                                                                        'T',
                                                                                                                                        'M'],
                                                                                                                                        2008:
                                                                                                                                        ['R',
                                                                                                                                        'T',
                                                                                                                                        'M'],
                                                                                                                                        2009:
                                                                                                                                        ['R',
                                                                                                                                        'T',
                                                                                                                                        'M'],
                                                                                                                                        2010:
                                                                                                                                        ['R',
                                                                                                                                        'T',
                                                                                                                                        'M'],
                                                                                                                                        2011:
                                                                                                                                        ['R',
                                                                                                                                        'T',
                                                                                                                                        'M'],
                                                                                                                                        2012:
                                                                                                                                        ['R',
                                                                                                                                        'T',
                                                                                                                                        'M'],
                                                                                                                                        2013:
                                                                                                                                        ['S',
                                                                                                                                        'R',
                                                                                                                                        'T'],
                                                                                                                                        2014:
                                                                                                                                        ['S',
                                                                                                                                        'R',
                                                                                                                                        'T'],
                                                                                                                                        2015:
                                                                                                                                        ['S',
                                                                                                                                        'R',
                                                                                                                                        'T'],
                                                                                                                                        2016:
                                                                                                                                        ['S',
                                                                                                                                        'R'],
                                                                                                                                        2017:
                                                                                                                                        ['S',
                                                                                                                                        'R'],
                                                                                                                                        2018:
                                                                                                                                        ['S',
                                                                                                                                        'R'],
                                                                                                                                        2019:
                                                                                                                                        ['S'],
                                                                                                                                        2020:
                                                                                                                                        ['S'],
                                                                                                                                        2021:
                                                                                                                                        ['S'],
                                                                                                                                        2022:
                                                                                                                                        ['S'],
                                                                                                                                        2023:
                                                                                                                                        ['S'],
                                                                                                                                        2024:
                                                                                                                                        ['S'],
                                                                                                                                        2025:
                                                                                                                                        ['S']
                                                                                                                                        },
                                                                                                                                        "Chevrolet":
                                                                                                                                        {
                                                                                                                                        1995:
                                                                                                                                        ['M'],
                                                                                                                                        1996:
                                                                                                                                        ['M'],
                                                                                                                                        1997:
                                                                                                                                        ['M'],
                                                                                                                                        1998:
                                                                                                                                        ['M'],
                                                                                                                                        1999:
                                                                                                                                        ['M'],
                                                                                                                                        2000:
                                                                                                                                        ['M'],
                                                                                                                                        2001:
                                                                                                                                        ['M'],
                                                                                                                                        2002:
                                                                                                                                        ['M'],
                                                                                                                                        2003:
                                                                                                                                        ['M'],
                                                                                                                                        2004:
                                                                                                                                        ['M'],
                                                                                                                                        2005:
                                                                                                                                        ['M'],
                                                                                                                                        2006:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        2007:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        2008:
                                                                                                                                        ['R',
                                                                                                                                        'T',
                                                                                                                                        'M'],
                                                                                                                                        2009:
                                                                                                                                        ['R',
                                                                                                                                        'T',
                                                                                                                                        'M'],
                                                                                                                                        2010:
                                                                                                                                        ['F',
                                                                                                                                        'R',
                                                                                                                                        'T'],
                                                                                                                                        2011:
                                                                                                                                        ['F',
                                                                                                                                        'R',
                                                                                                                                        'T'],
                                                                                                                                        2012:
                                                                                                                                        ['F',
                                                                                                                                        'R',
                                                                                                                                        'T'],
                                                                                                                                        2013:
                                                                                                                                        ['F',
                                                                                                                                        'R',
                                                                                                                                        'T'],
                                                                                                                                        2014:
                                                                                                                                        ['S',
                                                                                                                                        'F',
                                                                                                                                        'R'],
                                                                                                                                        2015:
                                                                                                                                        ['S',
                                                                                                                                        'F',
                                                                                                                                        'R'],
                                                                                                                                        2016:
                                                                                                                                        ['S',
                                                                                                                                        'F'],
                                                                                                                                        2017:
                                                                                                                                        ['S',
                                                                                                                                        'F'],
                                                                                                                                        2018:
                                                                                                                                        ['S',
                                                                                                                                        'F'],
                                                                                                                                        2019:
                                                                                                                                        ['S'],
                                                                                                                                        2020:
                                                                                                                                        ['S'],
                                                                                                                                        2021:
                                                                                                                                        ['S'],
                                                                                                                                        2022:
                                                                                                                                        ['S'],
                                                                                                                                        2023:
                                                                                                                                        ['S'],
                                                                                                                                        2024:
                                                                                                                                        ['S'],
                                                                                                                                        2025:
                                                                                                                                        ['S']
                                                                                                                                        },
                                                                                                                                        "Dodge":
                                                                                                                                        {
                                                                                                                                        1995:
                                                                                                                                        ['M'],
                                                                                                                                        1996:
                                                                                                                                        ['M'],
                                                                                                                                        1997:
                                                                                                                                        ['M'],
                                                                                                                                        1998:
                                                                                                                                        ['M'],
                                                                                                                                        1999:
                                                                                                                                        ['M'],
                                                                                                                                        2000:
                                                                                                                                        ['M'],
                                                                                                                                        2001:
                                                                                                                                        ['M'],
                                                                                                                                        2002:
                                                                                                                                        ['M'],
                                                                                                                                        2003:
                                                                                                                                        ['M'],
                                                                                                                                        2004:
                                                                                                                                        ['M'],
                                                                                                                                        2005:
                                                                                                                                        ['M'],
                                                                                                                                        2006:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        2007:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        2008:
                                                                                                                                        ['R',
                                                                                                                                        'T',
                                                                                                                                        'M'],
                                                                                                                                        2009:
                                                                                                                                        ['R',
                                                                                                                                        'T',
                                                                                                                                        'M'],
                                                                                                                                        2010:
                                                                                                                                        ['R',
                                                                                                                                        'T',
                                                                                                                                        'M'],
                                                                                                                                        2011:
                                                                                                                                        ['S',
                                                                                                                                        'R',
                                                                                                                                        'T'],
                                                                                                                                        2012:
                                                                                                                                        ['S',
                                                                                                                                        'R',
                                                                                                                                        'T'],
                                                                                                                                        2013:
                                                                                                                                        ['S',
                                                                                                                                        'R'],
                                                                                                                                        2014:
                                                                                                                                        ['S',
                                                                                                                                        'R'],
                                                                                                                                        2015:
                                                                                                                                        ['S',
                                                                                                                                        'R'],
                                                                                                                                        2016:
                                                                                                                                        ['S'],
                                                                                                                                        2017:
                                                                                                                                        ['S'],
                                                                                                                                        2018:
                                                                                                                                        ['S'],
                                                                                                                                        2019:
                                                                                                                                        ['S'],
                                                                                                                                        2020:
                                                                                                                                        ['S'],
                                                                                                                                        2021:
                                                                                                                                        ['S'],
                                                                                                                                        2022:
                                                                                                                                        ['S'],
                                                                                                                                        2023:
                                                                                                                                        ['S'],
                                                                                                                                        2024:
                                                                                                                                        ['S'],
                                                                                                                                        2025:
                                                                                                                                        ['S']
                                                                                                                                        },
                                                                                                                                        "Jeep":
                                                                                                                                        {
                                                                                                                                        1995:
                                                                                                                                        ['M'],
                                                                                                                                        1996:
                                                                                                                                        ['M'],
                                                                                                                                        1997:
                                                                                                                                        ['M'],
                                                                                                                                        1998:
                                                                                                                                        ['M'],
                                                                                                                                        1999:
                                                                                                                                        ['M'],
                                                                                                                                        2000:
                                                                                                                                        ['M'],
                                                                                                                                        2001:
                                                                                                                                        ['M'],
                                                                                                                                        2002:
                                                                                                                                        ['M'],
                                                                                                                                        2003:
                                                                                                                                        ['M'],
                                                                                                                                        2004:
                                                                                                                                        ['M'],
                                                                                                                                        2005:
                                                                                                                                        ['M'],
                                                                                                                                        2006:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        2007:
                                                                                                                                        ['R',
                                                                                                                                        'T',
                                                                                                                                        'M'],
                                                                                                                                        2008:
                                                                                                                                        ['R',
                                                                                                                                        'T',
                                                                                                                                        'M'],
                                                                                                                                        2009:
                                                                                                                                        ['R',
                                                                                                                                        'T',
                                                                                                                                        'M'],
                                                                                                                                        2010:
                                                                                                                                        ['R',
                                                                                                                                        'T',
                                                                                                                                        'M'],
                                                                                                                                        2011:
                                                                                                                                        ['R',
                                                                                                                                        'T',
                                                                                                                                        'M'],
                                                                                                                                        2012:
                                                                                                                                        ['R',
                                                                                                                                        'T',
                                                                                                                                        'M'],
                                                                                                                                        2013:
                                                                                                                                        ['S',
                                                                                                                                        'R',
                                                                                                                                        'T'],
                                                                                                                                        2014:
                                                                                                                                        ['S',
                                                                                                                                        'R',
                                                                                                                                        'T'],
                                                                                                                                        2015:
                                                                                                                                        ['S',
                                                                                                                                        'R'],
                                                                                                                                        2016:
                                                                                                                                        ['S',
                                                                                                                                        'R'],
                                                                                                                                        2017:
                                                                                                                                        ['S',
                                                                                                                                        'R'],
                                                                                                                                        2018:
                                                                                                                                        ['S'],
                                                                                                                                        2019:
                                                                                                                                        ['S'],
                                                                                                                                        2020:
                                                                                                                                        ['S'],
                                                                                                                                        2021:
                                                                                                                                        ['S'],
                                                                                                                                        2022:
                                                                                                                                        ['S'],
                                                                                                                                        2023:
                                                                                                                                        ['S'],
                                                                                                                                        2024:
                                                                                                                                        ['S'],
                                                                                                                                        2025:
                                                                                                                                        ['S']
                                                                                                                                        },
                                                                                                                                        //
                                                                                                                                        German
                                                                                                                                        "BMW":
                                                                                                                                        {
                                                                                                                                        1995:
                                                                                                                                        ['M'],
                                                                                                                                        1996:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        1997:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        1998:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        1999:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        2000:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        2001:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        2002:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        2003:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        2004:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        2005:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        2006:
                                                                                                                                        ['S',
                                                                                                                                        'T'],
                                                                                                                                        2007:
                                                                                                                                        ['S',
                                                                                                                                        'T'],
                                                                                                                                        2008:
                                                                                                                                        ['S',
                                                                                                                                        'T'],
                                                                                                                                        2009:
                                                                                                                                        ['S',
                                                                                                                                        'T'],
                                                                                                                                        2010:
                                                                                                                                        ['S',
                                                                                                                                        'T'],
                                                                                                                                        2011:
                                                                                                                                        ['S',
                                                                                                                                        'T'],
                                                                                                                                        2012:
                                                                                                                                        ['S',
                                                                                                                                        'T'],
                                                                                                                                        2013:
                                                                                                                                        ['S',
                                                                                                                                        'T'],
                                                                                                                                        2014:
                                                                                                                                        ['S'],
                                                                                                                                        2015:
                                                                                                                                        ['S'],
                                                                                                                                        2016:
                                                                                                                                        ['S'],
                                                                                                                                        2017:
                                                                                                                                        ['S'],
                                                                                                                                        2018:
                                                                                                                                        ['S'],
                                                                                                                                        2019:
                                                                                                                                        ['S'],
                                                                                                                                        2020:
                                                                                                                                        ['S'],
                                                                                                                                        2021:
                                                                                                                                        ['S'],
                                                                                                                                        2022:
                                                                                                                                        ['S'],
                                                                                                                                        2023:
                                                                                                                                        ['S'],
                                                                                                                                        2024:
                                                                                                                                        ['S'],
                                                                                                                                        2025:
                                                                                                                                        ['S']
                                                                                                                                        },
                                                                                                                                        "Mercedes":
                                                                                                                                        {
                                                                                                                                        1995:
                                                                                                                                        ['M'],
                                                                                                                                        1996:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        1997:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        1998:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        1999:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        2000:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        2001:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        2002:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        2003:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        2004:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        2005:
                                                                                                                                        ['S',
                                                                                                                                        'T'],
                                                                                                                                        2006:
                                                                                                                                        ['S',
                                                                                                                                        'T'],
                                                                                                                                        2007:
                                                                                                                                        ['S',
                                                                                                                                        'T'],
                                                                                                                                        2008:
                                                                                                                                        ['S',
                                                                                                                                        'T'],
                                                                                                                                        2009:
                                                                                                                                        ['S',
                                                                                                                                        'T'],
                                                                                                                                        2010:
                                                                                                                                        ['S',
                                                                                                                                        'T'],
                                                                                                                                        2011:
                                                                                                                                        ['S',
                                                                                                                                        'T'],
                                                                                                                                        2012:
                                                                                                                                        ['S'],
                                                                                                                                        2013:
                                                                                                                                        ['S'],
                                                                                                                                        2014:
                                                                                                                                        ['S'],
                                                                                                                                        2015:
                                                                                                                                        ['S'],
                                                                                                                                        2016:
                                                                                                                                        ['S'],
                                                                                                                                        2017:
                                                                                                                                        ['S'],
                                                                                                                                        2018:
                                                                                                                                        ['S'],
                                                                                                                                        2019:
                                                                                                                                        ['S'],
                                                                                                                                        2020:
                                                                                                                                        ['S'],
                                                                                                                                        2021:
                                                                                                                                        ['S'],
                                                                                                                                        2022:
                                                                                                                                        ['S'],
                                                                                                                                        2023:
                                                                                                                                        ['S'],
                                                                                                                                        2024:
                                                                                                                                        ['S'],
                                                                                                                                        2025:
                                                                                                                                        ['S']
                                                                                                                                        },
                                                                                                                                        "Volkswagen":
                                                                                                                                        {
                                                                                                                                        1995:
                                                                                                                                        ['M'],
                                                                                                                                        1996:
                                                                                                                                        ['M'],
                                                                                                                                        1997:
                                                                                                                                        ['M'],
                                                                                                                                        1998:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        1999:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        2000:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        2001:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        2002:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        2003:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        2004:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        2005:
                                                                                                                                        ['F',
                                                                                                                                        'T',
                                                                                                                                        'M'],
                                                                                                                                        2006:
                                                                                                                                        ['F',
                                                                                                                                        'T',
                                                                                                                                        'M'],
                                                                                                                                        2007:
                                                                                                                                        ['F',
                                                                                                                                        'T',
                                                                                                                                        'M'],
                                                                                                                                        2008:
                                                                                                                                        ['F',
                                                                                                                                        'T',
                                                                                                                                        'M'],
                                                                                                                                        2009:
                                                                                                                                        ['F',
                                                                                                                                        'T',
                                                                                                                                        'M'],
                                                                                                                                        2010:
                                                                                                                                        ['F',
                                                                                                                                        'T',
                                                                                                                                        'M'],
                                                                                                                                        2011:
                                                                                                                                        ['F',
                                                                                                                                        'T'],
                                                                                                                                        2012:
                                                                                                                                        ['S',
                                                                                                                                        'F',
                                                                                                                                        'T'],
                                                                                                                                        2013:
                                                                                                                                        ['S',
                                                                                                                                        'F',
                                                                                                                                        'T'],
                                                                                                                                        2014:
                                                                                                                                        ['S',
                                                                                                                                        'F'],
                                                                                                                                        2015:
                                                                                                                                        ['S',
                                                                                                                                        'F'],
                                                                                                                                        2016:
                                                                                                                                        ['S',
                                                                                                                                        'F'],
                                                                                                                                        2017:
                                                                                                                                        ['S'],
                                                                                                                                        2018:
                                                                                                                                        ['S'],
                                                                                                                                        2019:
                                                                                                                                        ['S'],
                                                                                                                                        2020:
                                                                                                                                        ['S'],
                                                                                                                                        2021:
                                                                                                                                        ['S'],
                                                                                                                                        2022:
                                                                                                                                        ['S'],
                                                                                                                                        2023:
                                                                                                                                        ['S'],
                                                                                                                                        2024:
                                                                                                                                        ['S'],
                                                                                                                                        2025:
                                                                                                                                        ['S']
                                                                                                                                        },
                                                                                                                                        //
                                                                                                                                        Korean
                                                                                                                                        "Hyundai":
                                                                                                                                        {
                                                                                                                                        1995:
                                                                                                                                        ['M'],
                                                                                                                                        1996:
                                                                                                                                        ['M'],
                                                                                                                                        1997:
                                                                                                                                        ['M'],
                                                                                                                                        1998:
                                                                                                                                        ['M'],
                                                                                                                                        1999:
                                                                                                                                        ['M'],
                                                                                                                                        2000:
                                                                                                                                        ['M'],
                                                                                                                                        2001:
                                                                                                                                        ['M'],
                                                                                                                                        2002:
                                                                                                                                        ['M'],
                                                                                                                                        2003:
                                                                                                                                        ['M'],
                                                                                                                                        2004:
                                                                                                                                        ['M'],
                                                                                                                                        2005:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        2006:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        2007:
                                                                                                                                        ['F',
                                                                                                                                        'T',
                                                                                                                                        'M'],
                                                                                                                                        2008:
                                                                                                                                        ['F',
                                                                                                                                        'T',
                                                                                                                                        'M'],
                                                                                                                                        2009:
                                                                                                                                        ['F',
                                                                                                                                        'T',
                                                                                                                                        'M'],
                                                                                                                                        2010:
                                                                                                                                        ['F',
                                                                                                                                        'T',
                                                                                                                                        'M'],
                                                                                                                                        2011:
                                                                                                                                        ['F',
                                                                                                                                        'T',
                                                                                                                                        'M'],
                                                                                                                                        2012:
                                                                                                                                        ['S',
                                                                                                                                        'F',
                                                                                                                                        'T'],
                                                                                                                                        2013:
                                                                                                                                        ['S',
                                                                                                                                        'F',
                                                                                                                                        'T'],
                                                                                                                                        2014:
                                                                                                                                        ['S',
                                                                                                                                        'F'],
                                                                                                                                        2015:
                                                                                                                                        ['S',
                                                                                                                                        'F'],
                                                                                                                                        2016:
                                                                                                                                        ['S',
                                                                                                                                        'F'],
                                                                                                                                        2017:
                                                                                                                                        ['S'],
                                                                                                                                        2018:
                                                                                                                                        ['S'],
                                                                                                                                        2019:
                                                                                                                                        ['S'],
                                                                                                                                        2020:
                                                                                                                                        ['S'],
                                                                                                                                        2021:
                                                                                                                                        ['S'],
                                                                                                                                        2022:
                                                                                                                                        ['S'],
                                                                                                                                        2023:
                                                                                                                                        ['S'],
                                                                                                                                        2024:
                                                                                                                                        ['S'],
                                                                                                                                        2025:
                                                                                                                                        ['S']
                                                                                                                                        },
                                                                                                                                        "Kia":
                                                                                                                                        {
                                                                                                                                        1995:
                                                                                                                                        ['M'],
                                                                                                                                        1996:
                                                                                                                                        ['M'],
                                                                                                                                        1997:
                                                                                                                                        ['M'],
                                                                                                                                        1998:
                                                                                                                                        ['M'],
                                                                                                                                        1999:
                                                                                                                                        ['M'],
                                                                                                                                        2000:
                                                                                                                                        ['M'],
                                                                                                                                        2001:
                                                                                                                                        ['M'],
                                                                                                                                        2002:
                                                                                                                                        ['M'],
                                                                                                                                        2003:
                                                                                                                                        ['M'],
                                                                                                                                        2004:
                                                                                                                                        ['M'],
                                                                                                                                        2005:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        2006:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        2007:
                                                                                                                                        ['F',
                                                                                                                                        'T',
                                                                                                                                        'M'],
                                                                                                                                        2008:
                                                                                                                                        ['F',
                                                                                                                                        'T',
                                                                                                                                        'M'],
                                                                                                                                        2009:
                                                                                                                                        ['F',
                                                                                                                                        'T',
                                                                                                                                        'M'],
                                                                                                                                        2010:
                                                                                                                                        ['F',
                                                                                                                                        'T',
                                                                                                                                        'M'],
                                                                                                                                        2011:
                                                                                                                                        ['F',
                                                                                                                                        'T',
                                                                                                                                        'M'],
                                                                                                                                        2012:
                                                                                                                                        ['S',
                                                                                                                                        'F',
                                                                                                                                        'T'],
                                                                                                                                        2013:
                                                                                                                                        ['S',
                                                                                                                                        'F',
                                                                                                                                        'T'],
                                                                                                                                        2014:
                                                                                                                                        ['S',
                                                                                                                                        'F'],
                                                                                                                                        2015:
                                                                                                                                        ['S',
                                                                                                                                        'F'],
                                                                                                                                        2016:
                                                                                                                                        ['S',
                                                                                                                                        'F'],
                                                                                                                                        2017:
                                                                                                                                        ['S'],
                                                                                                                                        2018:
                                                                                                                                        ['S'],
                                                                                                                                        2019:
                                                                                                                                        ['S'],
                                                                                                                                        2020:
                                                                                                                                        ['S'],
                                                                                                                                        2021:
                                                                                                                                        ['S'],
                                                                                                                                        2022:
                                                                                                                                        ['S'],
                                                                                                                                        2023:
                                                                                                                                        ['S'],
                                                                                                                                        2024:
                                                                                                                                        ['S'],
                                                                                                                                        2025:
                                                                                                                                        ['S']
                                                                                                                                        },
                                                                                                                                        "Acura":
                                                                                                                                        {
                                                                                                                                        1995:
                                                                                                                                        ['M'],
                                                                                                                                        1996:
                                                                                                                                        ['M'],
                                                                                                                                        1997:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        1998:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        1999:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        2000:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        2001:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        2002:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        2003:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        2004:
                                                                                                                                        ['S',
                                                                                                                                        'T',
                                                                                                                                        'M'],
                                                                                                                                        2005:
                                                                                                                                        ['S',
                                                                                                                                        'T'],
                                                                                                                                        2006:
                                                                                                                                        ['S',
                                                                                                                                        'T'],
                                                                                                                                        2007:
                                                                                                                                        ['S',
                                                                                                                                        'T'],
                                                                                                                                        2008:
                                                                                                                                        ['S',
                                                                                                                                        'T'],
                                                                                                                                        2009:
                                                                                                                                        ['S',
                                                                                                                                        'T'],
                                                                                                                                        2010:
                                                                                                                                        ['S',
                                                                                                                                        'T'],
                                                                                                                                        2011:
                                                                                                                                        ['S',
                                                                                                                                        'T'],
                                                                                                                                        2012:
                                                                                                                                        ['S',
                                                                                                                                        'T'],
                                                                                                                                        2013:
                                                                                                                                        ['S'],
                                                                                                                                        2014:
                                                                                                                                        ['S'],
                                                                                                                                        2015:
                                                                                                                                        ['S'],
                                                                                                                                        2016:
                                                                                                                                        ['S'],
                                                                                                                                        2017:
                                                                                                                                        ['S'],
                                                                                                                                        2018:
                                                                                                                                        ['S'],
                                                                                                                                        2019:
                                                                                                                                        ['S'],
                                                                                                                                        2020:
                                                                                                                                        ['S'],
                                                                                                                                        2021:
                                                                                                                                        ['S'],
                                                                                                                                        2022:
                                                                                                                                        ['S'],
                                                                                                                                        2023:
                                                                                                                                        ['S'],
                                                                                                                                        2024:
                                                                                                                                        ['S'],
                                                                                                                                        2025:
                                                                                                                                        ['S']
                                                                                                                                        },
                                                                                                                                        "Audi":
                                                                                                                                        {
                                                                                                                                        1995:
                                                                                                                                        ['M'],
                                                                                                                                        1996:
                                                                                                                                        ['M'],
                                                                                                                                        1997:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        1998:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        1999:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        2000:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        2001:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        2002:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        2003:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        2004:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        2005:
                                                                                                                                        ['F',
                                                                                                                                        'T',
                                                                                                                                        'M'],
                                                                                                                                        2006:
                                                                                                                                        ['F',
                                                                                                                                        'T',
                                                                                                                                        'M'],
                                                                                                                                        2007:
                                                                                                                                        ['F',
                                                                                                                                        'T',
                                                                                                                                        'M'],
                                                                                                                                        2008:
                                                                                                                                        ['F',
                                                                                                                                        'T',
                                                                                                                                        'M'],
                                                                                                                                        2009:
                                                                                                                                        ['F',
                                                                                                                                        'T',
                                                                                                                                        'M'],
                                                                                                                                        2010:
                                                                                                                                        ['F',
                                                                                                                                        'T',
                                                                                                                                        'M'],
                                                                                                                                        2011:
                                                                                                                                        ['F',
                                                                                                                                        'T'],
                                                                                                                                        2012:
                                                                                                                                        ['S',
                                                                                                                                        'F',
                                                                                                                                        'T'],
                                                                                                                                        2013:
                                                                                                                                        ['S',
                                                                                                                                        'F'],
                                                                                                                                        2014:
                                                                                                                                        ['S',
                                                                                                                                        'F'],
                                                                                                                                        2015:
                                                                                                                                        ['S'],
                                                                                                                                        2016:
                                                                                                                                        ['S'],
                                                                                                                                        2017:
                                                                                                                                        ['S'],
                                                                                                                                        2018:
                                                                                                                                        ['S'],
                                                                                                                                        2019:
                                                                                                                                        ['S'],
                                                                                                                                        2020:
                                                                                                                                        ['S'],
                                                                                                                                        2021:
                                                                                                                                        ['S'],
                                                                                                                                        2022:
                                                                                                                                        ['S'],
                                                                                                                                        2023:
                                                                                                                                        ['S'],
                                                                                                                                        2024:
                                                                                                                                        ['S'],
                                                                                                                                        2025:
                                                                                                                                        ['S']
                                                                                                                                        },
                                                                                                                                        "Buick":
                                                                                                                                        {
                                                                                                                                        1995:
                                                                                                                                        ['M'],
                                                                                                                                        1996:
                                                                                                                                        ['M'],
                                                                                                                                        1997:
                                                                                                                                        ['M'],
                                                                                                                                        1998:
                                                                                                                                        ['M'],
                                                                                                                                        1999:
                                                                                                                                        ['M'],
                                                                                                                                        2000:
                                                                                                                                        ['M'],
                                                                                                                                        2001:
                                                                                                                                        ['M'],
                                                                                                                                        2002:
                                                                                                                                        ['M'],
                                                                                                                                        2003:
                                                                                                                                        ['M'],
                                                                                                                                        2004:
                                                                                                                                        ['M'],
                                                                                                                                        2005:
                                                                                                                                        ['M'],
                                                                                                                                        2006:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        2007:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        2008:
                                                                                                                                        ['R',
                                                                                                                                        'T',
                                                                                                                                        'M'],
                                                                                                                                        2009:
                                                                                                                                        ['R',
                                                                                                                                        'T',
                                                                                                                                        'M'],
                                                                                                                                        2010:
                                                                                                                                        ['R',
                                                                                                                                        'T'],
                                                                                                                                        2011:
                                                                                                                                        ['R',
                                                                                                                                        'T'],
                                                                                                                                        2012:
                                                                                                                                        ['S',
                                                                                                                                        'R'],
                                                                                                                                        2013:
                                                                                                                                        ['S',
                                                                                                                                        'R'],
                                                                                                                                        2014:
                                                                                                                                        ['S'],
                                                                                                                                        2015:
                                                                                                                                        ['S'],
                                                                                                                                        2016:
                                                                                                                                        ['S'],
                                                                                                                                        2017:
                                                                                                                                        ['S'],
                                                                                                                                        2018:
                                                                                                                                        ['S'],
                                                                                                                                        2019:
                                                                                                                                        ['S'],
                                                                                                                                        2020:
                                                                                                                                        ['S'],
                                                                                                                                        2021:
                                                                                                                                        ['S'],
                                                                                                                                        2022:
                                                                                                                                        ['S'],
                                                                                                                                        2023:
                                                                                                                                        ['S'],
                                                                                                                                        2024:
                                                                                                                                        ['S'],
                                                                                                                                        2025:
                                                                                                                                        ['S']
                                                                                                                                        },
                                                                                                                                        "Cadillac":
                                                                                                                                        {
                                                                                                                                        1995:
                                                                                                                                        ['M'],
                                                                                                                                        1996:
                                                                                                                                        ['M'],
                                                                                                                                        1997:
                                                                                                                                        ['M'],
                                                                                                                                        1998:
                                                                                                                                        ['M'],
                                                                                                                                        1999:
                                                                                                                                        ['M'],
                                                                                                                                        2000:
                                                                                                                                        ['M'],
                                                                                                                                        2001:
                                                                                                                                        ['M'],
                                                                                                                                        2002:
                                                                                                                                        ['M'],
                                                                                                                                        2003:
                                                                                                                                        ['M'],
                                                                                                                                        2004:
                                                                                                                                        ['M'],
                                                                                                                                        2005:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        2006:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        2007:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        2008:
                                                                                                                                        ['S',
                                                                                                                                        'T'],
                                                                                                                                        2009:
                                                                                                                                        ['S',
                                                                                                                                        'T'],
                                                                                                                                        2010:
                                                                                                                                        ['S',
                                                                                                                                        'T'],
                                                                                                                                        2011:
                                                                                                                                        ['S'],
                                                                                                                                        2012:
                                                                                                                                        ['S'],
                                                                                                                                        2013:
                                                                                                                                        ['S'],
                                                                                                                                        2014:
                                                                                                                                        ['S'],
                                                                                                                                        2015:
                                                                                                                                        ['S'],
                                                                                                                                        2016:
                                                                                                                                        ['S'],
                                                                                                                                        2017:
                                                                                                                                        ['S'],
                                                                                                                                        2018:
                                                                                                                                        ['S'],
                                                                                                                                        2019:
                                                                                                                                        ['S'],
                                                                                                                                        2020:
                                                                                                                                        ['S'],
                                                                                                                                        2021:
                                                                                                                                        ['S'],
                                                                                                                                        2022:
                                                                                                                                        ['S'],
                                                                                                                                        2023:
                                                                                                                                        ['S'],
                                                                                                                                        2024:
                                                                                                                                        ['S'],
                                                                                                                                        2025:
                                                                                                                                        ['S']
                                                                                                                                        },
                                                                                                                                        "Chrysler":
                                                                                                                                        {
                                                                                                                                        1995:
                                                                                                                                        ['M'],
                                                                                                                                        1996:
                                                                                                                                        ['M'],
                                                                                                                                        1997:
                                                                                                                                        ['M'],
                                                                                                                                        1998:
                                                                                                                                        ['M'],
                                                                                                                                        1999:
                                                                                                                                        ['M'],
                                                                                                                                        2000:
                                                                                                                                        ['M'],
                                                                                                                                        2001:
                                                                                                                                        ['M'],
                                                                                                                                        2002:
                                                                                                                                        ['M'],
                                                                                                                                        2003:
                                                                                                                                        ['M'],
                                                                                                                                        2004:
                                                                                                                                        ['M'],
                                                                                                                                        2005:
                                                                                                                                        ['M'],
                                                                                                                                        2006:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        2007:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        2008:
                                                                                                                                        ['R',
                                                                                                                                        'T',
                                                                                                                                        'M'],
                                                                                                                                        2009:
                                                                                                                                        ['R',
                                                                                                                                        'T',
                                                                                                                                        'M'],
                                                                                                                                        2010:
                                                                                                                                        ['R',
                                                                                                                                        'T'],
                                                                                                                                        2011:
                                                                                                                                        ['S',
                                                                                                                                        'R',
                                                                                                                                        'T'],
                                                                                                                                        2012:
                                                                                                                                        ['S',
                                                                                                                                        'R'],
                                                                                                                                        2013:
                                                                                                                                        ['S',
                                                                                                                                        'R'],
                                                                                                                                        2014:
                                                                                                                                        ['S'],
                                                                                                                                        2015:
                                                                                                                                        ['S'],
                                                                                                                                        2016:
                                                                                                                                        ['S'],
                                                                                                                                        2017:
                                                                                                                                        ['S'],
                                                                                                                                        2018:
                                                                                                                                        ['S'],
                                                                                                                                        2019:
                                                                                                                                        ['S'],
                                                                                                                                        2020:
                                                                                                                                        ['S'],
                                                                                                                                        2021:
                                                                                                                                        ['S'],
                                                                                                                                        2022:
                                                                                                                                        ['S'],
                                                                                                                                        2023:
                                                                                                                                        ['S'],
                                                                                                                                        2024:
                                                                                                                                        ['S'],
                                                                                                                                        2025:
                                                                                                                                        ['S']
                                                                                                                                        },
                                                                                                                                        "GMC":
                                                                                                                                        {
                                                                                                                                        1995:
                                                                                                                                        ['M'],
                                                                                                                                        1996:
                                                                                                                                        ['M'],
                                                                                                                                        1997:
                                                                                                                                        ['M'],
                                                                                                                                        1998:
                                                                                                                                        ['M'],
                                                                                                                                        1999:
                                                                                                                                        ['M'],
                                                                                                                                        2000:
                                                                                                                                        ['M'],
                                                                                                                                        2001:
                                                                                                                                        ['M'],
                                                                                                                                        2002:
                                                                                                                                        ['M'],
                                                                                                                                        2003:
                                                                                                                                        ['M'],
                                                                                                                                        2004:
                                                                                                                                        ['M'],
                                                                                                                                        2005:
                                                                                                                                        ['M'],
                                                                                                                                        2006:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        2007:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        2008:
                                                                                                                                        ['R',
                                                                                                                                        'T',
                                                                                                                                        'M'],
                                                                                                                                        2009:
                                                                                                                                        ['R',
                                                                                                                                        'T',
                                                                                                                                        'M'],
                                                                                                                                        2010:
                                                                                                                                        ['R',
                                                                                                                                        'T'],
                                                                                                                                        2011:
                                                                                                                                        ['R',
                                                                                                                                        'T'],
                                                                                                                                        2012:
                                                                                                                                        ['S',
                                                                                                                                        'R'],
                                                                                                                                        2013:
                                                                                                                                        ['S',
                                                                                                                                        'R'],
                                                                                                                                        2014:
                                                                                                                                        ['S'],
                                                                                                                                        2015:
                                                                                                                                        ['S'],
                                                                                                                                        2016:
                                                                                                                                        ['S'],
                                                                                                                                        2017:
                                                                                                                                        ['S'],
                                                                                                                                        2018:
                                                                                                                                        ['S'],
                                                                                                                                        2019:
                                                                                                                                        ['S'],
                                                                                                                                        2020:
                                                                                                                                        ['S'],
                                                                                                                                        2021:
                                                                                                                                        ['S'],
                                                                                                                                        2022:
                                                                                                                                        ['S'],
                                                                                                                                        2023:
                                                                                                                                        ['S'],
                                                                                                                                        2024:
                                                                                                                                        ['S'],
                                                                                                                                        2025:
                                                                                                                                        ['S']
                                                                                                                                        },
                                                                                                                                        "Infiniti":
                                                                                                                                        {
                                                                                                                                        1995:
                                                                                                                                        ['M'],
                                                                                                                                        1996:
                                                                                                                                        ['M'],
                                                                                                                                        1997:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        1998:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        1999:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        2000:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        2001:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        2002:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        2003:
                                                                                                                                        ['S',
                                                                                                                                        'T'],
                                                                                                                                        2004:
                                                                                                                                        ['S',
                                                                                                                                        'T'],
                                                                                                                                        2005:
                                                                                                                                        ['S',
                                                                                                                                        'T'],
                                                                                                                                        2006:
                                                                                                                                        ['S',
                                                                                                                                        'T'],
                                                                                                                                        2007:
                                                                                                                                        ['S',
                                                                                                                                        'T'],
                                                                                                                                        2008:
                                                                                                                                        ['S',
                                                                                                                                        'T'],
                                                                                                                                        2009:
                                                                                                                                        ['S',
                                                                                                                                        'T'],
                                                                                                                                        2010:
                                                                                                                                        ['S'],
                                                                                                                                        2011:
                                                                                                                                        ['S'],
                                                                                                                                        2012:
                                                                                                                                        ['S'],
                                                                                                                                        2013:
                                                                                                                                        ['S'],
                                                                                                                                        2014:
                                                                                                                                        ['S'],
                                                                                                                                        2015:
                                                                                                                                        ['S'],
                                                                                                                                        2016:
                                                                                                                                        ['S'],
                                                                                                                                        2017:
                                                                                                                                        ['S'],
                                                                                                                                        2018:
                                                                                                                                        ['S'],
                                                                                                                                        2019:
                                                                                                                                        ['S'],
                                                                                                                                        2020:
                                                                                                                                        ['S'],
                                                                                                                                        2021:
                                                                                                                                        ['S'],
                                                                                                                                        2022:
                                                                                                                                        ['S'],
                                                                                                                                        2023:
                                                                                                                                        ['S'],
                                                                                                                                        2024:
                                                                                                                                        ['S'],
                                                                                                                                        2025:
                                                                                                                                        ['S']
                                                                                                                                        },
                                                                                                                                        "Jaguar":
                                                                                                                                        {
                                                                                                                                        1995:
                                                                                                                                        ['M'],
                                                                                                                                        1996:
                                                                                                                                        ['M'],
                                                                                                                                        1997:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        1998:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        1999:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        2000:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        2001:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        2002:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        2003:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        2004:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        2005:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        2006:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        2007:
                                                                                                                                        ['S',
                                                                                                                                        'T'],
                                                                                                                                        2008:
                                                                                                                                        ['S',
                                                                                                                                        'T'],
                                                                                                                                        2009:
                                                                                                                                        ['S',
                                                                                                                                        'T'],
                                                                                                                                        2010:
                                                                                                                                        ['S'],
                                                                                                                                        2011:
                                                                                                                                        ['S'],
                                                                                                                                        2012:
                                                                                                                                        ['S'],
                                                                                                                                        2013:
                                                                                                                                        ['S'],
                                                                                                                                        2014:
                                                                                                                                        ['S'],
                                                                                                                                        2015:
                                                                                                                                        ['S'],
                                                                                                                                        2016:
                                                                                                                                        ['S'],
                                                                                                                                        2017:
                                                                                                                                        ['S'],
                                                                                                                                        2018:
                                                                                                                                        ['S'],
                                                                                                                                        2019:
                                                                                                                                        ['S'],
                                                                                                                                        2020:
                                                                                                                                        ['S'],
                                                                                                                                        2021:
                                                                                                                                        ['S'],
                                                                                                                                        2022:
                                                                                                                                        ['S'],
                                                                                                                                        2023:
                                                                                                                                        ['S'],
                                                                                                                                        2024:
                                                                                                                                        ['S'],
                                                                                                                                        2025:
                                                                                                                                        ['S']
                                                                                                                                        },
                                                                                                                                        "Land
                                                                                                                                        Rover":
                                                                                                                                        {
                                                                                                                                        1995:
                                                                                                                                        ['M'],
                                                                                                                                        1996:
                                                                                                                                        ['M'],
                                                                                                                                        1997:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        1998:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        1999:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        2000:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        2001:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        2002:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        2003:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        2004:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        2005:
                                                                                                                                        ['S',
                                                                                                                                        'T'],
                                                                                                                                        2006:
                                                                                                                                        ['S',
                                                                                                                                        'T'],
                                                                                                                                        2007:
                                                                                                                                        ['S',
                                                                                                                                        'T'],
                                                                                                                                        2008:
                                                                                                                                        ['S',
                                                                                                                                        'T'],
                                                                                                                                        2009:
                                                                                                                                        ['S'],
                                                                                                                                        2010:
                                                                                                                                        ['S'],
                                                                                                                                        2011:
                                                                                                                                        ['S'],
                                                                                                                                        2012:
                                                                                                                                        ['S'],
                                                                                                                                        2013:
                                                                                                                                        ['S'],
                                                                                                                                        2014:
                                                                                                                                        ['S'],
                                                                                                                                        2015:
                                                                                                                                        ['S'],
                                                                                                                                        2016:
                                                                                                                                        ['S'],
                                                                                                                                        2017:
                                                                                                                                        ['S'],
                                                                                                                                        2018:
                                                                                                                                        ['S'],
                                                                                                                                        2019:
                                                                                                                                        ['S'],
                                                                                                                                        2020:
                                                                                                                                        ['S'],
                                                                                                                                        2021:
                                                                                                                                        ['S'],
                                                                                                                                        2022:
                                                                                                                                        ['S'],
                                                                                                                                        2023:
                                                                                                                                        ['S'],
                                                                                                                                        2024:
                                                                                                                                        ['S'],
                                                                                                                                        2025:
                                                                                                                                        ['S']
                                                                                                                                        },
                                                                                                                                        "Lincoln":
                                                                                                                                        {
                                                                                                                                        1995:
                                                                                                                                        ['M'],
                                                                                                                                        1996:
                                                                                                                                        ['M'],
                                                                                                                                        1997:
                                                                                                                                        ['M'],
                                                                                                                                        1998:
                                                                                                                                        ['M'],
                                                                                                                                        1999:
                                                                                                                                        ['M'],
                                                                                                                                        2000:
                                                                                                                                        ['M'],
                                                                                                                                        2001:
                                                                                                                                        ['M'],
                                                                                                                                        2002:
                                                                                                                                        ['M'],
                                                                                                                                        2003:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        2004:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        2005:
                                                                                                                                        ['S',
                                                                                                                                        'T'],
                                                                                                                                        2006:
                                                                                                                                        ['S',
                                                                                                                                        'T'],
                                                                                                                                        2007:
                                                                                                                                        ['S',
                                                                                                                                        'T'],
                                                                                                                                        2008:
                                                                                                                                        ['S',
                                                                                                                                        'T'],
                                                                                                                                        2009:
                                                                                                                                        ['S'],
                                                                                                                                        2010:
                                                                                                                                        ['S'],
                                                                                                                                        2011:
                                                                                                                                        ['S'],
                                                                                                                                        2012:
                                                                                                                                        ['S'],
                                                                                                                                        2013:
                                                                                                                                        ['S'],
                                                                                                                                        2014:
                                                                                                                                        ['S'],
                                                                                                                                        2015:
                                                                                                                                        ['S'],
                                                                                                                                        2016:
                                                                                                                                        ['S'],
                                                                                                                                        2017:
                                                                                                                                        ['S'],
                                                                                                                                        2018:
                                                                                                                                        ['S'],
                                                                                                                                        2019:
                                                                                                                                        ['S'],
                                                                                                                                        2020:
                                                                                                                                        ['S'],
                                                                                                                                        2021:
                                                                                                                                        ['S'],
                                                                                                                                        2022:
                                                                                                                                        ['S'],
                                                                                                                                        2023:
                                                                                                                                        ['S'],
                                                                                                                                        2024:
                                                                                                                                        ['S'],
                                                                                                                                        2025:
                                                                                                                                        ['S']
                                                                                                                                        },
                                                                                                                                        "Mercury":
                                                                                                                                        {
                                                                                                                                        1995:
                                                                                                                                        ['M'],
                                                                                                                                        1996:
                                                                                                                                        ['M'],
                                                                                                                                        1997:
                                                                                                                                        ['M'],
                                                                                                                                        1998:
                                                                                                                                        ['M'],
                                                                                                                                        1999:
                                                                                                                                        ['M'],
                                                                                                                                        2000:
                                                                                                                                        ['M'],
                                                                                                                                        2001:
                                                                                                                                        ['M'],
                                                                                                                                        2002:
                                                                                                                                        ['M'],
                                                                                                                                        2003:
                                                                                                                                        ['M'],
                                                                                                                                        2004:
                                                                                                                                        ['M'],
                                                                                                                                        2005:
                                                                                                                                        ['R',
                                                                                                                                        'T',
                                                                                                                                        'M'],
                                                                                                                                        2006:
                                                                                                                                        ['R',
                                                                                                                                        'T',
                                                                                                                                        'M'],
                                                                                                                                        2007:
                                                                                                                                        ['R',
                                                                                                                                        'T'],
                                                                                                                                        2008:
                                                                                                                                        ['R',
                                                                                                                                        'T'],
                                                                                                                                        2009:
                                                                                                                                        ['R',
                                                                                                                                        'T'],
                                                                                                                                        2010:
                                                                                                                                        ['R'],
                                                                                                                                        2011:
                                                                                                                                        ['R']
                                                                                                                                        },
                                                                                                                                        "Mitsubishi":
                                                                                                                                        {
                                                                                                                                        1995:
                                                                                                                                        ['M'],
                                                                                                                                        1996:
                                                                                                                                        ['M'],
                                                                                                                                        1997:
                                                                                                                                        ['M'],
                                                                                                                                        1998:
                                                                                                                                        ['M'],
                                                                                                                                        1999:
                                                                                                                                        ['M'],
                                                                                                                                        2000:
                                                                                                                                        ['M'],
                                                                                                                                        2001:
                                                                                                                                        ['M'],
                                                                                                                                        2002:
                                                                                                                                        ['M'],
                                                                                                                                        2003:
                                                                                                                                        ['M'],
                                                                                                                                        2004:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        2005:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        2006:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        2007:
                                                                                                                                        ['S',
                                                                                                                                        'T'],
                                                                                                                                        2008:
                                                                                                                                        ['S',
                                                                                                                                        'T'],
                                                                                                                                        2009:
                                                                                                                                        ['S',
                                                                                                                                        'T'],
                                                                                                                                        2010:
                                                                                                                                        ['S',
                                                                                                                                        'T'],
                                                                                                                                        2011:
                                                                                                                                        ['S'],
                                                                                                                                        2012:
                                                                                                                                        ['S'],
                                                                                                                                        2013:
                                                                                                                                        ['S'],
                                                                                                                                        2014:
                                                                                                                                        ['S'],
                                                                                                                                        2015:
                                                                                                                                        ['S'],
                                                                                                                                        2016:
                                                                                                                                        ['S'],
                                                                                                                                        2017:
                                                                                                                                        ['S'],
                                                                                                                                        2018:
                                                                                                                                        ['S'],
                                                                                                                                        2019:
                                                                                                                                        ['S'],
                                                                                                                                        2020:
                                                                                                                                        ['S'],
                                                                                                                                        2021:
                                                                                                                                        ['S'],
                                                                                                                                        2022:
                                                                                                                                        ['S'],
                                                                                                                                        2023:
                                                                                                                                        ['S'],
                                                                                                                                        2024:
                                                                                                                                        ['S'],
                                                                                                                                        2025:
                                                                                                                                        ['S']
                                                                                                                                        },
                                                                                                                                        "Porsche":
                                                                                                                                        {
                                                                                                                                        1995:
                                                                                                                                        ['M'],
                                                                                                                                        1996:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        1997:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        1998:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        1999:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        2000:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        2001:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        2002:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        2003:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        2004:
                                                                                                                                        ['S',
                                                                                                                                        'T'],
                                                                                                                                        2005:
                                                                                                                                        ['S',
                                                                                                                                        'T'],
                                                                                                                                        2006:
                                                                                                                                        ['S',
                                                                                                                                        'T'],
                                                                                                                                        2007:
                                                                                                                                        ['S',
                                                                                                                                        'T'],
                                                                                                                                        2008:
                                                                                                                                        ['S'],
                                                                                                                                        2009:
                                                                                                                                        ['S'],
                                                                                                                                        2010:
                                                                                                                                        ['S'],
                                                                                                                                        2011:
                                                                                                                                        ['S'],
                                                                                                                                        2012:
                                                                                                                                        ['S'],
                                                                                                                                        2013:
                                                                                                                                        ['S'],
                                                                                                                                        2014:
                                                                                                                                        ['S'],
                                                                                                                                        2015:
                                                                                                                                        ['S'],
                                                                                                                                        2016:
                                                                                                                                        ['S'],
                                                                                                                                        2017:
                                                                                                                                        ['S'],
                                                                                                                                        2018:
                                                                                                                                        ['S'],
                                                                                                                                        2019:
                                                                                                                                        ['S'],
                                                                                                                                        2020:
                                                                                                                                        ['S'],
                                                                                                                                        2021:
                                                                                                                                        ['S'],
                                                                                                                                        2022:
                                                                                                                                        ['S'],
                                                                                                                                        2023:
                                                                                                                                        ['S'],
                                                                                                                                        2024:
                                                                                                                                        ['S'],
                                                                                                                                        2025:
                                                                                                                                        ['S']
                                                                                                                                        },
                                                                                                                                        "Volvo":
                                                                                                                                        {
                                                                                                                                        1995:
                                                                                                                                        ['M'],
                                                                                                                                        1996:
                                                                                                                                        ['M'],
                                                                                                                                        1997:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        1998:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        1999:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        2000:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        2001:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        2002:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        2003:
                                                                                                                                        ['T',
                                                                                                                                        'M'],
                                                                                                                                        2004:
                                                                                                                                        ['S',
                                                                                                                                        'T'],
                                                                                                                                        2005:
                                                                                                                                        ['S',
                                                                                                                                        'T'],
                                                                                                                                        2006:
                                                                                                                                        ['S',
                                                                                                                                        'T'],
                                                                                                                                        2007:
                                                                                                                                        ['S',
                                                                                                                                        'T'],
                                                                                                                                        2008:
                                                                                                                                        ['S'],
                                                                                                                                        2009:
                                                                                                                                        ['S'],
                                                                                                                                        2010:
                                                                                                                                        ['S'],
                                                                                                                                        2011:
                                                                                                                                        ['S'],
                                                                                                                                        2012:
                                                                                                                                        ['S'],
                                                                                                                                        2013:
                                                                                                                                        ['S'],
                                                                                                                                        2014:
                                                                                                                                        ['S'],
                                                                                                                                        2015:
                                                                                                                                        ['S'],
                                                                                                                                        2016:
                                                                                                                                        ['S'],
                                                                                                                                        2017:
                                                                                                                                        ['S'],
                                                                                                                                        2018:
                                                                                                                                        ['S'],
                                                                                                                                        2019:
                                                                                                                                        ['S'],
                                                                                                                                        2020:
                                                                                                                                        ['S'],
                                                                                                                                        2021:
                                                                                                                                        ['S'],
                                                                                                                                        2022:
                                                                                                                                        ['S'],
                                                                                                                                        2023:
                                                                                                                                        ['S'],
                                                                                                                                        2024:
                                                                                                                                        ['S'],
                                                                                                                                        2025:
                                                                                                                                        ['S']
                                                                                                                                        }
                                                                                                                                        };

                                                                                                                                        //
                                                                                                                                        Key
                                                                                                                                        type
                                                                                                                                        colors
                                                                                                                                        matching
                                                                                                                                        badge
                                                                                                                                        colors
                                                                                                                                        const
                                                                                                                                        KEY_TYPE_COLORS
                                                                                                                                        =
                                                                                                                                        {
                                                                                                                                        'S':
                                                                                                                                        {
                                                                                                                                        bg:
                                                                                                                                        '#22c55e',
                                                                                                                                        label:
                                                                                                                                        'Smart/Prox',
                                                                                                                                        opacity:
                                                                                                                                        1,
                                                                                                                                        filter:
                                                                                                                                        'smart'
                                                                                                                                        },
                                                                                                                                        //
                                                                                                                                        Green
                                                                                                                                        'F':
                                                                                                                                        {
                                                                                                                                        bg:
                                                                                                                                        '#a855f7',
                                                                                                                                        label:
                                                                                                                                        'Flip
                                                                                                                                        Key',
                                                                                                                                        opacity:
                                                                                                                                        0.9,
                                                                                                                                        filter:
                                                                                                                                        'flip'
                                                                                                                                        },
                                                                                                                                        //
                                                                                                                                        Purple
                                                                                                                                        'R':
                                                                                                                                        {
                                                                                                                                        bg:
                                                                                                                                        '#3b82f6',
                                                                                                                                        label:
                                                                                                                                        'Remote
                                                                                                                                        Head',
                                                                                                                                        opacity:
                                                                                                                                        0.85,
                                                                                                                                        filter:
                                                                                                                                        'remote-head'
                                                                                                                                        },
                                                                                                                                        //
                                                                                                                                        Blue
                                                                                                                                        'T':
                                                                                                                                        {
                                                                                                                                        bg:
                                                                                                                                        '#fbbf24',
                                                                                                                                        label:
                                                                                                                                        'Transponder',
                                                                                                                                        opacity:
                                                                                                                                        0.8,
                                                                                                                                        filter:
                                                                                                                                        'transponder'
                                                                                                                                        },
                                                                                                                                        //
                                                                                                                                        Yellow
                                                                                                                                        'M':
                                                                                                                                        {
                                                                                                                                        bg:
                                                                                                                                        '#9ca3af',
                                                                                                                                        label:
                                                                                                                                        'Mechanical',
                                                                                                                                        opacity:
                                                                                                                                        0.6,
                                                                                                                                        filter:
                                                                                                                                        'mechanical'
                                                                                                                                        }
                                                                                                                                        //
                                                                                                                                        Grey
                                                                                                                                        };

                                                                                                                                        function
                                                                                                                                        renderKeyCoverageMap(forceRefresh
                                                                                                                                        =
                                                                                                                                        false)
                                                                                                                                        {
                                                                                                                                        const
                                                                                                                                        container
                                                                                                                                        =
                                                                                                                                        document.getElementById('keyCoverageContainer');
                                                                                                                                        if
                                                                                                                                        (!container)
                                                                                                                                        return;

                                                                                                                                        //
                                                                                                                                        Use
                                                                                                                                        cached
                                                                                                                                        HTML
                                                                                                                                        if
                                                                                                                                        available
                                                                                                                                        (performance
                                                                                                                                        optimization)
                                                                                                                                        if
                                                                                                                                        (!forceRefresh
                                                                                                                                        &&
                                                                                                                                        cachedHeatmapHtml
                                                                                                                                        &&
                                                                                                                                        heatmapCached)
                                                                                                                                        {
                                                                                                                                        container.innerHTML
                                                                                                                                        =
                                                                                                                                        cachedHeatmapHtml;
                                                                                                                                        return;
                                                                                                                                        }

                                                                                                                                        //
                                                                                                                                        Use
                                                                                                                                        expanded
                                                                                                                                        makes
                                                                                                                                        list
                                                                                                                                        from
                                                                                                                                        hardcoded
                                                                                                                                        coverage
                                                                                                                                        const
                                                                                                                                        makes
                                                                                                                                        =
                                                                                                                                        Object.keys(HARDCODED_COVERAGE);
                                                                                                                                        const
                                                                                                                                        years
                                                                                                                                        =
                                                                                                                                        Array.from({
                                                                                                                                        length:
                                                                                                                                        31
                                                                                                                                        },
                                                                                                                                        (_,
                                                                                                                                        i)
                                                                                                                                        =>
                                                                                                                                        1995
                                                                                                                                        +
                                                                                                                                        i);
                                                                                                                                        //
                                                                                                                                        1995-2025

                                                                                                                                        //
                                                                                                                                        Get
                                                                                                                                        current
                                                                                                                                        filter
                                                                                                                                        for
                                                                                                                                        highlighting
                                                                                                                                        const
                                                                                                                                        activeFilter
                                                                                                                                        =
                                                                                                                                        typeof
                                                                                                                                        fccKeyType
                                                                                                                                        !==
                                                                                                                                        'undefined'
                                                                                                                                        ?
                                                                                                                                        fccKeyType
                                                                                                                                        :
                                                                                                                                        'all';

                                                                                                                                        //
                                                                                                                                        Build
                                                                                                                                        coverage
                                                                                                                                        from
                                                                                                                                        hardcoded
                                                                                                                                        data
                                                                                                                                        +
                                                                                                                                        user
                                                                                                                                        inventory
                                                                                                                                        const
                                                                                                                                        coverage
                                                                                                                                        =
                                                                                                                                        {};
                                                                                                                                        makes.forEach(make
                                                                                                                                        =>
                                                                                                                                        {
                                                                                                                                        coverage[make]
                                                                                                                                        =
                                                                                                                                        {};
                                                                                                                                        years.forEach(year
                                                                                                                                        =>
                                                                                                                                        {
                                                                                                                                        const
                                                                                                                                        types
                                                                                                                                        =
                                                                                                                                        HARDCODED_COVERAGE[make]?.[year]
                                                                                                                                        ||
                                                                                                                                        ['M'];
                                                                                                                                        coverage[make][year]
                                                                                                                                        =
                                                                                                                                        {
                                                                                                                                        keyTypes:
                                                                                                                                        Array.isArray(types)
                                                                                                                                        ?
                                                                                                                                        types
                                                                                                                                        :
                                                                                                                                        [types],
                                                                                                                                        //
                                                                                                                                        Support
                                                                                                                                        both
                                                                                                                                        array
                                                                                                                                        and
                                                                                                                                        legacy
                                                                                                                                        single
                                                                                                                                        values
                                                                                                                                        inStock:
                                                                                                                                        0
                                                                                                                                        //
                                                                                                                                        Will
                                                                                                                                        be
                                                                                                                                        updated
                                                                                                                                        from
                                                                                                                                        inventory
                                                                                                                                        };
                                                                                                                                        });
                                                                                                                                        });

                                                                                                                                        //
                                                                                                                                        Overlay
                                                                                                                                        inventory
                                                                                                                                        data
                                                                                                                                        if
                                                                                                                                        fccData
                                                                                                                                        is
                                                                                                                                        available
                                                                                                                                        if
                                                                                                                                        (typeof
                                                                                                                                        fccData
                                                                                                                                        !==
                                                                                                                                        'undefined'
                                                                                                                                        &&
                                                                                                                                        fccData
                                                                                                                                        &&
                                                                                                                                        fccData.length
                                                                                                                                        >
                                                                                                                                        0)
                                                                                                                                        {
                                                                                                                                        fccData.forEach(entry
                                                                                                                                        =>
                                                                                                                                        {
                                                                                                                                        const
                                                                                                                                        vehicleStr
                                                                                                                                        =
                                                                                                                                        entry.vehicles
                                                                                                                                        ||
                                                                                                                                        '';
                                                                                                                                        if
                                                                                                                                        (!vehicleStr
                                                                                                                                        ||
                                                                                                                                        vehicleStr
                                                                                                                                        ===
                                                                                                                                        'N/A')
                                                                                                                                        return;

                                                                                                                                        const
                                                                                                                                        parts
                                                                                                                                        =
                                                                                                                                        vehicleStr.split(',').map(v
                                                                                                                                        =>
                                                                                                                                        v.trim()).filter(v
                                                                                                                                        =>
                                                                                                                                        v);
                                                                                                                                        parts.forEach(part
                                                                                                                                        =>
                                                                                                                                        {
                                                                                                                                        const
                                                                                                                                        match
                                                                                                                                        =
                                                                                                                                        part.match(/^([^(]+)\s+\((\d{4})(?:-(\d{4}))?\)$/);
                                                                                                                                        if
                                                                                                                                        (match)
                                                                                                                                        {
                                                                                                                                        const
                                                                                                                                        makeModel
                                                                                                                                        =
                                                                                                                                        match[1].trim();
                                                                                                                                        const
                                                                                                                                        makeMatch
                                                                                                                                        =
                                                                                                                                        makeModel.match(/^([A-Za-z]+)/);
                                                                                                                                        const
                                                                                                                                        make
                                                                                                                                        =
                                                                                                                                        makeMatch
                                                                                                                                        ?
                                                                                                                                        makeMatch[1]
                                                                                                                                        :
                                                                                                                                        null;

                                                                                                                                        if
                                                                                                                                        (make
                                                                                                                                        &&
                                                                                                                                        makes.includes(make))
                                                                                                                                        {
                                                                                                                                        const
                                                                                                                                        start
                                                                                                                                        =
                                                                                                                                        parseInt(match[2]);
                                                                                                                                        const
                                                                                                                                        end
                                                                                                                                        =
                                                                                                                                        match[3]
                                                                                                                                        ?
                                                                                                                                        parseInt(match[3])
                                                                                                                                        :
                                                                                                                                        start;

                                                                                                                                        //
                                                                                                                                        Check
                                                                                                                                        stock
                                                                                                                                        const
                                                                                                                                        hasStock
                                                                                                                                        =
                                                                                                                                        (entry.fcc_id
                                                                                                                                        &&
                                                                                                                                        InventoryManager.getKeyStock(entry.fcc_id)
                                                                                                                                        >
                                                                                                                                        0)
                                                                                                                                        ||
                                                                                                                                        (entry.primary_oem_part
                                                                                                                                        &&
                                                                                                                                        InventoryManager.getBlankStock(entry.primary_oem_part)
                                                                                                                                        >
                                                                                                                                        0);

                                                                                                                                        for
                                                                                                                                        (let
                                                                                                                                        y
                                                                                                                                        =
                                                                                                                                        start;
                                                                                                                                        y
                                                                                                                                        <= end;
                                                                                                                                            y++)
                                                                                                                                            {
                                                                                                                                            if
                                                                                                                                            (y>
                                                                                                                                            =
                                                                                                                                            1985
                                                                                                                                            &&
                                                                                                                                            y
                                                                                                                                            <= 2025
                                                                                                                                                &&
                                                                                                                                                coverage[make]
                                                                                                                                                &&
                                                                                                                                                coverage[make][y])
                                                                                                                                                {
                                                                                                                                                if
                                                                                                                                                (hasStock)
                                                                                                                                                coverage[make][y].inStock++;
                                                                                                                                                }
                                                                                                                                                }
                                                                                                                                                }
                                                                                                                                                }
                                                                                                                                                });
                                                                                                                                                });
                                                                                                                                                }
                                                                                                                                                //
                                                                                                                                                Render
                                                                                                                                                Heatmap
                                                                                                                                                with
                                                                                                                                                all
                                                                                                                                                5
                                                                                                                                                key
                                                                                                                                                type
                                                                                                                                                colors
                                                                                                                                                -
                                                                                                                                                Mobile
                                                                                                                                                optimized
                                                                                                                                                with
                                                                                                                                                sticky
                                                                                                                                                make
                                                                                                                                                column
                                                                                                                                                const
                                                                                                                                                html=`
                                                                                                                                                <div
                                                                                                                                                style="background: var(--bg-tertiary); padding: 16px; border-radius: 12px; border: 1px solid var(--border);">
                                                                                                                                                <h3
                                                                                                                                                    style="margin-top: 0; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; font-size: 1rem;">
                                                                                                                                                    <span>ðŸ—ºï¸
                                                                                                                                                        Key
                                                                                                                                                        Coverage
                                                                                                                                                        Map${activeFilter
                                                                                                                                                        !==
                                                                                                                                                        'all'
                                                                                                                                                        ?
                                                                                                                                                        '
                                                                                                                                                        -
                                                                                                                                                        '
                                                                                                                                                        +
                                                                                                                                                        (KEY_TYPE_COLORS[{
                                                                                                                                                        smart:
                                                                                                                                                        'S',
                                                                                                                                                        flip:
                                                                                                                                                        'F',
                                                                                                                                                        'remote-head':
                                                                                                                                                        'R',
                                                                                                                                                        transponder:
                                                                                                                                                        'T',
                                                                                                                                                        mechanical:
                                                                                                                                                        'M'
                                                                                                                                                        }[activeFilter]]?.label
                                                                                                                                                        ||
                                                                                                                                                        activeFilter)
                                                                                                                                                        :
                                                                                                                                                        ''}</span>
                                                                                                                                                </h3>
                                                                                                                                                <!-- Legend - compact for mobile -->
                                                                                                                                                <div
                                                                                                                                                    style="display: flex; gap: 6px; font-size: 0.65rem; font-weight: 400; flex-wrap: wrap; margin-bottom: 12px;">
                                                                                                                                                    <span
                                                                                                                                                        style="display: flex; align-items: center; gap: 3px;"><span
                                                                                                                                                            style="width: 8px; height: 8px; background: #22c55e; border-radius: 2px;"></span>Smart</span>
                                                                                                                                                    <span
                                                                                                                                                        style="display: flex; align-items: center; gap: 3px;"><span
                                                                                                                                                            style="width: 8px; height: 8px; background: #a855f7; border-radius: 2px;"></span>Flip</span>
                                                                                                                                                    <span
                                                                                                                                                        style="display: flex; align-items: center; gap: 3px;"><span
                                                                                                                                                            style="width: 8px; height: 8px; background: #3b82f6; border-radius: 2px;"></span>Remote</span>
                                                                                                                                                    <span
                                                                                                                                                        style="display: flex; align-items: center; gap: 3px;"><span
                                                                                                                                                            style="width: 8px; height: 8px; background: #fbbf24; border-radius: 2px;"></span>Transp</span>
                                                                                                                                                    <span
                                                                                                                                                        style="display: flex; align-items: center; gap: 3px;"><span
                                                                                                                                                            style="width: 8px; height: 8px; background: #9ca3af; border-radius: 2px;"></span>Mech</span>
                                                                                                                                                </div>

                                                                                                                                                <!-- Table-based layout for proper sticky column support -->
                                                                                                                                                <div
                                                                                                                                                    style="overflow-x: auto; -webkit-overflow-scrolling: touch; position: relative;">
                                                                                                                                                    <table
                                                                                                                                                        style="border-collapse: separate; border-spacing: 2px; table-layout: fixed;">
                                                                                                                                                        <thead>
                                                                                                                                                            <tr>
                                                                                                                                                                <th
                                                                                                                                                                    style="position: sticky; left: 0; z-index: 10; background: var(--bg-tertiary); min-width: 70px; width: 70px;">
                                                                                                                                                                </th>
                                                                                                                                                                ${years.map(y
                                                                                                                                                                =>
                                                                                                                                                                `
                                                                                                                                                                <th
                                                                                                                                                                    style="font-size: 0.5rem; color: var(--text-muted); text-align: center; padding: 0; width: 18px; min-width: 18px; font-weight: 400;">
                                                                                                                                                                    <div
                                                                                                                                                                        style="transform: rotate(-45deg); white-space: nowrap;">
                                                                                                                                                                        '${String(y).slice(-2)}
                                                                                                                                                                    </div>
                                                                                                                                                                </th>
                                                                                                                                                                `).join('')}
                                                                                                                                                            </tr>
                                                                                                                                                        </thead>
                                                                                                                                                        <tbody>
                                                                                                                                                            ${makes.map(make
                                                                                                                                                            =>
                                                                                                                                                            {
                                                                                                                                                            //
                                                                                                                                                            Determine
                                                                                                                                                            brand
                                                                                                                                                            lifecycle
                                                                                                                                                            to
                                                                                                                                                            show
                                                                                                                                                            "Inactive"
                                                                                                                                                            state
                                                                                                                                                            const
                                                                                                                                                            yearsDefined
                                                                                                                                                            =
                                                                                                                                                            Object.keys(HARDCODED_COVERAGE[make]).map(Number);
                                                                                                                                                            const
                                                                                                                                                            minYear
                                                                                                                                                            =
                                                                                                                                                            Math.min(...yearsDefined);
                                                                                                                                                            const
                                                                                                                                                            maxYear
                                                                                                                                                            =
                                                                                                                                                            Math.max(...yearsDefined);

                                                                                                                                                            //
                                                                                                                                                            Check
                                                                                                                                                            if
                                                                                                                                                            this
                                                                                                                                                            make
                                                                                                                                                            matches
                                                                                                                                                            the
                                                                                                                                                            current
                                                                                                                                                            search
                                                                                                                                                            query
                                                                                                                                                            const
                                                                                                                                                            searchInput
                                                                                                                                                            =
                                                                                                                                                            document.getElementById('fccSearch')?.value
                                                                                                                                                            ||
                                                                                                                                                            '';
                                                                                                                                                            const
                                                                                                                                                            searchLower
                                                                                                                                                            =
                                                                                                                                                            searchInput.toLowerCase().replace(/\b(19\d{2}|20\d{2})\b/g,
                                                                                                                                                            '').trim();

                                                                                                                                                            //
                                                                                                                                                            Precise
                                                                                                                                                            matching:
                                                                                                                                                            start
                                                                                                                                                            of
                                                                                                                                                            word
                                                                                                                                                            or
                                                                                                                                                            exact
                                                                                                                                                            match
                                                                                                                                                            const
                                                                                                                                                            makeMatchesSearch
                                                                                                                                                            =
                                                                                                                                                            !searchLower
                                                                                                                                                            ||
                                                                                                                                                            make.toLowerCase()
                                                                                                                                                            ===
                                                                                                                                                            searchLower
                                                                                                                                                            ||
                                                                                                                                                            make.toLowerCase().startsWith(searchLower)
                                                                                                                                                            ||
                                                                                                                                                            (searchLower.length
                                                                                                                                                            >
                                                                                                                                                            2
                                                                                                                                                            &&
                                                                                                                                                            make.toLowerCase().includes(searchLower));

                                                                                                                                                            const
                                                                                                                                                            rowHighlight
                                                                                                                                                            =
                                                                                                                                                            makeMatchesSearch
                                                                                                                                                            &&
                                                                                                                                                            searchLower
                                                                                                                                                            ?
                                                                                                                                                            'background:
                                                                                                                                                            rgba(251,
                                                                                                                                                            191,
                                                                                                                                                            36,
                                                                                                                                                            0.15);'
                                                                                                                                                            :
                                                                                                                                                            '';
                                                                                                                                                            const
                                                                                                                                                            rowDim
                                                                                                                                                            =
                                                                                                                                                            !makeMatchesSearch
                                                                                                                                                            &&
                                                                                                                                                            searchLower
                                                                                                                                                            ?
                                                                                                                                                            'opacity:
                                                                                                                                                            0.2;
                                                                                                                                                            grayscale:
                                                                                                                                                            1;'
                                                                                                                                                            :
                                                                                                                                                            '';

                                                                                                                                                            return
                                                                                                                                                            `
                                                                                                                                                            <tr
                                                                                                                                                                style="${rowHighlight} ${rowDim}">
                                                                                                                                                                <td
                                                                                                                                                                    style="position: sticky; left: 0; z-index: 5; background: var(--bg-tertiary); font-size: 0.7rem; font-weight: ${makeMatchesSearch && searchLower ? '700' : '600'}; color: ${makeMatchesSearch && searchLower ? 'var(--brand-primary)' : 'var(--text-primary)'}; padding-right: 6px; text-align: right; white-space: nowrap; min-width: 70px; width: 70px;">
                                                                                                                                                                    ${make}
                                                                                                                                                                </td>
                                                                                                                                                                ${years.map(year
                                                                                                                                                                =>
                                                                                                                                                                {
                                                                                                                                                                const
                                                                                                                                                                data
                                                                                                                                                                =
                                                                                                                                                                coverage[make]
                                                                                                                                                                &&
                                                                                                                                                                coverage[make][year];
                                                                                                                                                                const
                                                                                                                                                                isInactive
                                                                                                                                                                =
                                                                                                                                                                year
                                                                                                                                                                < minYear
                                                                                                                                                                    ||
                                                                                                                                                                    year>
                                                                                                                                                                    maxYear;
                                                                                                                                                                    const
                                                                                                                                                                    keyTypes
                                                                                                                                                                    =
                                                                                                                                                                    data?.keyTypes
                                                                                                                                                                    ||
                                                                                                                                                                    (isInactive
                                                                                                                                                                    ?
                                                                                                                                                                    []
                                                                                                                                                                    :
                                                                                                                                                                    ['M']);

                                                                                                                                                                    if
                                                                                                                                                                    (isInactive
                                                                                                                                                                    &&
                                                                                                                                                                    (!data
                                                                                                                                                                    ||
                                                                                                                                                                    data.inStock
                                                                                                                                                                    ===
                                                                                                                                                                    0))
                                                                                                                                                                    {
                                                                                                                                                                    return
                                                                                                                                                                    `
                                                                                                                                                                    <td
                                                                                                                                                                        style="padding: 0;">
                                                                                                                                                                        <div
                                                                                                                                                                            style="height: 20px; width: 16px; background: rgba(255,255,255,0.05); border-radius: 2px;">
                                                                                                                                                                        </div>
                                                                                                                                                                    </td>
                                                                                                                                                                    `;
                                                                                                                                                                    }

                                                                                                                                                                    const
                                                                                                                                                                    primaryType
                                                                                                                                                                    =
                                                                                                                                                                    keyTypes[0]
                                                                                                                                                                    ||
                                                                                                                                                                    'M';
                                                                                                                                                                    const
                                                                                                                                                                    typeInfo
                                                                                                                                                                    =
                                                                                                                                                                    KEY_TYPE_COLORS[primaryType]
                                                                                                                                                                    ||
                                                                                                                                                                    KEY_TYPE_COLORS['M'];

                                                                                                                                                                    //
                                                                                                                                                                    Check
                                                                                                                                                                    if
                                                                                                                                                                    ANY
                                                                                                                                                                    type
                                                                                                                                                                    in
                                                                                                                                                                    the
                                                                                                                                                                    cell
                                                                                                                                                                    matches
                                                                                                                                                                    the
                                                                                                                                                                    active
                                                                                                                                                                    filter
                                                                                                                                                                    const
                                                                                                                                                                    filterMap
                                                                                                                                                                    =
                                                                                                                                                                    {
                                                                                                                                                                    'smart':
                                                                                                                                                                    'S',
                                                                                                                                                                    'flip':
                                                                                                                                                                    'F',
                                                                                                                                                                    'remote-head':
                                                                                                                                                                    'R',
                                                                                                                                                                    'transponder':
                                                                                                                                                                    'T',
                                                                                                                                                                    'mechanical':
                                                                                                                                                                    'M'
                                                                                                                                                                    };
                                                                                                                                                                    const
                                                                                                                                                                    matchesFilter
                                                                                                                                                                    =
                                                                                                                                                                    activeFilter
                                                                                                                                                                    ===
                                                                                                                                                                    'all'
                                                                                                                                                                    ||
                                                                                                                                                                    keyTypes.includes(filterMap[activeFilter]);

                                                                                                                                                                    //
                                                                                                                                                                    Build
                                                                                                                                                                    tooltip
                                                                                                                                                                    showing
                                                                                                                                                                    all
                                                                                                                                                                    available
                                                                                                                                                                    types
                                                                                                                                                                    const
                                                                                                                                                                    typeLabels
                                                                                                                                                                    =
                                                                                                                                                                    keyTypes.map(t
                                                                                                                                                                    =>
                                                                                                                                                                    KEY_TYPE_COLORS[t]?.label
                                                                                                                                                                    ||
                                                                                                                                                                    t).join(',
                                                                                                                                                                    ');
                                                                                                                                                                    let
                                                                                                                                                                    title
                                                                                                                                                                    =
                                                                                                                                                                    `${make}
                                                                                                                                                                    ${year}:
                                                                                                                                                                    ${typeLabels}`;

                                                                                                                                                                    //
                                                                                                                                                                    Add
                                                                                                                                                                    immobilizer
                                                                                                                                                                    metadata
                                                                                                                                                                    if
                                                                                                                                                                    available
                                                                                                                                                                    if
                                                                                                                                                                    (typeof
                                                                                                                                                                    COVERAGE_METADATA
                                                                                                                                                                    !==
                                                                                                                                                                    'undefined'
                                                                                                                                                                    &&
                                                                                                                                                                    COVERAGE_METADATA[make]
                                                                                                                                                                    &&
                                                                                                                                                                    COVERAGE_METADATA[make][year])
                                                                                                                                                                    {
                                                                                                                                                                    const
                                                                                                                                                                    meta
                                                                                                                                                                    =
                                                                                                                                                                    COVERAGE_METADATA[make][year];
                                                                                                                                                                    const
                                                                                                                                                                    methodIcon
                                                                                                                                                                    =
                                                                                                                                                                    (typeof
                                                                                                                                                                    METHOD_ICONS
                                                                                                                                                                    !==
                                                                                                                                                                    'undefined'
                                                                                                                                                                    &&
                                                                                                                                                                    METHOD_ICONS[meta.method])
                                                                                                                                                                    ||
                                                                                                                                                                    '';
                                                                                                                                                                    title
                                                                                                                                                                    +=
                                                                                                                                                                    `
                                                                                                                                                                    |
                                                                                                                                                                    ${meta.system}
                                                                                                                                                                    (${meta.chip})
                                                                                                                                                                    |
                                                                                                                                                                    ${methodIcon}
                                                                                                                                                                    ${meta.difficulty}:
                                                                                                                                                                    ${meta.method}`;
                                                                                                                                                                    if
                                                                                                                                                                    (meta.notes)
                                                                                                                                                                    title
                                                                                                                                                                    +=
                                                                                                                                                                    `
                                                                                                                                                                    |
                                                                                                                                                                    ${meta.notes}`;
                                                                                                                                                                    }

                                                                                                                                                                    //
                                                                                                                                                                    When
                                                                                                                                                                    filtered,
                                                                                                                                                                    only
                                                                                                                                                                    show
                                                                                                                                                                    the
                                                                                                                                                                    color
                                                                                                                                                                    for
                                                                                                                                                                    matching
                                                                                                                                                                    types
                                                                                                                                                                    let
                                                                                                                                                                    bg
                                                                                                                                                                    =
                                                                                                                                                                    typeInfo.bg;
                                                                                                                                                                    let
                                                                                                                                                                    opacity;
                                                                                                                                                                    let
                                                                                                                                                                    border
                                                                                                                                                                    =
                                                                                                                                                                    'none';

                                                                                                                                                                    if
                                                                                                                                                                    (activeFilter
                                                                                                                                                                    ===
                                                                                                                                                                    'all')
                                                                                                                                                                    {
                                                                                                                                                                    opacity
                                                                                                                                                                    =
                                                                                                                                                                    0.85;
                                                                                                                                                                    if
                                                                                                                                                                    (keyTypes.length
                                                                                                                                                                    >
                                                                                                                                                                    1)
                                                                                                                                                                    {
                                                                                                                                                                    const
                                                                                                                                                                    colors
                                                                                                                                                                    =
                                                                                                                                                                    keyTypes.slice(0,
                                                                                                                                                                    3).map(t
                                                                                                                                                                    =>
                                                                                                                                                                    KEY_TYPE_COLORS[t]?.bg
                                                                                                                                                                    ||
                                                                                                                                                                    '#9ca3af');
                                                                                                                                                                    bg
                                                                                                                                                                    =
                                                                                                                                                                    `linear-gradient(135deg,
                                                                                                                                                                    ${colors.join(',
                                                                                                                                                                    ')})`;
                                                                                                                                                                    }
                                                                                                                                                                    }
                                                                                                                                                                    else
                                                                                                                                                                    if
                                                                                                                                                                    (matchesFilter)
                                                                                                                                                                    {
                                                                                                                                                                    const
                                                                                                                                                                    filteredTypeCode
                                                                                                                                                                    =
                                                                                                                                                                    filterMap[activeFilter];
                                                                                                                                                                    const
                                                                                                                                                                    filteredTypeInfo
                                                                                                                                                                    =
                                                                                                                                                                    KEY_TYPE_COLORS[filteredTypeCode];
                                                                                                                                                                    bg
                                                                                                                                                                    =
                                                                                                                                                                    filteredTypeInfo?.bg
                                                                                                                                                                    ||
                                                                                                                                                                    '#9ca3af';
                                                                                                                                                                    opacity
                                                                                                                                                                    =
                                                                                                                                                                    1;
                                                                                                                                                                    }
                                                                                                                                                                    else
                                                                                                                                                                    {
                                                                                                                                                                    bg
                                                                                                                                                                    =
                                                                                                                                                                    '#1a2942';
                                                                                                                                                                    opacity
                                                                                                                                                                    =
                                                                                                                                                                    0.3;
                                                                                                                                                                    }

                                                                                                                                                                    if
                                                                                                                                                                    (data
                                                                                                                                                                    &&
                                                                                                                                                                    data.inStock
                                                                                                                                                                    >
                                                                                                                                                                    0)
                                                                                                                                                                    {
                                                                                                                                                                    border
                                                                                                                                                                    =
                                                                                                                                                                    '2px
                                                                                                                                                                    solid
                                                                                                                                                                    #fff';
                                                                                                                                                                    opacity
                                                                                                                                                                    =
                                                                                                                                                                    1;
                                                                                                                                                                    title
                                                                                                                                                                    +=
                                                                                                                                                                    `
                                                                                                                                                                    |
                                                                                                                                                                    In
                                                                                                                                                                    Stock:
                                                                                                                                                                    ${data.inStock}`;
                                                                                                                                                                    }

                                                                                                                                                                    return
                                                                                                                                                                    `
                                                                                                                                                                    <td
                                                                                                                                                                        style="padding: 0;">
                                                                                                                                                                        <div title="${title}"
                                                                                                                                                                            onclick="filterKeyDb('${make}', ${year})"
                                                                                                                                                                            style="
                                            height: 20px; 
                                            width: 16px;
                                            background: ${bg}; 
                                            border-radius: 2px;
                                            opacity: ${opacity};
                                            cursor: pointer;
                                            transition: all 0.1s;
                                            border: ${border};
                                            box-sizing: border-box;
                                        " onmouseover="this.style.opacity=1; this.style.transform='scale(1.2)';" onmouseout="this.style.opacity=${opacity}; this.style.transform='scale(1)';">
                                                                                                                                                                        </div>
                                                                                                                                                                    </td>
                                                                                                                                                                    `;
                                                                                                                                                                    }).join('')}
                                                                                                                                                            </tr>
                                                                                                                                                            `;
                                                                                                                                                            }).join('')}
                                                                                                                                                        </tbody>
                                                                                                                                                        <tfoot>
                                                                                                                                                            <tr>
                                                                                                                                                                <th
                                                                                                                                                                    style="background: var(--bg-tertiary); max-width: 70px; width: 70px;">
                                                                                                                                                                </th>
                                                                                                                                                                ${years.map(y
                                                                                                                                                                =>
                                                                                                                                                                `
                                                                                                                                                                <th
                                                                                                                                                                    style="font-size: 0.5rem; color: var(--text-muted); text-align: center; padding: 4px 0 0 0; width: 18px; min-width: 18px; font-weight: 400;">
                                                                                                                                                                    <div
                                                                                                                                                                        style="transform: rotate(-45deg); white-space: nowrap;">
                                                                                                                                                                        '${String(y).slice(-2)}
                                                                                                                                                                    </div>
                                                                                                                                                                </th>
                                                                                                                                                                `).join('')}
                                                                                                                                                            </tr>
                                                                                                                                                        </tfoot>
                                                                                                                                                    </table>
                                                                                                                                                </div>
                                                                                                                                                </div>
                                                                                                                                                `;
                                                                                                                                                container.innerHTML
                                                                                                                                                =
                                                                                                                                                html;

                                                                                                                                                //
                                                                                                                                                Cache
                                                                                                                                                the
                                                                                                                                                result
                                                                                                                                                for
                                                                                                                                                performance
                                                                                                                                                cachedHeatmapHtml
                                                                                                                                                =
                                                                                                                                                html;
                                                                                                                                                heatmapCached
                                                                                                                                                =
                                                                                                                                                true;
                                                                                                                                                }

                                                                                                                                                //
                                                                                                                                                Helper
                                                                                                                                                to
                                                                                                                                                filter
                                                                                                                                                from
                                                                                                                                                chart
                                                                                                                                                click
                                                                                                                                                function
                                                                                                                                                filterKeyDb(make,
                                                                                                                                                year)
                                                                                                                                                {
                                                                                                                                                const
                                                                                                                                                searchBox
                                                                                                                                                =
                                                                                                                                                document.getElementById('fccSearch');
                                                                                                                                                searchBox.value
                                                                                                                                                =
                                                                                                                                                `${make}
                                                                                                                                                ${year}`;
                                                                                                                                                searchBox.dispatchEvent(new
                                                                                                                                                Event('input'));
                                                                                                                                                //
                                                                                                                                                Trigger
                                                                                                                                                search

                                                                                                                                                //
                                                                                                                                                Scroll
                                                                                                                                                to
                                                                                                                                                search
                                                                                                                                                results
                                                                                                                                                searchBox.scrollIntoView({
                                                                                                                                                behavior:
                                                                                                                                                'smooth',
                                                                                                                                                block:
                                                                                                                                                'center'
                                                                                                                                                });
                                                                                                                                                }

                                                                                                                                                //
                                                                                                                                                ==================
                                                                                                                                                VIN
                                                                                                                                                DECODER
                                                                                                                                                ==================

                                                                                                                                                //
                                                                                                                                                ILCO
                                                                                                                                                Key
                                                                                                                                                Parts
                                                                                                                                                Database
                                                                                                                                                (loaded
                                                                                                                                                from
                                                                                                                                                ilco_2023.json)
                                                                                                                                                let
                                                                                                                                                ilcoData
                                                                                                                                                =
                                                                                                                                                [];
                                                                                                                                                let
                                                                                                                                                ilcoDataLoaded
                                                                                                                                                =
                                                                                                                                                false;

                                                                                                                                                //
                                                                                                                                                Load
                                                                                                                                                ILCO
                                                                                                                                                key
                                                                                                                                                parts
                                                                                                                                                data
                                                                                                                                                async
                                                                                                                                                function
                                                                                                                                                loadIlcoData()
                                                                                                                                                {
                                                                                                                                                if
                                                                                                                                                (ilcoDataLoaded)
                                                                                                                                                return;
                                                                                                                                                try
                                                                                                                                                {
                                                                                                                                                const
                                                                                                                                                res
                                                                                                                                                =
                                                                                                                                                await
                                                                                                                                                fetch('data/ilco_2023.json');
                                                                                                                                                ilcoData
                                                                                                                                                =
                                                                                                                                                await
                                                                                                                                                res.json();
                                                                                                                                                ilcoDataLoaded
                                                                                                                                                =
                                                                                                                                                true;
                                                                                                                                                console.log(`Loaded
                                                                                                                                                ${ilcoData.length}
                                                                                                                                                ILCO
                                                                                                                                                key
                                                                                                                                                references`);
                                                                                                                                                }
                                                                                                                                                catch
                                                                                                                                                (e)
                                                                                                                                                {
                                                                                                                                                console.error('Failed
                                                                                                                                                to
                                                                                                                                                load
                                                                                                                                                ILCO
                                                                                                                                                data:',
                                                                                                                                                e);
                                                                                                                                                }
                                                                                                                                                }

                                                                                                                                                //
                                                                                                                                                Lookup
                                                                                                                                                ILCO
                                                                                                                                                parts
                                                                                                                                                by
                                                                                                                                                year/make/model
                                                                                                                                                function
                                                                                                                                                lookupIlcoParts(year,
                                                                                                                                                make,
                                                                                                                                                model)
                                                                                                                                                {
                                                                                                                                                if
                                                                                                                                                (!ilcoData
                                                                                                                                                ||
                                                                                                                                                ilcoData.length
                                                                                                                                                ===
                                                                                                                                                0)
                                                                                                                                                return
                                                                                                                                                null;

                                                                                                                                                const
                                                                                                                                                yearNum
                                                                                                                                                =
                                                                                                                                                parseInt(year);
                                                                                                                                                const
                                                                                                                                                makeLower
                                                                                                                                                =
                                                                                                                                                (make
                                                                                                                                                ||
                                                                                                                                                '').toLowerCase().trim();
                                                                                                                                                const
                                                                                                                                                modelLower
                                                                                                                                                =
                                                                                                                                                (model
                                                                                                                                                ||
                                                                                                                                                '').toLowerCase().trim();

                                                                                                                                                //
                                                                                                                                                Find
                                                                                                                                                all
                                                                                                                                                matching
                                                                                                                                                entries
                                                                                                                                                const
                                                                                                                                                matches
                                                                                                                                                =
                                                                                                                                                ilcoData.filter(entry
                                                                                                                                                =>
                                                                                                                                                {
                                                                                                                                                const
                                                                                                                                                entryMake
                                                                                                                                                =
                                                                                                                                                (entry.make
                                                                                                                                                ||
                                                                                                                                                '').toLowerCase().trim();
                                                                                                                                                const
                                                                                                                                                entryModel
                                                                                                                                                =
                                                                                                                                                (entry.model
                                                                                                                                                ||
                                                                                                                                                '').toLowerCase().trim();
                                                                                                                                                const
                                                                                                                                                startYear
                                                                                                                                                =
                                                                                                                                                entry.year_start
                                                                                                                                                ||
                                                                                                                                                0;
                                                                                                                                                const
                                                                                                                                                endYear
                                                                                                                                                =
                                                                                                                                                entry.year_end
                                                                                                                                                ||
                                                                                                                                                9999;

                                                                                                                                                //
                                                                                                                                                Check
                                                                                                                                                year
                                                                                                                                                range
                                                                                                                                                if
                                                                                                                                                (yearNum
                                                                                                                                                < startYear
                                                                                                                                                    ||
                                                                                                                                                    yearNum>
                                                                                                                                                    endYear)
                                                                                                                                                    return
                                                                                                                                                    false;

                                                                                                                                                    //
                                                                                                                                                    Check
                                                                                                                                                    make
                                                                                                                                                    (exact
                                                                                                                                                    match
                                                                                                                                                    or
                                                                                                                                                    contains)
                                                                                                                                                    if
                                                                                                                                                    (entryMake
                                                                                                                                                    !==
                                                                                                                                                    makeLower
                                                                                                                                                    &&
                                                                                                                                                    !entryMake.includes(makeLower)
                                                                                                                                                    &&
                                                                                                                                                    !makeLower.includes(entryMake))
                                                                                                                                                    return
                                                                                                                                                    false;

                                                                                                                                                    //
                                                                                                                                                    Check
                                                                                                                                                    model
                                                                                                                                                    (partial
                                                                                                                                                    match
                                                                                                                                                    -
                                                                                                                                                    model
                                                                                                                                                    names
                                                                                                                                                    vary)
                                                                                                                                                    if
                                                                                                                                                    (modelLower
                                                                                                                                                    &&
                                                                                                                                                    entryModel
                                                                                                                                                    &&
                                                                                                                                                    !entryModel.includes(modelLower)
                                                                                                                                                    &&
                                                                                                                                                    !modelLower.includes(entryModel))
                                                                                                                                                    {
                                                                                                                                                    //
                                                                                                                                                    Try
                                                                                                                                                    without
                                                                                                                                                    trim/variant
                                                                                                                                                    suffixes
                                                                                                                                                    const
                                                                                                                                                    baseModel
                                                                                                                                                    =
                                                                                                                                                    modelLower.split('
                                                                                                                                                    ')[0];
                                                                                                                                                    const
                                                                                                                                                    entryBaseModel
                                                                                                                                                    =
                                                                                                                                                    entryModel.split('
                                                                                                                                                    ')[0];
                                                                                                                                                    if
                                                                                                                                                    (baseModel
                                                                                                                                                    !==
                                                                                                                                                    entryBaseModel
                                                                                                                                                    &&
                                                                                                                                                    !entryBaseModel.includes(baseModel))
                                                                                                                                                    return
                                                                                                                                                    false;
                                                                                                                                                    }

                                                                                                                                                    return
                                                                                                                                                    true;
                                                                                                                                                    });

                                                                                                                                                    if
                                                                                                                                                    (matches.length
                                                                                                                                                    ===
                                                                                                                                                    0)
                                                                                                                                                    return
                                                                                                                                                    null;

                                                                                                                                                    //
                                                                                                                                                    Collect
                                                                                                                                                    unique
                                                                                                                                                    ILCO
                                                                                                                                                    refs,
                                                                                                                                                    chip
                                                                                                                                                    types,
                                                                                                                                                    and
                                                                                                                                                    key
                                                                                                                                                    types
                                                                                                                                                    const
                                                                                                                                                    ilcoRefs
                                                                                                                                                    =
                                                                                                                                                    [...new
                                                                                                                                                    Set(matches.map(m
                                                                                                                                                    =>
                                                                                                                                                    m.ilco_ref).filter(r
                                                                                                                                                    =>
                                                                                                                                                    r
                                                                                                                                                    &&
                                                                                                                                                    !r.includes('OEM#')))];
                                                                                                                                                    const
                                                                                                                                                    chipTypes
                                                                                                                                                    =
                                                                                                                                                    [...new
                                                                                                                                                    Set(matches.map(m
                                                                                                                                                    =>
                                                                                                                                                    m.chip_type).filter(Boolean))];
                                                                                                                                                    const
                                                                                                                                                    keyTypes
                                                                                                                                                    =
                                                                                                                                                    [...new
                                                                                                                                                    Set(matches.map(m
                                                                                                                                                    =>
                                                                                                                                                    m.key_type).filter(Boolean))];
                                                                                                                                                    const
                                                                                                                                                    codeSeries
                                                                                                                                                    =
                                                                                                                                                    [...new
                                                                                                                                                    Set(matches.map(m
                                                                                                                                                    =>
                                                                                                                                                    m.code_series).filter(Boolean))];
                                                                                                                                                    const
                                                                                                                                                    notes
                                                                                                                                                    =
                                                                                                                                                    matches.find(m
                                                                                                                                                    =>
                                                                                                                                                    m.notes)?.notes
                                                                                                                                                    ||
                                                                                                                                                    null;

                                                                                                                                                    return
                                                                                                                                                    {
                                                                                                                                                    ilco:
                                                                                                                                                    ilcoRefs.slice(0,
                                                                                                                                                    3),
                                                                                                                                                    //
                                                                                                                                                    Top
                                                                                                                                                    3
                                                                                                                                                    ILCO
                                                                                                                                                    refs
                                                                                                                                                    chip_types:
                                                                                                                                                    chipTypes,
                                                                                                                                                    key_types:
                                                                                                                                                    keyTypes,
                                                                                                                                                    code_series:
                                                                                                                                                    codeSeries.slice(0,
                                                                                                                                                    2),
                                                                                                                                                    notes:
                                                                                                                                                    notes,
                                                                                                                                                    total_matches:
                                                                                                                                                    matches.length
                                                                                                                                                    };
                                                                                                                                                    }

                                                                                                                                                    //
                                                                                                                                                    Strattec
                                                                                                                                                    Key
                                                                                                                                                    Parts
                                                                                                                                                    Database
                                                                                                                                                    (loaded
                                                                                                                                                    from
                                                                                                                                                    strattec_2008_clean.json)
                                                                                                                                                    let
                                                                                                                                                    strattecData
                                                                                                                                                    =
                                                                                                                                                    [];
                                                                                                                                                    let
                                                                                                                                                    strattecDataLoaded
                                                                                                                                                    =
                                                                                                                                                    false;

                                                                                                                                                    //
                                                                                                                                                    Load
                                                                                                                                                    Strattec
                                                                                                                                                    key
                                                                                                                                                    parts
                                                                                                                                                    data
                                                                                                                                                    async
                                                                                                                                                    function
                                                                                                                                                    loadStrattecData()
                                                                                                                                                    {
                                                                                                                                                    if
                                                                                                                                                    (strattecDataLoaded)
                                                                                                                                                    return;
                                                                                                                                                    try
                                                                                                                                                    {
                                                                                                                                                    const
                                                                                                                                                    res
                                                                                                                                                    =
                                                                                                                                                    await
                                                                                                                                                    fetch('data/strattec_2008_clean.json');
                                                                                                                                                    strattecData
                                                                                                                                                    =
                                                                                                                                                    await
                                                                                                                                                    res.json();
                                                                                                                                                    strattecDataLoaded
                                                                                                                                                    =
                                                                                                                                                    true;
                                                                                                                                                    console.log(`Loaded
                                                                                                                                                    ${strattecData.length}
                                                                                                                                                    Strattec
                                                                                                                                                    key
                                                                                                                                                    references`);
                                                                                                                                                    }
                                                                                                                                                    catch
                                                                                                                                                    (e)
                                                                                                                                                    {
                                                                                                                                                    console.error('Failed
                                                                                                                                                    to
                                                                                                                                                    load
                                                                                                                                                    Strattec
                                                                                                                                                    data:',
                                                                                                                                                    e);
                                                                                                                                                    }
                                                                                                                                                    }

                                                                                                                                                    //
                                                                                                                                                    Lookup
                                                                                                                                                    Strattec
                                                                                                                                                    parts
                                                                                                                                                    by
                                                                                                                                                    year/make/model
                                                                                                                                                    function
                                                                                                                                                    lookupStrattecParts(year,
                                                                                                                                                    make,
                                                                                                                                                    model)
                                                                                                                                                    {
                                                                                                                                                    //
                                                                                                                                                    Modern
                                                                                                                                                    Cross-Reference
                                                                                                                                                    (2010-2025)
                                                                                                                                                    const
                                                                                                                                                    modernMappings
                                                                                                                                                    =
                                                                                                                                                    [
                                                                                                                                                    {
                                                                                                                                                    make:
                                                                                                                                                    'Chevrolet',
                                                                                                                                                    model:
                                                                                                                                                    'Cruze',
                                                                                                                                                    year_start:
                                                                                                                                                    2011,
                                                                                                                                                    year_end:
                                                                                                                                                    2016,
                                                                                                                                                    strattec:
                                                                                                                                                    '5912545'
                                                                                                                                                    },
                                                                                                                                                    {
                                                                                                                                                    make:
                                                                                                                                                    'Chevrolet',
                                                                                                                                                    model:
                                                                                                                                                    'Equinox',
                                                                                                                                                    year_start:
                                                                                                                                                    2010,
                                                                                                                                                    year_end:
                                                                                                                                                    2017,
                                                                                                                                                    strattec:
                                                                                                                                                    '5912543'
                                                                                                                                                    },
                                                                                                                                                    {
                                                                                                                                                    make:
                                                                                                                                                    'Chevrolet',
                                                                                                                                                    model:
                                                                                                                                                    'Silverado
                                                                                                                                                    1500',
                                                                                                                                                    year_start:
                                                                                                                                                    2014,
                                                                                                                                                    year_end:
                                                                                                                                                    2018,
                                                                                                                                                    strattec:
                                                                                                                                                    '5922534'
                                                                                                                                                    },
                                                                                                                                                    {
                                                                                                                                                    make:
                                                                                                                                                    'Chevrolet',
                                                                                                                                                    model:
                                                                                                                                                    'Silverado
                                                                                                                                                    1500',
                                                                                                                                                    year_start:
                                                                                                                                                    2007,
                                                                                                                                                    year_end:
                                                                                                                                                    2013,
                                                                                                                                                    strattec:
                                                                                                                                                    '5903089'
                                                                                                                                                    },
                                                                                                                                                    {
                                                                                                                                                    make:
                                                                                                                                                    'GMC',
                                                                                                                                                    model:
                                                                                                                                                    'Sierra',
                                                                                                                                                    year_start:
                                                                                                                                                    2014,
                                                                                                                                                    year_end:
                                                                                                                                                    2019,
                                                                                                                                                    strattec:
                                                                                                                                                    '5912545'
                                                                                                                                                    },
                                                                                                                                                    {
                                                                                                                                                    make:
                                                                                                                                                    'Ford',
                                                                                                                                                    model:
                                                                                                                                                    'F-150',
                                                                                                                                                    year_start:
                                                                                                                                                    2011,
                                                                                                                                                    year_end:
                                                                                                                                                    2014,
                                                                                                                                                    strattec:
                                                                                                                                                    '5912560'
                                                                                                                                                    },
                                                                                                                                                    {
                                                                                                                                                    make:
                                                                                                                                                    'Ford',
                                                                                                                                                    model:
                                                                                                                                                    'F-150',
                                                                                                                                                    year_start:
                                                                                                                                                    2015,
                                                                                                                                                    year_end:
                                                                                                                                                    2020,
                                                                                                                                                    strattec:
                                                                                                                                                    '5925315'
                                                                                                                                                    },
                                                                                                                                                    {
                                                                                                                                                    make:
                                                                                                                                                    'Ford',
                                                                                                                                                    model:
                                                                                                                                                    'Fusion',
                                                                                                                                                    year_start:
                                                                                                                                                    2013,
                                                                                                                                                    year_end:
                                                                                                                                                    2016,
                                                                                                                                                    strattec:
                                                                                                                                                    '5923667'
                                                                                                                                                    },
                                                                                                                                                    {
                                                                                                                                                    make:
                                                                                                                                                    'Ford',
                                                                                                                                                    model:
                                                                                                                                                    'Explorer',
                                                                                                                                                    year_start:
                                                                                                                                                    2011,
                                                                                                                                                    year_end:
                                                                                                                                                    2015,
                                                                                                                                                    strattec:
                                                                                                                                                    '5921287'
                                                                                                                                                    },
                                                                                                                                                    {
                                                                                                                                                    make:
                                                                                                                                                    'Jeep',
                                                                                                                                                    model:
                                                                                                                                                    'Grand
                                                                                                                                                    Cherokee',
                                                                                                                                                    year_start:
                                                                                                                                                    2014,
                                                                                                                                                    year_end:
                                                                                                                                                    2021,
                                                                                                                                                    strattec:
                                                                                                                                                    '5926058'
                                                                                                                                                    },
                                                                                                                                                    {
                                                                                                                                                    make:
                                                                                                                                                    'Honda',
                                                                                                                                                    model:
                                                                                                                                                    'Accord',
                                                                                                                                                    year_start:
                                                                                                                                                    2008,
                                                                                                                                                    year_end:
                                                                                                                                                    2012,
                                                                                                                                                    strattec:
                                                                                                                                                    '5907553'
                                                                                                                                                    }
                                                                                                                                                    ];

                                                                                                                                                    const
                                                                                                                                                    yearNum
                                                                                                                                                    =
                                                                                                                                                    parseInt(year);
                                                                                                                                                    const
                                                                                                                                                    makeLower
                                                                                                                                                    =
                                                                                                                                                    (make
                                                                                                                                                    ||
                                                                                                                                                    '').toLowerCase().trim();
                                                                                                                                                    const
                                                                                                                                                    modelLower
                                                                                                                                                    =
                                                                                                                                                    (model
                                                                                                                                                    ||
                                                                                                                                                    '').toLowerCase().trim();

                                                                                                                                                    //
                                                                                                                                                    Check
                                                                                                                                                    modern
                                                                                                                                                    mappings
                                                                                                                                                    first
                                                                                                                                                    (higher
                                                                                                                                                    confidence)
                                                                                                                                                    const
                                                                                                                                                    modernMatch
                                                                                                                                                    =
                                                                                                                                                    modernMappings.find(m
                                                                                                                                                    =>
                                                                                                                                                    {
                                                                                                                                                    const
                                                                                                                                                    mMake
                                                                                                                                                    =
                                                                                                                                                    m.make.toLowerCase();
                                                                                                                                                    const
                                                                                                                                                    mModel
                                                                                                                                                    =
                                                                                                                                                    m.model.toLowerCase();
                                                                                                                                                    return
                                                                                                                                                    (makeLower.includes(mMake)
                                                                                                                                                    ||
                                                                                                                                                    mMake.includes(makeLower))
                                                                                                                                                    &&
                                                                                                                                                    (modelLower.includes(mModel)
                                                                                                                                                    ||
                                                                                                                                                    mModel.includes(modelLower))
                                                                                                                                                    &&
                                                                                                                                                    yearNum
                                                                                                                                                    >=
                                                                                                                                                    m.year_start
                                                                                                                                                    &&
                                                                                                                                                    yearNum
                                                                                                                                                    <= m.year_end;
                                                                                                                                                        });
                                                                                                                                                        if
                                                                                                                                                        (modernMatch)
                                                                                                                                                        {
                                                                                                                                                        return
                                                                                                                                                        {
                                                                                                                                                        strattec:
                                                                                                                                                        [modernMatch.strattec],
                                                                                                                                                        source: 'cross-reference'
                                                                                                                                                        };
                                                                                                                                                        }
                                                                                                                                                        if
                                                                                                                                                        (!strattecData
                                                                                                                                                        ||
                                                                                                                                                        strattecData.length===0)
                                                                                                                                                        return
                                                                                                                                                        null;
                                                                                                                                                        //
                                                                                                                                                        Find
                                                                                                                                                        all
                                                                                                                                                        matching
                                                                                                                                                        entries
                                                                                                                                                        in
                                                                                                                                                        historical
                                                                                                                                                        data
                                                                                                                                                        const
                                                                                                                                                        matches=strattecData.filter(entry=>
                                                                                                                                                        {
                                                                                                                                                        const
                                                                                                                                                        entryMake
                                                                                                                                                        =
                                                                                                                                                        (entry.make
                                                                                                                                                        ||
                                                                                                                                                        '').toLowerCase().trim();
                                                                                                                                                        const
                                                                                                                                                        entryModel
                                                                                                                                                        =
                                                                                                                                                        (entry.model
                                                                                                                                                        ||
                                                                                                                                                        '').toLowerCase().trim();
                                                                                                                                                        const
                                                                                                                                                        startYear
                                                                                                                                                        =
                                                                                                                                                        entry.year_start
                                                                                                                                                        ||
                                                                                                                                                        0;
                                                                                                                                                        const
                                                                                                                                                        endYear
                                                                                                                                                        =
                                                                                                                                                        entry.year_end
                                                                                                                                                        ||
                                                                                                                                                        9999;

                                                                                                                                                        if
                                                                                                                                                        (yearNum
                                                                                                                                                        < startYear
                                                                                                                                                            ||
                                                                                                                                                            yearNum>
                                                                                                                                                            endYear)
                                                                                                                                                            return
                                                                                                                                                            false;
                                                                                                                                                            if
                                                                                                                                                            (entryMake
                                                                                                                                                            !==
                                                                                                                                                            makeLower
                                                                                                                                                            &&
                                                                                                                                                            !entryMake.includes(makeLower)
                                                                                                                                                            &&
                                                                                                                                                            !makeLower.includes(entryMake))
                                                                                                                                                            return
                                                                                                                                                            false;

                                                                                                                                                            if
                                                                                                                                                            (modelLower
                                                                                                                                                            &&
                                                                                                                                                            entryModel
                                                                                                                                                            &&
                                                                                                                                                            !entryModel.includes(modelLower)
                                                                                                                                                            &&
                                                                                                                                                            !modelLower.includes(entryModel))
                                                                                                                                                            {
                                                                                                                                                            const
                                                                                                                                                            baseModel
                                                                                                                                                            =
                                                                                                                                                            modelLower.split('
                                                                                                                                                            ')[0];
                                                                                                                                                            const
                                                                                                                                                            entryBaseModel
                                                                                                                                                            =
                                                                                                                                                            entryModel.split('
                                                                                                                                                            ')[0];
                                                                                                                                                            if
                                                                                                                                                            (baseModel
                                                                                                                                                            !==
                                                                                                                                                            entryBaseModel
                                                                                                                                                            &&
                                                                                                                                                            !entryBaseModel.includes(baseModel))
                                                                                                                                                            return
                                                                                                                                                            false;
                                                                                                                                                            }
                                                                                                                                                            return
                                                                                                                                                            true;
                                                                                                                                                            });

                                                                                                                                                            if
                                                                                                                                                            (matches.length
                                                                                                                                                            ===
                                                                                                                                                            0)
                                                                                                                                                            return
                                                                                                                                                            null;

                                                                                                                                                            const
                                                                                                                                                            strattecRefs
                                                                                                                                                            =
                                                                                                                                                            [...new
                                                                                                                                                            Set(matches.map(m
                                                                                                                                                            =>
                                                                                                                                                            m.strattec_ref).filter(Boolean))];

                                                                                                                                                            return
                                                                                                                                                            {
                                                                                                                                                            strattec:
                                                                                                                                                            strattecRefs.slice(0,
                                                                                                                                                            3),
                                                                                                                                                            source:
                                                                                                                                                            'strattec_2008'
                                                                                                                                                            };
                                                                                                                                                            }

                                                                                                                                                            //
                                                                                                                                                            Camera
                                                                                                                                                            scanner
                                                                                                                                                            state
                                                                                                                                                            let
                                                                                                                                                            vinCameraStream
                                                                                                                                                            =
                                                                                                                                                            null;

                                                                                                                                                            //
                                                                                                                                                            Start
                                                                                                                                                            camera
                                                                                                                                                            for
                                                                                                                                                            VIN
                                                                                                                                                            scanning
                                                                                                                                                            async
                                                                                                                                                            function
                                                                                                                                                            startVinCamera()
                                                                                                                                                            {
                                                                                                                                                            const
                                                                                                                                                            modal
                                                                                                                                                            =
                                                                                                                                                            document.getElementById('vinCameraModal');
                                                                                                                                                            const
                                                                                                                                                            video
                                                                                                                                                            =
                                                                                                                                                            document.getElementById('vinCameraVideo');
                                                                                                                                                            const
                                                                                                                                                            errorEl
                                                                                                                                                            =
                                                                                                                                                            document.getElementById('vinError');

                                                                                                                                                            try
                                                                                                                                                            {
                                                                                                                                                            //
                                                                                                                                                            Request
                                                                                                                                                            camera
                                                                                                                                                            access
                                                                                                                                                            (prefer
                                                                                                                                                            back
                                                                                                                                                            camera
                                                                                                                                                            on
                                                                                                                                                            mobile)
                                                                                                                                                            vinCameraStream
                                                                                                                                                            =
                                                                                                                                                            await
                                                                                                                                                            navigator.mediaDevices.getUserMedia({
                                                                                                                                                            video:
                                                                                                                                                            {
                                                                                                                                                            facingMode:
                                                                                                                                                            'environment',
                                                                                                                                                            width:
                                                                                                                                                            {
                                                                                                                                                            ideal:
                                                                                                                                                            1280
                                                                                                                                                            },
                                                                                                                                                            height:
                                                                                                                                                            {
                                                                                                                                                            ideal:
                                                                                                                                                            720
                                                                                                                                                            }
                                                                                                                                                            }
                                                                                                                                                            });
                                                                                                                                                            video.srcObject
                                                                                                                                                            =
                                                                                                                                                            vinCameraStream;
                                                                                                                                                            modal.style.display
                                                                                                                                                            =
                                                                                                                                                            'block';
                                                                                                                                                            document.getElementById('vinScanResult').style.display
                                                                                                                                                            =
                                                                                                                                                            'none';
                                                                                                                                                            }
                                                                                                                                                            catch
                                                                                                                                                            (err)
                                                                                                                                                            {
                                                                                                                                                            errorEl.textContent
                                                                                                                                                            =
                                                                                                                                                            'Camera
                                                                                                                                                            access
                                                                                                                                                            denied
                                                                                                                                                            or
                                                                                                                                                            not
                                                                                                                                                            available.
                                                                                                                                                            Please
                                                                                                                                                            enter
                                                                                                                                                            VIN
                                                                                                                                                            manually.';
                                                                                                                                                            errorEl.style.display
                                                                                                                                                            =
                                                                                                                                                            'block';
                                                                                                                                                            console.error('Camera
                                                                                                                                                            error:',
                                                                                                                                                            err);
                                                                                                                                                            }
                                                                                                                                                            }

                                                                                                                                                            //
                                                                                                                                                            Stop
                                                                                                                                                            camera
                                                                                                                                                            function
                                                                                                                                                            stopVinCamera()
                                                                                                                                                            {
                                                                                                                                                            const
                                                                                                                                                            modal
                                                                                                                                                            =
                                                                                                                                                            document.getElementById('vinCameraModal');
                                                                                                                                                            const
                                                                                                                                                            video
                                                                                                                                                            =
                                                                                                                                                            document.getElementById('vinCameraVideo');

                                                                                                                                                            if
                                                                                                                                                            (vinCameraStream)
                                                                                                                                                            {
                                                                                                                                                            vinCameraStream.getTracks().forEach(track
                                                                                                                                                            =>
                                                                                                                                                            track.stop());
                                                                                                                                                            vinCameraStream
                                                                                                                                                            =
                                                                                                                                                            null;
                                                                                                                                                            }
                                                                                                                                                            video.srcObject
                                                                                                                                                            =
                                                                                                                                                            null;
                                                                                                                                                            modal.style.display
                                                                                                                                                            =
                                                                                                                                                            'none';
                                                                                                                                                            }

                                                                                                                                                            //
                                                                                                                                                            Capture
                                                                                                                                                            frame
                                                                                                                                                            and
                                                                                                                                                            extract
                                                                                                                                                            VIN
                                                                                                                                                            async
                                                                                                                                                            function
                                                                                                                                                            captureVinFrame(event)
                                                                                                                                                            {
                                                                                                                                                            const
                                                                                                                                                            video
                                                                                                                                                            =
                                                                                                                                                            document.getElementById('vinCameraVideo');
                                                                                                                                                            const
                                                                                                                                                            canvas
                                                                                                                                                            =
                                                                                                                                                            document.getElementById('vinCameraCanvas');
                                                                                                                                                            const
                                                                                                                                                            resultEl
                                                                                                                                                            =
                                                                                                                                                            document.getElementById('vinScanResult');
                                                                                                                                                            const
                                                                                                                                                            detectedText
                                                                                                                                                            =
                                                                                                                                                            document.getElementById('vinDetectedText');
                                                                                                                                                            const
                                                                                                                                                            captureBtn
                                                                                                                                                            =
                                                                                                                                                            event.currentTarget;

                                                                                                                                                            //
                                                                                                                                                            Visual
                                                                                                                                                            feedback
                                                                                                                                                            const
                                                                                                                                                            originalText
                                                                                                                                                            =
                                                                                                                                                            captureBtn.innerHTML;
                                                                                                                                                            captureBtn.disabled
                                                                                                                                                            =
                                                                                                                                                            true;
                                                                                                                                                            captureBtn.innerHTML
                                                                                                                                                            =
                                                                                                                                                            'âŒ›
                                                                                                                                                            Scanning...';

                                                                                                                                                            //
                                                                                                                                                            Draw
                                                                                                                                                            current
                                                                                                                                                            frame
                                                                                                                                                            to
                                                                                                                                                            canvas
                                                                                                                                                            canvas.width
                                                                                                                                                            =
                                                                                                                                                            video.videoWidth;
                                                                                                                                                            canvas.height
                                                                                                                                                            =
                                                                                                                                                            video.videoHeight;
                                                                                                                                                            const
                                                                                                                                                            ctx
                                                                                                                                                            =
                                                                                                                                                            canvas.getContext('2d');
                                                                                                                                                            ctx.drawImage(video,
                                                                                                                                                            0,
                                                                                                                                                            0);

                                                                                                                                                            try
                                                                                                                                                            {
                                                                                                                                                            //
                                                                                                                                                            OCR
                                                                                                                                                            with
                                                                                                                                                            Tesseract.js
                                                                                                                                                            const
                                                                                                                                                            {
                                                                                                                                                            data:
                                                                                                                                                            {
                                                                                                                                                            text
                                                                                                                                                            }
                                                                                                                                                            }
                                                                                                                                                            =
                                                                                                                                                            await
                                                                                                                                                            Tesseract.recognize(canvas,
                                                                                                                                                            'eng',
                                                                                                                                                            {
                                                                                                                                                            logger:
                                                                                                                                                            m
                                                                                                                                                            =>
                                                                                                                                                            console.log('ðŸ”
                                                                                                                                                            OCR:',
                                                                                                                                                            m.status,
                                                                                                                                                            Math.round(m.progress
                                                                                                                                                            *
                                                                                                                                                            100)
                                                                                                                                                            +
                                                                                                                                                            '%')
                                                                                                                                                            });

                                                                                                                                                            //
                                                                                                                                                            Extract
                                                                                                                                                            VIN
                                                                                                                                                            pattern
                                                                                                                                                            (17
                                                                                                                                                            alphanumeric
                                                                                                                                                            chars,
                                                                                                                                                            excluding
                                                                                                                                                            I,
                                                                                                                                                            O,
                                                                                                                                                            Q)
                                                                                                                                                            const
                                                                                                                                                            vinPattern
                                                                                                                                                            =
                                                                                                                                                            /[A-HJ-NPR-Z0-9]{17}/gi;
                                                                                                                                                            const
                                                                                                                                                            matches
                                                                                                                                                            =
                                                                                                                                                            text.toUpperCase().replace(/\s/g,
                                                                                                                                                            '').match(vinPattern);

                                                                                                                                                            if
                                                                                                                                                            (matches
                                                                                                                                                            &&
                                                                                                                                                            matches.length
                                                                                                                                                            >
                                                                                                                                                            0)
                                                                                                                                                            {
                                                                                                                                                            const
                                                                                                                                                            foundVin
                                                                                                                                                            =
                                                                                                                                                            matches[0];
                                                                                                                                                            detectedText.textContent
                                                                                                                                                            =
                                                                                                                                                            foundVin;
                                                                                                                                                            resultEl.style.display
                                                                                                                                                            =
                                                                                                                                                            'block';
                                                                                                                                                            }
                                                                                                                                                            else
                                                                                                                                                            {
                                                                                                                                                            //
                                                                                                                                                            Fallback
                                                                                                                                                            to
                                                                                                                                                            manual
                                                                                                                                                            entry
                                                                                                                                                            if
                                                                                                                                                            OCR
                                                                                                                                                            fails
                                                                                                                                                            to
                                                                                                                                                            find
                                                                                                                                                            a
                                                                                                                                                            VIN
                                                                                                                                                            const
                                                                                                                                                            manualVin
                                                                                                                                                            =
                                                                                                                                                            prompt('ðŸ“·
                                                                                                                                                            Capture
                                                                                                                                                            complete,
                                                                                                                                                            but
                                                                                                                                                            no
                                                                                                                                                            VIN
                                                                                                                                                            was
                                                                                                                                                            automatically
                                                                                                                                                            detected.\n\nPlease
                                                                                                                                                            enter
                                                                                                                                                            the
                                                                                                                                                            17-character
                                                                                                                                                            VIN
                                                                                                                                                            manually:\n(Looking
                                                                                                                                                            at
                                                                                                                                                            the
                                                                                                                                                            image
                                                                                                                                                            you
                                                                                                                                                            just
                                                                                                                                                            took)');
                                                                                                                                                            if
                                                                                                                                                            (manualVin)
                                                                                                                                                            {
                                                                                                                                                            const
                                                                                                                                                            cleanVin
                                                                                                                                                            =
                                                                                                                                                            manualVin.toUpperCase().replace(/[^A-HJ-NPR-Z0-9]/g,
                                                                                                                                                            '');
                                                                                                                                                            if
                                                                                                                                                            (cleanVin.length
                                                                                                                                                            ===
                                                                                                                                                            17)
                                                                                                                                                            {
                                                                                                                                                            detectedText.textContent
                                                                                                                                                            =
                                                                                                                                                            cleanVin;
                                                                                                                                                            resultEl.style.display
                                                                                                                                                            =
                                                                                                                                                            'block';
                                                                                                                                                            }
                                                                                                                                                            else
                                                                                                                                                            {
                                                                                                                                                            alert('VIN
                                                                                                                                                            must
                                                                                                                                                            be
                                                                                                                                                            17
                                                                                                                                                            characters.
                                                                                                                                                            Try
                                                                                                                                                            again
                                                                                                                                                            or
                                                                                                                                                            enter
                                                                                                                                                            manually.');
                                                                                                                                                            }
                                                                                                                                                            }
                                                                                                                                                            }
                                                                                                                                                            }
                                                                                                                                                            catch
                                                                                                                                                            (err)
                                                                                                                                                            {
                                                                                                                                                            console.error('OCR
                                                                                                                                                            Error:',
                                                                                                                                                            err);
                                                                                                                                                            alert('OCR
                                                                                                                                                            failed.
                                                                                                                                                            Please
                                                                                                                                                            enter
                                                                                                                                                            VIN
                                                                                                                                                            manually.');
                                                                                                                                                            }
                                                                                                                                                            finally
                                                                                                                                                            {
                                                                                                                                                            captureBtn.disabled
                                                                                                                                                            =
                                                                                                                                                            false;
                                                                                                                                                            captureBtn.innerHTML
                                                                                                                                                            =
                                                                                                                                                            originalText;
                                                                                                                                                            }
                                                                                                                                                            }

                                                                                                                                                            //
                                                                                                                                                            Use
                                                                                                                                                            detected
                                                                                                                                                            VIN
                                                                                                                                                            //
                                                                                                                                                            Use
                                                                                                                                                            detected
                                                                                                                                                            VIN
                                                                                                                                                            from
                                                                                                                                                            camera
                                                                                                                                                            function
                                                                                                                                                            useDetectedVin()
                                                                                                                                                            {
                                                                                                                                                            const
                                                                                                                                                            vin
                                                                                                                                                            =
                                                                                                                                                            document.getElementById('vinDetectedText').textContent;
                                                                                                                                                            const
                                                                                                                                                            omni
                                                                                                                                                            =
                                                                                                                                                            document.getElementById('omniSearch');
                                                                                                                                                            if
                                                                                                                                                            (omni)
                                                                                                                                                            {
                                                                                                                                                            omni.value
                                                                                                                                                            =
                                                                                                                                                            vin;
                                                                                                                                                            stopVinCamera();
                                                                                                                                                            decodeVin(vin);
                                                                                                                                                            }
                                                                                                                                                            }

                                                                                                                                                            //
                                                                                                                                                            Quick
                                                                                                                                                            lookup
                                                                                                                                                            helper
                                                                                                                                                            function
                                                                                                                                                            lookupVin(vin)
                                                                                                                                                            {
                                                                                                                                                            const
                                                                                                                                                            omni
                                                                                                                                                            =
                                                                                                                                                            document.getElementById('omniSearch');
                                                                                                                                                            if
                                                                                                                                                            (omni)
                                                                                                                                                            {
                                                                                                                                                            omni.value
                                                                                                                                                            =
                                                                                                                                                            vin;
                                                                                                                                                            decodeVin(vin);
                                                                                                                                                            omni.scrollIntoView({
                                                                                                                                                            behavior:
                                                                                                                                                            'smooth',
                                                                                                                                                            block:
                                                                                                                                                            'center'
                                                                                                                                                            });
                                                                                                                                                            }
                                                                                                                                                            }

                                                                                                                                                            async
                                                                                                                                                            function
                                                                                                                                                            decodeVin(vinOverride)
                                                                                                                                                            {
                                                                                                                                                            const
                                                                                                                                                            query
                                                                                                                                                            =
                                                                                                                                                            vinOverride
                                                                                                                                                            ||
                                                                                                                                                            document.getElementById('omniSearch').value.trim();
                                                                                                                                                            const
                                                                                                                                                            vin
                                                                                                                                                            =
                                                                                                                                                            query.toUpperCase().replace(/[^A-HJ-NPR-Z0-9]/g,
                                                                                                                                                            '');
                                                                                                                                                            const
                                                                                                                                                            errorEl
                                                                                                                                                            =
                                                                                                                                                            document.getElementById('vinError');
                                                                                                                                                            const
                                                                                                                                                            resultsEl
                                                                                                                                                            =
                                                                                                                                                            document.getElementById('vinResults');
                                                                                                                                                            const
                                                                                                                                                            loadingEl
                                                                                                                                                            =
                                                                                                                                                            document.getElementById('vinLoading');

                                                                                                                                                            //
                                                                                                                                                            Validate
                                                                                                                                                            VIN
                                                                                                                                                            (17
                                                                                                                                                            chars,
                                                                                                                                                            no
                                                                                                                                                            I,
                                                                                                                                                            O,
                                                                                                                                                            Q)
                                                                                                                                                            if
                                                                                                                                                            (vin.length
                                                                                                                                                            !==
                                                                                                                                                            17)
                                                                                                                                                            {
                                                                                                                                                            if
                                                                                                                                                            (errorEl)
                                                                                                                                                            {
                                                                                                                                                            errorEl.textContent
                                                                                                                                                            =
                                                                                                                                                            'VIN
                                                                                                                                                            must
                                                                                                                                                            be
                                                                                                                                                            exactly
                                                                                                                                                            17
                                                                                                                                                            characters.
                                                                                                                                                            Currently:
                                                                                                                                                            '
                                                                                                                                                            +
                                                                                                                                                            vin.length;
                                                                                                                                                            errorEl.style.display
                                                                                                                                                            =
                                                                                                                                                            'block';
                                                                                                                                                            //
                                                                                                                                                            Auto-hide
                                                                                                                                                            error
                                                                                                                                                            after
                                                                                                                                                            5s
                                                                                                                                                            setTimeout(()
                                                                                                                                                            =>
                                                                                                                                                            errorEl.style.display
                                                                                                                                                            =
                                                                                                                                                            'none',
                                                                                                                                                            5000);
                                                                                                                                                            }
                                                                                                                                                            if
                                                                                                                                                            (resultsEl)
                                                                                                                                                            resultsEl.style.display
                                                                                                                                                            =
                                                                                                                                                            'none';
                                                                                                                                                            return;
                                                                                                                                                            }

                                                                                                                                                            if
                                                                                                                                                            (errorEl)
                                                                                                                                                            errorEl.style.display
                                                                                                                                                            =
                                                                                                                                                            'none';
                                                                                                                                                            if
                                                                                                                                                            (loadingEl)
                                                                                                                                                            loadingEl.style.display
                                                                                                                                                            =
                                                                                                                                                            'block';
                                                                                                                                                            if
                                                                                                                                                            (resultsEl)
                                                                                                                                                            resultsEl.style.display
                                                                                                                                                            =
                                                                                                                                                            'none';

                                                                                                                                                            //
                                                                                                                                                            Ensure
                                                                                                                                                            we
                                                                                                                                                            are
                                                                                                                                                            on
                                                                                                                                                            the
                                                                                                                                                            browse
                                                                                                                                                            tab
                                                                                                                                                            showTab('browse',
                                                                                                                                                            false);

                                                                                                                                                            try
                                                                                                                                                            {
                                                                                                                                                            //
                                                                                                                                                            1.
                                                                                                                                                            Call
                                                                                                                                                            NHTSA
                                                                                                                                                            VIN
                                                                                                                                                            Decoder
                                                                                                                                                            API
                                                                                                                                                            const
                                                                                                                                                            nhtsaRes
                                                                                                                                                            =
                                                                                                                                                            await
                                                                                                                                                            fetch(`https://vpic.nhtsa.dot.gov/api/vehicles/decodevin/${vin}?format=json`);
                                                                                                                                                            const
                                                                                                                                                            nhtsaData
                                                                                                                                                            =
                                                                                                                                                            await
                                                                                                                                                            nhtsaRes.json();

                                                                                                                                                            //
                                                                                                                                                            Extract
                                                                                                                                                            key
                                                                                                                                                            vehicle
                                                                                                                                                            info
                                                                                                                                                            const
                                                                                                                                                            getVal
                                                                                                                                                            =
                                                                                                                                                            (varId)
                                                                                                                                                            =>
                                                                                                                                                            {
                                                                                                                                                            const
                                                                                                                                                            item
                                                                                                                                                            =
                                                                                                                                                            nhtsaData.Results?.find(r
                                                                                                                                                            =>
                                                                                                                                                            r.VariableId
                                                                                                                                                            ===
                                                                                                                                                            varId);
                                                                                                                                                            return
                                                                                                                                                            item?.Value
                                                                                                                                                            ||
                                                                                                                                                            null;
                                                                                                                                                            };

                                                                                                                                                            const
                                                                                                                                                            year
                                                                                                                                                            =
                                                                                                                                                            getVal(29)
                                                                                                                                                            ||
                                                                                                                                                            getVal(0);
                                                                                                                                                            //
                                                                                                                                                            Model
                                                                                                                                                            Year
                                                                                                                                                            const
                                                                                                                                                            make
                                                                                                                                                            =
                                                                                                                                                            getVal(26);
                                                                                                                                                            //
                                                                                                                                                            Make
                                                                                                                                                            const
                                                                                                                                                            model
                                                                                                                                                            =
                                                                                                                                                            getVal(28);
                                                                                                                                                            //
                                                                                                                                                            Model
                                                                                                                                                            const
                                                                                                                                                            series
                                                                                                                                                            =
                                                                                                                                                            getVal(34);
                                                                                                                                                            //
                                                                                                                                                            Series
                                                                                                                                                            const
                                                                                                                                                            bodyClass
                                                                                                                                                            =
                                                                                                                                                            getVal(5);
                                                                                                                                                            //
                                                                                                                                                            Body
                                                                                                                                                            Class
                                                                                                                                                            const
                                                                                                                                                            engineConfig
                                                                                                                                                            =
                                                                                                                                                            getVal(13);
                                                                                                                                                            //
                                                                                                                                                            Engine
                                                                                                                                                            Configuration
                                                                                                                                                            const
                                                                                                                                                            fuelType
                                                                                                                                                            =
                                                                                                                                                            getVal(24);
                                                                                                                                                            //
                                                                                                                                                            Fuel
                                                                                                                                                            Type
                                                                                                                                                            const
                                                                                                                                                            doors
                                                                                                                                                            =
                                                                                                                                                            getVal(14);
                                                                                                                                                            //
                                                                                                                                                            Doors

                                                                                                                                                            if
                                                                                                                                                            (!make
                                                                                                                                                            ||
                                                                                                                                                            !year)
                                                                                                                                                            {
                                                                                                                                                            throw
                                                                                                                                                            new
                                                                                                                                                            Error('Could
                                                                                                                                                            not
                                                                                                                                                            decode
                                                                                                                                                            VIN.
                                                                                                                                                            Please
                                                                                                                                                            check
                                                                                                                                                            and
                                                                                                                                                            try
                                                                                                                                                            again.');
                                                                                                                                                            }

                                                                                                                                                            //
                                                                                                                                                            2.
                                                                                                                                                            Display
                                                                                                                                                            vehicle
                                                                                                                                                            info
                                                                                                                                                            document.getElementById('vinVehicleInfo').innerHTML
                                                                                                                                                            =
                                                                                                                                                            `
                                                                                                                                                            <div
                                                                                                                                                                style="display: flex; align-items: center; gap: 16px; flex-wrap: wrap;">
                                                                                                                                                                <div
                                                                                                                                                                    style="font-size: 2.5rem;">
                                                                                                                                                                    ðŸš—
                                                                                                                                                                </div>
                                                                                                                                                                <div>
                                                                                                                                                                    <div
                                                                                                                                                                        style="font-size: 1.5rem; font-weight: 700; color: var(--brand-primary);">
                                                                                                                                                                        ${year}
                                                                                                                                                                        ${make}
                                                                                                                                                                        ${model}${series
                                                                                                                                                                        ?
                                                                                                                                                                        '
                                                                                                                                                                        '
                                                                                                                                                                        +
                                                                                                                                                                        series
                                                                                                                                                                        :
                                                                                                                                                                        ''}
                                                                                                                                                                    </div>
                                                                                                                                                                    <div
                                                                                                                                                                        style="color: var(--text-muted); font-size: 0.9rem; margin-top: 4px;">
                                                                                                                                                                        ${bodyClass
                                                                                                                                                                        ?
                                                                                                                                                                        bodyClass
                                                                                                                                                                        +
                                                                                                                                                                        '
                                                                                                                                                                        â€¢
                                                                                                                                                                        '
                                                                                                                                                                        :
                                                                                                                                                                        ''}${doors
                                                                                                                                                                        ?
                                                                                                                                                                        doors
                                                                                                                                                                        +
                                                                                                                                                                        '
                                                                                                                                                                        Door
                                                                                                                                                                        â€¢
                                                                                                                                                                        '
                                                                                                                                                                        :
                                                                                                                                                                        ''}${fuelType
                                                                                                                                                                        ||
                                                                                                                                                                        ''}
                                                                                                                                                                    </div>
                                                                                                                                                                    <div
                                                                                                                                                                        style="font-family: monospace; font-size: 0.85rem; color: var(--text-secondary); margin-top: 8px; letter-spacing: 1px;">
                                                                                                                                                                        VIN:
                                                                                                                                                                        ${vin}
                                                                                                                                                                    </div>
                                                                                                                                                                </div>
                                                                                                                                                            </div>
                                                                                                                                                            `;

                                                                                                                                                            //
                                                                                                                                                            Track
                                                                                                                                                            VIN
                                                                                                                                                            lookup
                                                                                                                                                            for
                                                                                                                                                            analytics
                                                                                                                                                            trackVinLookup(vin,
                                                                                                                                                            {
                                                                                                                                                            make,
                                                                                                                                                            model,
                                                                                                                                                            year
                                                                                                                                                            });

                                                                                                                                                            //
                                                                                                                                                            3.
                                                                                                                                                            Load
                                                                                                                                                            lookup
                                                                                                                                                            data
                                                                                                                                                            and
                                                                                                                                                            query
                                                                                                                                                            our
                                                                                                                                                            database
                                                                                                                                                            for
                                                                                                                                                            key
                                                                                                                                                            info
                                                                                                                                                            await
                                                                                                                                                            Promise.all([loadIlcoData(),
                                                                                                                                                            loadStrattecData()]);
                                                                                                                                                            const
                                                                                                                                                            [dbRes]
                                                                                                                                                            =
                                                                                                                                                            await
                                                                                                                                                            Promise.all([
                                                                                                                                                            fetch(`${API}/api/browse?make=${encodeURIComponent(make)}&year=${year}&limit=10`)
                                                                                                                                                            ]);
                                                                                                                                                            const
                                                                                                                                                            dbData
                                                                                                                                                            =
                                                                                                                                                            await
                                                                                                                                                            dbRes.json();
                                                                                                                                                            const
                                                                                                                                                            vehicles
                                                                                                                                                            =
                                                                                                                                                            dbData.rows
                                                                                                                                                            ||
                                                                                                                                                            [];

                                                                                                                                                            //
                                                                                                                                                            Find
                                                                                                                                                            the
                                                                                                                                                            best
                                                                                                                                                            match
                                                                                                                                                            by
                                                                                                                                                            model
                                                                                                                                                            const
                                                                                                                                                            exactMatch
                                                                                                                                                            =
                                                                                                                                                            vehicles.find(v
                                                                                                                                                            =>
                                                                                                                                                            v.model?.toLowerCase().includes(model?.toLowerCase()))
                                                                                                                                                            ||
                                                                                                                                                            vehicles[0];

                                                                                                                                                            //
                                                                                                                                                            Lookup
                                                                                                                                                            parts
                                                                                                                                                            from
                                                                                                                                                            local
                                                                                                                                                            databases
                                                                                                                                                            const
                                                                                                                                                            ilcoLookup
                                                                                                                                                            =
                                                                                                                                                            lookupIlcoParts(year,
                                                                                                                                                            make,
                                                                                                                                                            model);
                                                                                                                                                            const
                                                                                                                                                            strattecLookup
                                                                                                                                                            =
                                                                                                                                                            lookupStrattecParts(year,
                                                                                                                                                            make,
                                                                                                                                                            model);

                                                                                                                                                            //
                                                                                                                                                            4.
                                                                                                                                                            Populate
                                                                                                                                                            the
                                                                                                                                                            sections
                                                                                                                                                            -
                                                                                                                                                            prefer
                                                                                                                                                            lookups,
                                                                                                                                                            fallback
                                                                                                                                                            to
                                                                                                                                                            DB
                                                                                                                                                            const
                                                                                                                                                            ilcoDisplay
                                                                                                                                                            =
                                                                                                                                                            ilcoLookup?.ilco?.join(',
                                                                                                                                                            ')
                                                                                                                                                            ||
                                                                                                                                                            parseKeyRefs(exactMatch?.key_blank_refs,
                                                                                                                                                            'ilco')
                                                                                                                                                            ||
                                                                                                                                                            'N/A';
                                                                                                                                                            const
                                                                                                                                                            strattecDisplay
                                                                                                                                                            =
                                                                                                                                                            strattecLookup?.strattec?.join(',
                                                                                                                                                            ')
                                                                                                                                                            ||
                                                                                                                                                            parseKeyRefs(exactMatch?.key_blank_refs,
                                                                                                                                                            'strattec')
                                                                                                                                                            ||
                                                                                                                                                            'N/A';
                                                                                                                                                            const
                                                                                                                                                            keywayDisplay
                                                                                                                                                            =
                                                                                                                                                            exactMatch?.keyway
                                                                                                                                                            ||
                                                                                                                                                            'N/A';
                                                                                                                                                            const
                                                                                                                                                            chipFromIlco
                                                                                                                                                            =
                                                                                                                                                            ilcoLookup?.chip_types?.join(',
                                                                                                                                                            ')
                                                                                                                                                            ||
                                                                                                                                                            null;
                                                                                                                                                            const
                                                                                                                                                            keyTypeFromIlco
                                                                                                                                                            =
                                                                                                                                                            ilcoLookup?.key_types?.join(',
                                                                                                                                                            ')
                                                                                                                                                            ||
                                                                                                                                                            null;

                                                                                                                                                            const
                                                                                                                                                            keyBlankHtml
                                                                                                                                                            =
                                                                                                                                                            `
                                                                                                                                                            <div
                                                                                                                                                                style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                                                                                                                                                                <div
                                                                                                                                                                    style="color: var(--text-muted);">
                                                                                                                                                                    ILCO:
                                                                                                                                                                </div>
                                                                                                                                                                <div
                                                                                                                                                                    style="font-weight: 600; color: ${ilcoLookup?.ilco?.length ? '#22c55e' : 'var(--text-primary)'};">
                                                                                                                                                                    ${ilcoDisplay}
                                                                                                                                                                </div>
                                                                                                                                                                <div
                                                                                                                                                                    style="color: var(--text-muted);">
                                                                                                                                                                    Strattec:
                                                                                                                                                                </div>
                                                                                                                                                                <div
                                                                                                                                                                    style="font-weight: 600; color: ${strattecLookup?.strattec?.length ? '#22c55e' : 'var(--text-primary)'};">
                                                                                                                                                                    ${strattecDisplay}
                                                                                                                                                                </div>
                                                                                                                                                                <div
                                                                                                                                                                    style="color: var(--text-muted);">
                                                                                                                                                                    Keyway:
                                                                                                                                                                </div>
                                                                                                                                                                <div
                                                                                                                                                                    style="font-weight: 600; color: var(--text-primary);">
                                                                                                                                                                    ${keywayDisplay}
                                                                                                                                                                </div>
                                                                                                                                                                ${ilcoLookup?.code_series?.length
                                                                                                                                                                ?
                                                                                                                                                                `
                                                                                                                                                                <div
                                                                                                                                                                    style="color: var(--text-muted);">
                                                                                                                                                                    Code
                                                                                                                                                                    Series:
                                                                                                                                                                </div>
                                                                                                                                                                <div
                                                                                                                                                                    style="font-weight: 600; color: var(--text-primary);">
                                                                                                                                                                    ${ilcoLookup.code_series.join(',
                                                                                                                                                                    ')}
                                                                                                                                                                </div>
                                                                                                                                                                `
                                                                                                                                                                :
                                                                                                                                                                ''}
                                                                                                                                                            </div>
                                                                                                                                                            ${ilcoLookup?.notes
                                                                                                                                                            ?
                                                                                                                                                            `
                                                                                                                                                            <div
                                                                                                                                                                style="margin-top: 8px; font-size: 0.85rem; color: var(--text-muted); font-style: italic;">
                                                                                                                                                                ðŸ“
                                                                                                                                                                ${ilcoLookup.notes}
                                                                                                                                                            </div>
                                                                                                                                                            `
                                                                                                                                                            :
                                                                                                                                                            ''}
                                                                                                                                                            `;

                                                                                                                                                            const
                                                                                                                                                            transponderHtml
                                                                                                                                                            =
                                                                                                                                                            `
                                                                                                                                                            <div
                                                                                                                                                                style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                                                                                                                                                                <div
                                                                                                                                                                    style="color: var(--text-muted);">
                                                                                                                                                                    Chip
                                                                                                                                                                    Type:
                                                                                                                                                                </div>
                                                                                                                                                                <div
                                                                                                                                                                    style="font-weight: 600; color: ${chipFromIlco ? '#22c55e' : 'var(--text-primary)'};">
                                                                                                                                                                    ${chipFromIlco
                                                                                                                                                                    ||
                                                                                                                                                                    exactMatch?.transponder_type
                                                                                                                                                                    ||
                                                                                                                                                                    exactMatch?.chip
                                                                                                                                                                    ||
                                                                                                                                                                    'N/A'}
                                                                                                                                                                </div>
                                                                                                                                                                <div
                                                                                                                                                                    style="color: var(--text-muted);">
                                                                                                                                                                    Key
                                                                                                                                                                    Type:
                                                                                                                                                                </div>
                                                                                                                                                                <div
                                                                                                                                                                    style="font-weight: 600; color: ${keyTypeFromIlco ? '#22c55e' : 'var(--text-primary)'};">
                                                                                                                                                                    ${keyTypeFromIlco
                                                                                                                                                                    ||
                                                                                                                                                                    exactMatch?.key_type_display
                                                                                                                                                                    ||
                                                                                                                                                                    exactMatch?.key_type
                                                                                                                                                                    ||
                                                                                                                                                                    'N/A'}
                                                                                                                                                                </div>
                                                                                                                                                                <div
                                                                                                                                                                    style="color: var(--text-muted);">
                                                                                                                                                                    Immobilizer:
                                                                                                                                                                </div>
                                                                                                                                                                <div
                                                                                                                                                                    style="font-weight: 600; color: var(--text-primary);">
                                                                                                                                                                    ${exactMatch?.immobilizer_system
                                                                                                                                                                    ||
                                                                                                                                                                    'N/A'}
                                                                                                                                                                </div>
                                                                                                                                                            </div>
                                                                                                                                                            `;

                                                                                                                                                            const
                                                                                                                                                            remoteHtml
                                                                                                                                                            =
                                                                                                                                                            exactMatch
                                                                                                                                                            ?
                                                                                                                                                            `
                                                                                                                                                            <div
                                                                                                                                                                style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                                                                                                                                                                <div
                                                                                                                                                                    style="color: var(--text-muted);">
                                                                                                                                                                    FCC
                                                                                                                                                                    ID:
                                                                                                                                                                </div>
                                                                                                                                                                <div
                                                                                                                                                                    style="font-weight: 600; color: var(--text-primary);">
                                                                                                                                                                    ${exactMatch.fcc_id
                                                                                                                                                                    ||
                                                                                                                                                                    'N/A'}
                                                                                                                                                                </div>
                                                                                                                                                                <div
                                                                                                                                                                    style="color: var(--text-muted);">
                                                                                                                                                                    Frequency:
                                                                                                                                                                </div>
                                                                                                                                                                <div
                                                                                                                                                                    style="font-weight: 600; color: var(--text-primary);">
                                                                                                                                                                    ${exactMatch.frequency
                                                                                                                                                                    ?
                                                                                                                                                                    exactMatch.frequency
                                                                                                                                                                    +
                                                                                                                                                                    '
                                                                                                                                                                    MHz'
                                                                                                                                                                    :
                                                                                                                                                                    'N/A'}
                                                                                                                                                                </div>
                                                                                                                                                                <div
                                                                                                                                                                    style="color: var(--text-muted);">
                                                                                                                                                                    OEM
                                                                                                                                                                    Part:
                                                                                                                                                                </div>
                                                                                                                                                                <div
                                                                                                                                                                    style="font-weight: 600; color: var(--text-primary);">
                                                                                                                                                                    ${exactMatch.oem_part_number
                                                                                                                                                                    ||
                                                                                                                                                                    exactMatch.primary_oem_part
                                                                                                                                                                    ||
                                                                                                                                                                    'N/A'}
                                                                                                                                                                </div>
                                                                                                                                                            </div>
                                                                                                                                                            `
                                                                                                                                                            :
                                                                                                                                                            '
                                                                                                                                                            <div
                                                                                                                                                                style="color: var(--text-muted);">
                                                                                                                                                                No
                                                                                                                                                                remote/fob
                                                                                                                                                                data
                                                                                                                                                                found
                                                                                                                                                                for
                                                                                                                                                                this
                                                                                                                                                                vehicle.
                                                                                                                                                            </div>
                                                                                                                                                            ';

                                                                                                                                                            const
                                                                                                                                                            programmingHtml
                                                                                                                                                            =
                                                                                                                                                            exactMatch
                                                                                                                                                            ?
                                                                                                                                                            `
                                                                                                                                                            <div
                                                                                                                                                                style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                                                                                                                                                                <div
                                                                                                                                                                    style="color: var(--text-muted);">
                                                                                                                                                                    Equipment:
                                                                                                                                                                </div>
                                                                                                                                                                <div
                                                                                                                                                                    style="font-weight: 600; color: var(--text-primary);">
                                                                                                                                                                    ${exactMatch.programming_tool
                                                                                                                                                                    ||
                                                                                                                                                                    exactMatch.equipment_required
                                                                                                                                                                    ||
                                                                                                                                                                    'Professional
                                                                                                                                                                    Tool
                                                                                                                                                                    Required'}
                                                                                                                                                                </div>
                                                                                                                                                                <div
                                                                                                                                                                    style="color: var(--text-muted);">
                                                                                                                                                                    Procedure:
                                                                                                                                                                </div>
                                                                                                                                                                <div
                                                                                                                                                                    style="font-weight: 600; color: var(--text-primary);">
                                                                                                                                                                    ${exactMatch.programming_notes
                                                                                                                                                                    ||
                                                                                                                                                                    'Requires
                                                                                                                                                                    OBDII
                                                                                                                                                                    programming'}
                                                                                                                                                                </div>
                                                                                                                                                            </div>
                                                                                                                                                            `
                                                                                                                                                            :
                                                                                                                                                            '
                                                                                                                                                            <div
                                                                                                                                                                style="color: var(--text-muted);">
                                                                                                                                                                No
                                                                                                                                                                programming
                                                                                                                                                                info
                                                                                                                                                                found
                                                                                                                                                                for
                                                                                                                                                                this
                                                                                                                                                                vehicle.
                                                                                                                                                            </div>
                                                                                                                                                            ';

                                                                                                                                                            document.getElementById('vinKeyBlank').innerHTML
                                                                                                                                                            =
                                                                                                                                                            keyBlankHtml;
                                                                                                                                                            document.getElementById('vinTransponder').innerHTML
                                                                                                                                                            =
                                                                                                                                                            transponderHtml;
                                                                                                                                                            document.getElementById('vinRemote').innerHTML
                                                                                                                                                            =
                                                                                                                                                            remoteHtml;
                                                                                                                                                            document.getElementById('vinProgramming').innerHTML
                                                                                                                                                            =
                                                                                                                                                            programmingHtml;

                                                                                                                                                            //
                                                                                                                                                            5.
                                                                                                                                                            Build
                                                                                                                                                            Amazon
                                                                                                                                                            buy
                                                                                                                                                            links
                                                                                                                                                            using
                                                                                                                                                            lookup
                                                                                                                                                            results
                                                                                                                                                            const
                                                                                                                                                            searchTerm
                                                                                                                                                            =
                                                                                                                                                            `${year}
                                                                                                                                                            ${make}
                                                                                                                                                            ${model}
                                                                                                                                                            key
                                                                                                                                                            fob`;
                                                                                                                                                            const
                                                                                                                                                            ilcoParts
                                                                                                                                                            =
                                                                                                                                                            ilcoLookup?.ilco
                                                                                                                                                            ||
                                                                                                                                                            [];
                                                                                                                                                            const
                                                                                                                                                            strattecParts
                                                                                                                                                            =
                                                                                                                                                            strattecLookup?.strattec
                                                                                                                                                            ||
                                                                                                                                                            [];
                                                                                                                                                            const
                                                                                                                                                            fccId
                                                                                                                                                            =
                                                                                                                                                            exactMatch?.fcc_id;

                                                                                                                                                            let
                                                                                                                                                            amazonLinks
                                                                                                                                                            =
                                                                                                                                                            `
                                                                                                                                                            <a href="https://www.amazon.com/s?k=${encodeURIComponent(searchTerm)}&tag=eurokeys-20"
                                                                                                                                                                target="_blank"
                                                                                                                                                                onclick="logActivity('click_affiliate', { term: '${searchTerm}', origin: 'vin_lookup' })"
                                                                                                                                                                style="background: #22c55e; color: white; padding: 10px 16px; border-radius: 8px; text-decoration: none; font-weight: 600; display: flex; align-items: center; gap: 6px;">
                                                                                                                                                                ðŸ›’
                                                                                                                                                                Buy
                                                                                                                                                                Link
                                                                                                                                                                for
                                                                                                                                                                ${make}
                                                                                                                                                            </a>
                                                                                                                                                            `;

                                                                                                                                                            //
                                                                                                                                                            ILCO
                                                                                                                                                            Buttons
                                                                                                                                                            ilcoParts.slice(0,
                                                                                                                                                            2).forEach(part
                                                                                                                                                            =>
                                                                                                                                                            {
                                                                                                                                                            amazonLinks
                                                                                                                                                            +=
                                                                                                                                                            `
                                                                                                                                                            <a href="https://www.amazon.com/s?k=${encodeURIComponent('ILCO ' + part + ' key')}&tag=eurokeys-20"
                                                                                                                                                                target="_blank"
                                                                                                                                                                onclick="logActivity('click_affiliate', { part: '${part}', brand: 'ILCO', origin: 'vin_lookup' })"
                                                                                                                                                                style="background: #1e3a8a; color: white; padding: 10px 16px; border-radius: 8px; text-decoration: none; font-weight: 600; display: flex; align-items: center; gap: 6px; border: 1px solid rgba(255,255,255,0.1);">
                                                                                                                                                                ILCO
                                                                                                                                                                ${part}
                                                                                                                                                            </a>
                                                                                                                                                            `;
                                                                                                                                                            });

                                                                                                                                                            //
                                                                                                                                                            Strattec
                                                                                                                                                            Buttons
                                                                                                                                                            strattecParts.slice(0,
                                                                                                                                                            2).forEach(part
                                                                                                                                                            =>
                                                                                                                                                            {
                                                                                                                                                            amazonLinks
                                                                                                                                                            +=
                                                                                                                                                            `
                                                                                                                                                            <a href="https://www.amazon.com/s?k=${encodeURIComponent('Strattec ' + part + ' key')}&tag=eurokeys-20"
                                                                                                                                                                target="_blank"
                                                                                                                                                                onclick="logActivity('click_affiliate', { part: '${part}', brand: 'Strattec', origin: 'vin_lookup' })"
                                                                                                                                                                style="background: #1a1a1a; color: white; padding: 10px 16px; border-radius: 8px; text-decoration: none; font-weight: 600; display: flex; align-items: center; gap: 6px; border: 1px solid rgba(255,255,255,0.1);">
                                                                                                                                                                Strattec
                                                                                                                                                                ${part}
                                                                                                                                                            </a>
                                                                                                                                                            `;
                                                                                                                                                            });

                                                                                                                                                            if
                                                                                                                                                            (fccId
                                                                                                                                                            &&
                                                                                                                                                            fccId
                                                                                                                                                            !==
                                                                                                                                                            'N/A')
                                                                                                                                                            {
                                                                                                                                                            amazonLinks
                                                                                                                                                            +=
                                                                                                                                                            `
                                                                                                                                                            <a href="https://www.amazon.com/s?k=${encodeURIComponent(fccId + ' key fob')}&tag=eurokeys-20"
                                                                                                                                                                target="_blank"
                                                                                                                                                                onclick="logActivity('click_affiliate', { fcc: '${fccId}', origin: 'vin_lookup' })"
                                                                                                                                                                style="background: #4a1a5d; color: white; padding: 10px 16px; border-radius: 8px; text-decoration: none; font-weight: 600; display: flex; align-items: center; gap: 6px; border: 1px solid rgba(255,255,255,0.1);">
                                                                                                                                                                FCC:
                                                                                                                                                                ${fccId}
                                                                                                                                                            </a>
                                                                                                                                                            `;
                                                                                                                                                            }

                                                                                                                                                            document.getElementById('vinAmazonLinks').innerHTML
                                                                                                                                                            =
                                                                                                                                                            amazonLinks;

                                                                                                                                                            loadingEl.style.display
                                                                                                                                                            =
                                                                                                                                                            'none';
                                                                                                                                                            resultsEl.style.display
                                                                                                                                                            =
                                                                                                                                                            'block';

                                                                                                                                                            }
                                                                                                                                                            catch
                                                                                                                                                            (err)
                                                                                                                                                            {
                                                                                                                                                            loadingEl.style.display
                                                                                                                                                            =
                                                                                                                                                            'none';
                                                                                                                                                            errorEl.textContent
                                                                                                                                                            =
                                                                                                                                                            err.message
                                                                                                                                                            ||
                                                                                                                                                            'Failed
                                                                                                                                                            to
                                                                                                                                                            decode
                                                                                                                                                            VIN.
                                                                                                                                                            Please
                                                                                                                                                            try
                                                                                                                                                            again.';
                                                                                                                                                            errorEl.style.display
                                                                                                                                                            =
                                                                                                                                                            'block';
                                                                                                                                                            }
                                                                                                                                                            }

                                                                                                                                                            //
                                                                                                                                                            Helper
                                                                                                                                                            to
                                                                                                                                                            parse
                                                                                                                                                            key_blank_refs
                                                                                                                                                            JSON
                                                                                                                                                            function
                                                                                                                                                            parseKeyRefs(refs,
                                                                                                                                                            type)
                                                                                                                                                            {
                                                                                                                                                            if
                                                                                                                                                            (!refs)
                                                                                                                                                            return
                                                                                                                                                            null;
                                                                                                                                                            try
                                                                                                                                                            {
                                                                                                                                                            const
                                                                                                                                                            parsed
                                                                                                                                                            =
                                                                                                                                                            typeof
                                                                                                                                                            refs
                                                                                                                                                            ===
                                                                                                                                                            'string'
                                                                                                                                                            ?
                                                                                                                                                            JSON.parse(refs)
                                                                                                                                                            :
                                                                                                                                                            refs;
                                                                                                                                                            const
                                                                                                                                                            val
                                                                                                                                                            =
                                                                                                                                                            parsed[type];
                                                                                                                                                            if
                                                                                                                                                            (Array.isArray(val))
                                                                                                                                                            return
                                                                                                                                                            val.join(',
                                                                                                                                                            ');
                                                                                                                                                            return
                                                                                                                                                            val
                                                                                                                                                            ||
                                                                                                                                                            null;
                                                                                                                                                            }
                                                                                                                                                            catch
                                                                                                                                                            (e)
                                                                                                                                                            {
                                                                                                                                                            return
                                                                                                                                                            null;
                                                                                                                                                            }
                                                                                                                                                            }

                                                                                                                                                            async
                                                                                                                                                            function
                                                                                                                                                            renderToolCoveragePage(container,
                                                                                                                                                            headerHtml)
                                                                                                                                                            {
                                                                                                                                                            const
                                                                                                                                                            simulatedTool
                                                                                                                                                            =
                                                                                                                                                            localStorage.getItem('eurokeys_simulated_tool')
                                                                                                                                                            ||
                                                                                                                                                            null;
                                                                                                                                                            const
                                                                                                                                                            myCoverage
                                                                                                                                                            =
                                                                                                                                                            ToolCoverageManager.getMyCoverage();
                                                                                                                                                            const
                                                                                                                                                            simCoverage
                                                                                                                                                            =
                                                                                                                                                            simulatedTool
                                                                                                                                                            ?
                                                                                                                                                            ToolCoverageManager.getSimulatedCoverage(simulatedTool)
                                                                                                                                                            :
                                                                                                                                                            {};
                                                                                                                                                            const
                                                                                                                                                            allTools
                                                                                                                                                            =
                                                                                                                                                            ToolCoverageManager.getAllTools();

                                                                                                                                                            const
                                                                                                                                                            makes
                                                                                                                                                            =
                                                                                                                                                            ["Toyota",
                                                                                                                                                            "Lexus",
                                                                                                                                                            "Honda",
                                                                                                                                                            "Nissan",
                                                                                                                                                            "Ford",
                                                                                                                                                            "Dodge",
                                                                                                                                                            "Jeep",
                                                                                                                                                            "BMW",
                                                                                                                                                            "Mercedes",
                                                                                                                                                            "Volkswagen",
                                                                                                                                                            "Hyundai/Kia",
                                                                                                                                                            "Volvo",
                                                                                                                                                            "Land
                                                                                                                                                            Rover",
                                                                                                                                                            "GM"];
                                                                                                                                                            const
                                                                                                                                                            years
                                                                                                                                                            =
                                                                                                                                                            Array.from({
                                                                                                                                                            length:
                                                                                                                                                            26
                                                                                                                                                            },
                                                                                                                                                            (_,
                                                                                                                                                            i)
                                                                                                                                                            =>
                                                                                                                                                            2000
                                                                                                                                                            +
                                                                                                                                                            i);
                                                                                                                                                            //
                                                                                                                                                            2000-2025

                                                                                                                                                            let
                                                                                                                                                            html
                                                                                                                                                            =
                                                                                                                                                            headerHtml
                                                                                                                                                            +
                                                                                                                                                            `
                                                                                                                                                            <div
                                                                                                                                                                style="display: grid; grid-template-columns: 300px 1fr; gap: 24px; min-height: 600px;">
                                                                                                                                                                <!-- Left Panel: Tool Selector -->
                                                                                                                                                                <div
                                                                                                                                                                    style="background: var(--bg-tertiary); padding: 20px; border-radius: 12px; border: 1px solid var(--border);">
                                                                                                                                                                    <h3
                                                                                                                                                                        style="margin-top: 0; margin-bottom: 16px;">
                                                                                                                                                                        ðŸ› ï¸
                                                                                                                                                                        Tool
                                                                                                                                                                        Simulator
                                                                                                                                                                    </h3>
                                                                                                                                                                    <p
                                                                                                                                                                        style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 20px;">
                                                                                                                                                                        See
                                                                                                                                                                        what
                                                                                                                                                                        your
                                                                                                                                                                        tools
                                                                                                                                                                        cover
                                                                                                                                                                        (Green)
                                                                                                                                                                        and
                                                                                                                                                                        simulate
                                                                                                                                                                        buying
                                                                                                                                                                        new
                                                                                                                                                                        ones
                                                                                                                                                                        (Blue).
                                                                                                                                                                    </p>

                                                                                                                                                                    <div
                                                                                                                                                                        style="display: grid; gap: 12px;">
                                                                                                                                                                        ${allTools.map(tool
                                                                                                                                                                        =>
                                                                                                                                                                        {
                                                                                                                                                                        const
                                                                                                                                                                        isOwned
                                                                                                                                                                        =
                                                                                                                                                                        ToolCoverageManager.isToolOwned(tool.name);
                                                                                                                                                                        const
                                                                                                                                                                        isSimulated
                                                                                                                                                                        =
                                                                                                                                                                        simulatedTool
                                                                                                                                                                        ===
                                                                                                                                                                        tool.name;

                                                                                                                                                                        return
                                                                                                                                                                        `
                                                                                                                                                                        <div style="background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 12px; padding: 20px; text-align: left; position: relative; overflow: hidden;"
                                                                                                                                                                            onclick="${isOwned ? '' : `simulateTool('${tool.name}')`}">
                                                                                                                                                                            <div
                                                                                                                                                                                style="display: flex; justify-content: space-between; align-items: start;">
                                                                                                                                                                                <span
                                                                                                                                                                                    style="font-weight: 600; font-size: 0.9rem; color: var(--text-primary);">${tool.name}</span>
                                                                                                                                                                                ${isOwned
                                                                                                                                                                                ?
                                                                                                                                                                                '<span
                                                                                                                                                                                    style="font-size: 0.75rem; color: #22c55e; font-weight: 700;">OWNED</span>'
                                                                                                                                                                                :
                                                                                                                                                                                `<span
                                                                                                                                                                                    style="font-size: 0.75rem; color: var(--text-muted);">$${tool.price}</span>`
                                                                                                                                                                                }
                                                                                                                                                                            </div>
                                                                                                                                                                            ${!isOwned
                                                                                                                                                                            ?
                                                                                                                                                                            `
                                                                                                                                                                            <div
                                                                                                                                                                                style="font-size: 0.75rem; color: ${isSimulated ? '#60a5fa' : 'var(--text-muted)'}; margin-top: 4px;">
                                                                                                                                                                                ${isSimulated
                                                                                                                                                                                ?
                                                                                                                                                                                'ðŸ”µ
                                                                                                                                                                                Currently
                                                                                                                                                                                Simulating'
                                                                                                                                                                                :
                                                                                                                                                                                'Click
                                                                                                                                                                                to
                                                                                                                                                                                Simulate'}
                                                                                                                                                                            </div>
                                                                                                                                                                            `
                                                                                                                                                                            :
                                                                                                                                                                            ''}
                                                                                                                                                                        </div>
                                                                                                                                                                        `;
                                                                                                                                                                        }).join('')}
                                                                                                                                                                    </div>
                                                                                                                                                                    <div
                                                                                                                                                                        style="margin-top: 12px; font-size: 0.85rem; color: var(--text-muted);">
                                                                                                                                                                        <span
                                                                                                                                                                            style="display: inline-block; width: 12px; height: 12px; background: #22c55e; border-radius: 2px; margin-right: 6px;"></span>
                                                                                                                                                                        Owned
                                                                                                                                                                        Coverage
                                                                                                                                                                        <span
                                                                                                                                                                            style="display: inline-block; width: 12px; height: 12px; background: #60a5fa; border-radius: 2px; margin: 0 6px 0 16px;"></span>
                                                                                                                                                                        Simulated
                                                                                                                                                                        Gain
                                                                                                                                                                    </div>
                                                                                                                                                                </div>

                                                                                                                                                                <!-- Coverage Matrix -->
                                                                                                                                                                <div class="matrix-container"
                                                                                                                                                                    style="overflow-x: auto; background: var(--bg-secondary); border-radius: 12px; border: 1px solid var(--border); padding: 20px; margin-bottom: 40px;">
                                                                                                                                                                    <h3
                                                                                                                                                                        style="margin: 0 0 20px 0; display: flex; align-items: center; justify-content: space-between;">
                                                                                                                                                                        <span>Coverage
                                                                                                                                                                            Heatmap
                                                                                                                                                                            (2000-2025)</span>
                                                                                                                                                                        <div
                                                                                                                                                                            style="font-size: 0.8rem; font-weight: normal; color: var(--text-muted);">
                                                                                                                                                                            Click
                                                                                                                                                                            cells
                                                                                                                                                                            to
                                                                                                                                                                            see
                                                                                                                                                                            tool
                                                                                                                                                                            details
                                                                                                                                                                            (Coming
                                                                                                                                                                            Soon)
                                                                                                                                                                        </div>
                                                                                                                                                                    </h3>

                                                                                                                                                                    <div
                                                                                                                                                                        style="display: grid; grid-template-columns: 100px repeat(${years.length}, 1fr); gap: 2px; min-width: 800px;">
                                                                                                                                                                        <!-- Header Row -->
                                                                                                                                                                        <div>
                                                                                                                                                                        </div>
                                                                                                                                                                        <!-- Empty top-left -->
                                                                                                                                                                        ${years.map(y
                                                                                                                                                                        =>
                                                                                                                                                                        `
                                                                                                                                                                        <div
                                                                                                                                                                            style="font-size: 0.65rem; color: var(--text-muted); text-align: center; transform: rotate(-45deg); height: 30px; display: flex; align-items: flex-end; justify-content: center;">
                                                                                                                                                                            ${y}
                                                                                                                                                                        </div>
                                                                                                                                                                        `).join('')}

                                                                                                                                                                        <!-- Matrix Body -->
                                                                                                                                                                        ${makes.map(make
                                                                                                                                                                        =>
                                                                                                                                                                        {
                                                                                                                                                                        const
                                                                                                                                                                        makeRow
                                                                                                                                                                        =
                                                                                                                                                                        `
                                                                                                                                                                        <div
                                                                                                                                                                            style="font-size: 0.8rem; font-weight: 600; color: var(--text-primary); padding-right: 8px; display: flex; align-items: center; justify-content: flex-end;">
                                                                                                                                                                            ${make}
                                                                                                                                                                        </div>
                                                                                                                                                                        ${years.map(year
                                                                                                                                                                        =>
                                                                                                                                                                        {
                                                                                                                                                                        const
                                                                                                                                                                        owned
                                                                                                                                                                        =
                                                                                                                                                                        myCoverage[make]
                                                                                                                                                                        &&
                                                                                                                                                                        myCoverage[make][year];
                                                                                                                                                                        const
                                                                                                                                                                        simulated
                                                                                                                                                                        =
                                                                                                                                                                        simCoverage[make]
                                                                                                                                                                        &&
                                                                                                                                                                        simCoverage[make][year];

                                                                                                                                                                        let
                                                                                                                                                                        bg
                                                                                                                                                                        =
                                                                                                                                                                        'rgba(255,255,255,0.03)';
                                                                                                                                                                        let
                                                                                                                                                                        title
                                                                                                                                                                        =
                                                                                                                                                                        'No
                                                                                                                                                                        Coverage';

                                                                                                                                                                        if
                                                                                                                                                                        (owned)
                                                                                                                                                                        {
                                                                                                                                                                        bg
                                                                                                                                                                        =
                                                                                                                                                                        '#22c55e';
                                                                                                                                                                        title
                                                                                                                                                                        =
                                                                                                                                                                        `Owned:
                                                                                                                                                                        ${owned.tool}
                                                                                                                                                                        (${owned.note})`;
                                                                                                                                                                        }
                                                                                                                                                                        else
                                                                                                                                                                        if
                                                                                                                                                                        (simulated)
                                                                                                                                                                        {
                                                                                                                                                                        bg
                                                                                                                                                                        =
                                                                                                                                                                        '#60a5fa';
                                                                                                                                                                        title
                                                                                                                                                                        =
                                                                                                                                                                        `Gain:
                                                                                                                                                                        ${simulated.tool}
                                                                                                                                                                        (${simulated.note})`;
                                                                                                                                                                        }

                                                                                                                                                                        return
                                                                                                                                                                        `
                                                                                                                                                                        <div title="${make} ${year}: ${title}"
                                                                                                                                                                            style="
                                                height: 24px; 
                                                background: ${bg}; 
                                                border-radius: 2px;
                                                opacity: ${owned || simulated ? 0.9 : 1};
                                                transition: all 0.1s;
                                            " onmouseover="this.style.opacity=1; this.style.transform='scale(1.2)';" onmouseout="this.style.opacity=0.9; this.style.transform='scale(1)';">
                                                                                                                                                                        </div>
                                                                                                                                                                        `;
                                                                                                                                                                        }).join('')}
                                                                                                                                                                        `;
                                                                                                                                                                        return
                                                                                                                                                                        makeRow;
                                                                                                                                                                        }).join('')}
                                                                                                                                                                    </div>
                                                                                                                                                                </div>

                                                                                                                                                                ${typeof
                                                                                                                                                                TOOL_COVERAGE_DATA
                                                                                                                                                                !==
                                                                                                                                                                'undefined'
                                                                                                                                                                ?
                                                                                                                                                                `
                                                                                                                                                                <!-- Deep Dive Intelligence -->
                                                                                                                                                                <div
                                                                                                                                                                    style="margin-bottom: 40px;">
                                                                                                                                                                    <h2
                                                                                                                                                                        style="color: var(--brand-primary); margin-bottom: 20px; font-size: 1.5rem; border-bottom: 2px solid var(--border); padding-bottom: 10px;">
                                                                                                                                                                        ðŸ§ 
                                                                                                                                                                        Deep
                                                                                                                                                                        Dive
                                                                                                                                                                        Intelligence
                                                                                                                                                                    </h2>

                                                                                                                                                                    <!-- Top Tools Analysis -->
                                                                                                                                                                    <div
                                                                                                                                                                        style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px;">
                                                                                                                                                                        ${TOOL_COVERAGE_DATA.topTools.map(tool
                                                                                                                                                                        =>
                                                                                                                                                                        `
                                                                                                                                                                        <div
                                                                                                                                                                            style="background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 12px; padding: 20px; position: relative; overflow: hidden;">
                                                                                                                                                                            <div
                                                                                                                                                                                style="position: absolute; top: 0; left: 0; width: 4px; height: 100%; background: ${tool.badgeColor};">
                                                                                                                                                                            </div>
                                                                                                                                                                            <div
                                                                                                                                                                                style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
                                                                                                                                                                                <h3
                                                                                                                                                                                    style="margin: 0; font-size: 1.1rem;">
                                                                                                                                                                                    ${tool.name}
                                                                                                                                                                                </h3>
                                                                                                                                                                                <span
                                                                                                                                                                                    style="background: ${tool.badgeColor}20; color: ${tool.badgeColor}; padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase;">
                                                                                                                                                                                    ${tool.badge}
                                                                                                                                                                                </span>
                                                                                                                                                                            </div>
                                                                                                                                                                            <p
                                                                                                                                                                                style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 16px;">
                                                                                                                                                                                ${tool.notes}
                                                                                                                                                                            </p>
                                                                                                                                                                            <div
                                                                                                                                                                                style="margin-bottom: 12px;">
                                                                                                                                                                                <div
                                                                                                                                                                                    style="font-size: 0.75rem; color: var(--text-secondary); text-transform: uppercase; font-weight: 600; margin-bottom: 6px;">
                                                                                                                                                                                    Strengths
                                                                                                                                                                                </div>
                                                                                                                                                                                <div
                                                                                                                                                                                    style="display: flex; flex-wrap: wrap; gap: 6px;">
                                                                                                                                                                                    ${tool.strengths.map(s
                                                                                                                                                                                    =>
                                                                                                                                                                                    `
                                                                                                                                                                                    <span
                                                                                                                                                                                        style="background: var(--bg-tertiary); padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; border: 1px solid var(--border);">${s}</span>
                                                                                                                                                                                    `).join('')}
                                                                                                                                                                                </div>
                                                                                                                                                                            </div>
                                                                                                                                                                        </div>
                                                                                                                                                                        `).join('')}
                                                                                                                                                                    </div>

                                                                                                                                                                    <!-- High Value Protocols -->
                                                                                                                                                                    <h3
                                                                                                                                                                        style="margin-bottom: 16px; color: var(--text-primary);">
                                                                                                                                                                        High-Value
                                                                                                                                                                        Protocol
                                                                                                                                                                        Coverage
                                                                                                                                                                    </h3>
                                                                                                                                                                    <div
                                                                                                                                                                        style="overflow-x: auto; background: var(--bg-secondary); border-radius: 12px; border: 1px solid var(--border); margin-bottom: 30px;">
                                                                                                                                                                        <table
                                                                                                                                                                            style="width: 100%; border-collapse: collapse;">
                                                                                                                                                                            <thead>
                                                                                                                                                                                <tr
                                                                                                                                                                                    style="background: var(--bg-tertiary); border-bottom: 1px solid var(--border);">
                                                                                                                                                                                    <th
                                                                                                                                                                                        style="padding: 12px 16px; text-align: left; color: var(--text-muted); font-size: 0.85rem;">
                                                                                                                                                                                        System
                                                                                                                                                                                    </th>
                                                                                                                                                                                    <th
                                                                                                                                                                                        style="padding: 12px 16px; text-align: left; color: var(--text-muted); font-size: 0.85rem;">
                                                                                                                                                                                        Lonsdor
                                                                                                                                                                                    </th>
                                                                                                                                                                                    <th
                                                                                                                                                                                        style="padding: 12px 16px; text-align: left; color: var(--text-muted); font-size: 0.85rem;">
                                                                                                                                                                                        Autel
                                                                                                                                                                                    </th>
                                                                                                                                                                                    <th
                                                                                                                                                                                        style="padding: 12px 16px; text-align: left; color: var(--text-muted); font-size: 0.85rem;">
                                                                                                                                                                                        OBDStar
                                                                                                                                                                                    </th>
                                                                                                                                                                                    <th
                                                                                                                                                                                        style="padding: 12px 16px; text-align: left; color: var(--text-muted); font-size: 0.85rem;">
                                                                                                                                                                                        Xhorse
                                                                                                                                                                                    </th>
                                                                                                                                                                                </tr>
                                                                                                                                                                            </thead>
                                                                                                                                                                            <tbody>
                                                                                                                                                                                ${TOOL_COVERAGE_DATA.highValueProtocols.map(p
                                                                                                                                                                                =>
                                                                                                                                                                                `
                                                                                                                                                                                <tr
                                                                                                                                                                                    style="border-bottom: 1px solid var(--border);">
                                                                                                                                                                                    <td
                                                                                                                                                                                        style="padding: 16px;">
                                                                                                                                                                                        <div
                                                                                                                                                                                            style="font-weight: 700; color: var(--text-primary);">
                                                                                                                                                                                            ${p.make}
                                                                                                                                                                                        </div>
                                                                                                                                                                                        <div
                                                                                                                                                                                            style="font-size: 0.85rem; color: var(--brand-primary);">
                                                                                                                                                                                            ${p.system}
                                                                                                                                                                                        </div>
                                                                                                                                                                                        <div
                                                                                                                                                                                            style="font-size: 0.8rem; color: var(--text-muted);">
                                                                                                                                                                                            ${p.years}
                                                                                                                                                                                        </div>
                                                                                                                                                                                    </td>
                                                                                                                                                                                    ${['lonsdor',
                                                                                                                                                                                    'autel',
                                                                                                                                                                                    'obdstar',
                                                                                                                                                                                    'xhorse'].map(brand
                                                                                                                                                                                    =>
                                                                                                                                                                                    {
                                                                                                                                                                                    const
                                                                                                                                                                                    data
                                                                                                                                                                                    =
                                                                                                                                                                                    p[brand];
                                                                                                                                                                                    const
                                                                                                                                                                                    color
                                                                                                                                                                                    =
                                                                                                                                                                                    data.status
                                                                                                                                                                                    ===
                                                                                                                                                                                    'High'
                                                                                                                                                                                    ?
                                                                                                                                                                                    '#22c55e'
                                                                                                                                                                                    :
                                                                                                                                                                                    data.status
                                                                                                                                                                                    ===
                                                                                                                                                                                    'Medium'
                                                                                                                                                                                    ?
                                                                                                                                                                                    '#f59e0b'
                                                                                                                                                                                    :
                                                                                                                                                                                    data.status
                                                                                                                                                                                    ===
                                                                                                                                                                                    'Risky'
                                                                                                                                                                                    ?
                                                                                                                                                                                    '#ef4444'
                                                                                                                                                                                    :
                                                                                                                                                                                    '#64748b';
                                                                                                                                                                                    return
                                                                                                                                                                                    `
                                                                                                                                                                                    <td
                                                                                                                                                                                        style="padding: 16px; vertical-align: top;">
                                                                                                                                                                                        <div
                                                                                                                                                                                            style="display: flex; align-items: center; gap: 6px; margin-bottom: 4px;">
                                                                                                                                                                                            <span
                                                                                                                                                                                                style="width: 8px; height: 8px; border-radius: 50%; background: ${color};"></span>
                                                                                                                                                                                            <span
                                                                                                                                                                                                style="font-weight: 600; font-size: 0.9rem; color: ${color};">${data.status}</span>
                                                                                                                                                                                        </div>
                                                                                                                                                                                        <div
                                                                                                                                                                                            style="font-size: 0.85rem; color: var(--text-primary); margin-bottom: 2px;">
                                                                                                                                                                                            ${data.method}
                                                                                                                                                                                        </div>
                                                                                                                                                                                        <div
                                                                                                                                                                                            style="font-size: 0.75rem; color: var(--text-muted); font-style: italic;">
                                                                                                                                                                                            ${data.note}
                                                                                                                                                                                        </div>
                                                                                                                                                                                    </td>
                                                                                                                                                                                    `;
                                                                                                                                                                                    }).join('')}
                                                                                                                                                                                </tr>
                                                                                                                                                                                `).join('')}
                                                                                                                                                                            </tbody>
                                                                                                                                                                        </table>
                                                                                                                                                                    </div>

                                                                                                                                                                    <!-- Adapter Ecosystem -->
                                                                                                                                                                    ${TOOL_COVERAGE_DATA.adapterEcosystem
                                                                                                                                                                    ?
                                                                                                                                                                    `
                                                                                                                                                                    <h3
                                                                                                                                                                        style="margin-bottom: 16px; color: var(--text-primary);">
                                                                                                                                                                        ðŸ”Œ
                                                                                                                                                                        Adapter
                                                                                                                                                                        Ecosystem
                                                                                                                                                                        (Autel
                                                                                                                                                                        vs.
                                                                                                                                                                        Lonsdor)
                                                                                                                                                                    </h3>
                                                                                                                                                                    <div
                                                                                                                                                                        style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 24px; margin-bottom: 30px;">
                                                                                                                                                                        ${TOOL_COVERAGE_DATA.adapterEcosystem.map(sys
                                                                                                                                                                        =>
                                                                                                                                                                        `
                                                                                                                                                                        <div
                                                                                                                                                                            style="background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 12px; padding: 20px;">
                                                                                                                                                                            <div
                                                                                                                                                                                style="display: flex; justify-content: space-between; margin-bottom: 16px;">
                                                                                                                                                                                <h4
                                                                                                                                                                                    style="margin: 0; color: var(--text-primary); font-size: 1.1rem;">
                                                                                                                                                                                    ${sys.name}
                                                                                                                                                                                </h4>
                                                                                                                                                                                <span
                                                                                                                                                                                    style="font-size: 0.75rem; color: var(--brand-primary); background: rgba(251, 191, 36, 0.1); padding: 4px 8px; border-radius: 4px;">${sys.philosophy}</span>
                                                                                                                                                                            </div>
                                                                                                                                                                            <div
                                                                                                                                                                                style="display: flex; flex-direction: column; gap: 12px;">
                                                                                                                                                                                ${sys.details.map(d
                                                                                                                                                                                =>
                                                                                                                                                                                `
                                                                                                                                                                                <div
                                                                                                                                                                                    style="display: flex; justify-content: space-between; border-bottom: 1px solid var(--border); padding-bottom: 8px;">
                                                                                                                                                                                    <span
                                                                                                                                                                                        style="color: var(--text-muted); font-size: 0.85rem;">${d.feature}</span>
                                                                                                                                                                                    <span
                                                                                                                                                                                        style="color: var(--text-primary); font-size: 0.85rem; font-weight: 600; text-align: right; max-width: 60%;">${d.desc}</span>
                                                                                                                                                                                </div>
                                                                                                                                                                                `).join('')}
                                                                                                                                                                            </div>
                                                                                                                                                                        </div>
                                                                                                                                                                        `).join('')}
                                                                                                                                                                    </div>
                                                                                                                                                                    `
                                                                                                                                                                    :
                                                                                                                                                                    ''}


                                                                                                                                                                    <!-- Risk Analysis -->
                                                                                                                                                                    <h3
                                                                                                                                                                        style="margin-bottom: 16px; color: #ef4444; display: flex; align-items: center; gap: 8px;">
                                                                                                                                                                        âš ï¸
                                                                                                                                                                        Critical
                                                                                                                                                                        Risk
                                                                                                                                                                        Analysis
                                                                                                                                                                        (Brick
                                                                                                                                                                        Prevention)
                                                                                                                                                                    </h3>
                                                                                                                                                                    <div
                                                                                                                                                                        style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 16px;">
                                                                                                                                                                        ${TOOL_COVERAGE_DATA.riskAnalysis.map(risk
                                                                                                                                                                        =>
                                                                                                                                                                        `
                                                                                                                                                                        <div
                                                                                                                                                                            style="background: rgba(239, 68, 68, 0.05); border: 1px solid rgba(239, 68, 68, 0.2); border-radius: 12px; padding: 16px; display: flex; gap: 16px;">
                                                                                                                                                                            <div
                                                                                                                                                                                style="font-size: 2rem;">
                                                                                                                                                                                â›”
                                                                                                                                                                            </div>
                                                                                                                                                                            <div>
                                                                                                                                                                                <div
                                                                                                                                                                                    style="font-weight: 700; color: var(--text-primary); margin-bottom: 4px;">
                                                                                                                                                                                    ${risk.vehicle}
                                                                                                                                                                                </div>
                                                                                                                                                                                <div
                                                                                                                                                                                    style="font-size: 0.9rem; color: #ef4444; font-weight: 600; margin-bottom: 8px;">
                                                                                                                                                                                    RISK:
                                                                                                                                                                                    ${risk.risk}
                                                                                                                                                                                </div>
                                                                                                                                                                                <div
                                                                                                                                                                                    style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 4px;">
                                                                                                                                                                                    <strong>Cause:</strong>
                                                                                                                                                                                    ${risk.cause}
                                                                                                                                                                                </div>
                                                                                                                                                                                <div
                                                                                                                                                                                    style="font-size: 0.85rem; color: #22c55e;">
                                                                                                                                                                                    <strong>Mitigation:</strong>
                                                                                                                                                                                    ${risk.mitigation}
                                                                                                                                                                                </div>
                                                                                                                                                                            </div>
                                                                                                                                                                        </div>
                                                                                                                                                                        `).join('')}
                                                                                                                                                                    </div>
                                                                                                                                                                </div>
                                                                                                                                                                `
                                                                                                                                                                :
                                                                                                                                                                ''}

                                                                                                                                                            </div>
                                                                                                                                                            `;
                                                                                                                                                            container.innerHTML
                                                                                                                                                            =
                                                                                                                                                            html;
                                                                                                                                                            }

                                                                                                                                                            function
                                                                                                                                                            simulateTool(toolName)
                                                                                                                                                            {
                                                                                                                                                            if
                                                                                                                                                            (toolName)
                                                                                                                                                            {
                                                                                                                                                            localStorage.setItem('eurokeys_simulated_tool',
                                                                                                                                                            toolName);
                                                                                                                                                            }
                                                                                                                                                            else
                                                                                                                                                            {
                                                                                                                                                            localStorage.removeItem('eurokeys_simulated_tool');
                                                                                                                                                            }
                                                                                                                                                            renderInventoryPage('coverage');
                                                                                                                                                            }





                                                                                                                                                            /*
                                                                                                                                                            STRIPE
                                                                                                                                                            CHECKOUT
                                                                                                                                                            */

                                                                                                                                                            //
                                                                                                                                                            ==========================================
                                                                                                                                                            //
                                                                                                                                                            SUBSCRIPTION
                                                                                                                                                            TRACKER
                                                                                                                                                            //
                                                                                                                                                            ==========================================

                                                                                                                                                            //
                                                                                                                                                            Subscription
                                                                                                                                                            Catalog
                                                                                                                                                            -
                                                                                                                                                            Preloaded
                                                                                                                                                            with
                                                                                                                                                            50+
                                                                                                                                                            common
                                                                                                                                                            locksmith
                                                                                                                                                            subscriptions
                                                                                                                                                            const
                                                                                                                                                            SUBSCRIPTION_CATALOG
                                                                                                                                                            =
                                                                                                                                                            {
                                                                                                                                                            //
                                                                                                                                                            Key
                                                                                                                                                            Programmers
                                                                                                                                                            autel_tcp:
                                                                                                                                                            {
                                                                                                                                                            name:
                                                                                                                                                            'Autel
                                                                                                                                                            TCP
                                                                                                                                                            Subscription',
                                                                                                                                                            vendor:
                                                                                                                                                            'Autel',
                                                                                                                                                            cost:
                                                                                                                                                            895,
                                                                                                                                                            billingCycle:
                                                                                                                                                            'annual',
                                                                                                                                                            category:
                                                                                                                                                            'key_programmer',
                                                                                                                                                            notes:
                                                                                                                                                            'Required
                                                                                                                                                            for
                                                                                                                                                            Toyota
                                                                                                                                                            8A-BA,
                                                                                                                                                            Mercedes
                                                                                                                                                            FBS3
                                                                                                                                                            server
                                                                                                                                                            calculations.
                                                                                                                                                            TCP
                                                                                                                                                            =
                                                                                                                                                            Total
                                                                                                                                                            Care
                                                                                                                                                            Program.',
                                                                                                                                                            benefit:
                                                                                                                                                            'Essential
                                                                                                                                                            for
                                                                                                                                                            high-profit
                                                                                                                                                            Toyota
                                                                                                                                                            8A-BA
                                                                                                                                                            jobs
                                                                                                                                                            ($450-600
                                                                                                                                                            each).
                                                                                                                                                            Also
                                                                                                                                                            unlocks
                                                                                                                                                            Mercedes
                                                                                                                                                            FBS3
                                                                                                                                                            calculations
                                                                                                                                                            worth
                                                                                                                                                            $200-350
                                                                                                                                                            per
                                                                                                                                                            key.
                                                                                                                                                            ROI:
                                                                                                                                                            2-3
                                                                                                                                                            jobs
                                                                                                                                                            pay
                                                                                                                                                            for
                                                                                                                                                            annual
                                                                                                                                                            cost.'
                                                                                                                                                            },
                                                                                                                                                            lonsdor_update:
                                                                                                                                                            {
                                                                                                                                                            name:
                                                                                                                                                            'Lonsdor
                                                                                                                                                            K518
                                                                                                                                                            Update',
                                                                                                                                                            vendor:
                                                                                                                                                            'Lonsdor',
                                                                                                                                                            cost:
                                                                                                                                                            200,
                                                                                                                                                            billingCycle:
                                                                                                                                                            'annual',
                                                                                                                                                            category:
                                                                                                                                                            'key_programmer',
                                                                                                                                                            notes:
                                                                                                                                                            'Optional.
                                                                                                                                                            Toyota
                                                                                                                                                            8A-BA
                                                                                                                                                            works
                                                                                                                                                            OFFLINE
                                                                                                                                                            with
                                                                                                                                                            FP30
                                                                                                                                                            adapter.',
                                                                                                                                                            benefit:
                                                                                                                                                            'Best
                                                                                                                                                            value
                                                                                                                                                            for
                                                                                                                                                            Toyota
                                                                                                                                                            8A-BA
                                                                                                                                                            if
                                                                                                                                                            you
                                                                                                                                                            have
                                                                                                                                                            FP30
                                                                                                                                                            adapter
                                                                                                                                                            -
                                                                                                                                                            no
                                                                                                                                                            server
                                                                                                                                                            needed!
                                                                                                                                                            Lower
                                                                                                                                                            annual
                                                                                                                                                            cost
                                                                                                                                                            vs
                                                                                                                                                            Autel
                                                                                                                                                            TCP
                                                                                                                                                            while
                                                                                                                                                            covering
                                                                                                                                                            same
                                                                                                                                                            vehicles.'
                                                                                                                                                            },
                                                                                                                                                            xhorse_vvdi:
                                                                                                                                                            {
                                                                                                                                                            name:
                                                                                                                                                            'Xhorse
                                                                                                                                                            VVDI
                                                                                                                                                            Subscription',
                                                                                                                                                            vendor:
                                                                                                                                                            'Xhorse',
                                                                                                                                                            cost:
                                                                                                                                                            199,
                                                                                                                                                            billingCycle:
                                                                                                                                                            'annual',
                                                                                                                                                            category:
                                                                                                                                                            'key_programmer',
                                                                                                                                                            notes:
                                                                                                                                                            'Required
                                                                                                                                                            for
                                                                                                                                                            VAG
                                                                                                                                                            MQB/MQB48
                                                                                                                                                            and
                                                                                                                                                            Mercedes
                                                                                                                                                            token
                                                                                                                                                            calculations.',
                                                                                                                                                            benefit:
                                                                                                                                                            'Dominates
                                                                                                                                                            VAG
                                                                                                                                                            market
                                                                                                                                                            (VW,
                                                                                                                                                            Audi,
                                                                                                                                                            Porsche).
                                                                                                                                                            MQB
                                                                                                                                                            coverage
                                                                                                                                                            opens
                                                                                                                                                            lucrative
                                                                                                                                                            $300-500
                                                                                                                                                            VW/Audi
                                                                                                                                                            key
                                                                                                                                                            jobs.
                                                                                                                                                            Token
                                                                                                                                                            calculations
                                                                                                                                                            keep
                                                                                                                                                            costs
                                                                                                                                                            predictable.'
                                                                                                                                                            },
                                                                                                                                                            obdstar_update:
                                                                                                                                                            {
                                                                                                                                                            name:
                                                                                                                                                            'OBDStar
                                                                                                                                                            Annual
                                                                                                                                                            Update',
                                                                                                                                                            vendor:
                                                                                                                                                            'OBDStar',
                                                                                                                                                            cost:
                                                                                                                                                            299,
                                                                                                                                                            billingCycle:
                                                                                                                                                            'annual',
                                                                                                                                                            category:
                                                                                                                                                            'key_programmer',
                                                                                                                                                            notes:
                                                                                                                                                            'Nissan
                                                                                                                                                            Blacklist
                                                                                                                                                            detection
                                                                                                                                                            and
                                                                                                                                                            Toyota-30
                                                                                                                                                            cable
                                                                                                                                                            support.',
                                                                                                                                                            benefit:
                                                                                                                                                            'Only
                                                                                                                                                            tool
                                                                                                                                                            with
                                                                                                                                                            Nissan
                                                                                                                                                            Blacklist
                                                                                                                                                            detectionâ€”essential
                                                                                                                                                            for
                                                                                                                                                            avoiding
                                                                                                                                                            failed
                                                                                                                                                            $300+
                                                                                                                                                            Altima/Rogue
                                                                                                                                                            jobs.
                                                                                                                                                            Toyota-30
                                                                                                                                                            cable
                                                                                                                                                            unlocks
                                                                                                                                                            older
                                                                                                                                                            Toyota
                                                                                                                                                            AKL.'
                                                                                                                                                            },
                                                                                                                                                            xtool_x100:
                                                                                                                                                            {
                                                                                                                                                            name:
                                                                                                                                                            'Xtool
                                                                                                                                                            X100
                                                                                                                                                            PAD
                                                                                                                                                            Update',
                                                                                                                                                            vendor:
                                                                                                                                                            'Xtool',
                                                                                                                                                            cost:
                                                                                                                                                            199,
                                                                                                                                                            billingCycle:
                                                                                                                                                            'annual',
                                                                                                                                                            category:
                                                                                                                                                            'key_programmer',
                                                                                                                                                            notes:
                                                                                                                                                            'General
                                                                                                                                                            key
                                                                                                                                                            programming
                                                                                                                                                            coverage.',
                                                                                                                                                            benefit:
                                                                                                                                                            'Budget-friendly
                                                                                                                                                            backup
                                                                                                                                                            tool
                                                                                                                                                            with
                                                                                                                                                            broad
                                                                                                                                                            domestic
                                                                                                                                                            coverage.
                                                                                                                                                            Great
                                                                                                                                                            for
                                                                                                                                                            vans,
                                                                                                                                                            trucks,
                                                                                                                                                            and
                                                                                                                                                            older
                                                                                                                                                            vehicles
                                                                                                                                                            where
                                                                                                                                                            premium
                                                                                                                                                            tools
                                                                                                                                                            are
                                                                                                                                                            overkill.'
                                                                                                                                                            },
                                                                                                                                                            advanced_diag:
                                                                                                                                                            {
                                                                                                                                                            name:
                                                                                                                                                            'Advanced
                                                                                                                                                            Diagnostics
                                                                                                                                                            MVP
                                                                                                                                                            Pro',
                                                                                                                                                            vendor:
                                                                                                                                                            'Advanced
                                                                                                                                                            Diagnostics',
                                                                                                                                                            cost:
                                                                                                                                                            400,
                                                                                                                                                            billingCycle:
                                                                                                                                                            'annual',
                                                                                                                                                            category:
                                                                                                                                                            'key_programmer',
                                                                                                                                                            notes:
                                                                                                                                                            'Token-based
                                                                                                                                                            calculations
                                                                                                                                                            for
                                                                                                                                                            Euro
                                                                                                                                                            vehicles.',
                                                                                                                                                            benefit:
                                                                                                                                                            'Gold
                                                                                                                                                            standard
                                                                                                                                                            for
                                                                                                                                                            BMW,
                                                                                                                                                            Mercedes,
                                                                                                                                                            and
                                                                                                                                                            Jaguar.
                                                                                                                                                            Token
                                                                                                                                                            model
                                                                                                                                                            means
                                                                                                                                                            you
                                                                                                                                                            only
                                                                                                                                                            pay
                                                                                                                                                            when
                                                                                                                                                            you
                                                                                                                                                            workâ€”good
                                                                                                                                                            for
                                                                                                                                                            shops
                                                                                                                                                            with
                                                                                                                                                            occasional
                                                                                                                                                            Euro
                                                                                                                                                            customers.'
                                                                                                                                                            },
                                                                                                                                                            key_tool_max:
                                                                                                                                                            {
                                                                                                                                                            name:
                                                                                                                                                            'Xhorse
                                                                                                                                                            Key
                                                                                                                                                            Tool
                                                                                                                                                            Max',
                                                                                                                                                            vendor:
                                                                                                                                                            'Xhorse',
                                                                                                                                                            cost:
                                                                                                                                                            150,
                                                                                                                                                            billingCycle:
                                                                                                                                                            'annual',
                                                                                                                                                            category:
                                                                                                                                                            'key_programmer',
                                                                                                                                                            notes:
                                                                                                                                                            'Chip
                                                                                                                                                            cloning
                                                                                                                                                            and
                                                                                                                                                            remote
                                                                                                                                                            generation.',
                                                                                                                                                            benefit:
                                                                                                                                                            'Generates
                                                                                                                                                            super
                                                                                                                                                            chips
                                                                                                                                                            and
                                                                                                                                                            universal
                                                                                                                                                            remotes
                                                                                                                                                            on-the-fly.
                                                                                                                                                            Cloning
                                                                                                                                                            capability
                                                                                                                                                            means
                                                                                                                                                            no
                                                                                                                                                            server
                                                                                                                                                            dependencyâ€”work
                                                                                                                                                            anywhere,
                                                                                                                                                            even
                                                                                                                                                            without
                                                                                                                                                            internet.'
                                                                                                                                                            },
                                                                                                                                                            keydiy_kd:
                                                                                                                                                            {
                                                                                                                                                            name:
                                                                                                                                                            'KeyDIY
                                                                                                                                                            KD-X2/KD-MAX',
                                                                                                                                                            vendor:
                                                                                                                                                            'KeyDIY',
                                                                                                                                                            cost:
                                                                                                                                                            99,
                                                                                                                                                            billingCycle:
                                                                                                                                                            'annual',
                                                                                                                                                            category:
                                                                                                                                                            'key_programmer',
                                                                                                                                                            notes:
                                                                                                                                                            'Budget
                                                                                                                                                            chip
                                                                                                                                                            cloning
                                                                                                                                                            and
                                                                                                                                                            remote
                                                                                                                                                            maker.',
                                                                                                                                                            benefit:
                                                                                                                                                            'Lowest-cost
                                                                                                                                                            chip
                                                                                                                                                            cloner
                                                                                                                                                            that
                                                                                                                                                            actually
                                                                                                                                                            works.
                                                                                                                                                            Great
                                                                                                                                                            for
                                                                                                                                                            high-volume
                                                                                                                                                            shops
                                                                                                                                                            where
                                                                                                                                                            per-remote
                                                                                                                                                            cost
                                                                                                                                                            matters.
                                                                                                                                                            Easy
                                                                                                                                                            to
                                                                                                                                                            train
                                                                                                                                                            employees
                                                                                                                                                            on.'
                                                                                                                                                            },

                                                                                                                                                            //
                                                                                                                                                            Diagnostic
                                                                                                                                                            Tools
                                                                                                                                                            autel_maxisys:
                                                                                                                                                            {
                                                                                                                                                            name:
                                                                                                                                                            'Autel
                                                                                                                                                            MaxiSys
                                                                                                                                                            Update',
                                                                                                                                                            vendor:
                                                                                                                                                            'Autel',
                                                                                                                                                            cost:
                                                                                                                                                            800,
                                                                                                                                                            billingCycle:
                                                                                                                                                            'annual',
                                                                                                                                                            category:
                                                                                                                                                            'diagnostic',
                                                                                                                                                            notes:
                                                                                                                                                            'Comprehensive
                                                                                                                                                            diagnostics
                                                                                                                                                            with
                                                                                                                                                            ADAS,
                                                                                                                                                            coding,
                                                                                                                                                            and
                                                                                                                                                            DoIP
                                                                                                                                                            support.',
                                                                                                                                                            benefit:
                                                                                                                                                            'One
                                                                                                                                                            tool
                                                                                                                                                            for
                                                                                                                                                            everything:
                                                                                                                                                            diagnose
                                                                                                                                                            check
                                                                                                                                                            engine
                                                                                                                                                            lights
                                                                                                                                                            while
                                                                                                                                                            doing
                                                                                                                                                            keys.
                                                                                                                                                            ADAS
                                                                                                                                                            calibration
                                                                                                                                                            opens
                                                                                                                                                            new
                                                                                                                                                            $200+
                                                                                                                                                            revenue
                                                                                                                                                            per
                                                                                                                                                            job.
                                                                                                                                                            DoIP
                                                                                                                                                            covers
                                                                                                                                                            2021+
                                                                                                                                                            vehicles.'
                                                                                                                                                            },
                                                                                                                                                            launch_x431:
                                                                                                                                                            {
                                                                                                                                                            name:
                                                                                                                                                            'Launch
                                                                                                                                                            X431
                                                                                                                                                            Update',
                                                                                                                                                            vendor:
                                                                                                                                                            'Launch',
                                                                                                                                                            cost:
                                                                                                                                                            299,
                                                                                                                                                            billingCycle:
                                                                                                                                                            'annual',
                                                                                                                                                            category:
                                                                                                                                                            'diagnostic',
                                                                                                                                                            notes:
                                                                                                                                                            'Wide
                                                                                                                                                            vehicle
                                                                                                                                                            coverage
                                                                                                                                                            diagnostics.',
                                                                                                                                                            benefit:
                                                                                                                                                            'Excellent
                                                                                                                                                            Asian
                                                                                                                                                            vehicle
                                                                                                                                                            coverage
                                                                                                                                                            at
                                                                                                                                                            half
                                                                                                                                                            the
                                                                                                                                                            Autel
                                                                                                                                                            price.
                                                                                                                                                            Great
                                                                                                                                                            dedicated
                                                                                                                                                            diagnostic
                                                                                                                                                            tool
                                                                                                                                                            if
                                                                                                                                                            you
                                                                                                                                                            have
                                                                                                                                                            separate
                                                                                                                                                            key
                                                                                                                                                            programming
                                                                                                                                                            equipment.'
                                                                                                                                                            },
                                                                                                                                                            topdon_phoenix:
                                                                                                                                                            {
                                                                                                                                                            name:
                                                                                                                                                            'TOPDON
                                                                                                                                                            Phoenix
                                                                                                                                                            Update',
                                                                                                                                                            vendor:
                                                                                                                                                            'TOPDON',
                                                                                                                                                            cost:
                                                                                                                                                            399,
                                                                                                                                                            billingCycle:
                                                                                                                                                            'annual',
                                                                                                                                                            category:
                                                                                                                                                            'diagnostic',
                                                                                                                                                            notes:
                                                                                                                                                            'Affordable
                                                                                                                                                            MaxiSys
                                                                                                                                                            alternative.',
                                                                                                                                                            benefit:
                                                                                                                                                            'Same
                                                                                                                                                            J2534
                                                                                                                                                            capabilities
                                                                                                                                                            as
                                                                                                                                                            MaxiSys
                                                                                                                                                            for
                                                                                                                                                            OEM
                                                                                                                                                            programming
                                                                                                                                                            pass-thru
                                                                                                                                                            at
                                                                                                                                                            lower
                                                                                                                                                            cost.
                                                                                                                                                            Good
                                                                                                                                                            choice
                                                                                                                                                            for
                                                                                                                                                            new
                                                                                                                                                            shops
                                                                                                                                                            building
                                                                                                                                                            their
                                                                                                                                                            toolkit.'
                                                                                                                                                            },
                                                                                                                                                            thinkdiag:
                                                                                                                                                            {
                                                                                                                                                            name:
                                                                                                                                                            'ThinkDiag
                                                                                                                                                            Pro',
                                                                                                                                                            vendor:
                                                                                                                                                            'ThinkCar',
                                                                                                                                                            cost:
                                                                                                                                                            99,
                                                                                                                                                            billingCycle:
                                                                                                                                                            'annual',
                                                                                                                                                            category:
                                                                                                                                                            'diagnostic',
                                                                                                                                                            notes:
                                                                                                                                                            'Bluetooth
                                                                                                                                                            OBD
                                                                                                                                                            scanner
                                                                                                                                                            with
                                                                                                                                                            app-based
                                                                                                                                                            diagnostics.',
                                                                                                                                                            benefit:
                                                                                                                                                            'Ultra-portable
                                                                                                                                                            backup
                                                                                                                                                            scanner.
                                                                                                                                                            Keep
                                                                                                                                                            in
                                                                                                                                                            your
                                                                                                                                                            van
                                                                                                                                                            for
                                                                                                                                                            quick
                                                                                                                                                            diagnostic
                                                                                                                                                            checks
                                                                                                                                                            when
                                                                                                                                                            main
                                                                                                                                                            tool
                                                                                                                                                            is
                                                                                                                                                            at
                                                                                                                                                            the
                                                                                                                                                            shop.
                                                                                                                                                            Great
                                                                                                                                                            customer
                                                                                                                                                            demo
                                                                                                                                                            tool.'
                                                                                                                                                            },
                                                                                                                                                            foxwell_gt90:
                                                                                                                                                            {
                                                                                                                                                            name:
                                                                                                                                                            'Foxwell
                                                                                                                                                            GT90',
                                                                                                                                                            vendor:
                                                                                                                                                            'Foxwell',
                                                                                                                                                            cost:
                                                                                                                                                            199,
                                                                                                                                                            billingCycle:
                                                                                                                                                            'annual',
                                                                                                                                                            category:
                                                                                                                                                            'diagnostic',
                                                                                                                                                            notes:
                                                                                                                                                            'Full
                                                                                                                                                            system
                                                                                                                                                            diagnostics.',
                                                                                                                                                            benefit:
                                                                                                                                                            'Reliable
                                                                                                                                                            mid-range
                                                                                                                                                            scanner
                                                                                                                                                            for
                                                                                                                                                            European
                                                                                                                                                            vehicles.
                                                                                                                                                            Good
                                                                                                                                                            for
                                                                                                                                                            shops
                                                                                                                                                            that
                                                                                                                                                            specialize
                                                                                                                                                            in
                                                                                                                                                            BMW,
                                                                                                                                                            Mercedes,
                                                                                                                                                            or
                                                                                                                                                            VW
                                                                                                                                                            and
                                                                                                                                                            need
                                                                                                                                                            dedicated
                                                                                                                                                            Euro
                                                                                                                                                            coverage.'
                                                                                                                                                            },
                                                                                                                                                            autel_im508:
                                                                                                                                                            {
                                                                                                                                                            name:
                                                                                                                                                            'Autel
                                                                                                                                                            IM508
                                                                                                                                                            Update',
                                                                                                                                                            vendor:
                                                                                                                                                            'Autel',
                                                                                                                                                            cost:
                                                                                                                                                            395,
                                                                                                                                                            billingCycle:
                                                                                                                                                            'annual',
                                                                                                                                                            category:
                                                                                                                                                            'key_programmer',
                                                                                                                                                            notes:
                                                                                                                                                            'Entry-level
                                                                                                                                                            IMMO
                                                                                                                                                            programmer.',
                                                                                                                                                            benefit:
                                                                                                                                                            'Best
                                                                                                                                                            entry
                                                                                                                                                            point
                                                                                                                                                            into
                                                                                                                                                            professional
                                                                                                                                                            IMMO
                                                                                                                                                            programming.
                                                                                                                                                            XP400
                                                                                                                                                            Pro
                                                                                                                                                            unlocks
                                                                                                                                                            read/write
                                                                                                                                                            capabilities.
                                                                                                                                                            TCP
                                                                                                                                                            not
                                                                                                                                                            included
                                                                                                                                                            but
                                                                                                                                                            add-key
                                                                                                                                                            works
                                                                                                                                                            for
                                                                                                                                                            most
                                                                                                                                                            jobs.'
                                                                                                                                                            },

                                                                                                                                                            //
                                                                                                                                                            OEM
                                                                                                                                                            Dealer
                                                                                                                                                            Access
                                                                                                                                                            toyota_techstream:
                                                                                                                                                            {
                                                                                                                                                            name:
                                                                                                                                                            'Toyota
                                                                                                                                                            Techstream',
                                                                                                                                                            vendor:
                                                                                                                                                            'Toyota',
                                                                                                                                                            cost:
                                                                                                                                                            55,
                                                                                                                                                            billingCycle:
                                                                                                                                                            '2day',
                                                                                                                                                            category:
                                                                                                                                                            'oem_dealer',
                                                                                                                                                            notes:
                                                                                                                                                            '$55
                                                                                                                                                            for
                                                                                                                                                            2-day
                                                                                                                                                            access.
                                                                                                                                                            Required
                                                                                                                                                            for
                                                                                                                                                            factory
                                                                                                                                                            key
                                                                                                                                                            add.',
                                                                                                                                                            benefit:
                                                                                                                                                            '100%
                                                                                                                                                            success
                                                                                                                                                            rate
                                                                                                                                                            on
                                                                                                                                                            Toyota
                                                                                                                                                            key
                                                                                                                                                            registration.
                                                                                                                                                            Alternative
                                                                                                                                                            to
                                                                                                                                                            aftermarket
                                                                                                                                                            when
                                                                                                                                                            time
                                                                                                                                                            is
                                                                                                                                                            critical
                                                                                                                                                            or
                                                                                                                                                            customer
                                                                                                                                                            wants
                                                                                                                                                            OEM
                                                                                                                                                            solution.
                                                                                                                                                            Bill
                                                                                                                                                            to
                                                                                                                                                            customer.'
                                                                                                                                                            },
                                                                                                                                                            honda_hds:
                                                                                                                                                            {
                                                                                                                                                            name:
                                                                                                                                                            'Honda
                                                                                                                                                            HDS',
                                                                                                                                                            vendor:
                                                                                                                                                            'Honda',
                                                                                                                                                            cost:
                                                                                                                                                            55,
                                                                                                                                                            billingCycle:
                                                                                                                                                            'daily',
                                                                                                                                                            category:
                                                                                                                                                            'oem_dealer',
                                                                                                                                                            notes:
                                                                                                                                                            'OEM
                                                                                                                                                            diagnostics
                                                                                                                                                            and
                                                                                                                                                            immobilizer
                                                                                                                                                            reset.',
                                                                                                                                                            benefit:
                                                                                                                                                            'Resets
                                                                                                                                                            immobilizer
                                                                                                                                                            after
                                                                                                                                                            ECU
                                                                                                                                                            replacement.
                                                                                                                                                            Required
                                                                                                                                                            for
                                                                                                                                                            some
                                                                                                                                                            newer
                                                                                                                                                            Honda/Acura
                                                                                                                                                            models
                                                                                                                                                            where
                                                                                                                                                            aftermarket
                                                                                                                                                            fails.
                                                                                                                                                            Add
                                                                                                                                                            $100
                                                                                                                                                            to
                                                                                                                                                            job
                                                                                                                                                            for
                                                                                                                                                            access.'
                                                                                                                                                            },
                                                                                                                                                            ford_fdrs:
                                                                                                                                                            {
                                                                                                                                                            name:
                                                                                                                                                            'Ford
                                                                                                                                                            FDRS',
                                                                                                                                                            vendor:
                                                                                                                                                            'Ford',
                                                                                                                                                            cost:
                                                                                                                                                            40,
                                                                                                                                                            billingCycle:
                                                                                                                                                            'daily',
                                                                                                                                                            category:
                                                                                                                                                            'oem_dealer',
                                                                                                                                                            notes:
                                                                                                                                                            'Required
                                                                                                                                                            for
                                                                                                                                                            2021+
                                                                                                                                                            AKL
                                                                                                                                                            with
                                                                                                                                                            CAN-FD.',
                                                                                                                                                            benefit:
                                                                                                                                                            'Only
                                                                                                                                                            option
                                                                                                                                                            for
                                                                                                                                                            2021+
                                                                                                                                                            Ford/Lincoln
                                                                                                                                                            all-keys-lost.
                                                                                                                                                            CAN-FD
                                                                                                                                                            vehicles
                                                                                                                                                            will
                                                                                                                                                            NOT
                                                                                                                                                            program
                                                                                                                                                            with
                                                                                                                                                            aftermarket
                                                                                                                                                            until
                                                                                                                                                            FDRS
                                                                                                                                                            is
                                                                                                                                                            used
                                                                                                                                                            first.
                                                                                                                                                            Essential
                                                                                                                                                            for
                                                                                                                                                            modern
                                                                                                                                                            Ford.'
                                                                                                                                                            },
                                                                                                                                                            fca_witech:
                                                                                                                                                            {
                                                                                                                                                            name:
                                                                                                                                                            'FCA
                                                                                                                                                            WiTech
                                                                                                                                                            2.0',
                                                                                                                                                            vendor:
                                                                                                                                                            'Stellantis',
                                                                                                                                                            cost:
                                                                                                                                                            100,
                                                                                                                                                            billingCycle:
                                                                                                                                                            'daily',
                                                                                                                                                            category:
                                                                                                                                                            'oem_dealer',
                                                                                                                                                            notes:
                                                                                                                                                            'Chrysler/Dodge/Jeep/Ram
                                                                                                                                                            dealer
                                                                                                                                                            diagnostics.',
                                                                                                                                                            benefit:
                                                                                                                                                            'Bypass
                                                                                                                                                            SGW
                                                                                                                                                            security
                                                                                                                                                            gateway
                                                                                                                                                            on
                                                                                                                                                            2018+
                                                                                                                                                            Chrysler
                                                                                                                                                            vehicles.
                                                                                                                                                            AutoAuth
                                                                                                                                                            integration
                                                                                                                                                            makes
                                                                                                                                                            it
                                                                                                                                                            seamless.
                                                                                                                                                            Required
                                                                                                                                                            for
                                                                                                                                                            most
                                                                                                                                                            modern
                                                                                                                                                            CDJR
                                                                                                                                                            AKL
                                                                                                                                                            jobs.'
                                                                                                                                                            },
                                                                                                                                                            gm_gds2:
                                                                                                                                                            {
                                                                                                                                                            name:
                                                                                                                                                            'GM
                                                                                                                                                            GDS2/Tech2Win',
                                                                                                                                                            vendor:
                                                                                                                                                            'GM',
                                                                                                                                                            cost:
                                                                                                                                                            50,
                                                                                                                                                            billingCycle:
                                                                                                                                                            'daily',
                                                                                                                                                            category:
                                                                                                                                                            'oem_dealer',
                                                                                                                                                            notes:
                                                                                                                                                            'GM
                                                                                                                                                            dealer
                                                                                                                                                            diagnostics
                                                                                                                                                            and
                                                                                                                                                            programming.',
                                                                                                                                                            benefit:
                                                                                                                                                            'Factory
                                                                                                                                                            security
                                                                                                                                                            reset
                                                                                                                                                            for
                                                                                                                                                            GM
                                                                                                                                                            vehicles.
                                                                                                                                                            Required
                                                                                                                                                            for
                                                                                                                                                            some
                                                                                                                                                            2019+
                                                                                                                                                            Silverado
                                                                                                                                                            and
                                                                                                                                                            Sierra
                                                                                                                                                            AKL.
                                                                                                                                                            Pass
                                                                                                                                                            through
                                                                                                                                                            for
                                                                                                                                                            module
                                                                                                                                                            programming.'
                                                                                                                                                            },
                                                                                                                                                            nissan_consult:
                                                                                                                                                            {
                                                                                                                                                            name:
                                                                                                                                                            'Nissan
                                                                                                                                                            Consult
                                                                                                                                                            III+',
                                                                                                                                                            vendor:
                                                                                                                                                            'Nissan',
                                                                                                                                                            cost:
                                                                                                                                                            65,
                                                                                                                                                            billingCycle:
                                                                                                                                                            'daily',
                                                                                                                                                            category:
                                                                                                                                                            'oem_dealer',
                                                                                                                                                            notes:
                                                                                                                                                            'Factory
                                                                                                                                                            immobilizer
                                                                                                                                                            programming.',
                                                                                                                                                            benefit:
                                                                                                                                                            'Dealer-level
                                                                                                                                                            key
                                                                                                                                                            registration
                                                                                                                                                            for
                                                                                                                                                            when
                                                                                                                                                            aftermarket
                                                                                                                                                            gets
                                                                                                                                                            blacklisted.
                                                                                                                                                            Infiniti
                                                                                                                                                            coverage
                                                                                                                                                            included.
                                                                                                                                                            Good
                                                                                                                                                            fallback
                                                                                                                                                            for
                                                                                                                                                            difficult
                                                                                                                                                            Altima
                                                                                                                                                            jobs.'
                                                                                                                                                            },
                                                                                                                                                            bmw_ista:
                                                                                                                                                            {
                                                                                                                                                            name:
                                                                                                                                                            'BMW
                                                                                                                                                            ISTA/D',
                                                                                                                                                            vendor:
                                                                                                                                                            'BMW',
                                                                                                                                                            cost:
                                                                                                                                                            100,
                                                                                                                                                            billingCycle:
                                                                                                                                                            'daily',
                                                                                                                                                            category:
                                                                                                                                                            'oem_dealer',
                                                                                                                                                            notes:
                                                                                                                                                            'OEM
                                                                                                                                                            coding
                                                                                                                                                            and
                                                                                                                                                            programming.
                                                                                                                                                            Requires
                                                                                                                                                            PassThru.',
                                                                                                                                                            benefit:
                                                                                                                                                            'Factory
                                                                                                                                                            programming
                                                                                                                                                            for
                                                                                                                                                            BMW
                                                                                                                                                            modules.
                                                                                                                                                            Required
                                                                                                                                                            for
                                                                                                                                                            FEM/BDC
                                                                                                                                                            key
                                                                                                                                                            sync
                                                                                                                                                            on
                                                                                                                                                            newer
                                                                                                                                                            models.
                                                                                                                                                            Professional
                                                                                                                                                            image
                                                                                                                                                            with
                                                                                                                                                            customers
                                                                                                                                                            who
                                                                                                                                                            want
                                                                                                                                                            OEM.'
                                                                                                                                                            },
                                                                                                                                                            mb_xentry:
                                                                                                                                                            {
                                                                                                                                                            name:
                                                                                                                                                            'Mercedes
                                                                                                                                                            Xentry',
                                                                                                                                                            vendor:
                                                                                                                                                            'Mercedes-Benz',
                                                                                                                                                            cost:
                                                                                                                                                            150,
                                                                                                                                                            billingCycle:
                                                                                                                                                            'daily',
                                                                                                                                                            category:
                                                                                                                                                            'oem_dealer',
                                                                                                                                                            notes:
                                                                                                                                                            'Only
                                                                                                                                                            option
                                                                                                                                                            for
                                                                                                                                                            FBS4
                                                                                                                                                            (2019+)
                                                                                                                                                            vehicles.',
                                                                                                                                                            benefit:
                                                                                                                                                            'ONLY
                                                                                                                                                            way
                                                                                                                                                            to
                                                                                                                                                            do
                                                                                                                                                            2019+
                                                                                                                                                            Mercedes.
                                                                                                                                                            No
                                                                                                                                                            aftermarket
                                                                                                                                                            solution
                                                                                                                                                            exists
                                                                                                                                                            for
                                                                                                                                                            FBS4.
                                                                                                                                                            $500+
                                                                                                                                                            per
                                                                                                                                                            key
                                                                                                                                                            job
                                                                                                                                                            easily
                                                                                                                                                            covers
                                                                                                                                                            daily
                                                                                                                                                            access
                                                                                                                                                            cost.'
                                                                                                                                                            },
                                                                                                                                                            vw_odis:
                                                                                                                                                            {
                                                                                                                                                            name:
                                                                                                                                                            'VW/Audi
                                                                                                                                                            ODIS',
                                                                                                                                                            vendor:
                                                                                                                                                            'VAG',
                                                                                                                                                            cost:
                                                                                                                                                            100,
                                                                                                                                                            billingCycle:
                                                                                                                                                            'daily',
                                                                                                                                                            category:
                                                                                                                                                            'oem_dealer',
                                                                                                                                                            notes:
                                                                                                                                                            'Required
                                                                                                                                                            for
                                                                                                                                                            online
                                                                                                                                                            component
                                                                                                                                                            protection.',
                                                                                                                                                            benefit:
                                                                                                                                                            'Component
                                                                                                                                                            protection
                                                                                                                                                            unlock
                                                                                                                                                            for
                                                                                                                                                            newer
                                                                                                                                                            VAG.
                                                                                                                                                            Some
                                                                                                                                                            2020+
                                                                                                                                                            Audi
                                                                                                                                                            require
                                                                                                                                                            ODIS
                                                                                                                                                            for
                                                                                                                                                            key
                                                                                                                                                            learning.
                                                                                                                                                            Dealer-level
                                                                                                                                                            coding
                                                                                                                                                            and
                                                                                                                                                            adaptation.'
                                                                                                                                                            },
                                                                                                                                                            subaru_ssmiv:
                                                                                                                                                            {
                                                                                                                                                            name:
                                                                                                                                                            'Subaru
                                                                                                                                                            SSM
                                                                                                                                                            IV',
                                                                                                                                                            vendor:
                                                                                                                                                            'Subaru',
                                                                                                                                                            cost:
                                                                                                                                                            65,
                                                                                                                                                            billingCycle:
                                                                                                                                                            'daily',
                                                                                                                                                            category:
                                                                                                                                                            'oem_dealer',
                                                                                                                                                            notes:
                                                                                                                                                            'OEM
                                                                                                                                                            immobilizer
                                                                                                                                                            registration.',
                                                                                                                                                            benefit:
                                                                                                                                                            'Factory
                                                                                                                                                            key
                                                                                                                                                            registration
                                                                                                                                                            for
                                                                                                                                                            Subaru.
                                                                                                                                                            Great
                                                                                                                                                            for
                                                                                                                                                            mobile
                                                                                                                                                            locksmiths
                                                                                                                                                            in
                                                                                                                                                            areas
                                                                                                                                                            with
                                                                                                                                                            many
                                                                                                                                                            Subaru
                                                                                                                                                            owners.
                                                                                                                                                            Reliable
                                                                                                                                                            alternative
                                                                                                                                                            to
                                                                                                                                                            aftermarket.'
                                                                                                                                                            },

                                                                                                                                                            //
                                                                                                                                                            Access
                                                                                                                                                            Subscriptions
                                                                                                                                                            nastf:
                                                                                                                                                            {
                                                                                                                                                            name:
                                                                                                                                                            'NASTF
                                                                                                                                                            Registration',
                                                                                                                                                            vendor:
                                                                                                                                                            'NASTF',
                                                                                                                                                            cost:
                                                                                                                                                            30,
                                                                                                                                                            billingCycle:
                                                                                                                                                            'annual',
                                                                                                                                                            category:
                                                                                                                                                            'access',
                                                                                                                                                            notes:
                                                                                                                                                            'Required
                                                                                                                                                            for
                                                                                                                                                            OEM
                                                                                                                                                            security
                                                                                                                                                            access
                                                                                                                                                            (SBCA,
                                                                                                                                                            SGW
                                                                                                                                                            bypass).',
                                                                                                                                                            benefit:
                                                                                                                                                            'Mandatory
                                                                                                                                                            for
                                                                                                                                                            OEM
                                                                                                                                                            tool
                                                                                                                                                            access!
                                                                                                                                                            Only
                                                                                                                                                            $30/year
                                                                                                                                                            unlocks
                                                                                                                                                            ability
                                                                                                                                                            to
                                                                                                                                                            buy
                                                                                                                                                            Techstream,
                                                                                                                                                            FDRS,
                                                                                                                                                            WiTech
                                                                                                                                                            subscriptions.
                                                                                                                                                            No
                                                                                                                                                            NASTF
                                                                                                                                                            =
                                                                                                                                                            no
                                                                                                                                                            OEM
                                                                                                                                                            tools.'
                                                                                                                                                            },
                                                                                                                                                            autoauth:
                                                                                                                                                            {
                                                                                                                                                            name:
                                                                                                                                                            'AutoAuth
                                                                                                                                                            Access',
                                                                                                                                                            vendor:
                                                                                                                                                            'AutoAuth',
                                                                                                                                                            cost:
                                                                                                                                                            250,
                                                                                                                                                            billingCycle:
                                                                                                                                                            'annual',
                                                                                                                                                            category:
                                                                                                                                                            'access',
                                                                                                                                                            notes:
                                                                                                                                                            'FCA
                                                                                                                                                            SGW
                                                                                                                                                            cloud
                                                                                                                                                            unlock
                                                                                                                                                            integration.',
                                                                                                                                                            benefit:
                                                                                                                                                            'One-click
                                                                                                                                                            SGW
                                                                                                                                                            bypass
                                                                                                                                                            for
                                                                                                                                                            all
                                                                                                                                                            your
                                                                                                                                                            tools
                                                                                                                                                            (Autel,
                                                                                                                                                            Launch,
                                                                                                                                                            etc.).
                                                                                                                                                            Works
                                                                                                                                                            with
                                                                                                                                                            WiTech
                                                                                                                                                            too.
                                                                                                                                                            Essential
                                                                                                                                                            if
                                                                                                                                                            you
                                                                                                                                                            do
                                                                                                                                                            any
                                                                                                                                                            2018+
                                                                                                                                                            CDJR
                                                                                                                                                            vehicles.'
                                                                                                                                                            },
                                                                                                                                                            key_comm:
                                                                                                                                                            {
                                                                                                                                                            name:
                                                                                                                                                            'KEY-Comm',
                                                                                                                                                            vendor:
                                                                                                                                                            'ALOA',
                                                                                                                                                            cost:
                                                                                                                                                            150,
                                                                                                                                                            billingCycle:
                                                                                                                                                            'annual',
                                                                                                                                                            category:
                                                                                                                                                            'access',
                                                                                                                                                            notes:
                                                                                                                                                            'Locksmith
                                                                                                                                                            verification
                                                                                                                                                            and
                                                                                                                                                            key
                                                                                                                                                            code
                                                                                                                                                            lookup
                                                                                                                                                            network.',
                                                                                                                                                            benefit:
                                                                                                                                                            'Access
                                                                                                                                                            to
                                                                                                                                                            key
                                                                                                                                                            codes
                                                                                                                                                            for
                                                                                                                                                            thousands
                                                                                                                                                            of
                                                                                                                                                            vehicles.
                                                                                                                                                            Locksmith
                                                                                                                                                            verification
                                                                                                                                                            improves
                                                                                                                                                            credibility.
                                                                                                                                                            Network
                                                                                                                                                            to
                                                                                                                                                            source
                                                                                                                                                            rare
                                                                                                                                                            key
                                                                                                                                                            blanks
                                                                                                                                                            and
                                                                                                                                                            parts.'
                                                                                                                                                            },
                                                                                                                                                            autel_immo:
                                                                                                                                                            {
                                                                                                                                                            name:
                                                                                                                                                            'Autel
                                                                                                                                                            MaxiIM
                                                                                                                                                            Update',
                                                                                                                                                            vendor:
                                                                                                                                                            'Autel',
                                                                                                                                                            cost:
                                                                                                                                                            895,
                                                                                                                                                            billingCycle:
                                                                                                                                                            'annual',
                                                                                                                                                            category:
                                                                                                                                                            'key_programmer',
                                                                                                                                                            notes:
                                                                                                                                                            'Same
                                                                                                                                                            as
                                                                                                                                                            TCP
                                                                                                                                                            for
                                                                                                                                                            IM608
                                                                                                                                                            series.',
                                                                                                                                                            benefit:
                                                                                                                                                            'Identical
                                                                                                                                                            benefits
                                                                                                                                                            to
                                                                                                                                                            TCPâ€”if
                                                                                                                                                            you
                                                                                                                                                            have
                                                                                                                                                            IM608
                                                                                                                                                            instead
                                                                                                                                                            of
                                                                                                                                                            IM508+XP400,
                                                                                                                                                            this
                                                                                                                                                            is
                                                                                                                                                            your
                                                                                                                                                            subscription.
                                                                                                                                                            Same
                                                                                                                                                            server
                                                                                                                                                            calculations,
                                                                                                                                                            same
                                                                                                                                                            coverage.'
                                                                                                                                                            },

                                                                                                                                                            //
                                                                                                                                                            Software
                                                                                                                                                            instacode:
                                                                                                                                                            {
                                                                                                                                                            name:
                                                                                                                                                            'Instacode',
                                                                                                                                                            vendor:
                                                                                                                                                            'Instacode',
                                                                                                                                                            cost:
                                                                                                                                                            199,
                                                                                                                                                            billingCycle:
                                                                                                                                                            'annual',
                                                                                                                                                            category:
                                                                                                                                                            'software',
                                                                                                                                                            notes:
                                                                                                                                                            'Key
                                                                                                                                                            code
                                                                                                                                                            lookup
                                                                                                                                                            and
                                                                                                                                                            transponder
                                                                                                                                                            reference
                                                                                                                                                            database.',
                                                                                                                                                            benefit:
                                                                                                                                                            'Industry-standard
                                                                                                                                                            key
                                                                                                                                                            code
                                                                                                                                                            database.
                                                                                                                                                            Look
                                                                                                                                                            up
                                                                                                                                                            cuts
                                                                                                                                                            by
                                                                                                                                                            VIN,
                                                                                                                                                            decode
                                                                                                                                                            existing
                                                                                                                                                            keys,
                                                                                                                                                            identify
                                                                                                                                                            transponder
                                                                                                                                                            types.
                                                                                                                                                            Saves
                                                                                                                                                            hours
                                                                                                                                                            of
                                                                                                                                                            research
                                                                                                                                                            per
                                                                                                                                                            week.'
                                                                                                                                                            },
                                                                                                                                                            keypro:
                                                                                                                                                            {
                                                                                                                                                            name:
                                                                                                                                                            'Key-Pro',
                                                                                                                                                            vendor:
                                                                                                                                                            'Key-Pro',
                                                                                                                                                            cost:
                                                                                                                                                            249,
                                                                                                                                                            billingCycle:
                                                                                                                                                            'annual',
                                                                                                                                                            category:
                                                                                                                                                            'software',
                                                                                                                                                            notes:
                                                                                                                                                            'Comprehensive
                                                                                                                                                            key
                                                                                                                                                            and
                                                                                                                                                            remote
                                                                                                                                                            database.',
                                                                                                                                                            benefit:
                                                                                                                                                            'Combines
                                                                                                                                                            key
                                                                                                                                                            codes,
                                                                                                                                                            transponder
                                                                                                                                                            data,
                                                                                                                                                            and
                                                                                                                                                            remote
                                                                                                                                                            programming
                                                                                                                                                            in
                                                                                                                                                            one
                                                                                                                                                            app.
                                                                                                                                                            Cross-references
                                                                                                                                                            FCC
                                                                                                                                                            IDs
                                                                                                                                                            to
                                                                                                                                                            OEM
                                                                                                                                                            part
                                                                                                                                                            numbers.
                                                                                                                                                            Mobile-friendly.'
                                                                                                                                                            },
                                                                                                                                                            truecode:
                                                                                                                                                            {
                                                                                                                                                            name:
                                                                                                                                                            'True-Code',
                                                                                                                                                            vendor:
                                                                                                                                                            'True
                                                                                                                                                            Mileage',
                                                                                                                                                            cost:
                                                                                                                                                            149,
                                                                                                                                                            billingCycle:
                                                                                                                                                            'annual',
                                                                                                                                                            category:
                                                                                                                                                            'software',
                                                                                                                                                            notes:
                                                                                                                                                            'Vehicle
                                                                                                                                                            key
                                                                                                                                                            code
                                                                                                                                                            lookup.',
                                                                                                                                                            benefit:
                                                                                                                                                            'Budget
                                                                                                                                                            alternative
                                                                                                                                                            to
                                                                                                                                                            Instacode.
                                                                                                                                                            Good
                                                                                                                                                            domestic
                                                                                                                                                            vehicle
                                                                                                                                                            coverage.
                                                                                                                                                            Includes
                                                                                                                                                            some
                                                                                                                                                            pin
                                                                                                                                                            code
                                                                                                                                                            data
                                                                                                                                                            for
                                                                                                                                                            older
                                                                                                                                                            imports.'
                                                                                                                                                            },
                                                                                                                                                            jetlock:
                                                                                                                                                            {
                                                                                                                                                            name:
                                                                                                                                                            'Jet
                                                                                                                                                            Lock
                                                                                                                                                            Tools',
                                                                                                                                                            vendor:
                                                                                                                                                            'Jet
                                                                                                                                                            Lock',
                                                                                                                                                            cost:
                                                                                                                                                            99,
                                                                                                                                                            billingCycle:
                                                                                                                                                            'annual',
                                                                                                                                                            category:
                                                                                                                                                            'software',
                                                                                                                                                            notes:
                                                                                                                                                            'Locksmith
                                                                                                                                                            software
                                                                                                                                                            suite.',
                                                                                                                                                            benefit:
                                                                                                                                                            'All-in-one
                                                                                                                                                            locksmith
                                                                                                                                                            reference.
                                                                                                                                                            Key
                                                                                                                                                            blanks,
                                                                                                                                                            transponders,
                                                                                                                                                            remotes,
                                                                                                                                                            and
                                                                                                                                                            lock
                                                                                                                                                            information.
                                                                                                                                                            Great
                                                                                                                                                            for
                                                                                                                                                            training
                                                                                                                                                            new
                                                                                                                                                            technicians.'
                                                                                                                                                            },
                                                                                                                                                            keyless_api:
                                                                                                                                                            {
                                                                                                                                                            name:
                                                                                                                                                            'Keyless
                                                                                                                                                            Entry
                                                                                                                                                            API',
                                                                                                                                                            vendor:
                                                                                                                                                            'Various',
                                                                                                                                                            cost:
                                                                                                                                                            120,
                                                                                                                                                            billingCycle:
                                                                                                                                                            'annual',
                                                                                                                                                            category:
                                                                                                                                                            'software',
                                                                                                                                                            notes:
                                                                                                                                                            'Remote
                                                                                                                                                            frequency
                                                                                                                                                            lookup
                                                                                                                                                            API.',
                                                                                                                                                            benefit:
                                                                                                                                                            'Quick
                                                                                                                                                            FCC
                                                                                                                                                            ID
                                                                                                                                                            lookups
                                                                                                                                                            when
                                                                                                                                                            customers
                                                                                                                                                            call
                                                                                                                                                            with
                                                                                                                                                            remote
                                                                                                                                                            questions.
                                                                                                                                                            Helps
                                                                                                                                                            quote
                                                                                                                                                            jobs
                                                                                                                                                            accurately
                                                                                                                                                            without
                                                                                                                                                            visiting
                                                                                                                                                            vehicle
                                                                                                                                                            first.'
                                                                                                                                                            },
                                                                                                                                                            lishi_decoder:
                                                                                                                                                            {
                                                                                                                                                            name:
                                                                                                                                                            'Lishi
                                                                                                                                                            Decoder
                                                                                                                                                            App',
                                                                                                                                                            vendor:
                                                                                                                                                            'Lishi',
                                                                                                                                                            cost:
                                                                                                                                                            79,
                                                                                                                                                            billingCycle:
                                                                                                                                                            'annual',
                                                                                                                                                            category:
                                                                                                                                                            'software',
                                                                                                                                                            notes:
                                                                                                                                                            'Digital
                                                                                                                                                            Lishi
                                                                                                                                                            picking
                                                                                                                                                            reference.',
                                                                                                                                                            benefit:
                                                                                                                                                            'Pocket
                                                                                                                                                            reference
                                                                                                                                                            for
                                                                                                                                                            Lishi
                                                                                                                                                            tool
                                                                                                                                                            selection
                                                                                                                                                            and
                                                                                                                                                            decoding.
                                                                                                                                                            No
                                                                                                                                                            more
                                                                                                                                                            fumbling
                                                                                                                                                            with
                                                                                                                                                            paper
                                                                                                                                                            charts.
                                                                                                                                                            Works
                                                                                                                                                            offline
                                                                                                                                                            in
                                                                                                                                                            the
                                                                                                                                                            field.'
                                                                                                                                                            },

                                                                                                                                                            //
                                                                                                                                                            Tokens
                                                                                                                                                            (Per-Use)
                                                                                                                                                            xhorse_mb_tokens:
                                                                                                                                                            {
                                                                                                                                                            name:
                                                                                                                                                            'Xhorse
                                                                                                                                                            MB
                                                                                                                                                            Tokens',
                                                                                                                                                            vendor:
                                                                                                                                                            'Xhorse',
                                                                                                                                                            cost:
                                                                                                                                                            0,
                                                                                                                                                            billingCycle:
                                                                                                                                                            'per_use',
                                                                                                                                                            category:
                                                                                                                                                            'tokens',
                                                                                                                                                            notes:
                                                                                                                                                            '$5-20
                                                                                                                                                            per
                                                                                                                                                            calculation.
                                                                                                                                                            FBS3/FBS4
                                                                                                                                                            password.',
                                                                                                                                                            benefit:
                                                                                                                                                            'Pay
                                                                                                                                                            only
                                                                                                                                                            when
                                                                                                                                                            you
                                                                                                                                                            work
                                                                                                                                                            Mercedes.
                                                                                                                                                            No
                                                                                                                                                            subscription
                                                                                                                                                            waste.
                                                                                                                                                            Buy
                                                                                                                                                            tokens
                                                                                                                                                            when
                                                                                                                                                            you
                                                                                                                                                            have
                                                                                                                                                            a
                                                                                                                                                            job
                                                                                                                                                            lined
                                                                                                                                                            upâ€”predictable
                                                                                                                                                            per-job
                                                                                                                                                            cost.'
                                                                                                                                                            },
                                                                                                                                                            autel_tokens:
                                                                                                                                                            {
                                                                                                                                                            name:
                                                                                                                                                            'Autel
                                                                                                                                                            Calculation
                                                                                                                                                            Tokens',
                                                                                                                                                            vendor:
                                                                                                                                                            'Autel',
                                                                                                                                                            cost:
                                                                                                                                                            0,
                                                                                                                                                            billingCycle:
                                                                                                                                                            'per_use',
                                                                                                                                                            category:
                                                                                                                                                            'tokens',
                                                                                                                                                            notes:
                                                                                                                                                            'Included
                                                                                                                                                            with
                                                                                                                                                            TCP
                                                                                                                                                            subscription.',
                                                                                                                                                            benefit:
                                                                                                                                                            'Already
                                                                                                                                                            included
                                                                                                                                                            with
                                                                                                                                                            TCP!
                                                                                                                                                            No
                                                                                                                                                            extra
                                                                                                                                                            cost
                                                                                                                                                            for
                                                                                                                                                            server
                                                                                                                                                            calculations.
                                                                                                                                                            This
                                                                                                                                                            is
                                                                                                                                                            why
                                                                                                                                                            TCP
                                                                                                                                                            is
                                                                                                                                                            valuableâ€”unlimited
                                                                                                                                                            calculations
                                                                                                                                                            for
                                                                                                                                                            flat
                                                                                                                                                            $895/year.'
                                                                                                                                                            },
                                                                                                                                                            lonsdor_jlr:
                                                                                                                                                            {
                                                                                                                                                            name:
                                                                                                                                                            'Lonsdor
                                                                                                                                                            JLR
                                                                                                                                                            License',
                                                                                                                                                            vendor:
                                                                                                                                                            'Lonsdor',
                                                                                                                                                            cost:
                                                                                                                                                            180,
                                                                                                                                                            billingCycle:
                                                                                                                                                            'lifetime',
                                                                                                                                                            category:
                                                                                                                                                            'tokens',
                                                                                                                                                            notes:
                                                                                                                                                            'One-time
                                                                                                                                                            purchase.
                                                                                                                                                            JLR
                                                                                                                                                            OBD
                                                                                                                                                            with
                                                                                                                                                            active
                                                                                                                                                            alarm.',
                                                                                                                                                            benefit:
                                                                                                                                                            'ONLY
                                                                                                                                                            tool
                                                                                                                                                            that
                                                                                                                                                            does
                                                                                                                                                            Jaguar/Land
                                                                                                                                                            Rover
                                                                                                                                                            OBD
                                                                                                                                                            with
                                                                                                                                                            active
                                                                                                                                                            alarm
                                                                                                                                                            (no
                                                                                                                                                            key
                                                                                                                                                            present).
                                                                                                                                                            One-time
                                                                                                                                                            purchase,
                                                                                                                                                            no
                                                                                                                                                            recurring
                                                                                                                                                            cost.
                                                                                                                                                            $400-600
                                                                                                                                                            per
                                                                                                                                                            JLR
                                                                                                                                                            job.'
                                                                                                                                                            },
                                                                                                                                                            yanhua_tokens:
                                                                                                                                                            {
                                                                                                                                                            name:
                                                                                                                                                            'Yanhua
                                                                                                                                                            ACDP
                                                                                                                                                            Tokens',
                                                                                                                                                            vendor:
                                                                                                                                                            'Yanhua',
                                                                                                                                                            cost:
                                                                                                                                                            0,
                                                                                                                                                            billingCycle:
                                                                                                                                                            'per_use',
                                                                                                                                                            category:
                                                                                                                                                            'tokens',
                                                                                                                                                            notes:
                                                                                                                                                            'Module-specific
                                                                                                                                                            lifetime
                                                                                                                                                            licenses.',
                                                                                                                                                            benefit:
                                                                                                                                                            'Buy
                                                                                                                                                            individual
                                                                                                                                                            module
                                                                                                                                                            licenses
                                                                                                                                                            as
                                                                                                                                                            you
                                                                                                                                                            need
                                                                                                                                                            them.
                                                                                                                                                            BMW
                                                                                                                                                            CAS3/CAS4,
                                                                                                                                                            Mercedes
                                                                                                                                                            EIS,
                                                                                                                                                            JLR
                                                                                                                                                            KVM.
                                                                                                                                                            Only
                                                                                                                                                            pay
                                                                                                                                                            for
                                                                                                                                                            what
                                                                                                                                                            your
                                                                                                                                                            market
                                                                                                                                                            demands.'
                                                                                                                                                            },

                                                                                                                                                            //
                                                                                                                                                            Licenses
                                                                                                                                                            &
                                                                                                                                                            Certifications
                                                                                                                                                            locksmith_license:
                                                                                                                                                            {
                                                                                                                                                            name:
                                                                                                                                                            'Locksmith
                                                                                                                                                            License
                                                                                                                                                            (State)',
                                                                                                                                                            vendor:
                                                                                                                                                            'State
                                                                                                                                                            Government',
                                                                                                                                                            cost:
                                                                                                                                                            0,
                                                                                                                                                            billingCycle:
                                                                                                                                                            'annual',
                                                                                                                                                            category:
                                                                                                                                                            'license',
                                                                                                                                                            notes:
                                                                                                                                                            'Varies
                                                                                                                                                            by
                                                                                                                                                            state.
                                                                                                                                                            Required
                                                                                                                                                            in
                                                                                                                                                            TX,
                                                                                                                                                            CA,
                                                                                                                                                            NC,
                                                                                                                                                            etc.',
                                                                                                                                                            benefit:
                                                                                                                                                            'Legal
                                                                                                                                                            requirement
                                                                                                                                                            in
                                                                                                                                                            15
                                                                                                                                                            states.
                                                                                                                                                            Shows
                                                                                                                                                            customers
                                                                                                                                                            you
                                                                                                                                                            are
                                                                                                                                                            legitimate.
                                                                                                                                                            Required
                                                                                                                                                            for
                                                                                                                                                            business
                                                                                                                                                            insurance
                                                                                                                                                            and
                                                                                                                                                            NASTF
                                                                                                                                                            registration.'
                                                                                                                                                            },
                                                                                                                                                            contractor_bond:
                                                                                                                                                            {
                                                                                                                                                            name:
                                                                                                                                                            'Contractor
                                                                                                                                                            Bond',
                                                                                                                                                            vendor:
                                                                                                                                                            'Insurance
                                                                                                                                                            Provider',
                                                                                                                                                            cost:
                                                                                                                                                            0,
                                                                                                                                                            billingCycle:
                                                                                                                                                            'annual',
                                                                                                                                                            category:
                                                                                                                                                            'license',
                                                                                                                                                            notes:
                                                                                                                                                            'Required
                                                                                                                                                            in
                                                                                                                                                            some
                                                                                                                                                            states
                                                                                                                                                            for
                                                                                                                                                            licensing.',
                                                                                                                                                            benefit:
                                                                                                                                                            'Protects
                                                                                                                                                            customers
                                                                                                                                                            if
                                                                                                                                                            you
                                                                                                                                                            fail
                                                                                                                                                            to
                                                                                                                                                            complete
                                                                                                                                                            work.
                                                                                                                                                            Required
                                                                                                                                                            for
                                                                                                                                                            CA,
                                                                                                                                                            TX,
                                                                                                                                                            NV
                                                                                                                                                            licenses.
                                                                                                                                                            Typically
                                                                                                                                                            $500-1000
                                                                                                                                                            for
                                                                                                                                                            $10,000-25,000
                                                                                                                                                            bond.'
                                                                                                                                                            },
                                                                                                                                                            aloa_cert:
                                                                                                                                                            {
                                                                                                                                                            name:
                                                                                                                                                            'ALOA
                                                                                                                                                            Certification',
                                                                                                                                                            vendor:
                                                                                                                                                            'ALOA',
                                                                                                                                                            cost:
                                                                                                                                                            250,
                                                                                                                                                            billingCycle:
                                                                                                                                                            'annual',
                                                                                                                                                            category:
                                                                                                                                                            'license',
                                                                                                                                                            notes:
                                                                                                                                                            'Associated
                                                                                                                                                            Locksmiths
                                                                                                                                                            of
                                                                                                                                                            America
                                                                                                                                                            membership.',
                                                                                                                                                            benefit:
                                                                                                                                                            'Professional
                                                                                                                                                            credibility
                                                                                                                                                            and
                                                                                                                                                            networking.
                                                                                                                                                            Access
                                                                                                                                                            to
                                                                                                                                                            ALOA
                                                                                                                                                            training
                                                                                                                                                            and
                                                                                                                                                            certification
                                                                                                                                                            programs.
                                                                                                                                                            Discounts
                                                                                                                                                            on
                                                                                                                                                            insurance
                                                                                                                                                            and
                                                                                                                                                            tools.'
                                                                                                                                                            },
                                                                                                                                                            cml_cert:
                                                                                                                                                            {
                                                                                                                                                            name:
                                                                                                                                                            'CML
                                                                                                                                                            Certification',
                                                                                                                                                            vendor:
                                                                                                                                                            'ALOA',
                                                                                                                                                            cost:
                                                                                                                                                            195,
                                                                                                                                                            billingCycle:
                                                                                                                                                            'annual',
                                                                                                                                                            category:
                                                                                                                                                            'license',
                                                                                                                                                            notes:
                                                                                                                                                            'Certified
                                                                                                                                                            Master
                                                                                                                                                            Locksmith
                                                                                                                                                            designation.',
                                                                                                                                                            benefit:
                                                                                                                                                            'Highest
                                                                                                                                                            ALOA
                                                                                                                                                            certification.
                                                                                                                                                            Demonstrates
                                                                                                                                                            mastery
                                                                                                                                                            to
                                                                                                                                                            customers.
                                                                                                                                                            Command
                                                                                                                                                            premium
                                                                                                                                                            pricing.
                                                                                                                                                            Required
                                                                                                                                                            for
                                                                                                                                                            some
                                                                                                                                                            commercial
                                                                                                                                                            contracts.'
                                                                                                                                                            },
                                                                                                                                                            savta_cert:
                                                                                                                                                            {
                                                                                                                                                            name:
                                                                                                                                                            'SAVTA
                                                                                                                                                            Certification',
                                                                                                                                                            vendor:
                                                                                                                                                            'SAVTA',
                                                                                                                                                            cost:
                                                                                                                                                            150,
                                                                                                                                                            billingCycle:
                                                                                                                                                            'annual',
                                                                                                                                                            category:
                                                                                                                                                            'license',
                                                                                                                                                            notes:
                                                                                                                                                            'Safe
                                                                                                                                                            &
                                                                                                                                                            Vault
                                                                                                                                                            Technicians
                                                                                                                                                            Association.',
                                                                                                                                                            benefit:
                                                                                                                                                            'Essential
                                                                                                                                                            if
                                                                                                                                                            you
                                                                                                                                                            service
                                                                                                                                                            safes.
                                                                                                                                                            Training
                                                                                                                                                            and
                                                                                                                                                            certification
                                                                                                                                                            in
                                                                                                                                                            safe
                                                                                                                                                            opening.
                                                                                                                                                            Access
                                                                                                                                                            to
                                                                                                                                                            safe
                                                                                                                                                            manufacturer
                                                                                                                                                            technical
                                                                                                                                                            support.'
                                                                                                                                                            },

                                                                                                                                                            //
                                                                                                                                                            Insurance
                                                                                                                                                            liability_insurance:
                                                                                                                                                            {
                                                                                                                                                            name:
                                                                                                                                                            'General
                                                                                                                                                            Liability
                                                                                                                                                            Insurance',
                                                                                                                                                            vendor:
                                                                                                                                                            'Insurance
                                                                                                                                                            Provider',
                                                                                                                                                            cost:
                                                                                                                                                            0,
                                                                                                                                                            billingCycle:
                                                                                                                                                            'annual',
                                                                                                                                                            category:
                                                                                                                                                            'insurance',
                                                                                                                                                            notes:
                                                                                                                                                            'Typically
                                                                                                                                                            $500-2000/yr.
                                                                                                                                                            Protects
                                                                                                                                                            against
                                                                                                                                                            claims.',
                                                                                                                                                            benefit:
                                                                                                                                                            'Protects
                                                                                                                                                            if
                                                                                                                                                            you
                                                                                                                                                            damage
                                                                                                                                                            customer
                                                                                                                                                            property.
                                                                                                                                                            Required
                                                                                                                                                            by
                                                                                                                                                            many
                                                                                                                                                            commercial
                                                                                                                                                            clients.
                                                                                                                                                            Peace
                                                                                                                                                            of
                                                                                                                                                            mind
                                                                                                                                                            on
                                                                                                                                                            every
                                                                                                                                                            $50,000
                                                                                                                                                            Mercedes
                                                                                                                                                            job.'
                                                                                                                                                            },
                                                                                                                                                            eo_insurance:
                                                                                                                                                            {
                                                                                                                                                            name:
                                                                                                                                                            'E&O
                                                                                                                                                            Insurance',
                                                                                                                                                            vendor:
                                                                                                                                                            'Insurance
                                                                                                                                                            Provider',
                                                                                                                                                            cost:
                                                                                                                                                            0,
                                                                                                                                                            billingCycle:
                                                                                                                                                            'annual',
                                                                                                                                                            category:
                                                                                                                                                            'insurance',
                                                                                                                                                            notes:
                                                                                                                                                            'Errors
                                                                                                                                                            &
                                                                                                                                                            Omissions
                                                                                                                                                            coverage
                                                                                                                                                            for
                                                                                                                                                            professionals.',
                                                                                                                                                            benefit:
                                                                                                                                                            'Covers
                                                                                                                                                            professional
                                                                                                                                                            mistakes.
                                                                                                                                                            Program
                                                                                                                                                            wrong
                                                                                                                                                            key?
                                                                                                                                                            Customer
                                                                                                                                                            claims
                                                                                                                                                            you
                                                                                                                                                            "messed
                                                                                                                                                            up
                                                                                                                                                            their
                                                                                                                                                            car"?
                                                                                                                                                            E&O
                                                                                                                                                            has
                                                                                                                                                            your
                                                                                                                                                            back.'
                                                                                                                                                            },
                                                                                                                                                            auto_insurance:
                                                                                                                                                            {
                                                                                                                                                            name:
                                                                                                                                                            'Commercial
                                                                                                                                                            Auto
                                                                                                                                                            Insurance',
                                                                                                                                                            vendor:
                                                                                                                                                            'Insurance
                                                                                                                                                            Provider',
                                                                                                                                                            cost:
                                                                                                                                                            0,
                                                                                                                                                            billingCycle:
                                                                                                                                                            'annual',
                                                                                                                                                            category:
                                                                                                                                                            'insurance',
                                                                                                                                                            notes:
                                                                                                                                                            'Coverage
                                                                                                                                                            for
                                                                                                                                                            service
                                                                                                                                                            vehicles.',
                                                                                                                                                            benefit:
                                                                                                                                                            'Personal
                                                                                                                                                            auto
                                                                                                                                                            policy
                                                                                                                                                            WON\'T
                                                                                                                                                            cover
                                                                                                                                                            accidents
                                                                                                                                                            during
                                                                                                                                                            business
                                                                                                                                                            use.
                                                                                                                                                            Commercial
                                                                                                                                                            policy
                                                                                                                                                            protects
                                                                                                                                                            your
                                                                                                                                                            van
                                                                                                                                                            and
                                                                                                                                                            all
                                                                                                                                                            your
                                                                                                                                                            tools
                                                                                                                                                            inside.'
                                                                                                                                                            },
                                                                                                                                                            workers_comp:
                                                                                                                                                            {
                                                                                                                                                            name:
                                                                                                                                                            'Workers
                                                                                                                                                            Compensation',
                                                                                                                                                            vendor:
                                                                                                                                                            'Insurance
                                                                                                                                                            Provider',
                                                                                                                                                            cost:
                                                                                                                                                            0,
                                                                                                                                                            billingCycle:
                                                                                                                                                            'annual',
                                                                                                                                                            category:
                                                                                                                                                            'insurance',
                                                                                                                                                            notes:
                                                                                                                                                            'Required
                                                                                                                                                            if
                                                                                                                                                            you
                                                                                                                                                            have
                                                                                                                                                            employees.',
                                                                                                                                                            benefit:
                                                                                                                                                            'Legally
                                                                                                                                                            required
                                                                                                                                                            in
                                                                                                                                                            most
                                                                                                                                                            states
                                                                                                                                                            if
                                                                                                                                                            you
                                                                                                                                                            have
                                                                                                                                                            employees.
                                                                                                                                                            Covers
                                                                                                                                                            employee
                                                                                                                                                            injuries
                                                                                                                                                            on
                                                                                                                                                            the
                                                                                                                                                            job.
                                                                                                                                                            Protects
                                                                                                                                                            you
                                                                                                                                                            from
                                                                                                                                                            lawsuits.'
                                                                                                                                                            },

                                                                                                                                                            //
                                                                                                                                                            Custom
                                                                                                                                                            placeholder
                                                                                                                                                            custom:
                                                                                                                                                            {
                                                                                                                                                            name:
                                                                                                                                                            '',
                                                                                                                                                            vendor:
                                                                                                                                                            '',
                                                                                                                                                            cost:
                                                                                                                                                            0,
                                                                                                                                                            billingCycle:
                                                                                                                                                            'annual',
                                                                                                                                                            category:
                                                                                                                                                            'other',
                                                                                                                                                            notes:
                                                                                                                                                            '',
                                                                                                                                                            benefit:
                                                                                                                                                            ''
                                                                                                                                                            }
                                                                                                                                                            };

                                                                                                                                                            //
                                                                                                                                                            SubscriptionManager
                                                                                                                                                            Class
                                                                                                                                                            const
                                                                                                                                                            SubscriptionManager
                                                                                                                                                            =
                                                                                                                                                            {
                                                                                                                                                            STORAGE_KEY:
                                                                                                                                                            'eurokeys_subscriptions',

                                                                                                                                                            getAll()
                                                                                                                                                            {
                                                                                                                                                            try
                                                                                                                                                            {
                                                                                                                                                            const
                                                                                                                                                            data
                                                                                                                                                            =
                                                                                                                                                            localStorage.getItem(this.STORAGE_KEY);
                                                                                                                                                            return
                                                                                                                                                            data
                                                                                                                                                            ?
                                                                                                                                                            JSON.parse(data)
                                                                                                                                                            :
                                                                                                                                                            [];
                                                                                                                                                            }
                                                                                                                                                            catch
                                                                                                                                                            (e)
                                                                                                                                                            {
                                                                                                                                                            console.error('Error
                                                                                                                                                            loading
                                                                                                                                                            subscriptions:',
                                                                                                                                                            e);
                                                                                                                                                            return
                                                                                                                                                            [];
                                                                                                                                                            }
                                                                                                                                                            },

                                                                                                                                                            save(subscriptions)
                                                                                                                                                            {
                                                                                                                                                            localStorage.setItem(this.STORAGE_KEY,
                                                                                                                                                            JSON.stringify(subscriptions));
                                                                                                                                                            },

                                                                                                                                                            //
                                                                                                                                                            Cloud
                                                                                                                                                            Sync
                                                                                                                                                            Methods
                                                                                                                                                            async
                                                                                                                                                            syncToCloud(subscription)
                                                                                                                                                            {
                                                                                                                                                            if
                                                                                                                                                            (!currentUser)
                                                                                                                                                            return;
                                                                                                                                                            try
                                                                                                                                                            {
                                                                                                                                                            await
                                                                                                                                                            fetch(`${API}/api/user/tool-subscriptions`,
                                                                                                                                                            {
                                                                                                                                                            method:
                                                                                                                                                            'POST',
                                                                                                                                                            headers:
                                                                                                                                                            {
                                                                                                                                                            ...getAuthHeaders(),
                                                                                                                                                            'Content-Type':
                                                                                                                                                            'application/json'
                                                                                                                                                            },
                                                                                                                                                            body:
                                                                                                                                                            JSON.stringify({
                                                                                                                                                            subscription
                                                                                                                                                            })
                                                                                                                                                            });
                                                                                                                                                            }
                                                                                                                                                            catch
                                                                                                                                                            (e)
                                                                                                                                                            {
                                                                                                                                                            console.error('â˜ï¸
                                                                                                                                                            Subscription
                                                                                                                                                            sync
                                                                                                                                                            failed:',
                                                                                                                                                            e);
                                                                                                                                                            }
                                                                                                                                                            },

                                                                                                                                                            async
                                                                                                                                                            deleteFromCloud(id)
                                                                                                                                                            {
                                                                                                                                                            if
                                                                                                                                                            (!currentUser)
                                                                                                                                                            return;
                                                                                                                                                            try
                                                                                                                                                            {
                                                                                                                                                            await
                                                                                                                                                            fetch(`${API}/api/user/tool-subscriptions`,
                                                                                                                                                            {
                                                                                                                                                            method:
                                                                                                                                                            'DELETE',
                                                                                                                                                            headers:
                                                                                                                                                            {
                                                                                                                                                            ...getAuthHeaders(),
                                                                                                                                                            'Content-Type':
                                                                                                                                                            'application/json'
                                                                                                                                                            },
                                                                                                                                                            body:
                                                                                                                                                            JSON.stringify({
                                                                                                                                                            id
                                                                                                                                                            })
                                                                                                                                                            });
                                                                                                                                                            }
                                                                                                                                                            catch
                                                                                                                                                            (e)
                                                                                                                                                            {
                                                                                                                                                            console.error('ðŸ—‘ï¸
                                                                                                                                                            Subscription
                                                                                                                                                            delete
                                                                                                                                                            failed:',
                                                                                                                                                            e);
                                                                                                                                                            }
                                                                                                                                                            },

                                                                                                                                                            async
                                                                                                                                                            loadFromCloud()
                                                                                                                                                            {
                                                                                                                                                            if
                                                                                                                                                            (!currentUser)
                                                                                                                                                            return;
                                                                                                                                                            try
                                                                                                                                                            {
                                                                                                                                                            const
                                                                                                                                                            response
                                                                                                                                                            =
                                                                                                                                                            await
                                                                                                                                                            fetch(`${API}/api/user/tool-subscriptions`,
                                                                                                                                                            {
                                                                                                                                                            headers:
                                                                                                                                                            getAuthHeaders()
                                                                                                                                                            });
                                                                                                                                                            if
                                                                                                                                                            (!response.ok)
                                                                                                                                                            return;

                                                                                                                                                            const
                                                                                                                                                            data
                                                                                                                                                            =
                                                                                                                                                            await
                                                                                                                                                            response.json();
                                                                                                                                                            if
                                                                                                                                                            (data.subscriptions
                                                                                                                                                            &&
                                                                                                                                                            Array.isArray(data.subscriptions))
                                                                                                                                                            {
                                                                                                                                                            const
                                                                                                                                                            cloudSubs
                                                                                                                                                            =
                                                                                                                                                            data.subscriptions;
                                                                                                                                                            const
                                                                                                                                                            localSubs
                                                                                                                                                            =
                                                                                                                                                            this.getAll();

                                                                                                                                                            //
                                                                                                                                                            Merge
                                                                                                                                                            strategies:
                                                                                                                                                            //
                                                                                                                                                            1.
                                                                                                                                                            If
                                                                                                                                                            cloud
                                                                                                                                                            has
                                                                                                                                                            subs
                                                                                                                                                            and
                                                                                                                                                            local
                                                                                                                                                            is
                                                                                                                                                            empty
                                                                                                                                                            ->
                                                                                                                                                            use
                                                                                                                                                            cloud
                                                                                                                                                            //
                                                                                                                                                            2.
                                                                                                                                                            If
                                                                                                                                                            both
                                                                                                                                                            exist
                                                                                                                                                            ->
                                                                                                                                                            merge
                                                                                                                                                            by
                                                                                                                                                            ID
                                                                                                                                                            (cloud
                                                                                                                                                            wins
                                                                                                                                                            conflicts)

                                                                                                                                                            const
                                                                                                                                                            mergedMap
                                                                                                                                                            =
                                                                                                                                                            new
                                                                                                                                                            Map();
                                                                                                                                                            localSubs.forEach(s
                                                                                                                                                            =>
                                                                                                                                                            mergedMap.set(s.id,
                                                                                                                                                            s));
                                                                                                                                                            cloudSubs.forEach(s
                                                                                                                                                            =>
                                                                                                                                                            mergedMap.set(s.id,
                                                                                                                                                            s));

                                                                                                                                                            const
                                                                                                                                                            merged
                                                                                                                                                            =
                                                                                                                                                            Array.from(mergedMap.values());
                                                                                                                                                            //
                                                                                                                                                            Sort
                                                                                                                                                            by
                                                                                                                                                            created
                                                                                                                                                            date
                                                                                                                                                            merged.sort((a,
                                                                                                                                                            b)
                                                                                                                                                            =>
                                                                                                                                                            new
                                                                                                                                                            Date(b.createdAt)
                                                                                                                                                            -
                                                                                                                                                            new
                                                                                                                                                            Date(a.createdAt));

                                                                                                                                                            this.save(merged);
                                                                                                                                                            console.log('ðŸ“…
                                                                                                                                                            Subscriptions
                                                                                                                                                            loaded
                                                                                                                                                            from
                                                                                                                                                            cloud:',
                                                                                                                                                            merged.length);
                                                                                                                                                            return
                                                                                                                                                            true;
                                                                                                                                                            }
                                                                                                                                                            }
                                                                                                                                                            catch
                                                                                                                                                            (e)
                                                                                                                                                            {
                                                                                                                                                            console.error('ðŸ“…
                                                                                                                                                            Subscriptions
                                                                                                                                                            load
                                                                                                                                                            failed:',
                                                                                                                                                            e);
                                                                                                                                                            }
                                                                                                                                                            },

                                                                                                                                                            add(subscription)
                                                                                                                                                            {
                                                                                                                                                            const
                                                                                                                                                            subs
                                                                                                                                                            =
                                                                                                                                                            this.getAll();
                                                                                                                                                            subscription.id
                                                                                                                                                            =
                                                                                                                                                            'sub_'
                                                                                                                                                            +
                                                                                                                                                            Date.now()
                                                                                                                                                            +
                                                                                                                                                            '_'
                                                                                                                                                            +
                                                                                                                                                            Math.random().toString(36).substr(2,
                                                                                                                                                            9);
                                                                                                                                                            subscription.createdAt
                                                                                                                                                            =
                                                                                                                                                            new
                                                                                                                                                            Date().toISOString();
                                                                                                                                                            subs.push(subscription);
                                                                                                                                                            this.save(subs);
                                                                                                                                                            //
                                                                                                                                                            Sync
                                                                                                                                                            new
                                                                                                                                                            sub
                                                                                                                                                            to
                                                                                                                                                            cloud
                                                                                                                                                            this.syncToCloud(subscription);
                                                                                                                                                            return
                                                                                                                                                            subscription;
                                                                                                                                                            },

                                                                                                                                                            update(id,
                                                                                                                                                            updates)
                                                                                                                                                            {
                                                                                                                                                            const
                                                                                                                                                            subs
                                                                                                                                                            =
                                                                                                                                                            this.getAll();
                                                                                                                                                            const
                                                                                                                                                            index
                                                                                                                                                            =
                                                                                                                                                            subs.findIndex(s
                                                                                                                                                            =>
                                                                                                                                                            s.id
                                                                                                                                                            ===
                                                                                                                                                            id);
                                                                                                                                                            if
                                                                                                                                                            (index
                                                                                                                                                            !==
                                                                                                                                                            -1)
                                                                                                                                                            {
                                                                                                                                                            subs[index]
                                                                                                                                                            =
                                                                                                                                                            {
                                                                                                                                                            ...subs[index],
                                                                                                                                                            ...updates,
                                                                                                                                                            updatedAt:
                                                                                                                                                            new
                                                                                                                                                            Date().toISOString()
                                                                                                                                                            };
                                                                                                                                                            this.save(subs);
                                                                                                                                                            //
                                                                                                                                                            Sync
                                                                                                                                                            update
                                                                                                                                                            to
                                                                                                                                                            cloud
                                                                                                                                                            this.syncToCloud(subs[index]);
                                                                                                                                                            return
                                                                                                                                                            subs[index];
                                                                                                                                                            }
                                                                                                                                                            return
                                                                                                                                                            null;
                                                                                                                                                            },

                                                                                                                                                            delete(id)
                                                                                                                                                            {
                                                                                                                                                            const
                                                                                                                                                            subs
                                                                                                                                                            =
                                                                                                                                                            this.getAll();
                                                                                                                                                            const
                                                                                                                                                            filtered
                                                                                                                                                            =
                                                                                                                                                            subs.filter(s
                                                                                                                                                            =>
                                                                                                                                                            s.id
                                                                                                                                                            !==
                                                                                                                                                            id);
                                                                                                                                                            this.save(filtered);
                                                                                                                                                            //
                                                                                                                                                            Delete
                                                                                                                                                            from
                                                                                                                                                            cloud
                                                                                                                                                            this.deleteFromCloud(id);
                                                                                                                                                            },

                                                                                                                                                            getDaysRemaining(expirationDate)
                                                                                                                                                            {
                                                                                                                                                            if
                                                                                                                                                            (!expirationDate)
                                                                                                                                                            return
                                                                                                                                                            Infinity;
                                                                                                                                                            const
                                                                                                                                                            exp
                                                                                                                                                            =
                                                                                                                                                            new
                                                                                                                                                            Date(expirationDate);
                                                                                                                                                            const
                                                                                                                                                            now
                                                                                                                                                            =
                                                                                                                                                            new
                                                                                                                                                            Date();
                                                                                                                                                            const
                                                                                                                                                            diff
                                                                                                                                                            =
                                                                                                                                                            exp
                                                                                                                                                            -
                                                                                                                                                            now;
                                                                                                                                                            return
                                                                                                                                                            Math.ceil(diff
                                                                                                                                                            /
                                                                                                                                                            (1000
                                                                                                                                                            *
                                                                                                                                                            60
                                                                                                                                                            *
                                                                                                                                                            60
                                                                                                                                                            *
                                                                                                                                                            24));
                                                                                                                                                            },

                                                                                                                                                            getStatus(subscription)
                                                                                                                                                            {
                                                                                                                                                            if
                                                                                                                                                            (subscription.billingCycle
                                                                                                                                                            ===
                                                                                                                                                            'lifetime')
                                                                                                                                                            return
                                                                                                                                                            'lifetime';
                                                                                                                                                            if
                                                                                                                                                            (subscription.billingCycle
                                                                                                                                                            ===
                                                                                                                                                            'per_use')
                                                                                                                                                            return
                                                                                                                                                            'active';

                                                                                                                                                            const
                                                                                                                                                            days
                                                                                                                                                            =
                                                                                                                                                            this.getDaysRemaining(subscription.expirationDate);
                                                                                                                                                            if
                                                                                                                                                            (days
                                                                                                                                                            < 0) return 'expired'
                                                                                                                                                                ;
                                                                                                                                                                if
                                                                                                                                                                (days
                                                                                                                                                                <=7)
                                                                                                                                                                return 'critical'
                                                                                                                                                                ;
                                                                                                                                                                if
                                                                                                                                                                (days
                                                                                                                                                                <=30)
                                                                                                                                                                return 'warning'
                                                                                                                                                                ;
                                                                                                                                                                return 'active'
                                                                                                                                                                ;
                                                                                                                                                                },
                                                                                                                                                                getStats()
                                                                                                                                                                {
                                                                                                                                                                const
                                                                                                                                                                subs=this.getAll();
                                                                                                                                                                return
                                                                                                                                                                {
                                                                                                                                                                active:
                                                                                                                                                                subs.filter(s=>
                                                                                                                                                                this.getStatus(s)
                                                                                                                                                                ===
                                                                                                                                                                'active').length,
                                                                                                                                                                warning:
                                                                                                                                                                subs.filter(s
                                                                                                                                                                =>
                                                                                                                                                                ['warning',
                                                                                                                                                                'critical'].includes(this.getStatus(s))).length,
                                                                                                                                                                expired:
                                                                                                                                                                subs.filter(s
                                                                                                                                                                =>
                                                                                                                                                                this.getStatus(s)
                                                                                                                                                                ===
                                                                                                                                                                'expired').length,
                                                                                                                                                                lifetime:
                                                                                                                                                                subs.filter(s
                                                                                                                                                                =>
                                                                                                                                                                this.getStatus(s)
                                                                                                                                                                ===
                                                                                                                                                                'lifetime').length
                                                                                                                                                                };
                                                                                                                                                                },

                                                                                                                                                                getExpiringSoon(days
                                                                                                                                                                =
                                                                                                                                                                30)
                                                                                                                                                                {
                                                                                                                                                                return
                                                                                                                                                                this.getAll().filter(s
                                                                                                                                                                =>
                                                                                                                                                                {
                                                                                                                                                                const
                                                                                                                                                                remaining
                                                                                                                                                                =
                                                                                                                                                                this.getDaysRemaining(s.expirationDate);
                                                                                                                                                                return
                                                                                                                                                                remaining
                                                                                                                                                                >=
                                                                                                                                                                0
                                                                                                                                                                &&
                                                                                                                                                                remaining
                                                                                                                                                                <= days
                                                                                                                                                                    &&
                                                                                                                                                                    s.billingCycle
                                                                                                                                                                    !=='lifetime'
                                                                                                                                                                    ;
                                                                                                                                                                    }).sort((a,
                                                                                                                                                                    b)=>
                                                                                                                                                                    this.getDaysRemaining(a.expirationDate)
                                                                                                                                                                    -
                                                                                                                                                                    this.getDaysRemaining(b.expirationDate));
                                                                                                                                                                    }
                                                                                                                                                                    };

                                                                                                                                                                    //
                                                                                                                                                                    Current
                                                                                                                                                                    editing
                                                                                                                                                                    subscription
                                                                                                                                                                    ID
                                                                                                                                                                    let
                                                                                                                                                                    editingSubscriptionId
                                                                                                                                                                    =
                                                                                                                                                                    null;
                                                                                                                                                                    let
                                                                                                                                                                    currentSubFilter
                                                                                                                                                                    =
                                                                                                                                                                    'all';

                                                                                                                                                                    //
                                                                                                                                                                    Open
                                                                                                                                                                    Add
                                                                                                                                                                    Subscription
                                                                                                                                                                    Modal
                                                                                                                                                                    function
                                                                                                                                                                    openAddSubscriptionModal()
                                                                                                                                                                    {
                                                                                                                                                                    editingSubscriptionId
                                                                                                                                                                    =
                                                                                                                                                                    null;
                                                                                                                                                                    document.getElementById('subModalTitle').textContent
                                                                                                                                                                    =
                                                                                                                                                                    'Add
                                                                                                                                                                    Subscription';
                                                                                                                                                                    document.getElementById('subCatalogSelect').value
                                                                                                                                                                    =
                                                                                                                                                                    '';
                                                                                                                                                                    document.getElementById('subName').value
                                                                                                                                                                    =
                                                                                                                                                                    '';
                                                                                                                                                                    document.getElementById('subVendor').value
                                                                                                                                                                    =
                                                                                                                                                                    '';
                                                                                                                                                                    document.getElementById('subCost').value
                                                                                                                                                                    =
                                                                                                                                                                    '';
                                                                                                                                                                    document.getElementById('subBillingCycle').value
                                                                                                                                                                    =
                                                                                                                                                                    'annual';
                                                                                                                                                                    document.getElementById('subPurchaseDate').value
                                                                                                                                                                    =
                                                                                                                                                                    '';
                                                                                                                                                                    document.getElementById('subExpirationDate').value
                                                                                                                                                                    =
                                                                                                                                                                    '';
                                                                                                                                                                    document.getElementById('subCategory').value
                                                                                                                                                                    =
                                                                                                                                                                    'key_programmer';
                                                                                                                                                                    document.getElementById('subNotes').value
                                                                                                                                                                    =
                                                                                                                                                                    '';
                                                                                                                                                                    document.getElementById('subRenewalUrl').value
                                                                                                                                                                    =
                                                                                                                                                                    '';
                                                                                                                                                                    document.getElementById('subModalOverlay').style.display
                                                                                                                                                                    =
                                                                                                                                                                    'flex';
                                                                                                                                                                    }

                                                                                                                                                                    //
                                                                                                                                                                    Populate
                                                                                                                                                                    form
                                                                                                                                                                    from
                                                                                                                                                                    catalog
                                                                                                                                                                    selection
                                                                                                                                                                    function
                                                                                                                                                                    populateFromCatalog()
                                                                                                                                                                    {
                                                                                                                                                                    const
                                                                                                                                                                    select
                                                                                                                                                                    =
                                                                                                                                                                    document.getElementById('subCatalogSelect');
                                                                                                                                                                    const
                                                                                                                                                                    key
                                                                                                                                                                    =
                                                                                                                                                                    select.value;
                                                                                                                                                                    if
                                                                                                                                                                    (key
                                                                                                                                                                    &&
                                                                                                                                                                    SUBSCRIPTION_CATALOG[key])
                                                                                                                                                                    {
                                                                                                                                                                    const
                                                                                                                                                                    item
                                                                                                                                                                    =
                                                                                                                                                                    SUBSCRIPTION_CATALOG[key];
                                                                                                                                                                    document.getElementById('subName').value
                                                                                                                                                                    =
                                                                                                                                                                    item.name;
                                                                                                                                                                    document.getElementById('subVendor').value
                                                                                                                                                                    =
                                                                                                                                                                    item.vendor;
                                                                                                                                                                    document.getElementById('subCost').value
                                                                                                                                                                    =
                                                                                                                                                                    item.cost
                                                                                                                                                                    ||
                                                                                                                                                                    '';
                                                                                                                                                                    document.getElementById('subBillingCycle').value
                                                                                                                                                                    =
                                                                                                                                                                    item.billingCycle;
                                                                                                                                                                    document.getElementById('subCategory').value
                                                                                                                                                                    =
                                                                                                                                                                    item.category;
                                                                                                                                                                    document.getElementById('subNotes').value
                                                                                                                                                                    =
                                                                                                                                                                    item.notes
                                                                                                                                                                    ||
                                                                                                                                                                    '';
                                                                                                                                                                    //
                                                                                                                                                                    Store
                                                                                                                                                                    benefit
                                                                                                                                                                    for
                                                                                                                                                                    saving
                                                                                                                                                                    later
                                                                                                                                                                    document.getElementById('subModalOverlay').dataset.catalogBenefit
                                                                                                                                                                    =
                                                                                                                                                                    item.benefit
                                                                                                                                                                    ||
                                                                                                                                                                    '';

                                                                                                                                                                    //
                                                                                                                                                                    Auto-fill
                                                                                                                                                                    expiration
                                                                                                                                                                    if
                                                                                                                                                                    purchase
                                                                                                                                                                    date
                                                                                                                                                                    is
                                                                                                                                                                    already
                                                                                                                                                                    set
                                                                                                                                                                    autoFillExpirationDate();
                                                                                                                                                                    }
                                                                                                                                                                    }

                                                                                                                                                                    //
                                                                                                                                                                    Auto-fill
                                                                                                                                                                    expiration
                                                                                                                                                                    date
                                                                                                                                                                    based
                                                                                                                                                                    on
                                                                                                                                                                    purchase
                                                                                                                                                                    date
                                                                                                                                                                    and
                                                                                                                                                                    cycle
                                                                                                                                                                    function
                                                                                                                                                                    autoFillExpirationDate()
                                                                                                                                                                    {
                                                                                                                                                                    const
                                                                                                                                                                    purchaseDateVal
                                                                                                                                                                    =
                                                                                                                                                                    document.getElementById('subPurchaseDate').value;
                                                                                                                                                                    const
                                                                                                                                                                    billingCycle
                                                                                                                                                                    =
                                                                                                                                                                    document.getElementById('subBillingCycle').value;
                                                                                                                                                                    const
                                                                                                                                                                    expInput
                                                                                                                                                                    =
                                                                                                                                                                    document.getElementById('subExpirationDate');

                                                                                                                                                                    if
                                                                                                                                                                    (!purchaseDateVal)
                                                                                                                                                                    return;

                                                                                                                                                                    const
                                                                                                                                                                    purchaseDate
                                                                                                                                                                    =
                                                                                                                                                                    new
                                                                                                                                                                    Date(purchaseDateVal
                                                                                                                                                                    +
                                                                                                                                                                    'T12:00:00');
                                                                                                                                                                    //
                                                                                                                                                                    Midday
                                                                                                                                                                    to
                                                                                                                                                                    avoid
                                                                                                                                                                    timezone
                                                                                                                                                                    flips
                                                                                                                                                                    let
                                                                                                                                                                    expirationDate
                                                                                                                                                                    =
                                                                                                                                                                    new
                                                                                                                                                                    Date(purchaseDate);

                                                                                                                                                                    if
                                                                                                                                                                    (billingCycle
                                                                                                                                                                    ===
                                                                                                                                                                    'annual')
                                                                                                                                                                    {
                                                                                                                                                                    expirationDate.setFullYear(expirationDate.getFullYear()
                                                                                                                                                                    +
                                                                                                                                                                    1);
                                                                                                                                                                    }
                                                                                                                                                                    else
                                                                                                                                                                    if
                                                                                                                                                                    (billingCycle
                                                                                                                                                                    ===
                                                                                                                                                                    'monthly')
                                                                                                                                                                    {
                                                                                                                                                                    expirationDate.setMonth(expirationDate.getMonth()
                                                                                                                                                                    +
                                                                                                                                                                    1);
                                                                                                                                                                    }
                                                                                                                                                                    else
                                                                                                                                                                    {
                                                                                                                                                                    return;
                                                                                                                                                                    //
                                                                                                                                                                    Don't
                                                                                                                                                                    auto-fill
                                                                                                                                                                    for
                                                                                                                                                                    daily,
                                                                                                                                                                    per-use,
                                                                                                                                                                    lifetime,
                                                                                                                                                                    etc.
                                                                                                                                                                    }

                                                                                                                                                                    //
                                                                                                                                                                    Format
                                                                                                                                                                    to
                                                                                                                                                                    YYYY-MM-DD
                                                                                                                                                                    const
                                                                                                                                                                    yyyy
                                                                                                                                                                    =
                                                                                                                                                                    expirationDate.getFullYear();
                                                                                                                                                                    const
                                                                                                                                                                    mm
                                                                                                                                                                    =
                                                                                                                                                                    String(expirationDate.getMonth()
                                                                                                                                                                    +
                                                                                                                                                                    1).padStart(2,
                                                                                                                                                                    '0');
                                                                                                                                                                    const
                                                                                                                                                                    dd
                                                                                                                                                                    =
                                                                                                                                                                    String(expirationDate.getDate()).padStart(2,
                                                                                                                                                                    '0');
                                                                                                                                                                    expInput.value
                                                                                                                                                                    =
                                                                                                                                                                    `${yyyy}-${mm}-${dd}`;
                                                                                                                                                                    }

                                                                                                                                                                    //
                                                                                                                                                                    Attach
                                                                                                                                                                    listeners
                                                                                                                                                                    for
                                                                                                                                                                    auto-fill
                                                                                                                                                                    document.addEventListener('DOMContentLoaded',
                                                                                                                                                                    ()
                                                                                                                                                                    =>
                                                                                                                                                                    {
                                                                                                                                                                    const
                                                                                                                                                                    purchaseDateInput
                                                                                                                                                                    =
                                                                                                                                                                    document.getElementById('subPurchaseDate');
                                                                                                                                                                    const
                                                                                                                                                                    billingCycleSelect
                                                                                                                                                                    =
                                                                                                                                                                    document.getElementById('subBillingCycle');

                                                                                                                                                                    if
                                                                                                                                                                    (purchaseDateInput)
                                                                                                                                                                    {
                                                                                                                                                                    purchaseDateInput.addEventListener('change',
                                                                                                                                                                    autoFillExpirationDate);
                                                                                                                                                                    }
                                                                                                                                                                    if
                                                                                                                                                                    (billingCycleSelect)
                                                                                                                                                                    {
                                                                                                                                                                    billingCycleSelect.addEventListener('change',
                                                                                                                                                                    autoFillExpirationDate);
                                                                                                                                                                    }
                                                                                                                                                                    });

                                                                                                                                                                    //
                                                                                                                                                                    Close
                                                                                                                                                                    modal
                                                                                                                                                                    function
                                                                                                                                                                    closeSubscriptionModal(event)
                                                                                                                                                                    {
                                                                                                                                                                    if
                                                                                                                                                                    (event
                                                                                                                                                                    &&
                                                                                                                                                                    event.target
                                                                                                                                                                    !==
                                                                                                                                                                    event.currentTarget)
                                                                                                                                                                    return;
                                                                                                                                                                    document.getElementById('subModalOverlay').style.display
                                                                                                                                                                    =
                                                                                                                                                                    'none';
                                                                                                                                                                    }

                                                                                                                                                                    //
                                                                                                                                                                    Save
                                                                                                                                                                    subscription
                                                                                                                                                                    //
                                                                                                                                                                    Debounce
                                                                                                                                                                    timer
                                                                                                                                                                    for
                                                                                                                                                                    AI
                                                                                                                                                                    analysis
                                                                                                                                                                    let
                                                                                                                                                                    subscriptionAIAnalysisTimer
                                                                                                                                                                    =
                                                                                                                                                                    null;

                                                                                                                                                                    function
                                                                                                                                                                    saveSubscription()
                                                                                                                                                                    {
                                                                                                                                                                    const
                                                                                                                                                                    name
                                                                                                                                                                    =
                                                                                                                                                                    document.getElementById('subName').value.trim();
                                                                                                                                                                    const
                                                                                                                                                                    vendor
                                                                                                                                                                    =
                                                                                                                                                                    document.getElementById('subVendor').value.trim();
                                                                                                                                                                    const
                                                                                                                                                                    cost
                                                                                                                                                                    =
                                                                                                                                                                    parseFloat(document.getElementById('subCost').value)
                                                                                                                                                                    ||
                                                                                                                                                                    0;
                                                                                                                                                                    const
                                                                                                                                                                    billingCycle
                                                                                                                                                                    =
                                                                                                                                                                    document.getElementById('subBillingCycle').value;
                                                                                                                                                                    const
                                                                                                                                                                    purchaseDate
                                                                                                                                                                    =
                                                                                                                                                                    document.getElementById('subPurchaseDate').value;
                                                                                                                                                                    const
                                                                                                                                                                    expirationDate
                                                                                                                                                                    =
                                                                                                                                                                    document.getElementById('subExpirationDate').value;
                                                                                                                                                                    const
                                                                                                                                                                    category
                                                                                                                                                                    =
                                                                                                                                                                    document.getElementById('subCategory').value;
                                                                                                                                                                    const
                                                                                                                                                                    notes
                                                                                                                                                                    =
                                                                                                                                                                    document.getElementById('subNotes').value.trim();
                                                                                                                                                                    const
                                                                                                                                                                    renewalUrl
                                                                                                                                                                    =
                                                                                                                                                                    document.getElementById('subRenewalUrl').value.trim();

                                                                                                                                                                    //
                                                                                                                                                                    Get
                                                                                                                                                                    benefit
                                                                                                                                                                    from
                                                                                                                                                                    catalog
                                                                                                                                                                    selection
                                                                                                                                                                    if
                                                                                                                                                                    available
                                                                                                                                                                    const
                                                                                                                                                                    catalogBenefit
                                                                                                                                                                    =
                                                                                                                                                                    document.getElementById('subModalOverlay').dataset.catalogBenefit
                                                                                                                                                                    ||
                                                                                                                                                                    '';

                                                                                                                                                                    if
                                                                                                                                                                    (!name)
                                                                                                                                                                    {
                                                                                                                                                                    alert('Please
                                                                                                                                                                    enter
                                                                                                                                                                    a
                                                                                                                                                                    subscription
                                                                                                                                                                    name.');
                                                                                                                                                                    return;
                                                                                                                                                                    }

                                                                                                                                                                    const
                                                                                                                                                                    subscription
                                                                                                                                                                    =
                                                                                                                                                                    {
                                                                                                                                                                    name,
                                                                                                                                                                    vendor,
                                                                                                                                                                    cost,
                                                                                                                                                                    billingCycle,
                                                                                                                                                                    purchaseDate,
                                                                                                                                                                    expirationDate,
                                                                                                                                                                    category,
                                                                                                                                                                    notes,
                                                                                                                                                                    renewalUrl,
                                                                                                                                                                    benefit:
                                                                                                                                                                    catalogBenefit
                                                                                                                                                                    };

                                                                                                                                                                    const
                                                                                                                                                                    isNewSubscription
                                                                                                                                                                    =
                                                                                                                                                                    !editingSubscriptionId;

                                                                                                                                                                    if
                                                                                                                                                                    (editingSubscriptionId)
                                                                                                                                                                    {
                                                                                                                                                                    SubscriptionManager.update(editingSubscriptionId,
                                                                                                                                                                    subscription);
                                                                                                                                                                    }
                                                                                                                                                                    else
                                                                                                                                                                    {
                                                                                                                                                                    SubscriptionManager.add(subscription);
                                                                                                                                                                    }

                                                                                                                                                                    closeSubscriptionModal();
                                                                                                                                                                    renderSubscriptionsDashboard();

                                                                                                                                                                    //
                                                                                                                                                                    Clear
                                                                                                                                                                    the
                                                                                                                                                                    stored
                                                                                                                                                                    catalog
                                                                                                                                                                    benefit
                                                                                                                                                                    delete
                                                                                                                                                                    document.getElementById('subModalOverlay').dataset.catalogBenefit;

                                                                                                                                                                    //
                                                                                                                                                                    Trigger
                                                                                                                                                                    debounced
                                                                                                                                                                    AI
                                                                                                                                                                    analysis
                                                                                                                                                                    for
                                                                                                                                                                    new
                                                                                                                                                                    subscriptions
                                                                                                                                                                    (5-minute
                                                                                                                                                                    delay
                                                                                                                                                                    for
                                                                                                                                                                    bulk
                                                                                                                                                                    adds)
                                                                                                                                                                    if
                                                                                                                                                                    (isNewSubscription)
                                                                                                                                                                    {
                                                                                                                                                                    triggerDebouncedAIAnalysis();
                                                                                                                                                                    }
                                                                                                                                                                    }

                                                                                                                                                                    //
                                                                                                                                                                    Trigger
                                                                                                                                                                    AI
                                                                                                                                                                    analysis
                                                                                                                                                                    with
                                                                                                                                                                    5-minute
                                                                                                                                                                    debounce
                                                                                                                                                                    for
                                                                                                                                                                    bulk
                                                                                                                                                                    subscription
                                                                                                                                                                    adds
                                                                                                                                                                    function
                                                                                                                                                                    triggerDebouncedAIAnalysis()
                                                                                                                                                                    {
                                                                                                                                                                    //
                                                                                                                                                                    Clear
                                                                                                                                                                    any
                                                                                                                                                                    existing
                                                                                                                                                                    timer
                                                                                                                                                                    if
                                                                                                                                                                    (subscriptionAIAnalysisTimer)
                                                                                                                                                                    {
                                                                                                                                                                    clearTimeout(subscriptionAIAnalysisTimer);
                                                                                                                                                                    }

                                                                                                                                                                    //
                                                                                                                                                                    Set
                                                                                                                                                                    new
                                                                                                                                                                    timer
                                                                                                                                                                    for
                                                                                                                                                                    5
                                                                                                                                                                    minutes
                                                                                                                                                                    (300000ms)
                                                                                                                                                                    subscriptionAIAnalysisTimer
                                                                                                                                                                    =
                                                                                                                                                                    setTimeout(()
                                                                                                                                                                    =>
                                                                                                                                                                    {
                                                                                                                                                                    analyzeSubscriptionsWithAI();
                                                                                                                                                                    },
                                                                                                                                                                    300000);
                                                                                                                                                                    //
                                                                                                                                                                    5
                                                                                                                                                                    minutes

                                                                                                                                                                    console.log('ðŸ“Š
                                                                                                                                                                    AI
                                                                                                                                                                    analysis
                                                                                                                                                                    scheduled
                                                                                                                                                                    for
                                                                                                                                                                    5
                                                                                                                                                                    minutes
                                                                                                                                                                    from
                                                                                                                                                                    now');
                                                                                                                                                                    }

                                                                                                                                                                    //
                                                                                                                                                                    Analyze
                                                                                                                                                                    subscriptions
                                                                                                                                                                    with
                                                                                                                                                                    OpenRouter
                                                                                                                                                                    AI
                                                                                                                                                                    async
                                                                                                                                                                    function
                                                                                                                                                                    analyzeSubscriptionsWithAI()
                                                                                                                                                                    {
                                                                                                                                                                    const
                                                                                                                                                                    subs
                                                                                                                                                                    =
                                                                                                                                                                    SubscriptionManager.getAll();
                                                                                                                                                                    if
                                                                                                                                                                    (subs.length
                                                                                                                                                                    ===
                                                                                                                                                                    0)
                                                                                                                                                                    return;

                                                                                                                                                                    try
                                                                                                                                                                    {
                                                                                                                                                                    const
                                                                                                                                                                    response
                                                                                                                                                                    =
                                                                                                                                                                    await
                                                                                                                                                                    fetch(`${API}/api/ai/analyze-subscriptions`,
                                                                                                                                                                    {
                                                                                                                                                                    method:
                                                                                                                                                                    'POST',
                                                                                                                                                                    credentials:
                                                                                                                                                                    'include',
                                                                                                                                                                    headers:
                                                                                                                                                                    {
                                                                                                                                                                    'Content-Type':
                                                                                                                                                                    'application/json'
                                                                                                                                                                    },
                                                                                                                                                                    body:
                                                                                                                                                                    JSON.stringify({
                                                                                                                                                                    subscriptions:
                                                                                                                                                                    subs
                                                                                                                                                                    })
                                                                                                                                                                    });

                                                                                                                                                                    if
                                                                                                                                                                    (response.ok)
                                                                                                                                                                    {
                                                                                                                                                                    const
                                                                                                                                                                    data
                                                                                                                                                                    =
                                                                                                                                                                    await
                                                                                                                                                                    response.json();
                                                                                                                                                                    if
                                                                                                                                                                    (data.analysis)
                                                                                                                                                                    {
                                                                                                                                                                    localStorage.setItem('eurokeys_sub_analysis',
                                                                                                                                                                    JSON.stringify({
                                                                                                                                                                    timestamp:
                                                                                                                                                                    Date.now(),
                                                                                                                                                                    analysis:
                                                                                                                                                                    data.analysis
                                                                                                                                                                    }));
                                                                                                                                                                    console.log('ðŸ¤–
                                                                                                                                                                    AI
                                                                                                                                                                    subscription
                                                                                                                                                                    analysis
                                                                                                                                                                    complete');

                                                                                                                                                                    //
                                                                                                                                                                    Show
                                                                                                                                                                    result
                                                                                                                                                                    if
                                                                                                                                                                    the
                                                                                                                                                                    viewport
                                                                                                                                                                    is
                                                                                                                                                                    on
                                                                                                                                                                    the
                                                                                                                                                                    sub
                                                                                                                                                                    tab
                                                                                                                                                                    const
                                                                                                                                                                    subTab
                                                                                                                                                                    =
                                                                                                                                                                    document.getElementById('tabSubscriptions');
                                                                                                                                                                    if
                                                                                                                                                                    (subTab
                                                                                                                                                                    &&
                                                                                                                                                                    subTab.style.display
                                                                                                                                                                    !==
                                                                                                                                                                    'none')
                                                                                                                                                                    {
                                                                                                                                                                    showAIAnalysisResult(data.analysis);
                                                                                                                                                                    }
                                                                                                                                                                    }
                                                                                                                                                                    }
                                                                                                                                                                    else
                                                                                                                                                                    {
                                                                                                                                                                    console.error('AI
                                                                                                                                                                    analysis
                                                                                                                                                                    failed:',
                                                                                                                                                                    response.status);
                                                                                                                                                                    }
                                                                                                                                                                    }
                                                                                                                                                                    catch
                                                                                                                                                                    (error)
                                                                                                                                                                    {
                                                                                                                                                                    console.error('AI
                                                                                                                                                                    analysis
                                                                                                                                                                    error:',
                                                                                                                                                                    error);
                                                                                                                                                                    }
                                                                                                                                                                    }

                                                                                                                                                                    //
                                                                                                                                                                    Display
                                                                                                                                                                    AI
                                                                                                                                                                    analysis
                                                                                                                                                                    result
                                                                                                                                                                    function
                                                                                                                                                                    showAIAnalysisResult(analysis)
                                                                                                                                                                    {
                                                                                                                                                                    const
                                                                                                                                                                    existingModal
                                                                                                                                                                    =
                                                                                                                                                                    document.getElementById('aiAnalysisModal');
                                                                                                                                                                    if
                                                                                                                                                                    (existingModal)
                                                                                                                                                                    existingModal.remove();

                                                                                                                                                                    const
                                                                                                                                                                    modal
                                                                                                                                                                    =
                                                                                                                                                                    document.createElement('div');
                                                                                                                                                                    modal.id
                                                                                                                                                                    =
                                                                                                                                                                    'aiAnalysisModal';
                                                                                                                                                                    modal.innerHTML
                                                                                                                                                                    =
                                                                                                                                                                    `
                                                                                                                                                                    <div
                                                                                                                                                                        style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 10000;">
                                                                                                                                                                        <div
                                                                                                                                                                            style="background: var(--bg-secondary); border-radius: 16px; max-width: 600px; width: 90%; max-height: 80vh; overflow: auto; padding: 24px;">
                                                                                                                                                                            <div
                                                                                                                                                                                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                                                                                                                                                                                <h3
                                                                                                                                                                                    style="margin: 0; color: var(--brand-primary);">
                                                                                                                                                                                    ðŸ¤–
                                                                                                                                                                                    AI
                                                                                                                                                                                    Subscription
                                                                                                                                                                                    Analysis
                                                                                                                                                                                </h3>
                                                                                                                                                                                <button
                                                                                                                                                                                    onclick="this.closest('#aiAnalysisModal').remove()"
                                                                                                                                                                                    style="background: none; border: none; color: var(--text-secondary); font-size: 24px; cursor: pointer;">&times;</button>
                                                                                                                                                                            </div>
                                                                                                                                                                            <div
                                                                                                                                                                                style="color: var(--text-primary); line-height: 1.6; white-space: pre-wrap;">
                                                                                                                                                                                ${analysis}
                                                                                                                                                                            </div>
                                                                                                                                                                        </div>
                                                                                                                                                                    </div>
                                                                                                                                                                    `;
                                                                                                                                                                    document.body.appendChild(modal);
                                                                                                                                                                    }

                                                                                                                                                                    //
                                                                                                                                                                    Weekly
                                                                                                                                                                    AI
                                                                                                                                                                    analysis
                                                                                                                                                                    check
                                                                                                                                                                    (runs
                                                                                                                                                                    on
                                                                                                                                                                    page
                                                                                                                                                                    load)
                                                                                                                                                                    function
                                                                                                                                                                    checkWeeklyAIAnalysis()
                                                                                                                                                                    {
                                                                                                                                                                    const
                                                                                                                                                                    lastAnalysis
                                                                                                                                                                    =
                                                                                                                                                                    localStorage.getItem('eurokeys_sub_analysis');
                                                                                                                                                                    if
                                                                                                                                                                    (lastAnalysis)
                                                                                                                                                                    {
                                                                                                                                                                    const
                                                                                                                                                                    {
                                                                                                                                                                    timestamp
                                                                                                                                                                    }
                                                                                                                                                                    =
                                                                                                                                                                    JSON.parse(lastAnalysis);
                                                                                                                                                                    const
                                                                                                                                                                    weekInMs
                                                                                                                                                                    =
                                                                                                                                                                    7
                                                                                                                                                                    *
                                                                                                                                                                    24
                                                                                                                                                                    *
                                                                                                                                                                    60
                                                                                                                                                                    *
                                                                                                                                                                    60
                                                                                                                                                                    *
                                                                                                                                                                    1000;

                                                                                                                                                                    if
                                                                                                                                                                    (Date.now()
                                                                                                                                                                    -
                                                                                                                                                                    timestamp
                                                                                                                                                                    >
                                                                                                                                                                    weekInMs)
                                                                                                                                                                    {
                                                                                                                                                                    //
                                                                                                                                                                    More
                                                                                                                                                                    than
                                                                                                                                                                    a
                                                                                                                                                                    week
                                                                                                                                                                    since
                                                                                                                                                                    last
                                                                                                                                                                    analysis
                                                                                                                                                                    analyzeSubscriptionsWithAI();
                                                                                                                                                                    }
                                                                                                                                                                    }
                                                                                                                                                                    else
                                                                                                                                                                    if
                                                                                                                                                                    (SubscriptionManager.getAll().length
                                                                                                                                                                    >
                                                                                                                                                                    0)
                                                                                                                                                                    {
                                                                                                                                                                    //
                                                                                                                                                                    First
                                                                                                                                                                    time
                                                                                                                                                                    analysis
                                                                                                                                                                    if
                                                                                                                                                                    subscriptions
                                                                                                                                                                    exist
                                                                                                                                                                    analyzeSubscriptionsWithAI();
                                                                                                                                                                    }
                                                                                                                                                                    }

                                                                                                                                                                    function
                                                                                                                                                                    manualAIAnalysis()
                                                                                                                                                                    {
                                                                                                                                                                    //
                                                                                                                                                                    Check
                                                                                                                                                                    for
                                                                                                                                                                    cached
                                                                                                                                                                    analysis
                                                                                                                                                                    const
                                                                                                                                                                    cached
                                                                                                                                                                    =
                                                                                                                                                                    localStorage.getItem('eurokeys_sub_analysis');
                                                                                                                                                                    if
                                                                                                                                                                    (cached)
                                                                                                                                                                    {
                                                                                                                                                                    const
                                                                                                                                                                    {
                                                                                                                                                                    timestamp,
                                                                                                                                                                    analysis
                                                                                                                                                                    }
                                                                                                                                                                    =
                                                                                                                                                                    JSON.parse(cached);
                                                                                                                                                                    const
                                                                                                                                                                    ageHours
                                                                                                                                                                    =
                                                                                                                                                                    Math.round((Date.now()
                                                                                                                                                                    -
                                                                                                                                                                    timestamp)
                                                                                                                                                                    /
                                                                                                                                                                    (1000
                                                                                                                                                                    *
                                                                                                                                                                    60
                                                                                                                                                                    *
                                                                                                                                                                    60));

                                                                                                                                                                    if
                                                                                                                                                                    (confirm(`Last
                                                                                                                                                                    analysis
                                                                                                                                                                    was
                                                                                                                                                                    ${ageHours}h
                                                                                                                                                                    ago.
                                                                                                                                                                    Run
                                                                                                                                                                    a
                                                                                                                                                                    fresh
                                                                                                                                                                    analysis?
                                                                                                                                                                    (Cancel
                                                                                                                                                                    to
                                                                                                                                                                    view
                                                                                                                                                                    cached)`))
                                                                                                                                                                    {
                                                                                                                                                                    analyzeSubscriptionsWithAI();
                                                                                                                                                                    }
                                                                                                                                                                    else
                                                                                                                                                                    {
                                                                                                                                                                    showAIAnalysisResult(analysis);
                                                                                                                                                                    }
                                                                                                                                                                    }
                                                                                                                                                                    else
                                                                                                                                                                    {
                                                                                                                                                                    analyzeSubscriptionsWithAI();
                                                                                                                                                                    }
                                                                                                                                                                    }

                                                                                                                                                                    function
                                                                                                                                                                    editSubscription(id)
                                                                                                                                                                    {
                                                                                                                                                                    const
                                                                                                                                                                    subs
                                                                                                                                                                    =
                                                                                                                                                                    SubscriptionManager.getAll();
                                                                                                                                                                    const
                                                                                                                                                                    sub
                                                                                                                                                                    =
                                                                                                                                                                    subs.find(s
                                                                                                                                                                    =>
                                                                                                                                                                    s.id
                                                                                                                                                                    ===
                                                                                                                                                                    id);
                                                                                                                                                                    if
                                                                                                                                                                    (!sub)
                                                                                                                                                                    return;

                                                                                                                                                                    editingSubscriptionId
                                                                                                                                                                    =
                                                                                                                                                                    id;
                                                                                                                                                                    document.getElementById('subModalTitle').textContent
                                                                                                                                                                    =
                                                                                                                                                                    'Edit
                                                                                                                                                                    Subscription';
                                                                                                                                                                    document.getElementById('subCatalogSelect').value
                                                                                                                                                                    =
                                                                                                                                                                    '';
                                                                                                                                                                    document.getElementById('subName').value
                                                                                                                                                                    =
                                                                                                                                                                    sub.name;
                                                                                                                                                                    document.getElementById('subVendor').value
                                                                                                                                                                    =
                                                                                                                                                                    sub.vendor;
                                                                                                                                                                    document.getElementById('subCost').value
                                                                                                                                                                    =
                                                                                                                                                                    sub.cost
                                                                                                                                                                    ||
                                                                                                                                                                    '';
                                                                                                                                                                    document.getElementById('subBillingCycle').value
                                                                                                                                                                    =
                                                                                                                                                                    sub.billingCycle;
                                                                                                                                                                    document.getElementById('subPurchaseDate').value
                                                                                                                                                                    =
                                                                                                                                                                    sub.purchaseDate
                                                                                                                                                                    ||
                                                                                                                                                                    '';
                                                                                                                                                                    document.getElementById('subExpirationDate').value
                                                                                                                                                                    =
                                                                                                                                                                    sub.expirationDate
                                                                                                                                                                    ||
                                                                                                                                                                    '';
                                                                                                                                                                    document.getElementById('subCategory').value
                                                                                                                                                                    =
                                                                                                                                                                    sub.category;
                                                                                                                                                                    document.getElementById('subNotes').value
                                                                                                                                                                    =
                                                                                                                                                                    sub.notes
                                                                                                                                                                    ||
                                                                                                                                                                    '';
                                                                                                                                                                    document.getElementById('subRenewalUrl').value
                                                                                                                                                                    =
                                                                                                                                                                    sub.renewalUrl
                                                                                                                                                                    ||
                                                                                                                                                                    '';
                                                                                                                                                                    document.getElementById('subModalOverlay').style.display
                                                                                                                                                                    =
                                                                                                                                                                    'flex';
                                                                                                                                                                    }

                                                                                                                                                                    //
                                                                                                                                                                    Delete
                                                                                                                                                                    subscription
                                                                                                                                                                    function
                                                                                                                                                                    deleteSubscription(id)
                                                                                                                                                                    {
                                                                                                                                                                    if
                                                                                                                                                                    (confirm('Delete
                                                                                                                                                                    this
                                                                                                                                                                    subscription?
                                                                                                                                                                    This
                                                                                                                                                                    cannot
                                                                                                                                                                    be
                                                                                                                                                                    undone.'))
                                                                                                                                                                    {
                                                                                                                                                                    SubscriptionManager.delete(id);
                                                                                                                                                                    renderSubscriptionsDashboard();
                                                                                                                                                                    }
                                                                                                                                                                    }

                                                                                                                                                                    //
                                                                                                                                                                    Filter
                                                                                                                                                                    subscriptions
                                                                                                                                                                    by
                                                                                                                                                                    category
                                                                                                                                                                    function
                                                                                                                                                                    filterSubscriptions(category)
                                                                                                                                                                    {
                                                                                                                                                                    currentSubFilter
                                                                                                                                                                    =
                                                                                                                                                                    category;
                                                                                                                                                                    document.querySelectorAll('.sub-category-tab').forEach(tab
                                                                                                                                                                    =>
                                                                                                                                                                    {
                                                                                                                                                                    tab.classList.toggle('active',
                                                                                                                                                                    tab.textContent.toLowerCase().includes(category
                                                                                                                                                                    ===
                                                                                                                                                                    'all'
                                                                                                                                                                    ?
                                                                                                                                                                    'all'
                                                                                                                                                                    :
                                                                                                                                                                    category.replace('_',
                                                                                                                                                                    '
                                                                                                                                                                    ')));
                                                                                                                                                                    });
                                                                                                                                                                    renderSubscriptionCards();
                                                                                                                                                                    }

                                                                                                                                                                    //
                                                                                                                                                                    Format
                                                                                                                                                                    billing
                                                                                                                                                                    cycle
                                                                                                                                                                    function
                                                                                                                                                                    formatBillingCycle(cycle)
                                                                                                                                                                    {
                                                                                                                                                                    const
                                                                                                                                                                    labels
                                                                                                                                                                    =
                                                                                                                                                                    {
                                                                                                                                                                    'annual':
                                                                                                                                                                    '/year',
                                                                                                                                                                    'monthly':
                                                                                                                                                                    '/month',
                                                                                                                                                                    'per_use':
                                                                                                                                                                    'per
                                                                                                                                                                    use',
                                                                                                                                                                    '2day':
                                                                                                                                                                    '/2-day
                                                                                                                                                                    pass',
                                                                                                                                                                    'daily':
                                                                                                                                                                    '/day',
                                                                                                                                                                    'lifetime':
                                                                                                                                                                    'one-time'
                                                                                                                                                                    };
                                                                                                                                                                    return
                                                                                                                                                                    labels[cycle]
                                                                                                                                                                    ||
                                                                                                                                                                    cycle;
                                                                                                                                                                    }

                                                                                                                                                                    //
                                                                                                                                                                    Format
                                                                                                                                                                    date
                                                                                                                                                                    function
                                                                                                                                                                    formatDate(dateStr)
                                                                                                                                                                    {
                                                                                                                                                                    if
                                                                                                                                                                    (!dateStr)
                                                                                                                                                                    return
                                                                                                                                                                    'Not
                                                                                                                                                                    set';
                                                                                                                                                                    const
                                                                                                                                                                    date
                                                                                                                                                                    =
                                                                                                                                                                    new
                                                                                                                                                                    Date(dateStr);
                                                                                                                                                                    return
                                                                                                                                                                    date.toLocaleDateString('en-US',
                                                                                                                                                                    {
                                                                                                                                                                    month:
                                                                                                                                                                    'short',
                                                                                                                                                                    day:
                                                                                                                                                                    'numeric',
                                                                                                                                                                    year:
                                                                                                                                                                    'numeric'
                                                                                                                                                                    });
                                                                                                                                                                    }

                                                                                                                                                                    //
                                                                                                                                                                    Render
                                                                                                                                                                    subscription
                                                                                                                                                                    card
                                                                                                                                                                    function
                                                                                                                                                                    renderSubCard(sub)
                                                                                                                                                                    {
                                                                                                                                                                    const
                                                                                                                                                                    status
                                                                                                                                                                    =
                                                                                                                                                                    SubscriptionManager.getStatus(sub);
                                                                                                                                                                    const
                                                                                                                                                                    days
                                                                                                                                                                    =
                                                                                                                                                                    SubscriptionManager.getDaysRemaining(sub.expirationDate);

                                                                                                                                                                    let
                                                                                                                                                                    badgeClass
                                                                                                                                                                    =
                                                                                                                                                                    status;
                                                                                                                                                                    let
                                                                                                                                                                    badgeText
                                                                                                                                                                    =
                                                                                                                                                                    status.charAt(0).toUpperCase()
                                                                                                                                                                    +
                                                                                                                                                                    status.slice(1);
                                                                                                                                                                    let
                                                                                                                                                                    countdownText
                                                                                                                                                                    =
                                                                                                                                                                    '';

                                                                                                                                                                    if
                                                                                                                                                                    (status
                                                                                                                                                                    ===
                                                                                                                                                                    'lifetime')
                                                                                                                                                                    {
                                                                                                                                                                    countdownText
                                                                                                                                                                    =
                                                                                                                                                                    'âˆž';
                                                                                                                                                                    }
                                                                                                                                                                    else
                                                                                                                                                                    if
                                                                                                                                                                    (status
                                                                                                                                                                    ===
                                                                                                                                                                    'expired')
                                                                                                                                                                    {
                                                                                                                                                                    countdownText
                                                                                                                                                                    =
                                                                                                                                                                    Math.abs(days);
                                                                                                                                                                    badgeText
                                                                                                                                                                    =
                                                                                                                                                                    'Expired';
                                                                                                                                                                    }
                                                                                                                                                                    else
                                                                                                                                                                    if
                                                                                                                                                                    (days
                                                                                                                                                                    ===
                                                                                                                                                                    Infinity)
                                                                                                                                                                    {
                                                                                                                                                                    countdownText
                                                                                                                                                                    =
                                                                                                                                                                    'â€”';
                                                                                                                                                                    }
                                                                                                                                                                    else
                                                                                                                                                                    {
                                                                                                                                                                    countdownText
                                                                                                                                                                    =
                                                                                                                                                                    days;
                                                                                                                                                                    }

                                                                                                                                                                    const
                                                                                                                                                                    countdownLabel
                                                                                                                                                                    =
                                                                                                                                                                    status
                                                                                                                                                                    ===
                                                                                                                                                                    'expired'
                                                                                                                                                                    ?
                                                                                                                                                                    'days
                                                                                                                                                                    overdue'
                                                                                                                                                                    :
                                                                                                                                                                    status
                                                                                                                                                                    ===
                                                                                                                                                                    'lifetime'
                                                                                                                                                                    ?
                                                                                                                                                                    'Never
                                                                                                                                                                    expires'
                                                                                                                                                                    :
                                                                                                                                                                    'days
                                                                                                                                                                    remaining';

                                                                                                                                                                    return
                                                                                                                                                                    `
                                                                                                                                                                    <div
                                                                                                                                                                        class="sub-card status-${status}">
                                                                                                                                                                        <div
                                                                                                                                                                            class="sub-card-header">
                                                                                                                                                                            <div>
                                                                                                                                                                                <div
                                                                                                                                                                                    class="sub-card-title">
                                                                                                                                                                                    ${sub.name}
                                                                                                                                                                                </div>
                                                                                                                                                                                <div
                                                                                                                                                                                    class="sub-card-vendor">
                                                                                                                                                                                    ${sub.vendor
                                                                                                                                                                                    ||
                                                                                                                                                                                    'Unknown
                                                                                                                                                                                    vendor'}
                                                                                                                                                                                </div>
                                                                                                                                                                            </div>
                                                                                                                                                                            <span
                                                                                                                                                                                class="sub-card-badge ${badgeClass}">${badgeText}</span>
                                                                                                                                                                        </div>

                                                                                                                                                                        <div
                                                                                                                                                                            class="sub-card-meta">
                                                                                                                                                                            <div
                                                                                                                                                                                class="sub-meta-item">
                                                                                                                                                                                <span
                                                                                                                                                                                    class="sub-meta-label">Cost</span>
                                                                                                                                                                                <span
                                                                                                                                                                                    class="sub-meta-value">${sub.cost
                                                                                                                                                                                    ?
                                                                                                                                                                                    '$'
                                                                                                                                                                                    +
                                                                                                                                                                                    sub.cost.toLocaleString()
                                                                                                                                                                                    :
                                                                                                                                                                                    'Varies'}${sub.cost
                                                                                                                                                                                    ?
                                                                                                                                                                                    formatBillingCycle(sub.billingCycle)
                                                                                                                                                                                    :
                                                                                                                                                                                    ''}</span>
                                                                                                                                                                            </div>
                                                                                                                                                                            <div
                                                                                                                                                                                class="sub-meta-item">
                                                                                                                                                                                <span
                                                                                                                                                                                    class="sub-meta-label">Expires</span>
                                                                                                                                                                                <span
                                                                                                                                                                                    class="sub-meta-value">${sub.billingCycle
                                                                                                                                                                                    ===
                                                                                                                                                                                    'lifetime'
                                                                                                                                                                                    ?
                                                                                                                                                                                    'Never'
                                                                                                                                                                                    :
                                                                                                                                                                                    formatDate(sub.expirationDate)}</span>
                                                                                                                                                                            </div>
                                                                                                                                                                        </div>

                                                                                                                                                                        <div
                                                                                                                                                                            class="sub-countdown">
                                                                                                                                                                            <div
                                                                                                                                                                                class="sub-countdown-days">
                                                                                                                                                                                ${countdownText}
                                                                                                                                                                            </div>
                                                                                                                                                                            <div
                                                                                                                                                                                class="sub-countdown-label">
                                                                                                                                                                                ${countdownLabel}
                                                                                                                                                                            </div>
                                                                                                                                                                        </div>

                                                                                                                                                                        ${sub.notes
                                                                                                                                                                        ?
                                                                                                                                                                        `
                                                                                                                                                                        <div
                                                                                                                                                                            class="sub-card-notes">
                                                                                                                                                                            ${sub.notes}
                                                                                                                                                                        </div>
                                                                                                                                                                        `
                                                                                                                                                                        :
                                                                                                                                                                        ''}
                                                                                                                                                                        ${sub.benefit
                                                                                                                                                                        ?
                                                                                                                                                                        `
                                                                                                                                                                        <div
                                                                                                                                                                            class="sub-card-benefit">
                                                                                                                                                                            ðŸ’¡
                                                                                                                                                                            <strong>Why:</strong>
                                                                                                                                                                            ${sub.benefit}
                                                                                                                                                                        </div>
                                                                                                                                                                        `
                                                                                                                                                                        :
                                                                                                                                                                        ''}

                                                                                                                                                                        <div
                                                                                                                                                                            class="sub-card-actions">
                                                                                                                                                                            <button
                                                                                                                                                                                onclick="editSubscription('${sub.id}')">âœï¸
                                                                                                                                                                                Edit</button>
                                                                                                                                                                            ${sub.renewalUrl
                                                                                                                                                                            ?
                                                                                                                                                                            `<a href="${sub.renewalUrl}"
                                                                                                                                                                                target="_blank"
                                                                                                                                                                                class="btn-renew">ðŸ”„
                                                                                                                                                                                Renew</a>`
                                                                                                                                                                            :
                                                                                                                                                                            ''}
                                                                                                                                                                            <button
                                                                                                                                                                                onclick="deleteSubscription('${sub.id}')"
                                                                                                                                                                                style="color: #ef4444;">ðŸ—‘ï¸</button>
                                                                                                                                                                        </div>
                                                                                                                                                                    </div>
                                                                                                                                                                    `;
                                                                                                                                                                    }

                                                                                                                                                                    //
                                                                                                                                                                    Render
                                                                                                                                                                    subscription
                                                                                                                                                                    cards
                                                                                                                                                                    function
                                                                                                                                                                    renderSubscriptionCards()
                                                                                                                                                                    {
                                                                                                                                                                    const
                                                                                                                                                                    grid
                                                                                                                                                                    =
                                                                                                                                                                    document.getElementById('subCardsGrid');
                                                                                                                                                                    const
                                                                                                                                                                    emptyState
                                                                                                                                                                    =
                                                                                                                                                                    document.getElementById('subEmptyState');
                                                                                                                                                                    const
                                                                                                                                                                    licenseGrid
                                                                                                                                                                    =
                                                                                                                                                                    document.getElementById('licenseCardsGrid');

                                                                                                                                                                    //
                                                                                                                                                                    Guard
                                                                                                                                                                    against
                                                                                                                                                                    null
                                                                                                                                                                    elements
                                                                                                                                                                    (tab
                                                                                                                                                                    not
                                                                                                                                                                    visible
                                                                                                                                                                    or
                                                                                                                                                                    DOM
                                                                                                                                                                    not
                                                                                                                                                                    ready)
                                                                                                                                                                    if
                                                                                                                                                                    (!grid
                                                                                                                                                                    ||
                                                                                                                                                                    !emptyState)
                                                                                                                                                                    {
                                                                                                                                                                    console.warn('renderSubscriptionCards:
                                                                                                                                                                    Required
                                                                                                                                                                    DOM
                                                                                                                                                                    elements
                                                                                                                                                                    not
                                                                                                                                                                    found');
                                                                                                                                                                    return;
                                                                                                                                                                    }

                                                                                                                                                                    let
                                                                                                                                                                    subs
                                                                                                                                                                    =
                                                                                                                                                                    SubscriptionManager.getAll();

                                                                                                                                                                    //
                                                                                                                                                                    Separate
                                                                                                                                                                    licenses
                                                                                                                                                                    from
                                                                                                                                                                    other
                                                                                                                                                                    subscriptions
                                                                                                                                                                    const
                                                                                                                                                                    licenses
                                                                                                                                                                    =
                                                                                                                                                                    subs.filter(s
                                                                                                                                                                    =>
                                                                                                                                                                    ['license',
                                                                                                                                                                    'insurance'].includes(s.category));
                                                                                                                                                                    const
                                                                                                                                                                    otherSubs
                                                                                                                                                                    =
                                                                                                                                                                    subs.filter(s
                                                                                                                                                                    =>
                                                                                                                                                                    !['license',
                                                                                                                                                                    'insurance'].includes(s.category));

                                                                                                                                                                    //
                                                                                                                                                                    Apply
                                                                                                                                                                    filter
                                                                                                                                                                    let
                                                                                                                                                                    filteredSubs
                                                                                                                                                                    =
                                                                                                                                                                    otherSubs;
                                                                                                                                                                    if
                                                                                                                                                                    (currentSubFilter
                                                                                                                                                                    !==
                                                                                                                                                                    'all')
                                                                                                                                                                    {
                                                                                                                                                                    filteredSubs
                                                                                                                                                                    =
                                                                                                                                                                    otherSubs.filter(s
                                                                                                                                                                    =>
                                                                                                                                                                    s.category
                                                                                                                                                                    ===
                                                                                                                                                                    currentSubFilter);
                                                                                                                                                                    }

                                                                                                                                                                    //
                                                                                                                                                                    Sort
                                                                                                                                                                    by
                                                                                                                                                                    expiration
                                                                                                                                                                    (soonest
                                                                                                                                                                    first)
                                                                                                                                                                    filteredSubs.sort((a,
                                                                                                                                                                    b)
                                                                                                                                                                    =>
                                                                                                                                                                    {
                                                                                                                                                                    const
                                                                                                                                                                    daysA
                                                                                                                                                                    =
                                                                                                                                                                    SubscriptionManager.getDaysRemaining(a.expirationDate);
                                                                                                                                                                    const
                                                                                                                                                                    daysB
                                                                                                                                                                    =
                                                                                                                                                                    SubscriptionManager.getDaysRemaining(b.expirationDate);
                                                                                                                                                                    if
                                                                                                                                                                    (daysA
                                                                                                                                                                    ===
                                                                                                                                                                    Infinity)
                                                                                                                                                                    return
                                                                                                                                                                    1;
                                                                                                                                                                    if
                                                                                                                                                                    (daysB
                                                                                                                                                                    ===
                                                                                                                                                                    Infinity)
                                                                                                                                                                    return
                                                                                                                                                                    -1;
                                                                                                                                                                    return
                                                                                                                                                                    daysA
                                                                                                                                                                    -
                                                                                                                                                                    daysB;
                                                                                                                                                                    });

                                                                                                                                                                    if
                                                                                                                                                                    (filteredSubs.length
                                                                                                                                                                    ===
                                                                                                                                                                    0)
                                                                                                                                                                    {
                                                                                                                                                                    emptyState.style.display
                                                                                                                                                                    =
                                                                                                                                                                    'block';
                                                                                                                                                                    grid.innerHTML
                                                                                                                                                                    =
                                                                                                                                                                    emptyState.outerHTML;
                                                                                                                                                                    }
                                                                                                                                                                    else
                                                                                                                                                                    {
                                                                                                                                                                    emptyState.style.display
                                                                                                                                                                    =
                                                                                                                                                                    'none';
                                                                                                                                                                    grid.innerHTML
                                                                                                                                                                    =
                                                                                                                                                                    filteredSubs.map(renderSubCard).join('');
                                                                                                                                                                    }

                                                                                                                                                                    //
                                                                                                                                                                    Render
                                                                                                                                                                    licenses
                                                                                                                                                                    const
                                                                                                                                                                    licenseSection
                                                                                                                                                                    =
                                                                                                                                                                    document.getElementById('licenseSection');
                                                                                                                                                                    if
                                                                                                                                                                    (licenseGrid
                                                                                                                                                                    &&
                                                                                                                                                                    licenseSection)
                                                                                                                                                                    {
                                                                                                                                                                    if
                                                                                                                                                                    (licenses.length
                                                                                                                                                                    >
                                                                                                                                                                    0)
                                                                                                                                                                    {
                                                                                                                                                                    licenseGrid.innerHTML
                                                                                                                                                                    =
                                                                                                                                                                    licenses.map(renderSubCard).join('');
                                                                                                                                                                    licenseSection.style.display
                                                                                                                                                                    =
                                                                                                                                                                    'block';
                                                                                                                                                                    }
                                                                                                                                                                    else
                                                                                                                                                                    {
                                                                                                                                                                    licenseSection.style.display
                                                                                                                                                                    =
                                                                                                                                                                    'none';
                                                                                                                                                                    }
                                                                                                                                                                    }
                                                                                                                                                                    }

                                                                                                                                                                    //
                                                                                                                                                                    Render
                                                                                                                                                                    alert
                                                                                                                                                                    banner
                                                                                                                                                                    function
                                                                                                                                                                    renderAlertBanner()
                                                                                                                                                                    {
                                                                                                                                                                    const
                                                                                                                                                                    banner
                                                                                                                                                                    =
                                                                                                                                                                    document.getElementById('subAlertBanner');
                                                                                                                                                                    if
                                                                                                                                                                    (!banner)
                                                                                                                                                                    return;

                                                                                                                                                                    const
                                                                                                                                                                    expiringSoon
                                                                                                                                                                    =
                                                                                                                                                                    SubscriptionManager.getExpiringSoon(30);

                                                                                                                                                                    if
                                                                                                                                                                    (expiringSoon.length
                                                                                                                                                                    ===
                                                                                                                                                                    0)
                                                                                                                                                                    {
                                                                                                                                                                    banner.style.display
                                                                                                                                                                    =
                                                                                                                                                                    'none';
                                                                                                                                                                    return;
                                                                                                                                                                    }

                                                                                                                                                                    const
                                                                                                                                                                    critical
                                                                                                                                                                    =
                                                                                                                                                                    expiringSoon.filter(s
                                                                                                                                                                    =>
                                                                                                                                                                    SubscriptionManager.getDaysRemaining(s.expirationDate)
                                                                                                                                                                    <= 7);
                                                                                                                                                                        const
                                                                                                                                                                        isCritical=critical.length>
                                                                                                                                                                        0;

                                                                                                                                                                        const
                                                                                                                                                                        items
                                                                                                                                                                        =
                                                                                                                                                                        expiringSoon.slice(0,
                                                                                                                                                                        3).map(s
                                                                                                                                                                        =>
                                                                                                                                                                        {
                                                                                                                                                                        const
                                                                                                                                                                        days
                                                                                                                                                                        =
                                                                                                                                                                        SubscriptionManager.getDaysRemaining(s.expirationDate);
                                                                                                                                                                        return
                                                                                                                                                                        `<strong>${s.name}</strong>
                                                                                                                                                                        (${days}
                                                                                                                                                                        day${days
                                                                                                                                                                        !==
                                                                                                                                                                        1
                                                                                                                                                                        ?
                                                                                                                                                                        's'
                                                                                                                                                                        :
                                                                                                                                                                        ''})`;
                                                                                                                                                                        }).join(',
                                                                                                                                                                        ');

                                                                                                                                                                        const
                                                                                                                                                                        moreCount
                                                                                                                                                                        =
                                                                                                                                                                        expiringSoon.length
                                                                                                                                                                        -
                                                                                                                                                                        3;
                                                                                                                                                                        const
                                                                                                                                                                        moreText
                                                                                                                                                                        =
                                                                                                                                                                        moreCount
                                                                                                                                                                        >
                                                                                                                                                                        0
                                                                                                                                                                        ?
                                                                                                                                                                        `,
                                                                                                                                                                        and
                                                                                                                                                                        ${moreCount}
                                                                                                                                                                        more`
                                                                                                                                                                        :
                                                                                                                                                                        '';

                                                                                                                                                                        banner.className
                                                                                                                                                                        =
                                                                                                                                                                        isCritical
                                                                                                                                                                        ?
                                                                                                                                                                        'sub-alert-banner'
                                                                                                                                                                        :
                                                                                                                                                                        'sub-alert-banner
                                                                                                                                                                        warning';
                                                                                                                                                                        banner.innerHTML
                                                                                                                                                                        =
                                                                                                                                                                        `
                                                                                                                                                                        <span
                                                                                                                                                                            class="sub-alert-icon">${isCritical
                                                                                                                                                                            ?
                                                                                                                                                                            'ðŸš¨'
                                                                                                                                                                            :
                                                                                                                                                                            'âš ï¸'}</span>
                                                                                                                                                                        <div
                                                                                                                                                                            class="sub-alert-content">
                                                                                                                                                                            <div
                                                                                                                                                                                class="sub-alert-title">
                                                                                                                                                                                ${isCritical
                                                                                                                                                                                ?
                                                                                                                                                                                'Urgent:
                                                                                                                                                                                Subscriptions
                                                                                                                                                                                Expiring!'
                                                                                                                                                                                :
                                                                                                                                                                                'Upcoming
                                                                                                                                                                                Renewals'}
                                                                                                                                                                            </div>
                                                                                                                                                                            <div
                                                                                                                                                                                class="sub-alert-desc">
                                                                                                                                                                                ${items}${moreText}
                                                                                                                                                                            </div>
                                                                                                                                                                        </div>
                                                                                                                                                                        `;
                                                                                                                                                                        banner.style.display
                                                                                                                                                                        =
                                                                                                                                                                        'flex';
                                                                                                                                                                        }

                                                                                                                                                                        //
                                                                                                                                                                        Update
                                                                                                                                                                        stats
                                                                                                                                                                        function
                                                                                                                                                                        updateSubStats()
                                                                                                                                                                        {
                                                                                                                                                                        const
                                                                                                                                                                        stats
                                                                                                                                                                        =
                                                                                                                                                                        SubscriptionManager.getStats();
                                                                                                                                                                        const
                                                                                                                                                                        activeEl
                                                                                                                                                                        =
                                                                                                                                                                        document.getElementById('subActiveCount');
                                                                                                                                                                        const
                                                                                                                                                                        warningEl
                                                                                                                                                                        =
                                                                                                                                                                        document.getElementById('subWarningCount');
                                                                                                                                                                        const
                                                                                                                                                                        expiredEl
                                                                                                                                                                        =
                                                                                                                                                                        document.getElementById('subExpiredCount');
                                                                                                                                                                        const
                                                                                                                                                                        lifetimeEl
                                                                                                                                                                        =
                                                                                                                                                                        document.getElementById('subLifetimeCount');

                                                                                                                                                                        if
                                                                                                                                                                        (activeEl)
                                                                                                                                                                        activeEl.textContent
                                                                                                                                                                        =
                                                                                                                                                                        stats.active;
                                                                                                                                                                        if
                                                                                                                                                                        (warningEl)
                                                                                                                                                                        warningEl.textContent
                                                                                                                                                                        =
                                                                                                                                                                        stats.warning;
                                                                                                                                                                        if
                                                                                                                                                                        (expiredEl)
                                                                                                                                                                        expiredEl.textContent
                                                                                                                                                                        =
                                                                                                                                                                        stats.expired;
                                                                                                                                                                        if
                                                                                                                                                                        (lifetimeEl)
                                                                                                                                                                        lifetimeEl.textContent
                                                                                                                                                                        =
                                                                                                                                                                        stats.lifetime;
                                                                                                                                                                        }

                                                                                                                                                                        //
                                                                                                                                                                        Main
                                                                                                                                                                        render
                                                                                                                                                                        function
                                                                                                                                                                        function
                                                                                                                                                                        renderSubscriptionsDashboard()
                                                                                                                                                                        {
                                                                                                                                                                        updateSubStats();
                                                                                                                                                                        renderAlertBanner();
                                                                                                                                                                        renderSubscriptionCards();
                                                                                                                                                                        }

                                                                                                                                                                        //
                                                                                                                                                                        Initialize
                                                                                                                                                                        Everything
                                                                                                                                                                        window.addEventListener('DOMContentLoaded',
                                                                                                                                                                        ()
                                                                                                                                                                        =>
                                                                                                                                                                        {
                                                                                                                                                                        //
                                                                                                                                                                        Handle
                                                                                                                                                                        OAuth
                                                                                                                                                                        callback
                                                                                                                                                                        token
                                                                                                                                                                        in
                                                                                                                                                                        URL
                                                                                                                                                                        hash
                                                                                                                                                                        const
                                                                                                                                                                        hash
                                                                                                                                                                        =
                                                                                                                                                                        window.location.hash;
                                                                                                                                                                        if
                                                                                                                                                                        (hash.startsWith('#auth_token='))
                                                                                                                                                                        {
                                                                                                                                                                        const
                                                                                                                                                                        token
                                                                                                                                                                        =
                                                                                                                                                                        hash.replace('#auth_token=',
                                                                                                                                                                        '');
                                                                                                                                                                        if
                                                                                                                                                                        (token)
                                                                                                                                                                        {
                                                                                                                                                                        try
                                                                                                                                                                        {
                                                                                                                                                                        //
                                                                                                                                                                        Decode
                                                                                                                                                                        the
                                                                                                                                                                        JWT
                                                                                                                                                                        to
                                                                                                                                                                        get
                                                                                                                                                                        user
                                                                                                                                                                        info
                                                                                                                                                                        (payload
                                                                                                                                                                        is
                                                                                                                                                                        base64
                                                                                                                                                                        encoded)
                                                                                                                                                                        const
                                                                                                                                                                        payload
                                                                                                                                                                        =
                                                                                                                                                                        JSON.parse(atob(token.split('.')[1]));
                                                                                                                                                                        currentUser
                                                                                                                                                                        =
                                                                                                                                                                        {
                                                                                                                                                                        id:
                                                                                                                                                                        payload.sub,
                                                                                                                                                                        email:
                                                                                                                                                                        payload.email,
                                                                                                                                                                        name:
                                                                                                                                                                        payload.name,
                                                                                                                                                                        picture:
                                                                                                                                                                        payload.picture,
                                                                                                                                                                        is_pro:
                                                                                                                                                                        payload.is_pro,
                                                                                                                                                                        is_developer:
                                                                                                                                                                        payload.is_developer,
                                                                                                                                                                        trial_until:
                                                                                                                                                                        payload.trial_until
                                                                                                                                                                        };
                                                                                                                                                                        localStorage.setItem('eurokeys_user',
                                                                                                                                                                        JSON.stringify(currentUser));
                                                                                                                                                                        localStorage.setItem('eurokeys_session_token',
                                                                                                                                                                        token);
                                                                                                                                                                        //
                                                                                                                                                                        Clear
                                                                                                                                                                        the
                                                                                                                                                                        hash
                                                                                                                                                                        from
                                                                                                                                                                        URL
                                                                                                                                                                        history.replaceState(null,
                                                                                                                                                                        '',
                                                                                                                                                                        window.location.pathname);
                                                                                                                                                                        console.log('Auth
                                                                                                                                                                        completed
                                                                                                                                                                        via
                                                                                                                                                                        redirect,
                                                                                                                                                                        user:',
                                                                                                                                                                        currentUser.email);
                                                                                                                                                                        //
                                                                                                                                                                        Update
                                                                                                                                                                        UI
                                                                                                                                                                        after
                                                                                                                                                                        brief
                                                                                                                                                                        delay
                                                                                                                                                                        to
                                                                                                                                                                        ensure
                                                                                                                                                                        DOM
                                                                                                                                                                        is
                                                                                                                                                                        ready
                                                                                                                                                                        setTimeout(()
                                                                                                                                                                        =>
                                                                                                                                                                        {
                                                                                                                                                                        updateAuthUI(true);
                                                                                                                                                                        if
                                                                                                                                                                        (currentUser
                                                                                                                                                                        &&
                                                                                                                                                                        currentUser.is_developer)
                                                                                                                                                                        {
                                                                                                                                                                        const
                                                                                                                                                                        devTab
                                                                                                                                                                        =
                                                                                                                                                                        document.getElementById('devTab');
                                                                                                                                                                        if
                                                                                                                                                                        (devTab)
                                                                                                                                                                        devTab.style.display
                                                                                                                                                                        =
                                                                                                                                                                        'inline-flex';
                                                                                                                                                                        }
                                                                                                                                                                        //
                                                                                                                                                                        CRITICAL:
                                                                                                                                                                        Load
                                                                                                                                                                        inventory
                                                                                                                                                                        and
                                                                                                                                                                        logs
                                                                                                                                                                        from
                                                                                                                                                                        cloud
                                                                                                                                                                        after
                                                                                                                                                                        sign-in
                                                                                                                                                                        if
                                                                                                                                                                        (currentUser)
                                                                                                                                                                        {
                                                                                                                                                                        InventoryManager.loadFromCloud().then(()
                                                                                                                                                                        =>
                                                                                                                                                                        {
                                                                                                                                                                        console.log('ðŸ“¦
                                                                                                                                                                        Inventory
                                                                                                                                                                        loaded
                                                                                                                                                                        after
                                                                                                                                                                        sign-in
                                                                                                                                                                        redirect');
                                                                                                                                                                        InventoryManager.loadJobLogsFromCloud();
                                                                                                                                                                        SubscriptionManager.loadFromCloud();
                                                                                                                                                                        AssetManager.loadFromCloud();
                                                                                                                                                                        if
                                                                                                                                                                        (typeof
                                                                                                                                                                        renderInventoryPage
                                                                                                                                                                        ===
                                                                                                                                                                        'function')
                                                                                                                                                                        renderInventoryPage();
                                                                                                                                                                        });
                                                                                                                                                                        }
                                                                                                                                                                        },
                                                                                                                                                                        100);
                                                                                                                                                                        }
                                                                                                                                                                        catch
                                                                                                                                                                        (e)
                                                                                                                                                                        {
                                                                                                                                                                        console.error('Failed
                                                                                                                                                                        to
                                                                                                                                                                        parse
                                                                                                                                                                        auth
                                                                                                                                                                        token:',
                                                                                                                                                                        e);
                                                                                                                                                                        }
                                                                                                                                                                        }
                                                                                                                                                                        }

                                                                                                                                                                        //
                                                                                                                                                                        Initialize
                                                                                                                                                                        14-day
                                                                                                                                                                        trial
                                                                                                                                                                        for
                                                                                                                                                                        all
                                                                                                                                                                        visitors
                                                                                                                                                                        initAnonymousTrial();

                                                                                                                                                                        //
                                                                                                                                                                        Core
                                                                                                                                                                        UI/Auth
                                                                                                                                                                        Initialization
                                                                                                                                                                        populateYears();
                                                                                                                                                                        initGoogleAuth();

                                                                                                                                                                        //
                                                                                                                                                                        Render
                                                                                                                                                                        the
                                                                                                                                                                        make
                                                                                                                                                                        grid
                                                                                                                                                                        on
                                                                                                                                                                        initial
                                                                                                                                                                        load
                                                                                                                                                                        if
                                                                                                                                                                        (typeof
                                                                                                                                                                        renderMakeGrid
                                                                                                                                                                        ===
                                                                                                                                                                        'function')
                                                                                                                                                                        {
                                                                                                                                                                        renderMakeGrid();
                                                                                                                                                                        }

                                                                                                                                                                        //
                                                                                                                                                                        Handle
                                                                                                                                                                        URL
                                                                                                                                                                        hash
                                                                                                                                                                        routing
                                                                                                                                                                        on
                                                                                                                                                                        page
                                                                                                                                                                        load
                                                                                                                                                                        handleInitialRoute();

                                                                                                                                                                        //
                                                                                                                                                                        Show
                                                                                                                                                                        trial
                                                                                                                                                                        banner
                                                                                                                                                                        after
                                                                                                                                                                        short
                                                                                                                                                                        delay
                                                                                                                                                                        (to
                                                                                                                                                                        ensure
                                                                                                                                                                        auth
                                                                                                                                                                        is
                                                                                                                                                                        loaded)
                                                                                                                                                                        setTimeout(updateTrialBanner,
                                                                                                                                                                        500);

                                                                                                                                                                        //
                                                                                                                                                                        ==================
                                                                                                                                                                        MOBILE
                                                                                                                                                                        SYNC
                                                                                                                                                                        PATTERNS
                                                                                                                                                                        ==================

                                                                                                                                                                        //
                                                                                                                                                                        1.
                                                                                                                                                                        Revalidate
                                                                                                                                                                        on
                                                                                                                                                                        Focus
                                                                                                                                                                        -
                                                                                                                                                                        when
                                                                                                                                                                        user
                                                                                                                                                                        returns
                                                                                                                                                                        to
                                                                                                                                                                        tab/app,
                                                                                                                                                                        sync
                                                                                                                                                                        from
                                                                                                                                                                        cloud
                                                                                                                                                                        let
                                                                                                                                                                        lastRevalidation
                                                                                                                                                                        =
                                                                                                                                                                        0;
                                                                                                                                                                        const
                                                                                                                                                                        REVALIDATION_COOLDOWN
                                                                                                                                                                        =
                                                                                                                                                                        30000;
                                                                                                                                                                        //
                                                                                                                                                                        30
                                                                                                                                                                        seconds
                                                                                                                                                                        minimum
                                                                                                                                                                        between
                                                                                                                                                                        auto-syncs

                                                                                                                                                                        document.addEventListener('visibilitychange',
                                                                                                                                                                        async
                                                                                                                                                                        ()
                                                                                                                                                                        =>
                                                                                                                                                                        {
                                                                                                                                                                        if
                                                                                                                                                                        (document.visibilityState
                                                                                                                                                                        ===
                                                                                                                                                                        'visible'
                                                                                                                                                                        &&
                                                                                                                                                                        currentUser)
                                                                                                                                                                        {
                                                                                                                                                                        const
                                                                                                                                                                        now
                                                                                                                                                                        =
                                                                                                                                                                        Date.now();
                                                                                                                                                                        if
                                                                                                                                                                        (now
                                                                                                                                                                        -
                                                                                                                                                                        lastRevalidation
                                                                                                                                                                        >
                                                                                                                                                                        REVALIDATION_COOLDOWN)
                                                                                                                                                                        {
                                                                                                                                                                        lastRevalidation
                                                                                                                                                                        =
                                                                                                                                                                        now;
                                                                                                                                                                        console.log('ðŸ‘€
                                                                                                                                                                        Tab
                                                                                                                                                                        visible
                                                                                                                                                                        -
                                                                                                                                                                        revalidating
                                                                                                                                                                        from
                                                                                                                                                                        cloud...');
                                                                                                                                                                        try
                                                                                                                                                                        {
                                                                                                                                                                        await
                                                                                                                                                                        InventoryManager.loadFromCloud();
                                                                                                                                                                        await
                                                                                                                                                                        InventoryManager.loadJobLogsFromCloud();
                                                                                                                                                                        console.log('âœ…
                                                                                                                                                                        Revalidation
                                                                                                                                                                        complete');
                                                                                                                                                                        }
                                                                                                                                                                        catch
                                                                                                                                                                        (e)
                                                                                                                                                                        {
                                                                                                                                                                        console.warn('Revalidation
                                                                                                                                                                        failed:',
                                                                                                                                                                        e);
                                                                                                                                                                        }
                                                                                                                                                                        }
                                                                                                                                                                        }
                                                                                                                                                                        });

                                                                                                                                                                        //
                                                                                                                                                                        2.
                                                                                                                                                                        Pull
                                                                                                                                                                        to
                                                                                                                                                                        Refresh
                                                                                                                                                                        -
                                                                                                                                                                        mobile
                                                                                                                                                                        gesture
                                                                                                                                                                        let
                                                                                                                                                                        pullStartY
                                                                                                                                                                        =
                                                                                                                                                                        0;
                                                                                                                                                                        let
                                                                                                                                                                        pullCurrentY
                                                                                                                                                                        =
                                                                                                                                                                        0;
                                                                                                                                                                        let
                                                                                                                                                                        isPulling
                                                                                                                                                                        =
                                                                                                                                                                        false;
                                                                                                                                                                        let
                                                                                                                                                                        pullIndicator
                                                                                                                                                                        =
                                                                                                                                                                        null;

                                                                                                                                                                        function
                                                                                                                                                                        createPullIndicator()
                                                                                                                                                                        {
                                                                                                                                                                        if
                                                                                                                                                                        (pullIndicator)
                                                                                                                                                                        return
                                                                                                                                                                        pullIndicator;
                                                                                                                                                                        pullIndicator
                                                                                                                                                                        =
                                                                                                                                                                        document.createElement('div');
                                                                                                                                                                        pullIndicator.id
                                                                                                                                                                        =
                                                                                                                                                                        'pullToRefreshIndicator';
                                                                                                                                                                        pullIndicator.innerHTML
                                                                                                                                                                        =
                                                                                                                                                                        `
                                                                                                                                                                        <div style="
                        position: fixed;
                        top: 0;
                        left: 50%;
                        transform: translateX(-50%) translateY(-100%);
                        background: var(--bg-tertiary);
                        border: 1px solid var(--border);
                        padding: 12px 24px;
                        border-radius: 0 0 16px 16px;
                        display: flex;
                        align-items: center;
                        gap: 10px;
                        z-index: 9999;
                        transition: transform 0.2s;
                        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                    ">
                                                                                                                                                                            <span
                                                                                                                                                                                class="pull-icon"
                                                                                                                                                                                style="font-size: 1.2rem;">â†“</span>
                                                                                                                                                                            <span
                                                                                                                                                                                class="pull-text"
                                                                                                                                                                                style="color: var(--text-primary); font-size: 0.9rem; font-weight: 500;">Pull
                                                                                                                                                                                to
                                                                                                                                                                                refresh</span>
                                                                                                                                                                        </div>
                                                                                                                                                                        `;
                                                                                                                                                                        document.body.appendChild(pullIndicator);
                                                                                                                                                                        return
                                                                                                                                                                        pullIndicator;
                                                                                                                                                                        }

                                                                                                                                                                        function
                                                                                                                                                                        handlePullStart(e)
                                                                                                                                                                        {
                                                                                                                                                                        //
                                                                                                                                                                        Only
                                                                                                                                                                        enable
                                                                                                                                                                        pull-to-refresh
                                                                                                                                                                        when
                                                                                                                                                                        at
                                                                                                                                                                        top
                                                                                                                                                                        of
                                                                                                                                                                        page
                                                                                                                                                                        and
                                                                                                                                                                        on
                                                                                                                                                                        inventory
                                                                                                                                                                        tab
                                                                                                                                                                        const
                                                                                                                                                                        inventoryTab
                                                                                                                                                                        =
                                                                                                                                                                        document.getElementById('tabInventory');
                                                                                                                                                                        if
                                                                                                                                                                        (!inventoryTab
                                                                                                                                                                        ||
                                                                                                                                                                        inventoryTab.style.display
                                                                                                                                                                        ===
                                                                                                                                                                        'none')
                                                                                                                                                                        return;
                                                                                                                                                                        if
                                                                                                                                                                        (window.scrollY
                                                                                                                                                                        >
                                                                                                                                                                        5)
                                                                                                                                                                        return;
                                                                                                                                                                        if
                                                                                                                                                                        (!currentUser)
                                                                                                                                                                        return;

                                                                                                                                                                        pullStartY
                                                                                                                                                                        =
                                                                                                                                                                        e.touches
                                                                                                                                                                        ?
                                                                                                                                                                        e.touches[0].clientY
                                                                                                                                                                        :
                                                                                                                                                                        e.clientY;
                                                                                                                                                                        isPulling
                                                                                                                                                                        =
                                                                                                                                                                        true;
                                                                                                                                                                        }

                                                                                                                                                                        function
                                                                                                                                                                        handlePullMove(e)
                                                                                                                                                                        {
                                                                                                                                                                        if
                                                                                                                                                                        (!isPulling)
                                                                                                                                                                        return;

                                                                                                                                                                        pullCurrentY
                                                                                                                                                                        =
                                                                                                                                                                        e.touches
                                                                                                                                                                        ?
                                                                                                                                                                        e.touches[0].clientY
                                                                                                                                                                        :
                                                                                                                                                                        e.clientY;
                                                                                                                                                                        const
                                                                                                                                                                        pullDistance
                                                                                                                                                                        =
                                                                                                                                                                        pullCurrentY
                                                                                                                                                                        -
                                                                                                                                                                        pullStartY;

                                                                                                                                                                        if
                                                                                                                                                                        (pullDistance
                                                                                                                                                                        >
                                                                                                                                                                        20
                                                                                                                                                                        &&
                                                                                                                                                                        pullDistance
                                                                                                                                                                        < 150)
                                                                                                                                                                            {
                                                                                                                                                                            const
                                                                                                                                                                            indicator=createPullIndicator();
                                                                                                                                                                            const
                                                                                                                                                                            inner=indicator.querySelector('div');
                                                                                                                                                                            const
                                                                                                                                                                            progress=Math.min(pullDistance
                                                                                                                                                                            /
                                                                                                                                                                            80,
                                                                                                                                                                            1);
                                                                                                                                                                            inner.style.transform=`translateX(-50%)
                                                                                                                                                                            translateY(${-100
                                                                                                                                                                            +
                                                                                                                                                                            (progress
                                                                                                                                                                            *
                                                                                                                                                                            120)}%)`;
                                                                                                                                                                            const
                                                                                                                                                                            icon=indicator.querySelector('.pull-icon');
                                                                                                                                                                            const
                                                                                                                                                                            text=indicator.querySelector('.pull-text');
                                                                                                                                                                            if
                                                                                                                                                                            (pullDistance>
                                                                                                                                                                            80)
                                                                                                                                                                            {
                                                                                                                                                                            icon.textContent
                                                                                                                                                                            =
                                                                                                                                                                            'â†»';
                                                                                                                                                                            icon.style.animation
                                                                                                                                                                            =
                                                                                                                                                                            'none';
                                                                                                                                                                            text.textContent
                                                                                                                                                                            =
                                                                                                                                                                            'Release
                                                                                                                                                                            to
                                                                                                                                                                            refresh';
                                                                                                                                                                            }
                                                                                                                                                                            else
                                                                                                                                                                            {
                                                                                                                                                                            icon.textContent
                                                                                                                                                                            =
                                                                                                                                                                            'â†“';
                                                                                                                                                                            text.textContent
                                                                                                                                                                            =
                                                                                                                                                                            'Pull
                                                                                                                                                                            to
                                                                                                                                                                            refresh';
                                                                                                                                                                            }
                                                                                                                                                                            }
                                                                                                                                                                            }

                                                                                                                                                                            async
                                                                                                                                                                            function
                                                                                                                                                                            handlePullEnd(e)
                                                                                                                                                                            {
                                                                                                                                                                            if
                                                                                                                                                                            (!isPulling)
                                                                                                                                                                            return;
                                                                                                                                                                            isPulling
                                                                                                                                                                            =
                                                                                                                                                                            false;

                                                                                                                                                                            const
                                                                                                                                                                            pullDistance
                                                                                                                                                                            =
                                                                                                                                                                            pullCurrentY
                                                                                                                                                                            -
                                                                                                                                                                            pullStartY;

                                                                                                                                                                            if
                                                                                                                                                                            (pullIndicator)
                                                                                                                                                                            {
                                                                                                                                                                            const
                                                                                                                                                                            inner
                                                                                                                                                                            =
                                                                                                                                                                            pullIndicator.querySelector('div');

                                                                                                                                                                            if
                                                                                                                                                                            (pullDistance
                                                                                                                                                                            >
                                                                                                                                                                            80
                                                                                                                                                                            &&
                                                                                                                                                                            currentUser)
                                                                                                                                                                            {
                                                                                                                                                                            //
                                                                                                                                                                            Trigger
                                                                                                                                                                            refresh
                                                                                                                                                                            const
                                                                                                                                                                            icon
                                                                                                                                                                            =
                                                                                                                                                                            pullIndicator.querySelector('.pull-icon');
                                                                                                                                                                            const
                                                                                                                                                                            text
                                                                                                                                                                            =
                                                                                                                                                                            pullIndicator.querySelector('.pull-text');
                                                                                                                                                                            icon.textContent
                                                                                                                                                                            =
                                                                                                                                                                            'â†»';
                                                                                                                                                                            icon.style.animation
                                                                                                                                                                            =
                                                                                                                                                                            'spin
                                                                                                                                                                            0.8s
                                                                                                                                                                            linear
                                                                                                                                                                            infinite';
                                                                                                                                                                            text.textContent
                                                                                                                                                                            =
                                                                                                                                                                            'Refreshing...';

                                                                                                                                                                            //
                                                                                                                                                                            Add
                                                                                                                                                                            spin
                                                                                                                                                                            animation
                                                                                                                                                                            if
                                                                                                                                                                            not
                                                                                                                                                                            exists
                                                                                                                                                                            if
                                                                                                                                                                            (!document.getElementById('pullSpinStyle'))
                                                                                                                                                                            {
                                                                                                                                                                            const
                                                                                                                                                                            style
                                                                                                                                                                            =
                                                                                                                                                                            document.createElement('style');
                                                                                                                                                                            style.id
                                                                                                                                                                            =
                                                                                                                                                                            'pullSpinStyle';
                                                                                                                                                                            style.textContent
                                                                                                                                                                            =
                                                                                                                                                                            '@keyframes
                                                                                                                                                                            spin
                                                                                                                                                                            {
                                                                                                                                                                            from
                                                                                                                                                                            {
                                                                                                                                                                            transform:
                                                                                                                                                                            rotate(0deg);
                                                                                                                                                                            }
                                                                                                                                                                            to
                                                                                                                                                                            {
                                                                                                                                                                            transform:
                                                                                                                                                                            rotate(360deg);
                                                                                                                                                                            }
                                                                                                                                                                            }';
                                                                                                                                                                            document.head.appendChild(style);
                                                                                                                                                                            }

                                                                                                                                                                            try
                                                                                                                                                                            {
                                                                                                                                                                            await
                                                                                                                                                                            InventoryManager.loadFromCloud();
                                                                                                                                                                            await
                                                                                                                                                                            InventoryManager.loadJobLogsFromCloud();
                                                                                                                                                                            text.textContent
                                                                                                                                                                            =
                                                                                                                                                                            'âœ“
                                                                                                                                                                            Updated!';
                                                                                                                                                                            icon.textContent
                                                                                                                                                                            =
                                                                                                                                                                            'âœ“';
                                                                                                                                                                            icon.style.animation
                                                                                                                                                                            =
                                                                                                                                                                            'none';

                                                                                                                                                                            //
                                                                                                                                                                            Re-render
                                                                                                                                                                            current
                                                                                                                                                                            view
                                                                                                                                                                            const
                                                                                                                                                                            inventoryTab
                                                                                                                                                                            =
                                                                                                                                                                            document.getElementById('tabInventory');
                                                                                                                                                                            if
                                                                                                                                                                            (inventoryTab
                                                                                                                                                                            &&
                                                                                                                                                                            inventoryTab.style.display
                                                                                                                                                                            !==
                                                                                                                                                                            'none')
                                                                                                                                                                            {
                                                                                                                                                                            renderInventoryPage();
                                                                                                                                                                            }
                                                                                                                                                                            }
                                                                                                                                                                            catch
                                                                                                                                                                            (err)
                                                                                                                                                                            {
                                                                                                                                                                            text.textContent
                                                                                                                                                                            =
                                                                                                                                                                            'âœ—
                                                                                                                                                                            Failed';
                                                                                                                                                                            icon.textContent
                                                                                                                                                                            =
                                                                                                                                                                            'âœ—';
                                                                                                                                                                            icon.style.animation
                                                                                                                                                                            =
                                                                                                                                                                            'none';
                                                                                                                                                                            }

                                                                                                                                                                            //
                                                                                                                                                                            Hide
                                                                                                                                                                            after
                                                                                                                                                                            delay
                                                                                                                                                                            setTimeout(()
                                                                                                                                                                            =>
                                                                                                                                                                            {
                                                                                                                                                                            inner.style.transform
                                                                                                                                                                            =
                                                                                                                                                                            'translateX(-50%)
                                                                                                                                                                            translateY(-100%)';
                                                                                                                                                                            },
                                                                                                                                                                            1000);
                                                                                                                                                                            }
                                                                                                                                                                            else
                                                                                                                                                                            {
                                                                                                                                                                            //
                                                                                                                                                                            Cancel
                                                                                                                                                                            -
                                                                                                                                                                            hide
                                                                                                                                                                            indicator
                                                                                                                                                                            inner.style.transform
                                                                                                                                                                            =
                                                                                                                                                                            'translateX(-50%)
                                                                                                                                                                            translateY(-100%)';
                                                                                                                                                                            }
                                                                                                                                                                            }

                                                                                                                                                                            pullStartY
                                                                                                                                                                            =
                                                                                                                                                                            0;
                                                                                                                                                                            pullCurrentY
                                                                                                                                                                            =
                                                                                                                                                                            0;
                                                                                                                                                                            }

                                                                                                                                                                            //
                                                                                                                                                                            Attach
                                                                                                                                                                            pull-to-refresh
                                                                                                                                                                            listeners
                                                                                                                                                                            document.addEventListener('touchstart',
                                                                                                                                                                            handlePullStart,
                                                                                                                                                                            {
                                                                                                                                                                            passive:
                                                                                                                                                                            true
                                                                                                                                                                            });
                                                                                                                                                                            document.addEventListener('touchmove',
                                                                                                                                                                            handlePullMove,
                                                                                                                                                                            {
                                                                                                                                                                            passive:
                                                                                                                                                                            true
                                                                                                                                                                            });
                                                                                                                                                                            document.addEventListener('touchend',
                                                                                                                                                                            handlePullEnd,
                                                                                                                                                                            {
                                                                                                                                                                            passive:
                                                                                                                                                                            true
                                                                                                                                                                            });

                                                                                                                                                                            console.log('ðŸ“±
                                                                                                                                                                            Mobile
                                                                                                                                                                            sync
                                                                                                                                                                            patterns
                                                                                                                                                                            initialized
                                                                                                                                                                            (revalidateOnFocus
                                                                                                                                                                            +
                                                                                                                                                                            pull-to-refresh)');
                                                                                                                                                                            });

                                                                                                                                                                            </script>

                                                                                                                                                                            <!-- Service Worker Registration for PWA with Auto-Update -->
                                                                                                                                                                            <script>
        // PWA Install Prompt
        let deferredInstallPrompt = null;

        window.addEventListener('beforeinstallprompt', (e) => {
            console.log('PWA: Install prompt available');
            e.preventDefault();
            deferredInstallPrompt = e;
            showInstallBanner();
        });

        function showInstallBanner() {
            // Check if already installed or dismissed recently
            const dismissed = localStorage.getItem('pwa_install_dismissed');
            if (dismissed && Date.now() - parseInt(dismissed) < 7 * 24 * 60 * 60 * 1000) return; // 7 days

            // Create install banner
            const banner = document.createElement('div');
            banner.id = 'pwaInstallBanner';
            banner.innerHTML = `
                    < div style = "position: fixed; bottom: 0; left: 0; right: 0; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); 
                padding: 16px; display: flex; justify - content: space - between; align - items: center; gap: 12px; z - index: 10000;
                border - top: 1px solid rgba(255, 180, 0, 0.3); box - shadow: 0 - 4px 20px rgba(0, 0, 0, 0.5); ">
                    < div style = "display: flex; align-items: center; gap: 12px;" >
                        <img src="/assets/icon-192.png" style="width: 48px; height: 48px; border-radius: 10px;" alt="Euro Keys">
                        <div>
                            <div style="font-weight: 700; color: #fff; font-size: 0.95rem;">Install Euro Keys</div>
                            <div style="font-size: 0.8rem; color: rgba(255,255,255,0.7);">Quick access from your home screen</div>
                        </div>
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <button onclick="dismissInstallBanner()" style="padding: 8px 16px; background: transparent; border: 1px solid rgba(255,255,255,0.2); 
                                         color: rgba(255,255,255,0.7); border-radius: 8px; cursor: pointer; font-size: 0.85rem;">Later</button>
                        <button onclick="installPWA()" style="padding: 8px 20px; background: var(--brand-primary, #FFB400); border: none; 
                                         color: #000; border-radius: 8px; cursor: pointer; font-weight: 700; font-size: 0.85rem;">Install</button>
                    </div>
                </div >
                    `;
            document.body.appendChild(banner);
        }

        function dismissInstallBanner() {
            localStorage.setItem('pwa_install_dismissed', Date.now().toString());
            const banner = document.getElementById('pwaInstallBanner');
            if (banner) banner.remove();
        }

        async function installPWA() {
            if (!deferredInstallPrompt) {
                alert('To install: tap the Share button and select "Add to Home Screen"');
                return;
            }
            deferredInstallPrompt.prompt();
            const { outcome } = await deferredInstallPrompt.userChoice;
            console.log('PWA: Install outcome:', outcome);
            deferredInstallPrompt = null;
            dismissInstallBanner();
        }

        // Service Worker Registration with Update Handling
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', async () => {
                try {
                    const registration = await navigator.serviceWorker.register('/sw.js');
                    console.log('Service Worker registered:', registration.scope);

                    // Check for updates immediately and every 5 minutes
                    try {
                        registration.update();
                        setInterval(() => {
                            try { registration.update(); } catch (e) { console.warn('SW update failed', e); }
                        }, 5 * 60 * 1000);
                    } catch (e) {
                        console.warn('SW initial update failed', e);
                    }

                    // Handle updates
                    registration.addEventListener('updatefound', () => {
                        const newWorker = registration.installing;
                        console.log('Service Worker: Update found');

                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                // New version available, show update prompt
                                showUpdateBanner();
                            }
                        });
                    });
                } catch (err) {
                    console.log('Service Worker registration failed:', err);
                }
            });

            // Listen for SW_UPDATED message from service worker
            navigator.serviceWorker.addEventListener('message', (event) => {
                if (event.data && event.data.type === 'SW_UPDATED') {
                    console.log('Service Worker: Received update notification, reloading...');
                    window.location.reload();
                }
            });
        }

        function showUpdateBanner() {
            const banner = document.createElement('div');
            banner.id = 'updateBanner';
            banner.innerHTML = `
                    < div style = "position: fixed; top: 0; left: 0; right: 0; background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); 
                padding: 12px 16px; display: flex; justify - content: center; align - items: center; gap: 16px; z - index: 10001;
                box - shadow: 0 4px 20px rgba(0, 0, 0, 0.3); ">
                    < span style = "color: #fff; font-weight: 600;" >ðŸŽ‰ New version available!</span >
                        <button onclick="window.location.reload()" style="padding: 6px 16px; background: #fff; border: none; 
                                     color: #16a34a; border-radius: 6px; cursor: pointer; font-weight: 700; font-size: 0.85rem;">Refresh Now</button>
                </div >
            `;
            document.body.appendChild(banner);
        }
                                                                                                                                                                            </script>
                                                                                                                                                                            <!-- Programming Guide Modal -->
                                                                                                                                                                            <div id="guideModal"
                                                                                                                                                                                class="modal"
                                                                                                                                                                                style="display: none; align-items: center; justify-content: center;">
                                                                                                                                                                                <div class="modal-overlay"
                                                                                                                                                                                    onclick="closeGuideModal()">
                                                                                                                                                                                </div>
                                                                                                                                                                                <div class="modal-content"
                                                                                                                                                                                    style="max-width: 800px; max-height: 90vh; display: flex; flex-direction: column;">
                                                                                                                                                                                    <div
                                                                                                                                                                                        class="modal-header">
                                                                                                                                                                                        <h2
                                                                                                                                                                                            id="guideModalTitle">
                                                                                                                                                                                            Programming
                                                                                                                                                                                            Guide
                                                                                                                                                                                        </h2>
                                                                                                                                                                                        <button
                                                                                                                                                                                            class="modal-close"
                                                                                                                                                                                            onclick="closeGuideModal()">Ã—</button>
                                                                                                                                                                                    </div>
                                                                                                                                                                                    <div class="modal-body"
                                                                                                                                                                                        id="guideModalBody"
                                                                                                                                                                                        style="overflow-y: auto; padding: 20px; line-height: 1.6;">
                                                                                                                                                                                        <!-- Content injected here -->
                                                                                                                                                                                    </div>
                                                                                                                                                                                </div>
                                                                                                                                                                            </div>

                                                                                                                                                                            <!-- Cloudflare Web Analytics -->
                                                                                                                                                                            <script
                                                                                                                                                                                defer
                                                                                                                                                                                src='https://static.cloudflareinsights.com/beacon.min.js'
                                                                                                                                                                                data-cf-beacon='{"token": "55cb95cc0e174..."}'></script>
                                                                                                                                                                            <!-- End Cloudflare Web Analytics -->
                                                                                                                                                                            <script
                                                                                                                                                                                src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
                                                                                                                                                                            <script
                                                                                                                                                                                src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
                                                                                                                                                                            <script
                                                                                                                                                                                src="public/js/tool_coverage_data.js"></script>
                                                                                                                                                                            <script
                                                                                                                                                                                src="public/js/programming_guides_data.js"></script>
                                                                                                                                                                            <script
                                                                                                                                                                                src="public/js/transponder_reference.js"></script>
                                                                                                                                                                            <script
                                                                                                                                                                                src="public/js/coverage_metadata.js"></script>
                                                                                                                                                                            <!-- Dynamic Guide Renderer -->
                                                                                                                                                                            <script
                                                                                                                                                                                src="components/GuideRenderer.js"></script>
</body>

</html>