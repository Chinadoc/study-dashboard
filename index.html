<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0f172a">
    <title>Euro Keys - Locksmith Database</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a1628;
            --bg-secondary: #111d32;
            --bg-tertiary: #1a2942;
            --brand-primary: #fbbf24;
            --brand-secondary: #f59e0b;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --success: #22c55e;
            --border: rgba(251, 191, 36, 0.15);
            --radius: 12px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: linear-gradient(180deg, var(--bg-primary) 0%, #0d1829 100%);
            color: var(--text-primary);
            min-height: 100vh;
        }

        /* Top Bar */
        .top-bar {
            background: var(--brand-primary);
            color: var(--bg-primary);
            text-align: center;
            padding: 10px;
            font-size: 0.9rem;
            font-weight: 600;
        }

        /* Header */
        .header {
            padding: 20px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--text-primary);
        }

        .logo span {
            color: var(--brand-primary);
        }

        .header-right {
            display: flex;
            gap: 16px;
            align-items: center;
        }

        .header-link {
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 0.9rem;
        }

        .header-avatar {
            width: 36px;
            height: 36px;
            background: var(--brand-primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: var(--bg-primary);
        }

        .google-signin-btn {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 20px;
            background: #ffffff;
            border: 1px solid #dadce0;
            border-radius: 24px;
            font-size: 0.9rem;
            font-weight: 500;
            color: #3c4043;
            cursor: pointer;
            transition: all 0.2s;
            font-family: 'Roboto', 'Inter', sans-serif;
        }

        .google-signin-btn:hover {
            background: #f7f8f8;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12);
        }

        .google-signin-btn svg {
            width: 18px;
            height: 18px;
        }

        .user-menu {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-menu .header-avatar {
            cursor: pointer;
        }

        .user-menu .user-name {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        /* Header Search */
        .header-search-container {
            display: flex;
            align-items: center;
            position: relative;
        }

        .header-search-toggle {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .header-search-toggle:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .header-search-box {
            position: absolute;
            right: 0;
            top: 100%;
            margin-top: 8px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 8px;
            display: flex;
            gap: 6px;
            z-index: 100;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
            animation: slideDown 0.2s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .header-search-box input {
            width: 220px;
            padding: 10px 14px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .header-search-box input:focus {
            outline: none;
            border-color: var(--brand-primary);
        }

        .header-search-box button {
            padding: 10px 16px;
            background: var(--brand-primary);
            border: none;
            border-radius: 8px;
            color: var(--bg-primary);
            font-weight: 600;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .header-search-box button.close-search {
            background: var(--bg-tertiary);
            color: var(--text-muted);
            padding: 10px 12px;
        }

        .header-search-box button:hover {
            opacity: 0.9;
        }

        @media (max-width: 768px) {
            .header-search-box {
                right: -60px;
                width: calc(100vw - 40px);
            }

            .header-search-box input {
                flex: 1;
                width: auto;
            }
        }

        .tabs {
            display: flex;
            justify-content: center;
            gap: 8px;
            padding: 16px 24px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
        }

        .tab {
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            background: transparent;
            color: var(--text-secondary);
        }

        .tab:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .tab.active {
            background: var(--brand-primary);
            color: var(--bg-primary);
        }

        /* Container */
        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 40px 24px;
        }

        /* Page Title */
        .page-title {
            text-align: center;
            margin-bottom: 12px;
        }

        .page-title h1 {
            font-size: 2.2rem;
            font-weight: 800;
        }

        .page-title h1 span {
            color: var(--brand-primary);
        }

        .page-subtitle {
            text-align: center;
            color: var(--text-secondary);
            margin-bottom: 32px;
            font-size: 1rem;
        }

        /* Browse Box */
        .browse-box {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 32px;
            max-width: 700px;
            margin: 0 auto 40px;
        }

        .browse-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin-bottom: 20px;
        }

        .browse-field {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .browse-label {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
        }

        .browse-select {
            padding: 16px 20px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            color: var(--text-primary);
            font-size: 1rem;
            font-family: inherit;
            cursor: pointer;
            appearance: none;
        }

        .browse-select:focus {
            outline: none;
            border-color: var(--brand-primary);
        }

        .search-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
            padding: 18px;
            background: var(--brand-primary);
            border: none;
            border-radius: var(--radius);
            color: var(--bg-primary);
            font-weight: 700;
            font-size: 1.1rem;
            cursor: pointer;
        }

        /* FCC Table */
        .fcc-search {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
        }

        /* FCC Filters */
        .fcc-filters {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .fcc-filter {
            padding: 10px 20px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 24px;
            color: var(--text-secondary);
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .fcc-filter:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .fcc-filter.active {
            background: var(--brand-primary);
            color: var(--bg-primary);
            border-color: var(--brand-primary);
        }

        .fcc-search input {
            flex: 1;
            padding: 14px 20px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            color: var(--text-primary);
            font-size: 1rem;
        }

        .fcc-search input::placeholder {
            color: var(--text-muted);
        }

        .fcc-search input:focus {
            outline: none;
            border-color: var(--brand-primary);
        }

        .fcc-table-wrapper {
            overflow-x: auto;
        }

        .fcc-table {
            width: 100%;
            border-collapse: collapse;
        }

        .fcc-table th {
            text-align: left;
            padding: 14px 12px;
            background: var(--bg-secondary);
            color: var(--text-muted);
            font-weight: 600;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid var(--border);
        }

        .fcc-table td {
            padding: 14px 12px;
            border-bottom: 1px solid var(--border);
            font-size: 0.9rem;
        }

        .fcc-table tr:hover {
            background: var(--bg-secondary);
        }

        .fcc-link {
            color: var(--brand-primary);
            text-decoration: none;
            font-weight: 600;
        }

        .fcc-link:hover {
            text-decoration: underline;
        }

        .amazon-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            background: #ff9900;
            color: #000;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 600;
            text-decoration: none;
            transition: all 0.2s;
        }

        .amazon-btn:hover {
            background: #ffad33;
            transform: translateY(-1px);
        }

        /* Vehicle Card */
        .vehicle-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 16px;
        }

        .vehicle-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
            flex-wrap: wrap;
            gap: 12px;
        }

        .vehicle-name {
            font-size: 1.25rem;
            font-weight: 700;
        }

        .vehicle-badges {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .badge-gold {
            background: var(--brand-primary);
            color: var(--bg-primary);
        }

        .badge-dark {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        /* Data Grid */
        .data-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
        }

        .data-item {
            padding: 14px;
            background: var(--bg-tertiary);
            border-radius: 10px;
        }

        .data-label {
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }

        .data-value {
            font-size: 0.9rem;
            font-weight: 600;
        }

        .data-value a {
            color: var(--brand-primary);
            text-decoration: none;
        }

        .data-value.highlight {
            color: var(--brand-primary);
        }

        /* Views */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Results Section */
        .results-section {
            display: none;
        }

        .results-section.active {
            display: block;
        }

        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .result-title {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .back-btn {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        /* Footer */
        .footer {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-muted);
            font-size: 0.85rem;
            border-top: 1px solid var(--border);
            margin-top: 60px;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 60px;
            color: var(--text-muted);
        }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-top: 24px;
        }

        .pagination button {
            padding: 10px 16px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            cursor: pointer;
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination .page-info {
            padding: 10px 16px;
            color: var(--text-muted);
        }

        @media (max-width: 768px) {
            .browse-grid {
                grid-template-columns: 1fr;
            }

            .data-grid {
                grid-template-columns: 1fr 1fr;
            }

            .page-title h1 {
                font-size: 1.6rem;
            }

            .tabs {
                flex-wrap: wrap;
            }

            .tab {
                font-size: 0.85rem;
                padding: 10px 16px;
            }

            .hide-mobile {
                display: none !important;
            }

            .fcc-table th:nth-child(3),
            .fcc-table td:nth-child(3),
            .fcc-table th:nth-child(4),
            .fcc-table td:nth-child(4) {
                display: none;
            }

            .fcc-filters {
                flex-direction: column;
                gap: 12px;
            }

            .fcc-filters>div {
                margin-left: 0 !important;
            }
        }

        /* Photo Gallery Styles */
        .photo-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 12px;
            margin-top: 16px;
        }

        .photo-thumbnail {
            aspect-ratio: 1;
            background: var(--bg-tertiary);
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .photo-thumbnail:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 20px rgba(251, 191, 36, 0.3);
        }

        .photo-thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .fcc-link-card {
            display: block;
            padding: 20px;
            background: var(--bg-tertiary);
            border: 1px solid var(--brand-primary);
            border-radius: 12px;
            text-decoration: none;
            text-align: center;
            transition: all 0.2s;
        }

        .fcc-link-card:hover {
            background: rgba(251, 191, 36, 0.1);
            transform: translateY(-2px);
        }

        .key-photos-btn {
            padding: 8px 16px;
            background: var(--bg-tertiary);
            border: 1px solid var(--brand-primary);
            color: var(--brand-primary);
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .key-photos-btn:hover {
            background: var(--brand-primary);
            color: var(--bg-primary);
        }
    </style>
</head>

<body>

    <!-- FCC Detail Modal -->
    <div id="fccModal" class="modal" style="display: none;">
        <div class="modal-overlay" onclick="closeFccModal()"></div>
        <div class="modal-content">
            <button class="modal-close" onclick="closeFccModal()">√ó</button>
            <div id="fccModalBody"></div>
        </div>
    </div>

    <!-- Key Photos Modal -->
    <div id="keyPhotosModal" class="modal" style="display: none;">
        <div class="modal-overlay" onclick="closeKeyPhotosModal()"></div>
        <div class="modal-content" style="max-width: 700px;">
            <button class="modal-close" onclick="closeKeyPhotosModal()">√ó</button>
            <div id="keyPhotosModalBody"></div>
        </div>
    </div>

    <!-- Lightbox for enlarged photos -->
    <div id="photoLightbox" onclick="closeLightbox()"
        style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 2000; align-items: center; justify-content: center; cursor: zoom-out;">
        <img id="lightboxImage" style="max-width: 95%; max-height: 95%; object-fit: contain;">
    </div>

    <style>
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
        }

        .modal-content {
            position: relative;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 16px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            padding: 24px;
        }

        .modal-close {
            position: absolute;
            top: 12px;
            right: 16px;
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 24px;
            cursor: pointer;
        }

        .modal-close:hover {
            color: var(--text-primary);
        }

        .modal-title {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--brand-primary);
            margin-bottom: 8px;
        }

        .modal-subtitle {
            color: var(--text-muted);
            font-size: 0.9rem;
            margin-bottom: 20px;
        }

        .modal-vehicle-list {
            list-style: none;
            padding: 0;
            margin: 0 0 20px 0;
            max-height: 300px;
            overflow-y: auto;
        }

        .modal-vehicle-list li {
            padding: 10px 12px;
            border-bottom: 1px solid var(--border);
            font-size: 0.9rem;
        }

        .modal-vehicle-list li:last-child {
            border-bottom: none;
        }

        .modal-amazon {
            display: block;
            width: 100%;
            padding: 16px;
            background: var(--brand-primary);
            color: var(--bg-primary);
            text-align: center;
            text-decoration: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 700;
        }

        .modal-amazon:hover {
            opacity: 0.9;
        }

        .modal-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 20px;
        }

        .modal-info-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 10px;
            border-radius: 8px;
        }

        .modal-info-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .modal-info-value {
            font-weight: 600;
            color: var(--text-primary);
        }
    </style>

    <div class="top-bar">üìû Call (804) 506-0709</div>

    <header class="header">
        <div class="logo">üîë EURO <span>KEYS</span></div>
        <div class="header-right">
            <!-- Quick Search Toggle -->
            <div class="header-search-container">
                <button class="header-search-toggle" onclick="toggleHeaderSearch()" title="Quick Search">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"></circle>
                        <path d="m21 21-4.35-4.35"></path>
                    </svg>
                </button>
                <div id="headerSearchBox" class="header-search-box" style="display: none;">
                    <input type="text" id="headerSearchInput" placeholder="Search FCC ID, make, model..."
                        onkeypress="if(event.key==='Enter') headerQuickSearch()">
                    <button onclick="headerQuickSearch()">Go</button>
                    <button onclick="toggleHeaderSearch()" class="close-search">√ó</button>
                </div>
            </div>

            <!-- User menu shows when signed in -->
            <div id="userMenu" class="user-menu" style="display: none;">
                <span class="user-name" id="userName"></span>
                <div class="header-avatar" id="userAvatar" onclick="signOut()"></div>
            </div>
            <!-- Google Sign In button shows when signed out -->
            <button id="googleSignInBtn" class="google-signin-btn" onclick="signInWithGoogle()">
                <svg viewBox="0 0 24 24">
                    <path fill="#4285F4"
                        d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" />
                    <path fill="#34A853"
                        d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" />
                    <path fill="#FBBC05"
                        d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" />
                    <path fill="#EA4335"
                        d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" />
                </svg>
                Sign in
            </button>
        </div>
    </header>

    <!-- Tabs -->
    <div class="tabs">
        <button class="tab active" onclick="showTab('browse')">üìÇ Browse Database</button>
        <button class="tab" onclick="showTab('fcc')">üì° FCC Database</button>
    </div>

    <!-- Browse Database Tab -->
    <div class="tab-content active" id="tabBrowse">
        <div id="browseSection">
            <div class="container">
                <div class="page-title">
                    <h1>Browse <span>Database</span></h1>
                </div>
                <p class="page-subtitle">Select vehicle details to view locksmith specifications.</p>

                <div class="browse-box">
                    <div class="browse-grid">
                        <div class="browse-field">
                            <label class="browse-label">Year</label>
                            <select class="browse-select" id="yearSelect" onchange="loadMakes()">
                                <option value="">Select Year</option>
                            </select>
                        </div>
                        <div class="browse-field">
                            <label class="browse-label">Make</label>
                            <select class="browse-select" id="makeSelect" onchange="loadModels()">
                                <option value="">Select Make</option>
                            </select>
                        </div>
                        <div class="browse-field">
                            <label class="browse-label">Model</label>
                            <select class="browse-select" id="modelSelect">
                                <option value="">Select Model</option>
                            </select>
                        </div>
                    </div>
                    <button class="search-btn" onclick="searchVehicle()">Search Database üîç</button>
                </div>
            </div>
        </div>

        <div id="resultsSection" class="results-section">
            <div class="container">
                <div class="result-header">
                    <h2 class="result-title" id="resultTitle">Vehicle Results</h2>
                    <div class="result-actions">
                        <button class="back-btn" onclick="goBack()">üîç New Search</button>
                    </div>
                </div>

                <!-- Quick vehicle switcher -->
                <div class="quick-search" style="display: flex; gap: 8px; margin-bottom: 20px; flex-wrap: wrap;">
                    <select class="browse-select" id="quickYear" onchange="quickLoadMakes()"
                        style="padding: 10px 14px; font-size: 0.9rem; flex: 1; min-width: 100px;">
                        <option value="">Year</option>
                    </select>
                    <select class="browse-select" id="quickMake" onchange="quickLoadModels()"
                        style="padding: 10px 14px; font-size: 0.9rem; flex: 1; min-width: 120px;">
                        <option value="">Make</option>
                    </select>
                    <select class="browse-select" id="quickModel"
                        style="padding: 10px 14px; font-size: 0.9rem; flex: 1; min-width: 120px;">
                        <option value="">Model</option>
                    </select>
                    <button onclick="quickSearch()"
                        style="padding: 10px 16px; background: var(--brand-primary); border: none; border-radius: 8px; color: var(--bg-primary); font-weight: 600; cursor: pointer; white-space: nowrap;">Go
                        ‚Üí</button>
                </div>

                <div id="resultsContainer"></div>
            </div>
        </div>
    </div>

    <!-- FCC Database Tab -->
    <div class="tab-content" id="tabFcc">
        <div class="container">
            <div class="page-title">
                <h1>FCC <span>Database</span></h1>
            </div>
            <p class="page-subtitle">Browse FCC IDs for key fobs and remotes with direct Amazon links.</p>

            <div class="fcc-filters">
                <button class="fcc-filter active" data-type="all" onclick="setFccFilter('all')">All Keys</button>
                <button class="fcc-filter" data-type="push" onclick="setFccFilter('push')">üöó Push-to-Start</button>
                <button class="fcc-filter" data-type="non-push" onclick="setFccFilter('non-push')">üîë Traditional
                    Key</button>

                <div style="display: flex; gap: 8px; margin-left: auto; align-items: center;">
                    <span style="color: var(--text-muted); font-size: 0.85rem;">Year:</span>
                    <select id="fccYearFrom" class="browse-select"
                        style="padding: 8px 12px; font-size: 0.85rem; width: 90px;" onchange="filterFccTable()">
                        <option value="">From</option>
                    </select>
                    <span style="color: var(--text-muted);">-</span>
                    <select id="fccYearTo" class="browse-select"
                        style="padding: 8px 12px; font-size: 0.85rem; width: 90px;" onchange="filterFccTable()">
                        <option value="">To</option>
                    </select>
                </div>
            </div>

            <div class="fcc-search">
                <input type="text" id="fccSearch" placeholder="üîç Search by FCC ID or vehicle (e.g. Jeep, Honda)..."
                    oninput="filterFccTable()">
            </div>

            <div class="fcc-table-wrapper">
                <table class="fcc-table">
                    <thead>
                        <tr>
                            <th>FCC ID</th>
                            <th>Vehicles</th>
                            <th>Frequency</th>
                            <th>Chip</th>
                            <th>Amazon</th>
                        </tr>
                    </thead>
                    <tbody id="fccTableBody">
                        <tr>
                            <td colspan="5" class="loading">Loading FCC data...</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="pagination" id="fccPagination"></div>
        </div>
    </div>

    <footer class="footer">
        ¬© 2025 Euro Keys<br>
        Professional Automotive Locksmith - Richmond, VA
    </footer>

    <script>
        const API = 'https://euro-keys.jeremy-samuels17.workers.dev';
        const AFFILIATE_TAG = 'eurokeys-20';

        // Valid makes only
        const VALID_MAKES = [
            'Acura', 'Alfa Romeo', 'Aston Martin', 'Audi', 'Bentley', 'BMW', 'Buick',
            'Cadillac', 'Chevrolet', 'Chrysler', 'Dodge', 'Ferrari', 'Fiat', 'Ford',
            'Genesis', 'GMC', 'Gmc', 'Honda', 'Hummer', 'Hyundai', 'Infiniti', 'Jaguar',
            'Jeep', 'Kia', 'Lamborghini', 'Land Rover', 'Lexus', 'Lincoln', 'Maserati',
            'Mazda', 'McLaren', 'Mercedes-Benz', 'Mercedes', 'Mercury', 'Mini',
            'Mitsubishi', 'Nissan', 'Oldsmobile', 'Pontiac', 'Porsche', 'Ram',
            'Rolls-Royce', 'Saab', 'Saturn', 'Scion', 'Subaru', 'Suzuki', 'Tesla',
            'Toyota', 'Volkswagen', 'Volvo'
        ];

        function isValidMake(make) {
            return VALID_MAKES.some(v => v.toLowerCase() === make.toLowerCase());
        }

        // Tab switching
        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach((t, i) => {
                t.classList.toggle('active', (tabName === 'browse' && i === 0) || (tabName === 'fcc' && i === 1));
            });
            document.getElementById('tabBrowse').classList.toggle('active', tabName === 'browse');
            document.getElementById('tabFcc').classList.toggle('active', tabName === 'fcc');

            if (tabName === 'fcc' && !fccDataLoaded) {
                loadFccData();
            }
        }

        // ================== HEADER QUICK SEARCH ==================

        function toggleHeaderSearch() {
            const searchBox = document.getElementById('headerSearchBox');
            const isVisible = searchBox.style.display !== 'none';
            searchBox.style.display = isVisible ? 'none' : 'flex';
            if (!isVisible) {
                document.getElementById('headerSearchInput').focus();
            }
        }

        function headerQuickSearch() {
            const query = document.getElementById('headerSearchInput').value.trim();
            if (!query) return;

            // Switch to FCC tab and search
            showTab('fcc');
            document.getElementById('fccSearch').value = query;
            toggleHeaderSearch(); // Close the search box

            if (fccDataLoaded) {
                renderFccTable();
            } else {
                loadFccData();
            }
        }

        // Close header search when clicking outside
        document.addEventListener('click', function (e) {
            const container = document.querySelector('.header-search-container');
            const searchBox = document.getElementById('headerSearchBox');
            if (container && searchBox && !container.contains(e.target) && searchBox.style.display !== 'none') {
                searchBox.style.display = 'none';
            }
        });

        // ================== BROWSE DATABASE ==================

        function populateYears() {
            const select = document.getElementById('yearSelect');
            const year = new Date().getFullYear() + 1;
            for (let y = year; y >= 2000; y--) {
                select.innerHTML += `<option value="${y}">${y}</option>`;
            }
        }

        async function loadMakes() {
            const year = document.getElementById('yearSelect').value;
            const select = document.getElementById('makeSelect');

            if (!year) {
                select.innerHTML = '<option value="">Select Make</option>';
                return;
            }

            select.innerHTML = '<option value="">Loading...</option>';

            try {
                const res = await fetch(`${API}/api/master?year=${year}&limit=1000`);
                const data = await res.json();
                const makes = [...new Set(data.rows.map(r => r.make))]
                    .filter(isValidMake)
                    .sort();

                select.innerHTML = '<option value="">Select Make</option>';
                makes.forEach(m => {
                    select.innerHTML += `<option value="${m}">${m}</option>`;
                });
            } catch (e) {
                select.innerHTML = '<option value="">Select Make</option>';
            }
        }

        async function loadModels() {
            const year = document.getElementById('yearSelect').value;
            const make = document.getElementById('makeSelect').value;
            const select = document.getElementById('modelSelect');

            if (!make) {
                select.innerHTML = '<option value="">Select Model</option>';
                return;
            }

            select.innerHTML = '<option value="">Loading...</option>';

            try {
                const res = await fetch(`${API}/api/master?year=${year}&make=${encodeURIComponent(make)}&limit=500`);
                const data = await res.json();
                const models = [...new Set(data.rows.map(r => r.model))].sort();

                select.innerHTML = '<option value="">Select Model</option>';
                models.forEach(m => {
                    select.innerHTML += `<option value="${m}">${m}</option>`;
                });
            } catch (e) {
                select.innerHTML = '<option value="">Select Model</option>';
            }
        }

        async function searchVehicle() {
            const year = document.getElementById('yearSelect').value;
            const make = document.getElementById('makeSelect').value;
            const model = document.getElementById('modelSelect').value;

            if (!year || !make || !model) {
                alert('Please select year, make, and model');
                return;
            }

            document.getElementById('resultTitle').textContent = `${year} ${make} ${model}`;
            document.getElementById('resultsContainer').innerHTML = '<div class="loading">Loading...</div>';

            document.getElementById('browseSection').style.display = 'none';
            document.getElementById('resultsSection').classList.add('active');
            initQuickSearch();

            try {
                const res = await fetch(`${API}/api/browse?year=${year}&make=${encodeURIComponent(make)}&model=${encodeURIComponent(model)}&limit=10`);
                const data = await res.json();

                if (data.rows && data.rows.length > 0) {
                    displayResults(data.rows, year, make, model);
                } else {
                    document.getElementById('resultsContainer').innerHTML = '<div class="loading">No results found</div>';
                }
            } catch (e) {
                document.getElementById('resultsContainer').innerHTML = '<div class="loading">Failed to load</div>';
            }
        }

        function displayResults(rows, year, make, model) {
            const container = document.getElementById('resultsContainer');

            // Deduplicate rows by unique combination of FCC ID + OEM Part + key type
            const seen = new Set();
            const uniqueRows = rows.filter(v => {
                const key = `${v.fcc_id || ''}-${v.oem_part_number || ''}-${v.key_type || ''}`;
                if (seen.has(key)) return false;
                seen.add(key);
                return true;
            });

            container.innerHTML = uniqueRows.map((v, idx) => {
                const fccId = v.fcc_id || 'N/A';
                const oem = v.oem_part_number || 'N/A';
                const amazonLink = fccId !== 'N/A' ? getAmazonLink(fccId) : null;
                const immo = v.immobilizer_system || v.immobilizer || 'N/A';
                const chip = v.chip || v.chip_technology || 'N/A';
                const freq = v.frequency ? `${v.frequency} MHz` : 'N/A';
                const keyway = v.keyway || 'N/A';
                const buttons = v.buttons || 'N/A';
                const battery = v.battery || 'N/A';

                // Key type from API or crossref
                const keyType = v.key_type || v.crossref_key_type || 'N/A';
                const keyTypeIcon = getKeyTypeIcon(keyType);

                // Aftermarket parts from part_crossref
                const ilco = v.ilco_part || 'N/A';
                const strattec = v.strattec_part || 'N/A';
                const jma = v.jma_part || 'N/A';
                const keydiy = v.keydiy_part || 'N/A';
                const hasAftermarket = ilco !== 'N/A' || strattec !== 'N/A' || jma !== 'N/A' || keydiy !== 'N/A';

                // Create card label based on what differentiates it
                let cardLabel = `${year} ${make} ${model}`;
                if (uniqueRows.length > 1) {
                    if (fccId !== 'N/A') {
                        cardLabel += ` ‚Ä¢ FCC: ${fccId}`;
                    } else if (oem !== 'N/A') {
                        cardLabel += ` ‚Ä¢ Part: ${oem}`;
                    } else {
                        cardLabel += ` ‚Ä¢ Variant ${idx + 1}`;
                    }
                }

                // FCC ID links to internal FCC Database
                const fccDisplay = fccId !== 'N/A'
                    ? `<a href="#" class="fcc-link" onclick="searchFccById('${fccId}'); return false;">${fccId}</a>`
                    : 'N/A';

                // YouTube search link
                const youtubeLink = `https://www.youtube.com/results?search_query=${encodeURIComponent(`${year} ${make} ${model} key programming Autel`)}`;

                return `
                <div class="vehicle-card">
                    <div class="vehicle-card-header">
                        <div class="vehicle-name">${cardLabel}</div>
                        <div class="vehicle-badges">
                            ${keyType !== 'N/A' ? `<span class="badge badge-dark">${keyTypeIcon} ${keyType}</span>` : ''}
                            <span class="badge badge-gold">${immo !== 'N/A' ? immo : 'Standard'}</span>
                            ${amazonLink ? `<a href="${amazonLink}" target="_blank" class="amazon-btn">üõí Buy on Amazon</a>` : ''}
                        </div>
                    </div>
                    <div class="data-grid">
                        <div class="data-item">
                            <div class="data-label">FCC ID</div>
                            <div class="data-value highlight">${fccDisplay}</div>
                        </div>
                        <div class="data-item">
                            <div class="data-label">Chip</div>
                            <div class="data-value">${chip}</div>
                        </div>
                        <div class="data-item">
                            <div class="data-label">Frequency</div>
                            <div class="data-value">${freq}</div>
                        </div>
                        <div class="data-item">
                            <div class="data-label">Key Blank</div>
                            <div class="data-value">${keyway}</div>
                        </div>
                        <div class="data-item">
                            <div class="data-label">Buttons</div>
                            <div class="data-value">${buttons}</div>
                        </div>
                        <div class="data-item">
                            <div class="data-label">Battery</div>
                            <div class="data-value">${battery}</div>
                        </div>
                        <div class="data-item">
                            <div class="data-label">OEM Part #</div>
                            <div class="data-value">${oem}</div>
                        </div>
                        <div class="data-item">
                            <div class="data-label">Lishi Tool</div>
                            <div class="data-value">${v.lishi_tool || 'N/A'}</div>
                        </div>
                    </div>
                    
                    ${hasAftermarket ? `
                    <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border);">
                        <div style="font-size: 0.8rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;">Aftermarket Parts</div>
                        <div style="display: flex; gap: 12px; flex-wrap: wrap; font-size: 0.9rem;">
                            ${ilco !== 'N/A' ? `<span><strong>ILCO:</strong> ${ilco}</span>` : ''}
                            ${strattec !== 'N/A' ? `<span><strong>Strattec:</strong> ${strattec}</span>` : ''}
                            ${jma !== 'N/A' ? `<span><strong>JMA:</strong> ${jma}</span>` : ''}
                            ${keydiy !== 'N/A' ? `<span><strong>KEYDIY:</strong> ${keydiy}</span>` : ''}
                        </div>
                    </div>
                    ` : ''}
                    
                    <div style="margin-top: 12px; display: flex; gap: 8px; flex-wrap: wrap;">
                        ${fccId !== 'N/A' ? `<button onclick="showKeyPhotos('${fccId}')" class="key-photos-btn">üì∑ Key Photos</button>` : ''}
                        <a href="${youtubeLink}" target="_blank" style="padding: 8px 16px; background: #ff0000; color: white; border-radius: 6px; text-decoration: none; font-size: 0.85rem; font-weight: 600;">üì∫ Watch Tutorial</a>
                    </div>
                </div>
            `;
            }).join('');
        }

        function getKeyTypeIcon(keyType) {
            const lower = (keyType || '').toLowerCase();
            if (lower.includes('smart') || lower.includes('prox')) return 'üöó';
            if (lower.includes('flip')) return 'üîÑ';
            if (lower.includes('fobik')) return 'üìü';
            if (lower.includes('remote')) return 'üì°';
            return 'üîë';
        }

        function goBack() {
            document.getElementById('browseSection').style.display = 'block';
            document.getElementById('resultsSection').classList.remove('active');
        }

        // Quick search from results page
        async function quickLoadMakes() {
            const year = document.getElementById('quickYear').value;
            const select = document.getElementById('quickMake');

            if (!year) {
                select.innerHTML = '<option value="">Make</option>';
                return;
            }
            select.innerHTML = '<option value="">Loading...</option>';

            try {
                const res = await fetch(`${API}/api/master?year=${year}&limit=1000`);
                const data = await res.json();
                const makes = [...new Set(data.rows.map(r => r.make))].filter(isValidMake).sort();
                select.innerHTML = '<option value="">Make</option>';
                makes.forEach(m => { select.innerHTML += `<option value="${m}">${m}</option>`; });
            } catch (e) {
                select.innerHTML = '<option value="">Make</option>';
            }
        }

        async function quickLoadModels() {
            const year = document.getElementById('quickYear').value;
            const make = document.getElementById('quickMake').value;
            const select = document.getElementById('quickModel');

            if (!make) {
                select.innerHTML = '<option value="">Model</option>';
                return;
            }
            select.innerHTML = '<option value="">Loading...</option>';

            try {
                const res = await fetch(`${API}/api/master?year=${year}&make=${encodeURIComponent(make)}&limit=500`);
                const data = await res.json();
                const models = [...new Set(data.rows.map(r => r.model))].sort();
                select.innerHTML = '<option value="">Model</option>';
                models.forEach(m => { select.innerHTML += `<option value="${m}">${m}</option>`; });
            } catch (e) {
                select.innerHTML = '<option value="">Model</option>';
            }
        }

        async function quickSearch() {
            const year = document.getElementById('quickYear').value;
            const make = document.getElementById('quickMake').value;
            const model = document.getElementById('quickModel').value;

            if (!year || !make || !model) {
                alert('Please select year, make, and model');
                return;
            }

            document.getElementById('resultTitle').textContent = `${year} ${make} ${model}`;
            document.getElementById('resultsContainer').innerHTML = '<div class="loading">Loading...</div>';

            try {
                const res = await fetch(`${API}/api/browse?year=${year}&make=${encodeURIComponent(make)}&model=${encodeURIComponent(model)}&limit=10`);
                const data = await res.json();
                if (data.rows && data.rows.length > 0) {
                    displayResults(data.rows, year, make, model);
                } else {
                    document.getElementById('resultsContainer').innerHTML = '<div class="loading">No results found</div>';
                }
            } catch (e) {
                document.getElementById('resultsContainer').innerHTML = '<div class="loading">Failed to load</div>';
            }
        }

        // Populate quick search years when results are shown
        function initQuickSearch() {
            const select = document.getElementById('quickYear');
            if (select.options.length <= 1) {
                const year = new Date().getFullYear() + 1;
                for (let y = year; y >= 2000; y--) {
                    select.innerHTML += `<option value="${y}">${y}</option>`;
                }
            }
        }

        // ================== FCC DATABASE ==================

        let fccData = [];
        let fccDataLoaded = false;
        let fccPage = 1;
        let fccKeyType = 'all'; // 'all', 'push', 'non-push'
        const FCC_PER_PAGE = 20;

        // Determine if FCC ID is for a push-to-start key
        function isPushKey(row) {
            const vehicles = (row.vehicles || '').toLowerCase();
            const chip = (row.chip || '').toLowerCase();
            const freq = parseFloat(row.frequency) || 0;

            // Push keys typically: 433 MHz, prox/PEPS systems, modern chips
            const pushIndicators = ['peps', 'prox', 'smart key', 'push', 'intelligent key', 'keyless'];
            const pushChips = ['id47', 'id49', 'id4a', 'hitag pro', 'hitag-aes', 'hitag 3'];

            // Check for push indicators in vehicle/chip names
            const hasPushKeyword = pushIndicators.some(kw => vehicles.includes(kw) || chip.includes(kw));
            const hasPushChip = pushChips.some(c => chip.includes(c));

            // 433 MHz is commonly used for proximity keys
            const is433MHz = freq >= 433;

            return hasPushKeyword || hasPushChip || is433MHz;
        }

        function setFccFilter(type) {
            fccKeyType = type;
            fccPage = 1;
            // Update active button
            document.querySelectorAll('.fcc-filter').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.type === type);
            });
            renderFccTable();
        }

        async function loadFccData() {
            try {
                const res = await fetch(`${API}/api/fcc?limit=500`);
                const data = await res.json();
                fccData = data.rows || [];
                fccDataLoaded = true;
                populateFccYears();
                renderFccTable();
            } catch (e) {
                document.getElementById('fccTableBody').innerHTML = '<tr><td colspan="5" class="loading">Failed to load FCC data</td></tr>';
            }
        }

        function populateFccYears() {
            const fromSelect = document.getElementById('fccYearFrom');
            const toSelect = document.getElementById('fccYearTo');
            if (!fromSelect || !toSelect) return;

            const currentYear = new Date().getFullYear() + 1;
            for (let y = currentYear; y >= 1998; y--) {
                fromSelect.innerHTML += `<option value="${y}">${y}</option>`;
                toSelect.innerHTML += `<option value="${y}">${y}</option>`;
            }
        }

        function filterFccTable() {
            fccPage = 1;
            renderFccTable();
        }

        function renderFccTable() {
            const rawSearch = document.getElementById('fccSearch').value;
            const yearFrom = parseInt(document.getElementById('fccYearFrom')?.value) || 0;
            const yearTo = parseInt(document.getElementById('fccYearTo')?.value) || 9999;

            // Parse year from search string (e.g. "jeep 2012")
            const yearMatch = rawSearch.match(/\b(19\d{2}|20\d{2})\b/);
            const searchYear = yearMatch ? parseInt(yearMatch[1]) : null;
            const searchText = rawSearch.replace(/\b(19\d{2}|20\d{2})\b/g, '').trim().toLowerCase();

            // Filter by search and exclude garbage FCC IDs (< 5 chars)
            let filtered = fccData.filter(r => {
                const fccId = r.fcc_id || '';
                if (fccId.length < 5) return false; // Filter garbage like "ID"

                const matchesSearch = !searchText ||
                    fccId.toLowerCase().includes(searchText) ||
                    (r.vehicles || '').toLowerCase().includes(searchText);

                // Check if vehicle years match searched year
                if (matchesSearch && searchYear) {
                    const vehicles = r.vehicles || '';
                    const yearRanges = vehicles.match(/\((\d{4})-(\d{4})\)/g) || [];
                    const matchesYear = yearRanges.some(match => {
                        const [_, start, end] = match.match(/\((\d{4})-(\d{4})\)/);
                        return searchYear >= parseInt(start) && searchYear <= parseInt(end);
                    });
                    return matchesYear;
                }

                return matchesSearch;
            });

            // Apply year range filter (extract years from vehicles string)
            if (yearFrom || yearTo !== 9999) {
                filtered = filtered.filter(r => {
                    const vehicles = r.vehicles || '';
                    // Extract years from format like "(2014-2021)"
                    const yearMatches = vehicles.match(/\((\d{4})-(\d{4})\)/g) || [];
                    if (yearMatches.length === 0) return true; // Show if no year data

                    // Check if any year range overlaps with filter
                    return yearMatches.some(match => {
                        const [_, start, end] = match.match(/\((\d{4})-(\d{4})\)/);
                        return parseInt(end) >= yearFrom && parseInt(start) <= yearTo;
                    });
                });
            }

            // Apply key type filter
            if (fccKeyType === 'push') {
                filtered = filtered.filter(isPushKey);
            } else if (fccKeyType === 'non-push') {
                filtered = filtered.filter(r => !isPushKey(r));
            }

            const totalPages = Math.ceil(filtered.length / FCC_PER_PAGE);
            const start = (fccPage - 1) * FCC_PER_PAGE;
            const pageData = filtered.slice(start, start + FCC_PER_PAGE);

            const tbody = document.getElementById('fccTableBody');

            if (pageData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="loading">No FCC IDs found</td></tr>';
                return;
            }

            tbody.innerHTML = pageData.map(r => {
                const fccId = r.fcc_id || 'N/A';
                const vehicles = r.vehicles || 'N/A';
                const freq = r.frequency || 'N/A';
                const chip = r.chip || 'N/A';
                const oemPart = r.primary_oem_part || null;
                const primaryMake = r.primary_make || null;

                // Get first vehicle for Amazon search (fallback if no OEM part)
                const firstVehicle = vehicles !== 'N/A' ? vehicles.split(',')[0].trim() : null;
                const amazonLink = getAmazonLink(fccId, firstVehicle, oemPart, primaryMake);

                // Format vehicles list - show first 2, then count
                const vehicleList = vehicles !== 'N/A' ? vehicles.split(',').slice(0, 2).join(', ') : 'N/A';
                const vehicleCount = vehicles !== 'N/A' ? vehicles.split(',').length : 0;

                // Highlight search term in vehicles
                let highlightedVehicles = vehicleList;
                if (searchText && vehicleList !== 'N/A') {
                    const regex = new RegExp(`(${searchText})`, 'gi');
                    highlightedVehicles = vehicleList.replace(regex, '<mark style="background: var(--brand-primary); color: var(--bg-primary); padding: 0 2px; border-radius: 2px;">$1</mark>');
                }

                const moreLink = vehicleCount > 2
                    ? `<br><a href="#" onclick="showFccModal('${fccId}'); return false;" style="color: var(--brand-primary); font-size: 0.8rem;">+${vehicleCount - 2} more vehicles</a>`
                    : '';

                return `
                <tr>
                    <td>
                        <a href="#" class="fcc-link" onclick="showFccModal('${fccId}'); return false;">${fccId}</a>
                    </td>
                    <td style="max-width: 350px; font-size: 0.85rem; line-height: 1.4;">${highlightedVehicles}${moreLink}</td>
                    <td>${freq}${freq !== 'N/A' && !String(freq).includes('Hz') ? ' MHz' : ''}</td>
                    <td>${chip}</td>
                    <td class="hide-mobile"><a href="${amazonLink}" target="_blank" class="amazon-btn">üõí Amazon</a></td>
                </tr>
            `;
            }).join('');

            // Pagination
            document.getElementById('fccPagination').innerHTML = `
            <button onclick="fccPrev()" ${fccPage === 1 ? 'disabled' : ''}>‚Üê Prev</button>
            <span class="page-info">Page ${fccPage} of ${totalPages} (${filtered.length} results)</span>
            <button onclick="fccNext()" ${fccPage >= totalPages ? 'disabled' : ''}>Next ‚Üí</button>
        `;
        }

        function fccPrev() {
            if (fccPage > 1) {
                fccPage--;
                renderFccTable();
            }
        }

        function fccNext() {
            fccPage++;
            renderFccTable();
        }

        // ================== AMAZON AFFILIATE LINK ==================

        // Navigate to FCC Database and search for specific FCC ID
        function searchFccById(fccId) {
            showTab('fcc');
            document.getElementById('fccSearch').value = fccId;
            fccPage = 1;
            if (fccDataLoaded) {
                renderFccTable();
            } else {
                loadFccData();
            }
        }

        // Show FCC ID detail modal with all vehicles
        function showFccModal(fccId) {
            const record = fccData.find(r => r.fcc_id === fccId);
            if (!record) return;

            const vehicles = record.vehicles || 'N/A';
            const vehicleArray = vehicles !== 'N/A' ? vehicles.split(',').map(v => v.trim()) : [];
            const freq = record.frequency || 'N/A';
            const chip = record.chip || 'N/A';

            // Get first vehicle for Amazon search (for better matching)
            const firstVehicle = vehicleArray.length > 0 ? vehicleArray[0] : null;
            const amazonLink = getAmazonLink(fccId, firstVehicle);

            // Combine consecutive year ranges for same vehicle
            const combinedVehicles = combineVehicleYears(vehicleArray);

            const vehicleListHtml = combinedVehicles.length > 0
                ? `<ul class="modal-vehicle-list">${combinedVehicles.map(v => `<li>üöó ${v}</li>`).join('')}</ul>`
                : '<p style="color: var(--text-muted);">No vehicle data available</p>';

            document.getElementById('fccModalBody').innerHTML = `
        <div class="modal-title">FCC ID: ${fccId}</div>
        <div class="modal-subtitle">${combinedVehicles.length} compatible vehicle(s)</div>
        
        <div class="modal-info">
            <div class="modal-info-item">
                <div class="modal-info-label">Frequency</div>
                <div class="modal-info-value">${freq}${freq !== 'N/A' && !String(freq).includes('Hz') ? ' MHz' : ''}</div>
            </div>
            <div class="modal-info-item">
                <div class="modal-info-label">Chip</div>
                <div class="modal-info-value">${chip}</div>
            </div>
        </div>
        
        ${vehicleListHtml}
        
        <a href="${amazonLink}" target="_blank" class="modal-amazon">
            üõí Buy on Amazon
        </a>
    `;

            document.getElementById('fccModal').style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }

        // Combine vehicle entries with consecutive years into ranges
        function combineVehicleYears(vehicleArray) {
            // Group vehicles by make/model (without year range)
            const vehicleGroups = new Map();

            vehicleArray.forEach(vehicle => {
                // Parse format like "Hyundai Genesis G80 (2017-2017)"
                const match = vehicle.match(/^(.+?)\s*\((\d{4})-(\d{4})\)$/);
                if (match) {
                    const [, name, startYear, endYear] = match;
                    const key = name.trim();
                    if (!vehicleGroups.has(key)) {
                        vehicleGroups.set(key, []);
                    }
                    vehicleGroups.get(key).push({
                        start: parseInt(startYear),
                        end: parseInt(endYear)
                    });
                } else {
                    // No year range, keep as-is
                    vehicleGroups.set(vehicle, null);
                }
            });

            // Combine year ranges for each vehicle
            const result = [];
            vehicleGroups.forEach((years, name) => {
                if (years === null) {
                    result.push(name);
                } else if (years.length === 1) {
                    const { start, end } = years[0];
                    result.push(start === end ? `${name} (${start})` : `${name} (${start}-${end})`);
                } else {
                    // Sort by start year and merge overlapping/consecutive ranges
                    years.sort((a, b) => a.start - b.start);
                    const merged = [years[0]];
                    for (let i = 1; i < years.length; i++) {
                        const last = merged[merged.length - 1];
                        const curr = years[i];
                        if (curr.start <= last.end + 1) {
                            // Merge ranges
                            last.end = Math.max(last.end, curr.end);
                        } else {
                            merged.push(curr);
                        }
                    }
                    // Format merged ranges
                    const rangeStrs = merged.map(r => r.start === r.end ? `${r.start}` : `${r.start}-${r.end}`);
                    result.push(`${name} (${rangeStrs.join(', ')})`);
                }
            });

            return result;
        }

        function closeFccModal() {
            document.getElementById('fccModal').style.display = 'none';
            document.body.style.overflow = '';
        }

        // Show key photos from FCC external photos
        async function showKeyPhotos(fccId) {
            const modalBody = document.getElementById('keyPhotosModalBody');
            modalBody.innerHTML = '<div class="loading">Loading key photos...</div>';
            document.getElementById('keyPhotosModal').style.display = 'flex';
            document.body.style.overflow = 'hidden';

            // FCC report URLs
            const fccReportUrl = `https://fcc.report/FCC-ID/${fccId}`;

            // Try to fetch the FCC page to find the external photos document ID
            let externalPhotosUrl = fccReportUrl; // Fallback to main page
            let externalPhotosPdfUrl = null;

            try {
                // Use a CORS proxy or direct fetch (may work for some browsers)
                const corsProxy = 'https://corsproxy.io/?';
                const response = await fetch(corsProxy + encodeURIComponent(fccReportUrl));
                const html = await response.text();

                // Parse the HTML to find external photos link
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');

                // Find the link containing "external photos"
                const links = doc.querySelectorAll('a');
                for (const link of links) {
                    if (link.textContent.toLowerCase().includes('external photos')) {
                        const href = link.getAttribute('href');
                        if (href) {
                            externalPhotosUrl = 'https://fcc.report' + href;
                            externalPhotosPdfUrl = externalPhotosUrl + '.pdf';
                            break;
                        }
                    }
                }
            } catch (e) {
                console.log('Could not fetch FCC page directly, using fallback:', e);
            }

            modalBody.innerHTML = `
                <div class="modal-title">üì∑ Key Photos: ${fccId}</div>
                <div class="modal-subtitle">Official FCC external photos document</div>
                
                <div style="margin-top: 20px;">
                    <p style="color: var(--text-muted); margin-bottom: 16px; font-size: 0.9rem;">
                        View the official FCC external photos showing key fob images and configurations:
                    </p>
                    
                    ${externalPhotosPdfUrl ? `
                    <a href="${externalPhotosPdfUrl}" target="_blank" class="fcc-link-card" style="margin-bottom: 12px;">
                        <span style="font-size: 2.5rem; display: block; margin-bottom: 8px;">üìÑ</span>
                        <span style="color: var(--brand-primary); font-weight: 700; font-size: 1.1rem;">View External Photos PDF ‚Üí</span>
                        <br>
                        <span style="color: var(--text-muted); font-size: 0.85rem;">Opens PDF with key fob images</span>
                    </a>
                    ` : ''}
                    
                    <a href="${fccReportUrl}" target="_blank" class="fcc-link-card">
                        <span style="font-size: 2rem; display: block; margin-bottom: 8px;">üîç</span>
                        <span style="color: var(--text-secondary); font-weight: 600;">View All FCC Documents ‚Üí</span>
                        <br>
                        <span style="color: var(--text-muted); font-size: 0.85rem;">Internal photos, test reports, manuals</span>
                    </a>
                </div>
            `;
        }

        function closeKeyPhotosModal() {
            document.getElementById('keyPhotosModal').style.display = 'none';
            document.body.style.overflow = '';
        }

        function openLightbox(imgSrc) {
            document.getElementById('lightboxImage').src = imgSrc;
            document.getElementById('photoLightbox').style.display = 'flex';
        }

        function closeLightbox() {
            document.getElementById('photoLightbox').style.display = 'none';
        }

        function getAmazonLink(fccId, vehicleInfo = null, oemPart = null, make = null) {
            // Create Amazon search URL with affiliate tag
            // Priority: OEM part number > make + key terms (sellers use OEM parts, not FCC IDs)
            let searchTerm;

            if (oemPart && oemPart !== 'null') {
                // Best match: OEM part number (e.g., "68577124AB key fob")
                const vehicleMake = make || (vehicleInfo ? vehicleInfo.match(/^([A-Za-z]+)/)?.[1] : '') || '';
                searchTerm = `${vehicleMake} ${oemPart} key fob remote`.trim();
            } else if (vehicleInfo) {
                // Fallback: Extract make and model from vehicle info
                const makeMatch = vehicleInfo.match(/^([A-Za-z]+)/);
                const vehicleMake = makeMatch ? makeMatch[1] : '';
                const modelMatch = vehicleInfo.match(/^[A-Za-z]+\s+([A-Za-z0-9\s]+)\s*\(/);
                const vehicleModel = modelMatch ? modelMatch[1].trim() : '';
                searchTerm = `${vehicleMake} ${vehicleModel} key fob remote`.trim();
            } else {
                // Last resort: FCC ID (often doesn't match well)
                searchTerm = `${fccId} key fob remote`;
            }
            return `https://www.amazon.com/s?k=${encodeURIComponent(searchTerm)}&tag=${AFFILIATE_TAG}`;
        }

        // ================== GOOGLE OAUTH ==================

        // Google OAuth Client ID
        const GOOGLE_CLIENT_ID = '1057439383868-t1h9qf10acvad82bv0h9gg2jeufg30v4.apps.googleusercontent.com';

        let googleAuth = null;
        let currentUser = null;

        // Initialize Google Sign-In
        function initGoogleAuth() {
            // Check if user is already signed in (from localStorage)
            const savedUser = localStorage.getItem('eurokeys_user');
            if (savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);
                    updateAuthUI(true);
                } catch (e) {
                    localStorage.removeItem('eurokeys_user');
                }
            }
        }

        // Sign in with Google
        function signInWithGoogle() {
            // Check if Google Identity Services is loaded
            if (typeof google === 'undefined' || !google.accounts) {
                // Load the Google Identity Services library
                const script = document.createElement('script');
                script.src = 'https://accounts.google.com/gsi/client';
                script.async = true;
                script.defer = true;
                script.onload = () => initGoogleSignIn();
                document.head.appendChild(script);
            } else {
                initGoogleSignIn();
            }
        }

        // Initialize Google Sign-In popup
        function initGoogleSignIn() {
            if (GOOGLE_CLIENT_ID === 'YOUR_GOOGLE_CLIENT_ID.apps.googleusercontent.com') {
                alert('Please configure your Google OAuth Client ID in the application code.\n\nGo to Google Cloud Console ‚Üí APIs & Services ‚Üí Credentials to create an OAuth 2.0 Client ID.');
                return;
            }

            google.accounts.id.initialize({
                client_id: GOOGLE_CLIENT_ID,
                callback: handleGoogleSignIn,
                auto_select: false,
                ux_mode: 'popup'
            });

            // Show the One Tap UI or popup
            google.accounts.id.prompt((notification) => {
                if (notification.isNotDisplayed() || notification.isSkippedMoment()) {
                    // If One Tap is not displayed, use the button approach
                    google.accounts.oauth2.initTokenClient({
                        client_id: GOOGLE_CLIENT_ID,
                        scope: 'email profile',
                        callback: (response) => {
                            if (response.access_token) {
                                fetchUserProfile(response.access_token);
                            }
                        }
                    }).requestAccessToken();
                }
            });
        }

        // Handle Google Sign-In callback (for ID token flow)
        function handleGoogleSignIn(response) {
            if (response.credential) {
                // Decode the JWT token to get user info
                const payload = JSON.parse(atob(response.credential.split('.')[1]));
                currentUser = {
                    name: payload.name,
                    email: payload.email,
                    picture: payload.picture,
                    sub: payload.sub
                };
                localStorage.setItem('eurokeys_user', JSON.stringify(currentUser));
                updateAuthUI(true);
            }
        }

        // Fetch user profile using access token
        async function fetchUserProfile(accessToken) {
            try {
                const response = await fetch('https://www.googleapis.com/oauth2/v2/userinfo', {
                    headers: { Authorization: `Bearer ${accessToken}` }
                });
                const profile = await response.json();
                currentUser = {
                    name: profile.name,
                    email: profile.email,
                    picture: profile.picture,
                    sub: profile.id
                };
                localStorage.setItem('eurokeys_user', JSON.stringify(currentUser));
                updateAuthUI(true);
            } catch (e) {
                console.error('Failed to fetch user profile:', e);
            }
        }

        // Update the UI based on auth state
        function updateAuthUI(isSignedIn) {
            const signInBtn = document.getElementById('googleSignInBtn');
            const userMenu = document.getElementById('userMenu');
            const userName = document.getElementById('userName');
            const userAvatar = document.getElementById('userAvatar');

            if (isSignedIn && currentUser) {
                signInBtn.style.display = 'none';
                userMenu.style.display = 'flex';
                userName.textContent = currentUser.name.split(' ')[0]; // First name only

                // Show initials or profile picture
                if (currentUser.picture) {
                    userAvatar.innerHTML = `<img src="${currentUser.picture}" alt="${currentUser.name}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">`;
                } else {
                    const initials = currentUser.name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
                    userAvatar.innerHTML = initials;
                }
            } else {
                signInBtn.style.display = 'flex';
                userMenu.style.display = 'none';
            }
        }

        // Sign out
        function signOut() {
            if (confirm('Sign out of Euro Keys?')) {
                currentUser = null;
                localStorage.removeItem('eurokeys_user');
                updateAuthUI(false);

                // Revoke Google token if available
                if (typeof google !== 'undefined' && google.accounts) {
                    google.accounts.id.disableAutoSelect();
                }
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            populateYears();
            initGoogleAuth();
        });
    </script>
</body>

</html>