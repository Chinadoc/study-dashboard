<!DOCTYPE html>
<html lang="en" data-version="1.0.5">

<head>
    <!-- v1.0.4 - Restored InventoryManager.getAllKeys functionality -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Euro Keys">
    <link rel="manifest" href="/manifest.webmanifest">
    <link rel="apple-touch-icon" href="/assets/icon-192.png">
    <title>Euro Keys - Locksmith Database</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a1628;
            --bg-secondary: #111d32;
            --bg-tertiary: #1a2942;
            --brand-primary: #fbbf24;
            --brand-secondary: #f59e0b;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --success: #22c55e;
            --border: rgba(251, 191, 36, 0.15);
            --radius: 12px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: linear-gradient(180deg, var(--bg-primary) 0%, #0d1829 100%);
            color: var(--text-primary);
            min-height: 100vh;
        }

        /* Top Bar */
        .top-bar {
            background: var(--brand-primary);
            color: var(--bg-primary);
            text-align: center;
            padding: 10px;
            font-size: 0.9rem;
            font-weight: 600;
        }

        /* Header */
        .header {
            padding: 20px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--text-primary);
        }

        .logo span {
            color: var(--brand-primary);
        }

        .header-right {
            display: flex;
            gap: 16px;
            align-items: center;
        }

        .header-link {
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 0.9rem;
        }

        .header-avatar {
            width: 36px;
            height: 36px;
            background: var(--brand-primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: var(--bg-primary);
        }

        .google-signin-btn {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 20px;
            background: #ffffff;
            border: 1px solid #dadce0;
            border-radius: 24px;
            font-size: 0.9rem;
            font-weight: 500;
            color: #3c4043;
            cursor: pointer;
            transition: all 0.2s;
            font-family: 'Roboto', 'Inter', sans-serif;
        }

        .google-signin-btn:hover {
            background: #f7f8f8;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12);
        }

        .google-signin-btn svg {
            width: 18px;
            height: 18px;
        }

        .user-menu {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-menu .header-avatar {
            cursor: pointer;
        }

        .user-menu .user-name {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        /* Header Search */
        .header-search-container {
            display: flex;
            align-items: center;
            position: relative;
        }

        .header-search-toggle {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .header-search-toggle:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .header-search-box {
            position: absolute;
            right: 0;
            top: 100%;
            margin-top: 8px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 8px;
            display: flex;
            gap: 6px;
            z-index: 100;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
            animation: slideDown 0.2s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .header-search-box input {
            width: 220px;
            padding: 10px 14px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .header-search-box input:focus {
            outline: none;
            border-color: var(--brand-primary);
        }

        .header-search-box button {
            padding: 10px 16px;
            background: var(--brand-primary);
            border: none;
            border-radius: 8px;
            color: var(--bg-primary);
            font-weight: 600;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .header-search-box button.close-search {
            background: var(--bg-tertiary);
            color: var(--text-muted);
            padding: 10px 12px;
        }

        .header-search-box button:hover {
            opacity: 0.9;
        }

        @media (max-width: 768px) {
            .header-search-box {
                right: -60px;
                width: calc(100vw - 40px);
            }

            .header-search-box input {
                flex: 1;
                width: auto;
            }
        }

        .tabs {
            display: flex;
            justify-content: center;
            gap: 8px;
            padding: 16px 24px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
        }

        .tab {
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            background: transparent;
            color: var(--text-secondary);
        }

        .tab:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .tab.active {
            background: var(--brand-primary);
            color: var(--bg-primary);
        }

        /* Container */
        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 40px 24px;
        }

        /* Page Title */
        .page-title {
            text-align: center;
            margin-bottom: 12px;
        }

        .page-title h1 {
            font-size: 2.2rem;
            font-weight: 800;
        }

        .page-title h1 span {
            color: var(--brand-primary);
        }

        .page-subtitle {
            text-align: center;
            color: var(--text-secondary);
            margin-bottom: 32px;
            font-size: 1rem;
        }

        /* Browse Box */
        .browse-box {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 32px;
            max-width: 700px;
            margin: 0 auto 40px;
        }

        .browse-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin-bottom: 20px;
        }

        .browse-field {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .browse-label {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
        }

        .browse-select {
            padding: 16px 20px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            color: var(--text-primary);
            font-size: 1rem;
            font-family: inherit;
            cursor: pointer;
            appearance: none;
        }

        .browse-select:focus {
            outline: none;
            border-color: var(--brand-primary);
        }

        .search-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
            padding: 18px;
            background: var(--brand-primary);
            border: none;
            border-radius: var(--radius);
            color: var(--bg-primary);
            font-weight: 700;
            font-size: 1.1rem;
            cursor: pointer;
        }

        /* FCC Table */
        .fcc-search {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
        }

        /* FCC Filters */
        .fcc-filters {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .fcc-filter {
            padding: 10px 20px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 24px;
            color: var(--text-secondary);
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .fcc-filter:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .fcc-filter.active {
            background: var(--brand-primary);
            color: var(--bg-primary);
            border-color: var(--brand-primary);
        }

        .fcc-search input {
            flex: 1;
            padding: 14px 20px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            color: var(--text-primary);
            font-size: 1rem;
        }

        .fcc-search input::placeholder {
            color: var(--text-muted);
        }

        .fcc-search input:focus {
            outline: none;
            border-color: var(--brand-primary);
        }

        .fcc-table-wrapper {
            overflow-x: auto;
        }

        .fcc-table {
            width: 100%;
            border-collapse: collapse;
        }

        .fcc-table th {
            text-align: left;
            padding: 14px 12px;
            background: var(--bg-secondary);
            color: var(--text-muted);
            font-weight: 600;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid var(--border);
        }

        .fcc-table td {
            padding: 14px 12px;
            border-bottom: 1px solid var(--border);
            font-size: 0.9rem;
        }

        .fcc-table tr:hover {
            background: var(--bg-secondary);
        }

        .fcc-link {
            color: var(--brand-primary);
            text-decoration: none;
            font-weight: 600;
        }

        .fcc-link:hover {
            text-decoration: underline;
        }

        .amazon-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            background: #ff9900;
            color: #000;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 600;
            text-decoration: none;
            transition: all 0.2s;
        }

        .amazon-btn:hover {
            background: #ffad33;
            transform: translateY(-1px);
        }

        /* Mobile-First FCC Cards */
        .fcc-cards {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .fcc-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 20px;
            transition: all 0.3s ease;
        }

        .fcc-card:hover {
            border-color: var(--brand-primary);
            box-shadow: 0 8px 32px rgba(251, 191, 36, 0.15);
            transform: translateY(-2px);
        }

        .fcc-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
            gap: 12px;
        }

        .fcc-id-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            background: linear-gradient(135deg, var(--brand-primary), var(--brand-secondary));
            color: #000;
            border-radius: 24px;
            font-size: 0.9rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
        }

        .fcc-id-badge:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 16px rgba(251, 191, 36, 0.4);
        }

        .fcc-oem {
            padding: 6px 12px;
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            border-radius: 8px;
            font-size: 0.8rem;
            font-family: monospace;
        }

        .fcc-vehicles {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 16px;
        }

        .vehicle-chip {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 0.8rem;
            color: var(--text-primary);
            transition: all 0.2s;
        }

        .vehicle-chip:hover {
            background: var(--bg-primary);
            border-color: var(--brand-primary);
        }

        .vehicle-chip .make-icon {
            font-size: 1rem;
        }

        .vehicle-chip-more {
            background: rgba(251, 191, 36, 0.15);
            color: var(--brand-primary);
            border-color: var(--brand-primary);
            cursor: pointer;
        }

        /* Grouped Vehicle Styles */
        .fcc-card-image {
            width: 100%;
            height: 140px;
            background: var(--bg-primary);
            border-radius: 12px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            border: 1px solid var(--border);
            padding: 8px;
        }

        .fcc-card-image img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .vehicle-group-chip {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 0.8rem;
            color: var(--text-primary);
            margin: 0 4px 4px 0;
            transition: all 0.2s;
        }

        .vehicle-group-chip:hover {
            border-color: var(--brand-primary);
            background: var(--bg-secondary);
        }

        .vehicle-group-make {
            font-weight: 700;
            color: var(--brand-primary);
        }

        .vehicle-group-years {
            color: var(--text-muted);
            font-size: 0.75rem;
        }

        @media (max-width: 600px) {
            .fcc-card-image {
                height: 120px;
            }

            .vehicle-group-chip {
                padding: 4px 8px;
                font-size: 0.75rem;
            }
        }

        .fcc-card-meta {
            display: flex;
            gap: 16px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .fcc-meta-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .fcc-meta-item span:last-child {
            color: var(--text-primary);
            font-weight: 600;
        }

        .fcc-card-actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .fcc-action-btn {
            flex: 1;
            min-width: 120px;
            padding: 12px 16px;
            border-radius: 10px;
            font-size: 0.9rem;
            font-weight: 600;
            text-align: center;
            text-decoration: none;
            transition: all 0.2s;
        }

        .fcc-action-primary {
            background: linear-gradient(135deg, #ff9900, #ff6600);
            color: #000;
        }

        .fcc-action-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(255, 153, 0, 0.4);
        }

        .fcc-action-secondary {
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-primary);
            border: 1px solid var(--border);
            backdrop-filter: blur(8px);
        }

        .fcc-action-secondary:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: var(--brand-primary);
            transform: translateY(-2px);
        }

        /* Hide table on mobile, show cards */
        @media (max-width: 768px) {
            .fcc-table-wrapper {
                display: none;
            }

            .fcc-cards {
                display: flex;
            }
        }

        /* Show table on desktop, hide cards */
        @media (min-width: 769px) {
            .fcc-cards {
                display: none;
            }

            .fcc-table-wrapper {
                display: block;
            }
        }

        /* Beautiful modal vehicle list */
        .modal-vehicles-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            max-height: 200px;
            overflow-y: auto;
            padding: 12px;
            background: var(--bg-tertiary);
            border-radius: 12px;
            margin-bottom: 16px;
        }

        /* Vehicle Card */
        .vehicle-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 16px;
        }

        .vehicle-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
            flex-wrap: wrap;
            gap: 12px;
        }

        .vehicle-name {
            font-size: 1.25rem;
            font-weight: 700;
        }

        .vehicle-badges {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .badge-gold {
            background: var(--brand-primary);
            color: var(--bg-primary);
        }

        .badge-dark {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        /* Key Type Badges */
        .badge-transponder {
            background: linear-gradient(135deg, #10b981, #059669);
            color: #fff;
        }

        .badge-smartkey {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: #fff;
        }

        .badge-mechanical {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            border: 1px solid var(--border);
        }

        .badge-remotehead {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: #000;
        }

        .key-blank-refs {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-top: 8px;
        }

        .key-ref-chip {
            padding: 4px 8px;
            background: rgba(251, 191, 36, 0.1);
            border: 1px solid var(--brand-primary);
            border-radius: 4px;
            font-size: 0.7rem;
            font-family: monospace;
            color: var(--brand-primary);
        }

        /* Data Grid */
        .data-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
        }

        .data-item {
            padding: 14px;
            background: var(--bg-tertiary);
            border-radius: 10px;
        }

        .data-label {
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }

        .data-value {
            font-size: 0.9rem;
            font-weight: 600;
        }

        .data-value a {
            color: var(--brand-primary);
            text-decoration: none;
        }

        .data-value.highlight {
            color: var(--brand-primary);
        }

        /* Views */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Results Section */
        .results-section {
            display: none;
        }

        .results-section.active {
            display: block;
        }

        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .result-title {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .back-btn {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        /* Footer */
        .footer {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-muted);
            font-size: 0.85rem;
            border-top: 1px solid var(--border);
            margin-top: 60px;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 60px;
            color: var(--text-muted);
        }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-top: 24px;
        }

        .pagination button {
            padding: 10px 16px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            cursor: pointer;
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination .page-info {
            padding: 10px 16px;
            color: var(--text-muted);
        }

        @media (max-width: 768px) {
            .browse-grid {
                grid-template-columns: 1fr;
            }

            .data-grid {
                grid-template-columns: 1fr 1fr;
            }

            .page-title h1 {
                font-size: 1.6rem;
            }

            .tabs {
                flex-wrap: wrap;
            }

            .tab {
                font-size: 0.85rem;
                padding: 10px 16px;
            }

            .hide-mobile {
                display: none !important;
            }

            .fcc-table th:nth-child(3),
            .fcc-table td:nth-child(3),
            .fcc-table th:nth-child(4),
            .fcc-table td:nth-child(4) {
                display: none;
            }

            .fcc-filters {
                flex-direction: column;
                gap: 12px;
            }

            .fcc-filters>div {
                margin-left: 0 !important;
            }
        }

        /* Photo Gallery Styles */
        .photo-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 12px;
            margin-top: 16px;
        }

        .photo-thumbnail {
            aspect-ratio: 1;
            background: var(--bg-tertiary);
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .photo-thumbnail:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 20px rgba(251, 191, 36, 0.3);
        }

        .photo-thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .fcc-link-card {
            display: block;
            padding: 20px;
            background: var(--bg-tertiary);
            border: 1px solid var(--brand-primary);
            border-radius: 12px;
            text-decoration: none;
            text-align: center;
            transition: all 0.2s;
        }

        .fcc-link-card:hover {
            background: rgba(251, 191, 36, 0.1);
            transform: translateY(-2px);
        }

        .key-photos-btn {
            padding: 8px 16px;
            background: var(--bg-tertiary);
            border: 1px solid var(--brand-primary);
            color: var(--brand-primary);
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .key-photos-btn:hover {
            background: var(--brand-primary);
            color: var(--bg-primary);
        }

        /* Walkthrough Guide Styles */
        .walkthrough-toggle {
            padding: 8px 16px;
            background: var(--bg-tertiary);
            border: 1px solid var(--brand-primary);
            color: var(--brand-primary);
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .walkthrough-toggle:hover {
            background: var(--brand-primary);
            color: var(--bg-primary);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(251, 191, 36, 0.2);
        }

        .walkthrough-content {
            display: none;
            margin-top: 16px;
            padding: 24px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 16px;
            font-size: 0.95rem;
            line-height: 1.7;
            max-height: 600px;
            overflow-y: auto;
            position: relative;
            scrollbar-width: thin;
            scrollbar-color: var(--brand-primary) var(--bg-secondary);
        }

        .walkthrough-content::-webkit-scrollbar {
            width: 6px;
        }

        .walkthrough-content::-webkit-scrollbar-thumb {
            background-color: var(--brand-primary);
            border-radius: 20px;
        }

        .walkthrough-content.expanded {
            display: block;
            animation: slideDown 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .walkthrough-content h2 {
            color: var(--text-primary);
            font-size: 1.4rem;
            font-weight: 800;
            margin-bottom: 20px;
            letter-spacing: -0.02em;
            background: linear-gradient(to right, var(--brand-primary), var(--brand-secondary));
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .walkthrough-content h3 {
            color: var(--brand-primary);
            font-size: 1.1rem;
            font-weight: 700;
            margin-top: 24px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .walkthrough-content h3::before {
            content: '';
            display: inline-block;
            width: 4px;
            height: 18px;
            background: var(--brand-primary);
            border-radius: 2px;
        }

        .walkthrough-content h4 {
            color: var(--text-primary);
            font-size: 1rem;
            font-weight: 600;
            margin-top: 16px;
            margin-bottom: 8px;
        }

        .walkthrough-content table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin: 20px 0;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid var(--border);
        }

        .walkthrough-content th,
        .walkthrough-content td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        .walkthrough-content th {
            background: var(--bg-tertiary);
            color: var(--text-muted);
            font-weight: 600;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .walkthrough-content tr:last-child td {
            border-bottom: none;
        }

        .walkthrough-content td {
            background: var(--bg-primary);
            color: var(--text-secondary);
        }

        .walkthrough-content blockquote {
            margin: 20px 0;
            padding: 16px 20px;
            background: rgba(251, 191, 36, 0.05);
            border-left: 4px solid var(--brand-primary);
            border-radius: 0 12px 12px 0;
            font-style: italic;
            color: var(--text-primary);
        }

        .walkthrough-content blockquote.alert-tip {
            background: rgba(16, 185, 129, 0.05);
            border-left-color: #10b981;
        }

        .walkthrough-content blockquote.alert-warning {
            background: rgba(245, 158, 11, 0.05);
            border-left-color: #f59e0b;
        }

        .walkthrough-content blockquote.alert-important {
            background: rgba(239, 68, 68, 0.05);
            border-left-color: #ef4444;
        }

        .walkthrough-content ul,
        .walkthrough-content ol {
            padding-left: 20px;
            margin: 16px 0;
        }

        .walkthrough-content li {
            margin-bottom: 8px;
        }

        .walkthrough-content strong {
            color: var(--brand-primary);
        }

        .walkthrough-content hr {
            border: none;
            border-top: 1px solid var(--border);
            margin: 24px 0;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Programming Guide Styles */
        .programming-guide-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
            padding-bottom: 16px;
            margin-bottom: 24px;
        }

        .programming-guide-header h3 {
            margin: 0 !important;
            font-size: 1.25rem !important;
            background: linear-gradient(135deg, var(--brand-primary), #f59e0b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .programming-guide-body {
            font-size: 0.95rem;
            line-height: 1.7;
        }

        .guide-asset-block {
            margin-bottom: 24px;
            text-align: center;
        }

        .guide-infographic {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border: 1px solid var(--border);
        }

        .guide-asset-link {
            margin-bottom: 24px;
        }

        .pdf-download-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            background: rgba(59, 130, 246, 0.1);
            color: #60a5fa;
            border: 1px solid rgba(59, 130, 246, 0.2);
            border-radius: 6px;
            text-decoration: none;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .pdf-download-btn:hover {
            background: rgba(59, 130, 246, 0.2);
            transform: translateY(-1px);
        }

        .auth-required-badge {
            font-size: 0.8rem;
            color: var(--text-muted);
            padding: 8px 12px;
            background: var(--bg-tertiary);
            border-radius: 6px;
        }

        /* Job Logging Button */
        .btn-log-job {
            background: var(--brand-primary);
            background: linear-gradient(135deg, var(--brand-primary), #f59e0b);
            color: #000;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 700;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            box-shadow: 0 4px 12px rgba(251, 191, 36, 0.2);
        }

        .btn-log-job:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(251, 191, 36, 0.3);
            filter: brightness(1.05);
        }

        .btn-log-job:active {
            transform: translateY(0);
        }

        .btn-log-job:disabled {
            background: var(--bg-tertiary);
            color: var(--text-muted);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
            opacity: 0.7;
        }
    </style>
    <script>
        window.onerror = function (msg, url, line, col, error) {
            const div = document.createElement('div');
            div.style.cssText = 'position:fixed;top:0;left:0;right:0;background:red;color:white;padding:20px;z-index:99999;font-family:monospace;white-space:pre-wrap;';
            div.innerHTML = `ERROR: ${msg}\n${url}:${line}:${col}\n${error?.stack || ''}`;
            document.body.appendChild(div);
            return false;
        };
        window.addEventListener('unhandledrejection', function (event) {
            const div = document.createElement('div');
            div.style.cssText = 'position:fixed;top:0;left:0;right:0;background:orange;color:black;padding:20px;z-index:99999;font-family:monospace;white-space:pre-wrap;';
            div.innerHTML = `PROMISE ERROR: ${event.reason}`;
            document.body.appendChild(div);
        });
    </script>
    <style>
        /* Guide Specific Styles - Tailwind Polyfill */
        .bg-navy-800 {
            background-color: var(--bg-secondary) !important;
        }

        .bg-navy-900\/50 {
            background-color: rgba(10, 22, 40, 0.5) !important;
        }

        .bg-navy-700 {
            background-color: var(--bg-tertiary) !important;
        }

        .border-navy-700 {
            border-color: var(--bg-tertiary) !important;
        }

        .border-navy-600 {
            border-color: #334155 !important;
        }

        .text-brand-400 {
            color: var(--brand-primary) !important;
        }

        .text-slate-300 {
            color: var(--text-secondary) !important;
        }

        .text-white {
            color: #ffffff !important;
        }

        .text-2xl {
            font-size: 1.5rem !important;
            line-height: 2rem !important;
        }

        .font-bold {
            font-weight: 700 !important;
        }

        .font-semibold {
            font-weight: 600 !important;
        }

        .p-4 {
            padding: 1rem !important;
        }

        .p-6 {
            padding: 1.5rem !important;
        }

        .mb-2 {
            margin-bottom: 0.5rem !important;
        }

        .mb-4 {
            margin-bottom: 1rem !important;
        }

        .rounded-xl {
            border-radius: 0.75rem !important;
        }

        .rounded-lg {
            border-radius: 0.5rem !important;
        }

        .shadow-lg {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05) !important;
        }

        .space-y-6>*+* {
            margin-top: 1.5rem !important;
        }

        .space-y-2>*+* {
            margin-top: 0.5rem !important;
        }

        .list-decimal {
            list-style-type: decimal !important;
        }

        .list-inside {
            list-style-position: inside !important;
        }

        /* Alerts */
        .bg-red-500\/10 {
            background-color: rgba(239, 68, 68, 0.1) !important;
        }

        .border-red-500\/30 {
            border-color: rgba(239, 68, 68, 0.3) !important;
        }

        .text-red-400 {
            color: #f87171 !important;
        }

        .text-red-200\/80 {
            color: rgba(254, 202, 202, 0.8) !important;
        }

        .text-sm {
            font-size: 0.875rem !important;
        }
    </style>
</head>

<body>

    <!-- FCC Detail Modal -->
    <div id="fccModal" class="modal" style="display: none;">
        <div class="modal-overlay" onclick="closeFccModal()"></div>
        <div class="modal-content">
            <button class="modal-close" onclick="closeFccModal()">Ã—</button>
            <div id="fccModalBody"></div>
        </div>
    </div>

    <!-- Key Photos Modal -->
    <div id="keyPhotosModal" class="modal" style="display: none;">
        <div class="modal-overlay" onclick="closeKeyPhotosModal()"></div>
        <div class="modal-content" style="max-width: 700px;">
            <button class="modal-close" onclick="closeKeyPhotosModal()">Ã—</button>
            <div id="keyPhotosModalBody"></div>
        </div>
    </div>

    <!-- Lightbox for enlarged photos -->
    <div id="photoLightbox" onclick="closeLightbox()"
        style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 2000; align-items: center; justify-content: center; cursor: zoom-out;">
        <img id="lightboxImage" style="max-width: 95%; max-height: 95%; object-fit: contain;">
    </div>

    <!-- Job Logging Modal -->
    <div id="jobLogModal" class="job-modal-overlay" onclick="if(event.target === this) closeJobModal()">
        <div class="job-modal" style="max-width: 520px;">
            <div class="job-modal-header">
                <h3>ðŸ“‹ Log Job & Calculate Profit</h3>
                <button class="job-modal-close" onclick="closeJobModal()">Ã—</button>
            </div>
            <div class="job-modal-body">
                <div class="job-item-preview" id="jobItemPreview">
                    <div class="item-name" id="jobItemName">Item Name</div>
                    <div class="item-vehicle" id="jobItemVehicle"></div>
                </div>

                <form id="jobLogForm" onsubmit="submitJobLog(event)">
                    <input type="hidden" id="jobItemKey" />
                    <input type="hidden" id="jobItemType" />
                    <input type="hidden" id="jobDisplayTitle" />

                    <!-- Customer & Description -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                        <div class="job-form-group">
                            <label for="jobCustomer">Customer</label>
                            <input type="text" id="jobCustomer" placeholder="John Smith" />
                        </div>
                        <div class="job-form-group">
                            <label for="jobDescription">Vehicle/Job</label>
                            <input type="text" id="jobDescription" placeholder="2018 Camry" />
                        </div>
                    </div>

                    <!-- Revenue Section -->
                    <div
                        style="background: rgba(34, 197, 94, 0.1); padding: 12px; border-radius: 8px; margin: 12px 0; border: 1px solid rgba(34, 197, 94, 0.2);">
                        <div
                            style="font-size: 0.75rem; color: #4ade80; text-transform: uppercase; font-weight: 700; margin-bottom: 8px;">
                            ðŸ’µ Revenue</div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                            <div class="job-form-group" style="margin: 0;">
                                <label for="jobRevenue">Service Charged ($)</label>
                                <input type="number" id="jobRevenue" placeholder="150.00" step="0.01"
                                    oninput="calculateJobProfit()" />
                            </div>
                            <div class="job-form-group" style="margin: 0;">
                                <label for="jobTip">Tip ($)</label>
                                <input type="number" id="jobTip" placeholder="0.00" step="0.01" value="0"
                                    oninput="calculateJobProfit()" />
                            </div>
                        </div>
                    </div>

                    <!-- Costs Section -->
                    <div
                        style="background: rgba(239, 68, 68, 0.1); padding: 12px; border-radius: 8px; margin: 12px 0; border: 1px solid rgba(239, 68, 68, 0.2);">
                        <div
                            style="font-size: 0.75rem; color: #f87171; text-transform: uppercase; font-weight: 700; margin-bottom: 8px;">
                            ðŸ“‰ Costs</div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px;">
                            <div class="job-form-group" style="margin: 0;">
                                <label for="itemCost">Key Cost ($)</label>
                                <input type="number" id="itemCost" placeholder="35.00" step="0.01"
                                    oninput="calculateJobProfit()" />
                            </div>
                            <div class="job-form-group" style="margin: 0;">
                                <label for="jobMiles">Miles Driven</label>
                                <input type="number" id="jobMiles" placeholder="15" step="0.1"
                                    oninput="calculateJobProfit()" />
                            </div>
                            <div class="job-form-group" style="margin: 0;">
                                <label for="jobTimeMinutes">Time (min)</label>
                                <input type="number" id="jobTimeMinutes" placeholder="45" step="1"
                                    oninput="calculateJobProfit()" />
                            </div>
                        </div>
                    </div>

                    <!-- Profit Summary (Live Calculation) -->
                    <div id="profitSummary"
                        style="background: linear-gradient(135deg, #1e1e1e, #252525); padding: 16px; border-radius: 8px; margin: 12px 0; border: 1px solid #333;">
                        <div
                            style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; text-align: center;">
                            <div>
                                <div style="font-size: 0.65rem; color: var(--text-muted); text-transform: uppercase;">
                                    Gross</div>
                                <div id="calcGross" style="font-size: 1.1rem; font-weight: 700; color: #4ade80;">$0.00
                                </div>
                            </div>
                            <div>
                                <div style="font-size: 0.65rem; color: var(--text-muted); text-transform: uppercase;">
                                    Expenses</div>
                                <div id="calcExpenses" style="font-size: 1.1rem; font-weight: 700; color: #f87171;">
                                    $0.00</div>
                            </div>
                            <div>
                                <div style="font-size: 0.65rem; color: var(--text-muted); text-transform: uppercase;">
                                    Net Profit</div>
                                <div id="calcProfit"
                                    style="font-size: 1.1rem; font-weight: 700; color: var(--brand-primary);">$0.00
                                </div>
                            </div>
                            <div>
                                <div style="font-size: 0.65rem; color: var(--text-muted); text-transform: uppercase;">
                                    $/Hour</div>
                                <div id="calcHourly" style="font-size: 1.1rem; font-weight: 700; color: #60a5fa;">$0.00
                                </div>
                            </div>
                        </div>
                        <div
                            style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #333; display: flex; justify-content: space-between; font-size: 0.75rem; color: var(--text-muted);">
                            <span>Est. Tax (30%): <span id="calcTax" style="color: #fbbf24;">$0.00</span></span>
                            <span>Mileage: <span id="calcMileage" style="color: #a78bfa;">$0.00</span> @ $0.67/mi</span>
                        </div>
                    </div>

                    <!-- Notes -->
                    <div class="job-form-group">
                        <label for="jobNotes">Notes (Optional)</label>
                        <textarea id="jobNotes" placeholder="Any details..." style="height: 50px;"></textarea>
                    </div>

                    <div class="job-modal-actions">
                        <button type="button" class="btn-cancel-job" onclick="closeJobModal()">Cancel</button>
                        <button type="submit" class="btn-save-job">âœ“ Log Job & Use Item</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Upgrade to Pro Modal -->
    <div id="upgradeModal" class="modal" style="display: none;">
        <div class="modal-overlay" onclick="closeUpgradeModal()"></div>
        <div class="modal-content" style="max-width: 900px; padding: 0;">
            <button class="modal-close" onclick="closeUpgradeModal()" style="z-index: 10;">Ã—</button>

            <div class="upgrade-modal-layout">
                <!-- Header / Value Prop -->
                <div
                    style="background: linear-gradient(135deg, #1e293b, #0f172a); padding: 40px; text-align: center; border-radius: 12px 12px 0 0;">
                    <h2
                        style="font-size: 2rem; margin-bottom: 12px; background: linear-gradient(90deg, #fbbf24, #f59e0b); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent;">
                        Upgrade to Euro Keys Pro
                    </h2>
                    <p style="color: #94a3b8; font-size: 1.1rem; max-width: 600px; margin: 0 auto;">
                        Stop guessing on the job. Get full inventory control, offline access features, and priority
                        updates.
                    </p>
                </div>

                <!-- Pricing Cards -->
                <div style="padding: 40px; background: var(--bg-secondary);">

                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 24px;">

                        <!-- Monthly -->
                        <div class="price-card"
                            style="background: var(--bg-tertiary); padding: 24px; border-radius: 12px; border: 1px solid var(--border); position: relative;">
                            <h3 style="color: var(--text-primary); margin-bottom: 8px;">Monthly</h3>
                            <div
                                style="font-size: 2rem; font-weight: 700; color: var(--text-primary); margin-bottom: 16px;">
                                $9.99<span
                                    style="font-size: 1rem; color: var(--text-muted); font-weight: 400;">/mo</span>
                            </div>
                            <ul
                                style="list-style: none; padding: 0; margin-bottom: 24px; color: var(--text-secondary);">
                                <li style="margin-bottom: 8px;">âœ“ Full Inventory Management</li>
                                <li style="margin-bottom: 8px;">âœ“ Stock Alerts</li>
                                <li style="margin-bottom: 8px;">âœ“ Priority Support</li>
                            </ul>
                            <button onclick="startCheckout('monthly')"
                                style="width: 100%; padding: 12px; background: var(--bg-secondary); border: 1px solid var(--brand-primary); color: var(--brand-primary); border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                                Start Monthly
                            </button>
                        </div>

                        <!-- Annual (Best Value) -->
                        <div class="price-card"
                            style="background: #1e293b; padding: 24px; border-radius: 12px; border: 2px solid #fbbf24; position: relative; transform: scale(1.05); box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3);">
                            <div
                                style="position: absolute; top: -12px; left: 50%; transform: translateX(-50%); background: #fbbf24; color: #000; padding: 4px 12px; border-radius: 12px; font-size: 0.8rem; font-weight: 700;">
                                MOST POPULAR
                            </div>
                            <h3 style="color: white; margin-bottom: 8px;">Annual</h3>
                            <div style="font-size: 2rem; font-weight: 700; color: white; margin-bottom: 4px;">
                                $99<span style="font-size: 1rem; color: #94a3b8; font-weight: 400;">/yr</span>
                            </div>
                            <div style="color: #fbbf24; font-size: 0.85rem; margin-bottom: 16px;">Save ~17% vs
                                Monthly</div>
                            <ul style="list-style: none; padding: 0; margin-bottom: 24px; color: #e2e8f0;">
                                <li style="margin-bottom: 8px;">âœ“ Full Inventory Management</li>
                                <li style="margin-bottom: 8px;">âœ“ Stock Alerts</li>
                                <li style="margin-bottom: 8px;">âœ“ Priority Support</li>
                                <li style="margin-bottom: 8px;">âœ“ 2 Months Free</li>
                            </ul>
                            <button onclick="startCheckout('annual')"
                                style="width: 100%; padding: 12px; background: #fbbf24; border: none; color: #000; border-radius: 8px; font-weight: 700; cursor: pointer; transition: all 0.2s;">
                                Get Annual Plan
                            </button>
                        </div>

                        <!-- Lifetime -->
                        <div class="price-card"
                            style="background: var(--bg-tertiary); padding: 24px; border-radius: 12px; border: 1px solid var(--border);">
                            <h3 style="color: var(--text-primary); margin-bottom: 8px;">Lifetime</h3>
                            <div
                                style="font-size: 2rem; font-weight: 700; color: var(--text-primary); margin-bottom: 16px;">
                                $249
                            </div>
                            <ul
                                style="list-style: none; padding: 0; margin-bottom: 24px; color: var(--text-secondary);">
                                <li style="margin-bottom: 8px;">âœ“ One-time payment</li>
                                <li style="margin-bottom: 8px;">âœ“ All Pro Features Forever</li>
                                <li style="margin-bottom: 8px;">âœ“ No Recurring Fees</li>
                            </ul>
                            <button onclick="startCheckout('lifetime')"
                                style="width: 100%; padding: 12px; background: var(--bg-secondary); border: 1px solid var(--text-muted); color: var(--text-primary); border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                                Buy Lifetime
                            </button>
                        </div>

                    </div>

                    <div style="text-align: center; margin-top: 24px; color: var(--text-muted); font-size: 0.9rem;">
                        Secure payment processing via Stripe.
                        <a href="#" onclick="restorePurchases(); return false;"
                            style="color: var(--text-secondary); text-decoration: underline;">Restore Purchases</a>
                    </div>
                </div>
            </div>
            <style>
                .upgrade-modal-layout {
                    display: flex;
                    flex-direction: column;
                }

                @media (min-width: 768px) {
                    .upgrade-modal-layout {
                        flex-direction: column;
                    }
                }
            </style>
        </div>
    </div>

    <style>
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
        }

        .modal-content {
            position: relative;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 16px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            padding: 24px;
        }

        .modal-close {
            position: absolute;
            top: 12px;
            right: 16px;
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 24px;
            cursor: pointer;
        }

        .modal-close:hover {
            color: var(--text-primary);
        }

        .modal-title {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--brand-primary);
            margin-bottom: 8px;
        }

        .modal-subtitle {
            color: var(--text-muted);
            font-size: 0.9rem;
            margin-bottom: 20px;
        }

        .modal-vehicle-list {
            list-style: none;
            padding: 0;
            margin: 0 0 20px 0;
            max-height: 300px;
            overflow-y: auto;
        }

        .modal-vehicle-list li {
            padding: 10px 12px;
            border-bottom: 1px solid var(--border);
            font-size: 0.9rem;
        }

        .modal-vehicle-list li:last-child {
            border-bottom: none;
        }

        .modal-amazon {
            display: block;
            width: 100%;
            padding: 16px;
            background: var(--brand-primary);
            color: var(--bg-primary);
            text-align: center;
            text-decoration: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 700;
        }

        .modal-amazon:hover {
            opacity: 0.9;
        }

        /* Mechanical Codex Styles */
        .pro-data-section {
            margin-top: 16px;
            padding: 16px;
            background: rgba(251, 191, 36, 0.05);
            border: 1px solid rgba(251, 191, 36, 0.2);
            border-radius: 12px;
            position: relative;
            overflow: hidden;
        }

        .pro-data-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--brand-primary);
        }

        .pro-header {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.75rem;
            color: var(--brand-primary);
            text-transform: uppercase;
            font-weight: 800;
            margin-bottom: 12px;
            letter-spacing: 1px;
        }

        .mec-codex-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
            margin-bottom: 12px;
        }

        .mec-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .mec-label {
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .mec-value {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .pro-note {
            font-size: 0.85rem;
            color: var(--text-secondary);
            line-height: 1.5;
            padding-top: 12px;
            border-top: 1px solid rgba(251, 191, 36, 0.1);
            margin-top: 8px;
        }

        .modal-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 20px;
        }

        .modal-info-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 10px;
            border-radius: 8px;
        }

        .modal-info-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .modal-info-value {
            font-weight: 600;
            color: var(--text-primary);
        }

        /* Inventory Tracker Styles */
        .inventory-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .inventory-badge.in-stock {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
        }

        .inventory-badge.out-of-stock {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .inventory-controls {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            margin-left: 8px;
        }

        .inventory-btn {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: 1px solid var(--border);
            background: var(--bg-tertiary);
            color: var(--text-primary);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .inventory-btn:hover {
            background: var(--brand-primary);
            color: var(--bg-primary);
            border-color: var(--brand-primary);
        }

        .inventory-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        /* Stats Dashboard Styles */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .stats-card {
            background: var(--bg-tertiary);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid var(--border);
            text-align: center;
        }

        .stats-card h4 {
            color: var(--text-muted);
            margin: 0 0 8px 0;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stats-card .value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .stats-card .sub-value {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .alert-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.2);
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 12px;
        }

        .alert-item .alert-title {
            color: #ef4444;
            font-weight: 600;
        }

        .btn-log-job {
            padding: 6px 14px;
            background: linear-gradient(135deg, #3b82f6, #0ea5e9);
            border: none;
            color: white;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .btn-log-job:hover {
            background: linear-gradient(135deg, #2563eb, #0284c7);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .btn-log-job:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .inventory-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 0;
            border-top: 1px solid var(--border);
            margin-top: 8px;
        }

        /* Job Logging Modal */
        .job-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            /* Hidden by default */
            align-items: center;
            justify-content: center;
            z-index: 10000;
            padding: 20px;
        }

        .job-modal-overlay.active {
            display: flex !important;
        }

        .job-modal {
            background: var(--bg-secondary);
            border-radius: 16px;
            max-width: 480px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .job-modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .job-modal-header h3 {
            color: var(--text-primary);
            font-size: 1.1rem;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .job-modal-close {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 4px;
            line-height: 1;
        }

        .job-modal-close:hover {
            color: var(--text-primary);
        }

        .job-modal-body {
            padding: 24px;
        }

        .job-form-group {
            margin-bottom: 16px;
        }

        .job-form-group label {
            display: block;
            color: var(--text-secondary);
            font-size: 0.8rem;
            font-weight: 500;
            margin-bottom: 6px;
        }

        .job-form-group input,
        .job-form-group textarea {
            width: 100%;
            padding: 10px 14px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.9rem;
            font-family: inherit;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .job-form-group input:focus,
        .job-form-group textarea:focus {
            outline: none;
            border-color: var(--brand-primary);
            box-shadow: 0 0 0 3px rgba(252, 186, 3, 0.15);
        }

        .job-form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .job-item-preview {
            background: var(--bg-tertiary);
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid var(--border);
        }

        .job-item-preview .item-name {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.95rem;
        }

        .job-item-preview .item-vehicle {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .job-modal-actions {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        .job-modal-actions button {
            flex: 1;
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-cancel-job {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            color: var(--text-secondary);
        }

        .btn-cancel-job:hover {
            background: var(--bg-primary);
        }

        .btn-save-job {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            border: none;
            color: white;
        }

        .btn-save-job:hover {
            background: linear-gradient(135deg, #16a34a, #15803d);
            box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
        }
    </style>

    <div class="top-bar">ðŸ“ž Call (804) 506-0709</div>

    <header class="header">
        <div class="logo">ðŸ”‘ EURO <span>KEYS</span></div>
        <div class="header-right">
            <!-- Quick Search Toggle -->
            <div class="header-search-container">
                <button class="header-search-toggle" onclick="toggleHeaderSearch()" title="Quick Search">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"></circle>
                        <path d="m21 21-4.35-4.35"></path>
                    </svg>
                </button>
                <div id="headerSearchBox" class="header-search-box" style="display: none;">
                    <input type="text" id="headerSearchInput" placeholder="Search FCC ID, make, model..."
                        onkeypress="if(event.key==='Enter') headerQuickSearch()">
                    <button onclick="headerQuickSearch()">Go</button>
                    <button onclick="toggleHeaderSearch()" class="close-search">Ã—</button>
                </div>
            </div>

            <!-- User menu shows when signed in -->
            <div id="userMenu" class="user-menu" style="display: none; align-items: center; gap: 12px;">
                <button id="headerUpgradeBtn" onclick="startStripeCheckout()" style="
                    background: linear-gradient(135deg, #fbbf24, #f59e0b);
                    border: none;
                    color: #000;
                    padding: 6px 12px;
                    border-radius: 20px;
                    font-weight: 700;
                    font-size: 0.8rem;
                    cursor: pointer;
                    display: flex;
                    align-items: center;
                    gap: 4px;
                    box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);
                ">
                    <span style="font-size: 1rem;">ðŸ‘‘</span> Upgrade
                </button>
                <span class="user-name" id="userName" style="font-weight: 600; color: var(--text-primary);"></span>
                <div class="header-avatar" id="userAvatar" onclick="signOut()" style="cursor: pointer;"></div>
            </div>
            <!-- Google Sign In button shows when signed out -->
            <button id="googleSignInBtn" class="google-signin-btn" onclick="signInWithGoogle()">
                <svg viewBox="0 0 24 24">
                    <path fill="#4285F4"
                        d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" />
                    <path fill="#34A853"
                        d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" />
                    <path fill="#FBBC05"
                        d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" />
                    <path fill="#EA4335"
                        d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" />
                </svg>
                Sign in
            </button>
        </div>
    </header>

    <!-- Tabs -->
    <div class="tabs" id="mainTabs">
        <button class="tab active" onclick="showTab('browse')">ðŸ“‚ Browse Database</button>
        <button class="tab" onclick="showTab('fcc')">ðŸ“¡ FCC Database</button>
        <button class="tab" onclick="showTab('vin')">ðŸ” VIN Lookup</button>
        <button class="tab" id="inventoryTab" onclick="showTab('inventory')" style="display: none;">ðŸ“¦ My
            Inventory</button>
        <button class="tab" id="devTab" onclick="showTab('dev')" style="display: none;">ðŸ› ï¸ Dev Panel</button>
    </div>

    <!-- Browse Database Tab -->
    <div class="tab-content active" id="tabBrowse">
        <div id="browseSection">
            <div class="container">
                <div class="page-title">
                    <h1>Browse <span>Database</span></h1>
                </div>
                <p class="page-subtitle">Select vehicle details to view locksmith specifications.</p>

                <div class="browse-box">
                    <div class="browse-grid">
                        <div class="browse-field">
                            <label class="browse-label">Year</label>
                            <select class="browse-select" id="yearSelect" onchange="loadMakes()">
                                <option value="">Select Year</option>
                            </select>
                        </div>
                        <div class="browse-field">
                            <label class="browse-label">Make</label>
                            <select class="browse-select" id="makeSelect" onchange="loadModels()">
                                <option value="">Select Make</option>
                            </select>
                        </div>
                        <div class="browse-field">
                            <label class="browse-label">Model</label>
                            <select class="browse-select" id="modelSelect">
                                <option value="">Select Model</option>
                            </select>
                        </div>
                    </div>
                    <button class="search-btn" onclick="searchVehicle()">Search Database ðŸ”</button>
                </div>
            </div>
        </div>

        <div id="resultsSection" class="results-section">
            <div class="container">
                <div class="result-header">
                    <h2 class="result-title" id="resultTitle">Vehicle Results</h2>
                    <div class="result-actions">
                        <button class="back-btn" onclick="goBack()">ðŸ” New Search</button>
                    </div>
                </div>

                <!-- Quick vehicle switcher -->
                <div class="quick-search" style="display: flex; gap: 8px; margin-bottom: 20px; flex-wrap: wrap;">
                    <select class="browse-select" id="quickYear" onchange="quickLoadMakes()"
                        style="padding: 10px 14px; font-size: 0.9rem; flex: 1; min-width: 100px;">
                        <option value="">Year</option>
                    </select>
                    <select class="browse-select" id="quickMake" onchange="quickLoadModels()"
                        style="padding: 10px 14px; font-size: 0.9rem; flex: 1; min-width: 120px;">
                        <option value="">Make</option>
                    </select>
                    <select class="browse-select" id="quickModel"
                        style="padding: 10px 14px; font-size: 0.9rem; flex: 1; min-width: 120px;">
                        <option value="">Model</option>
                    </select>
                    <button onclick="quickSearch()"
                        style="padding: 10px 16px; background: var(--brand-primary); border: none; border-radius: 8px; color: var(--bg-primary); font-weight: 600; cursor: pointer; white-space: nowrap;">Go
                        â†’</button>
                </div>

                <div id="resultsContainer"></div>
            </div>
        </div>
    </div>

    <!-- FCC Database Tab -->
    <div class="tab-content" id="tabFcc">
        <div class="container">
            <div class="page-title">
                <h1>Key <span>Database</span> & Coverage</h1>
            </div>
            <p class="page-subtitle">Browse FCC IDs for key fobs and remotes with direct Amazon links.</p>

            <div class="fcc-filters" style="flex-wrap: wrap;">
                <button class="fcc-filter active" data-type="all" onclick="setFccFilter('all')">All Keys</button>
                <button class="fcc-filter" data-type="smart" onclick="setFccFilter('smart')">ðŸš— Smart/Prox</button>
                <button class="fcc-filter" data-type="transponder" onclick="setFccFilter('transponder')">ðŸ·ï¸
                    Transponder</button>
                <button class="fcc-filter" data-type="remote-head" onclick="setFccFilter('remote-head')">ðŸ”‘ Remote
                    Head</button>
                <button class="fcc-filter" data-type="flip" onclick="setFccFilter('flip')">ðŸ”„ Flip Key</button>
                <button class="fcc-filter" data-type="mechanical" onclick="setFccFilter('mechanical')">ðŸ—ï¸
                    Mechanical</button>

                <!-- Year filters hidden/moved if desired, or kept here -->
            </div>

            <!-- KEY DATABASE HEADER & HEATMAP CONTAINER -->
            <div id="keyCoverageContainer" style="margin-bottom: 24px;">
                <!-- Heatmap injected by renderKeyCoverageMap() -->
            </div>

            <div class="fcc-search" style="margin-top: 20px;">
                <input type="text" id="fccSearch" placeholder="ðŸ” Search keys... (e.g. 'Honda Civic 2018', 'HYQ12BDM')"
                    oninput="filterFccTable()">
            </div>

            <div class="fcc-table-wrapper">
                <table class="fcc-table">
                    <thead>
                        <tr>
                            <th>FCC ID</th>
                            <th>OEM Part #</th>
                            <th>Vehicles</th>
                            <th class="hide-mobile">Frequency</th>
                            <th class="hide-mobile">Chip</th>
                            <th>Stock</th>
                            <th>Amazon</th>
                        </tr>
                    </thead>
                    <tbody id="fccTableBody">
                        <tr>
                            <td colspan="7" class="loading">Loading FCC data...</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Mobile-first cards view -->
            <div class="fcc-cards" id="fccCards">
                <div class="loading" style="text-align: center; padding: 40px; color: var(--text-muted);">
                    Loading
                    FCC
                    data...</div>
            </div>

            <div class="pagination" id="fccPagination"></div>
        </div>
    </div>

    <!-- VIN Lookup Tab -->
    <div class="tab-content" id="tabVin">
        <div class="container">
            <div class="page-title">
                <h1>ðŸ” VIN <span>Lookup</span></h1>
            </div>
            <p class="page-subtitle">Enter a 17-digit VIN to instantly get key part numbers, transponder info, and buy
                links.</p>

            <!-- VIN Input Section -->
            <div class="browse-box" style="margin-bottom: 24px;">
                <div style="display: flex; gap: 12px; flex-wrap: wrap; align-items: flex-end;">
                    <div style="flex: 1; min-width: 250px;">
                        <label class="browse-label" style="margin-bottom: 8px; display: block;">Vehicle Identification
                            Number</label>
                        <input type="text" id="vinInput" placeholder="Enter 17-digit VIN (e.g., 1HGBH41JXMN109186)"
                            style="width: 100%; padding: 14px 18px; font-size: 1.1rem; letter-spacing: 2px; font-family: monospace; background: var(--bg-tertiary); border: 2px solid var(--border); border-radius: 10px; color: var(--text-primary); text-transform: uppercase;"
                            maxlength="17" onkeypress="if(event.key==='Enter') decodeVin()">
                    </div>
                    <button onclick="decodeVin()" class="search-btn" style="padding: 14px 28px; white-space: nowrap;">
                        Decode VIN ðŸš—
                    </button>
                    <button onclick="startVinCamera()" class="search-btn"
                        style="padding: 14px 20px; white-space: nowrap; background: linear-gradient(135deg, #4a1a5d, #6a2b7a);"
                        title="Scan VIN with camera">
                        ðŸ“· Scan
                    </button>
                </div>
                <div id="vinError" style="color: #ef4444; font-size: 0.85rem; margin-top: 8px; display: none;"></div>

                <!-- Camera Scanner Modal -->
                <div id="vinCameraModal"
                    style="display: none; margin-top: 16px; padding: 16px; background: var(--bg-tertiary); border-radius: 12px; border: 1px solid var(--border);">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <span style="font-weight: 600; color: var(--text-primary);">ðŸ“· VIN Camera Scanner</span>
                        <button onclick="stopVinCamera()"
                            style="background: #ef4444; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.85rem;">Close
                            âœ•</button>
                    </div>
                    <video id="vinCameraVideo"
                        style="width: 100%; max-height: 300px; border-radius: 8px; background: #000;" autoplay
                        playsinline></video>
                    <div style="margin-top: 12px; text-align: center;">
                        <button onclick="captureVinFrame()" class="search-btn" style="padding: 10px 24px;">ðŸ“¸ Capture &
                            Scan</button>
                    </div>
                    <canvas id="vinCameraCanvas" style="display: none;"></canvas>
                    <div id="vinScanResult"
                        style="margin-top: 12px; display: none; padding: 12px; background: rgba(34, 197, 94, 0.1); border-radius: 8px; border: 1px solid #22c55e;">
                        <span style="color: #22c55e; font-weight: 600;">Detected VIN: </span>
                        <span id="vinDetectedText"
                            style="font-family: monospace; letter-spacing: 2px; color: var(--text-primary);"></span>
                        <button onclick="useDetectedVin()"
                            style="margin-left: 12px; background: #22c55e; color: white; border: none; padding: 4px 12px; border-radius: 4px; cursor: pointer;">Use
                            This</button>
                    </div>
                </div>
            </div>

            <!-- Popular VINs by Make/Model -->
            <div style="margin-bottom: 24px;">
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">
                    <h3 style="margin: 0; color: var(--text-primary); font-size: 1.1rem;">ðŸ”¥ Popular Vehicle VINs (Click
                        to Lookup)</h3>
                    <button onclick="toggleVinList()" id="vinListToggle"
                        style="background: none; border: 1px solid var(--border); color: var(--text-secondary); padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.85rem;">Show
                        All â–¼</button>
                </div>
                <div id="popularVinGrid"
                    style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 12px;">
                    <!-- Toyota -->
                    <div onclick="lookupVin('JTDKN3DU5A0000001')" class="vin-quick-card"
                        style="background: var(--bg-tertiary); padding: 14px 16px; border-radius: 10px; border: 1px solid var(--border); cursor: pointer; transition: all 0.2s;"
                        onmouseover="this.style.borderColor='var(--brand-primary)'"
                        onmouseout="this.style.borderColor='var(--border)'">
                        <div style="font-weight: 700; color: var(--brand-primary);">Toyota Camry</div>
                        <div
                            style="font-family: monospace; font-size: 0.85rem; color: var(--text-muted); letter-spacing: 1px; margin-top: 4px;">
                            JTDKN3DU5A0...</div>
                        <div style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 2px;">2010+ â€¢ Smart
                            Key</div>
                    </div>
                    <!-- Honda -->
                    <div onclick="lookupVin('1HGBH41JXMN109186')" class="vin-quick-card"
                        style="background: var(--bg-tertiary); padding: 14px 16px; border-radius: 10px; border: 1px solid var(--border); cursor: pointer; transition: all 0.2s;"
                        onmouseover="this.style.borderColor='var(--brand-primary)'"
                        onmouseout="this.style.borderColor='var(--border)'">
                        <div style="font-weight: 700; color: var(--brand-primary);">Honda Accord</div>
                        <div
                            style="font-family: monospace; font-size: 0.85rem; color: var(--text-muted); letter-spacing: 1px; margin-top: 4px;">
                            1HGBH41JXMN...</div>
                        <div style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 2px;">2008+ â€¢ ILCO
                            HD106-PT</div>
                    </div>
                    <!-- Ford -->
                    <div onclick="lookupVin('1FAHP3F29CL000001')" class="vin-quick-card"
                        style="background: var(--bg-tertiary); padding: 14px 16px; border-radius: 10px; border: 1px solid var(--border); cursor: pointer; transition: all 0.2s;"
                        onmouseover="this.style.borderColor='var(--brand-primary)'"
                        onmouseout="this.style.borderColor='var(--border)'">
                        <div style="font-weight: 700; color: var(--brand-primary);">Ford Focus</div>
                        <div
                            style="font-family: monospace; font-size: 0.85rem; color: var(--text-muted); letter-spacing: 1px; margin-top: 4px;">
                            1FAHP3F29CL...</div>
                        <div style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 2px;">2012+ â€¢ Strattec
                            5921285</div>
                    </div>
                    <!-- Chevrolet -->
                    <div onclick="lookupVin('1G1YY22G965000001')" class="vin-quick-card"
                        style="background: var(--bg-tertiary); padding: 14px 16px; border-radius: 10px; border: 1px solid var(--border); cursor: pointer; transition: all 0.2s;"
                        onmouseover="this.style.borderColor='var(--brand-primary)'"
                        onmouseout="this.style.borderColor='var(--border)'">
                        <div style="font-weight: 700; color: var(--brand-primary);">Chevrolet Malibu</div>
                        <div
                            style="font-family: monospace; font-size: 0.85rem; color: var(--text-muted); letter-spacing: 1px; margin-top: 4px;">
                            1G1YY22G965...</div>
                        <div style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 2px;">2016+ â€¢ B111-PT
                        </div>
                    </div>
                </div>
                <!-- Hidden additional VINs -->
                <div id="moreVins" style="display: none; margin-top: 12px;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 12px;">
                        <!-- Nissan -->
                        <div onclick="lookupVin('1N4AA5AP9DC000001')" class="vin-quick-card"
                            style="background: var(--bg-tertiary); padding: 14px 16px; border-radius: 10px; border: 1px solid var(--border); cursor: pointer; transition: all 0.2s;"
                            onmouseover="this.style.borderColor='var(--brand-primary)'"
                            onmouseout="this.style.borderColor='var(--border)'">
                            <div style="font-weight: 700; color: var(--brand-primary);">Nissan Altima</div>
                            <div
                                style="font-family: monospace; font-size: 0.85rem; color: var(--text-muted); letter-spacing: 1px; margin-top: 4px;">
                                1N4AA5AP9DC...</div>
                            <div style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 2px;">2013+ â€¢
                                Intelligent Key</div>
                        </div>
                        <!-- BMW -->
                        <div onclick="lookupVin('WBAPH5C55BA000001')" class="vin-quick-card"
                            style="background: var(--bg-tertiary); padding: 14px 16px; border-radius: 10px; border: 1px solid var(--border); cursor: pointer; transition: all 0.2s;"
                            onmouseover="this.style.borderColor='var(--brand-primary)'"
                            onmouseout="this.style.borderColor='var(--border)'">
                            <div style="font-weight: 700; color: var(--brand-primary);">BMW 3 Series</div>
                            <div
                                style="font-family: monospace; font-size: 0.85rem; color: var(--text-muted); letter-spacing: 1px; margin-top: 4px;">
                                WBAPH5C55BA...</div>
                            <div style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 2px;">2011+ â€¢
                                HU92RP</div>
                        </div>
                        <!-- Mercedes -->
                        <div onclick="lookupVin('WDDGF81X79F000001')" class="vin-quick-card"
                            style="background: var(--bg-tertiary); padding: 14px 16px; border-radius: 10px; border: 1px solid var(--border); cursor: pointer; transition: all 0.2s;"
                            onmouseover="this.style.borderColor='var(--brand-primary)'"
                            onmouseout="this.style.borderColor='var(--border)'">
                            <div style="font-weight: 700; color: var(--brand-primary);">Mercedes C-Class</div>
                            <div
                                style="font-family: monospace; font-size: 0.85rem; color: var(--text-muted); letter-spacing: 1px; margin-top: 4px;">
                                WDDGF81X79F...</div>
                            <div style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 2px;">2009+ â€¢
                                Smart Key</div>
                        </div>
                        <!-- VW -->
                        <div onclick="lookupVin('3VW2K7AJ5DM000001')" class="vin-quick-card"
                            style="background: var(--bg-tertiary); padding: 14px 16px; border-radius: 10px; border: 1px solid var(--border); cursor: pointer; transition: all 0.2s;"
                            onmouseover="this.style.borderColor='var(--brand-primary)'"
                            onmouseout="this.style.borderColor='var(--border)'">
                            <div style="font-weight: 700; color: var(--brand-primary);">Volkswagen Jetta</div>
                            <div
                                style="font-family: monospace; font-size: 0.85rem; color: var(--text-muted); letter-spacing: 1px; margin-top: 4px;">
                                3VW2K7AJ5DM...</div>
                            <div style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 2px;">2013+ â€¢ HU66
                                Keyway</div>
                        </div>
                        <!-- Jeep -->
                        <div onclick="lookupVin('1C4RJFBG3EC000001')" class="vin-quick-card"
                            style="background: var(--bg-tertiary); padding: 14px 16px; border-radius: 10px; border: 1px solid var(--border); cursor: pointer; transition: all 0.2s;"
                            onmouseover="this.style.borderColor='var(--brand-primary)'"
                            onmouseout="this.style.borderColor='var(--border)'">
                            <div style="font-weight: 700; color: var(--brand-primary);">Jeep Grand Cherokee</div>
                            <div
                                style="font-family: monospace; font-size: 0.85rem; color: var(--text-muted); letter-spacing: 1px; margin-top: 4px;">
                                1C4RJFBG3EC...</div>
                            <div style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 2px;">2014+ â€¢
                                FOBIK</div>
                        </div>
                        <!-- Hyundai -->
                        <div onclick="lookupVin('5NPE24AF8FH000001')" class="vin-quick-card"
                            style="background: var(--bg-tertiary); padding: 14px 16px; border-radius: 10px; border: 1px solid var(--border); cursor: pointer; transition: all 0.2s;"
                            onmouseover="this.style.borderColor='var(--brand-primary)'"
                            onmouseout="this.style.borderColor='var(--border)'">
                            <div style="font-weight: 700; color: var(--brand-primary);">Hyundai Sonata</div>
                            <div
                                style="font-family: monospace; font-size: 0.85rem; color: var(--text-muted); letter-spacing: 1px; margin-top: 4px;">
                                5NPE24AF8FH...</div>
                            <div style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 2px;">2015+ â€¢
                                Smart Key</div>
                        </div>
                        <!-- Kia -->
                        <div onclick="lookupVin('5XYZU3LB7DG000001')" class="vin-quick-card"
                            style="background: var(--bg-tertiary); padding: 14px 16px; border-radius: 10px; border: 1px solid var(--border); cursor: pointer; transition: all 0.2s;"
                            onmouseover="this.style.borderColor='var(--brand-primary)'"
                            onmouseout="this.style.borderColor='var(--border)'">
                            <div style="font-weight: 700; color: var(--brand-primary);">Kia Sorento</div>
                            <div
                                style="font-family: monospace; font-size: 0.85rem; color: var(--text-muted); letter-spacing: 1px; margin-top: 4px;">
                                5XYZU3LB7DG...</div>
                            <div style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 2px;">2013+ â€¢
                                SY5HMFNA04</div>
                        </div>
                        <!-- Subaru -->
                        <div onclick="lookupVin('JF2SJAHC5FH000001')" class="vin-quick-card"
                            style="background: var(--bg-tertiary); padding: 14px 16px; border-radius: 10px; border: 1px solid var(--border); cursor: pointer; transition: all 0.2s;"
                            onmouseover="this.style.borderColor='var(--brand-primary)'"
                            onmouseout="this.style.borderColor='var(--border)'">
                            <div style="font-weight: 700; color: var(--brand-primary);">Subaru Forester</div>
                            <div
                                style="font-family: monospace; font-size: 0.85rem; color: var(--text-muted); letter-spacing: 1px; margin-top: 4px;">
                                JF2SJAHC5FH...</div>
                            <div style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 2px;">2015+ â€¢
                                Smart Key</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- VIN Results Section -->
            <div id="vinResults" style="display: none;">
                <!-- Vehicle Info Banner -->
                <div id="vinVehicleInfo"
                    style="background: linear-gradient(135deg, var(--bg-tertiary), var(--bg-secondary)); padding: 20px 24px; border-radius: 12px; border: 1px solid var(--border); margin-bottom: 24px;">
                </div>

                <!-- Key Parts Grid -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">

                    <!-- Key Blank Section -->
                    <div class="vin-result-card"
                        style="background: var(--bg-tertiary); border-radius: 12px; padding: 20px; border: 1px solid var(--border);">
                        <div
                            style="display: flex; align-items: center; gap: 10px; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid var(--border);">
                            <span style="font-size: 1.5rem;">ðŸ”‘</span>
                            <h3 style="margin: 0; color: var(--brand-primary);">Key Blank</h3>
                        </div>
                        <div id="vinKeyBlank" class="vin-data-grid"></div>
                    </div>

                    <!-- Transponder Section -->
                    <div class="vin-result-card"
                        style="background: var(--bg-tertiary); border-radius: 12px; padding: 20px; border: 1px solid var(--border);">
                        <div
                            style="display: flex; align-items: center; gap: 10px; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid var(--border);">
                            <span style="font-size: 1.5rem;">ðŸ·ï¸</span>
                            <h3 style="margin: 0; color: var(--brand-primary);">Transponder / Chip</h3>
                        </div>
                        <div id="vinTransponder" class="vin-data-grid"></div>
                    </div>

                    <!-- Remote / FOB Section -->
                    <div class="vin-result-card"
                        style="background: var(--bg-tertiary); border-radius: 12px; padding: 20px; border: 1px solid var(--border);">
                        <div
                            style="display: flex; align-items: center; gap: 10px; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid var(--border);">
                            <span style="font-size: 1.5rem;">ðŸ“¡</span>
                            <h3 style="margin: 0; color: var(--brand-primary);">Remote / Key Fob</h3>
                        </div>
                        <div id="vinRemote" class="vin-data-grid"></div>
                    </div>

                    <!-- Programming Section -->
                    <div class="vin-result-card"
                        style="background: var(--bg-tertiary); border-radius: 12px; padding: 20px; border: 1px solid var(--border);">
                        <div
                            style="display: flex; align-items: center; gap: 10px; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid var(--border);">
                            <span style="font-size: 1.5rem;">ðŸ› ï¸</span>
                            <h3 style="margin: 0; color: var(--brand-primary);">Programming Info</h3>
                        </div>
                        <div id="vinProgramming" class="vin-data-grid"></div>
                    </div>
                </div>

                <!-- Buy Links Section -->
                <div id="vinBuyLinks"
                    style="margin-top: 24px; background: linear-gradient(135deg, #1a472a, #2d5a3f); border-radius: 12px; padding: 20px; border: 1px solid #3d7a5a;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 16px;">
                        <span style="font-size: 1.5rem;">ðŸ›’</span>
                        <h3 style="margin: 0; color: #4ade80;">Buy Parts on Amazon</h3>
                    </div>
                    <div id="vinAmazonLinks" style="display: flex; gap: 12px; flex-wrap: wrap;"></div>
                </div>
            </div>

            <!-- Loading State -->
            <div id="vinLoading" style="display: none; text-align: center; padding: 60px; color: var(--text-muted);">
                <div style="font-size: 2rem; margin-bottom: 12px;">ðŸ”„</div>
                <div>Decoding VIN...</div>
            </div>
        </div>
    </div>

    <!-- Developer Panel Tab (only visible to developers) -->
    <div class="tab-content" id="tabDev" style="display: none;">
        <div class="container">
            <div class="page-title">
                <h1>ðŸ› ï¸ Developer <span>Panel</span></h1>
            </div>
            <p class="page-subtitle">User analytics and activity tracking dashboard.</p>

            <!-- Stats Cards -->
            <div id="devStats"
                style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-top: 24px;">
                <div
                    style="background: var(--glass-bg); border-radius: 16px; padding: 20px; border: 1px solid var(--glass-border);">
                    <div style="font-size: 2rem; font-weight: 800; color: var(--text-primary);" id="devTotalUsers">-
                    </div>
                    <div style="color: var(--text-muted); font-size: 0.9rem;">Total Users</div>
                </div>
                <div
                    style="background: var(--glass-bg); border-radius: 16px; padding: 20px; border: 1px solid var(--glass-border);">
                    <div style="font-size: 2rem; font-weight: 800; color: var(--brand-primary);" id="devProUsers">-
                    </div>
                    <div style="color: var(--text-muted); font-size: 0.9rem;">Pro Subscribers</div>
                </div>
                <div
                    style="background: var(--glass-bg); border-radius: 16px; padding: 20px; border: 1px solid var(--glass-border);">
                    <div style="font-size: 2rem; font-weight: 800; color: var(--text-secondary);" id="devActivities">-
                    </div>
                    <div style="color: var(--text-muted); font-size: 0.9rem;">Activities Today</div>
                </div>
            </div>

            <!-- Users Table -->
            <div style="margin-top: 32px;">
                <h3 style="color: var(--text-primary); margin-bottom: 16px;">ðŸ‘¥ Registered Users</h3>
                <div
                    style="background: var(--glass-bg); border-radius: 16px; border: 1px solid var(--glass-border); overflow: hidden;">
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: rgba(255,255,255,0.03);">
                                    <th
                                        style="padding: 12px 16px; text-align: left; color: var(--text-muted); font-weight: 600; font-size: 0.85rem;">
                                        User</th>
                                    <th
                                        style="padding: 12px 16px; text-align: left; color: var(--text-muted); font-weight: 600; font-size: 0.85rem;">
                                        Email</th>
                                    <th
                                        style="padding: 12px 16px; text-align: center; color: var(--text-muted); font-weight: 600; font-size: 0.85rem;">
                                        Status</th>
                                    <th
                                        style="padding: 12px 16px; text-align: center; color: var(--text-muted); font-weight: 600; font-size: 0.85rem;">
                                        Activities</th>
                                    <th
                                        style="padding: 12px 16px; text-align: left; color: var(--text-muted); font-weight: 600; font-size: 0.85rem;">
                                        Signed Up</th>
                                    <th
                                        style="padding: 12px 16px; text-align: left; color: var(--text-muted); font-weight: 600; font-size: 0.85rem;">
                                        Last Active</th>
                                </tr>
                            </thead>
                            <tbody id="devUsersTable">
                                <tr>
                                    <td colspan="6"
                                        style="padding: 40px; text-align: center; color: var(--text-muted);">Loading
                                        users...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Activity Log -->
            <div style="margin-top: 32px;">
                <h3 style="color: var(--text-primary); margin-bottom: 16px;">ðŸ“Š Recent Activity</h3>
                <div id="devActivityLog"
                    style="background: var(--glass-bg); border-radius: 16px; border: 1px solid var(--glass-border); padding: 16px; max-height: 400px; overflow-y: auto;">
                    <div style="text-align: center; padding: 40px; color: var(--text-muted);">Loading activity...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Inventory Tab (only visible when signed in) -->
    <div class="tab-content" id="tabInventory" style="display: none;">
        <div class="container">
            <div class="page-title">
                <h1>ðŸ“¦ My <span>Inventory</span></h1>
            </div>
            <p class="page-subtitle">Track your key fobs and key blanks in stock.</p>

            <div id="inventoryContent" style="margin-top: 24px;">
                <div style="text-align: center; padding: 60px 20px; color: var(--text-muted);">
                    <div style="font-size: 4rem; margin-bottom: 16px;">ðŸ“¦</div>
                    <h3 style="color: var(--text-primary); margin-bottom: 8px;">Your inventory is empty</h3>
                    <p>Browse vehicles and add keys to your inventory to track stock.</p>
                </div>
            </div>
        </div>
    </div>

    <footer class="footer">
        Â© 2025 Euro Keys<br>
        Professional Automotive Locksmith - Richmond, VA
    </footer>

    <script>
        const API = 'https://euro-keys.jeremy-samuels17.workers.dev';
        const AFFILIATE_TAG = 'eurokeys-20';

        // Valid makes only
        const VALID_MAKES = [
            'Acura', 'Alfa Romeo', 'Aston Martin', 'Audi', 'Bentley', 'BMW', 'Buick',
            'Cadillac', 'Chevrolet', 'Chrysler', 'Dodge', 'Ferrari', 'Fiat', 'Ford',
            'Genesis', 'GMC', 'Gmc', 'Honda', 'Hummer', 'Hyundai', 'Infiniti', 'Jaguar',
            'Jeep', 'Kia', 'Lamborghini', 'Land Rover', 'Lexus', 'Lincoln', 'Maserati',
            'Mazda', 'McLaren', 'Mercedes-Benz', 'Mercedes', 'Mercury', 'Mini',
            'Mitsubishi', 'Nissan', 'Oldsmobile', 'Pontiac', 'Porsche', 'Ram',
            'Rolls-Royce', 'Saab', 'Saturn', 'Scion', 'Subaru', 'Suzuki', 'Tesla',
            'Toyota', 'Volkswagen', 'Volvo'
        ];

        function isValidMake(make) {
            return VALID_MAKES.some(v => v.toLowerCase() === make.toLowerCase());
        }

        // Make logos mapping using logo.dev CDN
        function getMakeLogo(make) {
            const normalizedMake = make.toLowerCase().replace(/[^a-z]/g, '');
            const logoMappings = {
                'acura': 'https://logo.clearbit.com/acura.com',
                'alfaromeo': 'https://logo.clearbit.com/alfaromeo.com',
                'audi': 'https://logo.clearbit.com/audi.com',
                'bmw': 'https://logo.clearbit.com/bmw.com',
                'buick': 'https://logo.clearbit.com/buick.com',
                'cadillac': 'https://logo.clearbit.com/cadillac.com',
                'chevrolet': 'https://logo.clearbit.com/chevrolet.com',
                'chrysler': 'https://logo.clearbit.com/chrysler.com',
                'dodge': 'https://logo.clearbit.com/dodge.com',
                'ford': 'https://logo.clearbit.com/ford.com',
                'genesis': 'https://logo.clearbit.com/genesis.com',
                'gmc': 'https://logo.clearbit.com/gmc.com',
                'honda': 'https://logo.clearbit.com/honda.com',
                'hyundai': 'https://logo.clearbit.com/hyundai.com',
                'infiniti': 'https://logo.clearbit.com/infinitiusa.com',
                'jaguar': 'https://logo.clearbit.com/jaguar.com',
                'jeep': 'https://logo.clearbit.com/jeep.com',
                'kia': 'https://logo.clearbit.com/kia.com',
                'landrover': 'https://logo.clearbit.com/landrover.com',
                'lexus': 'https://logo.clearbit.com/lexus.com',
                'lincoln': 'https://logo.clearbit.com/lincoln.com',
                'mazda': 'https://logo.clearbit.com/mazda.com',
                'mercedesbenz': 'https://logo.clearbit.com/mercedes-benz.com',
                'mercedes': 'https://logo.clearbit.com/mercedes-benz.com',
                'mini': 'https://logo.clearbit.com/mini.com',
                'mitsubishi': 'https://logo.clearbit.com/mitsubishi.com',
                'nissan': 'https://logo.clearbit.com/nissan.com',
                'porsche': 'https://logo.clearbit.com/porsche.com',
                'ram': 'https://logo.clearbit.com/ramtrucks.com',
                'subaru': 'https://logo.clearbit.com/subaru.com',
                'tesla': 'https://logo.clearbit.com/tesla.com',
                'toyota': 'https://logo.clearbit.com/toyota.com',
                'volkswagen': 'https://logo.clearbit.com/volkswagen.com',
                'volvo': 'https://logo.clearbit.com/volvo.com',
            };
            return logoMappings[normalizedMake] || null;
        }

        let asinData = { products_by_fcc: {} };

        async function loadAsinData() {
            try {
                const res = await fetch('asin_based_affiliate_products.json');
                const data = await res.json();
                asinData = data;
            } catch (e) {
                console.error('Failed to load ASIN data local mapping');
            }
        }

        // Helper to group vehicles into chips
        function groupVehicles(vehicles) {
            const vehicleItems = vehicles ? vehicles.split(',').map(v => v.trim()).filter(v => v) : [];
            const groups = {};
            vehicleItems.forEach(vi => {
                const match = vi.match(/^([^(]+)\s+\((\d{4})(?:-(\d{4}))?\)$/);
                if (match) {
                    const makeModel = match[1].trim();
                    const startYear = parseInt(match[2]);
                    const endYear = match[3] ? parseInt(match[3]) : startYear;
                    if (!groups[makeModel]) {
                        groups[makeModel] = { start: startYear, end: endYear };
                    } else {
                        groups[makeModel].start = Math.min(groups[makeModel].start, startYear);
                        groups[makeModel].end = Math.max(groups[makeModel].end, endYear);
                    }
                } else {
                    if (!groups[vi]) groups[vi] = { start: null, end: null };
                }
            });
            return Object.entries(groups).map(([name, range]) => ({
                name,
                years: range.start ? (range.start === range.end ? `${range.start}` : `${range.start}-${range.end}`) : ''
            }));
        }

        // Tab switching with URL routing
        function showTab(tabName, updateHash = true) {
            // Update URL hash for deep linking (e.g., /#database, /#fcc, /#vin, /#inventory, /#dev)
            if (updateHash && window.location.hash !== `#${tabName}`) {
                history.pushState(null, '', `#${tabName}`);
            }

            // Log tab view activity
            if (currentUser) {
                logActivity('view_tab', { tab: tabName });
            }

            document.querySelectorAll('.tab').forEach((t, i) => {
                if (tabName === 'browse' && i === 0) t.classList.add('active');
                else if (tabName === 'fcc' && i === 1) t.classList.add('active');
                else if (tabName === 'vin' && i === 2) t.classList.add('active');
                else if (tabName === 'inventory' && i === 3) t.classList.add('active');
                else if (tabName === 'dev' && i === 4) t.classList.add('active');
                else t.classList.remove('active');
            });
            document.getElementById('tabBrowse').classList.toggle('active', tabName === 'browse');
            document.getElementById('tabFcc').classList.toggle('active', tabName === 'fcc');
            const tabVin = document.getElementById('tabVin');
            if (tabVin) {
                tabVin.classList.toggle('active', tabName === 'vin');
            }
            const tabInventory = document.getElementById('tabInventory');
            if (tabInventory) {
                tabInventory.style.display = tabName === 'inventory' ? 'block' : 'none';
                if (tabName === 'inventory') {
                    renderInventoryPage();
                }
            }
            const tabDev = document.getElementById('tabDev');
            if (tabDev) {
                tabDev.style.display = tabName === 'dev' ? 'block' : 'none';
                if (tabName === 'dev') {
                    loadDevPanel();
                }
            }

            if (tabName === 'fcc') {
                if (!fccDataLoaded) loadFccData();
                // Render/Refresh the Key Coverage Heatmap
                renderKeyCoverageMap();
            }
        }

        // Handle URL hash changes (back/forward buttons)
        window.addEventListener('hashchange', function () {
            const hash = window.location.hash.slice(1) || 'browse';
            const validTabs = ['browse', 'database', 'fcc', 'vin', 'inventory', 'dev'];
            const tabName = hash === 'database' ? 'browse' : hash;
            if (validTabs.includes(hash) || hash === 'database') {
                showTab(tabName, false);
            }
        });

        // Handle initial URL hash on page load
        function handleInitialRoute() {
            const hash = window.location.hash.slice(1);
            const validTabs = ['browse', 'database', 'fcc', 'vin', 'inventory', 'dev'];
            if (hash === 'database') {
                showTab('browse', false);
            } else if (validTabs.includes(hash)) {
                showTab(hash, false);
            }
        }

        // ================== HEADER QUICK SEARCH ==================

        function toggleHeaderSearch() {
            const searchBox = document.getElementById('headerSearchBox');
            const isVisible = searchBox.style.display !== 'none';
            searchBox.style.display = isVisible ? 'none' : 'flex';
            if (!isVisible) {
                document.getElementById('headerSearchInput').focus();
            }
        }

        function headerQuickSearch() {
            const query = document.getElementById('headerSearchInput').value.trim();
            if (!query) return;

            // Switch to FCC tab and search
            showTab('fcc');
            document.getElementById('fccSearch').value = query;
            toggleHeaderSearch(); // Close the search box

            if (fccDataLoaded) {
                renderFccTable();
            } else {
                loadFccData();
            }
        }

        // Close header search when clicking outside
        document.addEventListener('click', function (e) {
            const container = document.querySelector('.header-search-container');
            const searchBox = document.getElementById('headerSearchBox');
            if (container && searchBox && !container.contains(e.target) && searchBox.style.display !== 'none') {
                searchBox.style.display = 'none';
            }
        });

        // ================== WALKTHROUGH GUIDES ==================

        // Cache for loaded guides
        const guideCache = {};

        async function toggleGuide(make, model, idx) {
            const containerId = `guide-${idx}`;
            const container = document.getElementById(containerId);

            if (!container) return;

            // Toggle off if already expanded
            if (container.classList.contains('expanded')) {
                container.classList.remove('expanded');
                return;
            }

            // Check cache first
            const cacheKey = `${make.toLowerCase()}-${model.toLowerCase()}`;
            if (guideCache[cacheKey]) {
                container.innerHTML = guideCache[cacheKey];
                container.classList.add('expanded');
                return;
            }

            // Fetch guide from API
            container.innerHTML = '<div class="loading">Loading programming guide...</div>';
            container.classList.add('expanded');

            try {
                // Determine category based on context (default to AKL_PROCEDURE for now)
                const guideUrl = `${API}/api/guides?make=${encodeURIComponent(make)}&model=${encodeURIComponent(model)}&category=AKL_PROCEDURE`;
                console.log('Fetching guide:', guideUrl);
                const res = await fetch(guideUrl);
                const data = await res.json();
                console.log('Guide API response:', data);

                if (data.rows && data.rows.length > 0) {
                    console.log('Found guide, rendering content...');
                    const guide = data.rows[0];
                    const contentHtml = renderGuideContent(guide.content);

                    let assetsHtml = '';
                    if (guide.assets) {
                        if (guide.assets.infographic) {
                            assetsHtml += `
                                <div class="guide-asset-block">
                                    <img src="/api/assets/${guide.assets.infographic}" alt="${guide.make} Infographic" class="guide-infographic" loading="lazy">
                                </div>
                            `;
                        }
                        if (guide.assets.pdf) {
                            assetsHtml += `
                                <div class="guide-asset-link">
                                    <a href="/api/assets/${guide.assets.pdf}" target="_blank" class="pdf-download-btn">
                                        ðŸ“„ Download ${guide.assets.pdf_title || 'Technical Guide'} (PDF)
                                    </a>
                                </div>
                            `;
                        }
                    }

                    const html = `
                        <div class="programming-guide-header">
                            <h3>${guide.title || (make + ' ' + model)}</h3>
                            <button onclick="this.closest('.walkthrough-container').innerHTML=''" style="background:none; border:none; color:var(--text-muted); cursor:pointer;">âœ• Close</button>
                        </div>
                        ${assetsHtml}
                        <div class="programming-guide-body">
                            ${contentHtml}
                        </div>
                    `;

                    guideCache[cacheKey] = html;
                    container.innerHTML = html;
                } else {
                    console.log('No guide found in response');
                    container.innerHTML = '<div style="color: var(--text-muted); text-align: center; padding: 20px;">ðŸ“š No detailed programming guide available yet for this vehicle.</div>';
                }
            } catch (e) {
                console.error('Failed to load guide:', e);
                container.innerHTML = '<div style="color: #f87171; text-align: center;">Failed to load programming guide. Please try again.</div>';
            }
        }

        function renderGuideContent(markdown) {
            if (!markdown) return '';

            let html = markdown;

            // Process tables (simple conversion)
            html = html.replace(/\|(.+)\|\n\|[-:| ]+\|\n((?:\|.+\|\n?)+)/g, (match, header, body) => {
                const headerCells = header.split('|').filter(c => c.trim()).map(c => `<th>${c.trim()}</th>`).join('');
                const rows = body.trim().split('\n').map(row => {
                    const cells = row.split('|').filter(c => c.trim()).map(c => `<td>${c.trim()}</td>`).join('');
                    return `<tr>${cells}</tr>`;
                }).join('');
                return `<div class="table-container"><table><thead><tr>${headerCells}</tr></thead><tbody>${rows}</tbody></table></div>`;
            });

            // Alerts / Callouts (Custom Syntax Support)
            // Support > [!TIP] etc
            html = html.replace(/^> \[!TIP\] (.*)$/gm, '<blockquote class="alert-tip"><strong>ðŸ’¡ Tip:</strong> $1</blockquote>');
            html = html.replace(/^> \[!WARNING\] (.*)$/gm, '<blockquote class="alert-warning"><strong>âš ï¸ Warning:</strong> $1</blockquote>');
            html = html.replace(/^> \[!IMPORTANT\] (.*)$/gm, '<blockquote class="alert-important"><strong>ðŸš¨ Important:</strong> $1</blockquote>');
            html = html.replace(/^> ðŸ’¡ (.*)$/gm, '<blockquote class="alert-tip"><strong>ðŸ’¡ Tip:</strong> $1</blockquote>');
            html = html.replace(/^> âš ï¸ (.*)$/gm, '<blockquote class="alert-warning"><strong>âš ï¸ Warning:</strong> $1</blockquote>');
            html = html.replace(/^> ðŸš¨ (.*)$/gm, '<blockquote class="alert-important"><strong>ðŸš¨ Important:</strong> $1</blockquote>');

            // Headers
            html = html.replace(/^### (.*)$/gm, '<h4>$1</h4>');
            html = html.replace(/^## (.*)$/gm, '<h3>$1</h3>');
            html = html.replace(/^# (.*)$/gm, '<h2>$1</h2>');

            // Bold & Italic
            html = html.replace(/\*\*\*(.+?)\*\*\*/g, '<strong><em>$1</em></strong>');
            html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
            html = html.replace(/\*(.+?)\*/g, '<em>$1</em>');

            // Blockquotes (standard fallback)
            html = html.replace(/^> (.*)$/gm, '<blockquote>$1</blockquote>');

            // Horizontal rules
            html = html.replace(/^---$/gm, '<hr>');

            // Lists (Improved)
            html = html.replace(/^(\d+\.|-)\s+(.*)$/gm, (match, prefix, content) => {
                const type = prefix.includes('.') ? 'ol' : 'ul';
                return `<li data-type="${type}">${content}</li>`;
            });

            // Wrap contiguous <li> in <ul> or <ol>
            html = html.replace(/(?:<li data-type="(ul|ol)">.*?<\/li>\s*)+/g, (match, type) => {
                const tag = type === 'ol' ? 'ol' : 'ul';
                const items = match.replace(/ data-type="(ul|ol)"/g, '');
                return `<${tag}>${items}</${tag}>`;
            });

            // Line breaks
            // Preserve paragraphs but avoid double-spacing block elements
            html = html.replace(/\n\n/g, '</p><p>');
            html = html.replace(/\n/g, ' ');

            // R2 Asset Support (r2://bucket-path -> /api/assets/bucket-path)
            html = html.replace(/src="r2:\/\/([^"]+)"/g, 'src="/api/assets/$1"');
            html = html.replace(/href="r2:\/\/([^"]+)"/g, 'href="/api/assets/$1"');

            // Also support markdown syntax ![alt](r2://...) and [text](r2://...)
            html = html.replace(/!\[(.*?)\]\(r2:\/\/(.*?)\)/g, '<img src="/api/assets/$2" alt="$1" class="guide-image">');
            html = html.replace(/\[(.*?)\]\(r2:\/\/(.*?)\)/g, '<a href="/api/assets/$2" target="_blank">$1</a>');

            // Final wrap
            if (!html.startsWith('<p>') && !html.startsWith('<div') && !html.startsWith('<table') && !html.startsWith('<blockquote')) {
                html = '<p>' + html + '</p>';
            }

            // Clean up empty paragraphs and mis-wrapped block elements
            html = html.replace(/<p>\s*<(h[234]|table|blockquote|hr|ul|ol|div|img)/g, '<$1');
            html = html.replace(/<\/(h[234]|table|blockquote|hr|ul|ol|div|img)>\s*<\/p>/g, '</$1>');
            html = html.replace(/<p>\s*<\/p>/g, '');

            return html;
        }

        // ================== BROWSE DATABASE ==================

        function populateYears() {
            const select = document.getElementById('yearSelect');
            const year = new Date().getFullYear() + 1;
            for (let y = year; y >= 2000; y--) {
                select.innerHTML += `<option value="${y}">${y}</option>`;
            }
        }

        async function loadMakes() {
            const year = document.getElementById('yearSelect').value;
            const select = document.getElementById('makeSelect');

            if (!year) {
                select.innerHTML = '<option value="">Select Make</option>';
                return;
            }

            select.innerHTML = '<option value="">Loading...</option>';

            try {
                const res = await fetch(`${API}/api/master?year=${year}&limit=1000`);
                const data = await res.json();
                const makes = [...new Set(data.rows.map(r => r.make))]
                    .filter(isValidMake)
                    .sort();

                select.innerHTML = '<option value="">Select Make</option>';
                makes.forEach(m => {
                    select.innerHTML += `<option value="${m}">${m}</option>`;
                });
            } catch (e) {
                select.innerHTML = '<option value="">Select Make</option>';
            }
        }

        // Check if model name looks like a product description rather than a vehicle model
        function isValidModelName(model) {
            if (!model) return false;
            const badPatterns = [
                /keyless entry/i, /remote key/i, /key fob/i, /flip key/i,
                /smart key/i, /transponder/i, /key blank/i, /mechanical key/i,
                /\d+b\s*w/i,  // "5B w" truncated entries
                /\d+ button/i, /peps/i, /fobik/i, /80 bit/i, /high security/i,
                /proximity/i, /smart remote/i
            ];
            return !badPatterns.some(p => p.test(model));
        }

        async function loadModels() {
            const year = document.getElementById('yearSelect').value;
            const make = document.getElementById('makeSelect').value;
            const select = document.getElementById('modelSelect');

            if (!make) {
                select.innerHTML = '<option value="">Select Model</option>';
                return;
            }

            select.innerHTML = '<option value="">Loading...</option>';

            try {
                // Try new clean models endpoint first
                let res = await fetch(`${API}/api/models?year=${year}&make=${encodeURIComponent(make)}`);
                let data = await res.json();

                if (data.models && data.models.length > 0) {
                    // Use clean model names
                    const models = [...new Set(data.models.map(r => r.clean_model))]
                        .filter(m => m && m.length > 0)
                        .sort();

                    select.innerHTML = '<option value="">Select Model</option>';
                    models.forEach(m => {
                        select.innerHTML += `<option value="${m}">${m}</option>`;
                    });
                } else {
                    // Fallback to legacy endpoint if no clean models
                    res = await fetch(`${API}/api/master?year=${year}&make=${encodeURIComponent(make)}&limit=500`);
                    data = await res.json();
                    const models = [...new Set(data.rows.map(r => r.model))]
                        .filter(m => isValidModelName(m))
                        .sort();

                    select.innerHTML = '<option value="">Select Model</option>';
                    models.forEach(m => {
                        select.innerHTML += `<option value="${m}">${m}</option>`;
                    });
                }
            } catch (e) {
                console.error('Error loading models:', e);
                select.innerHTML = '<option value="">Select Model</option>';
            }
        }


        // Open the job logging modal (UI)
        window.openJobLogModal = function (itemKey, type, vehicle, amazonLink) {
            document.getElementById('jobItemKey').value = itemKey;
            document.getElementById('jobItemType').value = type;
            document.getElementById('jobCustomer').value = '';
            document.getElementById('jobDescription').value = vehicle ? `${vehicle} Key Programming` : 'Key Programming';
            document.getElementById('jobRevenue').value = '';

            // Try to find estimated cost from ASIN data
            let estimatedCost = '';
            if (typeof asinData !== 'undefined' && asinData.products_by_fcc) {
                const productEntry = asinData.products_by_fcc[itemKey];
                if (productEntry && productEntry.length > 0 && productEntry[0].price) {
                    // Price usually comes as "$34.95"
                    estimatedCost = productEntry[0].price.replace(/[$,]/g, '');
                }
            }
            document.getElementById('itemCost').value = estimatedCost;

            document.getElementById('jobNotes').value = amazonLink ? `Amazon Link: ${amazonLink}` : '';

            document.getElementById('jobItemName').textContent = type === 'blank' ? `Key Blank: ${itemKey}` : `FCC ID: ${itemKey}`;
            document.getElementById('jobItemVehicle').textContent = vehicle || 'Unknown Vehicle';

            document.querySelector('.job-modal').classList.add('active');
            document.querySelector('.job-modal-overlay').classList.add('active');
        }

        // Helper functions for displayResults
        function getAmazonLink(term) {
            return `https://www.amazon.com/s?k=${encodeURIComponent(term)}&tag=${AFFILIATE_TAG}`;
        }

        function getKeyTypeIcon(type) {
            const lower = (type || '').toLowerCase();
            if (lower.includes('smart') || lower.includes('prox')) return 'ðŸ“¡';
            if (lower.includes('flip')) return 'ðŸ”‘';
            if (lower.includes('remote') || lower.includes('fob')) return 'ðŸŽ›ï¸';
            if (lower.includes('transponder')) return 'ðŸ·ï¸';
            return 'ðŸ”‘';
        }

        function getMakeLogo(make) {
            // Simple mapping or return null to hide
            // In a real app, this might point to /assets/logos/...
            return null;
        }

        async function searchVehicle() {
            const year = document.getElementById('yearSelect').value;
            const make = document.getElementById('makeSelect').value;
            const model = document.getElementById('modelSelect').value;

            if (!year || !make || !model) {
                alert('Please select year, make, and model');
                return;
            }

            document.getElementById('resultTitle').textContent = `${year} ${make} ${model}`;
            document.getElementById('resultsContainer').innerHTML = '<div class="loading">Loading...</div>';

            document.getElementById('browseSection').style.display = 'none';
            document.getElementById('resultsSection').classList.add('active');
            initQuickSearch();

            try {
                const res = await fetch(`${API}/api/browse?year=${year}&make=${encodeURIComponent(make)}&model=${encodeURIComponent(model)}&limit=10`);
                const data = await res.json();

                if (data.rows && data.rows.length > 0) {
                    displayResults(data.rows, year, make, model);
                } else {
                    document.getElementById('resultsContainer').innerHTML = '<div class="loading">No results found</div>';
                }
            } catch (e) {
                console.error('Search failed:', e);
                document.getElementById('resultsContainer').innerHTML = '<div class="loading">Failed to load</div>';
            }
        }

        function displayResults(rows, year, make, model) {
            const container = document.getElementById('resultsContainer');

            // Deduplicate rows - prioritize FCC ID, only separate by OEM when FCC is N/A
            const seen = new Set();
            const uniqueRows = rows.filter(v => {
                const fccId = v.fcc_id || '';
                const oem = v.oem_part_number || '';
                // If FCC ID exists, use it as primary key (ignore OEM differences)
                // If no FCC ID, use OEM + key_type as key
                const key = fccId ? `FCC:${fccId}` : `OEM:${oem}-${v.key_type || ''}`;
                if (key && seen.has(key)) return false;
                if (key) seen.add(key);
                return true;
            });

            container.innerHTML = uniqueRows.map((v, idx) => {
                const fccId = v.fcc_id || 'N/A';
                const oem = v.oem_part_number || 'N/A';
                // Prefer direct ASIN link if available, otherwise search
                const amazonLink = v.primary_asin
                    ? `https://www.amazon.com/dp/${v.primary_asin}?tag=${AFFILIATE_TAG}`
                    : (fccId !== 'N/A' ? getAmazonLink(fccId) : null);
                const immo = v.immobilizer_system || v.immobilizer || 'N/A';
                const chip = v.chip || v.chip_technology || 'N/A';
                const freq = v.frequency ? `${v.frequency} MHz` : 'N/A';
                const keyway = v.keyway || 'N/A';
                const buttons = v.buttons || 'N/A';
                const battery = v.battery || 'N/A';

                // Key type from API or crossref
                const keyType = v.key_type || v.crossref_key_type || 'N/A';
                const keyTypeIcon = getKeyTypeIcon(keyType);

                // Key type display with color coding
                const keyTypeDisplay = v.key_type_display || '';
                const getKeyTypeBadgeClass = (type) => {
                    if (!type) return '';
                    const t = type.toLowerCase();
                    if (t.includes('transponder')) return 'badge-transponder';
                    if (t.includes('smart')) return 'badge-smartkey';
                    if (t.includes('remote head')) return 'badge-remotehead';
                    if (t.includes('mechanical')) return 'badge-mechanical';
                    return 'badge-dark';
                };
                const keyTypeBadgeClass = getKeyTypeBadgeClass(keyTypeDisplay);

                // Parse key_blank_refs JSON
                let keyBlankRefs = null;
                try {
                    if (v.key_blank_refs) {
                        keyBlankRefs = typeof v.key_blank_refs === 'string' ? JSON.parse(v.key_blank_refs) : v.key_blank_refs;
                    }
                } catch (e) { /* ignore parse errors */ }

                // Get image URL
                const imageUrl = v.image_url || v.remote_image || (fccId !== 'N/A' && v.has_image ? `${API}/api/assets/${fccId}.png` : null);

                // Aftermarket parts from part_crossref
                const ilco = v.ilco_part || (keyBlankRefs?.ilco?.[0]) || 'N/A';
                const strattec = v.strattec_part || (keyBlankRefs?.strattec?.[0]) || 'N/A';
                const jma = v.jma_part || 'N/A';
                const keydiy = v.keydiy_part || 'N/A';
                const hasAftermarket = ilco !== 'N/A' || strattec !== 'N/A' || jma !== 'N/A' || keydiy !== 'N/A' || (keyBlankRefs?.ilco?.length > 0);

                // Create card label based on what differentiates it
                let cardLabel = `${year} ${make} ${model}`;
                if (uniqueRows.length > 1) {
                    if (fccId !== 'N/A') {
                        cardLabel += ` â€¢ FCC: ${fccId}`;
                    } else if (oem !== 'N/A') {
                        cardLabel += ` â€¢ Part: ${oem}`;
                    } else {
                        cardLabel += ` â€¢ Variant ${idx + 1}`;
                    }
                }

                // FCC ID links to internal FCC Database
                const fccDisplay = fccId !== 'N/A'
                    ? `<a href="#" class="fcc-link" onclick="searchFccById('${fccId}'); return false;">${fccId}</a>`
                    : 'N/A';

                // YouTube search link
                const youtubeLink = `https://www.youtube.com/results?search_query=${encodeURIComponent(`${year} ${make} ${model} key programming Autel`)}`;

                // Get make logo
                const makeLogo = getMakeLogo(make);
                const logoHtml = makeLogo ? `<img src="${makeLogo}" alt="${make}" class="make-logo" onerror="this.style.display='none'" style="width: 28px; height: 28px; object-fit: contain; margin-right: 10px; border-radius: 4px;">` : '';

                // Check inventory stock for this key (if signed in)
                const keyInStock = currentUser && fccId !== 'N/A' ? InventoryManager.getKeyStock(fccId) : 0;
                const blankInStock = currentUser && keyway !== 'N/A' ? InventoryManager.getBlankStock(keyway) : 0;
                const inventoryBadge = keyInStock > 0
                    ? `<span class="badge" style="background: #22c55e; color: white;">ðŸ“¦ ${keyInStock} in stock</span>`
                    : blankInStock > 0
                        ? `<span class="badge" style="background: #22c55e; color: white;">ðŸ”‘ ${blankInStock} blanks</span>`
                        : '';

                return `
                <div class="vehicle-card" style="display: flex; flex-direction: column; gap: 12px;">
                    <div class="vehicle-card-header" style="border-bottom: 1px solid var(--border); padding-bottom: 12px; margin-bottom: 0;">
                        <div class="vehicle-name" style="display: flex; align-items: center;">
                            ${logoHtml}
                            <span class="make-link" onclick="quickSwitchMake('${make}')" style="cursor: pointer; color: var(--brand-primary);" title="View all ${make} models">${make}</span>
                            <span style="margin: 0 6px; color: var(--text-muted);">${model}</span>
                            ${uniqueRows.length > 1 ? `<span style="color: var(--text-muted); font-size: 0.85rem;">â€¢ ${fccId !== 'N/A' ? 'FCC: ' + fccId : oem !== 'N/A' ? 'Part: ' + oem : 'Variant ' + (idx + 1)}</span>` : ''}
                        </div>
                        <div class="vehicle-badges">
                            ${inventoryBadge}
                            ${keyTypeDisplay ? `<span class="badge ${keyTypeBadgeClass}">${keyTypeDisplay}</span>` : ''}
                            ${keyType !== 'N/A' ? `<span class="badge badge-dark">${keyTypeIcon} ${keyType}</span>` : ''}
                            <span class="badge badge-gold">${immo !== 'N/A' ? immo : 'Standard'}</span>
                        </div>
                    </div>

                    <div style="display: flex; gap: 16px; align-items: flex-start; flex-wrap: wrap;">
                        ${imageUrl ? `
                            <div class="fcc-card-image" style="width: 140px; height: 140px; margin-bottom: 0; flex-shrink: 0;" onclick="showFccModal('${fccId}')">
                                <img src="${imageUrl}" alt="${fccId}" onerror="this.style.display='none'">
                            </div>
                        ` : ''}
                        
                        <div class="data-grid" style="flex: 1; min-width: 250px; margin-top: 0;">
                            <div class="data-item">
                                <div class="data-label">FCC ID</div>
                                <div class="data-value highlight">${fccDisplay}</div>
                            </div>
                            <div class="data-item">
                                <div class="data-label">Chip</div>
                                <div class="data-value">${chip}</div>
                            </div>
                            <div class="data-item">
                                <div class="data-label">Frequency</div>
                                <div class="data-value">${freq}</div>
                            </div>
                            <div class="data-item">
                                <div class="data-label">Key Blank</div>
                                <div class="data-value">${keyway}</div>
                            </div>
                            <div class="data-item">
                                <div class="data-label">Buttons</div>
                                <div class="data-value">${buttons}</div>
                            </div>
                            <div class="data-item">
                                <div class="data-label">Battery</div>
                                <div class="data-value">${battery}</div>
                            </div>
                            <div class="data-item">
                                <div class="data-label">OEM Part #</div>
                                <div class="data-value">${oem}</div>
                            </div>
                            <div class="data-item">
                                <div class="data-label">Lishi Tool</div>
                                <div class="data-value">${v.lishi_tool || 'N/A'}</div>
                            </div>
                        </div>
                    </div>

                    <div class="vehicle-card-actions" style="display: flex; gap: 12px; margin-top: 8px; border-top: 1px solid var(--border); padding-top: 12px;">
                         ${amazonLink ? `<a href="${amazonLink}" target="_blank" class="fcc-action-btn fcc-action-primary" style="flex: 1; text-decoration: none; text-align: center;">ðŸ›’ Buy on Amazon</a>` : ''}
                         <button onclick="showFccModal('${fccId}')" class="fcc-action-btn fcc-action-secondary" style="flex: 1;">ðŸ” View Details</button>
                    </div>
                    
                    ${hasAftermarket ? `
                    <div style="margin-top: 4px; padding-top: 12px; border-top: 1px dashed var(--border);">
                        <div style="font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;">Aftermarket Parts (click to buy)</div>
                        <div style="display: flex; gap: 8px; flex-wrap: wrap; font-size: 0.85rem;">
                            ${ilco !== 'N/A' ? `<a href="https://www.amazon.com/s?k=${encodeURIComponent('ILCO ' + ilco + ' key blank')}&tag=eurokeys-20" target="_blank" style="background: linear-gradient(135deg, #1a472a, #2d5a3f); padding: 6px 12px; border-radius: 6px; border: 1px solid #3d7a5a; text-decoration: none; color: white; display: flex; align-items: center; gap: 6px; transition: all 0.2s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'"><span style="font-weight: 600;">ILCO</span> ${ilco} ðŸ›’</a>` : ''}
                            ${strattec !== 'N/A' ? `<a href="https://www.amazon.com/s?k=${encodeURIComponent('Strattec ' + strattec + ' key')}&tag=eurokeys-20" target="_blank" style="background: linear-gradient(135deg, #1a365d, #2b4c7a); padding: 6px 12px; border-radius: 6px; border: 1px solid #3d5a80; text-decoration: none; color: white; display: flex; align-items: center; gap: 6px; transition: all 0.2s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'"><span style="font-weight: 600;">Strattec</span> ${strattec} ðŸ›’</a>` : ''}
                            ${jma !== 'N/A' ? `<a href="https://www.amazon.com/s?k=${encodeURIComponent('JMA ' + jma + ' key blank')}&tag=eurokeys-20" target="_blank" style="background: linear-gradient(135deg, #5a3d1a, #7a5a2b); padding: 6px 12px; border-radius: 6px; border: 1px solid #8a6a3b; text-decoration: none; color: white; display: flex; align-items: center; gap: 6px; transition: all 0.2s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'"><span style="font-weight: 600;">JMA</span> ${jma} ðŸ›’</a>` : ''}
                            ${keydiy !== 'N/A' ? `<a href="https://www.amazon.com/s?k=${encodeURIComponent('KEYDIY ' + keydiy)}&tag=eurokeys-20" target="_blank" style="background: linear-gradient(135deg, #4a1a5d, #6a2b7a); padding: 6px 12px; border-radius: 6px; border: 1px solid #7a3b8a; text-decoration: none; color: white; display: flex; align-items: center; gap: 6px; transition: all 0.2s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'"><span style="font-weight: 600;">KEYDIY</span> ${keydiy} ðŸ›’</a>` : ''}
                        </div>
                    </div>
                    ` : ''}
                    
                    ${(fccId !== 'N/A' || oem !== 'N/A' || keyway !== 'N/A') ? `
                    <div style="margin-top: 12px; padding: 12px; background: var(--bg-tertiary); border-radius: 8px;">
                        <div style="font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;">ðŸ“¦ My Inventory</div>
                        ${getVehicleInventoryHtml(
                    oem !== 'N/A' ? oem : (fccId !== 'N/A' ? fccId : null),
                    keyway,
                    year + ' ' + make + ' ' + model,
                    oem !== 'N/A' ? 'https://www.amazon.com/s?k=' + encodeURIComponent(year + ' ' + make + ' ' + model + ' key fob ' + oem) + '&tag=eurokeys-20' : (fccId !== 'N/A' ? 'https://www.amazon.com/s?k=' + encodeURIComponent(year + ' ' + make + ' ' + model + ' key fob ' + fccId) + '&tag=eurokeys-20' : null),
                    keyway !== 'N/A' ? 'https://www.amazon.com/s?k=' + encodeURIComponent(keyway + ' key blank') + '&tag=eurokeys-20' : null
                )}
                    </div>
                    ` : ''}

                    ${v.mechanical_spec || v.code_series || v.service_notes_pro ? `
                    <div class="pro-data-section">
                        <div class="pro-header">
                            <span style="font-size: 1.1rem;">ðŸ› ï¸</span> Mechanical Codex
                        </div>
                        <div class="mec-codex-grid">
                            ${v.mechanical_spec ? `<div class="mec-item"><div class="mec-label">Key Spec</div><div class="mec-value">${v.mechanical_spec}</div></div>` : ''}
                            ${v.spaces ? `<div class="mec-item"><div class="mec-label">Spaces</div><div class="mec-value">${v.spaces}</div></div>` : ''}
                            ${v.depths ? `<div class="mec-item"><div class="mec-label">Depths</div><div class="mec-value">${v.depths}</div></div>` : ''}
                            ${v.code_series ? `<div class="mec-item"><div class="mec-label">Code Series</div><div class="mec-value">${v.code_series}</div></div>` : ''}
                            ${v.ignition_retainer ? `<div class="mec-item"><div class="mec-label">Ignition Retainer</div><div class="mec-value">${v.ignition_retainer}</div></div>` : ''}
                        </div>
                        ${v.service_notes_pro ? `
                        <div class="pro-note">
                            <strong>Service Note:</strong> ${v.service_notes_pro}
                        </div>
                        ` : ''}
                    </div>
                    ` : ''
                    }

                    <div style="margin-top: 12px; display: flex; gap: 8px; flex-wrap: wrap; align-items: center;">
                        ${oem !== 'N/A' ? `<a href="https://www.amazon.com/s?k=${encodeURIComponent(year + ' ' + make + ' ' + model + ' key fob ' + oem)}&tag=eurokeys-20" target="_blank" class="key-photos-btn" style="text-decoration: none;">ðŸ›’ Buy Key on Amazon</a>` : (fccId !== 'N/A' ? `<a href="https://www.amazon.com/s?k=${encodeURIComponent(year + ' ' + make + ' ' + model + ' key fob ' + fccId)}&tag=eurokeys-20" target="_blank" class="key-photos-btn" style="text-decoration: none;">ðŸ›’ Buy Key on Amazon</a>` : '')}
                        <a href="${youtubeLink}" target="_blank" style="padding: 8px 16px; background: #ff0000; color: white; border-radius: 6px; text-decoration: none; font-size: 0.85rem; font-weight: 600;">ðŸ“º Watch Tutorial</a>
                        <button onclick="toggleGuide('${make}', '${model}', ${idx})" class="walkthrough-toggle">ðŸ“– View Guide</button>
                    </div>
                    <div id="guide-${idx}" class="walkthrough-content"></div>
                </div>
            `;
            }).join('');
        }

        function getKeyTypeIcon(keyType) {
            const lower = (keyType || '').toLowerCase();
            if (lower.includes('smart') || lower.includes('prox')) return 'ðŸš—';
            if (lower.includes('flip')) return 'ðŸ”„';
            if (lower.includes('fobik')) return 'ðŸ“Ÿ';
            if (lower.includes('remote')) return 'ðŸ“¡';
            return 'ðŸ”‘';
        }

        function goBack() {
            document.getElementById('browseSection').style.display = 'block';
            document.getElementById('resultsSection').classList.remove('active');
        }

        // Quick switch to a different make (pre-populate dropdowns)
        async function quickSwitchMake(make) {
            // Go back to browse section
            document.getElementById('browseSection').style.display = 'block';
            document.getElementById('resultsSection').classList.remove('active');

            // Set the make in dropdown
            const makeSelect = document.getElementById('makeSelect');
            makeSelect.value = make;

            // Trigger model load
            await loadModels();

            // Focus on model select for quick selection
            document.getElementById('modelSelect').focus();
        }

        // Quick switch to a different model (same year/make)
        async function quickSwitchModel(year, make, model) {
            document.getElementById('yearSelect').value = year;
            document.getElementById('makeSelect').value = make;
            await loadModels();
            document.getElementById('modelSelect').value = model;
            await searchVehicle();
        }

        // Quick search from results page
        async function quickLoadMakes() {
            const year = document.getElementById('quickYear').value;
            const select = document.getElementById('quickMake');

            if (!year) {
                select.innerHTML = '<option value="">Make</option>';
                return;
            }
            select.innerHTML = '<option value="">Loading...</option>';

            try {
                const res = await fetch(`${API}/api/master?year=${year}&limit=1000`);
                const data = await res.json();
                const makes = [...new Set(data.rows.map(r => r.make))].filter(isValidMake).sort();
                select.innerHTML = '<option value="">Make</option>';
                makes.forEach(m => { select.innerHTML += `<option value="${m}">${m}</option>`; });
            } catch (e) {
                select.innerHTML = '<option value="">Make</option>';
            }
        }

        async function quickLoadModels() {
            const year = document.getElementById('quickYear').value;
            const make = document.getElementById('quickMake').value;
            const select = document.getElementById('quickModel');

            if (!make) {
                select.innerHTML = '<option value="">Model</option>';
                return;
            }
            select.innerHTML = '<option value="">Loading...</option>';

            try {
                const res = await fetch(`${API}/api/master?year=${year}&make=${encodeURIComponent(make)}&limit=500`);
                const data = await res.json();
                const models = [...new Set(data.rows.map(r => r.model))].sort();
                select.innerHTML = '<option value="">Model</option>';
                models.forEach(m => { select.innerHTML += `<option value="${m}">${m}</option>`; });
            } catch (e) {
                select.innerHTML = '<option value="">Model</option>';
            }
        }

        async function quickSearch() {
            const year = document.getElementById('quickYear').value;
            const make = document.getElementById('quickMake').value;
            const model = document.getElementById('quickModel').value;

            if (!year || !make || !model) {
                alert('Please select year, make, and model');
                return;
            }

            document.getElementById('resultTitle').textContent = `${year} ${make} ${model}`;
            document.getElementById('resultsContainer').innerHTML = '<div class="loading">Loading...</div>';

            try {
                const res = await fetch(`${API}/api/browse?year=${year}&make=${encodeURIComponent(make)}&model=${encodeURIComponent(model)}&limit=10`);
                const data = await res.json();
                if (data.rows && data.rows.length > 0) {
                    displayResults(data.rows, year, make, model);
                } else {
                    document.getElementById('resultsContainer').innerHTML = '<div class="loading">No results found</div>';
                }
            } catch (e) {
                document.getElementById('resultsContainer').innerHTML = '<div class="loading">Failed to load</div>';
            }
        }

        // Populate quick search years when results are shown
        function initQuickSearch() {
            const select = document.getElementById('quickYear');
            if (select.options.length <= 1) {
                const year = new Date().getFullYear() + 1;
                for (let y = year; y >= 2000; y--) {
                    select.innerHTML += `<option value="${y}">${y}</option>`;
                }
            }
        }

        // ================== FCC DATABASE ==================

        let fccData = [];
        let fccDataLoaded = false;
        let fccPage = 1;
        let fccKeyType = 'all'; // 'all', 'push', 'non-push'
        const FCC_PER_PAGE = 20;

        // Determine key type matching filter categories
        function getKeyType(row) {
            const vehicles = (row.vehicles || '').toLowerCase();
            const chip = (row.chip || '').toLowerCase();
            const freq = parseFloat(row.frequency) || 0;
            const keyTypeDisplay = (row.key_type_display || '').toLowerCase();

            // Smart/Prox keys: PEPS, proximity, push-to-start
            if (chip.includes('hitag') || chip.includes('id47') || chip.includes('id49') ||
                chip.includes('id4a') || vehicles.includes('prox') ||
                vehicles.includes('smart') || vehicles.includes('peps') ||
                keyTypeDisplay.includes('smart') || freq >= 433) {
                return 'smart';
            }

            // Flip/switchblade keys
            if (vehicles.includes('flip') || vehicles.includes('switchblade') ||
                keyTypeDisplay.includes('flip')) {
                return 'flip';
            }

            // Remote head keys
            if (vehicles.includes('remote head') || chip.includes('remote head') ||
                keyTypeDisplay.includes('remote head') ||
                vehicles.includes('rhk') || vehicles.includes('remote key')) {
                return 'remote-head';
            }

            // Mechanical/traditional keys: no chip
            if (row.is_synthetic || chip.includes('non-transponder') ||
                chip.includes('traditional') || chip === 'na' || chip === 'n/a' ||
                chip === '' || keyTypeDisplay.includes('mechanical') ||
                keyTypeDisplay.includes('high security')) {
                return 'mechanical';
            }

            // Transponder keys: chip-based but not smart
            if (chip.includes('id') || chip.includes('philips') || chip.includes('texas') ||
                chip.includes('megamos') || chip.includes('pcf') || chip.includes('tpx') ||
                keyTypeDisplay.includes('transponder') || keyTypeDisplay.includes('ews')) {
                return 'transponder';
            }

            return 'transponder'; // Default fallback
        }

        // Generate key type badge HTML with appropriate colors
        function getKeyTypeBadge(row, includeMarginLeft = false) {
            const keyType = getKeyType(row);
            const badges = {
                'smart': { label: 'Smart/Prox', bg: 'rgba(34, 197, 94, 0.1)', color: '#22c55e', border: 'rgba(34, 197, 94, 0.2)' },
                'flip': { label: 'Flip Key', bg: 'rgba(168, 85, 247, 0.1)', color: '#a855f7', border: 'rgba(168, 85, 247, 0.2)' },
                'remote-head': { label: 'Remote Head', bg: 'rgba(59, 130, 246, 0.1)', color: '#3b82f6', border: 'rgba(59, 130, 246, 0.2)' },
                'mechanical': { label: 'Mechanical', bg: 'rgba(156, 163, 175, 0.1)', color: '#9ca3af', border: 'rgba(156, 163, 175, 0.2)' },
                'transponder': { label: 'Transponder', bg: 'rgba(251, 191, 36, 0.1)', color: '#fbbf24', border: 'rgba(251, 191, 36, 0.2)' }
            };
            const badge = badges[keyType] || badges['transponder'];
            const marginStyle = includeMarginLeft ? ' margin-left: 8px;' : '';
            return `<span style="font-size: 0.7rem; background: ${badge.bg}; color: ${badge.color}; padding: 2px 6px; border-radius: 4px; border: 1px solid ${badge.border};${marginStyle}">${badge.label}</span>`;
        }

        // Legacy compatibility - keep isPushKey for any other usages
        function isPushKey(row) {
            return getKeyType(row) === 'smart';
        }

        function setFccFilter(type) {
            fccKeyType = type;
            fccPage = 1;
            // Update active button
            document.querySelectorAll('.fcc-filter').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.type === type);
            });
            renderFccTable();
        }

        async function loadFccData() {
            try {
                const res = await fetch(`${API}/api/fcc?limit=500`);
                const data = await res.json();
                fccData = data.rows || [];
                fccDataLoaded = true;
                populateFccYears();
                renderFccTable();
            } catch (e) {
                document.getElementById('fccTableBody').innerHTML = '<tr><td colspan="5" class="loading">Failed to load FCC data</td></tr>';
            }
        }

        function populateFccYears() {
            const fromSelect = document.getElementById('fccYearFrom');
            const toSelect = document.getElementById('fccYearTo');
            if (!fromSelect || !toSelect) return;

            const currentYear = new Date().getFullYear() + 1;
            for (let y = currentYear; y >= 1998; y--) {
                fromSelect.innerHTML += `<option value="${y}">${y}</option>`;
                toSelect.innerHTML += `<option value="${y}">${y}</option>`;
            }
        }

        function filterFccTable() {
            fccPage = 1;
            renderFccTable();
        }

        function renderFccTable() {
            const rawSearch = document.getElementById('fccSearch').value;
            const yearFrom = parseInt(document.getElementById('fccYearFrom')?.value) || 0;
            const yearTo = parseInt(document.getElementById('fccYearTo')?.value) || 9999;

            // Parse year from search string (e.g. "jeep 2012")
            const yearMatch = rawSearch.match(/\b(19\d{2}|20\d{2})\b/);
            const searchYear = yearMatch ? parseInt(yearMatch[1]) : null;
            const searchText = rawSearch.replace(/\b(19\d{2}|20\d{2})\b/g, '').trim().toLowerCase();

            // Filter by search and exclude garbage FCC IDs (< 5 chars)
            let filtered = fccData.filter(r => {
                const fccId = r.fcc_id || '';
                if (fccId.length < 5) return false; // Filter garbage like "ID"

                const matchesSearch = !searchText ||
                    fccId.toLowerCase().includes(searchText) ||
                    (r.vehicles || '').toLowerCase().includes(searchText);

                // Check if vehicle years match searched year
                if (matchesSearch && searchYear) {
                    const vehicles = r.vehicles || '';
                    const yearRanges = vehicles.match(/\((\d{4})(?:-(\d{4}))?\)/g) || [];
                    const matchesYear = yearRanges.some(match => {
                        const m = match.match(/\((\d{4})(?:-(\d{4}))?\)/);
                        if (!m) return false;
                        const start = parseInt(m[1]);
                        const end = m[2] ? parseInt(m[2]) : start;
                        return searchYear >= start && searchYear <= end;
                    });
                    return matchesYear;
                }

                return matchesSearch;
            });

            // Apply year range filter (extract years from vehicles string)
            if (yearFrom || yearTo !== 9999) {
                filtered = filtered.filter(r => {
                    const vehicles = r.vehicles || '';
                    // Extract years from format like "(2014-2021)"
                    const yearMatches = vehicles.match(/\((\d{4})(?:-(\d{4}))?\)/g) || [];
                    if (yearMatches.length === 0) return true; // Show if no year data

                    // Check if any year range overlaps with filter
                    return yearMatches.some(match => {
                        const m = match.match(/\((\d{4})(?:-(\d{4}))?\)/);
                        if (!m) return false;
                        const start = parseInt(m[1]);
                        const end = m[2] ? parseInt(m[2]) : start;
                        return end >= yearFrom && start <= yearTo;
                    });
                });
            }

            // Apply key type filter - uses getKeyType() to match badge display logic
            if (fccKeyType !== 'all') {
                filtered = filtered.filter(r => getKeyType(r) === fccKeyType);
            }

            const totalPages = Math.ceil(filtered.length / FCC_PER_PAGE);
            const start = (fccPage - 1) * FCC_PER_PAGE;
            const pageData = filtered.slice(start, start + FCC_PER_PAGE);

            const tbody = document.getElementById('fccTableBody');

            if (pageData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="loading">No FCC IDs found</td></tr>';
                return;
            }

            tbody.innerHTML = pageData.map(r => {
                const fccId = r.fcc_id || 'N/A';
                const vehicles = r.vehicles || 'N/A';
                const freq = r.frequency || 'N/A';
                const chip = r.chip || 'N/A';
                const oemPart = r.primary_oem_part || null;
                const primaryMake = r.primary_make || null;

                // Parse and group vehicles to avoid long lists
                const vehicleItems = vehicles !== 'N/A' ? vehicles.split(',').map(v => v.trim()).filter(v => v) : [];
                const groups = {};
                vehicleItems.forEach(vi => {
                    const match = vi.match(/^([^(]+)\s+\((\d{4})(?:-(\d{4}))?\)$/);
                    if (match) {
                        const makeModel = match[1].trim();
                        const startYear = parseInt(match[2]);
                        const endYear = match[3] ? parseInt(match[3]) : startYear;
                        if (!groups[makeModel]) {
                            groups[makeModel] = { start: startYear, end: endYear };
                        } else {
                            groups[makeModel].start = Math.min(groups[makeModel].start, startYear);
                            groups[makeModel].end = Math.max(groups[makeModel].end, endYear);
                        }
                    } else {
                        if (!groups[vi]) groups[vi] = { start: null, end: null };
                    }
                });
                const grouped = Object.entries(groups).map(([name, range]) => ({
                    name,
                    years: range.start ? (range.start === range.end ? `${range.start}` : `${range.start}-${range.end}`) : ''
                }));

                const displayGroups = grouped.slice(0, 2);
                const moreCount = grouped.length - 2;

                const firstVehicle = vehicleItems[0] || null;

                // Get ASIN and Image URL
                const asinEntry = typeof asinData !== 'undefined' && asinData.products_by_fcc ? asinData.products_by_fcc[fccId] : null;
                const primaryAsin = asinEntry ? asinEntry.primary_asin : null;

                const amazonLink = primaryAsin
                    ? `https://www.amazon.com/dp/${primaryAsin}?tag=${AFFILIATE_TAG}`
                    : getAmazonLink(fccId, firstVehicle, oemPart, primaryMake);

                let imageUrl = null;
                if (r.has_image) {
                    imageUrl = `${API}/api/assets/${fccId}.png`;
                } else if (primaryAsin) {
                    imageUrl = `https://ws-na.amazon-adsystem.com/widgets/q?_encoding=UTF8&ASIN=${primaryAsin}&Format=_SL160_&ID=AsinImage&MarketPlace=US&ServiceVersion=20070822&WS=1`;
                }

                let highlightedVehiclesHtml = displayGroups.map(g => {
                    let name = g.name;
                    if (searchText) {
                        const regex = new RegExp(`(${searchText})`, 'gi');
                        name = name.replace(regex, '<mark style="background: var(--brand-primary); color: #000; padding: 0 2px; border-radius: 2px;">$1</mark>');
                    }
                    return `<span class="vehicle-group-chip" style="font-size: 0.75rem; padding: 3px 8px; margin: 0 2px 2px 0;">
                        <span class="vehicle-group-make">${name}</span>
                        ${g.years ? `<span class="vehicle-group-years">(${g.years})</span>` : ''}
                    </span>`;
                }).join('');

                const moreLink = moreCount > 0
                    ? `<br><a href="#" onclick="showFccModal('${fccId}'); return false;" style="color: var(--brand-primary); font-size: 0.75rem;">+${moreCount} more groups</a>`
                    : '';

                return `
                <tr>
                    <td style="min-width: 100px;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            ${imageUrl ? `
                                <a href="${amazonLink}" target="_blank" style="display: block; width: 40px; height: 40px; background: var(--bg-tertiary); border-radius: 6px; border: 1px solid var(--border); overflow: hidden; flex-shrink: 0;">
                                    <img src="${imageUrl}" style="width: 100%; height: 100%; object-fit: contain;" onerror="this.style.display='none'">
                                </a>
                            ` : ''}
                            <a href="#" class="fcc-link" onclick="showFccModal('${fccId}'); return false;">${fccId}</a>
                        </div>
                    </td>
                    <td style="font-size: 0.85rem;">
                        ${oemPart ? `<a href="${amazonLink}" target="_blank" style="color: var(--brand-primary);">${oemPart}</a>` : '<span style="color: var(--text-muted);">-</span>'}
                        <div style="margin-top: 4px;">
                            ${getKeyTypeBadge(r)}
                        </div>
                    </td>
                    <td style="max-width: 350px; line-height: 1.4;">${highlightedVehiclesHtml}${moreLink}</td>
                    <td class="hide-mobile">${freq}${freq !== 'N/A' && !String(freq).includes('Hz') ? ' MHz' : ''}</td>
                    <td class="hide-mobile">${chip}</td>
                    <td>
                        <div style="display: flex; gap: 4px; align-items: center;">
                            <button onclick="inventoryMinus('${fccId}', 'key')" class="inv-btn" title="Remove 1" style="width: 24px; height: 24px; border-radius: 4px; border: none; background: var(--bg-secondary); color: var(--text-primary); cursor: pointer;">âˆ’</button>
                            <span id="fcc-stock-${fccId}" style="min-width: 20px; text-align: center; font-size: 0.85rem;">${InventoryManager.getKeyStock(fccId)}</span>
                            <button onclick="fccInventoryAdd('${fccId}', '${(vehicles || '').replace(/'/g, "\\'")}', '${amazonLink.replace(/'/g, "\\'")}')" class="inv-btn" title="Add 1" style="width: 24px; height: 24px; border-radius: 4px; border: none; background: var(--brand-primary); color: var(--bg-primary); cursor: pointer; font-weight: bold;">+</button>
                        </div>
                    </td>
                    <td><a href="${amazonLink}" target="_blank" class="amazon-btn">ðŸ›’</a></td>
                </tr>
            `;
            }).join('');

            // Also render mobile cards
            const cardsContainer = document.getElementById('fccCards');
            if (pageData.length === 0) {
                cardsContainer.innerHTML = '<div class="loading" style="text-align: center; padding: 40px; color: var(--text-muted);">No FCC IDs found</div>';
            } else {
                cardsContainer.innerHTML = pageData.map(r => {
                    const fccId = r.fcc_id || 'N/A';
                    const vehicles = r.vehicles || '';
                    const freq = r.frequency || 'N/A';
                    const chip = r.chip || 'N/A';
                    const oemPart = r.primary_oem_part || null;
                    const primaryMake = r.primary_make || null;

                    // Parse and group vehicles to avoid long lists
                    const vehicleItems = vehicles ? vehicles.split(',').map(v => v.trim()).filter(v => v) : [];
                    const groups = {};
                    vehicleItems.forEach(vi => {
                        const match = vi.match(/^([^(]+)\s+\((\d{4})(?:-(\d{4}))?\)$/);
                        if (match) {
                            const makeModel = match[1].trim();
                            const startYear = parseInt(match[2]);
                            const endYear = match[3] ? parseInt(match[3]) : startYear;
                            if (!groups[makeModel]) {
                                groups[makeModel] = { start: startYear, end: endYear };
                            } else {
                                groups[makeModel].start = Math.min(groups[makeModel].start, startYear);
                                groups[makeModel].end = Math.max(groups[makeModel].end, endYear);
                            }
                        } else {
                            if (!groups[vi]) groups[vi] = { start: null, end: null };
                        }
                    });
                    const grouped = Object.entries(groups).map(([name, range]) => ({
                        name,
                        years: range.start ? (range.start === range.end ? `${range.start}` : `${range.start}-${range.end}`) : ''
                    }));

                    const displayGroups = grouped.slice(0, 5);
                    const moreCount = grouped.length - 5;
                    const firstVehicle = vehicleItems[0] || null;
                    const amazonLink = getAmazonLink(fccId, firstVehicle, oemPart, primaryMake);

                    // Get ASIN and Image URL
                    const asinEntry = typeof asinData !== 'undefined' && asinData.products_by_fcc ? asinData.products_by_fcc[fccId] : null;
                    const primaryAsin = asinEntry ? asinEntry.primary_asin : null;
                    const imageUrl = primaryAsin
                        ? `https://ws-na.amazon-adsystem.com/widgets/q?_encoding=UTF8&ASIN=${primaryAsin}&Format=_SL160_&ID=AsinImage&MarketPlace=US&ServiceVersion=20070822&WS=1`
                        : null;

                    return `
                    <div class="fcc-card">
                        <div class="fcc-card-header">
                            <span class="fcc-id-badge" onclick="showFccModal('${fccId}')">ðŸ”‘ ${fccId}</span>
                            ${oemPart ? `<span class="fcc-oem">${oemPart}</span>` : ''}
                            ${getKeyTypeBadge(r, true)}
                        </div>

                        ${imageUrl ? `
                        <div class="fcc-card-image" onclick="showFccModal('${fccId}')">
                            <img src="${imageUrl}" alt="${fccId}" onerror="this.parentElement.style.display='none'">
                        </div>
                        ` : ''}
                        
                        <div class="fcc-vehicles">
                            ${displayGroups.map(g => `
                                <span class="vehicle-group-chip" onclick="showFccModal('${fccId}')">
                                    <span class="vehicle-group-make">${g.name}</span>
                                    ${g.years ? `<span class="vehicle-group-years">(${g.years})</span>` : ''}
                                </span>
                            `).join('')}
                            ${moreCount > 0 ? `
                                <span class="vehicle-chip vehicle-chip-more" onclick="showFccModal('${fccId}')">
                                    +${moreCount} more
                                </span>
                            ` : ''}
                        </div>

                        <div class="fcc-card-meta">
                            ${freq !== 'N/A' ? `<div class="fcc-meta-item"><span>ðŸ“¡</span><span>${freq}${!String(freq).includes('Hz') ? ' MHz' : ''}</span></div>` : ''}
                            ${chip !== 'N/A' ? `<div class="fcc-meta-item"><span>ðŸ”</span><span>${chip}</span></div>` : ''}
                        </div>

                        <div class="fcc-card-actions">
                            <a href="${amazonLink}" target="_blank" class="fcc-action-btn fcc-action-primary">ðŸ›’ Buy on Amazon</a>
                            <button onclick="showFccModal('${fccId}')" class="fcc-action-btn fcc-action-secondary">ðŸ” View Details</button>
                        </div>
                    </div>
                `;
                }).join('');
            }

            // Pagination
            document.getElementById('fccPagination').innerHTML = `
            <button onclick="fccPrev()" ${fccPage === 1 ? 'disabled' : ''}>â† Prev</button>
            <span class="page-info">Page ${fccPage} of ${totalPages} (${filtered.length} results)</span>
            <button onclick="fccNext()" ${fccPage >= totalPages ? 'disabled' : ''}>Next â†’</button>
        `;
        }

        function fccPrev() {
            if (fccPage > 1) {
                fccPage--;
                renderFccTable();
            }
        }

        function fccNext() {
            fccPage++;
            renderFccTable();
        }

        // ================== AMAZON AFFILIATE LINK ==================

        // Navigate to FCC Database and search for specific FCC ID
        function searchFccById(fccId) {
            showTab('fcc');
            document.getElementById('fccSearch').value = fccId;
            fccPage = 1;
            if (fccDataLoaded) {
                renderFccTable();
            } else {
                loadFccData();
            }
        }

        // Show FCC ID detail modal with all OEM parts and product images
        async function showFccModal(fccId) {
            const modalBody = document.getElementById('fccModalBody');
            modalBody.innerHTML = '<div class="loading">Loading FCC details...</div>';
            document.getElementById('fccModal').style.display = 'flex';
            document.body.style.overflow = 'hidden';

            try {
                // Fetch detailed OEM parts from API
                const response = await fetch(`${API_BASE}/fcc-detail/${encodeURIComponent(fccId)}`);
                const data = await response.json();

                if (data.error) throw new Error(data.error);

                const fccInfo = data.fcc_info || {};
                const oemParts = data.oem_parts || [];
                const totalVehicles = data.total_vehicles || 0;

                // Build OEM parts cards with product images
                const oemCardsHtml = oemParts.length > 0 ? oemParts.map(part => {
                    const asin = part.amazon_asin;
                    const oem = part.oem_part_number || 'Unknown';
                    const vehicles = part.vehicles || [];

                    // Generate specific link for this part
                    // If ASIN exists, link directly. Else search by OEM.
                    const partLink = asin
                        ? `https://www.amazon.com/dp/${asin}?tag=${AFFILIATE_TAG}`
                        : getAmazonLink(fccId, null, oem, null);

                    // Prioritize R2 image if available, then Amazon
                    const hasRemoteImage = part.has_image === 1 || part.has_image === true;

                    let imageUrl = null;
                    if (hasRemoteImage) {
                        imageUrl = `${API}/api/assets/${fccId}.png`;
                    } else if (asin) {
                        imageUrl = `https://ws-na.amazon-adsystem.com/widgets/q?_encoding=UTF8&ASIN=${asin}&Format=_SL160_&ID=AsinImage&MarketPlace=US&ServiceVersion=20070822&WS=1`;
                    }

                    // Group vehicles for this OEM part
                    const vehicleItems = vehicles.map(v => `${v.make} ${v.model} (${v.year_start}-${v.year_end})`);

                    const groups = {};
                    vehicleItems.forEach(vi => {
                        const match = vi.match(/^([^(]+)\s+\((\d{4})(?:-(\d{4}))?\)$/);
                        if (match) {
                            const makeModel = match[1].trim();
                            const startYear = parseInt(match[2]);
                            const endYear = match[3] ? parseInt(match[3]) : startYear;
                            if (!groups[makeModel]) {
                                groups[makeModel] = { start: startYear, end: endYear };
                            } else {
                                groups[makeModel].start = Math.min(groups[makeModel].start, startYear);
                                groups[makeModel].end = Math.max(groups[makeModel].end, endYear);
                            }
                        } else {
                            if (!groups[vi]) groups[vi] = { start: null, end: null };
                        }
                    });

                    const grouped = Object.entries(groups).map(([name, range]) => ({
                        name,
                        years: range.start ? (range.start === range.end ? `${range.start}` : `${range.start}-${range.end}`) : ''
                    }));

                    const vehicleListHtml = grouped.map(g => `
                        <span class="vehicle-group-chip" style="background: var(--bg-primary); border-color: var(--border);">
                            <span class="vehicle-group-make">${g.name}</span>
                            ${g.years ? `<span class="vehicle-group-years">(${g.years})</span>` : ''}
                        </span>
                    `).join('');

                    return `
                        <div class="oem-product-card" style="display: flex; gap: 12px; padding: 12px; background: var(--bg-tertiary); border-radius: 10px; margin-bottom: 10px; flex-direction: column;">
                            <div style="display: flex; gap: 12px;">
                                <a href="${partLink}" target="_blank" style="flex-shrink: 0;">
                                    <div style="width: 80px; height: 80px; background: var(--bg-secondary); border-radius: 8px; display: flex; align-items: center; justify-content: center; overflow: hidden; border: 1px solid var(--border);">
                                        ${imageUrl
                            ? `<img src="${imageUrl}" alt="${oem}" style="max-width: 100%; max-height: 100%; object-fit: contain;" onerror="this.style.display='none'; this.parentElement.innerHTML='<span style=\\'font-size: 2rem;\\'>ðŸ”‘</span>';"/>`
                            : '<span style="font-size: 2rem;">ðŸ”‘</span>'
                        }
                                    </div>
                                </a>
                                <div style="flex: 1; min-width: 0;">
                                    <div style="font-weight: 600; color: var(--brand-primary); margin-bottom: 4px; display: flex; align-items: center; gap: 8px;">
                                        <a href="${partLink}" target="_blank" style="color: inherit; text-decoration: none;">${oem}</a>
                                        ${asin ? '<span style="font-size: 0.65rem; background: #28a745; color: white; padding: 2px 6px; border-radius: 4px;">BEST MATCH</span>' : ''}
                                    </div>
                                    <div style="margin-top: 8px;">
                                        <a href="${partLink}" target="_blank" class="amazon-btn" style="font-size: 0.75rem; padding: 6px 12px; display: inline-flex;">
                                            ðŸ›’ ${asin ? 'Buy on Amazon' : 'Search Amazon'}
                                        </a>
                                    </div>
                                </div>
                            </div>
                            <div style="margin-top: 8px; border-top: 1px solid var(--border); padding-top: 10px;">
                                <div style="font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 8px; letter-spacing: 0.5px;">Compatible Vehicles</div>
                                <div style="display: flex; flex-wrap: wrap; gap: 4px;">
                                    ${vehicleListHtml}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('') : '<p style="color: var(--text-muted);">No OEM parts found</p>';

                // Get primary item key for inventory (prefer OEM part, fallback to FCC ID)
                const primaryItemKey = oemParts.length > 0 && oemParts[0].oem_part_number !== 'unknown'
                    ? oemParts[0].oem_part_number
                    : fccId;

                modalBody.innerHTML = `
                    <div class="modal-header-premium" style="margin-bottom: 24px;">
                        <div class="modal-title" style="font-size: 1.75rem; font-weight: 800; background: linear-gradient(135deg, var(--brand-primary), #f59e0b); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 8px;">FCC ID: ${fccId}</div>
                        <div class="modal-subtitle" style="font-size: 1rem; color: var(--text-secondary); font-weight: 500;">
                            <span style="display: inline-flex; align-items: center; gap: 4px;">ðŸ“¦ ${oemParts.length} OEM Parts</span> 
                            <span style="color: var(--text-muted); margin: 0 8px;">â€¢</span>
                            <span style="display: inline-flex; align-items: center; gap: 4px;">ðŸš— ${totalVehicles} Vehicles</span>
                        </div>
                    </div>
                    
                    <div style="background: rgba(255, 255, 255, 0.03); border: 1px solid var(--border); border-radius: 16px; padding: 20px; margin-bottom: 24px; backdrop-filter: blur(10px);">
                        ${getInventoryControlsHtml(primaryItemKey)}
                    </div>
                    
                    <div class="modal-info" style="margin-bottom: 16px; margin-top: 16px;">
                        <div class="modal-info-item">
                            <div class="modal-info-label">Frequency</div>
                            <div class="modal-info-value">${fccInfo.frequency || 'N/A'}</div>
                        </div>
                        <div class="modal-info-item">
                            <div class="modal-info-label">Battery</div>
                            <div class="modal-info-value">${fccInfo.battery || 'N/A'}</div>
                        </div>
                        <div class="modal-info-item">
                            <div class="modal-info-label">Buttons</div>
                            <div class="modal-info-value">${fccInfo.buttons || 'N/A'}</div>
                        </div>
                    </div>

                    <div style="font-weight: 600; margin-bottom: 8px; color: var(--text-primary);">OEM Parts & Products</div>
                    ${oemCardsHtml}
                `;

            } catch (err) {
                console.error('Error loading FCC detail:', err);
                // Fallback to basic display from cached data
                const record = fccData.find(r => r.fcc_id === fccId);
                if (record) {
                    const vehicles = record.vehicles || 'N/A';
                    const oemPart = record.primary_oem_part || null;
                    const primaryMake = record.primary_make || null;

                    const grouped = groupVehicles(vehicles);
                    const vehicleListHtml = grouped.map(g => `
                        <span class="vehicle-group-chip" style="background: var(--bg-primary); border-color: var(--border);">
                            <span class="vehicle-group-make">${g.name}</span>
                            ${g.years ? `<span class="vehicle-group-years">(${g.years})</span>` : ''}
                        </span>
                    `).join('');

                    const firstVehicle = grouped.length > 0 ? grouped[0].name : null;
                    const amazonLink = getAmazonLink(fccId, firstVehicle, oemPart, primaryMake);

                    modalBody.innerHTML = `
                        <div class="modal-header-premium" style="margin-bottom: 24px;">
                            <div class="modal-title" style="font-size: 1.75rem; font-weight: 800; background: linear-gradient(135deg, var(--brand-primary), #f59e0b); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 8px;">FCC ID: ${fccId}</div>
                            <div class="modal-subtitle" style="font-size: 1rem; color: var(--text-secondary);">Limited details available</div>
                        </div>
                        
                        <div style="background: rgba(255, 255, 255, 0.03); border: 1px solid var(--border); border-radius: 16px; padding: 20px; margin-bottom: 24px;">
                            ${getInventoryControlsHtml(fccId)}
                        </div>
                        
                        <div style="font-weight: 600; margin-bottom: 8px; color: var(--text-primary);">Compatible Vehicles</div>
                        <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 24px;">
                            ${vehicleListHtml}
                        </div>
                        
                        <a href="${amazonLink}" target="_blank" class="modal-amazon">ðŸ›’ Search on Amazon</a>
                    `;
                } else {
                    modalBody.innerHTML = '<p style="color: var(--text-muted);">Error loading FCC details</p>';
                }
            }
        }

        // Combine vehicle entries with consecutive years into ranges
        function combineVehicleYears(vehicleArray) {
            // Group vehicles by make/model (without year range)
            const vehicleGroups = new Map();

            vehicleArray.forEach(vehicle => {
                // Parse format like "Hyundai Genesis G80 (2017-2017)"
                const match = vehicle.match(/^(.+?)\s*\((\d{4})-(\d{4})\)$/);
                if (match) {
                    const [, name, startYear, endYear] = match;
                    const key = name.trim();
                    if (!vehicleGroups.has(key)) {
                        vehicleGroups.set(key, []);
                    }
                    vehicleGroups.get(key).push({
                        start: parseInt(startYear),
                        end: parseInt(endYear)
                    });
                } else {
                    // No year range, keep as-is
                    vehicleGroups.set(vehicle, null);
                }
            });

            // Combine year ranges for each vehicle
            const result = [];
            vehicleGroups.forEach((years, name) => {
                if (years === null) {
                    result.push(name);
                } else if (years.length === 1) {
                    const { start, end } = years[0];
                    result.push(start === end ? `${name} (${start})` : `${name} (${start}-${end})`);
                } else {
                    // Sort by start year and merge overlapping/consecutive ranges
                    years.sort((a, b) => a.start - b.start);
                    const merged = [years[0]];
                    for (let i = 1; i < years.length; i++) {
                        const last = merged[merged.length - 1];
                        const curr = years[i];
                        if (curr.start <= last.end + 1) {
                            // Merge ranges
                            last.end = Math.max(last.end, curr.end);
                        } else {
                            merged.push(curr);
                        }
                    }
                    // Format merged ranges
                    const rangeStrs = merged.map(r => r.start === r.end ? `${r.start}` : `${r.start}-${r.end}`);
                    result.push(`${name} (${rangeStrs.join(', ')})`);
                }
            });

            return result;
        }

        // Subscription Management
        let isPro = true; // TEMP: Set to true for testing - TODO: restore to false when Stripe is configured

        async function checkSubscription() {
            if (!currentUser) return;

            try {
                // Check local cache first to avoid delay
                const localStatus = localStorage.getItem('eurokeys_subscription');
                if (localStatus) {
                    const data = JSON.parse(localStatus);
                    if (data.userId === currentUser.sub && data.expiresAt > Date.now() / 1000) {
                        isPro = true;
                        updateProUI();
                        // Don't return, verify with server in background
                    }
                }

                const res = await fetch(`${API}/subscription-status?userId=${currentUser.sub}`);
                const data = await res.json();

                isPro = data.isPro;

                // Cache status
                if (isPro) {
                    localStorage.setItem('eurokeys_subscription', JSON.stringify({
                        userId: currentUser.sub,
                        expiresAt: data.expiresAt
                    }));
                } else {
                    localStorage.removeItem('eurokeys_subscription');
                }

                updateProUI();
            } catch (err) {
                console.error('Subscription check failed:', err);
            }
        }

        function updateProUI() {
            const userMenu = document.getElementById('userMenu');
            if (!userMenu) return;

            // Remove existing elements to prevent duplicates
            const existingBtn = document.getElementById('headerUpgradeBtn');
            if (existingBtn) existingBtn.remove();
            const existingBadge = document.querySelector('.pro-badge');
            if (existingBadge) existingBadge.remove();

            if (isPro) {
                const userName = document.getElementById('userName');
                if (userName) {
                    const badge = document.createElement('span');
                    badge.className = 'pro-badge';
                    badge.innerHTML = 'PRO';
                    badge.style.cssText = 'background: #fbbf24; color: #000; font-size: 0.65rem; padding: 2px 6px; border-radius: 4px; font-weight: 800; margin-left: 8px; vertical-align: middle; box-shadow: 0 0 10px rgba(251, 191, 36, 0.4);';
                    userName.appendChild(badge);
                }
            } else {
                const btn = document.createElement('button');
                btn.id = 'headerUpgradeBtn';
                btn.innerText = 'Upgrade';
                btn.style.cssText = 'background: linear-gradient(135deg, #fbbf24, #f59e0b); color: #000; border: none; padding: 6px 16px; border-radius: 20px; font-weight: 700; font-size: 0.85rem; cursor: pointer; margin-right: 12px; transition: transform 0.2s;';
                btn.onmouseover = () => btn.style.transform = 'scale(1.05)';
                btn.onmouseout = () => btn.style.transform = 'scale(1)';
                btn.onclick = openUpgradeModal;

                const avatar = document.getElementById('userAvatar');
                if (avatar) {
                    userMenu.insertBefore(btn, avatar);
                } else {
                    userMenu.appendChild(btn);
                }
            }

            // Refresh inventory view if open
            if (document.getElementById('tabInventory')?.classList.contains('active')) {
                renderInventoryPage();
            }
        }

        function openUpgradeModal() {
            const modal = document.getElementById('upgradeModal');
            if (modal) {
                modal.style.display = 'block';
            } else {
                // Fallback if modal doesn't exist
                alert('Upgrade to Pro for inventory features! Contact support@eurokeys.app');
            }
        }

        function closeUpgradeModal() {
            const modal = document.getElementById('upgradeModal');
            if (modal) modal.style.display = 'none';
        }

        async function startCheckout(plan) {
            if (!currentUser) {
                google.accounts.id.prompt(); // Ask to sign in first
                return;
            }

            const btn = event.target;
            const originalText = btn.innerText;
            btn.innerText = 'Redirecting...';
            btn.disabled = true;

            try {
                const res = await fetch(`${API}/create-checkout-session`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: currentUser.sub,
                        email: currentUser.email,
                        plan: plan
                    })
                });

                const data = await res.json();
                if (data.url) {
                    window.location.href = data.url;
                } else {
                    alert('Checkout failed: ' + (data.error || 'Unknown error'));
                    btn.innerText = originalText;
                    btn.disabled = false;
                }
            } catch (err) {
                console.error('Checkout error:', err);
                alert('Connection failed. Please try again.');
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }

        // Restore purchases - re-check subscription status
        async function restorePurchases() {
            if (!currentUser) {
                alert('Please sign in first to restore purchases.');
                return;
            }

            try {
                // Force refresh subscription status from server
                localStorage.removeItem('eurokeys_subscription');
                const res = await fetch(`${API}/subscription-status?userId=${currentUser.sub}`);
                const data = await res.json();

                if (data.isPro) {
                    isPro = true;
                    localStorage.setItem('eurokeys_subscription', JSON.stringify({
                        userId: currentUser.sub,
                        expiresAt: data.expiresAt
                    }));
                    updateProUI();
                    closeUpgradeModal();
                    alert('âœ… Subscription restored successfully! You now have Pro access.');
                } else {
                    alert('No active subscription found. If you recently purchased, please wait a few moments and try again.');
                }
            } catch (err) {
                console.error('Restore failed:', err);
                alert('Failed to restore purchases. Please try again or contact support@eurokeys.app');
            }
        }

        // Check for success param on load
        window.addEventListener('load', () => {
            loadAsinData(); // Load local ASIN mapping
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('subscription') === 'success') {
                // Clear URL
                window.history.replaceState({}, document.title, window.location.pathname);
                alert('ðŸŽ‰ Upgrade Successful! You now have Pro access.');
                if (currentUser) checkSubscription();
            }
        });

        function closeFccModal() {
            document.getElementById('fccModal').style.display = 'none';
            document.body.style.overflow = '';
        }

        // Show key photos from FCC external photos
        // FCC External Photos Lookup Cache
        let fccPhotosLookup = null;

        async function loadFccPhotosLookup() {
            if (fccPhotosLookup) return fccPhotosLookup;
            try {
                const response = await fetch('data/fcc_external_photos.csv');
                const text = await response.text();
                const lines = text.trim().split('\n');
                fccPhotosLookup = {};
                for (let i = 1; i < lines.length; i++) {
                    const [fccId, docId, url] = lines[i].split(',');
                    if (fccId && url) {
                        fccPhotosLookup[fccId] = url;
                    }
                }
                console.log(`Loaded ${Object.keys(fccPhotosLookup).length} FCC photo URLs`);
                return fccPhotosLookup;
            } catch (e) {
                console.log('Could not load FCC photos lookup:', e);
                return {};
            }
        }

        async function showKeyPhotos(fccId) {
            const modalBody = document.getElementById('keyPhotosModalBody');
            modalBody.innerHTML = '<div class="loading">Loading key photos...</div>';
            document.getElementById('keyPhotosModal').style.display = 'flex';
            document.body.style.overflow = 'hidden';

            // FCC report URLs
            const fccReportUrl = `https://fcc.report/FCC-ID/${fccId}`;
            let externalPhotosPdfUrl = null;

            // First, try the pre-scraped lookup table (fast!)
            const lookup = await loadFccPhotosLookup();
            if (lookup[fccId]) {
                externalPhotosPdfUrl = lookup[fccId];
                console.log(`Found FCC photos in lookup: ${externalPhotosPdfUrl}`);
            } else {
                // Fallback to dynamic fetching via CORS proxy
                console.log(`FCC ID ${fccId} not in lookup, trying dynamic fetch...`);
                try {
                    const corsProxy = 'https://corsproxy.io/?';
                    const response = await fetch(corsProxy + encodeURIComponent(fccReportUrl));
                    const html = await response.text();
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    for (const link of doc.querySelectorAll('a')) {
                        if (link.textContent.toLowerCase().includes('external photo')) {
                            const href = link.getAttribute('href');
                            if (href) {
                                externalPhotosPdfUrl = 'https://fcc.report' + href + '.pdf';
                                break;
                            }
                        }
                    }
                } catch (e) {
                    console.log('Dynamic fetch failed:', e);
                }
            }

            modalBody.innerHTML = `
                <div class="modal-title">ðŸ“· Key Photos: ${fccId}</div>
                <div class="modal-subtitle">Official FCC external photos document</div>
                
                <div style="margin-top: 20px;">
                    <p style="color: var(--text-muted); margin-bottom: 16px; font-size: 0.9rem;">
                        View the official FCC external photos showing key fob images and configurations:
                    </p>
                    
                    ${externalPhotosPdfUrl ? `
                    <a href="${externalPhotosPdfUrl}" target="_blank" class="fcc-link-card" style="margin-bottom: 12px;">
                        <span style="font-size: 2.5rem; display: block; margin-bottom: 8px;">ðŸ“„</span>
                        <span style="color: var(--brand-primary); font-weight: 700; font-size: 1.1rem;">View External Photos PDF â†’</span>
                        <br>
                        <span style="color: var(--text-muted); font-size: 0.85rem;">Opens PDF with key fob images</span>
                    </a>
                    ` : `
                    <div class="fcc-link-card" style="margin-bottom: 12px; opacity: 0.7;">
                        <span style="font-size: 2rem; display: block; margin-bottom: 8px;">âš ï¸</span>
                        <span style="color: var(--text-muted); font-weight: 600;">No external photos found</span>
                        <br>
                        <span style="color: var(--text-muted); font-size: 0.85rem;">Check the FCC report page below</span>
                    </div>
                    `}
                    
                    <a href="${fccReportUrl}" target="_blank" class="fcc-link-card">
                        <span style="font-size: 2rem; display: block; margin-bottom: 8px;">ðŸ”</span>
                        <span style="color: var(--text-secondary); font-weight: 600;">View All FCC Documents â†’</span>
                        <br>
                        <span style="color: var(--text-muted); font-size: 0.85rem;">Internal photos, test reports, manuals</span>
                    </a>
                </div>
            `;
        }

        function closeKeyPhotosModal() {
            document.getElementById('keyPhotosModal').style.display = 'none';
            document.body.style.overflow = '';
        }

        function openLightbox(imgSrc) {
            document.getElementById('lightboxImage').src = imgSrc;
            document.getElementById('photoLightbox').style.display = 'flex';
        }

        function closeLightbox() {
            document.getElementById('photoLightbox').style.display = 'none';
        }

        function getAmazonLink(fccId, vehicleInfo = null, oemPart = null, make = null) {
            // Create Amazon search URL with affiliate tag
            // Priority: OEM part number > make + key terms (sellers use OEM parts, not FCC IDs)
            let searchTerm;

            if (oemPart && oemPart !== 'null') {
                // Best match: OEM part number (e.g., "68577124AB key fob")
                const vehicleMake = make || (vehicleInfo ? vehicleInfo.match(/^([A-Za-z]+)/)?.[1] : '') || '';
                searchTerm = `${vehicleMake} ${oemPart} key fob remote`.trim();
            } else if (vehicleInfo) {
                // Fallback: Extract make and model from vehicle info
                const makeMatch = vehicleInfo.match(/^([A-Za-z]+)/);
                const vehicleMake = makeMatch ? makeMatch[1] : '';
                const modelMatch = vehicleInfo.match(/^[A-Za-z]+\s+([A-Za-z0-9\s]+)\s*\(/);
                const vehicleModel = modelMatch ? modelMatch[1].trim() : '';
                searchTerm = `${vehicleMake} ${vehicleModel} key fob remote`.trim();
            } else {
                // Last resort: FCC ID (often doesn't match well)
                searchTerm = `${fccId} key fob remote`;
            }
            return `https://www.amazon.com/s?k=${encodeURIComponent(searchTerm)}&tag=${AFFILIATE_TAG}`;
        }

        // ================== GOOGLE OAUTH ==================

        // Google OAuth Client ID
        const GOOGLE_CLIENT_ID = '1057439383868-t1h9qf10acvad82bv0h9gg2jeufg30v4.apps.googleusercontent.com';

        let googleAuth = null;
        let currentUser = null;

        // Initialize Google Sign-In
        function initGoogleAuth() {
            // Check if user is already signed in (from localStorage)
            const savedUser = localStorage.getItem('eurokeys_user');
            if (savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);
                    updateAuthUI(true);
                } catch (e) {
                    localStorage.removeItem('eurokeys_user');
                }
            }
        }

        // Sign in with Google
        function signInWithGoogle() {
            // Check if Google Identity Services is loaded
            if (typeof google === 'undefined' || !google.accounts) {
                // Load the Google Identity Services library
                const script = document.createElement('script');
                script.src = 'https://accounts.google.com/gsi/client';
                script.async = true;
                script.defer = true;
                script.onload = () => initGoogleSignIn();
                document.head.appendChild(script);
            } else {
                initGoogleSignIn();
            }
        }

        // Initialize Google Sign-In popup
        function initGoogleSignIn() {
            if (GOOGLE_CLIENT_ID === 'YOUR_GOOGLE_CLIENT_ID.apps.googleusercontent.com') {
                alert('Please configure your Google OAuth Client ID in the application code.\n\nGo to Google Cloud Console â†’ APIs & Services â†’ Credentials to create an OAuth 2.0 Client ID.');
                return;
            }

            // Detect mobile to use redirect mode (popups are blocked on mobile)
            const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

            google.accounts.id.initialize({
                client_id: GOOGLE_CLIENT_ID,
                callback: handleGoogleSignIn,
                auto_select: false,
                ux_mode: isMobile ? 'redirect' : 'popup'
            });

            // Show the One Tap UI or popup
            google.accounts.id.prompt((notification) => {
                if (notification.isNotDisplayed() || notification.isSkippedMoment()) {
                    // If One Tap is not displayed, use the button approach with appropriate mode
                    const tokenClient = google.accounts.oauth2.initTokenClient({
                        client_id: GOOGLE_CLIENT_ID,
                        scope: 'email profile',
                        callback: (response) => {
                            if (response.access_token) {
                                fetchUserProfile(response.access_token);
                            }
                        }
                    });

                    // Use popup on desktop, redirect on mobile
                    if (isMobile) {
                        // For mobile, use redirect flow
                        tokenClient.requestAccessToken({ prompt: 'consent' });
                    } else {
                        tokenClient.requestAccessToken();
                    }
                }
            });
        }

        // Handle Google Sign-In callback (for ID token flow)
        function handleGoogleSignIn(response) {
            if (response.credential) {
                // Decode the JWT token to get user info
                const payload = JSON.parse(atob(response.credential.split('.')[1]));
                currentUser = {
                    name: payload.name,
                    email: payload.email,
                    picture: payload.picture,
                    sub: payload.sub
                };
                localStorage.setItem('eurokeys_user', JSON.stringify(currentUser));
                updateAuthUI(true);
            }
        }

        // Fetch user profile using access token
        async function fetchUserProfile(accessToken) {
            try {
                const response = await fetch('https://www.googleapis.com/oauth2/v2/userinfo', {
                    headers: { Authorization: `Bearer ${accessToken}` }
                });
                const profile = await response.json();
                currentUser = {
                    name: profile.name,
                    email: profile.email,
                    picture: profile.picture,
                    sub: profile.id
                };
                localStorage.setItem('eurokeys_user', JSON.stringify(currentUser));
                updateAuthUI(true);
            } catch (e) {
                console.error('Failed to fetch user profile:', e);
            }
        }

        // Update the UI based on auth state
        function updateAuthUI(isSignedIn) {
            const signInBtn = document.getElementById('googleSignInBtn');
            const userMenu = document.getElementById('userMenu');
            const userName = document.getElementById('userName');
            const userAvatar = document.getElementById('userAvatar');

            if (isSignedIn && currentUser) {
                signInBtn.style.display = 'none';
                userMenu.style.display = 'flex';
                userName.textContent = currentUser.name.split(' ')[0]; // First name only

                // Show initials or profile picture
                if (currentUser.picture) {
                    userAvatar.innerHTML = `<img src="${currentUser.picture}" alt="${currentUser.name}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">`;
                } else {
                    const initials = currentUser.name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
                    userAvatar.innerHTML = initials;
                }

                // Show inventory tab and update badge
                const inventoryTab = document.getElementById('inventoryTab');
                if (inventoryTab) {
                    inventoryTab.style.display = 'inline-flex';
                    updateInventoryTabBadge();
                }

                // Show developer tab if user is a developer
                const devTab = document.getElementById('devTab');
                if (devTab) {
                    devTab.style.display = currentUser.is_developer ? 'inline-flex' : 'none';
                }
            } else {
                signInBtn.style.display = 'flex';
                userMenu.style.display = 'none';

                // Hide inventory tab
                const inventoryTab = document.getElementById('inventoryTab');
                if (inventoryTab) {
                    inventoryTab.style.display = 'none';
                }

                // Hide developer tab
                const devTab = document.getElementById('devTab');
                if (devTab) {
                    devTab.style.display = 'none';
                }
            }
        }

        // Sign out
        function signOut() {
            if (confirm('Sign out of Euro Keys?')) {
                logActivity('sign_out');
                currentUser = null;
                localStorage.removeItem('eurokeys_user');
                updateAuthUI(false);

                // Revoke Google token if available
                if (typeof google !== 'undefined' && google.accounts) {
                    google.accounts.id.disableAutoSelect();
                }
            }
        }

        // ================== ACTIVITY TRACKING ==================

        // Log user activity to the server
        async function logActivity(action, details = null) {
            if (!currentUser) return;
            try {
                await fetch(`${API}/activity/log`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ action, details })
                });
            } catch (e) {
                console.log('Activity log failed:', e);
            }
        }

        // ================== DEVELOPER PANEL ==================

        let devPanelLoaded = false;

        // Load developer panel data
        async function loadDevPanel() {
            if (devPanelLoaded) return; // Only load once per session

            try {
                const [usersRes, activityRes] = await Promise.all([
                    fetch(`${API}/admin/users`, { credentials: 'include' }),
                    fetch(`${API}/admin/activity`, { credentials: 'include' })
                ]);

                if (!usersRes.ok || !activityRes.ok) {
                    console.error('Failed to load dev panel data');
                    return;
                }

                const usersData = await usersRes.json();
                const activityData = await activityRes.json();

                // Update stats
                const users = usersData.users || [];
                const activities = activityData.activity || [];

                document.getElementById('devTotalUsers').textContent = users.length;
                document.getElementById('devProUsers').textContent = users.filter(u => u.is_pro).length;

                // Count today's activities
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const todayTimestamp = today.getTime();
                const todayActivities = activities.filter(a => a.created_at >= todayTimestamp).length;
                document.getElementById('devActivities').textContent = todayActivities;

                // Render users table
                const usersTable = document.getElementById('devUsersTable');
                if (users.length === 0) {
                    usersTable.innerHTML = '<tr><td colspan="6" style="padding: 40px; text-align: center; color: var(--text-muted);">No users yet</td></tr>';
                } else {
                    usersTable.innerHTML = users.map(user => {
                        const signupDate = user.created_at ? new Date(user.created_at).toLocaleDateString() : 'Unknown';
                        const lastActive = user.last_activity ? new Date(user.last_activity).toLocaleString() : 'Never';
                        const statusBadge = user.is_pro
                            ? '<span style="background: #fbbf24; color: #000; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: 700;">PRO</span>'
                            : (user.is_developer ? '<span style="background: #8b5cf6; color: #fff; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: 700;">DEV</span>' : '<span style="background: var(--glass-border); color: var(--text-muted); padding: 2px 8px; border-radius: 4px; font-size: 0.75rem;">Free</span>');

                        return `
                            <tr style="border-top: 1px solid var(--glass-border);">
                                <td style="padding: 12px 16px;">
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        ${user.picture ? `<img src="${user.picture}" style="width: 32px; height: 32px; border-radius: 50%;">` : '<div style="width: 32px; height: 32px; border-radius: 50%; background: var(--brand-primary); display: flex; align-items: center; justify-content: center; font-weight: 700;">' + (user.name?.[0] || '?') + '</div>'}
                                        <span style="color: var(--text-primary);">${user.name || 'Unknown'}</span>
                                    </div>
                                </td>
                                <td style="padding: 12px 16px; color: var(--text-muted);">${user.email || '-'}</td>
                                <td style="padding: 12px 16px; text-align: center;">${statusBadge}</td>
                                <td style="padding: 12px 16px; text-align: center; color: var(--text-secondary);">${user.activity_count || 0}</td>
                                <td style="padding: 12px 16px; color: var(--text-muted);">${signupDate}</td>
                                <td style="padding: 12px 16px; color: var(--text-muted);">${lastActive}</td>
                            </tr>
                        `;
                    }).join('');
                }

                // Render activity log
                const activityLog = document.getElementById('devActivityLog');
                if (activities.length === 0) {
                    activityLog.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-muted);">No activity yet</div>';
                } else {
                    activityLog.innerHTML = activities.slice(0, 100).map(activity => {
                        const time = new Date(activity.created_at).toLocaleString();
                        const actionIcon = {
                            'sign_in': 'ðŸ”‘',
                            'sign_out': 'ðŸ‘‹',
                            'view_tab': 'ðŸ‘ï¸',
                            'search': 'ðŸ”',
                            'inventory_add': 'âž•',
                            'inventory_use': 'âž–'
                        }[activity.action] || 'ðŸ“Š';

                        let detailsStr = '';
                        if (activity.details) {
                            try {
                                const details = typeof activity.details === 'string' ? JSON.parse(activity.details) : activity.details;
                                detailsStr = Object.entries(details).map(([k, v]) => `${k}: ${v}`).join(', ');
                            } catch (e) {
                                detailsStr = activity.details;
                            }
                        }

                        return `
                            <div style="padding: 10px 0; border-bottom: 1px solid var(--glass-border); display: flex; gap: 12px; align-items: flex-start;">
                                <span style="font-size: 1.2rem;">${actionIcon}</span>
                                <div style="flex: 1;">
                                    <div style="color: var(--text-primary);">
                                        <strong>${activity.user_name || activity.user_email || 'User'}</strong>
                                        <span style="color: var(--text-muted);"> - ${activity.action}</span>
                                    </div>
                                    ${detailsStr ? `<div style="color: var(--text-muted); font-size: 0.85rem;">${detailsStr}</div>` : ''}
                                    <div style="color: var(--text-muted); font-size: 0.8rem; margin-top: 2px;">${time}</div>
                                </div>
                            </div>
                        `;
                    }).join('');
                }

                devPanelLoaded = true;

            } catch (e) {
                console.error('Error loading dev panel:', e);
                document.getElementById('devUsersTable').innerHTML = '<tr><td colspan="6" style="padding: 40px; text-align: center; color: #ef4444;">Failed to load data</td></tr>';
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            populateYears();
            initGoogleAuth();
        });

        // ================== INVENTORY MANAGER ==================

        const InventoryManager = {
            KEYS_STORAGE_KEY: 'eurokeys_inventory_keys_v2',
            BLANKS_STORAGE_KEY: 'eurokeys_inventory_blanks_v2',

            // Get all keys inventory (format: { itemKey: { qty, vehicle, amazonLink } })
            getKeysInventory() {
                try {
                    const data = localStorage.getItem(this.KEYS_STORAGE_KEY);
                    if (data) return JSON.parse(data);

                    // Migrate from old format if exists
                    const oldData = localStorage.getItem('eurokeys_inventory_keys');
                    if (oldData) {
                        const old = JSON.parse(oldData);
                        const migrated = {};
                        Object.entries(old).forEach(([key, qty]) => {
                            migrated[key] = { qty, vehicle: null, amazonLink: null };
                        });
                        this.setKeysInventory(migrated);
                        return migrated;
                    }
                    return {};
                } catch (e) {
                    console.error('Error reading keys inventory:', e);
                    return {};
                }
            },

            // Get all blanks inventory
            getBlanksInventory() {
                try {
                    const data = localStorage.getItem(this.BLANKS_STORAGE_KEY);
                    if (data) return JSON.parse(data);

                    // Migrate from old format
                    const oldData = localStorage.getItem('eurokeys_inventory_blanks');
                    if (oldData) {
                        const old = JSON.parse(oldData);
                        const migrated = {};
                        Object.entries(old).forEach(([key, qty]) => {
                            migrated[key] = { qty, vehicle: null, amazonLink: null };
                        });
                        this.setBlanksInventory(migrated);
                        return migrated;
                    }
                    return {};
                } catch (e) {
                    console.error('Error reading blanks inventory:', e);
                    return {};
                }
            },

            setKeysInventory(data) {
                try {
                    localStorage.setItem(this.KEYS_STORAGE_KEY, JSON.stringify(data));
                } catch (e) {
                    console.error('Error saving keys inventory:', e);
                }
            },

            setBlanksInventory(data) {
                try {
                    localStorage.setItem(this.BLANKS_STORAGE_KEY, JSON.stringify(data));
                } catch (e) {
                    console.error('Error saving blanks inventory:', e);
                }
            },

            // Get stock for a key (remote/fob)
            getKeyStock(itemKey) {
                const inv = this.getKeysInventory();
                return inv[itemKey]?.qty || 0;
            },

            // Get stock for a blank (keyway)
            getBlankStock(keyway) {
                const inv = this.getBlanksInventory();
                return inv[keyway]?.qty || 0;
            },

            // Get full item data
            getKeyItem(itemKey) {
                const inv = this.getKeysInventory();
                return inv[itemKey] || null;
            },

            getBlankItem(keyway) {
                const inv = this.getBlanksInventory();
                return inv[keyway] || null;
            },

            // Legacy method for backwards compatibility
            getStock(itemKey) {
                return this.getKeyStock(itemKey);
            },

            // Add stock with metadata
            addKeyStock(itemKey, qty = 1, vehicle = null, amazonLink = null) {
                const inv = this.getKeysInventory();
                if (!inv[itemKey]) {
                    inv[itemKey] = { qty: 0, vehicle: null, amazonLink: null };
                }
                inv[itemKey].qty += qty;
                // Update metadata if provided (keeps latest)
                if (vehicle) inv[itemKey].vehicle = vehicle;
                if (amazonLink) inv[itemKey].amazonLink = amazonLink;
                this.setKeysInventory(inv);
                return inv[itemKey].qty;
            },

            addBlankStock(keyway, qty = 1, vehicle = null, amazonLink = null) {
                const inv = this.getBlanksInventory();
                if (!inv[keyway]) {
                    inv[keyway] = { qty: 0, vehicle: null, amazonLink: null };
                }
                inv[keyway].qty += qty;
                if (vehicle) inv[keyway].vehicle = vehicle;
                if (amazonLink) inv[keyway].amazonLink = amazonLink;
                this.setBlanksInventory(inv);
                return inv[keyway].qty;
            },

            // Legacy method
            addStock(itemKey, qty = 1, vehicle = null, amazonLink = null) {
                return this.addKeyStock(itemKey, qty, vehicle, amazonLink);
            },

            useKeyStock(itemKey, qty = 1) {
                const inv = this.getKeysInventory();
                if (inv[itemKey]) {
                    const actualUsed = Math.min(qty, inv[itemKey].qty);
                    inv[itemKey].qty = Math.max(0, inv[itemKey].qty - qty);
                    inv[itemKey].used = (inv[itemKey].used || 0) + actualUsed;
                    this.setKeysInventory(inv);
                    return inv[itemKey].qty;
                }
                return 0;
            },

            useBlankStock(keyway, qty = 1) {
                const inv = this.getBlanksInventory();
                if (inv[keyway]) {
                    const actualUsed = Math.min(qty, inv[keyway].qty);
                    inv[keyway].qty = Math.max(0, inv[keyway].qty - qty);
                    inv[keyway].used = (inv[keyway].used || 0) + actualUsed;
                    this.setBlanksInventory(inv);
                    return inv[keyway].qty;
                }
                return 0;
            },

            // Legacy method
            useStock(itemKey, qty = 1) {
                return this.useKeyStock(itemKey, qty);
            },

            // Get total counts
            getTotalKeys() {
                const inv = this.getKeysInventory();
                return Object.values(inv).reduce((sum, item) => sum + (item?.qty || 0), 0);
            },

            getTotalBlanks() {
                const inv = this.getBlanksInventory();
                return Object.values(inv).reduce((sum, item) => sum + (item?.qty || 0), 0);
            },

            // Get total used counts
            getTotalUsedKeys() {
                const inv = this.getKeysInventory();
                return Object.values(inv).reduce((sum, item) => sum + (item?.used || 0), 0);
            },

            getTotalUsedBlanks() {
                const inv = this.getBlanksInventory();
                return Object.values(inv).reduce((sum, item) => sum + (item?.used || 0), 0);
            },

            // Get all items for display
            getAllKeys() {
                return this.getKeysInventory();
            },

            getAllBlanks() {
                return this.getBlanksInventory();
            }
        };

        // ================== TOOL LIBRARY (EXPANDED) ==================
        const ToolLibrary = {
            // CATEGORY: KEY PROGRAMMERS (TABLET)
            "Autel IM608 Pro": {
                name: "Autel IM608 Pro",
                type: "Programmer",
                price: 3500,
                capabilities: [
                    { make: "Toyota", years: "2000-2023", note: "Excellent OBD coverage, G/H Chip" },
                    { make: "Lexus", years: "2000-2023", note: "Smart Key programming" },
                    { make: "BMW", years: "2005-2018", note: "CAS1-4, FEM/BDC" },
                    { make: "Mercedes", years: "2005-2014", note: "FBS3 IR Key (needs XP400)" },
                    { make: "Ford", years: "2010-2024", note: "PATS, Smart Keys" },
                    { make: "Honda", years: "2005-2023", note: "All Keys Lost OBD" },
                    { make: "Nissan", years: "2008-2023", note: "BCM Code Reading" },
                    { make: "Hyundai/Kia", years: "2010-2023", note: "Pincode Reading, Smart Key" },
                    { make: "Dodge", years: "2010-2022", note: "RF Hub, Fobik, Smart Key" },
                    { make: "Jeep", years: "2010-2022", note: "Wrangler/Grand Cherokee" }
                ]
            },
            "Autel IM508": {
                name: "Autel IM508",
                type: "Programmer",
                price: 1500,
                capabilities: [
                    { make: "Toyota", years: "2000-2023", note: "Excellent OBD coverage" },
                    { make: "Honda", years: "2005-2023", note: "All Keys Lost OBD" },
                    { make: "Ford", years: "2010-2024", note: "Basic PATS" },
                    { make: "Hyundai/Kia", years: "2010-2020", note: "Basic Key Programming" }
                ]
            },
            "Lonsdor K518": {
                name: "Lonsdor K518",
                type: "Programmer",
                price: 1200,
                capabilities: [
                    { make: "Toyota", years: "2019-2024", note: "Best for New Smart Keys (0410/BA)" },
                    { make: "Volvo", years: "2010-2022", note: "Solder-free Smart Key" },
                    { make: "Land Rover", years: "2015-2023", note: "JLR OBD Programming" },
                    { make: "Nissan", years: "2019-2023", note: "New Sentra/Versa Rolling Code" }
                ]
            },
            "Xhorse Key Tool Max": {
                name: "Xhorse Key Tool Max",
                type: "Generators",
                price: 450,
                capabilities: [
                    { make: "Toyota", years: "2018-2024", note: "8A Smart Key (with adapter)" },
                    { make: "Volkswagen", years: "2000-2015", note: "MQB (Limited), ID48 Cloning" },
                    { make: "Honda", years: "2000-2020", note: "General OBD" },
                    { make: "Universal", years: "All", note: "Chip Generation & Cloning" }
                ]
            },
            "Smart Pro": {
                name: "Advanced Diagnostics Smart Pro",
                type: "Programmer",
                price: 4500,
                capabilities: [
                    { make: "Ford", years: "2015-2024", note: "Active Alarm Bypass" },
                    { make: "GM", years: "2017-2024", note: "CAN FD (with adapter)" },
                    { make: "Jeep", years: "2018-2024", note: "RF Hub Bypass" }
                ]
            },
            "Autel MaxiSYS Ultra": {
                name: "Autel MaxiSYS Ultra",
                type: "Diagnostic",
                price: 4995,
                capabilities: [
                    { make: "Mercedes", years: "2005-2022", note: "SCN Coding, Topology Mapping" },
                    { make: "BMW", years: "2005-2022", note: "Coding/Programming, ECU Flashing" },
                    { make: "Land Rover", years: "2010-2023", note: "Module Programming, Pathfinding" },
                    { make: "Universal", years: "All", note: "Full System Diagnostics, ADAS Calib." }
                ]
            },
            "TOPDON Phoenix Max": {
                name: "TOPDON Phoenix Max",
                type: "Diagnostic",
                price: 3600,
                capabilities: [
                    { make: "Universal", years: "All", note: "Topology Mapping, Online Coding" },
                    { make: "GM", years: "2020-2024", note: "CAN FD Built-in" }
                ]
            }
        };

        const ToolCoverageManager = {
            getAllTools() {
                return Object.values(ToolLibrary);
            },

            isToolOwned(toolName) {
                const assets = AssetManager.getAssets();
                // Normalize for comparison (remove spaces/case)
                const norm = str => str.toLowerCase().replace(/[^a-z0-9]/g, '');
                const target = norm(toolName);
                return assets.equipment.some(e => norm(e.name).includes(target));
            },

            getMyCoverage() {
                const assets = AssetManager.getAssets();
                const coverage = {}; // { Make: { Year: { tool, note } } }

                // Check all known tools against owned assets
                Object.values(ToolLibrary).forEach(tool => {
                    if (this.isToolOwned(tool.name)) {
                        tool.capabilities.forEach(cap => {
                            if (!coverage[cap.make]) coverage[cap.make] = {};

                            // Parse years "2010-2022" or "All"
                            let start = 2000, end = 2025;
                            if (cap.years !== "All") {
                                const parts = cap.years.split('-');
                                start = parseInt(parts[0]);
                                end = parts[1] === 'Present' ? 2025 : parseInt(parts[1]);
                            }

                            for (let y = start; y <= end; y++) {
                                // Only overwrite if we don't have coverage or if this tool is "better" (logic simplified: first match wins for now)
                                if (!coverage[cap.make][y]) {
                                    coverage[cap.make][y] = { tool: tool.name, note: cap.note };
                                }
                            }
                        });
                    }
                });
                return coverage;
            },

            getSimulatedCoverage(toolName) {
                const tool = ToolLibrary[toolName];
                if (!tool) return {};

                const existing = this.getMyCoverage();
                const gained = {};

                tool.capabilities.forEach(cap => {
                    // Parse years
                    let start = 2000, end = 2025;
                    if (cap.years !== "All") {
                        const parts = cap.years.split('-');
                        start = parseInt(parts[0]);
                        end = parts[1] === 'Present' ? 2025 : parseInt(parts[1]);
                    }

                    for (let y = start; y <= end; y++) {
                        // If I DON'T have coverage for this slot, it's a GAIN
                        if (!existing[cap.make] || !existing[cap.make][y]) {
                            if (!gained[cap.make]) gained[cap.make] = {};
                            gained[cap.make][y] = { tool: tool.name, note: cap.note };
                        }
                    }
                });
                return gained;
            }
        };

        // ================== ASSET MANAGER ==================
        const AssetManager = {
            ASSETS_STORAGE_KEY: 'eurokeys_assets_v1',

            getAssets() {
                try {
                    const data = localStorage.getItem(this.ASSETS_STORAGE_KEY);
                    return data ? JSON.parse(data) : { equipment: [], vehicles: [] };
                } catch (e) {
                    console.error('Error reading assets:', e);
                    return { equipment: [], vehicles: [] };
                }
            },

            saveAssets(assets) {
                localStorage.setItem(this.ASSETS_STORAGE_KEY, JSON.stringify(assets));
            },

            addEquipment(name, cost, purchaseDate) {
                const assets = this.getAssets();
                assets.equipment.push({
                    id: 'eq_' + Date.now(),
                    name,
                    cost: parseFloat(cost) || 0,
                    purchaseDate: purchaseDate || new Date().toISOString().split('T')[0]
                });
                this.saveAssets(assets);
            },

            addVehicle(name, price, purchaseDate) {
                const assets = this.getAssets();
                assets.vehicles.push({
                    id: 'vh_' + Date.now(),
                    name,
                    price: parseFloat(price) || 0,
                    purchaseDate: purchaseDate || new Date().toISOString().split('T')[0]
                });
                this.saveAssets(assets);
            },

            removeAsset(type, id) {
                const assets = this.getAssets();
                assets[type] = assets[type].filter(a => a.id !== id);
                this.saveAssets(assets);
            },

            calculateDepreciation() {
                const assets = this.getAssets();
                const now = new Date();
                let totalDepreciation = 0;

                // Simple 5-year straight-line depreciation for vehicles
                assets.vehicles.forEach(v => {
                    const purchaseDate = new Date(v.purchaseDate);
                    const ageInYears = (now - purchaseDate) / (1000 * 60 * 60 * 24 * 365);
                    if (ageInYears > 0) {
                        const annualDepreciation = v.price / 5;
                        totalDepreciation += annualDepreciation * Math.min(ageInYears, 5);
                    }
                });

                return totalDepreciation;
            }
        };

        // ================== TOOL COVERAGE & INTELLIGENCE ==================

        // Update inventory display in modal
        function updateInventoryDisplay(itemKey, type = 'key') {
            const stock = type === 'blank' ? InventoryManager.getBlankStock(itemKey) : InventoryManager.getKeyStock(itemKey);
            const prefix = type === 'blank' ? 'blank' : 'inv';
            const badge = document.getElementById(`${prefix}-badge-${CSS.escape(itemKey)}`);
            const minusBtn = document.getElementById(`${prefix}-minus-${CSS.escape(itemKey)}`);
            const usedBtn = document.getElementById(`${prefix}-used-${CSS.escape(itemKey)}`);

            if (badge) {
                if (stock > 0) {
                    badge.textContent = `${type === 'blank' ? 'ðŸ”‘' : 'ðŸ“¦'} ${stock} in stock`;
                    badge.className = 'inventory-badge in-stock';
                } else {
                    badge.textContent = 'âš ï¸ Out of stock';
                    badge.className = 'inventory-badge out-of-stock';
                }
            }
            if (minusBtn) minusBtn.disabled = stock === 0;
            if (usedBtn) usedBtn.disabled = stock === 0;
        }

        function inventoryAdd(itemKey, type = 'key', vehicle = null, amazonLink = null) {
            if (!isPro) {
                openUpgradeModal();
                return;
            }
            if (type === 'blank') {
                InventoryManager.addBlankStock(itemKey, 1, vehicle, amazonLink);
            } else {
                InventoryManager.addKeyStock(itemKey, 1, vehicle, amazonLink);
            }
            updateInventoryDisplay(itemKey, type);
            updateInventoryTabBadge();
        }

        function inventoryMinus(itemKey, type = 'key') {
            if (!isPro) {
                openUpgradeModal();
                return;
            }
            if (type === 'blank') {
                InventoryManager.useBlankStock(itemKey);
            } else {
                InventoryManager.useKeyStock(itemKey);
            }
            updateInventoryDisplay(itemKey, type);
            updateInventoryTabBadge();
            // Also update FCC table if visible
            updateFccStockDisplay(itemKey);
        }

        // Helper for FCC table inventory add
        function fccInventoryAdd(fccId, vehicle, amazonLink) {
            inventoryAdd(fccId, 'key', vehicle, amazonLink);
            updateFccStockDisplay(fccId);
        }

        // Update stock display in FCC table
        function updateFccStockDisplay(fccId) {
            const stockEl = document.getElementById(`fcc-stock-${fccId}`);
            if (stockEl) {
                stockEl.textContent = InventoryManager.getKeyStock(fccId);
            }
        }

        // Open the job logging modal
        function openJobLogModal(itemKey, type = 'key', vehicle = null, amazonLink = null) {
            // Get current stock
            const stock = type === 'blank' ? InventoryManager.getBlankStock(itemKey) : InventoryManager.getKeyStock(itemKey);
            if (stock <= 0) {
                if (!itemKey) return;
                alert("Cannot log job: Item is out of stock.");
                return;
            }

            // Get saved metadata from inventory for defaults
            const invItem = type === 'blank' ? InventoryManager.getBlanksInventory()[itemKey] : InventoryManager.getKeysInventory()[itemKey];
            const savedVehicle = invItem?.vehicle || vehicle || '';

            // Populate Modal
            document.getElementById('jobItemKey').value = itemKey;
            document.getElementById('jobItemType').value = type;
            document.getElementById('jobItemName').textContent = `${type === 'blank' ? 'ðŸ”‘' : 'ðŸ”'} ${itemKey}`;
            document.getElementById('jobItemVehicle').textContent = savedVehicle || '';

            // Reset all fields
            document.getElementById('jobDescription').value = savedVehicle;
            document.getElementById('jobCustomer').value = '';
            document.getElementById('jobNotes').value = '';
            document.getElementById('jobRevenue').value = '';
            document.getElementById('jobTip').value = '0';
            document.getElementById('itemCost').value = '';
            document.getElementById('jobMiles').value = '';
            document.getElementById('jobTimeMinutes').value = '';

            // Reset calculations display
            calculateJobProfit();

            // Show modal
            const modal = document.getElementById('jobLogModal');
            if (modal) {
                modal.classList.add('active');
            }
        }

        // Live profit calculation for job modal
        function calculateJobProfit() {
            const MILEAGE_RATE = 0.67; // IRS 2024 standard mileage rate
            const TAX_RATE = 0.30;     // 30% estimated tax

            const revenue = parseFloat(document.getElementById('jobRevenue')?.value) || 0;
            const tip = parseFloat(document.getElementById('jobTip')?.value) || 0;
            const keyCost = parseFloat(document.getElementById('itemCost')?.value) || 0;
            const miles = parseFloat(document.getElementById('jobMiles')?.value) || 0;
            const minutes = parseFloat(document.getElementById('jobTimeMinutes')?.value) || 0;

            const gross = revenue + tip;
            const mileageCost = miles * MILEAGE_RATE;
            const totalExpenses = keyCost + mileageCost;
            const netProfit = gross - totalExpenses;
            const taxEstimate = Math.max(0, netProfit * TAX_RATE);
            const hours = minutes / 60;
            const hourlyRate = hours > 0 ? netProfit / hours : 0;

            // Update display
            if (document.getElementById('calcGross')) {
                document.getElementById('calcGross').textContent = `$${gross.toFixed(2)}`;
                document.getElementById('calcExpenses').textContent = `$${totalExpenses.toFixed(2)}`;
                document.getElementById('calcProfit').textContent = `$${netProfit.toFixed(2)}`;
                document.getElementById('calcProfit').style.color = netProfit >= 0 ? 'var(--brand-primary)' : '#f87171';
                document.getElementById('calcHourly').textContent = hours > 0 ? `$${hourlyRate.toFixed(2)}` : '--';
                document.getElementById('calcTax').textContent = `$${taxEstimate.toFixed(2)}`;
                document.getElementById('calcMileage').textContent = `$${mileageCost.toFixed(2)}`;
            }
        }

        function inventoryMarkUsed(itemKey, type = 'key') {
            openJobLogModal(itemKey, type);
        }

        // Close the job logging modal
        function closeJobModal() {
            const modal = document.getElementById('jobLogModal');
            if (modal) {
                modal.classList.remove('active');
            }
        }

        // Submit the job log form
        function submitJobLog(event) {
            event.preventDefault();

            const MILEAGE_RATE = 0.67; // IRS 2024 standard mileage rate
            const TAX_RATE = 0.30;     // 30% estimated tax

            const itemKey = document.getElementById('jobItemKey').value;
            const type = document.getElementById('jobItemType').value;
            const customer = document.getElementById('jobCustomer').value.trim();
            const description = document.getElementById('jobDescription').value.trim();
            const notes = document.getElementById('jobNotes').value.trim();

            // Financials - NEW EBITDA FIELDS
            const revenue = parseFloat(document.getElementById('jobRevenue').value) || 0;
            const tip = parseFloat(document.getElementById('jobTip').value) || 0;
            const keyCost = parseFloat(document.getElementById('itemCost').value) || 0;
            const miles = parseFloat(document.getElementById('jobMiles').value) || 0;
            const minutes = parseFloat(document.getElementById('jobTimeMinutes').value) || 0;

            // Calculated values
            const gross = revenue + tip;
            const mileageCost = miles * MILEAGE_RATE;
            const totalExpenses = keyCost + mileageCost;
            const netProfit = gross - totalExpenses;
            const hours = minutes / 60;
            const hourlyRate = hours > 0 ? netProfit / hours : 0;
            const taxEstimate = Math.max(0, netProfit * TAX_RATE);

            const stock = type === 'blank' ? InventoryManager.getBlankStock(itemKey) : InventoryManager.getKeyStock(itemKey);

            if (stock <= 0) {
                alert('No stock available to log a job for this item.');
                return;
            }

            // Decrement stock
            if (type === 'blank') {
                InventoryManager.useBlankStock(itemKey);
                const inv = InventoryManager.getBlanksInventory();
                if (inv[itemKey] && !inv[itemKey].vehicle && description) {
                    inv[itemKey].vehicle = description;
                    InventoryManager.setBlanksInventory(inv);
                }
            } else {
                InventoryManager.useKeyStock(itemKey);
                const inv = InventoryManager.getKeysInventory();
                if (inv[itemKey] && !inv[itemKey].vehicle && description) {
                    inv[itemKey].vehicle = description;
                    InventoryManager.setKeysInventory(inv);
                }
            }

            // Log the job with full EBITDA data
            const jobLog = {
                itemKey,
                type,
                vehicle: description,
                date: new Date().toISOString(),
                timestamp: Date.now(),
                // Revenue
                revenue: revenue,
                tip: tip,
                gross: gross,
                // Costs
                cost: keyCost,
                miles: miles,
                mileageCost: mileageCost,
                totalExpenses: totalExpenses,
                // Time
                minutes: minutes,
                hours: hours,
                // Profit metrics
                netProfit: netProfit,
                hourlyRate: hourlyRate,
                taxEstimate: taxEstimate,
                // Metadata
                customer: customer || 'Walk-in',
                description: description || `Used 1 ${type === 'blank' ? 'key blank' : 'key fob'}`,
                notes: notes
            };

            // Get existing logs or create new array
            const logsKey = 'eurokeys_job_logs';
            let logs = [];
            try {
                const existing = localStorage.getItem(logsKey);
                if (existing) logs = JSON.parse(existing);
            } catch (e) { }

            logs.push(jobLog);
            localStorage.setItem(logsKey, JSON.stringify(logs));

            // Update UI
            updateInventoryDisplay(itemKey, type);
            updateInventoryTabBadge();

            // Refresh inventory page if active
            if (document.getElementById('tabInventory')?.classList.contains('active')) {
                renderInventoryPage();
            }

            // Close modal
            closeJobModal();
        }

        // Update inventory tab badge with total count
        function updateInventoryTabBadge() {
            const tab = document.getElementById('inventoryTab');
            if (tab) { // UNLOCKED: if (tab && currentUser)
                const totalKeys = InventoryManager.getTotalKeys();
                const totalBlanks = InventoryManager.getTotalBlanks();
                const total = totalKeys + totalBlanks;
                tab.innerHTML = total > 0
                    ? `ðŸ“¦ My Inventory <span style="background: var(--brand-primary); color: #000; padding: 2px 8px; border-radius: 10px; font-size: 0.75rem; margin-left: 4px;">${total}</span>`
                    : 'ðŸ“¦ My Inventory';
            }
        }

        // Generate inventory control HTML for a vehicle card (shows both key and blank)
        function getVehicleInventoryHtml(keyIdentifier, blankKeyway, vehicleInfo = null, keyAmazonLink = null, blankAmazonLink = null) {
            // UNLOCKED: if (!currentUser) return ''; 

            const keyStock = keyIdentifier ? InventoryManager.getKeyStock(keyIdentifier) : 0;
            const blankStock = blankKeyway && blankKeyway !== 'N/A' ? InventoryManager.getBlankStock(blankKeyway) : 0;

            const escapedKey = keyIdentifier ? keyIdentifier.replace(/'/g, "\\'") : '';
            const escapedBlank = blankKeyway && blankKeyway !== 'N/A' ? blankKeyway.replace(/'/g, "\\'") : '';
            const escapedVehicle = vehicleInfo ? vehicleInfo.replace(/'/g, "\\'") : '';
            const escapedKeyAmazon = keyAmazonLink ? keyAmazonLink.replace(/'/g, "\\'") : '';
            const escapedBlankAmazon = blankAmazonLink ? blankAmazonLink.replace(/'/g, "\\'") : '';

            let html = '';

            // Key fob/remote inventory
            if (keyIdentifier) {
                html += `
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="font-size: 0.75rem; color: var(--text-muted);">ðŸ” Key Fob:</span>
                            <span id="inv-badge-${CSS.escape(keyIdentifier)}" class="inventory-badge ${keyStock > 0 ? 'in-stock' : 'out-of-stock'}">
                                ${keyStock > 0 ? `ðŸ“¦ ${keyStock}` : 'âš ï¸ 0'}
                            </span>
                            <div class="inventory-controls">
                                <button class="inventory-btn" onclick="inventoryMinus('${escapedKey}', 'key')" id="inv-minus-${CSS.escape(keyIdentifier)}" ${keyStock === 0 ? 'disabled' : ''}>âˆ’</button>
                                <button class="inventory-btn" onclick="inventoryAdd('${escapedKey}', 'key', '${escapedVehicle}', '${escapedKeyAmazon}')">+</button>
                            </div>
                        </div>
                        <button class="btn-log-job" onclick="openJobLogModal('${escapedKey}', 'key', '${escapedVehicle}', '${escapedKeyAmazon}')" id="inv-used-${CSS.escape(keyIdentifier)}" ${keyStock === 0 ? 'disabled' : ''}>âœ“ Log Job</button>
                    </div>
                `;
            }

            // Key blank inventory
            if (blankKeyway && blankKeyway !== 'N/A') {
                html += `
                    <div style="display: flex; align-items: center; justify-content: space-between;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="font-size: 0.75rem; color: var(--text-muted);">ðŸ”‘ Blank (${blankKeyway}):</span>
                            <span id="blank-badge-${CSS.escape(blankKeyway)}" class="inventory-badge ${blankStock > 0 ? 'in-stock' : 'out-of-stock'}">
                                ${blankStock > 0 ? `ðŸ”‘ ${blankStock}` : 'âš ï¸ 0'}
                            </span>
                            <div class="inventory-controls">
                                <button class="inventory-btn" onclick="inventoryMinus('${escapedBlank}', 'blank')" id="blank-minus-${CSS.escape(blankKeyway)}" ${blankStock === 0 ? 'disabled' : ''}>âˆ’</button>
                                <button class="inventory-btn" onclick="inventoryAdd('${escapedBlank}', 'blank', '${escapedVehicle}', '${escapedBlankAmazon}')">+</button>
                            </div>
                        </div>
                        <button class="btn-log-job" onclick="openJobLogModal('${escapedBlank}', 'blank', '${escapedVehicle}', '${escapedBlankAmazon}')" id="blank-used-${CSS.escape(blankKeyway)}" ${blankStock === 0 ? 'disabled' : ''}>âœ“ Log Job</button>
                    </div>
                `;
            }

            return html ? `<div style="padding-top: 8px; border-top: 1px solid var(--border);">${html}</div>` : '';
        }

        // Generate inventory control HTML for an item (legacy for FCC modal)
        function getInventoryControlsHtml(itemKey) {
            // UNLOCKED: if (!currentUser) return ''; 

            const stock = InventoryManager.getKeyStock(itemKey);
            const escapedKey = itemKey.replace(/'/g, "\\'");
            const cssEscapedKey = CSS.escape(itemKey);

            return `
                <div class="inventory-row" style="display: flex; align-items: center; justify-content: space-between; gap: 12px; flex-wrap: wrap;">
                    <div style="flex: 1; min-width: 140px;">
                        <span id="inv-badge-${cssEscapedKey}" class="inventory-badge ${stock > 0 ? 'in-stock' : 'out-of-stock'}" style="
                            padding: 6px 12px; 
                            border-radius: 20px; 
                            font-size: 0.85rem; 
                            font-weight: 700;
                            display: inline-flex;
                            align-items: center;
                            gap: 6px;
                            background: ${stock > 0 ? 'rgba(34, 197, 94, 0.1)' : 'rgba(239, 68, 68, 0.1)'};
                            color: ${stock > 0 ? '#4ade80' : '#f87171'};
                            border: 1px solid ${stock > 0 ? 'rgba(34, 197, 94, 0.2)' : 'rgba(239, 68, 68, 0.2)'};
                        ">
                            ${stock > 0 ? `ðŸ“¦ ${stock} in stock` : 'âš ï¸ Out of stock'}
                        </span>
                        <div class="inventory-controls" style="display: flex; align-items: center; gap: 8px; margin-top: 10px;">
                            <button class="inventory-btn" onclick="inventoryMinus('${escapedKey}', 'key')" id="inv-minus-${cssEscapedKey}" ${stock === 0 ? 'disabled' : ''} style="width: 32px; height: 32px; border-radius: 50%; border: 1px solid var(--border); background: var(--bg-tertiary); color: var(--text-primary); cursor: pointer; display: flex; align-items: center; justify-content: center; font-weight: 700;">âˆ’</button>
                            <span style="font-weight: 700; font-size: 1rem; min-width: 20px; text-align: center;">${stock}</span>
                            <button class="inventory-btn" onclick="inventoryAdd('${escapedKey}', 'key')" style="width: 32px; height: 32px; border-radius: 50%; border: 1px solid var(--border); background: var(--bg-tertiary); color: var(--text-primary); cursor: pointer; display: flex; align-items: center; justify-content: center; font-weight: 700;">+</button>
                        </div>
                    </div>
                    <button class="btn-log-job" onclick="openJobLogModal('${escapedKey}', 'key')" id="inv-used-${cssEscapedKey}" ${stock === 0 ? 'disabled' : ''} style="flex: 1; min-width: 140px;">âœ“ Log Job</button>
                </div>
            `;
        }

        function calculateInventoryStats(period = 'year') {
            const logs = JSON.parse(localStorage.getItem('eurokeys_job_logs') || '[]');
            const now = new Date();
            let filteredLogs = logs;

            if (period === 'week') {
                const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                filteredLogs = logs.filter(l => new Date(l.date) >= weekAgo);
            } else if (period === 'month') {
                const monthAgo = new Date(now.getFullYear(), now.getMonth() - 1, now.getDate());
                filteredLogs = logs.filter(l => new Date(l.date) >= monthAgo);
            }

            const totalRevenue = filteredLogs.reduce((sum, log) => sum + (log.revenue || 0), 0);
            const totalTips = filteredLogs.reduce((sum, log) => sum + (log.tip || 0), 0);
            const totalCost = filteredLogs.reduce((sum, log) => sum + (log.cost || 0), 0);
            const totalMiles = filteredLogs.reduce((sum, log) => sum + (log.miles || 0), 0);
            const totalMinutes = filteredLogs.reduce((sum, log) => sum + (log.minutes || 0), 0);

            const MILEAGE_RATE = 0.67;
            const mileageCost = totalMiles * MILEAGE_RATE;
            const gross = totalRevenue + totalTips;
            const ebitda = gross - (totalCost + mileageCost);
            const taxEstimate = Math.max(0, ebitda * 0.30);

            const keys = InventoryManager.getKeysInventory();
            const blanks = InventoryManager.getBlanksInventory();
            const lowStock = [];

            Object.entries(keys).forEach(([key, item]) => {
                if (item.qty <= 2) lowStock.push({ name: key, type: 'key', qty: item.qty });
            });
            Object.entries(blanks).forEach(([key, item]) => {
                if (item.qty <= 3) lowStock.push({ name: key, type: 'blank', qty: item.qty });
            });

            return {
                gross,
                ebitda,
                totalJobs: filteredLogs.length,
                totalRevenue,
                totalTips,
                totalCost,
                mileageCost,
                taxEstimate,
                totalHours: totalMinutes / 60,
                hourlyRate: (totalMinutes > 0) ? (ebitda / (totalMinutes / 60)) : 0,
                lowStock
            };
        }

        // Render full inventory page
        function renderInventoryPage(view = 'inventory') {
            const container = document.getElementById('inventoryContent');
            if (!container) return;

            // Toggle Header
            const headerHtml = `
                    <div style="display: flex; gap: 12px; margin-bottom: 24px; padding-bottom: 16px; border-bottom: 1px solid var(--border);">
                        <button onclick="renderInventoryPage('inventory')" style="
                            padding: 8px 16px; 
                            border-radius: 20px; 
                            border: none; 
                            background: ${view === 'inventory' ? 'var(--brand-primary)' : 'var(--bg-tertiary)'}; 
                            color: ${view === 'inventory' ? '#000' : 'var(--text-primary)'}; 
                            font-weight: 600; 
                            cursor: pointer;
                        ">ðŸ“¦ Current Stock</button>
                        <button onclick="renderInventoryPage('logs')" style="
                            padding: 8px 16px; 
                            border-radius: 20px; 
                            border: none; 
                            background: ${view === 'logs' ? 'var(--brand-primary)' : 'var(--bg-tertiary)'}; 
                            color: ${view === 'logs' ? '#000' : 'var(--text-primary)'}; 
                            font-weight: 600; 
                            cursor: pointer;
                        ">ðŸ“‹ Job Logs</button>
                        <button onclick="renderInventoryPage('stats')" style="
                            padding: 8px 16px; 
                            border-radius: 20px; 
                            border: none; 
                            background: ${view === 'stats' ? 'var(--brand-primary)' : 'var(--bg-tertiary)'}; 
                            color: ${view === 'stats' ? '#000' : 'var(--text-primary)'}; 
                            font-weight: 600; 
                            cursor: pointer;
                        ">ðŸ“Š Statistics</button>
                        <button onclick="renderInventoryPage('coverage')" style="
                            padding: 8px 16px; 
                            border-radius: 20px; 
                            border: none; 
                            background: ${view === 'coverage' ? 'var(--brand-primary)' : 'var(--bg-tertiary)'}; 
                            color: ${view === 'coverage' ? '#000' : 'var(--text-primary)'}; 
                            font-weight: 600; 
                            cursor: pointer;
                        ">ðŸ—ºï¸ Coverage Map</button>
                    </div>
                `;

            if (view === 'logs') {
                renderJobLogsPage(container, headerHtml);
                return;
            }

            if (view === 'stats') {
                renderBusinessDashboard(container, headerHtml);
                return;
            }

            if (view === 'coverage') {
                renderToolCoveragePage(container, headerHtml);
                return;
            }

            const keys = InventoryManager.getAllKeys();
            const blanks = InventoryManager.getAllBlanks();
            // Filter items with qty > 0 OR used > 0 (show items with history)
            const keyEntries = Object.entries(keys).filter(([k, item]) => (item?.qty || 0) > 0);
            const blankEntries = Object.entries(blanks).filter(([k, item]) => (item?.qty || 0) > 0);

            // Get items that have been fully used (qty = 0 but used > 0)
            const usedKeyEntries = Object.entries(keys).filter(([k, item]) => (item?.qty || 0) === 0 && (item?.used || 0) > 0);
            const usedBlankEntries = Object.entries(blanks).filter(([k, item]) => (item?.qty || 0) === 0 && (item?.used || 0) > 0);

            const totalUsedKeys = InventoryManager.getTotalUsedKeys();
            const totalUsedBlanks = InventoryManager.getTotalUsedBlanks();

            if (keyEntries.length === 0 && blankEntries.length === 0 && usedKeyEntries.length === 0 && usedBlankEntries.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px; color: var(--text-muted);">
                        <div style="font-size: 4rem; margin-bottom: 16px;">ðŸ“¦</div>
                        <h3 style="color: var(--text-primary); margin-bottom: 8px;">Your inventory is empty</h3>
                        <p>Browse vehicles and add keys to your inventory to track stock.</p>
                    </div>
                `;
                return;
            }

            let html = headerHtml + '<div style="display: grid; gap: 24px;">';

            // AI Insight Card (Dynamic)
            const insightContainerId = 'ai-insight-' + Math.random().toString(36).substr(2, 9);
            html += `
                <div id="${insightContainerId}" style="display: none; padding: 20px; background: linear-gradient(135deg, #1e1e1e 0%, #252525 100%); border: 1px solid #333; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                    <div style="display: flex; align-items: start; gap: 16px;">
                        <div style="font-size: 2rem; background: rgba(59, 130, 246, 0.1); width: 48px; height: 48px; display: flex; align-items: center; justify-content: center; border-radius: 50%;">ðŸ’¡</div>
                        <div style="flex: 1;">
                            <div style="font-weight: 700; color: #60a5fa; margin-bottom: 4px; text-transform: uppercase; font-size: 0.8rem; letter-spacing: 1px;">AI Analyst Tip</div>
                            <div class="insight-content" style="color: #e5e5e5; line-height: 1.5; font-size: 0.95rem;">Loading insight...</div>
                            <div class="insight-products" style="display: flex; gap: 8px; margin-top: 12px; flex-wrap: wrap;"></div>
                        </div>
                    </div>
                </div>
            `;

            // Fetch insight asynchronously
            setTimeout(async () => {
                const card = document.getElementById(insightContainerId);
                if (!card) return;
                try {
                    const res = await fetch(`${API}/api/insights`);
                    const data = await res.json();
                    if (data.insight && data.insight.content) {
                        card.style.display = 'block';
                        card.querySelector('.insight-content').textContent = data.insight.content;

                        // Render recommendations if any
                        if (data.insight.recommendations) {
                            const products = JSON.parse(data.insight.recommendations);
                            const prodContainer = card.querySelector('.insight-products');
                            products.forEach(prod => {
                                const btn = document.createElement('a');
                                btn.href = `https://www.amazon.com/s?k=${encodeURIComponent(prod)}&tag=jeremysamuels-20`;
                                btn.target = '_blank';
                                btn.style.cssText = 'padding: 6px 12px; background: #333; color: #fff; text-decoration: none; border-radius: 20px; font-size: 0.8rem; display: flex; align-items: center; gap: 6px; border: 1px solid #444; transition: all 0.2s ease;';
                                btn.innerHTML = `<span>ðŸ›’</span> ${prod}`;
                                btn.onmouseover = () => { btn.style.background = '#444'; btn.style.borderColor = '#666'; };
                                btn.onmouseout = () => { btn.style.background = '#333'; btn.style.borderColor = '#444'; };
                                prodContainer.appendChild(btn);
                            });
                        }
                    }
                } catch (e) { console.warn('Failed to load AI insight', e); }
            }, 100);

            // Stats summary
            const totalInStock = keyEntries.reduce((s, [k, item]) => s + (item?.qty || 0), 0) + blankEntries.reduce((s, [k, item]) => s + (item?.qty || 0), 0);
            html += `
                <div style="display: flex; gap: 16px; flex-wrap: wrap;">
                    <div style="padding: 16px 24px; background: var(--bg-tertiary); border-radius: 8px; text-align: center; flex: 1; min-width: 120px;">
                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--brand-primary);">${totalInStock}</div>
                        <div style="font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px;">In Stock</div>
                    </div>
                    <div style="padding: 16px 24px; background: var(--bg-tertiary); border-radius: 8px; text-align: center; flex: 1; min-width: 120px;">
                        <div style="font-size: 1.5rem; font-weight: 700; color: #22c55e;">${totalUsedKeys + totalUsedBlanks}</div>
                        <div style="font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px;">Used</div>
                    </div>
                </div>
            `;

            // Keys in stock section
            if (keyEntries.length > 0) {
                const totalKeys = keyEntries.reduce((s, [k, item]) => s + (item?.qty || 0), 0);
                html += `
                    <div>
                        <h3 style="color: var(--brand-primary); margin-bottom: 12px;">ðŸ” Key Fobs & Remotes (${totalKeys} in stock)</h3>
                        <div style="display: grid; gap: 8px;">
                `;
                keyEntries.forEach(([key, item]) => {
                    const qty = item?.qty || 0;
                    const used = item?.used || 0;
                    const vehicle = item?.vehicle || null;
                    const amazonLink = item?.amazonLink || null;
                    const escapedKey = key.replace(/'/g, "\\\\'");

                    html += `
                        <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px; background: var(--bg-tertiary); border-radius: 8px; flex-wrap: wrap; gap: 8px;">
                            <div style="display: flex; flex-direction: column; gap: 4px; min-width: 200px;">
                                <span style="font-weight: 600; color: var(--text-primary);">${key}</span>
                                ${vehicle ? `<span style="font-size: 0.75rem; color: var(--text-muted);">ðŸš— ${vehicle}</span>` : ''}
                            </div>
                            <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
                                <span class="inventory-badge in-stock">ðŸ“¦ ${qty}</span>
                                ${used > 0 ? `<span style="padding: 4px 8px; background: rgba(34, 197, 94, 0.2); color: #22c55e; border-radius: 4px; font-size: 0.75rem;">âœ“ ${used} used</span>` : ''}
                                <div class="inventory-controls">
                                    <button class="inventory-btn" onclick="inventoryMinus('${escapedKey}', 'key'); renderInventoryPage();">âˆ’</button>
                                    <button class="inventory-btn" onclick="inventoryAdd('${escapedKey}', 'key'); renderInventoryPage();">+</button>
                                </div>
                                <button class="btn-log-job" onclick="openJobLogModal('${escapedKey}', 'key', '${vehicle ? vehicle.replace(/'/g, "\\\\'") : ''}', '${amazonLink ? amazonLink.replace(/'/g, "\\\\'") : ''}')" style="padding: 6px 12px; font-size: 0.8rem;">âœ“ Log Job</button>
                                ${amazonLink ? `<a href="${amazonLink}" target="_blank" style="padding: 6px 12px; background: linear-gradient(135deg, #ff9900, #ff6600); color: #000; border-radius: 6px; font-size: 0.8rem; font-weight: 600; text-decoration: none;">ðŸ›’ Buy</a>` : ''}
                            </div>
                        </div>
                    `;
                });
                html += '</div></div>';
            }

            // Blanks in stock section
            if (blankEntries.length > 0) {
                const totalBlanks = blankEntries.reduce((s, [k, item]) => s + (item?.qty || 0), 0);
                html += `
                    <div>
                        <h3 style="color: var(--brand-primary); margin-bottom: 12px;">ðŸ”‘ Key Blanks (${totalBlanks} in stock)</h3>
                        <div style="display: grid; gap: 8px;">
                `;
                blankEntries.forEach(([keyway, item]) => {
                    const qty = item?.qty || 0;
                    const used = item?.used || 0;
                    const vehicle = item?.vehicle || null;
                    const amazonLink = item?.amazonLink || `https://www.amazon.com/s?k=${encodeURIComponent(keyway + ' key blank')}&tag=eurokeys-20`;
                    const escapedKey = keyway.replace(/'/g, "\\\\'");

                    html += `
                        <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px; background: var(--bg-tertiary); border-radius: 8px; flex-wrap: wrap; gap: 8px;">
                            <div style="display: flex; flex-direction: column; gap: 4px; min-width: 200px;">
                                <span style="font-weight: 600; color: var(--text-primary);">${keyway}</span>
                                ${vehicle ? `<span style="font-size: 0.75rem; color: var(--text-muted);">ðŸš— ${vehicle}</span>` : ''}
                            </div>
                            <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
                                <span class="inventory-badge in-stock">ðŸ”‘ ${qty}</span>
                                ${used > 0 ? `<span style="padding: 4px 8px; background: rgba(34, 197, 94, 0.2); color: #22c55e; border-radius: 4px; font-size: 0.75rem;">âœ“ ${used} used</span>` : ''}
                                <div class="inventory-controls">
                                    <button class="inventory-btn" onclick="inventoryMinus('${escapedKey}', 'blank'); renderInventoryPage();">âˆ’</button>
                                    <button class="inventory-btn" onclick="inventoryAdd('${escapedKey}', 'blank'); renderInventoryPage();">+</button>
                                </div>
                                <button class="btn-log-job" onclick="openJobLogModal('${escapedKey}', 'blank', '${vehicle ? vehicle.replace(/'/g, "\\\\'") : ''}', '${amazonLink ? amazonLink.replace(/'/g, "\\\\'") : ''}')" style="padding: 6px 12px; font-size: 0.8rem;">âœ“ Log Job</button>
                                <a href="${amazonLink}" target="_blank" style="padding: 6px 12px; background: linear-gradient(135deg, #ff9900, #ff6600); color: #000; border-radius: 6px; font-size: 0.8rem; font-weight: 600; text-decoration: none;">ðŸ›’ Buy</a>
                            </div>
                        </div>
                    `;
                });
                html += '</div></div>';
            }

            // Usage History section (items that have been fully used)
            if (usedKeyEntries.length > 0 || usedBlankEntries.length > 0) {
                html += `
                    <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border);">
                        <h3 style="color: #22c55e; margin-bottom: 12px;">âœ“ Usage History (Out of Stock)</h3>
                        <div style="display: grid; gap: 8px;">
                `;

                usedKeyEntries.forEach(([key, item]) => {
                    const used = item?.used || 0;
                    const vehicle = item?.vehicle || null;
                    const amazonLink = item?.amazonLink || null;
                    html += `
                        <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px; background: rgba(34, 197, 94, 0.1); border-radius: 8px; flex-wrap: wrap; gap: 8px; opacity: 0.8;">
                            <div style="display: flex; flex-direction: column; gap: 4px; min-width: 200px;">
                                <span style="font-weight: 600; color: var(--text-primary);">ðŸ” ${key}</span>
                                ${vehicle ? `<span style="font-size: 0.75rem; color: var(--text-muted);">ðŸš— ${vehicle}</span>` : ''}
                            </div>
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <span style="padding: 4px 8px; background: rgba(34, 197, 94, 0.3); color: #22c55e; border-radius: 4px; font-size: 0.85rem; font-weight: 600;">âœ“ ${used} used</span>
                                ${amazonLink ? `<a href="${amazonLink}" target="_blank" style="padding: 6px 12px; background: linear-gradient(135deg, #ff9900, #ff6600); color: #000; border-radius: 6px; font-size: 0.8rem; font-weight: 600; text-decoration: none;">ðŸ›’ Restock</a>` : ''}
                            </div>
                        </div>
                    `;
                });

                usedBlankEntries.forEach(([keyway, item]) => {
                    const used = item?.used || 0;
                    const vehicle = item?.vehicle || null;
                    const amazonLink = item?.amazonLink || `https://www.amazon.com/s?k=${encodeURIComponent(keyway + ' key blank')}&tag=eurokeys-20`;
                    html += `
                        <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px; background: rgba(34, 197, 94, 0.1); border-radius: 8px; flex-wrap: wrap; gap: 8px; opacity: 0.8;">
                            <div style="display: flex; flex-direction: column; gap: 4px; min-width: 200px;">
                                <span style="font-weight: 600; color: var(--text-primary);">ðŸ”‘ ${keyway}</span>
                                ${vehicle ? `<span style="font-size: 0.75rem; color: var(--text-muted);">ðŸš— ${vehicle}</span>` : ''}
                            </div>
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <span style="padding: 4px 8px; background: rgba(34, 197, 94, 0.3); color: #22c55e; border-radius: 4px; font-size: 0.85rem; font-weight: 600;">âœ“ ${used} used</span>
                                <a href="${amazonLink}" target="_blank" style="padding: 6px 12px; background: linear-gradient(135deg, #ff9900, #ff6600); color: #000; border-radius: 6px; font-size: 0.8rem; font-weight: 600; text-decoration: none;">ðŸ›’ Restock</a>
                            </div>
                        </div>
                    `;
                });

                html += '</div></div>';
            }

            html += '</div>';
            container.innerHTML = html;
        }

        function renderJobLogsPage(container, headerHtml) {
            const logs = JSON.parse(localStorage.getItem('eurokeys_job_logs') || '[]');

            let html = headerHtml;

            if (logs.length === 0) {
                html += `
                        <div style="text-align: center; padding: 40px; color: var(--text-muted);">
                            <div style="font-size: 3rem; margin-bottom: 16px;">ðŸ“‹</div>
                            <h3>No jobs logged yet</h3>
                            <p>Completed jobs will appear here.</p>
                        </div>
                    `;
            } else {
                html += `
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                            <h3 style="color: var(--text-primary);">Recent Jobs (${logs.length})</h3>
                            <button onclick="exportJobLogs()" style="padding: 8px 16px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary); cursor: pointer;">Download CSV</button>
                        </div>
                        <div style="display: grid; gap: 12px;">
                    `;

                logs.forEach(log => {
                    const date = new Date(log.date).toLocaleString();
                    const cost = typeof log.cost === 'number' ? log.cost : 0;
                    const revenue = typeof log.revenue === 'number' ? log.revenue : 0;
                    const profit = revenue - cost;
                    const customer = log.customer || 'Unknown Customer';
                    const description = log.description || log.vehicle || '';

                    html += `
                            <div style="background: var(--bg-tertiary); padding: 16px; border-radius: 8px; border-left: 4px solid var(--brand-primary);">
                                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
                                    <div>
                                        <div style="font-weight: 700; color: var(--text-primary); font-size: 1.1rem;">${customer}</div>
                                        <div style="font-size: 0.85rem; color: var(--text-muted);">${date}</div>
                                    </div>
                                    <div style="text-align: right;">
                                        <div style="font-weight: 700; color: #22c55e;">+ $${profit.toFixed(2)}</div>
                                        <div style="font-size: 0.75rem; color: var(--text-muted);">Rev: $${revenue.toFixed(2)}</div>
                                    </div>
                                </div>
                                <div style="margin-bottom: 8px;">
                                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                                        <span style="font-size: 0.85rem; padding: 2px 8px; background: rgba(255, 255, 255, 0.1); border-radius: 4px;">${log.type === 'blank' ? 'ðŸ”‘' : 'ðŸ”'} ${log.itemKey}</span>
                                        ${description ? `<span style="font-size: 0.9rem; color: var(--text-primary);">${description}</span>` : ''}
                                    </div>
                                    ${log.notes ? `<div style="font-size: 0.85rem; color: var(--text-muted); font-style: italic;">"${log.notes}"</div>` : ''}
                                </div>
                            </div>
                        `;
                });

                html += '</div>';
            }

            container.innerHTML = html;
        }

        function exportJobLogs() {
            const logs = JSON.parse(localStorage.getItem('eurokeys_job_logs') || '[]');
            if (logs.length === 0) return alert('No logs to export');

            const headers = ['Date', 'Customer', 'Item', 'Type', 'Description', 'Cost', 'Notes'];
            const csvContent = [
                headers.join(','),
                ...logs.map(log => [
                    new Date(log.date).toISOString(),
                    `"${(log.customer || 'Manual Job').replace(/"/g, '""')}"`,
                    `"${(log.itemKey || '').replace(/"/g, '""')}"`,
                    log.type,
                    `"${(log.description || log.vehicle || '').replace(/"/g, '""')}"`,
                    typeof log.cost === 'number' ? log.cost.toFixed(2) : '0.00',
                    `"${(log.notes || '').replace(/"/g, '""')}"`
                ].join(','))
            ].join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `job-logs-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        }


        async function renderBusinessDashboard(container, headerHtml) {
            const period = localStorage.getItem('eurokeys_dashboard_period') || 'year';
            const stats = calculateInventoryStats(period);
            const assets = AssetManager.getAssets();
            const depreciation = AssetManager.calculateDepreciation();

            let html = headerHtml + `
                <div style="margin-bottom: 24px;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 16px;">
                        <h2 style="margin: 0; color: var(--text-primary);">ðŸ’¼ Business Dashboard</h2>
                        <div style="display: flex; gap: 8px; background: var(--bg-tertiary); padding: 4px; border-radius: 8px;">
                            ${['week', 'month', 'year'].map(p => `
                                <button onclick="localStorage.setItem('eurokeys_dashboard_period', '${p}'); renderInventoryPage('stats')" style="
                                    padding: 6px 12px; border: none; border-radius: 6px; cursor: pointer; font-size: 0.75rem; font-weight: 600;
                                    background: ${period === p ? 'var(--brand-primary)' : 'transparent'};
                                    color: ${period === p ? '#000' : 'var(--text-muted)'};
                                ">${p.toUpperCase()}</button>
                            `).join('')}
                        </div>
                    </div>

                    <!-- KPI Grid -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 32px;">
                        <div style="padding: 20px; background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); border-radius: 12px; border: 1px solid rgba(255,255,255,0.05);">
                            <div style="color: var(--text-muted); font-size: 0.75rem; text-transform: uppercase; margin-bottom: 8px;">Gross EBITDA</div>
                            <div style="font-size: 1.8rem; font-weight: 800; color: #fff;">$${stats.ebitda.toFixed(2)}</div>
                            <div style="font-size: 0.75rem; color: #22c55e; margin-top: 4px;">from ${stats.totalJobs} jobs</div>
                        </div>
                        <div style="padding: 20px; background: var(--bg-tertiary); border-radius: 12px; border: 1px solid var(--border);">
                            <div style="color: var(--text-muted); font-size: 0.75rem; text-transform: uppercase; margin-bottom: 8px;">Hourly Efficiency</div>
                            <div style="font-size: 1.8rem; font-weight: 800; color: var(--brand-primary);">$${stats.hourlyRate.toFixed(2)}<span style="font-size: 0.9rem; font-weight: 400; color: var(--text-muted);">/hr</span></div>
                            <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 4px;">Net after expenses</div>
                        </div>
                        <div style="padding: 20px; background: var(--bg-tertiary); border-radius: 12px; border: 1px solid var(--border);">
                            <div style="color: var(--text-muted); font-size: 0.75rem; text-transform: uppercase; margin-bottom: 8px;">Estimated Taxes</div>
                            <div style="font-size: 1.8rem; font-weight: 800; color: #f87171;">$${stats.taxEstimate.toFixed(2)}</div>
                            <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 4px;">Based on 30% rate</div>
                        </div>
                    </div>

                    <!-- Detailed Metrics Grid -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 24px;">
                        <!-- Financial Breakdown -->
                        <div style="background: var(--bg-tertiary); border-radius: 12px; padding: 24px;">
                            <h3 style="margin-top: 0; margin-bottom: 20px; display: flex; align-items: center; gap: 8px;">
                                <span>ðŸ“Š</span> Financial Breakdown
                            </h3>
                            <div style="display: grid; gap: 12px;">
                                <div style="display: flex; justify-content: space-between; padding-bottom: 8px; border-bottom: 1px solid rgba(255,255,255,0.05);">
                                    <span style="color: var(--text-muted);">Service Revenue</span>
                                    <span style="font-weight: 600;">$${stats.totalRevenue.toFixed(2)}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding-bottom: 8px; border-bottom: 1px solid rgba(255,255,255,0.05);">
                                    <span style="color: var(--text-muted);">Tips Earned</span>
                                    <span style="font-weight: 600; color: #22c55e;">+$${stats.totalTips.toFixed(2)}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding-bottom: 8px; border-bottom: 1px solid rgba(255,255,255,0.05);">
                                    <span style="color: var(--text-muted);">Inventory COGS</span>
                                    <span style="font-weight: 600; color: #f87171;">-$${stats.totalCost.toFixed(2)}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding-bottom: 8px; border-bottom: 1px solid rgba(255,255,255,0.05);">
                                    <span style="color: var(--text-muted);">Mileage Write-off</span>
                                    <span style="font-weight: 600; color: #f87171;">-$${stats.mileageCost.toFixed(2)}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding-top: 8px; font-weight: 800; color: var(--brand-primary);">
                                    <span>Net EBITDA</span>
                                    <span>$${stats.ebitda.toFixed(2)}</span>
                                </div>
                            </div>
                        </div>

                        <!-- Asset Manager -->
                        <div style="background: var(--bg-tertiary); border-radius: 12px; padding: 24px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                <h3 style="margin: 0; display: flex; align-items: center; gap: 8px;">
                                    <span>ðŸ› ï¸</span> Asset Manager
                                </h3>
                                <button onclick="toggleAssetForm()" style="padding: 4px 8px; background: var(--brand-primary); border: none; border-radius: 4px; color: #000; font-size: 0.7rem; font-weight: 700; cursor: pointer;">+ ADD</button>
                            </div>
                            
                            <div id="assetForm" style="display: none; background: rgba(0,0,0,0.2); padding: 12px; border-radius: 8px; margin-bottom: 16px;">
                                <select id="assetType" onchange="handleAssetTypeChange()" style="width: 100%; padding: 8px; margin-bottom: 8px; background: #1a1a1a; color: #fff; border: 1px solid #333;">
                                    <option value="equipment">Equipment (Tool/Programmer)</option>
                                    <option value="vehicle">Service Vehicle</option>
                                </select>
                                
                                <!-- Dynamic Tool Selector -->
                                <div id="toolSelectContainer">
                                    <select id="knownToolSelect" onchange="handleToolSelection()" style="width: 100%; padding: 8px; margin-bottom: 8px; background: #1a1a1a; color: #fff; border: 1px solid #333;">
                                        <option value="">-- Select Tool --</option>
                                        ${Object.keys(ToolLibrary).map(tool => `<option value="${tool}">${tool}</option>`).join('')}
                                        <option value="custom">+ Custom / Other</option>
                                    </select>
                                </div>

                                <input type="text" id="assetName" placeholder="Asset Name" style="width: 100%; padding: 8px; margin-bottom: 8px; background: #1a1a1a; color: #fff; border: 1px solid #333; display: none;">
                                <input type="number" id="assetCost" placeholder="Price/Value ($)" style="width: 100%; padding: 8px; margin-bottom: 8px; background: #1a1a1a; color: #fff; border: 1px solid #333;">
                                
                                <button onclick="saveNewAsset()" style="width: 100%; padding: 8px; background: var(--brand-primary); border: none; color: #000; font-weight: 700; cursor: pointer;">Save Asset</button>
                            </div>

                            <div style="display: grid; gap: 12px;">
                                ${assets.vehicles.map(v => `
                                    <div style="display: flex; justify-content: space-between; font-size: 0.9rem;">
                                        <span style="color: var(--text-primary);">ðŸš ${v.name}</span>
                                        <div style="text-align: right;">
                                            <div style="font-weight: 600;">$${v.price.toLocaleString()}</div>
                                            <div style="font-size: 0.7rem; color: var(--text-muted);">Depr: -$${(v.price / 5).toFixed(0)}/yr</div>
                                        </div>
                                    </div>
                                `).join('')}
                                ${assets.equipment.map(e => `
                                    <div style="display: flex; justify-content: space-between; font-size: 0.9rem;">
                                        <span style="color: var(--text-primary);">ðŸ”§ ${e.name}</span>
                                        <span style="font-weight: 600;">$${e.cost.toLocaleString()}</span>
                                    </div>
                                `).join('')}
                                ${assets.vehicles.length === 0 && assets.equipment.length === 0 ? '<div style="color: var(--text-muted); text-align: center; padding: 20px;">No assets tracked yet</div>' : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            container.innerHTML = html;
        }

        function toggleAssetForm() {
            const form = document.getElementById('assetForm');
            form.style.display = form.style.display === 'none' ? 'block' : 'none';
        }

        function handleAssetTypeChange() {
            const type = document.getElementById('assetType').value;
            const toolContainer = document.getElementById('toolSelectContainer');
            const nameInput = document.getElementById('assetName');

            if (type === 'vehicle') {
                toolContainer.style.display = 'none';
                nameInput.style.display = 'block';
                nameInput.placeholder = "Vehicle Name (e.g. 2018 Ford Transit)";
                nameInput.value = '';
                document.getElementById('assetCost').value = '';
            } else {
                toolContainer.style.display = 'block';
                document.getElementById('knownToolSelect').value = '';
                nameInput.style.display = 'none'; // Hide manual input initially
                document.getElementById('assetCost').value = '';
            }
        }

        function handleToolSelection() {
            const select = document.getElementById('knownToolSelect');
            const nameInput = document.getElementById('assetName');
            const costInput = document.getElementById('assetCost');
            const val = select.value;

            if (val === 'custom') {
                nameInput.style.display = 'block';
                nameInput.value = '';
                nameInput.placeholder = "Enter Tool Name";
                costInput.value = '';
            } else if (val) {
                nameInput.style.display = 'none';
                nameInput.value = val; // Set hidden value for submission
                // Auto-fill price
                if (ToolLibrary[val]) {
                    costInput.value = ToolLibrary[val].price;
                }
            } else {
                nameInput.style.display = 'none';
                costInput.value = '';
            }
        }

        function saveNewAsset() {
            const type = document.getElementById('assetType').value;
            let name = document.getElementById('assetName').value;

            // If using dropdown logic for equipment
            if (type === 'equipment') {
                const selectVal = document.getElementById('knownToolSelect').value;
                if (selectVal && selectVal !== 'custom') {
                    name = selectVal;
                }
            }

            const cost = document.getElementById('assetCost').value;
            if (!name || !cost) return alert('Please enter name and cost');

            if (type === 'equipment') AssetManager.addEquipment(name, cost);
            else AssetManager.addVehicle(name, cost);

            renderInventoryPage('stats');
        }



        // ================== KEY COVERAGE HEATMAP ==================
        let heatmapCached = false;
        let cachedCoverage = null;
        let cachedHeatmapHtml = null;

        // Hardcoded coverage data: key type by make and year
        // 'S' = Smart/Prox, 'F' = Flip Key, 'R' = Remote Head, 'T' = Transponder, 'M' = Mechanical
        // This data reflects typical key technology adoption by manufacturer
        const HARDCODED_COVERAGE = {
            // Japanese - Early smart key adopters
            "Toyota": { 2000: 'T', 2001: 'T', 2002: 'T', 2003: 'T', 2004: 'T', 2005: 'T', 2006: 'T', 2007: 'S', 2008: 'S', 2009: 'S', 2010: 'S', 2011: 'S', 2012: 'S', 2013: 'S', 2014: 'S', 2015: 'S', 2016: 'S', 2017: 'S', 2018: 'S', 2019: 'S', 2020: 'S', 2021: 'S', 2022: 'S', 2023: 'S', 2024: 'S', 2025: 'S' },
            "Lexus": { 2000: 'T', 2001: 'T', 2002: 'T', 2003: 'T', 2004: 'S', 2005: 'S', 2006: 'S', 2007: 'S', 2008: 'S', 2009: 'S', 2010: 'S', 2011: 'S', 2012: 'S', 2013: 'S', 2014: 'S', 2015: 'S', 2016: 'S', 2017: 'S', 2018: 'S', 2019: 'S', 2020: 'S', 2021: 'S', 2022: 'S', 2023: 'S', 2024: 'S', 2025: 'S' },
            "Honda": { 2000: 'T', 2001: 'T', 2002: 'T', 2003: 'T', 2004: 'T', 2005: 'T', 2006: 'T', 2007: 'R', 2008: 'R', 2009: 'R', 2010: 'R', 2011: 'R', 2012: 'S', 2013: 'S', 2014: 'S', 2015: 'S', 2016: 'S', 2017: 'S', 2018: 'S', 2019: 'S', 2020: 'S', 2021: 'S', 2022: 'S', 2023: 'S', 2024: 'S', 2025: 'S' },
            "Nissan": { 2000: 'T', 2001: 'T', 2002: 'T', 2003: 'T', 2004: 'T', 2005: 'T', 2006: 'T', 2007: 'S', 2008: 'S', 2009: 'S', 2010: 'S', 2011: 'S', 2012: 'S', 2013: 'S', 2014: 'S', 2015: 'S', 2016: 'S', 2017: 'S', 2018: 'S', 2019: 'S', 2020: 'S', 2021: 'S', 2022: 'S', 2023: 'S', 2024: 'S', 2025: 'S' },
            "Mazda": { 2000: 'M', 2001: 'M', 2002: 'M', 2003: 'M', 2004: 'M', 2005: 'T', 2006: 'T', 2007: 'F', 2008: 'F', 2009: 'F', 2010: 'F', 2011: 'F', 2012: 'F', 2013: 'S', 2014: 'S', 2015: 'S', 2016: 'S', 2017: 'S', 2018: 'S', 2019: 'S', 2020: 'S', 2021: 'S', 2022: 'S', 2023: 'S', 2024: 'S', 2025: 'S' },
            "Subaru": { 2000: 'M', 2001: 'M', 2002: 'M', 2003: 'M', 2004: 'M', 2005: 'T', 2006: 'T', 2007: 'T', 2008: 'T', 2009: 'T', 2010: 'R', 2011: 'R', 2012: 'R', 2013: 'R', 2014: 'S', 2015: 'S', 2016: 'S', 2017: 'S', 2018: 'S', 2019: 'S', 2020: 'S', 2021: 'S', 2022: 'S', 2023: 'S', 2024: 'S', 2025: 'S' },
            // American - Remote head key era
            "Ford": { 2000: 'M', 2001: 'M', 2002: 'M', 2003: 'M', 2004: 'M', 2005: 'R', 2006: 'R', 2007: 'R', 2008: 'R', 2009: 'R', 2010: 'R', 2011: 'R', 2012: 'R', 2013: 'S', 2014: 'S', 2015: 'S', 2016: 'S', 2017: 'S', 2018: 'S', 2019: 'S', 2020: 'S', 2021: 'S', 2022: 'S', 2023: 'S', 2024: 'S', 2025: 'S' },
            "Chevrolet": { 2000: 'M', 2001: 'M', 2002: 'M', 2003: 'M', 2004: 'M', 2005: 'M', 2006: 'T', 2007: 'T', 2008: 'R', 2009: 'R', 2010: 'F', 2011: 'F', 2012: 'F', 2013: 'F', 2014: 'S', 2015: 'S', 2016: 'S', 2017: 'S', 2018: 'S', 2019: 'S', 2020: 'S', 2021: 'S', 2022: 'S', 2023: 'S', 2024: 'S', 2025: 'S' },
            "Dodge": { 2000: 'M', 2001: 'M', 2002: 'M', 2003: 'M', 2004: 'M', 2005: 'M', 2006: 'T', 2007: 'T', 2008: 'R', 2009: 'R', 2010: 'R', 2011: 'S', 2012: 'S', 2013: 'S', 2014: 'S', 2015: 'S', 2016: 'S', 2017: 'S', 2018: 'S', 2019: 'S', 2020: 'S', 2021: 'S', 2022: 'S', 2023: 'S', 2024: 'S', 2025: 'S' },
            "Jeep": { 2000: 'M', 2001: 'M', 2002: 'M', 2003: 'M', 2004: 'M', 2005: 'M', 2006: 'T', 2007: 'R', 2008: 'R', 2009: 'R', 2010: 'R', 2011: 'R', 2012: 'R', 2013: 'S', 2014: 'S', 2015: 'S', 2016: 'S', 2017: 'S', 2018: 'S', 2019: 'S', 2020: 'S', 2021: 'S', 2022: 'S', 2023: 'S', 2024: 'S', 2025: 'S' },
            // German - Early transponder adopters
            "BMW": { 2000: 'T', 2001: 'T', 2002: 'T', 2003: 'T', 2004: 'T', 2005: 'T', 2006: 'S', 2007: 'S', 2008: 'S', 2009: 'S', 2010: 'S', 2011: 'S', 2012: 'S', 2013: 'S', 2014: 'S', 2015: 'S', 2016: 'S', 2017: 'S', 2018: 'S', 2019: 'S', 2020: 'S', 2021: 'S', 2022: 'S', 2023: 'S', 2024: 'S', 2025: 'S' },
            "Mercedes": { 2000: 'T', 2001: 'T', 2002: 'T', 2003: 'T', 2004: 'T', 2005: 'S', 2006: 'S', 2007: 'S', 2008: 'S', 2009: 'S', 2010: 'S', 2011: 'S', 2012: 'S', 2013: 'S', 2014: 'S', 2015: 'S', 2016: 'S', 2017: 'S', 2018: 'S', 2019: 'S', 2020: 'S', 2021: 'S', 2022: 'S', 2023: 'S', 2024: 'S', 2025: 'S' },
            "Volkswagen": { 2000: 'T', 2001: 'T', 2002: 'T', 2003: 'T', 2004: 'T', 2005: 'F', 2006: 'F', 2007: 'F', 2008: 'F', 2009: 'F', 2010: 'F', 2011: 'F', 2012: 'S', 2013: 'S', 2014: 'S', 2015: 'S', 2016: 'S', 2017: 'S', 2018: 'S', 2019: 'S', 2020: 'S', 2021: 'S', 2022: 'S', 2023: 'S', 2024: 'S', 2025: 'S' },
            // Korean - Flip key era
            "Hyundai": { 2000: 'M', 2001: 'M', 2002: 'M', 2003: 'M', 2004: 'M', 2005: 'T', 2006: 'T', 2007: 'F', 2008: 'F', 2009: 'F', 2010: 'F', 2011: 'F', 2012: 'S', 2013: 'S', 2014: 'S', 2015: 'S', 2016: 'S', 2017: 'S', 2018: 'S', 2019: 'S', 2020: 'S', 2021: 'S', 2022: 'S', 2023: 'S', 2024: 'S', 2025: 'S' },
            "Kia": { 2000: 'M', 2001: 'M', 2002: 'M', 2003: 'M', 2004: 'M', 2005: 'T', 2006: 'T', 2007: 'F', 2008: 'F', 2009: 'F', 2010: 'F', 2011: 'F', 2012: 'S', 2013: 'S', 2014: 'S', 2015: 'S', 2016: 'S', 2017: 'S', 2018: 'S', 2019: 'S', 2020: 'S', 2021: 'S', 2022: 'S', 2023: 'S', 2024: 'S', 2025: 'S' }
        };

        // Key type colors matching badge colors
        const KEY_TYPE_COLORS = {
            'S': { bg: '#22c55e', label: 'Smart/Prox', opacity: 1 },      // Green
            'F': { bg: '#a855f7', label: 'Flip Key', opacity: 0.9 },      // Purple
            'R': { bg: '#3b82f6', label: 'Remote Head', opacity: 0.85 },  // Blue
            'T': { bg: '#fbbf24', label: 'Transponder', opacity: 0.8 },   // Yellow
            'M': { bg: '#9ca3af', label: 'Mechanical', opacity: 0.6 }     // Grey
        };

        function renderKeyCoverageMap(forceRefresh = false) {
            const container = document.getElementById('keyCoverageContainer');
            if (!container) return;

            // Use cached HTML if available (performance optimization)
            if (!forceRefresh && cachedHeatmapHtml && heatmapCached) {
                container.innerHTML = cachedHeatmapHtml;
                return;
            }

            const makes = ["Toyota", "Lexus", "Honda", "Nissan", "Ford", "Chevrolet", "Dodge", "Jeep", "BMW", "Mercedes", "Volkswagen", "Hyundai", "Kia", "Subaru", "Mazda"];
            const years = Array.from({ length: 26 }, (_, i) => 2000 + i);

            // Build coverage from hardcoded data + user inventory
            const coverage = {};
            makes.forEach(make => {
                coverage[make] = {};
                years.forEach(year => {
                    const type = HARDCODED_COVERAGE[make]?.[year] || 'M';
                    coverage[make][year] = {
                        keyType: type,
                        inStock: 0 // Will be updated from inventory
                    };
                });
            });

            // Overlay inventory data if fccData is available
            if (typeof fccData !== 'undefined' && fccData && fccData.length > 0) {
                fccData.forEach(entry => {
                    const vehicleStr = entry.vehicles || '';
                    if (!vehicleStr || vehicleStr === 'N/A') return;

                    const parts = vehicleStr.split(',').map(v => v.trim()).filter(v => v);
                    parts.forEach(part => {
                        const match = part.match(/^([^(]+)\s+\((\d{4})(?:-(\d{4}))?\)$/);
                        if (match) {
                            const makeModel = match[1].trim();
                            const makeMatch = makeModel.match(/^([A-Za-z]+)/);
                            const make = makeMatch ? makeMatch[1] : null;

                            if (make && makes.includes(make)) {
                                const start = parseInt(match[2]);
                                const end = match[3] ? parseInt(match[3]) : start;

                                // Check stock
                                const hasStock = (entry.fcc_id && InventoryManager.getKeyStock(entry.fcc_id) > 0) ||
                                    (entry.primary_oem_part && InventoryManager.getBlankStock(entry.primary_oem_part) > 0);

                                for (let y = start; y <= end; y++) {
                                    if (y >= 2000 && y <= 2025 && coverage[make] && coverage[make][y]) {
                                        if (hasStock) coverage[make][y].inStock++;
                                    }
                                }
                            }
                        }
                    });
                });
            }

            // Render Heatmap with all 5 key type colors
            const html = `
                <div style="background: var(--bg-tertiary); padding: 20px; border-radius: 12px; border: 1px solid var(--border); overflow-x: auto;">
                    <h3 style="margin-top: 0; margin-bottom: 20px; display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
                        <span>ðŸ—ºï¸ Key Coverage Map</span>
                        <div style="display: flex; gap: 8px; font-size: 0.75rem; font-weight: 400; flex-wrap: wrap;">
                            <span style="display: flex; align-items: center; gap: 4px;"><span style="width: 10px; height: 10px; background: #22c55e; border-radius: 2px;"></span> Smart/Prox</span>
                            <span style="display: flex; align-items: center; gap: 4px;"><span style="width: 10px; height: 10px; background: #a855f7; border-radius: 2px;"></span> Flip Key</span>
                            <span style="display: flex; align-items: center; gap: 4px;"><span style="width: 10px; height: 10px; background: #3b82f6; border-radius: 2px;"></span> Remote Head</span>
                            <span style="display: flex; align-items: center; gap: 4px;"><span style="width: 10px; height: 10px; background: #fbbf24; border-radius: 2px;"></span> Transponder</span>
                            <span style="display: flex; align-items: center; gap: 4px;"><span style="width: 10px; height: 10px; background: #9ca3af; border-radius: 2px;"></span> Mechanical</span>
                        </div>
                    </h3>

                    <div style="display: grid; grid-template-columns: 100px repeat(${years.length}, 1fr); gap: 2px; min-width: 800px;">
                         <!-- Headers -->
                        <div></div>
                        ${years.map(y => `<div style="font-size: 0.65rem; color: var(--text-muted); text-align: center; transform: rotate(-45deg); height: 30px; display: flex; align-items: flex-end; justify-content: center;">${y % 100}</div>`).join('')}

                        <!-- Body -->
                        ${makes.map(make => {
                return `
                                <div style="font-size: 0.8rem; font-weight: 600; color: var(--text-primary); padding-right: 8px; display: flex; align-items: center; justify-content: flex-end;">${make}</div>
                                ${years.map(year => {
                    const data = coverage[make] && coverage[make][year];
                    const typeCode = data?.keyType || 'M';
                    const typeInfo = KEY_TYPE_COLORS[typeCode] || KEY_TYPE_COLORS['M'];

                    // If in stock, show bright green with ring
                    let bg = typeInfo.bg;
                    let opacity = typeInfo.opacity;
                    let title = typeInfo.label;
                    let border = 'none';

                    if (data && data.inStock > 0) {
                        border = '2px solid #fff';
                        opacity = 1;
                        title = `${typeInfo.label} - In Stock: ${data.inStock}`;
                    }

                    return `
                                        <div title="${make} ${year}: ${title}" 
                                             onclick="filterKeyDb('${make}', ${year})"
                                             style="
                                            height: 24px; 
                                            background: ${bg}; 
                                            border-radius: 2px;
                                            opacity: ${opacity};
                                            cursor: pointer;
                                            transition: all 0.1s;
                                            border: ${border};
                                            box-sizing: border-box;
                                        " onmouseover="this.style.opacity=1; this.style.transform='scale(1.2)';" onmouseout="this.style.opacity=${opacity}; this.style.transform='scale(1)';"></div>
                                    `;
                }).join('')}
                            `;
            }).join('')}
                    </div>
                </div>
            `;
            container.innerHTML = html;

            // Cache the result for performance
            cachedHeatmapHtml = html;
            heatmapCached = true;
        }

        // Helper to filter from chart click
        function filterKeyDb(make, year) {
            const searchBox = document.getElementById('fccSearch');
            searchBox.value = `${make} ${year}`;
            searchBox.dispatchEvent(new Event('input')); // Trigger search

            // Scroll to search results
            searchBox.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        // ================== VIN DECODER ==================

        // Camera scanner state
        let vinCameraStream = null;

        // Start camera for VIN scanning
        async function startVinCamera() {
            const modal = document.getElementById('vinCameraModal');
            const video = document.getElementById('vinCameraVideo');
            const errorEl = document.getElementById('vinError');

            try {
                // Request camera access (prefer back camera on mobile)
                vinCameraStream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment', width: { ideal: 1280 }, height: { ideal: 720 } }
                });
                video.srcObject = vinCameraStream;
                modal.style.display = 'block';
                document.getElementById('vinScanResult').style.display = 'none';
            } catch (err) {
                errorEl.textContent = 'Camera access denied or not available. Please enter VIN manually.';
                errorEl.style.display = 'block';
                console.error('Camera error:', err);
            }
        }

        // Stop camera
        function stopVinCamera() {
            const modal = document.getElementById('vinCameraModal');
            const video = document.getElementById('vinCameraVideo');

            if (vinCameraStream) {
                vinCameraStream.getTracks().forEach(track => track.stop());
                vinCameraStream = null;
            }
            video.srcObject = null;
            modal.style.display = 'none';
        }

        // Capture frame and extract VIN
        async function captureVinFrame() {
            const video = document.getElementById('vinCameraVideo');
            const canvas = document.getElementById('vinCameraCanvas');
            const resultEl = document.getElementById('vinScanResult');
            const detectedText = document.getElementById('vinDetectedText');

            // Draw current frame to canvas
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0);

            // For now, use a simple approach - prompt for manual entry with camera context
            // Full OCR would require Tesseract.js or cloud API
            const vinPattern = /[A-HJ-NPR-Z0-9]{17}/gi;

            // Simulated OCR - in production, integrate Tesseract.js or Google Cloud Vision
            // For now, show instruction to user
            const manualVin = prompt('ðŸ“· Camera captured!\n\nLook at the VIN plate in the image and enter the 17 characters you see:\n\n(Tip: VIN is usually on the dashboard near windshield, or on driver door jamb)');

            if (manualVin) {
                const cleanVin = manualVin.toUpperCase().replace(/[^A-HJ-NPR-Z0-9]/g, '');
                if (cleanVin.length === 17) {
                    detectedText.textContent = cleanVin;
                    resultEl.style.display = 'block';
                } else {
                    alert('VIN must be exactly 17 characters. Found: ' + cleanVin.length);
                }
            }
        }

        // Use detected VIN
        function useDetectedVin() {
            const vin = document.getElementById('vinDetectedText').textContent;
            document.getElementById('vinInput').value = vin;
            stopVinCamera();
            decodeVin();
        }

        // Quick lookup from popular VIN cards
        function lookupVin(vin) {
            document.getElementById('vinInput').value = vin;
            decodeVin();
            // Scroll to input
            document.getElementById('vinInput').scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        // Toggle show more VINs
        function toggleVinList() {
            const moreVins = document.getElementById('moreVins');
            const toggleBtn = document.getElementById('vinListToggle');
            const isHidden = moreVins.style.display === 'none';

            moreVins.style.display = isHidden ? 'block' : 'none';
            toggleBtn.textContent = isHidden ? 'Show Less â–²' : 'Show All â–¼';
        }

        async function decodeVin() {
            const vinInput = document.getElementById('vinInput');
            const vin = vinInput.value.trim().toUpperCase().replace(/[^A-HJ-NPR-Z0-9]/g, '');
            const errorEl = document.getElementById('vinError');
            const resultsEl = document.getElementById('vinResults');
            const loadingEl = document.getElementById('vinLoading');

            // Validate VIN (17 chars, no I, O, Q)
            if (vin.length !== 17) {
                errorEl.textContent = 'VIN must be exactly 17 characters. Currently: ' + vin.length;
                errorEl.style.display = 'block';
                resultsEl.style.display = 'none';
                return;
            }

            errorEl.style.display = 'none';
            loadingEl.style.display = 'block';
            resultsEl.style.display = 'none';

            try {
                // 1. Call NHTSA VIN Decoder API
                const nhtsaRes = await fetch(`https://vpic.nhtsa.dot.gov/api/vehicles/decodevin/${vin}?format=json`);
                const nhtsaData = await nhtsaRes.json();

                // Extract key vehicle info
                const getVal = (varId) => {
                    const item = nhtsaData.Results?.find(r => r.VariableId === varId);
                    return item?.Value || null;
                };

                const year = getVal(29) || getVal(0); // Model Year
                const make = getVal(26); // Make
                const model = getVal(28); // Model
                const series = getVal(34); // Series
                const bodyClass = getVal(5); // Body Class
                const engineConfig = getVal(13); // Engine Configuration
                const fuelType = getVal(24); // Fuel Type
                const doors = getVal(14); // Doors

                if (!make || !year) {
                    throw new Error('Could not decode VIN. Please check and try again.');
                }

                // 2. Display vehicle info
                document.getElementById('vinVehicleInfo').innerHTML = `
                    <div style="display: flex; align-items: center; gap: 16px; flex-wrap: wrap;">
                        <div style="font-size: 2.5rem;">ðŸš—</div>
                        <div>
                            <div style="font-size: 1.5rem; font-weight: 700; color: var(--brand-primary);">${year} ${make} ${model}${series ? ' ' + series : ''}</div>
                            <div style="color: var(--text-muted); font-size: 0.9rem; margin-top: 4px;">
                                ${bodyClass ? bodyClass + ' â€¢ ' : ''}${doors ? doors + ' Door â€¢ ' : ''}${fuelType || ''}
                            </div>
                            <div style="font-family: monospace; font-size: 0.85rem; color: var(--text-secondary); margin-top: 8px; letter-spacing: 1px;">VIN: ${vin}</div>
                        </div>
                    </div>
                `;

                // 3. Query our database for key info
                const dbRes = await fetch(`${API}/api/browse?make=${encodeURIComponent(make)}&year=${year}&limit=10`);
                const dbData = await dbRes.json();
                const vehicles = dbData.rows || [];

                // Find the best match by model
                const exactMatch = vehicles.find(v => v.model?.toLowerCase().includes(model?.toLowerCase())) || vehicles[0];

                // 4. Populate the sections
                const keyBlankHtml = exactMatch ? `
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                        <div style="color: var(--text-muted);">ILCO:</div>
                        <div style="font-weight: 600; color: var(--text-primary);">${parseKeyRefs(exactMatch.key_blank_refs, 'ilco') || 'N/A'}</div>
                        <div style="color: var(--text-muted);">Strattec:</div>
                        <div style="font-weight: 600; color: var(--text-primary);">${parseKeyRefs(exactMatch.key_blank_refs, 'strattec') || 'N/A'}</div>
                        <div style="color: var(--text-muted);">Keyway:</div>
                        <div style="font-weight: 600; color: var(--text-primary);">${exactMatch.keyway || 'N/A'}</div>
                    </div>
                ` : '<div style="color: var(--text-muted);">No key blank data found for this vehicle.</div>';

                const transponderHtml = exactMatch ? `
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                        <div style="color: var(--text-muted);">Chip Type:</div>
                        <div style="font-weight: 600; color: var(--text-primary);">${exactMatch.transponder_type || exactMatch.chip || 'N/A'}</div>
                        <div style="color: var(--text-muted);">Key Type:</div>
                        <div style="font-weight: 600; color: var(--text-primary);">${exactMatch.key_type_display || exactMatch.key_type || 'N/A'}</div>
                        <div style="color: var(--text-muted);">Immobilizer:</div>
                        <div style="font-weight: 600; color: var(--text-primary);">${exactMatch.immobilizer_system || 'N/A'}</div>
                    </div>
                ` : '<div style="color: var(--text-muted);">No transponder data found for this vehicle.</div>';

                const remoteHtml = exactMatch ? `
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                        <div style="color: var(--text-muted);">FCC ID:</div>
                        <div style="font-weight: 600; color: var(--text-primary);">${exactMatch.fcc_id || 'N/A'}</div>
                        <div style="color: var(--text-muted);">Frequency:</div>
                        <div style="font-weight: 600; color: var(--text-primary);">${exactMatch.frequency ? exactMatch.frequency + ' MHz' : 'N/A'}</div>
                        <div style="color: var(--text-muted);">OEM Part:</div>
                        <div style="font-weight: 600; color: var(--text-primary);">${exactMatch.oem_part_number || exactMatch.primary_oem_part || 'N/A'}</div>
                    </div>
                ` : '<div style="color: var(--text-muted);">No remote/fob data found for this vehicle.</div>';

                const programmingHtml = exactMatch ? `
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                        <div style="color: var(--text-muted);">Equipment:</div>
                        <div style="font-weight: 600; color: var(--text-primary);">${exactMatch.programming_tool || exactMatch.equipment_required || 'Professional Tool Required'}</div>
                        <div style="color: var(--text-muted);">Procedure:</div>
                        <div style="font-weight: 600; color: var(--text-primary);">${exactMatch.programming_notes || 'Requires OBDII programming'}</div>
                    </div>
                ` : '<div style="color: var(--text-muted);">No programming info found for this vehicle.</div>';

                document.getElementById('vinKeyBlank').innerHTML = keyBlankHtml;
                document.getElementById('vinTransponder').innerHTML = transponderHtml;
                document.getElementById('vinRemote').innerHTML = remoteHtml;
                document.getElementById('vinProgramming').innerHTML = programmingHtml;

                // 5. Build Amazon buy links
                const searchTerm = `${year} ${make} ${model} key fob`;
                const ilco = parseKeyRefs(exactMatch?.key_blank_refs, 'ilco');
                const strattec = parseKeyRefs(exactMatch?.key_blank_refs, 'strattec');
                const fccId = exactMatch?.fcc_id;
                const oem = exactMatch?.oem_part_number || exactMatch?.primary_oem_part;

                let amazonLinks = `
                    <a href="https://www.amazon.com/s?k=${encodeURIComponent(searchTerm)}&tag=eurokeys-20" target="_blank" 
                       style="background: #22c55e; color: white; padding: 10px 16px; border-radius: 8px; text-decoration: none; font-weight: 600; display: flex; align-items: center; gap: 6px;">
                        ðŸ”‘ Key Fob for ${make}
                    </a>
                `;
                if (ilco && ilco !== 'N/A') {
                    amazonLinks += `
                        <a href="https://www.amazon.com/s?k=${encodeURIComponent('ILCO ' + ilco + ' key blank')}&tag=eurokeys-20" target="_blank"
                           style="background: #1a472a; color: white; padding: 10px 16px; border-radius: 8px; text-decoration: none; font-weight: 600; display: flex; align-items: center; gap: 6px; border: 1px solid #3d7a5a;">
                            ILCO ${ilco}
                        </a>
                    `;
                }
                if (strattec && strattec !== 'N/A') {
                    amazonLinks += `
                        <a href="https://www.amazon.com/s?k=${encodeURIComponent('Strattec ' + strattec + ' key')}&tag=eurokeys-20" target="_blank"
                           style="background: #1a365d; color: white; padding: 10px 16px; border-radius: 8px; text-decoration: none; font-weight: 600; display: flex; align-items: center; gap: 6px; border: 1px solid #3d5a80;">
                            Strattec ${strattec}
                        </a>
                    `;
                }
                if (fccId && fccId !== 'N/A') {
                    amazonLinks += `
                        <a href="https://www.amazon.com/s?k=${encodeURIComponent(fccId + ' key fob')}&tag=eurokeys-20" target="_blank"
                           style="background: #4a1a5d; color: white; padding: 10px 16px; border-radius: 8px; text-decoration: none; font-weight: 600; display: flex; align-items: center; gap: 6px; border: 1px solid #7a3b8a;">
                            FCC: ${fccId}
                        </a>
                    `;
                }

                document.getElementById('vinAmazonLinks').innerHTML = amazonLinks;

                loadingEl.style.display = 'none';
                resultsEl.style.display = 'block';

            } catch (err) {
                loadingEl.style.display = 'none';
                errorEl.textContent = err.message || 'Failed to decode VIN. Please try again.';
                errorEl.style.display = 'block';
            }
        }

        // Helper to parse key_blank_refs JSON
        function parseKeyRefs(refs, type) {
            if (!refs) return null;
            try {
                const parsed = typeof refs === 'string' ? JSON.parse(refs) : refs;
                const val = parsed[type];
                if (Array.isArray(val)) return val.join(', ');
                return val || null;
            } catch (e) {
                return null;
            }
        }

        async function renderToolCoveragePage(container, headerHtml) {
            const simulatedTool = localStorage.getItem('eurokeys_simulated_tool') || null;
            const myCoverage = ToolCoverageManager.getMyCoverage();
            const simCoverage = simulatedTool ? ToolCoverageManager.getSimulatedCoverage(simulatedTool) : {};
            const allTools = ToolCoverageManager.getAllTools();

            const makes = ["Toyota", "Lexus", "Honda", "Nissan", "Ford", "Dodge", "Jeep", "BMW", "Mercedes", "Volkswagen", "Hyundai/Kia", "Volvo", "Land Rover", "GM"];
            const years = Array.from({ length: 26 }, (_, i) => 2000 + i); // 2000-2025

            let html = headerHtml + `
                <div style="display: grid; grid-template-columns: 300px 1fr; gap: 24px; min-height: 600px;">
                    <!-- Left Panel: Tool Selector -->
                    <div style="background: var(--bg-tertiary); padding: 20px; border-radius: 12px; border: 1px solid var(--border);">
                        <h3 style="margin-top: 0; margin-bottom: 16px;">ðŸ› ï¸ Tool Simulator</h3>
                        <p style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 20px;">
                            See what your tools cover (Green) and simulate buying new ones (Blue).
                        </p>

                        <div style="display: grid; gap: 12px;">
                            ${allTools.map(tool => {
                const isOwned = ToolCoverageManager.isToolOwned(tool.name);
                const isSimulated = simulatedTool === tool.name;

                return `
                                    <div style="
                                        padding: 12px; border-radius: 8px; border: 1px solid ${isOwned ? '#22c55e' : (isSimulated ? '#60a5fa' : 'var(--border)')};
                                        background: ${isOwned ? 'rgba(34, 197, 94, 0.1)' : (isSimulated ? 'rgba(96, 165, 250, 0.1)' : 'rgba(255,255,255,0.02)')};
                                        cursor: ${isOwned ? 'default' : 'pointer'};
                                        transition: all 0.2s;
                                    " onclick="${isOwned ? '' : `simulateTool('${tool.name}')`}">
                                        <div style="display: flex; justify-content: space-between; align-items: start;">
                                            <span style="font-weight: 600; font-size: 0.9rem; color: var(--text-primary);">${tool.name}</span>
                                            ${isOwned
                        ? '<span style="font-size: 0.75rem; color: #22c55e; font-weight: 700;">OWNED</span>'
                        : `<span style="font-size: 0.75rem; color: var(--text-muted);">$${tool.price}</span>`
                    }
                                        </div>
                                        ${!isOwned ? `
                                            <div style="font-size: 0.75rem; color: ${isSimulated ? '#60a5fa' : 'var(--text-muted)'}; margin-top: 4px;">
                                                ${isSimulated ? 'ðŸ”µ Currently Simulating' : 'Click to Simulate'}
                                            </div>
                                        ` : ''}
                                    </div>
                                `;
            }).join('')}
                            
                            ${simulatedTool ? `
                                <button onclick="simulateTool(null)" style="margin-top: 12px; width: 100%; padding: 8px; border: 1px solid var(--border); background: transparent; color: var(--text-muted); border-radius: 6px; cursor: pointer;">
                                    Clear Simulation
                                </button>
                            ` : ''}
                        </div>
                    </div>

                    <!-- Right Panel: Coverage Matrix -->
                    <div style="background: var(--bg-tertiary); padding: 20px; border-radius: 12px; border: 1px solid var(--border); overflow-x: auto;">
                        <h3 style="margin-top: 0; margin-bottom: 20px; display: flex; align-items: center; gap: 12px;">
                            <span>ðŸ—ºï¸ Coverage Map</span>
                            <div style="display: flex; gap: 12px; font-size: 0.8rem; font-weight: 400;">
                                <span style="display: flex; align-items: center; gap: 4px;"><span style="width: 10px; height: 10px; background: #22c55e; border-radius: 2px;"></span> Owned</span>
                                <span style="display: flex; align-items: center; gap: 4px;"><span style="width: 10px; height: 10px; background: #60a5fa; border-radius: 2px;"></span> Gain (Simulated)</span>
                                <span style="display: flex; align-items: center; gap: 4px;"><span style="width: 10px; height: 10px; background: rgba(255,255,255,0.05); border-radius: 2px;"></span> No Coverage</span>
                            </div>
                        </h3>

                        <div style="display: grid; grid-template-columns: 100px repeat(${years.length}, 1fr); gap: 2px; min-width: 800px;">
                            <!-- Header Row -->
                            <div></div> <!-- Empty top-left -->
                            ${years.map(y => `
                                <div style="font-size: 0.65rem; color: var(--text-muted); text-align: center; transform: rotate(-45deg); height: 30px; display: flex; align-items: flex-end; justify-content: center;">
                                    ${y % 5 === 0 ? y : "'" + (y % 100)}
                                </div>
                            `).join('')}

                            <!-- Matrix Body -->
                            ${makes.map(make => {
                const makeRow = `
                                    <div style="font-size: 0.8rem; font-weight: 600; color: var(--text-primary); padding-right: 8px; display: flex; align-items: center; justify-content: flex-end;">${make}</div>
                                    ${years.map(year => {
                    const owned = myCoverage[make] && myCoverage[make][year];
                    const simulated = simCoverage[make] && simCoverage[make][year];

                    let bg = 'rgba(255,255,255,0.03)';
                    let title = 'No Coverage';

                    if (owned) {
                        bg = '#22c55e';
                        title = `Owned: ${owned.tool} (${owned.note})`;
                    } else if (simulated) {
                        bg = '#60a5fa';
                        title = `Gain: ${simulated.tool} (${simulated.note})`;
                    }

                    return `
                                            <div title="${make} ${year}: ${title}" style="
                                                height: 24px; 
                                                background: ${bg}; 
                                                border-radius: 2px;
                                                opacity: ${owned || simulated ? 0.9 : 1};
                                                transition: all 0.1s;
                                            " onmouseover="this.style.opacity=1; this.style.transform='scale(1.2)';" onmouseout="this.style.opacity=0.9; this.style.transform='scale(1)';"></div>
                                        `;
                }).join('')}
                                `;
                return makeRow;
            }).join('')}
                        </div>
                    </div>
                </div>
            `;
            container.innerHTML = html;
        }

        function simulateTool(toolName) {
            if (toolName) {
                localStorage.setItem('eurokeys_simulated_tool', toolName);
            } else {
                localStorage.removeItem('eurokeys_simulated_tool');
            }
            renderInventoryPage('coverage');
        }

        // ==========================================
        // AUTHENTICATION & SYNC (Restored)
        // ==========================================

        const AuthManager = {
            async init() {
                try {
                    const res = await fetch(`${API}/api/user`);
                    if (res.ok) {
                        const data = await res.json();
                        currentUser = data;
                        isPro = true;
                    } else {
                        currentUser = null;
                        isPro = true;
                    }
                    this.updateUI();
                } catch (e) {
                    console.error("Auth check failed", e);
                }
            },

            updateUI() {
                const startBtn = document.getElementById('googleSignInBtn');
                const userMenu = document.getElementById('userMenu');
                const userEmail = document.getElementById('userEmail');
                const proBadge = document.getElementById('proBadge');
                const upgradeBtn = document.getElementById('headerUpgradeBtn');

                if (currentUser) {
                    if (startBtn) startBtn.style.display = 'none';
                    if (userMenu) userMenu.style.display = 'flex';
                    if (userEmail) userEmail.textContent = currentUser.email;

                    if (isPro) {
                        if (proBadge) proBadge.style.display = 'inline-block';
                        if (upgradeBtn) upgradeBtn.style.display = 'none';
                    } else {
                        if (proBadge) proBadge.style.display = 'none';
                        if (upgradeBtn) upgradeBtn.style.display = 'flex';
                    }
                } else {
                    if (startBtn) startBtn.style.display = 'flex';
                    if (userMenu) userMenu.style.display = 'none';
                }
            }
        };



        /* SYNC MANAGER */
        const SyncManager = {
            async init() {
                if (!currentUser) return;

                // 1. Initial Pull (Cloud -> Local)
                // In a real app, you'd merge. Simplified: Cloud overwrites local if newer? 
                // For now, we just push local changes to cloud periodically.

                setInterval(this.syncToCloud, 60000); // Sync every minute
                this.syncToCloud(); // And immediately
            },

            async syncToCloud() {
                if (!currentUser) return;

                const inventory = {
                    keys: JSON.parse(localStorage.getItem('eurokeys_inventory_keys') || '{}'),
                    blanks: JSON.parse(localStorage.getItem('eurokeys_inventory_blanks') || '{}')
                };
                const logs = JSON.parse(localStorage.getItem('eurokeys_job_logs') || '[]');

                try {
                    await fetch(`${API}/api/sync`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ inventory, logs })
                    });
                    console.log('â˜ï¸ Data synced to cloud');
                } catch (e) {
                    console.error('Sync failed', e);
                }
            }
        };

        /* STRIPE CHECKOUT */
        async function startStripeCheckout(plan) {
            if (!currentUser) {
                alert("Please sign in first!");
                signInWithGoogle();
                return;
            }

            const btn = document.getElementById('upgradeBtn-' + plan);
            if (btn) btn.textContent = 'Loading...';

            try {
                const res = await fetch(`${API}/api/create-checkout-session`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: currentUser.id,
                        email: currentUser.email,
                        plan: plan // 'monthly' or 'lifetime'
                    })
                });

                const data = await res.json();
                if (data.url) {
                    window.location.href = data.url;
                } else {
                    alert('Checkout failed: ' + (data.error || 'Unknown error'));
                }
            } catch (e) {
                console.error("Stripe error", e);
                alert("Failed to start checkout");
            } finally {
                if (btn) btn.textContent = plan === 'monthly' ? 'Subscribe' : 'Buy Lifetime';
            }
        }

        // Initialize Everything
        window.addEventListener('DOMContentLoaded', async () => {
            await AuthManager.init();
            SyncManager.init();
            handleInitialRoute(); // Handle URL hash routing on page load
        });

    </script>

    <!-- Service Worker Registration for PWA -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(reg => console.log('Service Worker registered:', reg.scope))
                    .catch(err => console.log('Service Worker registration failed:', err));
            });
        }
    </script>
</body>

</html>